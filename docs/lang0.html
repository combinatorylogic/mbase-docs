<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN">
<html>
  <head>
    <script src="scripts.js" type="text/javascript"></script>
    <script src="scripts1.js" type="text/javascript"></script>
    <link rel="stylesheet" href="stylesheets.css" type="text/css">

    <meta http-equiv=Content-Type content="text/html; charset=iso-8859-1">
    <title>Literate output</title>
  </head>
  
<body lang="EN-GB" link=blue vlink=purple>

<div class="column">





<h2>Constructing a compiler</h2>

<p>There is a lot of tutorials out there on how to write a simple interpreter or a compiler. There is most
certainly no need in just another one of this kind. This tutorial is the opposite, it tells how to write a
<i>complex</i> compiler with all the bells and whistles, while still leaving the unimportant details out and
keeping things easy to understand.

<p>As a source language we're using a very simple, somewhat functional language. It's eager, expression--oriented,
no explicit destructive assignment to variables, functions may have I/O and memory side effects
(using some impure intrinsics). No explicit looping constructs besides recursion, tail recursion optimisation
is guaranteed by the compiler.

<p>We build a compiler on top of this simple language, and then extend the core language with more features
added as syntax extensions and compile-time macros, demonstrating a number of different important
approaches used together.

<p>There is no intention to write just another one short and dense compiler. We're fully embracing
the <i>nanopass</i>-style of compiler construction, therefore code is deliberately verbose, but on the other hand,
every step made in the compilation pipeline is easy to understand and easy to reason about.

<p>This compiler takes its eager functional source language and reduces it to an <i>imperative</i>
low level intermediate representation, so both functional and imperative compilation techniques
are covered here, with more emphasis on the imperative side (e.g., we do not go the CPS way,
using an SSA representation instead).

<p>Naming languages is hard and does not make much sense, so we'll simply call our source language <i>lang0</i>,
with all the consequent IR names derived from this notation.

<p>Topics covered in this tutorial include (but not limited to):

<ul>
  <li> <a href="#ast">ASTs</a>
  <li> <a href="#parser">Parsing</a>
  <li> <a href="#macros">Macro expansion</a>
  <li> <a href="#sugar">Syntax sugar elimination</a>
  <li> <a href="#lexical">Lexical scope handling</a>
  <li> <a href="#lifting">Lambda lifting<a>
  <li> <a href="#tails">Tail calls handling</a>, <a href="#tco">tail recursion optimisation</a>
  <li> <a href="#imperative">Converting an expression-oriented language to statements + expressions</a>
  <li> <a href="#ssa">Producing a flat SSA IR</a>
  <li> <a href="#abstract">Converting to the abstract SSA IR and back</a>
</ul>

<p>This is also a showcase for a range of new MBase features - recform ASTs support, abstract SSA library,
AST pretty printing, etc.

<h2 id="ast">Initial AST</h2>

<p>Language starts with a definition of its Abstract Syntax Tree. This is the very first AST in our compilation
chain, it is generated by the parser frontend directly and contains some syntax sugar that ought to be
eliminated straight away.

<p>Since this is a "functional" (sort of) language, everything is an expression. We will split statements and
expressions further down the compilation pipeline.


<p><div class='code'>
<span class='keyword'>ast</span>&nbsp;<span class='ident'>lang0src</span>&nbsp;<span class='keyword'>recform</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;<span class='comment'>//&nbsp;Toplevel&nbsp;statements&nbsp;-&nbsp;definitions&nbsp;and&nbsp;raw&nbsp;expressions<br>
</span>&nbsp;&nbsp;<span class='ident'>top</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='ident'>define</span><span class='lexic'>(</span><span class='ident'>ident</span><span class='lexic'>:</span><span class='ident'>id</span><span class='lexic'>,</span>&nbsp;<span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>e</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>defmacro</span><span class='lexic'>(</span><span class='ident'>ident</span><span class='lexic'>:</span><span class='ident'>id</span><span class='lexic'>,</span>&nbsp;<span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>e</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>expr</span><span class='lexic'>(</span><span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>e</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>debug</span><span class='lexic'>(.*</span><span class='ident'>any</span><span class='lexic'>:</span><span class='ident'>es</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>;</span><br>
&nbsp;&nbsp;<span class='comment'>//&nbsp;All&nbsp;possible&nbsp;expressions<br>
</span>&nbsp;&nbsp;<span class='ident'>expr</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='ident'>lambda</span><span class='lexic'>(*</span><span class='ident'>ident</span><span class='lexic'>:</span><span class='ident'>args</span><span class='lexic'>,</span>&nbsp;<span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>body</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>seq</span><span class='lexic'>(.*</span><span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>body</span><span class='lexic'>)</span><br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>const</span><span class='lexic'>(</span><span class='ident'>const</span><span class='lexic'>:</span><span class='ident'>c</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>var</span><span class='lexic'>(</span><span class='ident'>ident</span><span class='lexic'>:</span><span class='ident'>id</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>apply</span><span class='lexic'>(</span><span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>fn</span><span class='lexic'>,</span>&nbsp;<span class='lexic'>.*</span><span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>args</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>apply2</span><span class='lexic'>(</span><span class='ident'>vident</span><span class='lexic'>:</span><span class='ident'>fn</span><span class='lexic'>,</span>&nbsp;<span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>L</span><span class='lexic'>,</span>&nbsp;<span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>R</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>if3</span><span class='lexic'>(</span><span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>cnd</span><span class='lexic'>,</span>&nbsp;<span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>tr</span><span class='lexic'>,</span>&nbsp;<span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>fl</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>if2</span><span class='lexic'>(</span><span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>cnd</span><span class='lexic'>,</span>&nbsp;<span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>tr</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>let</span><span class='lexic'>(*</span><span class='ident'>letpair</span><span class='lexic'>:</span><span class='ident'>ps</span><span class='lexic'>,</span>&nbsp;<span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>body</span><span class='lexic'>)</span><br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>mklist</span><span class='lexic'>(*</span><span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>es</span><span class='lexic'>)</span><br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='comment'>//&nbsp;This&nbsp;one&nbsp;does&nbsp;not&nbsp;come&nbsp;from&nbsp;a&nbsp;parser,&nbsp;but&nbsp;is<br>
</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='comment'>//&nbsp;produced&nbsp;by&nbsp;a&nbsp;lexical&nbsp;scoping&nbsp;pass&nbsp;later&nbsp;on.<br>
</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>elambda</span><span class='lexic'>(*</span><span class='ident'>ident</span><span class='lexic'>:</span><span class='ident'>args</span><span class='lexic'>,</span>&nbsp;<span class='ident'>lenv</span><span class='lexic'>:</span><span class='ident'>benv</span><span class='lexic'>,</span>&nbsp;<span class='ident'>lenv</span><span class='lexic'>:</span><span class='ident'>fenv</span><span class='lexic'>,</span>&nbsp;<span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>body</span><span class='lexic'>)</span><br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='comment'>//&nbsp;And&nbsp;the&nbsp;following&nbsp;is&nbsp;for&nbsp;macros<br>
</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>toplift</span><span class='lexic'>(</span><span class='ident'>top</span><span class='lexic'>:</span><span class='ident'>t</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>quasiquote</span><span class='lexic'>(</span><span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>e</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>unquote</span><span class='lexic'>(</span><span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>e</span><span class='lexic'>)</span>&nbsp;&nbsp;&nbsp;<span class='comment'>//&nbsp;only&nbsp;valid&nbsp;inside&nbsp;a&nbsp;quasiquote&nbsp;expression<br>
</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>;</span><br>
&nbsp;&nbsp;<span class='comment'>//&nbsp;All&nbsp;possible&nbsp;constant&nbsp;literals<br>
</span>&nbsp;&nbsp;<span class='ident'>const</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='ident'>number</span><span class='lexic'>(</span><span class='ident'>any</span><span class='lexic'>:</span><span class='ident'>n</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>string</span><span class='lexic'>(</span><span class='ident'>any</span><span class='lexic'>:</span><span class='ident'>s</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>symbol</span><span class='lexic'>(</span><span class='ident'>any</span><span class='lexic'>:</span><span class='ident'>s</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>nil</span><span class='lexic'>()</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>;</span><br>
&nbsp;&nbsp;<span class='comment'>//&nbsp;A&nbsp;let&nbsp;binding&nbsp;node<br>
</span>&nbsp;&nbsp;<span class='ident'>letpair</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='ident'>p</span><span class='lexic'>(</span><span class='ident'>ident</span><span class='lexic'>:</span><span class='ident'>id</span><span class='lexic'>,</span>&nbsp;<span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>v</span><span class='lexic'>);</span><br>
<br>
&nbsp;&nbsp;<span class='ident'>ident</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='ident'>unquote</span><span class='lexic'>(</span><span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>e</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>v</span><span class='lexic'>(</span><span class='ident'>vident</span><span class='lexic'>:</span><span class='ident'>id</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>;</span><br>
<span class='lexic'>}</span>
<p></div>


Very often we will have to define a new AST which is only slighly different from
another one. It does not make sense to copy-paste the same thing over and over
again. Instead, new ASTs should be rewritten from the existing ones.

The language after macro expansion will be the following:


<p><div class='code'>
<span class='keyword'>ast</span>&nbsp;<span class='ident'>lang0</span>&nbsp;<span class='lexic'>:</span>&nbsp;<span class='ident'>lang0src</span>&nbsp;<span class='lexic'>(</span>&nbsp;<span class='ident'>ident</span>&nbsp;&#8594;&nbsp;<span class='ident'>oident</span>&nbsp;<span class='lexic'>)</span>&nbsp;<span class='keyword'>recform</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;<span class='ident'>top</span>&nbsp;<span class='lexic'>+=</span>&nbsp;<span class='lexic'>-</span><span class='ident'>defmacro</span><span class='lexic'>;</span><br>
&nbsp;&nbsp;<span class='ident'>expr</span>&nbsp;<span class='lexic'>+=</span>&nbsp;<span class='lexic'>-</span><span class='ident'>toplift</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;&nbsp;<span class='lexic'>-</span><span class='ident'>quasiquote</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;&nbsp;<span class='lexic'>-</span><span class='ident'>unquote</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>;</span><br>
<span class='lexic'>}</span>
<p></div>


<h2 id="parser">Parser</h2>

<p>As we have defined the structure of this language, we can start building a parser for it.

<p>Parsers in PFront are based on an extended PEG. Normally, a new language
parser will inherit one of the existing parsers, to avoid defining common stuff
like whitespace, comments, identifiers, number and string literals and so on. In
this case we're inheriting PFront language entirely, though only use few
primitive nodes from it.

<p>Let's not dwell on it, ok? Far too many compiler tutorials are stuck on
parsing, and parsing is the least important part of a language implementation.


<p><div class='code'>
<span class='keyword'>parser</span>&nbsp;<span class='ident'>plang0</span>&nbsp;<span class='keyword'>(</span><span class='ident'>pfront</span><span class='keyword'>)</span>&nbsp;<span class='keyword'>{</span><br>
&nbsp;&nbsp;<span class='comment'>//&nbsp;A&nbsp;target&nbsp;AST&nbsp;produced&nbsp;by&nbsp;this&nbsp;parser<br>
</span>&nbsp;&nbsp;<span class='keyword'>target</span>&nbsp;<span class='ident'>lang0src</span><span class='keyword'>;</span><br>
&nbsp;&nbsp;<span class='comment'>//&nbsp;Which&nbsp;node&nbsp;should&nbsp;be&nbsp;used&nbsp;as&nbsp;a&nbsp;whitespace&nbsp;-&nbsp;inherited&nbsp;from&nbsp;PFront<br>
</span>&nbsp;&nbsp;<span class='keyword'>!!</span><span class='ident'>Spaces</span><span class='keyword'>;</span><br>
&nbsp;&nbsp;<br>
&nbsp;&nbsp;<span class='comment'>//&nbsp;Rules&nbsp;-&nbsp;for&nbsp;syntax&nbsp;highlighting&nbsp;and&nbsp;for&nbsp;separating&nbsp;keywords<br>
</span>&nbsp;&nbsp;<span class='comment'>//&nbsp;from&nbsp;identifiers<br>
</span>&nbsp;&nbsp;<span class='keyword'>[</span><span class='ident'>lexical</span><span class='keyword'>:]</span>&nbsp;&#8656;&nbsp;<span class='pattern'><span class='keyword'>[lexical]</span></span>&nbsp;&#8658;&nbsp;<span class='keyword'>{</span><span class='ident'>ctoken</span>&nbsp;<span class='keyword'>=</span>&nbsp;<span class='ident'>lexic</span><span class='keyword'>};</span><br>
&nbsp;&nbsp;<span class='keyword'>[</span><span class='ident'>keyword</span><span class='keyword'>:]</span>&nbsp;&#8656;&nbsp;<span class='pattern'><span class='keyword'>[keyword]</span></span>&nbsp;<span class='keyword'><span class='pattern'>![IdentRest]</span></span>&nbsp;&#8658;&nbsp;<span class='keyword'>{</span><span class='ident'>ctoken</span>&nbsp;<span class='keyword'>=</span>&nbsp;<span class='ident'>keyword</span><span class='keyword'>};</span><br>
<br>
&nbsp;&nbsp;<span class='comment'>//&nbsp;Top&nbsp;entry&nbsp;node&nbsp;-&nbsp;returns&nbsp;a&nbsp;list&nbsp;of&nbsp;lang0&nbsp;toplevel&nbsp;statements.<br>
</span>&nbsp;&nbsp;<span class='comment'>//&nbsp;Note&nbsp;the&nbsp;trailing&nbsp;whitespaces&nbsp;-&nbsp;it&nbsp;is&nbsp;important&nbsp;to&nbsp;add&nbsp;them&nbsp;to&nbsp;a<br>
</span>&nbsp;&nbsp;<span class='comment'>//&nbsp;top&nbsp;node,&nbsp;since&nbsp;the&nbsp;whitespaces&nbsp;are&nbsp;only&nbsp;implicitly&nbsp;ignored&nbsp;at<br>
</span>&nbsp;&nbsp;<span class='comment'>//&nbsp;beginnings&nbsp;of&nbsp;tokens.<br>
</span>&nbsp;&nbsp;<span class='ident'>plang0</span>&nbsp;&#8656;&nbsp;<span class='pattern'>eslist</span><span class='keyword'><span class='pattern'>&lt;[l0topexpr]&gt;:</span></span><span class='pattern'>ts</span>&nbsp;<span class='keyword'><span class='pattern'>[Spaces]*</span></span>&nbsp;&#8658;&nbsp;<span class='ident'>ts</span><span class='keyword'>;</span><br>
<br>
&nbsp;&nbsp;<span class='comment'>//&nbsp;A&nbsp;single&nbsp;toplevel&nbsp;statement,&nbsp;including&nbsp;standalone&nbsp;expressions<br>
</span>&nbsp;&nbsp;<span class='ident'>l0topexpr</span>&nbsp;<span class='keyword'>&gt;&gt;</span>&nbsp;<span class='ident'>top</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#8656;&nbsp;<span class='keyword'>{</span>&nbsp;<span class='const'><span class='pattern'>define</span></span>&nbsp;<span class='keyword'><span class='pattern'>[l0qident]:</span></span><span class='pattern'>name</span>&nbsp;<span class='pattern'><span class='const'>&quot;=&quot;</span></span>&nbsp;<span class='keyword'><span class='pattern'>[l0expr]:</span></span><span class='pattern'>e</span>&nbsp;<span class='const'><span class='pattern'>&quot;;&quot;</span></span><span class='keyword'><span class='pattern'>?</span></span>&nbsp;&#8658;&nbsp;<span class='ident'>define</span><span class='keyword'>(</span><span class='ident'>name</span><span class='keyword'>,</span>&nbsp;<span class='ident'>e</span><span class='keyword'>)</span>&nbsp;<span class='keyword'>}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>/</span>&nbsp;&nbsp;<span class='keyword'>{</span>&nbsp;<span class='const'><span class='pattern'>function</span></span>&nbsp;<span class='keyword'><span class='pattern'>[l0qident]:</span></span><span class='pattern'>name</span>&nbsp;<span class='pattern'><span class='const'>&quot;(&quot;</span></span>&nbsp;<span class='pattern'>ecslist</span><span class='keyword'><span class='pattern'>&lt;[l0qident],</span></span><span class='const'><span class='pattern'>&quot;,&quot;</span></span><span class='keyword'><span class='pattern'>&gt;:</span></span><span class='pattern'>args</span>&nbsp;<span class='pattern'><span class='const'>&quot;)&quot;</span></span>&nbsp;<span class='keyword'><span class='pattern'>[l0expr]:</span></span><span class='pattern'>b</span>&nbsp;&#8658;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='ident'>define</span><span class='keyword'>(</span><span class='ident'>name</span><span class='keyword'>,</span>&nbsp;<span class='ident'>lambda</span><span class='keyword'>(</span><span class='ident'>args</span><span class='keyword'>,</span>&nbsp;<span class='ident'>b</span><span class='keyword'>))</span>&nbsp;<span class='keyword'>}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>/</span>&nbsp;&nbsp;<span class='keyword'>{</span>&nbsp;<span class='const'><span class='pattern'>macro</span></span>&nbsp;<span class='keyword'><span class='pattern'>[l0qident]:</span></span><span class='pattern'>name</span>&nbsp;<span class='pattern'><span class='const'>&quot;(&quot;</span></span>&nbsp;<span class='pattern'>ecslist</span><span class='keyword'><span class='pattern'>&lt;[l0qident],</span></span><span class='const'><span class='pattern'>&quot;,&quot;</span></span><span class='keyword'><span class='pattern'>&gt;:</span></span><span class='pattern'>args</span>&nbsp;<span class='pattern'><span class='const'>&quot;)&quot;</span></span>&nbsp;<span class='keyword'><span class='pattern'>[l0expr]:</span></span><span class='pattern'>b</span>&nbsp;&#8658;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='ident'>defmacro</span><span class='keyword'>(</span><span class='ident'>name</span><span class='keyword'>,</span>&nbsp;<span class='ident'>lambda</span><span class='keyword'>(</span><span class='ident'>args</span><span class='keyword'>,</span>&nbsp;<span class='ident'>b</span><span class='keyword'>))</span>&nbsp;<span class='keyword'>}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>/</span>&nbsp;&nbsp;<span class='keyword'>{</span>&nbsp;<span class='keyword'><span class='pattern'>[l0expr]:</span></span><span class='pattern'>e</span>&nbsp;&#8658;&nbsp;<span class='ident'>expr</span><span class='keyword'>(</span><span class='ident'>e</span><span class='keyword'>)</span>&nbsp;<span class='keyword'>}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>;</span><br>
&nbsp;&nbsp;<span class='comment'>//&nbsp;Binary&nbsp;operators&nbsp;classified&nbsp;by&nbsp;their&nbsp;priority<br>
</span>&nbsp;&nbsp;<span class='ident'>p0binop10</span>&nbsp;&#8656;&nbsp;<span class='keyword'>{</span><span class='pattern'><span class='const'>&quot;*&quot;</span></span>&nbsp;&#8658;&nbsp;<span class='keyword'>`</span><span class='ident'>binopmul</span>&nbsp;<span class='keyword'>}</span>&nbsp;<span class='keyword'>/</span>&nbsp;<span class='keyword'>{</span><span class='pattern'><span class='const'>&quot;/&quot;</span></span>&nbsp;&#8658;&nbsp;<span class='keyword'>`</span><span class='ident'>binopdiv</span>&nbsp;<span class='keyword'>};</span><br>
&nbsp;&nbsp;<span class='ident'>p0binop9x</span>&nbsp;&nbsp;&#8656;&nbsp;<span class='keyword'>{</span><span class='const'><span class='pattern'>&quot;&amp;&amp;&quot;</span></span>&nbsp;&#8658;&nbsp;<span class='keyword'>`</span><span class='ident'>binopand</span>&nbsp;<span class='keyword'>}</span>&nbsp;<span class='keyword'>/</span>&nbsp;<span class='keyword'>{</span><span class='pattern'><span class='const'>&quot;&amp;&quot;</span></span>&nbsp;&nbsp;&#8658;&nbsp;<span class='keyword'>`</span><span class='ident'>binopbinand</span>&nbsp;<span class='keyword'>}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>/</span>&nbsp;&nbsp;<span class='keyword'>{</span><span class='const'><span class='pattern'>&quot;||&quot;</span></span>&nbsp;&nbsp;&#8658;&nbsp;<span class='keyword'>`</span><span class='ident'>binopor</span>&nbsp;<span class='keyword'>}</span>&nbsp;<span class='keyword'>/</span>&nbsp;<span class='keyword'>{</span><span class='pattern'><span class='const'>&quot;|&quot;</span></span>&nbsp;&nbsp;&#8658;&nbsp;<span class='keyword'>`</span><span class='ident'>binopbinor</span>&nbsp;<span class='keyword'>};</span><br>
&nbsp;&nbsp;<span class='ident'>p0binop9</span>&nbsp;&nbsp;&#8656;&nbsp;<span class='keyword'>{</span><span class='const'><span class='pattern'>&quot;&lt;&lt;&quot;</span></span>&nbsp;&#8658;&nbsp;<span class='keyword'>`</span><span class='ident'>binopshl</span>&nbsp;<span class='keyword'>}</span>&nbsp;<span class='keyword'>/</span>&nbsp;<span class='keyword'>{</span><span class='const'><span class='pattern'>&quot;&gt;&gt;&quot;</span></span>&nbsp;&#8658;&nbsp;<span class='keyword'>`</span><span class='ident'>binopshr</span>&nbsp;<span class='keyword'>};</span><br>
&nbsp;&nbsp;<span class='ident'>p0binop8</span>&nbsp;&nbsp;&#8656;&nbsp;<span class='keyword'>{</span><span class='pattern'><span class='const'>&quot;+&quot;</span></span>&nbsp;&#8658;&nbsp;<span class='keyword'>`</span><span class='ident'>binopadd</span>&nbsp;<span class='keyword'>}</span>&nbsp;<span class='keyword'>/</span>&nbsp;<span class='keyword'>{</span><span class='pattern'><span class='const'>&quot;-&quot;</span></span>&nbsp;&#8658;&nbsp;<span class='keyword'>`</span><span class='ident'>binopsub</span>&nbsp;<span class='keyword'>};</span><br>
&nbsp;&nbsp;<span class='ident'>p0binop7</span>&nbsp;&nbsp;&#8656;&nbsp;<span class='keyword'>{</span><span class='const'><span class='pattern'>&quot;&lt;=&quot;</span></span>&nbsp;&#8658;&nbsp;<span class='keyword'>`</span><span class='ident'>binople</span>&nbsp;<span class='keyword'>}</span>&nbsp;<span class='keyword'>/</span>&nbsp;<span class='keyword'>{</span><span class='const'><span class='pattern'>&quot;&gt;=&quot;</span></span>&nbsp;&#8658;&nbsp;<span class='keyword'>`</span><span class='ident'>binopge</span>&nbsp;<span class='keyword'>}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>/</span>&nbsp;&nbsp;<span class='keyword'>{</span><span class='const'><span class='pattern'>&quot;==&quot;</span></span>&nbsp;&#8658;&nbsp;<span class='keyword'>`</span><span class='ident'>binopeq</span>&nbsp;<span class='keyword'>}</span>&nbsp;<span class='keyword'>/</span>&nbsp;<span class='keyword'>{</span><span class='const'><span class='pattern'>&quot;!=&quot;</span></span>&nbsp;&#8658;&nbsp;<span class='keyword'>`</span><span class='ident'>binopneq</span>&nbsp;<span class='keyword'>}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>/</span>&nbsp;&nbsp;<span class='keyword'>{</span><span class='pattern'><span class='const'>&quot;&lt;&quot;</span></span>&nbsp;&#8658;&nbsp;<span class='keyword'>`</span><span class='ident'>binoplt</span>&nbsp;<span class='keyword'>}</span>&nbsp;<span class='keyword'>/</span>&nbsp;<span class='keyword'>{</span><span class='pattern'><span class='const'>&quot;&gt;&quot;</span></span>&nbsp;&#8658;&nbsp;<span class='keyword'>`</span><span class='ident'>binopgt</span>&nbsp;<span class='keyword'>};</span><br>
&nbsp;&nbsp;<span class='comment'>//&nbsp;Expressions,&nbsp;starting&nbsp;with&nbsp;a&nbsp;binary.&nbsp;This&nbsp;is&nbsp;compiled&nbsp;as&nbsp;a&nbsp;Pratt&nbsp;parser&nbsp;embedded<br>
</span>&nbsp;&nbsp;<span class='comment'>//&nbsp;into&nbsp;a&nbsp;PEG.<br>
</span>&nbsp;&nbsp;<span class='keyword'>binary</span>&nbsp;<span class='ident'>l0expr</span>&nbsp;<span class='keyword'>&gt;&gt;</span>&nbsp;<span class='ident'>expr</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#8656;&nbsp;<span class='keyword'>(</span><span class='const'>1000</span><span class='keyword'>)</span>&nbsp;<span class='pattern'><span class='keyword'>[l0expr]</span></span>&nbsp;<span class='pattern'><span class='keyword'>[p0binop10]</span></span>&nbsp;<span class='pattern'><span class='keyword'>[l0expr]</span></span>&nbsp;&#8658;&nbsp;<span class='ident'>apply2</span><span class='keyword'>(</span><span class='ident'>op</span><span class='keyword'>,</span>&nbsp;<span class='ident'>L</span><span class='keyword'>,</span>&nbsp;<span class='ident'>R</span><span class='keyword'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>|</span>&nbsp;&nbsp;&nbsp;<span class='keyword'>(</span><span class='const'>950</span><span class='keyword'>)</span>&nbsp;<span class='pattern'><span class='keyword'>[l0expr]</span></span>&nbsp;<span class='pattern'><span class='keyword'>[p0binop9x]</span></span>&nbsp;<span class='pattern'><span class='keyword'>[l0expr]</span></span>&nbsp;&#8658;&nbsp;<span class='ident'>apply2</span><span class='keyword'>(</span><span class='ident'>op</span><span class='keyword'>,</span>&nbsp;<span class='ident'>L</span><span class='keyword'>,</span>&nbsp;<span class='ident'>R</span><span class='keyword'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>|</span>&nbsp;&nbsp;&nbsp;<span class='keyword'>(</span><span class='const'>900</span><span class='keyword'>)</span>&nbsp;<span class='pattern'><span class='keyword'>[l0expr]</span></span>&nbsp;<span class='pattern'><span class='keyword'>[p0binop9]</span></span>&nbsp;&nbsp;<span class='pattern'><span class='keyword'>[l0expr]</span></span>&nbsp;&#8658;&nbsp;<span class='ident'>apply2</span><span class='keyword'>(</span><span class='ident'>op</span><span class='keyword'>,</span>&nbsp;<span class='ident'>L</span><span class='keyword'>,</span>&nbsp;<span class='ident'>R</span><span class='keyword'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>|</span>&nbsp;&nbsp;&nbsp;<span class='keyword'>(</span><span class='const'>800</span><span class='keyword'>)</span>&nbsp;<span class='pattern'><span class='keyword'>[l0expr]</span></span>&nbsp;<span class='pattern'><span class='keyword'>[p0binop8]</span></span>&nbsp;&nbsp;<span class='pattern'><span class='keyword'>[l0expr]</span></span>&nbsp;&#8658;&nbsp;<span class='ident'>apply2</span><span class='keyword'>(</span><span class='ident'>op</span><span class='keyword'>,</span>&nbsp;<span class='ident'>L</span><span class='keyword'>,</span>&nbsp;<span class='ident'>R</span><span class='keyword'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>|</span>&nbsp;&nbsp;&nbsp;<span class='keyword'>(</span><span class='const'>700</span><span class='keyword'>)</span>&nbsp;<span class='pattern'><span class='keyword'>[l0expr]</span></span>&nbsp;<span class='pattern'><span class='keyword'>[p0binop7]</span></span>&nbsp;&nbsp;<span class='pattern'><span class='keyword'>[l0expr]</span></span>&nbsp;&#8658;&nbsp;<span class='ident'>apply2</span><span class='keyword'>(</span><span class='ident'>op</span><span class='keyword'>,</span>&nbsp;<span class='ident'>L</span><span class='keyword'>,</span>&nbsp;<span class='ident'>R</span><span class='keyword'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>|</span>&nbsp;&nbsp;&nbsp;<span class='keyword'>(</span><span class='const'>600</span><span class='keyword'>)</span>&nbsp;<span class='pattern'><span class='keyword'>[l0expr]</span></span>&nbsp;<span class='const'><span class='pattern'>&quot;::&quot;</span></span>&nbsp;&nbsp;<span class='pattern'><span class='keyword'>[l0expr]</span></span>&nbsp;&#8658;&nbsp;<span class='ident'>apply2</span><span class='keyword'>(</span><span class='keyword'>`</span><span class='ident'>cons</span><span class='keyword'>,</span>&nbsp;<span class='ident'>L</span><span class='keyword'>,</span>&nbsp;<span class='ident'>R</span><span class='keyword'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>|</span>&nbsp;&nbsp;&nbsp;<span class='keyword'>(</span><span class='const'>500</span><span class='keyword'>)</span>&nbsp;<span class='pattern'><span class='keyword'>[l0expr]</span></span>&nbsp;<span class='pattern'><span class='const'>&quot;@&quot;</span></span>&nbsp;&nbsp;<span class='pattern'><span class='keyword'>[l0expr]</span></span>&nbsp;&#8658;&nbsp;<span class='ident'>apply2</span><span class='keyword'>(</span><span class='keyword'>`</span><span class='ident'>append</span><span class='keyword'>,</span>&nbsp;<span class='ident'>L</span><span class='keyword'>,</span>&nbsp;<span class='ident'>R</span><span class='keyword'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>|</span>&nbsp;&nbsp;&nbsp;<span class='pattern'><span class='keyword'>[l0expr1]</span></span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>;</span><br>
&nbsp;&nbsp;<span class='comment'>//&nbsp;Simple&nbsp;expressions<br>
</span>&nbsp;&nbsp;<span class='ident'>l0expr1</span>&nbsp;&#8656;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>{</span>&nbsp;<span class='pattern'><span class='const'>&quot;(&quot;</span></span>&nbsp;<span class='keyword'><span class='pattern'>[l0expr]:</span></span><span class='pattern'>e</span>&nbsp;<span class='pattern'><span class='const'>&quot;)&quot;</span></span>&nbsp;<span class='pattern'><span class='const'>&quot;(&quot;</span></span>&nbsp;<span class='pattern'>ecslist</span><span class='keyword'><span class='pattern'>&lt;[l0expr],</span></span><span class='const'><span class='pattern'>&quot;,&quot;</span></span><span class='keyword'><span class='pattern'>&gt;:</span></span><span class='pattern'>args</span>&nbsp;<span class='pattern'><span class='const'>&quot;)&quot;</span></span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#8658;&nbsp;<span class='ident'>apply</span><span class='keyword'>(</span><span class='ident'>e</span><span class='keyword'>,@</span><span class='ident'>args</span><span class='keyword'>)</span>&nbsp;<span class='keyword'>}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>/</span>&nbsp;&nbsp;<span class='keyword'>{</span>&nbsp;<span class='pattern'><span class='const'>&quot;(&quot;</span></span>&nbsp;<span class='keyword'><span class='pattern'>[l0expr]:</span></span><span class='pattern'>e</span>&nbsp;<span class='pattern'><span class='const'>&quot;)&quot;</span></span>&nbsp;&#8658;&nbsp;<span class='ident'>e</span>&nbsp;<span class='keyword'>}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>/</span>&nbsp;&nbsp;<span class='keyword'>{</span>&nbsp;<span class='pattern'><span class='const'>&quot;{&quot;</span></span>&nbsp;<span class='pattern'>cslist</span><span class='keyword'><span class='pattern'>&lt;[l0expr],</span></span><span class='pattern'>&nbsp;</span><span class='const'><span class='pattern'>&quot;;&quot;</span></span><span class='keyword'><span class='pattern'>&gt;:</span></span><span class='pattern'>es</span>&nbsp;<span class='const'><span class='pattern'>&quot;;&quot;</span></span><span class='keyword'><span class='pattern'>?</span></span>&nbsp;<span class='pattern'><span class='const'>&quot;}&quot;</span></span>&nbsp;&#8658;&nbsp;<span class='ident'>seq</span><span class='keyword'>(</span><span class='keyword'>@</span><span class='ident'>es</span><span class='keyword'>)</span>&nbsp;<span class='keyword'>}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>/</span>&nbsp;&nbsp;<span class='keyword'>{</span>&nbsp;<span class='pattern'><span class='const'>&quot;`&quot;</span></span>&nbsp;<span class='keyword'><span class='pattern'>[l0expr]:</span></span><span class='pattern'>e</span>&nbsp;<span class='pattern'><span class='const'>&quot;`&quot;</span></span>&nbsp;&#8658;&nbsp;<span class='ident'>quasiquote</span><span class='keyword'>(</span><span class='ident'>e</span><span class='keyword'>)</span>&nbsp;<span class='keyword'>}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>/</span>&nbsp;&nbsp;<span class='keyword'>{</span>&nbsp;<span class='const'><span class='pattern'>&quot;::expr&quot;</span></span>&nbsp;<span class='pattern'><span class='const'>&quot;\&quot;</span></span>&nbsp;<span class='keyword'><span class='pattern'>[l0expr]:</span></span><span class='pattern'>e</span>&nbsp;<span class='pattern'><span class='const'>&quot;\&quot;</span></span>&nbsp;&#8658;&nbsp;<span class='ident'>unquote</span><span class='keyword'>(</span><span class='ident'>e</span><span class='keyword'>)</span>&nbsp;<span class='keyword'>}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>/</span>&nbsp;&nbsp;<span class='keyword'>{</span>&nbsp;<span class='const'><span class='pattern'>&quot;::lift&quot;</span></span>&nbsp;<span class='keyword'><span class='pattern'>[l0topexpr]:</span></span><span class='pattern'>t</span>&nbsp;&#8658;&nbsp;<span class='ident'>toplift</span><span class='keyword'>(</span><span class='ident'>t</span><span class='keyword'>)</span>&nbsp;<span class='keyword'>}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>/</span>&nbsp;&nbsp;<span class='keyword'>{</span>&nbsp;<span class='const'><span class='pattern'>if</span></span>&nbsp;<span class='pattern'><span class='const'>&quot;(&quot;</span></span>&nbsp;<span class='keyword'><span class='pattern'>[l0expr]:</span></span><span class='pattern'>cnd</span>&nbsp;<span class='pattern'><span class='const'>&quot;)&quot;</span></span>&nbsp;<span class='keyword'><span class='pattern'>[l0expr]:</span></span><span class='pattern'>tr</span>&nbsp;<span class='const'><span class='pattern'>else</span></span>&nbsp;<span class='keyword'><span class='pattern'>[l0expr]:</span></span><span class='pattern'>fl</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#8658;&nbsp;<span class='ident'>if3</span><span class='keyword'>(</span><span class='ident'>cnd</span><span class='keyword'>,</span>&nbsp;<span class='ident'>tr</span><span class='keyword'>,</span>&nbsp;<span class='ident'>fl</span><span class='keyword'>)</span>&nbsp;<span class='keyword'>}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>/</span>&nbsp;&nbsp;<span class='keyword'>{</span>&nbsp;<span class='const'><span class='pattern'>if</span></span>&nbsp;<span class='pattern'><span class='const'>&quot;(&quot;</span></span>&nbsp;<span class='keyword'><span class='pattern'>[l0expr]:</span></span><span class='pattern'>cnd</span>&nbsp;<span class='pattern'><span class='const'>&quot;)&quot;</span></span>&nbsp;<span class='keyword'><span class='pattern'>[l0expr]:</span></span><span class='pattern'>tr</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#8658;&nbsp;<span class='ident'>if2</span><span class='keyword'>(</span><span class='ident'>cnd</span><span class='keyword'>,</span>&nbsp;<span class='ident'>tr</span><span class='keyword'>,</span>&nbsp;<span class='ident'>fl</span><span class='keyword'>)</span>&nbsp;<span class='keyword'>}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>/</span>&nbsp;&nbsp;<span class='keyword'>{</span>&nbsp;<span class='const'><span class='pattern'>fun</span></span>&nbsp;<span class='pattern'><span class='const'>&quot;(&quot;</span></span>&nbsp;<span class='pattern'>ecslist</span><span class='keyword'><span class='pattern'>&lt;[l0qident],</span></span><span class='const'><span class='pattern'>&quot;,&quot;</span></span><span class='keyword'><span class='pattern'>&gt;:</span></span><span class='pattern'>args</span>&nbsp;<span class='pattern'><span class='const'>&quot;)&quot;</span></span>&nbsp;<span class='keyword'><span class='pattern'>[l0expr]:</span></span><span class='pattern'>b</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#8658;&nbsp;<span class='ident'>lambda</span><span class='keyword'>(</span><span class='ident'>args</span><span class='keyword'>,</span>&nbsp;<span class='ident'>b</span><span class='keyword'>)</span>&nbsp;<span class='keyword'>}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>/</span>&nbsp;&nbsp;<span class='keyword'>{</span>&nbsp;<span class='const'><span class='pattern'>let</span></span>&nbsp;<span class='pattern'>cslist</span><span class='keyword'><span class='pattern'>&lt;[l0letpair],</span></span><span class='const'><span class='pattern'>&quot;,&quot;</span></span><span class='keyword'><span class='pattern'>&gt;:</span></span><span class='pattern'>ps</span>&nbsp;<span class='const'><span class='pattern'>in</span></span>&nbsp;<span class='keyword'><span class='pattern'>[l0expr]:</span></span><span class='pattern'>b</span>&nbsp;&#8658;&nbsp;<span class='ident'>let</span><span class='keyword'>(</span><span class='ident'>ps</span><span class='keyword'>,</span>&nbsp;<span class='ident'>b</span><span class='keyword'>)</span>&nbsp;<span class='keyword'>}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>/</span>&nbsp;&nbsp;<span class='keyword'>{</span>&nbsp;<span class='const'><span class='pattern'>return</span></span>&nbsp;<span class='keyword'><span class='pattern'>[l0expr]:</span></span><span class='pattern'>e</span>&nbsp;&#8658;&nbsp;<span class='ident'>e</span>&nbsp;<span class='keyword'>}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>/</span>&nbsp;&nbsp;<span class='keyword'>{</span>&nbsp;<span class='keyword'><span class='pattern'>[number]:</span></span><span class='pattern'>n</span>&nbsp;&#8658;&nbsp;<span class='ident'>const</span><span class='keyword'>(</span><span class='ident'>number</span><span class='keyword'>(</span><span class='ident'>n</span><span class='keyword'>))</span>&nbsp;<span class='keyword'>}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>/</span>&nbsp;&nbsp;<span class='keyword'>{</span>&nbsp;<span class='keyword'><span class='pattern'>[string]:</span></span><span class='pattern'>s</span>&nbsp;&#8658;&nbsp;<span class='ident'>const</span><span class='keyword'>(</span><span class='ident'>string</span><span class='keyword'>(</span><span class='ident'>s</span><span class='keyword'>))</span>&nbsp;<span class='keyword'>}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>/</span>&nbsp;&nbsp;<span class='keyword'>{</span>&nbsp;<span class='pattern'><span class='const'>&quot;[&quot;</span></span>&nbsp;<span class='pattern'>cslist</span><span class='keyword'><span class='pattern'>&lt;[l0expr],</span></span><span class='const'><span class='pattern'>&quot;;&quot;</span></span><span class='keyword'><span class='pattern'>&gt;:</span></span><span class='pattern'>es</span>&nbsp;<span class='pattern'><span class='const'>&quot;]&quot;</span></span>&nbsp;&#8658;&nbsp;<span class='ident'>mklist</span><span class='keyword'>(</span><span class='ident'>es</span><span class='keyword'>)</span>&nbsp;<span class='keyword'>}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>/</span>&nbsp;&nbsp;<span class='keyword'>{</span>&nbsp;<span class='pattern'><span class='const'>&quot;[&quot;</span></span>&nbsp;<span class='pattern'><span class='const'>&quot;]&quot;</span></span>&nbsp;&#8658;&nbsp;<span class='ident'>const</span><span class='keyword'>(</span><span class='ident'>nil</span><span class='keyword'>())</span>&nbsp;<span class='keyword'>}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>/</span>&nbsp;&nbsp;<span class='keyword'>{</span>&nbsp;<span class='pattern'><span class='const'>&quot;'&quot;</span></span>&nbsp;<span class='keyword'><span class='pattern'>[l0qident]:</span></span><span class='pattern'>s</span>&nbsp;&#8658;&nbsp;<span class='ident'>const</span><span class='keyword'>(</span><span class='ident'>symbol</span><span class='keyword'>(</span><span class='ident'>s</span><span class='keyword'>))</span>&nbsp;<span class='keyword'>}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>/</span>&nbsp;&nbsp;<span class='keyword'>{</span>&nbsp;<span class='keyword'><span class='pattern'>[l0qident]:</span></span><span class='pattern'>id</span>&nbsp;<span class='pattern'><span class='const'>&quot;(&quot;</span></span>&nbsp;<span class='pattern'>ecslist</span><span class='keyword'><span class='pattern'>&lt;[l0expr],</span></span><span class='const'><span class='pattern'>&quot;,&quot;</span></span><span class='keyword'><span class='pattern'>&gt;:</span></span><span class='pattern'>args</span>&nbsp;<span class='pattern'><span class='const'>&quot;)&quot;</span></span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#8658;&nbsp;<span class='ident'>apply</span><span class='keyword'>(</span><span class='ident'>var</span><span class='keyword'>(</span><span class='ident'>id</span><span class='keyword'>),@</span><span class='ident'>args</span><span class='keyword'>)</span>&nbsp;<span class='keyword'>}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>/</span>&nbsp;&nbsp;<span class='keyword'>{</span>&nbsp;<span class='keyword'><span class='pattern'>[l0qident]:</span></span><span class='pattern'>id</span>&nbsp;&#8658;&nbsp;<span class='ident'>var</span><span class='keyword'>(</span><span class='ident'>id</span><span class='keyword'>)</span>&nbsp;<span class='keyword'>}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>;</span><br>
&nbsp;&nbsp;<span class='comment'>//&nbsp;A&nbsp;single&nbsp;let&nbsp;binding&nbsp;node<br>
</span>&nbsp;&nbsp;<span class='ident'>l0letpair</span>&nbsp;<span class='keyword'>&gt;&gt;</span>&nbsp;<span class='ident'>letpair</span>&nbsp;&#8656;&nbsp;<span class='keyword'><span class='pattern'>[l0qident]:</span></span><span class='pattern'>id</span>&nbsp;<span class='pattern'><span class='const'>&quot;=&quot;</span></span>&nbsp;<span class='keyword'><span class='pattern'>[l0expr]:</span></span><span class='pattern'>e</span>&nbsp;&#8658;&nbsp;<span class='ident'>p</span><span class='keyword'>(</span><span class='ident'>id</span><span class='keyword'>,</span>&nbsp;<span class='ident'>e</span><span class='keyword'>)</span><span class='keyword'>;</span><br>
<br>
&nbsp;&nbsp;<span class='comment'>//&nbsp;Potentially&nbsp;unquoted&nbsp;identifiers<br>
</span>&nbsp;&nbsp;<span class='ident'>l0qident</span>&nbsp;&#8656;&nbsp;<span class='keyword'>{</span>&nbsp;<span class='pattern'><span class='const'>&quot;\&quot;</span></span>&nbsp;<span class='keyword'><span class='pattern'>[l0expr]:</span></span><span class='pattern'>e</span>&nbsp;<span class='pattern'><span class='const'>&quot;\&quot;</span></span>&nbsp;&#8658;&nbsp;<span class='ident'>unquote</span><span class='keyword'>(</span><span class='ident'>e</span><span class='keyword'>)</span>&nbsp;<span class='keyword'>}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>/</span>&nbsp;&nbsp;<span class='keyword'>{</span>&nbsp;<span class='keyword'><span class='pattern'>[ident]:</span></span><span class='pattern'>id</span>&nbsp;&#8658;&nbsp;<span class='ident'>v</span><span class='keyword'>(</span><span class='ident'>id</span><span class='keyword'>)</span>&nbsp;<span class='keyword'>}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>;</span><br>
<span class='keyword'>}</span>
<p></div>


<p>An example of a language accepted by this parser would look like this:






<p><div class='democode'>
<span class='comment'>/*&nbsp;Comment&nbsp;*/</span><br>
<span class='keyword'>function</span>&nbsp;<span class='ident'>foldl</span><span class='lexic'>(</span><span class='ident'>fn</span><span class='lexic'>,</span>&nbsp;<span class='ident'>i</span><span class='lexic'>,</span>&nbsp;<span class='ident'>l</span><span class='lexic'>)</span><br>
<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;<span class='keyword'>if</span><span class='lexic'>(</span><span class='ident'>nullp</span><span class='lexic'>(</span><span class='ident'>l</span><span class='lexic'>))</span>&nbsp;<span class='keyword'>return</span>&nbsp;<span class='ident'>i</span><br>
&nbsp;&nbsp;&nbsp;<span class='keyword'>else</span>&nbsp;<span class='keyword'>let</span>&nbsp;<span class='ident'>hd</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='ident'>head</span><span class='lexic'>(</span><span class='ident'>l</span><span class='lexic'>),</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='ident'>tl</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='ident'>tail</span><span class='lexic'>(</span><span class='ident'>l</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>in</span>&nbsp;<span class='ident'>foldl</span><span class='lexic'>(</span><span class='ident'>fn</span><span class='lexic'>,</span>&nbsp;<span class='ident'>fn</span><span class='lexic'>(</span><span class='ident'>i</span><span class='lexic'>,</span>&nbsp;<span class='ident'>hd</span><span class='lexic'>),</span>&nbsp;<span class='ident'>tl</span><span class='lexic'>)</span><br>
<span class='lexic'>}</span>
</div><p>



<p><div class='democode'>
<br>
<span class='comment'>//&nbsp;One-line&nbsp;comment<br>
</span><span class='ident'>print</span><span class='lexic'>(</span><span class='ident'>foldl</span><span class='lexic'>(</span><span class='keyword'>fun</span><span class='lexic'>(</span><span class='ident'>a</span><span class='lexic'>,</span><span class='ident'>b</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><span class='ident'>a</span><span class='lexic'>+</span><span class='ident'>b</span><span class='lexic'>},</span>&nbsp;<span class='const'>0</span><span class='lexic'>,</span>&nbsp;<span class='lexic'>[</span><span class='const'>1</span><span class='lexic'>;</span><span class='const'>2</span><span class='lexic'>;</span><span class='const'>3</span><span class='lexic'>;</span><span class='const'>4</span><span class='lexic'>;</span><span class='const'>5</span><span class='lexic'>;</span><span class='const'>6</span><span class='lexic'>]))</span>
</div><p>


<p>We will use this foldl function to illustrate the compilation pipeline.

<p>There is nothing interesting to see there yet. Leaving it here just for a reference - this
function straight after parsing:



   

<p><div class='democode'>
<span class='lexic'>(define</span>&nbsp;<span class='lexic'>(</span><span class='ident'>v</span>&nbsp;<span class='keyword'>foldl</span><span class='lexic'>)</span>&nbsp;<br>
&nbsp;&nbsp;<span class='lexic'>(lambda</span>&nbsp;<span class='lexic'>((</span><span class='ident'>v</span>&nbsp;<span class='ident'>fn</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>(</span><span class='ident'>v</span>&nbsp;<span class='ident'>i</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>(</span><span class='ident'>v</span>&nbsp;<span class='ident'>l</span><span class='lexic'>))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>seq</span>&nbsp;<span class='lexic'>(</span><span class='ident'>if3</span>&nbsp;<span class='lexic'>(</span><span class='keyword'>apply</span>&nbsp;<span class='lexic'>(</span><span class='ident'>var</span>&nbsp;<span class='lexic'>(</span><span class='ident'>v</span>&nbsp;<span class='ident'>nullp</span><span class='lexic'>))</span>&nbsp;<span class='lexic'>(</span><span class='ident'>var</span>&nbsp;<span class='lexic'>(</span><span class='ident'>v</span>&nbsp;<span class='ident'>l</span><span class='lexic'>)))</span>&nbsp;<span class='lexic'>(</span><span class='ident'>var</span>&nbsp;<span class='lexic'>(</span><span class='ident'>v</span>&nbsp;<span class='ident'>i</span><span class='lexic'>))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(let</span>&nbsp;<span class='lexic'>((</span><span class='ident'>p</span>&nbsp;<span class='lexic'>(</span><span class='ident'>v</span>&nbsp;<span class='ident'>hd</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>(</span><span class='keyword'>apply</span>&nbsp;<span class='lexic'>(</span><span class='ident'>var</span>&nbsp;<span class='lexic'>(</span><span class='ident'>v</span>&nbsp;<span class='ident'>head</span><span class='lexic'>))</span>&nbsp;<span class='lexic'>(</span><span class='ident'>var</span>&nbsp;<span class='lexic'>(</span><span class='ident'>v</span>&nbsp;<span class='ident'>l</span><span class='lexic'>))))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>p</span>&nbsp;<span class='lexic'>(</span><span class='ident'>v</span>&nbsp;<span class='ident'>tl</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>(</span><span class='keyword'>apply</span>&nbsp;<span class='lexic'>(</span><span class='ident'>var</span>&nbsp;<span class='lexic'>(</span><span class='ident'>v</span>&nbsp;<span class='ident'>tail</span><span class='lexic'>))</span>&nbsp;<span class='lexic'>(</span><span class='ident'>var</span>&nbsp;<span class='lexic'>(</span><span class='ident'>v</span>&nbsp;<span class='ident'>l</span><span class='lexic'>)))))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='keyword'>apply</span>&nbsp;<span class='lexic'>(</span><span class='ident'>var</span>&nbsp;<span class='lexic'>(</span><span class='ident'>v</span>&nbsp;<span class='keyword'>foldl</span><span class='lexic'>))</span>&nbsp;<span class='lexic'>(</span><span class='ident'>var</span>&nbsp;<span class='lexic'>(</span><span class='ident'>v</span>&nbsp;<span class='ident'>fn</span><span class='lexic'>))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='keyword'>apply</span>&nbsp;<span class='lexic'>(</span><span class='ident'>var</span>&nbsp;<span class='lexic'>(</span><span class='ident'>v</span>&nbsp;<span class='ident'>fn</span><span class='lexic'>))</span>&nbsp;<span class='lexic'>(</span><span class='ident'>var</span>&nbsp;<span class='lexic'>(</span><span class='ident'>v</span>&nbsp;<span class='ident'>i</span><span class='lexic'>))</span>&nbsp;<span class='lexic'>(</span><span class='ident'>var</span>&nbsp;<span class='lexic'>(</span><span class='ident'>v</span>&nbsp;<span class='ident'>hd</span><span class='lexic'>)))</span>&nbsp;<span class='lexic'>(</span><span class='ident'>var</span>&nbsp;<span class='lexic'>(</span><span class='ident'>v</span>&nbsp;<span class='ident'>tl</span><span class='lexic'>))))))))</span><br>

</div><p>




<h2 id="macros">Macro expansion</h2>

Logically, this is the next step straight after parsing. Though, it is a
relatively advanced subject that probably should be skipped at first, straight
to the <a href="#sugar">syntax sugar lowering</a>. Feel free to come back and
review this section after reading about the runtime-compiler feedback loop.

At this moment we don't have any feedback loop, it can only be defined later,
when the rest of the compiler pipeline is finalised. We'll leave an empty stub
here meanwhile.


<p><div class='code'>
<span id='Z508840'><span class='keyword'>d</span></span><span class='keyword'>efine</span>&nbsp;<span class='ident'>l0_env_feedback_hook</span>&nbsp;<span class='lexic'>=</span><br>
&nbsp;&nbsp;<span class='ident'>mkref</span><span class='lexic'>(</span><span class='keyword'>&lambda;</span><span class='lexic'>(</span><span class='ident'>globenv</span><span class='lexic'>,</span>&nbsp;<span class='ident'>t</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>&#8709;</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;<br>
<span id='Z508841'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_env_feedback_loop</span><span class='lexic'>(</span><span id='Z508846'><span><span class='ident'>globenv</span></span></span><span class='lexic'>,</span>&nbsp;<span id='Z508847'><span><span class='ident'>t</span></span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;<span class='lexic'>(^</span><span class='ident'>l0_env_feedback_hook</span><span class='lexic'>)(</span><span class='idfrom' onmouseenter='srcref_over("Z508846",this)' onmouseleave='srcref_leave("Z508846",this)'><span><span class='ident'>globenv</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z508847",this)' onmouseleave='srcref_leave("Z508847",this)'><span><span class='ident'>t</span></span></span><span class='lexic'>)</span>
<p></div>


Unfortunately, macros imply a very eary exposure to the concept of environment,
which, again, we'd prefer to leave for much later down the pipeline. We'll keep
a dummy stub here instead.


<p><div class='code'>
<span id='Z508855'><span class='keyword'>d</span></span><span class='keyword'>efine</span>&nbsp;<span class='ident'>l0_env_find_macro_hook</span>&nbsp;<span class='lexic'>=</span><br>
&nbsp;&nbsp;<span class='ident'>mkref</span><span class='lexic'>(</span><span class='keyword'>&lambda;</span><span class='lexic'>(</span><span class='ident'>globenv</span><span class='lexic'>,</span>&nbsp;<span class='ident'>id</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>&#8709;</span><span class='lexic'>)</span>
<p></div>



<p><div class='code'>
<span id='Z508862'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_env_find_macro</span><span class='lexic'>(</span><span id='Z509719'><span><span class='ident'>globenv</span></span></span><span class='lexic'>,</span>&nbsp;<span id='Z509721'><span><span class='ident'>fn</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;<span id='Z509720'><span><span class='ident'>getid</span></span></span><span class='lexic'>(</span><span id='Z509298'><span><span class='ident'>fn</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>=</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0src</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>expr</span><span class='lexic'>:</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z509298",this)' onmouseleave='srcref_leave("Z509298",this)'><span><span class='ident'>fn</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>expr</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z509642'><span><span class='ident'>var</span></span></span>&nbsp;&#8594;&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z509642",this)' onmouseleave='srcref_leave("Z509642",this)'><span><span class='ident'>id</span></span></span><span class='hint'>var(id)</span></span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='lexic'>&#8709;</span><span class='lexic'>};</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>ident</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z509711'><span><span class='ident'>v</span></span></span>&nbsp;&#8594;&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z509711",this)' onmouseleave='srcref_leave("Z509711",this)'><span><span class='ident'>id</span></span></span><span class='hint'>v(id)</span></span>&nbsp;<span class='lexic'>|</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='lexic'>&#8709;</span><span class='lexic'>}};</span><br>
&nbsp;&nbsp;<span class='lexic'>(^</span><span class='ident'>l0_env_find_macro_hook</span><span class='lexic'>)(</span><span class='idfrom' onmouseenter='srcref_over("Z509719",this)' onmouseleave='srcref_leave("Z509719",this)'><span><span class='ident'>globenv</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z509720",this)' onmouseleave='srcref_leave("Z509720",this)'><span><span class='ident'>getid</span></span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z509721",this)' onmouseleave='srcref_leave("Z509721",this)'><span><span class='ident'>fn</span></span></span><span class='lexic'>))}</span>
<p></div>


In order to be able to implement macros we need an access to AST constructing
functions.  The easiest way of abstracting them out nicely is to use
quasiquotation: any AST inside the quasiquotation is translated into an
AST-constructing code that calls the appropriate runtime library functions.


<p><div class='code'>
<span id='Z509809'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_compile_quasiquote</span><span class='lexic'>(</span><span class='ident'>loop</span><span class='lexic'>,</span>&nbsp;<span id='Z510363'><span><span class='ident'>e</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;<span id='Z510674'><span><span class='ident'>mkapp</span></span></span><span class='lexic'>(</span><span id='Z510331'><span><span class='ident'>id</span></span></span><span class='lexic'>,</span>&nbsp;<span id='Z510338'><span><span class='ident'>args</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='keyword'>with</span>&nbsp;<span class='keyword'>target</span>&nbsp;<span class='lexic'>(</span><span class='ident'>lang0src</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>expr</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>apply</span><span class='hint'>lang0src:expr:apply(fn,args)</span></span><span class='lexic'>(</span><span class='ident'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>var</span><span class='hint'>lang0src:expr:var(id)</span></span><span class='lexic'>(</span><span class='ident'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>v</span><span class='hint'>lang0src:ident:v(id)</span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z510331",this)' onmouseleave='srcref_leave("Z510331",this)'><span><span class='ident'>id</span></span></span><span class='lexic'>)),</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z510338",this)' onmouseleave='srcref_leave("Z510338",this)'><span><span class='ident'>args</span></span></span><span class='lexic'>)};</span><br>
&nbsp;&nbsp;&nbsp;<span id='Z510842'><span><span class='ident'>mkqsymbol</span></span></span><span class='lexic'>(</span><span id='Z510351'><span><span class='ident'>id</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='keyword'>with</span>&nbsp;<span class='keyword'>target</span>&nbsp;<span class='lexic'>(</span><span class='ident'>lang0src</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>expr</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>const</span><span class='hint'>lang0src:expr:const(c)</span></span><span class='lexic'>(</span><span class='ident'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>symbol</span><span class='hint'>lang0src:const:symbol(s)</span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z510351",this)' onmouseleave='srcref_leave("Z510351",this)'><span><span class='ident'>id</span></span></span><span class='lexic'>))};</span><br>
&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0src</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>expr</span><span class='lexic'>:</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z510363",this)' onmouseleave='srcref_leave("Z510363",this)'><span><span class='ident'>e</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>once</span>&nbsp;<span class='ident'>expr</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z510830'><span><span class='ident'>unquote</span></span></span>&nbsp;&#8594;&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z510830",this)' onmouseleave='srcref_leave("Z510830",this)'><span><span class='ident'>e</span></span></span><span class='hint'>unquote(e)</span></span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='keyword'>deep</span>&nbsp;&#8594;&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z510678'><span><span class='ident'>lambda</span></span></span>&nbsp;&#8594;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z510674",this)' onmouseleave='srcref_leave("Z510674",this)'><span><span class='ident'>mkapp</span></span></span><span class='lexic'>(</span><span class='symbol'>'macrolib.make_lambda'</span><span class='lexic'>,</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>[</span><span class='idfrom' onmouseenter='srcref_over("Z510674",this)' onmouseleave='srcref_leave("Z510674",this)'><span><span class='ident'>mkapp</span></span></span><span class='lexic'>(</span><span class='symbol'>'macrolib.make_list'</span><span class='lexic'>,</span>&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>mklist</span><span class='hint'>lang0src:expr:mklist(es)</span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z510678",this)' onmouseleave='srcref_leave("Z510678",this)'><span><span class='ident'>args</span></span></span><span class='hint'>lambda(args,body)</span></span><span class='lexic'>));</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z510678",this)' onmouseleave='srcref_leave("Z510678",this)'><span><span class='ident'>body</span></span></span><span class='hint'>lambda(args,body)</span></span><span class='lexic'>])</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;&nbsp;<span id='Z510694'><span><span class='ident'>seq</span></span></span>&nbsp;&#8594;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z510674",this)' onmouseleave='srcref_leave("Z510674",this)'><span><span class='ident'>mkapp</span></span></span><span class='lexic'>(</span><span class='symbol'>'macrolib.make_seq'</span><span class='lexic'>,</span>&nbsp;<span class='lexic'>[</span><span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>mklist</span><span class='hint'>lang0src:expr:mklist(es)</span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z510694",this)' onmouseleave='srcref_leave("Z510694",this)'><span><span class='ident'>body</span></span></span><span class='hint'>seq(body)</span></span><span class='lexic'>)])</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;&nbsp;<span class='ident'>const</span>&nbsp;&#8594;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z510674",this)' onmouseleave='srcref_leave("Z510674",this)'><span><span class='ident'>mkapp</span></span></span><span class='lexic'>(</span><span class='symbol'>'macrolib.make_const'</span><span class='lexic'>,</span>&nbsp;<span class='lexic'>[</span><span class='ident'>node</span><span class='lexic'>()])</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;&nbsp;<span id='Z510708'><span><span class='ident'>var</span></span></span>&nbsp;&#8594;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z510674",this)' onmouseleave='srcref_leave("Z510674",this)'><span><span class='ident'>mkapp</span></span></span><span class='lexic'>(</span><span class='symbol'>'macrolib.make_var'</span><span class='lexic'>,</span>&nbsp;<span class='lexic'>[</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z510708",this)' onmouseleave='srcref_leave("Z510708",this)'><span><span class='ident'>id</span></span></span><span class='hint'>var(id)</span></span><span class='lexic'>])</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;&nbsp;<span id='Z510717'><span><span class='ident'>apply</span></span></span>&nbsp;&#8594;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z510674",this)' onmouseleave='srcref_leave("Z510674",this)'><span><span class='ident'>mkapp</span></span></span><span class='lexic'>(</span><span class='symbol'>'macrolib.make_apply'</span><span class='lexic'>,</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>[</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z510717",this)' onmouseleave='srcref_leave("Z510717",this)'><span><span class='ident'>fn</span></span></span><span class='hint'>apply(fn,args)</span></span><span class='lexic'>;</span>&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>mklist</span><span class='hint'>lang0src:expr:mklist(es)</span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z510717",this)' onmouseleave='srcref_leave("Z510717",this)'><span><span class='ident'>args</span></span></span><span class='hint'>apply(fn,args)</span></span><span class='lexic'>)])</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;&nbsp;<span id='Z510739'><span><span class='ident'>apply2</span></span></span>&nbsp;&#8594;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z510674",this)' onmouseleave='srcref_leave("Z510674",this)'><span><span class='ident'>mkapp</span></span></span><span class='lexic'>(</span><span class='symbol'>'macrolib.make_apply2'</span><span class='lexic'>,</span>&nbsp;<span class='lexic'>[</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z510739",this)' onmouseleave='srcref_leave("Z510739",this)'><span><span class='ident'>fn</span></span></span><span class='hint'>apply2(fn,L,R)</span></span><span class='lexic'>;</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z510739",this)' onmouseleave='srcref_leave("Z510739",this)'><span><span class='ident'>L</span></span></span><span class='hint'>apply2(fn,L,R)</span></span><span class='lexic'>;</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z510739",this)' onmouseleave='srcref_leave("Z510739",this)'><span><span class='ident'>R</span></span></span><span class='hint'>apply2(fn,L,R)</span></span><span class='lexic'>])</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;&nbsp;<span id='Z510755'><span><span class='ident'>if3</span></span></span>&nbsp;&#8594;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z510674",this)' onmouseleave='srcref_leave("Z510674",this)'><span><span class='ident'>mkapp</span></span></span><span class='lexic'>(</span><span class='symbol'>'macrolib.make_if3'</span><span class='lexic'>,</span>&nbsp;<span class='lexic'>[</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z510755",this)' onmouseleave='srcref_leave("Z510755",this)'><span><span class='ident'>cnd</span></span></span><span class='hint'>if3(cnd,tr,fl)</span></span><span class='lexic'>;</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z510755",this)' onmouseleave='srcref_leave("Z510755",this)'><span><span class='ident'>tr</span></span></span><span class='hint'>if3(cnd,tr,fl)</span></span><span class='lexic'>;</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z510755",this)' onmouseleave='srcref_leave("Z510755",this)'><span><span class='ident'>fl</span></span></span><span class='hint'>if3(cnd,tr,fl)</span></span><span class='lexic'>])</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;&nbsp;<span id='Z510768'><span><span class='ident'>if2</span></span></span>&nbsp;&#8594;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z510674",this)' onmouseleave='srcref_leave("Z510674",this)'><span><span class='ident'>mkapp</span></span></span><span class='lexic'>(</span><span class='symbol'>'macrolib.make_if2'</span><span class='lexic'>,</span>&nbsp;<span class='lexic'>[</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z510768",this)' onmouseleave='srcref_leave("Z510768",this)'><span><span class='ident'>cnd</span></span></span><span class='hint'>if2(cnd,tr)</span></span><span class='lexic'>;</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z510768",this)' onmouseleave='srcref_leave("Z510768",this)'><span><span class='ident'>tr</span></span></span><span class='hint'>if2(cnd,tr)</span></span><span class='lexic'>])</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;&nbsp;<span id='Z510782'><span><span class='ident'>let</span></span></span>&nbsp;&#8594;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z510674",this)' onmouseleave='srcref_leave("Z510674",this)'><span><span class='ident'>mkapp</span></span></span><span class='lexic'>(</span><span class='symbol'>'macrolib.make_let'</span><span class='lexic'>,</span>&nbsp;<span class='lexic'>[</span><span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>mklist</span><span class='hint'>lang0src:expr:mklist(es)</span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z510782",this)' onmouseleave='srcref_leave("Z510782",this)'><span><span class='ident'>ps</span></span></span><span class='hint'>let(ps,body)</span></span><span class='lexic'>);</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z510782",this)' onmouseleave='srcref_leave("Z510782",this)'><span><span class='ident'>body</span></span></span><span class='hint'>let(ps,body)</span></span><span class='lexic'>])</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;&nbsp;<span id='Z510798'><span><span class='ident'>mklist</span></span></span>&nbsp;&#8594;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z510674",this)' onmouseleave='srcref_leave("Z510674",this)'><span><span class='ident'>mkapp</span></span></span><span class='lexic'>(</span><span class='symbol'>'macrolib.make_mklist'</span><span class='lexic'>,</span>&nbsp;<span class='lexic'>[</span><span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>mklist</span><span class='hint'>lang0src:expr:mklist(es)</span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z510798",this)' onmouseleave='srcref_leave("Z510798",this)'><span><span class='ident'>es</span></span></span><span class='hint'>mklist(es)</span></span><span class='lexic'>)])</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;&nbsp;<span id='Z510821'><span><span class='ident'>toplift</span></span></span>&nbsp;&#8594;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z510674",this)' onmouseleave='srcref_leave("Z510674",this)'><span><span class='ident'>mkapp</span></span></span><span class='lexic'>(</span><span class='symbol'>'macrolib.make_toplift'</span><span class='lexic'>,</span>&nbsp;<span class='lexic'>[</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z510821",this)' onmouseleave='srcref_leave("Z510821",this)'><span><span class='ident'>t</span></span></span><span class='hint'>toplift(t)</span></span><span class='lexic'>])</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='withhint'><span class='ident'>ccerror</span><span class='hint'>function&nbsp;ccerror&nbsp;arg:&nbsp;<br>
Raises&nbsp;[MBaseException]&nbsp;with&nbsp;a&nbsp;given&nbsp;argument.</span></span><span class='lexic'>(</span><span class='symbol'>'IMPOSSIBLE'</span><span class='lexic'>())}};</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>ident</span>&nbsp;<span class='lexic'>{</span>&nbsp;<span id='Z510843'><span><span class='ident'>v</span></span></span>&nbsp;&#8594;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z510842",this)' onmouseleave='srcref_leave("Z510842",this)'><span><span class='ident'>mkqsymbol</span></span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z510843",this)' onmouseleave='srcref_leave("Z510843",this)'><span><span class='ident'>id</span></span></span><span class='hint'>v(id)</span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>|</span>&nbsp;<span id='Z510836'><span><span class='ident'>unquote</span></span></span>&nbsp;&#8594;&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z510836",this)' onmouseleave='srcref_leave("Z510836",this)'><span><span class='ident'>e</span></span></span><span class='hint'>unquote(e)</span></span>&nbsp;<span class='lexic'>};</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>letpair</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z510852'><span><span class='ident'>p</span></span></span>&nbsp;&#8594;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z510674",this)' onmouseleave='srcref_leave("Z510674",this)'><span><span class='ident'>mkapp</span></span></span><span class='lexic'>(</span><span class='symbol'>'macrolib.make_letpair'</span><span class='lexic'>,</span>&nbsp;<span class='lexic'>[</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z510852",this)' onmouseleave='srcref_leave("Z510852",this)'><span><span class='ident'>id</span></span></span><span class='hint'>p(id,v)</span></span><span class='lexic'>;</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z510852",this)' onmouseleave='srcref_leave("Z510852",this)'><span><span class='ident'>v</span></span></span><span class='hint'>p(id,v)</span></span><span class='lexic'>])};</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>top</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z510863'><span><span class='ident'>define</span></span></span>&nbsp;&#8594;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z510674",this)' onmouseleave='srcref_leave("Z510674",this)'><span><span class='ident'>mkapp</span></span></span><span class='lexic'>(</span><span class='symbol'>'macrolib.make_define'</span><span class='lexic'>,</span>&nbsp;<span class='lexic'>[</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z510863",this)' onmouseleave='srcref_leave("Z510863",this)'><span><span class='ident'>id</span></span></span><span class='hint'>define(id,e)</span></span><span class='lexic'>;</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z510863",this)' onmouseleave='srcref_leave("Z510863",this)'><span><span class='ident'>e</span></span></span><span class='hint'>define(id,e)</span></span><span class='lexic'>])</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span id='Z510874'><span><span class='ident'>defmacro</span></span></span>&nbsp;&#8594;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z510674",this)' onmouseleave='srcref_leave("Z510674",this)'><span><span class='ident'>mkapp</span></span></span><span class='lexic'>(</span><span class='symbol'>'macrolib.make_defmacro'</span><span class='lexic'>,</span>&nbsp;<span class='lexic'>[</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z510874",this)' onmouseleave='srcref_leave("Z510874",this)'><span><span class='ident'>id</span></span></span><span class='hint'>defmacro(id,e)</span></span><span class='lexic'>;</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z510874",this)' onmouseleave='srcref_leave("Z510874",this)'><span><span class='ident'>e</span></span></span><span class='hint'>defmacro(id,e)</span></span><span class='lexic'>])</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span id='Z510882'><span><span class='ident'>expr</span></span></span>&nbsp;&#8594;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z510674",this)' onmouseleave='srcref_leave("Z510674",this)'><span><span class='ident'>mkapp</span></span></span><span class='lexic'>(</span><span class='symbol'>'macrolib.make_expr'</span><span class='lexic'>,</span>&nbsp;<span class='lexic'>[</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z510882",this)' onmouseleave='srcref_leave("Z510882",this)'><span><span class='ident'>e</span></span></span><span class='hint'>expr(e)</span></span><span class='lexic'>])</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>debug</span>&nbsp;&#8594;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z510674",this)' onmouseleave='srcref_leave("Z510674",this)'><span><span class='ident'>mkapp</span></span></span><span class='lexic'>(</span><span class='symbol'>'macrolib.make_debug'</span><span class='lexic'>,</span>&nbsp;<span class='lexic'>&#8709;</span><span class='lexic'>)}}}</span>
<p></div>


Expression expansion pass includes handling the quasiquote nodes (consider
quasiquote a special kind of a "macro") and user-defined macros applied via the
compiler feedback loop.


<p><div class='code'>
<span id='Z511013'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_macro_expand_expr</span><span class='lexic'>(</span><span id='Z511827'><span><span class='ident'>globenv</span></span></span><span class='lexic'>,</span>&nbsp;<span id='Z511833'><span><span class='ident'>addtop</span></span></span><span class='lexic'>,</span>&nbsp;<span id='Z511470'><span><span class='ident'>e</span></span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0src</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>expr</span><span class='lexic'>:</span><span class='idfrom' onmouseenter='srcref_over("Z511470",this)' onmouseleave='srcref_leave("Z511470",this)'><span><span class='ident'>e</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>once</span>&nbsp;<span class='ident'>expr</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z511915'><span><span class='ident'>quasiquote</span></span></span>&nbsp;&#8594;&nbsp;<a href='#Z509809'><span class='ident'>l0_compile_quasiquote</span></a><span class='lexic'>(</span><span class='keyword'>&lambda;</span><span class='lexic'>(</span><span id='Z511914'><span><span class='ident'>e0</span></span></span><span class='lexic'>)</span>&nbsp;<a href='#Z511013'><span class='ident'>l0_macro_expand_expr</span></a><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z511827",this)' onmouseleave='srcref_leave("Z511827",this)'><span><span class='ident'>globenv</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z511833",this)' onmouseleave='srcref_leave("Z511833",this)'><span><span class='ident'>addtop</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z511914",this)' onmouseleave='srcref_leave("Z511914",this)'><span><span class='ident'>e0</span></span></span><span class='lexic'>)</span><span class='lexic'>,</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z511915",this)' onmouseleave='srcref_leave("Z511915",this)'><span><span class='ident'>e</span></span></span><span class='hint'>quasiquote(e)</span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>unquote</span>&nbsp;&#8594;&nbsp;<span class='withhint'><span class='ident'>ccerror</span><span class='hint'>function&nbsp;ccerror&nbsp;arg:&nbsp;<br>
Raises&nbsp;[MBaseException]&nbsp;with&nbsp;a&nbsp;given&nbsp;argument.</span></span><span class='lexic'>(</span><span class='symbol'>'MISPLACED-UNQUOTE'</span><span class='lexic'>())</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span id='Z511828'><span><span class='ident'>apply</span></span></span>&nbsp;&nbsp;&nbsp;&#8594;&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z511831'><span><span class='ident'>ismacro</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<a href='#Z508862'><span class='ident'>l0_env_find_macro</span></a><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z511827",this)' onmouseleave='srcref_leave("Z511827",this)'><span><span class='ident'>globenv</span></span></span><span class='lexic'>,</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z511828",this)' onmouseleave='srcref_leave("Z511828",this)'><span><span class='ident'>fn</span></span></span><span class='hint'>apply(fn,args)</span></span><span class='lexic'>);</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>if</span>&nbsp;<span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z511831",this)' onmouseleave='srcref_leave("Z511831",this)'><span><span class='ident'>ismacro</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z511834'><span><span class='ident'>nxt</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z511831",this)' onmouseleave='srcref_leave("Z511831",this)'><span><span class='ident'>ismacro</span></span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z511827",this)' onmouseleave='srcref_leave("Z511827",this)'><span><span class='ident'>globenv</span></span></span><span class='lexic'>,</span>&nbsp;<span class='ident'>node</span><span class='lexic'>());</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href='#Z511013'><span class='ident'>l0_macro_expand_expr</span></a><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z511827",this)' onmouseleave='srcref_leave("Z511827",this)'><span><span class='ident'>globenv</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z511833",this)' onmouseleave='srcref_leave("Z511833",this)'><span><span class='ident'>addtop</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z511834",this)' onmouseleave='srcref_leave("Z511834",this)'><span><span class='ident'>nxt</span></span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>}</span>&nbsp;<span class='keyword'>else</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='keyword'>node</span><span class='hint'>lang0src:expr:apply(fn,args)</span></span><span class='lexic'>(</span><span class='ident'>fn</span>&nbsp;<span class='lexic'>=</span>&nbsp;<a href='#Z511013'><span class='ident'>l0_macro_expand_expr</span></a><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z511827",this)' onmouseleave='srcref_leave("Z511827",this)'><span><span class='ident'>globenv</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z511833",this)' onmouseleave='srcref_leave("Z511833",this)'><span><span class='ident'>addtop</span></span></span><span class='lexic'>,</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z511828",this)' onmouseleave='srcref_leave("Z511828",this)'><span><span class='ident'>fn</span></span></span><span class='hint'>apply(fn,args)</span></span><span class='lexic'>),</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='ident'>args</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='keyword'>map</span>&nbsp;<span id='Z511848'><span><span class='ident'>a</span></span></span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z511828",this)' onmouseleave='srcref_leave("Z511828",this)'><span><span class='ident'>args</span></span></span><span class='hint'>apply(fn,args)</span></span>&nbsp;<span class='keyword'>do</span>&nbsp;<a href='#Z511013'><span class='ident'>l0_macro_expand_expr</span></a><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z511827",this)' onmouseleave='srcref_leave("Z511827",this)'><span><span class='ident'>globenv</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z511833",this)' onmouseleave='srcref_leave("Z511833",this)'><span><span class='ident'>addtop</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z511848",this)' onmouseleave='srcref_leave("Z511848",this)'><span><span class='ident'>a</span></span></span><span class='lexic'>))</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='keyword'>deep</span>&nbsp;&#8594;&nbsp;<span class='lexic'>{</span>&nbsp;<span class='ident'>toplift</span>&nbsp;&#8594;&nbsp;<span class='lexic'>{</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z511833",this)' onmouseleave='srcref_leave("Z511833",this)'><span><span class='ident'>addtop</span></span></span><span class='lexic'>(</span><span class='ident'>node</span><span class='lexic'>());</span>&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>seq</span><span class='hint'>lang0src:expr:seq(body)</span></span><span class='lexic'>(</span><span class='ident'>body</span><span class='lexic'>=</span><span class='lexic'>&#8709;</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='ident'>node</span><span class='lexic'>()</span>&nbsp;<span class='lexic'>}}}</span>
<p></div>



<p><div class='code'>
<span id='Z512020'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_macro_expand_top</span><span class='lexic'>(</span><span id='Z512789'><span><span class='ident'>globenv</span></span></span><span class='lexic'>,</span>&nbsp;<span id='Z512790'><span><span class='ident'>addtop</span></span></span><span class='lexic'>,</span>&nbsp;<span id='Z512454'><span><span class='ident'>t</span></span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0src</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>top</span><span class='lexic'>:</span><span class='idfrom' onmouseenter='srcref_over("Z512454",this)' onmouseleave='srcref_leave("Z512454",this)'><span><span class='ident'>t</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>once</span>&nbsp;<span class='ident'>expr</span>&nbsp;<span class='lexic'>{</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href='#Z511013'><span class='ident'>l0_macro_expand_expr</span></a><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z512789",this)' onmouseleave='srcref_leave("Z512789",this)'><span><span class='ident'>globenv</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z512790",this)' onmouseleave='srcref_leave("Z512790",this)'><span><span class='ident'>addtop</span></span></span><span class='lexic'>,</span>&nbsp;<span class='ident'>node</span><span class='lexic'>())</span>&nbsp;<span class='lexic'>}}</span>
<p></div>



<p><div class='code'>
<span id='Z512954'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_macro_expand</span><span class='lexic'>(</span><span id='Z513797'><span><span class='ident'>globenv</span></span></span><span class='lexic'>,</span>&nbsp;<span id='Z513397'><span><span class='ident'>ts</span></span></span><span class='lexic'>)</span><br>
<span class='keyword'>collector</span>&nbsp;<span class='lexic'>(</span><span id='Z513796'><span><span class='ident'>addtop</span></span></span><span class='lexic'>,</span>&nbsp;<span id='Z513821'><span><span class='ident'>gettop</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;<span class='keyword'>iter</span>&nbsp;<span id='Z513404'><span><span class='ident'>t</span></span></span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z513397",this)' onmouseleave='srcref_leave("Z513397",this)'><span><span class='ident'>ts</span></span></span>&nbsp;<span class='keyword'>do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0src</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>top</span><span class='lexic'>:</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z513404",this)' onmouseleave='srcref_leave("Z513404",this)'><span><span class='ident'>t</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>once</span>&nbsp;<span class='ident'>top</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='ident'>defmacro</span>&nbsp;&#8594;&nbsp;<a href='#Z508841'><span class='ident'>l0_env_feedback_loop</span></a><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z513797",this)' onmouseleave='srcref_leave("Z513797",this)'><span><span class='ident'>globenv</span></span></span><span class='lexic'>,</span>&nbsp;<span class='ident'>node</span><span class='lexic'>())</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z513796",this)' onmouseleave='srcref_leave("Z513796",this)'><span><span class='ident'>addtop</span></span></span><span class='lexic'>(</span><a href='#Z512020'><span class='ident'>l0_macro_expand_top</span></a><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z513797",this)' onmouseleave='srcref_leave("Z513797",this)'><span><span class='ident'>globenv</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z513796",this)' onmouseleave='srcref_leave("Z513796",this)'><span><span class='ident'>addtop</span></span></span><span class='lexic'>,</span>&nbsp;<span class='ident'>node</span><span class='lexic'>()))}};</span><br>
&nbsp;&nbsp;&nbsp;<span class='keyword'>return</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z513821",this)' onmouseleave='srcref_leave("Z513821",this)'><span><span class='ident'>gettop</span></span></span><span class='lexic'>()}</span>
<p></div>


<h3>Cleanup</h3>

Now all the quasiquotations, macro applications and top lift nodes are eliminated and we can turn our AST
into a form suitable for the rest of the compiler pipeline.


<p><div class='code'>
<span id='Z513909'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_postexpand_sanitise</span><span class='lexic'>(</span><span id='Z514344'><span><span class='ident'>ts</span></span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;<span class='keyword'>map</span>&nbsp;<span id='Z514352'><span><span class='ident'>t</span></span></span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z514344",this)' onmouseleave='srcref_leave("Z514344",this)'><span><span class='ident'>ts</span></span></span>&nbsp;<span class='keyword'>do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0src</span>&nbsp;<span class='lexic'>/rec,</span>&nbsp;<span class='lexic'>dst</span>&nbsp;<span class='ident'>lang0</span><span class='lexic'>/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>top</span><span class='lexic'>:</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z514352",this)' onmouseleave='srcref_leave("Z514352",this)'><span><span class='ident'>t</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>expr</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='ident'>toplift</span>&nbsp;&#8594;&nbsp;<span class='withhint'><span class='ident'>ccerror</span><span class='hint'>function&nbsp;ccerror&nbsp;arg:&nbsp;<br>
Raises&nbsp;[MBaseException]&nbsp;with&nbsp;a&nbsp;given&nbsp;argument.</span></span><span class='lexic'>(</span><span class='symbol'>'IMPOSSIBLE'</span><span class='lexic'>())</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>quasiquote</span>&nbsp;&#8594;&nbsp;<span class='withhint'><span class='ident'>ccerror</span><span class='hint'>function&nbsp;ccerror&nbsp;arg:&nbsp;<br>
Raises&nbsp;[MBaseException]&nbsp;with&nbsp;a&nbsp;given&nbsp;argument.</span></span><span class='lexic'>(</span><span class='symbol'>'IMPOSSIBLE'</span><span class='lexic'>())</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>unquote</span>&nbsp;&#8594;&nbsp;<span class='withhint'><span class='ident'>ccerror</span><span class='hint'>function&nbsp;ccerror&nbsp;arg:&nbsp;<br>
Raises&nbsp;[MBaseException]&nbsp;with&nbsp;a&nbsp;given&nbsp;argument.</span></span><span class='lexic'>(</span><span class='symbol'>'IMPOSSIBLE'</span><span class='lexic'>())</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='ident'>node</span><span class='lexic'>()</span><span class='lexic'>};</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>ident</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='ident'>unquote</span>&nbsp;&#8594;&nbsp;<span class='withhint'><span class='ident'>ccerror</span><span class='hint'>function&nbsp;ccerror&nbsp;arg:&nbsp;<br>
Raises&nbsp;[MBaseException]&nbsp;with&nbsp;a&nbsp;given&nbsp;argument.</span></span><span class='lexic'>(</span><span class='symbol'>'IMPOSSIBLE'</span><span class='lexic'>())</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span id='Z514762'><span><span class='ident'>v</span></span></span>&nbsp;&#8594;&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z514762",this)' onmouseleave='srcref_leave("Z514762",this)'><span><span class='ident'>id</span></span></span><span class='hint'>v(id)</span></span><span class='lexic'>}}</span>
<p></div>


For the compiler pipeline demo purposes we need a dummy environment:


<p><div class='code'>
<span id='Z514857'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_expand_dummy</span><span class='lexic'>(</span><span id='Z514859'><span><span class='ident'>ts</span></span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;<a href='#Z513909'><span class='ident'>l0_postexpand_sanitise</span></a><span class='lexic'>(</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<a href='#Z512954'><span class='ident'>l0_macro_expand</span></a><span class='lexic'>(</span><span class='ident'>mkhash</span><span class='lexic'>(),</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z514859",this)' onmouseleave='srcref_leave("Z514859",this)'><span><span class='ident'>ts</span></span></span><span class='lexic'>))</span>
<p></div>






<h2 id="sugar">Lowering</h2>

<p>Our first AST is designed for parsing, but it is not very useful for any further analysis, optimisations and
a code generation. Before we start actually compiling anything we have to eliminate some syntax sugar and make this
AST simpler.

<h3>Eliminating syntax sugar</h3>

<p>The two argument application node was only introduced to simplify binary expressions parsing and must go.

<p>This is our first introduction to <i>visitors</i> - a fundamental building block in PFront. Visitor walks
over an AST in a defined order and builds a new AST, transforming certain nodes with given expressions. In this
case we only rewrite <b>apply2</b> variant of an <b>expr</b> node, with all the boilerplate covering all possible
paths to <b>expr</b> nodes being inferred automatically.

<p>Variant constructors like <b>mk:apply</b> are context-dependent, in this visitor we know that the resulting
AST is the same as the original AST, so it constructs <b>lang0:expr:apply</b> variants.

<p>This function takes a list of toplevel statements as an argument, and returns a list of transformed toplevel
statements.


<p><div class='code'>
<span id='Z514863'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_eliminate_apply2</span><span class='lexic'>(</span><span id='Z515213'><span><span class='ident'>ts</span></span></span><span class='lexic'>)</span><br>
&nbsp;<span class='comment'>//&nbsp;'ts'&nbsp;is&nbsp;a&nbsp;list&nbsp;of&nbsp;top&nbsp;statements,<br>
</span>&nbsp;<span class='comment'>//&nbsp;&nbsp;&nbsp;we'll&nbsp;visit&nbsp;them&nbsp;one&nbsp;by&nbsp;one<br>
</span>&nbsp;<span class='keyword'>map</span>&nbsp;<span id='Z515221'><span><span class='ident'>t</span></span></span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z515213",this)' onmouseleave='srcref_leave("Z515213",this)'><span><span class='ident'>ts</span></span></span>&nbsp;<span class='keyword'>do</span><br>
&nbsp;&nbsp;<span class='comment'>//&nbsp;A&nbsp;visitor&nbsp;block:<br>
</span>&nbsp;&nbsp;<span class='comment'>//&nbsp;&nbsp;*&nbsp;&nbsp;The&nbsp;source&nbsp;AST&nbsp;is&nbsp;'lang0',&nbsp;destination&nbsp;is&nbsp;the&nbsp;same<br>
</span>&nbsp;&nbsp;<span class='comment'>//&nbsp;&nbsp;*&nbsp;&nbsp;It's&nbsp;a&nbsp;recform&nbsp;AST&nbsp;(not&nbsp;an&nbsp;old&nbsp;list-based&nbsp;one)<br>
</span>&nbsp;&nbsp;<span class='comment'>//&nbsp;&nbsp;*&nbsp;&nbsp;The&nbsp;entry&nbsp;point&nbsp;is&nbsp;a&nbsp;'top'&nbsp;node<br>
</span>&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>top</span><span class='lexic'>:</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z515221",this)' onmouseleave='srcref_leave("Z515221",this)'><span><span class='ident'>t</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='comment'>//&nbsp;All&nbsp;the&nbsp;'expr'&nbsp;nodes&nbsp;are&nbsp;visited&nbsp;in&nbsp;a&nbsp;depth-first&nbsp;order<br>
</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>expr</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='comment'>//&nbsp;All&nbsp;the&nbsp;'apply2'&nbsp;variants&nbsp;of&nbsp;'expr'&nbsp;are&nbsp;rewritten<br>
</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='comment'>//&nbsp;&nbsp;as&nbsp;'apply'&nbsp;variants<br>
</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z515501'><span><span class='ident'>apply2</span></span></span>&nbsp;&#8594;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>apply</span><span class='hint'>lang0:expr:apply(fn,args)</span></span><span class='lexic'>(</span><span class='ident'>fn</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>var</span><span class='hint'>lang0:expr:var(id)</span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z515501",this)' onmouseleave='srcref_leave("Z515501",this)'><span><span class='ident'>fn</span></span></span><span class='hint'>apply2(fn,L,R)</span></span><span class='lexic'>),</span>&nbsp;<span class='ident'>args</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='lexic'>[</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z515501",this)' onmouseleave='srcref_leave("Z515501",this)'><span><span class='ident'>L</span></span></span><span class='hint'>apply2(fn,L,R)</span></span><span class='lexic'>;</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z515501",this)' onmouseleave='srcref_leave("Z515501",this)'><span><span class='ident'>R</span></span></span><span class='hint'>apply2(fn,L,R)</span></span><span class='lexic'>])</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='comment'>//&nbsp;All&nbsp;the&nbsp;other&nbsp;variants&nbsp;will&nbsp;remain&nbsp;the&nbsp;same<br>
</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='ident'>node</span><span class='lexic'>()</span><span class='lexic'>}}</span>
<p></div>


<p>A two-armed <b>if</b> does not make sense in an expression--based language and it must go. An implicit false branch
returns a nil constant.


<p><div class='code'>
<span id='Z515627'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_eliminate_if2</span><span class='lexic'>(</span><span id='Z515986'><span><span class='ident'>ts</span></span></span><span class='lexic'>)</span><br>
&nbsp;<span class='keyword'>map</span>&nbsp;<span id='Z515994'><span><span class='ident'>t</span></span></span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z515986",this)' onmouseleave='srcref_leave("Z515986",this)'><span><span class='ident'>ts</span></span></span>&nbsp;<span class='keyword'>do</span><br>
&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>top</span><span class='lexic'>:</span><span class='idfrom' onmouseenter='srcref_over("Z515994",this)' onmouseleave='srcref_leave("Z515994",this)'><span><span class='ident'>t</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>expr</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='ident'>if2</span>&nbsp;&#8594;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>if3</span><span class='hint'>lang0:expr:if3(cnd,tr,fl)<br>
&nbsp;&nbsp;&nbsp;with&nbsp;implicit&nbsp;arguments:&nbsp;cnd,&nbsp;tr<br>
</span></span><span class='lexic'>(</span><span class='ident'>fl</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>const</span><span class='hint'>lang0:expr:const(c)</span></span><span class='lexic'>(</span><span class='ident'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>nil</span><span class='hint'>lang0:const:nil()</span></span><span class='lexic'>()))</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='ident'>node</span><span class='lexic'>()</span><span class='lexic'>}}</span>
<p></div>


<p>And a list constructor is just a sequence of nested <b>cons</b> applications. We do not care if it's entirely
constant at this stage, all the optimisations can be done at a later stage.


<p><div class='code'>
<span id='Z516399'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_eliminate_list</span><span class='lexic'>(</span><span id='Z516773'><span><span class='ident'>ts</span></span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;<span class='keyword'>map</span>&nbsp;<span id='Z516781'><span><span class='ident'>t</span></span></span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z516773",this)' onmouseleave='srcref_leave("Z516773",this)'><span><span class='ident'>ts</span></span></span>&nbsp;<span class='keyword'>do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>top</span><span class='lexic'>:</span><span class='idfrom' onmouseenter='srcref_over("Z516781",this)' onmouseleave='srcref_leave("Z516781",this)'><span><span class='ident'>t</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>expr</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z517123'><span><span class='ident'>mklist</span></span></span>&nbsp;&#8594;&nbsp;<span class='keyword'>do</span>&nbsp;<span id='Z517100'><span><span class='ident'>loop</span></span></span><span class='lexic'>(</span><span id='Z517122'><span><span class='ident'>e</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z517123",this)' onmouseleave='srcref_leave("Z517123",this)'><span><span class='ident'>es</span></span></span><span class='hint'>mklist(es)</span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>match</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z517122",this)' onmouseleave='srcref_leave("Z517122",this)'><span><span class='ident'>e</span></span></span>&nbsp;<span class='keyword'>with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z517099'><span><span class='ident'><span class='pattern'>hd</span></span></span></span><span class='pattern'>&nbsp;</span><span class='lexic'><span class='pattern'>:</span></span><span class='pattern'>&nbsp;</span><span id='Z517101'><span><span class='ident'><span class='pattern'>tl</span></span></span></span>&nbsp;&#8594;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>apply</span><span class='hint'>lang0:expr:apply(fn,args)</span></span><span class='lexic'>(</span><span class='ident'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>var</span><span class='hint'>lang0:expr:var(id)</span></span><span class='lexic'>(</span><span class='symbol'>'cons'</span><span class='lexic'>),</span>&nbsp;<span class='lexic'>[</span><span class='idfrom' onmouseenter='srcref_over("Z517099",this)' onmouseleave='srcref_leave("Z517099",this)'><span><span class='ident'>hd</span></span></span><span class='lexic'>;</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z517100",this)' onmouseleave='srcref_leave("Z517100",this)'><span><span class='ident'>loop</span></span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z517101",this)' onmouseleave='srcref_leave("Z517101",this)'><span><span class='ident'>tl</span></span></span><span class='lexic'>)])</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='lexic'><span class='pattern'>&#8709;</span></span>&nbsp;&#8594;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>const</span><span class='hint'>lang0:expr:const(c)</span></span><span class='lexic'>(</span><span class='ident'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>nil</span><span class='hint'>lang0:const:nil()</span></span><span class='lexic'>())}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='ident'>node</span><span class='lexic'>()</span><span class='lexic'>}}</span>
<p></div>


<p>And everything together now:


<p><div class='code'>
<span id='Z517221'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_lowering</span><span class='lexic'>(</span><span id='Z517223'><span><span class='ident'>ts</span></span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;<a href='#Z516399'><span class='ident'>l0_eliminate_list</span></a><span class='lexic'>(</span><br>
&nbsp;&nbsp;&nbsp;<a href='#Z515627'><span class='ident'>l0_eliminate_if2</span></a><span class='lexic'>(</span><br>
&nbsp;&nbsp;&nbsp;<a href='#Z514863'><span class='ident'>l0_eliminate_apply2</span></a><span class='lexic'>(</span><br>
&nbsp;&nbsp;&nbsp;<a href='#Z514857'><span class='ident'>l0_expand_dummy</span></a><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z517223",this)' onmouseleave='srcref_leave("Z517223",this)'><span><span class='ident'>ts</span></span></span><span class='lexic'>))))</span>
<p></div>



<h2 id="lexical">Lexical scope</h2>

<p>This is a lexically scoped language, allowing new definitions to override an outer scope. This is a default
design decision for languages with pattern matching, for example. Our core language does not have any pattern
matching support, but it can be added later with macros and syntax extensions.

<p>The simplest approach to lexical scope implementation is to just rename all the variables to make them unique.
In a consequent pass we'll collect variable and argument declarations and sort everything into categories -
global variables, local variables and lambda arguments. Another category to appear later (after a lambda
lifting pass) is a closure variable.


<p><div class='code'>
<span id='Z517227'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_lexical_scope_expr</span><span class='lexic'>(</span><span id='Z519048'><span><span class='ident'>e0</span></span></span><span class='lexic'>,</span>&nbsp;<span id='Z518910'><span><span class='ident'>addrenames</span></span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;<span class='keyword'>do</span>&nbsp;<span id='Z518683'><span><span class='ident'>loop</span></span></span><span class='lexic'>(</span><span id='Z518702'><span><span class='ident'>e</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z519048",this)' onmouseleave='srcref_leave("Z519048",this)'><span><span class='ident'>e0</span></span></span><span class='lexic'>,</span>&nbsp;<span id='Z518686'><span><span class='ident'>env</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='lexic'>&#8709;</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='comment'>//&nbsp;A&nbsp;helper&nbsp;function,&nbsp;returns&nbsp;a&nbsp;new&nbsp;name&nbsp;if&nbsp;it&nbsp;is&nbsp;in&nbsp;the&nbsp;current<br>
</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='comment'>//&nbsp;environment&nbsp;or&nbsp;id&nbsp;unchanged&nbsp;(meaning&nbsp;it's&nbsp;a&nbsp;global&nbsp;name)<br>
</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z518678'><span><span class='ident'>renamevar</span></span></span><span class='lexic'>(</span><span id='Z518134'><span><span class='ident'>venv</span></span></span><span class='lexic'>,</span>&nbsp;<span id='Z518120'><span><span class='ident'>id</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>=</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>do</span>&nbsp;<span id='Z518130'><span><span class='ident'>iloop</span></span></span><span class='lexic'>(</span><span id='Z518133'><span><span class='ident'>e</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z518134",this)' onmouseleave='srcref_leave("Z518134",this)'><span><span class='ident'>venv</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>match</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z518133",this)' onmouseleave='srcref_leave("Z518133",this)'><span><span class='ident'>e</span></span></span>&nbsp;<span class='keyword'>with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'><span class='pattern'>[(</span></span><span class='ident'><span class='pattern'>iid</span></span><span class='pattern'>&nbsp;</span><span class='keyword'><span class='pattern'>when</span></span><span class='pattern'>&nbsp;</span><span class='ident'><span class='pattern'>iid</span></span><span class='pattern'>&nbsp;</span><span class='lexic'><span class='pattern'>===</span></span><span class='pattern'>&nbsp;</span><span class='idfrom' onmouseenter='srcref_over("Z518120",this)' onmouseleave='srcref_leave("Z518120",this)'><span><span class='ident'><span class='pattern'>id</span></span></span></span><span class='lexic'><span class='pattern'>);</span></span><span class='pattern'>&nbsp;</span><span id='Z518125'><span><span class='ident'><span class='pattern'>nnm</span></span></span></span><span class='lexic'><span class='pattern'>]:</span></span><span class='ident'><span class='pattern'>tl</span></span>&nbsp;&#8594;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z518125",this)' onmouseleave='srcref_leave("Z518125",this)'><span><span class='ident'>nnm</span></span></span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'><span class='pattern'>hd</span></span><span class='lexic'><span class='pattern'>:</span></span><span id='Z518131'><span><span class='ident'><span class='pattern'>tl</span></span></span></span>&nbsp;&#8594;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z518130",this)' onmouseleave='srcref_leave("Z518130",this)'><span><span class='ident'>iloop</span></span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z518131",this)' onmouseleave='srcref_leave("Z518131",this)'><span><span class='ident'>tl</span></span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'><span class='pattern'>else</span></span>&nbsp;&#8594;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z518120",this)' onmouseleave='srcref_leave("Z518120",this)'><span><span class='ident'>id</span></span></span><span class='lexic'>};</span><br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='comment'>//&nbsp;A&nbsp;helper&nbsp;function&nbsp;to&nbsp;access&nbsp;an&nbsp;identifier&nbsp;bound<br>
</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='comment'>//&nbsp;in&nbsp;a&nbsp;let&nbsp;pair<br>
</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z519005'><span><span class='ident'>getpident</span></span></span><span class='lexic'>(</span><span id='Z518143'><span><span class='ident'>p</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>letpair</span><span class='lexic'>:</span><span class='idfrom' onmouseenter='srcref_over("Z518143",this)' onmouseleave='srcref_leave("Z518143",this)'><span><span class='ident'>p</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>once</span>&nbsp;<span class='ident'>letpair</span>&nbsp;<span class='lexic'>{</span>&nbsp;<span id='Z518400'><span><span class='ident'>p</span></span></span>&nbsp;&#8594;&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z518400",this)' onmouseleave='srcref_leave("Z518400",this)'><span><span class='ident'>id</span></span></span><span class='hint'>p(id,v)</span></span>&nbsp;<span class='lexic'>}};</span><br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='comment'>//&nbsp;A&nbsp;helper&nbsp;function:&nbsp;loop&nbsp;into&nbsp;a&nbsp;right&nbsp;hand&nbsp;side<br>
</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='comment'>//&nbsp;of&nbsp;a&nbsp;let&nbsp;pair&nbsp;and&nbsp;rename&nbsp;a&nbsp;bound&nbsp;identifier<br>
</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z519019'><span><span class='ident'>loopps</span></span></span><span class='lexic'>(</span><span id='Z518679'><span><span class='ident'>ne</span></span></span><span class='lexic'>,</span>&nbsp;<span id='Z518417'><span><span class='ident'>p</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>letpair</span><span class='lexic'>:</span><span class='idfrom' onmouseenter='srcref_over("Z518417",this)' onmouseleave='srcref_leave("Z518417",this)'><span><span class='ident'>p</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>letpair</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z518680'><span><span class='ident'>p</span></span></span>&nbsp;&#8594;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='keyword'>node</span><span class='hint'>lang0:letpair:p(id,v)</span></span><span class='lexic'>(</span><span class='ident'>id</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z518678",this)' onmouseleave='srcref_leave("Z518678",this)'><span><span class='ident'>renamevar</span></span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z518679",this)' onmouseleave='srcref_leave("Z518679",this)'><span><span class='ident'>ne</span></span></span><span class='lexic'>,</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z518680",this)' onmouseleave='srcref_leave("Z518680",this)'><span><span class='ident'>id</span></span></span><span class='hint'>p(id,v)</span></span><span class='lexic'>),</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='ident'>v</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z518683",this)' onmouseleave='srcref_leave("Z518683",this)'><span><span class='ident'>loop</span></span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z518680",this)' onmouseleave='srcref_leave("Z518680",this)'><span><span class='ident'>v</span></span></span><span class='hint'>p(id,v)</span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z518686",this)' onmouseleave='srcref_leave("Z518686",this)'><span><span class='ident'>env</span></span></span><span class='lexic'>))}};</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='comment'>//&nbsp;Main&nbsp;visitor:&nbsp;for&nbsp;lambda&nbsp;and&nbsp;let&nbsp;nodes&nbsp;it<br>
</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='comment'>//&nbsp;stops&nbsp;and&nbsp;recurses&nbsp;into&nbsp;their&nbsp;sub-nodes&nbsp;explicitly,<br>
</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='comment'>//&nbsp;while&nbsp;all&nbsp;the&nbsp;other&nbsp;variants&nbsp;are&nbsp;traversed&nbsp;in&nbsp;the&nbsp;depth-first<br>
</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='comment'>//&nbsp;order.<br>
</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>expr</span><span class='lexic'>:</span><span class='idfrom' onmouseenter='srcref_over("Z518702",this)' onmouseleave='srcref_leave("Z518702",this)'><span><span class='ident'>e</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>once</span>&nbsp;<span class='ident'>expr</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z518903'><span><span class='ident'>lambda</span></span></span>&nbsp;&#8594;&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z518911'><span><span class='ident'>newenv</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='keyword'>map</span>&nbsp;<span id='Z518908'><span><span class='ident'>a</span></span></span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z518903",this)' onmouseleave='srcref_leave("Z518903",this)'><span><span class='ident'>args</span></span></span><span class='hint'>lambda(args,body)</span></span>&nbsp;<span class='keyword'>do</span>&nbsp;<span class='lexic'>[</span><span class='idfrom' onmouseenter='srcref_over("Z518908",this)' onmouseleave='srcref_leave("Z518908",this)'><span><span class='ident'>a</span></span></span><span class='lexic'>;</span>&nbsp;<span class='withhint'><span class='ident'>gensym</span><span class='hint'>function&nbsp;gensym&nbsp;:&nbsp;<br>
Returns&nbsp;a&nbsp;unique&nbsp;symbol&nbsp;every&nbsp;time&nbsp;it&nbsp;is&nbsp;called.<br>
Uniqueness&nbsp;is&nbsp;guaranteed&nbsp;within&nbsp;one&nbsp;run&nbsp;only.</span></span><span class='lexic'>()];</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z518910",this)' onmouseleave='srcref_leave("Z518910",this)'><span><span class='ident'>addrenames</span></span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z518911",this)' onmouseleave='srcref_leave("Z518911",this)'><span><span class='ident'>newenv</span></span></span><span class='lexic'>);</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>elambda</span><span class='hint'>lang0:expr:elambda(args,benv,fenv,body)</span></span><span class='lexic'>(</span><span class='ident'>args</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='keyword'>map</span>&nbsp;<span class='lexic'>[</span><span class='ident'><span class='pattern'>a</span></span><span class='lexic'>;</span><span id='Z518932'><span><span class='ident'><span class='pattern'>b</span></span></span></span><span class='lexic'>]</span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z518911",this)' onmouseleave='srcref_leave("Z518911",this)'><span><span class='ident'>newenv</span></span></span>&nbsp;<span class='keyword'>do</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z518932",this)' onmouseleave='srcref_leave("Z518932",this)'><span><span class='ident'>b</span></span></span><span class='lexic'>,</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='ident'>benv</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z518686",this)' onmouseleave='srcref_leave("Z518686",this)'><span><span class='ident'>env</span></span></span><span class='lexic'>,</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='ident'>fenv</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='lexic'>&#8709;</span><span class='lexic'>,</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='ident'>body</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z518683",this)' onmouseleave='srcref_leave("Z518683",this)'><span><span class='ident'>loop</span></span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z518903",this)' onmouseleave='srcref_leave("Z518903",this)'><span><span class='ident'>body</span></span></span><span class='hint'>lambda(args,body)</span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z518911",this)' onmouseleave='srcref_leave("Z518911",this)'><span><span class='ident'>newenv</span></span></span>&nbsp;<span class='lexic'>&#8853;</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z518686",this)' onmouseleave='srcref_leave("Z518686",this)'><span><span class='ident'>env</span></span></span><span class='lexic'>))}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span id='Z519000'><span><span class='ident'>let</span></span></span>&nbsp;&#8594;&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z519007'><span><span class='ident'>newenv</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='keyword'>map</span>&nbsp;<span id='Z519006'><span><span class='ident'>p</span></span></span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z519000",this)' onmouseleave='srcref_leave("Z519000",this)'><span><span class='ident'>ps</span></span></span><span class='hint'>let(ps,body)</span></span>&nbsp;<span class='keyword'>do</span>&nbsp;<span class='lexic'>[</span><span class='idfrom' onmouseenter='srcref_over("Z519005",this)' onmouseleave='srcref_leave("Z519005",this)'><span><span class='ident'>getpident</span></span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z519006",this)' onmouseleave='srcref_leave("Z519006",this)'><span><span class='ident'>p</span></span></span><span class='lexic'>);</span>&nbsp;<span class='withhint'><span class='ident'>gensym</span><span class='hint'>function&nbsp;gensym&nbsp;:&nbsp;<br>
Returns&nbsp;a&nbsp;unique&nbsp;symbol&nbsp;every&nbsp;time&nbsp;it&nbsp;is&nbsp;called.<br>
Uniqueness&nbsp;is&nbsp;guaranteed&nbsp;within&nbsp;one&nbsp;run&nbsp;only.</span></span><span class='lexic'>()];</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z518910",this)' onmouseleave='srcref_leave("Z518910",this)'><span><span class='ident'>addrenames</span></span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z519007",this)' onmouseleave='srcref_leave("Z519007",this)'><span><span class='ident'>newenv</span></span></span><span class='lexic'>);</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='keyword'>node</span><span class='hint'>lang0:expr:let(ps,body)</span></span><span class='lexic'>(</span><span class='ident'>ps</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='keyword'>map</span>&nbsp;<span id='Z519020'><span><span class='ident'>p</span></span></span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z519000",this)' onmouseleave='srcref_leave("Z519000",this)'><span><span class='ident'>ps</span></span></span><span class='hint'>let(ps,body)</span></span>&nbsp;<span class='keyword'>do</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z519019",this)' onmouseleave='srcref_leave("Z519019",this)'><span><span class='ident'>loopps</span></span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z519007",this)' onmouseleave='srcref_leave("Z519007",this)'><span><span class='ident'>newenv</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z519020",this)' onmouseleave='srcref_leave("Z519020",this)'><span><span class='ident'>p</span></span></span><span class='lexic'>),</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='ident'>body</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z518683",this)' onmouseleave='srcref_leave("Z518683",this)'><span><span class='ident'>loop</span></span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z519000",this)' onmouseleave='srcref_leave("Z519000",this)'><span><span class='ident'>body</span></span></span><span class='hint'>let(ps,body)</span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z519007",this)' onmouseleave='srcref_leave("Z519007",this)'><span><span class='ident'>newenv</span></span></span><span class='lexic'>&#8853;</span><span class='idfrom' onmouseenter='srcref_over("Z518686",this)' onmouseleave='srcref_leave("Z518686",this)'><span><span class='ident'>env</span></span></span><span class='lexic'>))}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='keyword'>deep</span>&nbsp;&#8594;&nbsp;<span class='lexic'>{</span>&nbsp;<span id='Z518952'><span><span class='ident'>var</span></span></span>&nbsp;&#8594;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='keyword'>node</span><span class='hint'>lang0:expr:var(id)</span></span><span class='lexic'>(</span><span class='ident'>id</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z518678",this)' onmouseleave='srcref_leave("Z518678",this)'><span><span class='ident'>renamevar</span></span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z518686",this)' onmouseleave='srcref_leave("Z518686",this)'><span><span class='ident'>env</span></span></span><span class='lexic'>,</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z518952",this)' onmouseleave='srcref_leave("Z518952",this)'><span><span class='ident'>id</span></span></span><span class='hint'>var(id)</span></span><span class='lexic'>))</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='ident'>node</span><span class='lexic'>()</span>&nbsp;<span class='lexic'>}}}}</span>
<p></div>


<p>It would be nice to keep a track of all the renames we did, it could help
with producing debug information and with giving error messages more context.


<p><div class='code'>
<span id='Z519256'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_lexical_scope</span><span class='lexic'>(</span><span id='Z519619'><span><span class='ident'>ts</span></span></span><span class='lexic'>)</span><br>
&nbsp;<span class='keyword'>collector</span><span class='lexic'>(</span><span id='Z519870'><span><span class='ident'>add</span></span></span><span class='lexic'>,</span>&nbsp;<span id='Z519954'><span><span class='ident'>get</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;<span id='Z519962'><span><span class='ident'>ret</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='keyword'>map</span>&nbsp;<span id='Z519627'><span><span class='ident'>t</span></span></span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z519619",this)' onmouseleave='srcref_leave("Z519619",this)'><span><span class='ident'>ts</span></span></span>&nbsp;<span class='keyword'>do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>top</span><span class='lexic'>:</span><span class='idfrom' onmouseenter='srcref_over("Z519627",this)' onmouseleave='srcref_leave("Z519627",this)'><span><span class='ident'>t</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>once</span>&nbsp;<span class='ident'>expr</span>&nbsp;<span class='lexic'>{</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<a href='#Z517227'><span class='ident'>l0_lexical_scope_expr</span></a><span class='lexic'>(</span><span class='ident'>node</span><span class='lexic'>(),</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z519870",this)' onmouseleave='srcref_leave("Z519870",this)'><span><span class='ident'>add</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>}};</span><br>
&nbsp;&nbsp;&nbsp;<span class='keyword'>with</span>&nbsp;<span class='keyword'>target</span>&nbsp;<span class='lexic'>(</span><span class='ident'>lang0</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>top</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>debug</span><span class='hint'>lang0:top:debug(es)</span></span><span class='lexic'>(</span><span class='symbol'>'renames'</span><span class='lexic'>(@</span><span class='keyword'>map</span>&nbsp;<span class='keyword'>append</span>&nbsp;<span id='Z519957'><span><span class='ident'>g</span></span></span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z519954",this)' onmouseleave='srcref_leave("Z519954",this)'><span><span class='ident'>get</span></span></span><span class='lexic'>()</span>&nbsp;<span class='keyword'>do</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z519957",this)' onmouseleave='srcref_leave("Z519957",this)'><span><span class='ident'>g</span></span></span><span class='lexic'>))</span>&nbsp;<span class='lexic'>:</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z519962",this)' onmouseleave='srcref_leave("Z519962",this)'><span><span class='ident'>ret</span></span></span><br>
&nbsp;&nbsp;&nbsp;<span class='lexic'>}}</span>
<p></div>


<p>Now it's time to stop using the initial AST and move on. We eliminated few variants, and are going to introduce
more specific variable variants: global, local, argument or a closure variable. We're also introducing variants
for a consequent lambda lifting.

<p>The new AST is derived from the previous one (<b>lang0</b>), with few modifications
made to the <b>expr</b> node.


<p><div class='code'>
<span class='keyword'>ast</span>&nbsp;<span class='ident'>lang0i</span>&nbsp;<span class='lexic'>:</span>&nbsp;<span class='ident'>lang0</span>&nbsp;<span class='lexic'>()</span>&nbsp;<span class='keyword'>recform</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;<span class='ident'>expr</span>&nbsp;<span class='lexic'>+=</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='ident'>global</span><span class='lexic'>(</span><span class='ident'>ident</span><span class='lexic'>:</span><span class='ident'>id</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>local</span><span class='lexic'>(</span><span class='ident'>ident</span><span class='lexic'>:</span><span class='ident'>id</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>arg</span><span class='lexic'>(</span><span class='ident'>ident</span><span class='lexic'>:</span><span class='ident'>id</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>clvar</span><span class='lexic'>(</span><span class='ident'>ident</span><span class='lexic'>:</span><span class='ident'>id</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>mkclosure</span><span class='lexic'>(</span><span class='ident'>ident</span><span class='lexic'>:</span><span class='ident'>df</span><span class='lexic'>,</span>&nbsp;<span class='lexic'>*</span><span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>args</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>clambda</span><span class='lexic'>(*</span><span class='ident'>ident</span><span class='lexic'>:</span><span class='ident'>clenv</span><span class='lexic'>,</span>&nbsp;<span class='lexic'>*</span><span class='ident'>ident</span><span class='lexic'>:</span><span class='ident'>args</span><span class='lexic'>,</span>&nbsp;<span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>body</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='lexic'>-</span><span class='ident'>var</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='lexic'>-</span><span class='ident'>apply2</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='lexic'>-</span><span class='ident'>if2</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='lexic'>-</span><span class='ident'>mklist</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='lexic'>-</span><span class='ident'>lambda</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>;}</span>
<p></div>


<p>Now we can make our variables more specific, and since all the names are unique now we can do it easily in
a depth--first order. Of course we could do it in the previous pass, but it's better to keep passes as simple
as possible.


<p><div class='code'>
<span id='Z520039'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_classify_vars_top</span><span class='lexic'>(</span><span id='Z520745'><span><span class='ident'>t</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;<span id='Z521053'><span><span class='ident'>dict</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='ident'>mkhash</span><span class='lexic'>();</span><br>
&nbsp;&nbsp;<span class='comment'>//&nbsp;Fill&nbsp;a&nbsp;hash&nbsp;table&nbsp;with&nbsp;origins&nbsp;of&nbsp;all&nbsp;the&nbsp;definitions<br>
</span>&nbsp;&nbsp;<span id='Z521069'><span><span class='ident'>filldict</span></span></span><span class='lexic'>()</span>&nbsp;<span class='lexic'>=</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>top</span><span class='lexic'>:</span><span class='idfrom' onmouseenter='srcref_over("Z520745",this)' onmouseleave='srcref_leave("Z520745",this)'><span><span class='ident'>t</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>expr</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z521049'><span><span class='ident'>elambda</span></span></span>&nbsp;&#8594;&nbsp;<span class='keyword'>iter</span>&nbsp;<span id='Z521054'><span><span class='ident'>a</span></span></span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z521049",this)' onmouseleave='srcref_leave("Z521049",this)'><span><span class='ident'>args</span></span></span><span class='hint'>elambda(args,benv,fenv,body)</span></span>&nbsp;<span class='keyword'>do</span>&nbsp;<span class='ident'>ohashput</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z521053",this)' onmouseleave='srcref_leave("Z521053",this)'><span><span class='ident'>dict</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z521054",this)' onmouseleave='srcref_leave("Z521054",this)'><span><span class='ident'>a</span></span></span><span class='lexic'>,</span>&nbsp;<span class='symbol'>'arg'</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='lexic'>&#8709;</span><span class='lexic'>};</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>letpair</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z521061'><span><span class='ident'>p</span></span></span>&nbsp;&#8594;&nbsp;<span class='ident'>ohashput</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z521053",this)' onmouseleave='srcref_leave("Z521053",this)'><span><span class='ident'>dict</span></span></span><span class='lexic'>,</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z521061",this)' onmouseleave='srcref_leave("Z521061",this)'><span><span class='ident'>id</span></span></span><span class='hint'>p(id,v)</span></span><span class='lexic'>,</span>&nbsp;<span class='symbol'>'local'</span><span class='lexic'>)}};</span><br>
&nbsp;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z521069",this)' onmouseleave='srcref_leave("Z521069",this)'><span><span class='ident'>filldict</span></span></span><span class='lexic'>();</span><br>
<br>
&nbsp;&nbsp;<span class='comment'>//&nbsp;Replace&nbsp;all&nbsp;the&nbsp;var&nbsp;nodes&nbsp;with&nbsp;specific&nbsp;versions<br>
</span>&nbsp;&nbsp;<span class='comment'>//&nbsp;and&nbsp;use&nbsp;this&nbsp;opportunity&nbsp;to&nbsp;mark&nbsp;lambda&nbsp;bound&nbsp;variables&nbsp;lists&nbsp;with<br>
</span>&nbsp;&nbsp;<span class='comment'>//&nbsp;nearly&nbsp;correct&nbsp;origins.&nbsp;We're&nbsp;still&nbsp;missing&nbsp;closure&nbsp;variables,&nbsp;they&nbsp;will<br>
</span>&nbsp;&nbsp;<span class='comment'>//&nbsp;appear&nbsp;later.<br>
</span>&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0</span>&nbsp;<span class='lexic'>/rec,</span>&nbsp;<span class='lexic'>dst</span>&nbsp;<span class='ident'>lang0i</span><span class='lexic'>/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>top</span><span class='lexic'>:</span><span class='idfrom' onmouseenter='srcref_over("Z520745",this)' onmouseleave='srcref_leave("Z520745",this)'><span><span class='ident'>t</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>expr</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z521423'><span><span class='ident'>elambda</span></span></span>&nbsp;&#8594;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='keyword'>node</span><span class='hint'>lang0i:expr:elambda(args,benv,fenv,body)<br>
&nbsp;&nbsp;&nbsp;with&nbsp;implicit&nbsp;arguments:&nbsp;args,&nbsp;fenv,&nbsp;body<br>
</span></span><span class='lexic'>(</span><span class='ident'>benv</span>&nbsp;<span class='lexic'>=</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>map</span>&nbsp;<span class='lexic'>[</span><span class='ident'><span class='pattern'>o</span></span><span class='lexic'>;</span><span id='Z521437'><span><span class='ident'><span class='pattern'>n</span></span></span></span><span class='lexic'>]</span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z521423",this)' onmouseleave='srcref_leave("Z521423",this)'><span><span class='ident'>benv</span></span></span><span class='hint'>elambda(args,benv,fenv,body)</span></span>&nbsp;<span class='keyword'>do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>[</span><span class='idfrom' onmouseenter='srcref_over("Z521437",this)' onmouseleave='srcref_leave("Z521437",this)'><span><span class='ident'>n</span></span></span><span class='lexic'>;</span>&nbsp;<span class='ident'>ohashget</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z521053",this)' onmouseleave='srcref_leave("Z521053",this)'><span><span class='ident'>dict</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z521437",this)' onmouseleave='srcref_leave("Z521437",this)'><span><span class='ident'>n</span></span></span><span class='lexic'>)])</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span id='Z521333'><span><span class='ident'>var</span></span></span>&nbsp;&#8594;&nbsp;<span class='keyword'>aif</span>&nbsp;<span class='lexic'>(</span><span class='ident'>ct</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='ident'>ohashget</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z521053",this)' onmouseleave='srcref_leave("Z521053",this)'><span><span class='ident'>dict</span></span></span><span class='lexic'>,</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z521333",this)' onmouseleave='srcref_leave("Z521333",this)'><span><span class='ident'>id</span></span></span><span class='hint'>var(id)</span></span><span class='lexic'>))</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>if</span><span class='lexic'>(</span><span class='ident'>ct</span>&nbsp;<span class='lexic'>===</span>&nbsp;<span class='symbol'>'arg'</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>arg</span><span class='hint'>lang0i:expr:arg(id)</span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z521333",this)' onmouseleave='srcref_leave("Z521333",this)'><span><span class='ident'>id</span></span></span><span class='hint'>var(id)</span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>else</span>&nbsp;<span class='keyword'>if</span><span class='lexic'>(</span><span class='ident'>ct</span>&nbsp;<span class='lexic'>===</span>&nbsp;<span class='symbol'>'local'</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>local</span><span class='hint'>lang0i:expr:local(id)</span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z521333",this)' onmouseleave='srcref_leave("Z521333",this)'><span><span class='ident'>id</span></span></span><span class='hint'>var(id)</span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>else</span>&nbsp;<span class='withhint'><span class='ident'>ccerror</span><span class='hint'>function&nbsp;ccerror&nbsp;arg:&nbsp;<br>
Raises&nbsp;[MBaseException]&nbsp;with&nbsp;a&nbsp;given&nbsp;argument.</span></span><span class='lexic'>(</span><span class='symbol'>'WHAT?'</span><span class='lexic'>(</span><span class='ident'>ct</span><span class='lexic'>))</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>}</span>&nbsp;<span class='keyword'>else</span>&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>global</span><span class='hint'>lang0i:expr:global(id)</span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z521333",this)' onmouseleave='srcref_leave("Z521333",this)'><span><span class='ident'>id</span></span></span><span class='hint'>var(id)</span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='ident'>node</span><span class='lexic'>()}}}</span>
<p></div>



<p><div class='code'>
<span id='Z521601'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_classify_vars</span><span class='lexic'>(</span><span id='Z521611'><span><span class='ident'>ts</span></span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;<span class='keyword'>map</span>&nbsp;<span id='Z521614'><span><span class='ident'>t</span></span></span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z521611",this)' onmouseleave='srcref_leave("Z521611",this)'><span><span class='ident'>ts</span></span></span>&nbsp;<span class='keyword'>do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<a href='#Z520039'><span class='ident'>l0_classify_vars_top</span></a><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z521614",this)' onmouseleave='srcref_leave("Z521614",this)'><span><span class='ident'>t</span></span></span><span class='lexic'>)</span>
<p></div>



<h2 id="lifting">Lambda lifting</h2>

<p>Lambda lifting pass will turn all the nested lambda functions into toplevel definitions, capturing closure
environments where necessary. We did the lexical scoping pass previously, and now all the names inside any
given context are unique, which makes it easy to produce lists of externally defined variables used under each
lambda context.

<p>First we have to propagate the free variables lists (with bound variables already collected in the
lexical scoping pass), from top to bottom.


<p><div class='code'>
<span id='Z521622'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_lambda_lift_freevars</span><span class='lexic'>(</span><span id='Z522492'><span><span class='ident'>e</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;<span class='comment'>//&nbsp;A&nbsp;helper&nbsp;function:&nbsp;returns&nbsp;a&nbsp;list&nbsp;of&nbsp;all<br>
</span>&nbsp;&nbsp;<span class='comment'>//&nbsp;identifiers&nbsp;used&nbsp;in&nbsp;a&nbsp;given&nbsp;expression&nbsp;(bound&nbsp;or&nbsp;not)<br>
</span>&nbsp;&nbsp;<span id='Z522733'><span><span class='ident'>collectvars</span></span></span><span class='lexic'>(</span><span id='Z522203'><span><span class='ident'>e</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='keyword'>collector</span><span class='lexic'>(</span><span id='Z522446'><span><span class='ident'>addv</span></span></span><span class='lexic'>,</span>&nbsp;<span id='Z522486'><span><span class='ident'>getvs</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0i</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>expr</span><span class='lexic'>:</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z522203",this)' onmouseleave='srcref_leave("Z522203",this)'><span><span class='ident'>e</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>once</span>&nbsp;<span class='ident'>expr</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z522442'><span><span class='ident'>elambda</span></span></span>&nbsp;&#8594;&nbsp;<span class='lexic'>{</span><span class='keyword'>iter</span>&nbsp;<span id='Z522447'><span><span class='ident'>v</span></span></span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z522442",this)' onmouseleave='srcref_leave("Z522442",this)'><span><span class='ident'>fenv</span></span></span><span class='hint'>elambda(args,benv,fenv,body)</span></span>&nbsp;<span class='keyword'>do</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z522446",this)' onmouseleave='srcref_leave("Z522446",this)'><span><span class='ident'>addv</span></span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z522447",this)' onmouseleave='srcref_leave("Z522447",this)'><span><span class='ident'>v</span></span></span><span class='lexic'>)}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='keyword'>deep</span>&nbsp;&#8594;&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z522454'><span><span class='ident'>local</span></span></span>&nbsp;&#8594;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z522446",this)' onmouseleave='srcref_leave("Z522446",this)'><span><span class='ident'>addv</span></span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z522454",this)' onmouseleave='srcref_leave("Z522454",this)'><span><span class='ident'>id</span></span></span><span class='hint'>local(id)</span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span id='Z522460'><span><span class='ident'>arg</span></span></span>&nbsp;&#8594;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z522446",this)' onmouseleave='srcref_leave("Z522446",this)'><span><span class='ident'>addv</span></span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z522460",this)' onmouseleave='srcref_leave("Z522460",this)'><span><span class='ident'>id</span></span></span><span class='hint'>arg(id)</span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='lexic'>&#8709;</span><span class='lexic'>}}};</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>return</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z522486",this)' onmouseleave='srcref_leave("Z522486",this)'><span><span class='ident'>getvs</span></span></span><span class='lexic'>()};</span><br>
&nbsp;&nbsp;<span class='comment'>//&nbsp;Add&nbsp;free&nbsp;variable&nbsp;lists&nbsp;to&nbsp;all&nbsp;the&nbsp;lambda&nbsp;nodes,<br>
</span>&nbsp;&nbsp;<span class='comment'>//&nbsp;in&nbsp;a&nbsp;depth--first&nbsp;order.<br>
</span>&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0i</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>expr</span><span class='lexic'>:</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z522492",this)' onmouseleave='srcref_leave("Z522492",this)'><span><span class='ident'>e</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>expr</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z522734'><span><span class='ident'>elambda</span></span></span>&nbsp;&#8594;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='keyword'>node</span><span class='hint'>lang0i:expr:elambda(args,benv,fenv,body)<br>
&nbsp;&nbsp;&nbsp;with&nbsp;implicit&nbsp;arguments:&nbsp;args,&nbsp;benv,&nbsp;body<br>
</span></span><span class='lexic'>(</span><span class='ident'>fenv</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z522733",this)' onmouseleave='srcref_leave("Z522733",this)'><span><span class='ident'>collectvars</span></span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z522734",this)' onmouseleave='srcref_leave("Z522734",this)'><span><span class='ident'>body</span></span></span><span class='hint'>elambda(args,benv,fenv,body)</span></span><span class='lexic'>))</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='ident'>node</span><span class='lexic'>()}}}</span>
<p></div>


<p>Now we can use an intersection between a bound variables list and
a free variable list to form a closure environment.


<p><div class='code'>
<span id='Z522889'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_lambda_lift_expr</span><span class='lexic'>(</span><span id='Z523718'><span><span class='ident'>e</span></span></span><span class='lexic'>,</span>&nbsp;<span class='ident'>clenv</span><span class='lexic'>,</span>&nbsp;<span id='Z523624'><span><span class='ident'>adddef</span></span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;<span class='comment'>//&nbsp;An&nbsp;entry&nbsp;for&nbsp;nested&nbsp;lambdas,&nbsp;to&nbsp;keep&nbsp;a&nbsp;track&nbsp;of&nbsp;variables<br>
</span>&nbsp;&nbsp;<span class='comment'>//&nbsp;that&nbsp;were&nbsp;turned&nbsp;into&nbsp;closure&nbsp;variables&nbsp;in&nbsp;a&nbsp;lifted&nbsp;context.<br>
</span>&nbsp;&nbsp;<span class='keyword'>do</span>&nbsp;<span id='Z523615'><span><span class='ident'>loop</span></span></span><span class='lexic'>(</span><span id='Z523344'><span><span class='ident'>e</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z523718",this)' onmouseleave='srcref_leave("Z523718",this)'><span><span class='ident'>e</span></span></span><span class='lexic'>,</span>&nbsp;<span id='Z523318'><span><span class='ident'>renv</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='lexic'>&#8709;</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;<span class='comment'>//&nbsp;A&nbsp;helper&nbsp;function,&nbsp;generating&nbsp;a&nbsp;list&nbsp;of<br>
</span>&nbsp;&nbsp;&nbsp;<span class='comment'>//&nbsp;captured&nbsp;closure&nbsp;variables&nbsp;out&nbsp;of&nbsp;bound&nbsp;and&nbsp;free&nbsp;variables&nbsp;lists<br>
</span>&nbsp;&nbsp;&nbsp;<span id='Z523583'><span><span class='ident'>getclenv</span></span></span><span class='lexic'>(</span><span id='Z523305'><span><span class='ident'>benv</span></span></span><span class='lexic'>,</span>&nbsp;<span id='Z523292'><span><span class='ident'>fenv</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='keyword'>with</span>&nbsp;<span class='keyword'>target</span><span class='lexic'>(</span><span class='ident'>lang0i</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z523294'><span><span class='ident'>ht</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='ident'>mkhash</span><span class='lexic'>();</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>iter</span>&nbsp;<span id='Z523295'><span><span class='ident'>nm</span></span></span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z523292",this)' onmouseleave='srcref_leave("Z523292",this)'><span><span class='ident'>fenv</span></span></span>&nbsp;<span class='keyword'>do</span>&nbsp;<span class='ident'>ohashput</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z523294",this)' onmouseleave='srcref_leave("Z523294",this)'><span><span class='ident'>ht</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z523295",this)' onmouseleave='srcref_leave("Z523295",this)'><span><span class='ident'>nm</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z523295",this)' onmouseleave='srcref_leave("Z523295",this)'><span><span class='ident'>nm</span></span></span><span class='lexic'>);</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>map</span>&nbsp;<span class='keyword'>append</span>&nbsp;<span class='lexic'>[</span><span id='Z523317'><span><span class='ident'><span class='pattern'>nm</span></span></span></span><span class='lexic'>;</span><span id='Z523325'><span><span class='ident'><span class='pattern'>cl</span></span></span></span><span class='lexic'>]</span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z523305",this)' onmouseleave='srcref_leave("Z523305",this)'><span><span class='ident'>benv</span></span></span>&nbsp;<span class='keyword'>do</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>if</span><span class='lexic'>(</span><span class='ident'>ohashget</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z523294",this)' onmouseleave='srcref_leave("Z523294",this)'><span><span class='ident'>ht</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z523317",this)' onmouseleave='srcref_leave("Z523317",this)'><span><span class='ident'>nm</span></span></span><span class='lexic'>))</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>if</span>&nbsp;<span class='lexic'>(</span><span class='ident'>memq</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z523317",this)' onmouseleave='srcref_leave("Z523317",this)'><span><span class='ident'>nm</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z523318",this)' onmouseleave='srcref_leave("Z523318",this)'><span><span class='ident'>renv</span></span></span><span class='lexic'>))</span>&nbsp;<span class='lexic'>[[</span><span class='idfrom' onmouseenter='srcref_over("Z523317",this)' onmouseleave='srcref_leave("Z523317",this)'><span><span class='ident'>nm</span></span></span><span class='lexic'>;</span>&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>expr</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>clvar</span><span class='hint'>lang0i:expr:clvar(id)</span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z523317",this)' onmouseleave='srcref_leave("Z523317",this)'><span><span class='ident'>nm</span></span></span><span class='lexic'>)]]</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>else</span>&nbsp;<span class='keyword'>if</span>&nbsp;<span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z523325",this)' onmouseleave='srcref_leave("Z523325",this)'><span><span class='ident'>cl</span></span></span>&nbsp;<span class='lexic'>===</span>&nbsp;<span class='symbol'>'local'</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>[[</span><span class='idfrom' onmouseenter='srcref_over("Z523317",this)' onmouseleave='srcref_leave("Z523317",this)'><span><span class='ident'>nm</span></span></span><span class='lexic'>;</span>&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>expr</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>local</span><span class='hint'>lang0i:expr:local(id)</span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z523317",this)' onmouseleave='srcref_leave("Z523317",this)'><span><span class='ident'>nm</span></span></span><span class='lexic'>)]]</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>else</span>&nbsp;<span class='keyword'>if</span>&nbsp;<span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z523325",this)' onmouseleave='srcref_leave("Z523325",this)'><span><span class='ident'>cl</span></span></span>&nbsp;<span class='lexic'>===</span>&nbsp;<span class='symbol'>'arg'</span><span class='lexic'>)</span>&nbsp;&nbsp;&nbsp;<span class='lexic'>[[</span><span class='idfrom' onmouseenter='srcref_over("Z523317",this)' onmouseleave='srcref_leave("Z523317",this)'><span><span class='ident'>nm</span></span></span><span class='lexic'>;</span>&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>expr</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>arg</span><span class='hint'>lang0i:expr:arg(id)</span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z523317",this)' onmouseleave='srcref_leave("Z523317",this)'><span><span class='ident'>nm</span></span></span><span class='lexic'>)]]</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>else</span>&nbsp;<span class='withhint'><span class='ident'>ccerror</span><span class='hint'>function&nbsp;ccerror&nbsp;arg:&nbsp;<br>
Raises&nbsp;[MBaseException]&nbsp;with&nbsp;a&nbsp;given&nbsp;argument.</span></span><span class='lexic'>(</span><span class='symbol'>'WHAT?'</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z523325",this)' onmouseleave='srcref_leave("Z523325",this)'><span><span class='ident'>cl</span></span></span><span class='lexic'>))</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>}</span>&nbsp;<span class='keyword'>else</span>&nbsp;<span class='lexic'>&#8709;</span><span class='lexic'>}};</span><br>
&nbsp;&nbsp;&nbsp;<span class='comment'>//&nbsp;A&nbsp;main&nbsp;visitor,&nbsp;lifting&nbsp;all&nbsp;the&nbsp;lambda&nbsp;nodes&nbsp;into&nbsp;new<br>
</span>&nbsp;&nbsp;&nbsp;<span class='comment'>//&nbsp;toplevel&nbsp;definitions&nbsp;and&nbsp;replacing&nbsp;them&nbsp;with&nbsp;closure&nbsp;allocations,<br>
</span>&nbsp;&nbsp;&nbsp;<span class='comment'>//&nbsp;even&nbsp;if&nbsp;no&nbsp;closure&nbsp;environment&nbsp;is&nbsp;captured&nbsp;(we'll&nbsp;deal&nbsp;with&nbsp;this<br>
</span>&nbsp;&nbsp;&nbsp;<span class='comment'>//&nbsp;case&nbsp;later).&nbsp;Also&nbsp;using&nbsp;this&nbsp;opportunity&nbsp;to&nbsp;make&nbsp;closure&nbsp;variable<br>
</span>&nbsp;&nbsp;&nbsp;<span class='comment'>//&nbsp;references&nbsp;specific.<br>
</span>&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0i</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>expr</span><span class='lexic'>:</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z523344",this)' onmouseleave='srcref_leave("Z523344",this)'><span><span class='ident'>e</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>once</span>&nbsp;<span class='ident'>expr</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z523584'><span><span class='ident'>elambda</span></span></span>&nbsp;&#8594;&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z523593'><span><span class='ident'>intersect</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z523583",this)' onmouseleave='srcref_leave("Z523583",this)'><span><span class='ident'>getclenv</span></span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z523584",this)' onmouseleave='srcref_leave("Z523584",this)'><span><span class='ident'>benv</span></span></span><span class='hint'>elambda(args,benv,fenv,body)</span></span><span class='lexic'>,</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z523584",this)' onmouseleave='srcref_leave("Z523584",this)'><span><span class='ident'>fenv</span></span></span><span class='hint'>elambda(args,benv,fenv,body)</span></span><span class='lexic'>);</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z523612'><span><span class='ident'>clargs</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='keyword'>map</span>&nbsp;<span class='lexic'>[</span><span id='Z523605'><span><span class='ident'><span class='pattern'>nm</span></span></span></span><span class='lexic'>;</span><span class='ident'><span class='pattern'>cl</span></span><span class='lexic'>]</span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z523593",this)' onmouseleave='srcref_leave("Z523593",this)'><span><span class='ident'>intersect</span></span></span>&nbsp;<span class='keyword'>do</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z523605",this)' onmouseleave='srcref_leave("Z523605",this)'><span><span class='ident'>nm</span></span></span><span class='lexic'>;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z523630'><span><span class='ident'>newlambda</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>clambda</span><span class='hint'>lang0i:expr:clambda(clenv,args,body)</span></span><span class='lexic'>(</span><span class='ident'>clenv</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z523612",this)' onmouseleave='srcref_leave("Z523612",this)'><span><span class='ident'>clargs</span></span></span><span class='lexic'>,</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='ident'>args</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z523584",this)' onmouseleave='srcref_leave("Z523584",this)'><span><span class='ident'>args</span></span></span><span class='hint'>elambda(args,benv,fenv,body)</span></span><span class='lexic'>,</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='ident'>body</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z523615",this)' onmouseleave='srcref_leave("Z523615",this)'><span><span class='ident'>loop</span></span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z523584",this)' onmouseleave='srcref_leave("Z523584",this)'><span><span class='ident'>body</span></span></span><span class='hint'>elambda(args,benv,fenv,body)</span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z523612",this)' onmouseleave='srcref_leave("Z523612",this)'><span><span class='ident'>clargs</span></span></span>&nbsp;<span class='lexic'>&#8853;</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z523318",this)' onmouseleave='srcref_leave("Z523318",this)'><span><span class='ident'>renv</span></span></span><span class='lexic'>));</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z523629'><span><span class='ident'>newnm</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='withhint'><span class='ident'>gensym</span><span class='hint'>function&nbsp;gensym&nbsp;:&nbsp;<br>
Returns&nbsp;a&nbsp;unique&nbsp;symbol&nbsp;every&nbsp;time&nbsp;it&nbsp;is&nbsp;called.<br>
Uniqueness&nbsp;is&nbsp;guaranteed&nbsp;within&nbsp;one&nbsp;run&nbsp;only.</span></span><span class='lexic'>();</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z523624",this)' onmouseleave='srcref_leave("Z523624",this)'><span><span class='ident'>adddef</span></span></span><span class='lexic'>(</span><span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>top</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>define</span><span class='hint'>lang0i:top:define(id,e)</span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z523629",this)' onmouseleave='srcref_leave("Z523629",this)'><span><span class='ident'>newnm</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z523630",this)' onmouseleave='srcref_leave("Z523630",this)'><span><span class='ident'>newlambda</span></span></span><span class='lexic'>));</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>return</span>&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>mkclosure</span><span class='hint'>lang0i:expr:mkclosure(df,args)</span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z523629",this)' onmouseleave='srcref_leave("Z523629",this)'><span><span class='ident'>newnm</span></span></span><span class='lexic'>,</span>&nbsp;<span class='keyword'>map</span>&nbsp;<span class='lexic'>[</span><span class='ident'><span class='pattern'>nm</span></span><span class='lexic'>;</span><span id='Z523654'><span><span class='ident'><span class='pattern'>cl</span></span></span></span><span class='lexic'>]</span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z523593",this)' onmouseleave='srcref_leave("Z523593",this)'><span><span class='ident'>intersect</span></span></span>&nbsp;<span class='keyword'>do</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z523654",this)' onmouseleave='srcref_leave("Z523654",this)'><span><span class='ident'>cl</span></span></span><span class='lexic'>)}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span id='Z523666'><span><span class='ident'>local</span></span></span>&nbsp;&#8594;&nbsp;<span class='keyword'>if</span><span class='lexic'>(</span><span class='ident'>memq</span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z523666",this)' onmouseleave='srcref_leave("Z523666",this)'><span><span class='ident'>id</span></span></span><span class='hint'>local(id)</span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z523318",this)' onmouseleave='srcref_leave("Z523318",this)'><span><span class='ident'>renv</span></span></span><span class='lexic'>))</span>&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>clvar</span><span class='hint'>lang0i:expr:clvar(id)</span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z523666",this)' onmouseleave='srcref_leave("Z523666",this)'><span><span class='ident'>id</span></span></span><span class='hint'>local(id)</span></span><span class='lexic'>)</span>&nbsp;<span class='keyword'>else</span>&nbsp;<span class='ident'>node</span><span class='lexic'>()</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span id='Z523682'><span><span class='ident'>arg</span></span></span>&nbsp;&nbsp;&nbsp;&#8594;&nbsp;<span class='keyword'>if</span><span class='lexic'>(</span><span class='ident'>memq</span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z523682",this)' onmouseleave='srcref_leave("Z523682",this)'><span><span class='ident'>id</span></span></span><span class='hint'>arg(id)</span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z523318",this)' onmouseleave='srcref_leave("Z523318",this)'><span><span class='ident'>renv</span></span></span><span class='lexic'>))</span>&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>clvar</span><span class='hint'>lang0i:expr:clvar(id)</span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z523682",this)' onmouseleave='srcref_leave("Z523682",this)'><span><span class='ident'>id</span></span></span><span class='hint'>arg(id)</span></span><span class='lexic'>)</span>&nbsp;<span class='keyword'>else</span>&nbsp;<span class='ident'>node</span><span class='lexic'>()</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='keyword'>deep</span>&nbsp;&#8594;&nbsp;<span class='lexic'>{</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='ident'>node</span><span class='lexic'>()</span>&nbsp;<span class='lexic'>}}}}</span>
<p></div>


<p>Obviously we do not need to lift lambda expressions that are already on top,
so we have to make an exception for this case.


<p><div class='code'>
<span id='Z523833'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_lambda_lift_top</span><span class='lexic'>(</span><span id='Z524186'><span><span class='ident'>t</span></span></span><span class='lexic'>,</span>&nbsp;<span id='Z524180'><span><span class='ident'>adddef</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;<span id='Z524437'><span><span class='ident'>liftexpr</span></span></span><span class='lexic'>(</span><span id='Z524179'><span><span class='ident'>e</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>=</span>&nbsp;<a href='#Z522889'><span class='ident'>l0_lambda_lift_expr</span></a><span class='lexic'>(</span><a href='#Z521622'><span class='ident'>l0_lambda_lift_freevars</span></a><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z524179",this)' onmouseleave='srcref_leave("Z524179",this)'><span><span class='ident'>e</span></span></span><span class='lexic'>),</span>&nbsp;<span class='lexic'>&#8709;</span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z524180",this)' onmouseleave='srcref_leave("Z524180",this)'><span><span class='ident'>adddef</span></span></span><span class='lexic'>);</span><br>
&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0i</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>top</span><span class='lexic'>:</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z524186",this)' onmouseleave='srcref_leave("Z524186",this)'><span><span class='ident'>t</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>once</span>&nbsp;<span class='ident'>expr</span>&nbsp;<span class='lexic'>{</span>&nbsp;<span id='Z524482'><span><span class='ident'>elambda</span></span></span>&nbsp;&#8594;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>clambda</span><span class='hint'>lang0i:expr:clambda(clenv,args,body)</span></span><span class='lexic'>(</span><span class='ident'>clenv</span><span class='lexic'>=</span><span class='lexic'>&#8709;</span><span class='lexic'>,</span>&nbsp;<span class='ident'>args</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z524482",this)' onmouseleave='srcref_leave("Z524482",this)'><span><span class='ident'>args</span></span></span><span class='hint'>elambda(args,benv,fenv,body)</span></span><span class='lexic'>,</span>&nbsp;<span class='ident'>body</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z524437",this)' onmouseleave='srcref_leave("Z524437",this)'><span><span class='ident'>liftexpr</span></span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z524482",this)' onmouseleave='srcref_leave("Z524482",this)'><span><span class='ident'>body</span></span></span><span class='hint'>elambda(args,benv,fenv,body)</span></span><span class='lexic'>))</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z524437",this)' onmouseleave='srcref_leave("Z524437",this)'><span><span class='ident'>liftexpr</span></span></span><span class='lexic'>(</span><span class='ident'>node</span><span class='lexic'>())</span>&nbsp;<span class='lexic'>}}}</span>
<p></div>


<p>Lambda--lifting a single top level statement may produce any number of new top level statements, so
we'll just collect all the new statements together into one flat list.


<p><div class='code'>
<span id='Z524592'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_lambda_lift</span><span class='lexic'>(</span><span id='Z524609'><span><span class='ident'>ts</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;<span class='keyword'>collector</span><span class='lexic'>(</span><span id='Z524611'><span><span class='ident'>adddef</span></span></span><span class='lexic'>,</span>&nbsp;<span id='Z524613'><span><span class='ident'>getdefs</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>iter</span>&nbsp;<span id='Z524612'><span><span class='ident'>t</span></span></span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z524609",this)' onmouseleave='srcref_leave("Z524609",this)'><span><span class='ident'>ts</span></span></span>&nbsp;<span class='keyword'>do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z524611",this)' onmouseleave='srcref_leave("Z524611",this)'><span><span class='ident'>adddef</span></span></span><span class='lexic'>(</span><a href='#Z523833'><span class='ident'>l0_lambda_lift_top</span></a><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z524612",this)' onmouseleave='srcref_leave("Z524612",this)'><span><span class='ident'>t</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z524611",this)' onmouseleave='srcref_leave("Z524611",this)'><span><span class='ident'>adddef</span></span></span><span class='lexic'>));</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>return</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z524613",this)' onmouseleave='srcref_leave("Z524613",this)'><span><span class='ident'>getdefs</span></span></span><span class='lexic'>()}}</span>
<p></div>


<p>And now, all the lexical scope and lambda lifting passes together:


<p><div class='code'>
<span id='Z524621'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_lexical</span><span class='lexic'>(</span><span id='Z524623'><span><span class='ident'>ts</span></span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;<a href='#Z524592'><span class='ident'>l0_lambda_lift</span></a><span class='lexic'>(</span><br>
&nbsp;&nbsp;&nbsp;<a href='#Z521601'><span class='ident'>l0_classify_vars</span></a><span class='lexic'>(</span><br>
&nbsp;&nbsp;&nbsp;<a href='#Z519256'><span class='ident'>l0_lexical_scope</span></a><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z524623",this)' onmouseleave='srcref_leave("Z524623",this)'><span><span class='ident'>ts</span></span></span><span class='lexic'>)))</span>
<p></div>



<h2>Preparing for a code generation</h2>

<p>By now we moved all the lambdas into top level definitions, made closure
environments explicit, eliminated lexical scope and reduced some syntax sugar.

<p>Let's refine our AST further. We can classify top level statements as
functions (i.e., lambdas with an empty closure environment), closures,
constants, evaluated definitions and, finally, toplevel expressions.

<p>We also eliminated the temporary <b>elambda</b> variant previously, and are
going to get rid of nested <b>let</b> bindings and replace them with flat
imperative assignments. Same AST is introducing a special tail call variant.

<p>Another variant introduced here is <b>splitexpr</b>, it is required for
separating expressions and statements further down the pipeline.


<p><div class='code'>
<span class='keyword'>ast</span>&nbsp;<span class='ident'>lang0j</span>&nbsp;<span class='lexic'>:</span>&nbsp;<span class='ident'>lang0i</span>&nbsp;<span class='lexic'>()</span>&nbsp;<span class='keyword'>recform</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;<span class='ident'>top</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='ident'>define</span><span class='lexic'>(</span><span class='ident'>ident</span><span class='lexic'>:</span><span class='ident'>id</span><span class='lexic'>,</span>&nbsp;<span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>e</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>defconst</span><span class='lexic'>(</span><span class='ident'>ident</span><span class='lexic'>:</span><span class='ident'>id</span><span class='lexic'>,</span>&nbsp;<span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>e</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>sfunction</span><span class='lexic'>(</span><span class='ident'>ident</span><span class='lexic'>:</span><span class='ident'>id</span><span class='lexic'>,</span>&nbsp;<span class='lexic'>*</span><span class='ident'>ident</span><span class='lexic'>:</span><span class='ident'>args</span><span class='lexic'>,</span>&nbsp;<span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>body</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>closure</span><span class='lexic'>(</span><span class='ident'>ident</span><span class='lexic'>:</span><span class='ident'>id</span><span class='lexic'>,</span>&nbsp;<span class='lexic'>*</span><span class='ident'>ident</span><span class='lexic'>:</span><span class='ident'>clargs</span><span class='lexic'>,</span>&nbsp;<span class='lexic'>*</span><span class='ident'>ident</span><span class='lexic'>:</span><span class='ident'>args</span><span class='lexic'>,</span>&nbsp;<span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>body</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>expr</span><span class='lexic'>(</span><span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>e</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>debug</span><span class='lexic'>(.*</span><span class='ident'>any</span><span class='lexic'>:</span><span class='ident'>es</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>;</span><br>
&nbsp;&nbsp;<span class='ident'>expr</span>&nbsp;<span class='lexic'>+=</span>&nbsp;<span class='lexic'>-</span><span class='ident'>elambda</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;&nbsp;<span class='lexic'>-</span><span class='ident'>clambda</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;&nbsp;<span class='ident'>alloca</span><span class='lexic'>(</span><span class='ident'>ident</span><span class='lexic'>:</span><span class='ident'>id</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;&nbsp;<span class='ident'>set</span><span class='lexic'>(</span><span class='ident'>ident</span><span class='lexic'>:</span><span class='ident'>id</span><span class='lexic'>,</span>&nbsp;<span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>v</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;&nbsp;<span class='ident'>drop</span><span class='lexic'>(</span><span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>v</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;&nbsp;<span class='ident'>funref</span><span class='lexic'>(</span><span class='ident'>ident</span><span class='lexic'>:</span><span class='ident'>id</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;&nbsp;<span class='ident'>tailapply</span><span class='lexic'>(</span><span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>fn</span><span class='lexic'>,</span>&nbsp;<span class='lexic'>.*</span><span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>args</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;&nbsp;<span class='ident'>return</span><span class='lexic'>(</span><span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>v</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;&nbsp;<span class='ident'>splitexpr</span><span class='lexic'>(</span><span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>l</span><span class='lexic'>,</span>&nbsp;<span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>r</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>;}</span>
<p></div>


<h3>Removing toplevel lambdas</h3>


<p><div class='code'>
<span id='Z524627'><span class='lexic'>%</span></span><span class='const'>&quot;lang0i:*top&nbsp;-&gt;&nbsp;lang0j:*top&quot;</span><br>
<span class='keyword'>function</span>&nbsp;<span class='ident'>l0_classify_functions</span><span class='lexic'>(</span><span id='Z525040'><span><span class='ident'>ts</span></span></span><span class='lexic'>)</span><br>
&nbsp;<span class='keyword'>map</span>&nbsp;<span id='Z525048'><span><span class='ident'>t</span></span></span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z525040",this)' onmouseleave='srcref_leave("Z525040",this)'><span><span class='ident'>ts</span></span></span>&nbsp;<span class='keyword'>do</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0i</span>&nbsp;<span class='lexic'>/rec,</span>&nbsp;<span class='lexic'>dst</span>&nbsp;<span class='ident'>lang0j</span><span class='lexic'>/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>top</span><span class='lexic'>:</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z525048",this)' onmouseleave='srcref_leave("Z525048",this)'><span><span class='ident'>t</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>top</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z525293'><span><span class='ident'>define</span></span></span>&nbsp;&#8594;&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z525293",this)' onmouseleave='srcref_leave("Z525293",this)'><span><span class='ident'>e</span></span></span><span class='hint'>define(id,e)</span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z525293",this)' onmouseleave='srcref_leave("Z525293",this)'><span><span class='ident'>id</span></span></span><span class='hint'>define(id,e)</span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span id='Z525301'><span><span class='ident'>expr</span></span></span>&nbsp;&#8594;&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z525301",this)' onmouseleave='srcref_leave("Z525301",this)'><span><span class='ident'>e</span></span></span><span class='hint'>expr(e)</span></span><span class='lexic'>(</span><span class='lexic'>&#8709;</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>debug</span>&nbsp;&#8594;&nbsp;<span class='ident'>node</span><span class='lexic'>()</span><span class='lexic'>};</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>once</span>&nbsp;<span class='ident'>expr</span><span class='lexic'>(</span><span id='Z525308'><span><span class='ident'>dst</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z525426'><span><span class='ident'>clambda</span></span></span>&nbsp;&#8594;&nbsp;<span class='keyword'>if</span>&nbsp;<span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z525426",this)' onmouseleave='srcref_leave("Z525426",this)'><span><span class='ident'>clenv</span></span></span><span class='hint'>clambda(clenv,args,body)</span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>top</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>closure</span><span class='hint'>lang0j:top:closure(id,clargs,args,body)</span></span><span class='lexic'>(</span><span class='ident'>id</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z525308",this)' onmouseleave='srcref_leave("Z525308",this)'><span><span class='ident'>dst</span></span></span><span class='lexic'>,</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='ident'>clargs</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z525426",this)' onmouseleave='srcref_leave("Z525426",this)'><span><span class='ident'>clenv</span></span></span><span class='hint'>clambda(clenv,args,body)</span></span><span class='lexic'>,</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='ident'>args</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z525426",this)' onmouseleave='srcref_leave("Z525426",this)'><span><span class='ident'>args</span></span></span><span class='hint'>clambda(clenv,args,body)</span></span><span class='lexic'>,</span>&nbsp;<span class='ident'>body</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z525426",this)' onmouseleave='srcref_leave("Z525426",this)'><span><span class='ident'>body</span></span></span><span class='hint'>clambda(clenv,args,body)</span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>else</span>&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>top</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>sfunction</span><span class='hint'>lang0j:top:sfunction(id,args,body)</span></span><span class='lexic'>(</span><span class='ident'>id</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z525308",this)' onmouseleave='srcref_leave("Z525308",this)'><span><span class='ident'>dst</span></span></span><span class='lexic'>,</span>&nbsp;<span class='ident'>args</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z525426",this)' onmouseleave='srcref_leave("Z525426",this)'><span><span class='ident'>args</span></span></span><span class='hint'>clambda(clenv,args,body)</span></span><span class='lexic'>,</span>&nbsp;<span class='ident'>body</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z525426",this)' onmouseleave='srcref_leave("Z525426",this)'><span><span class='ident'>body</span></span></span><span class='hint'>clambda(clenv,args,body)</span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;&nbsp;<span class='ident'>const</span>&nbsp;&#8594;&nbsp;<span class='keyword'>if</span>&nbsp;<span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z525308",this)' onmouseleave='srcref_leave("Z525308",this)'><span><span class='ident'>dst</span></span></span><span class='lexic'>)</span>&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>top</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>defconst</span><span class='hint'>lang0j:top:defconst(id,e)</span></span><span class='lexic'>(</span><span class='ident'>id</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z525308",this)' onmouseleave='srcref_leave("Z525308",this)'><span><span class='ident'>dst</span></span></span><span class='lexic'>,</span>&nbsp;<span class='ident'>e</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='ident'>node</span><span class='lexic'>())</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>else</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>top</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>expr</span><span class='hint'>lang0j:top:expr(e)</span></span><span class='lexic'>(</span><span class='ident'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>const</span><span class='hint'>lang0j:expr:const(c)</span></span><span class='lexic'>(</span><span class='ident'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>nil</span><span class='hint'>lang0j:const:nil()</span></span><span class='lexic'>()))</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;&nbsp;<span class='keyword'>else</span>&nbsp;&nbsp;&#8594;&nbsp;<span class='keyword'>if</span>&nbsp;<span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z525308",this)' onmouseleave='srcref_leave("Z525308",this)'><span><span class='ident'>dst</span></span></span><span class='lexic'>)</span>&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>top</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>define</span><span class='hint'>lang0j:top:define(id,e)</span></span><span class='lexic'>(</span><span class='ident'>id</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z525308",this)' onmouseleave='srcref_leave("Z525308",this)'><span><span class='ident'>dst</span></span></span><span class='lexic'>,</span>&nbsp;<span class='ident'>e</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='ident'>node</span><span class='lexic'>())</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>else</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>top</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>expr</span><span class='hint'>lang0j:top:expr(e)</span></span><span class='lexic'>(</span><span class='ident'>node</span><span class='lexic'>())</span><span class='lexic'>}}</span>
<p></div>



<p><div class='code'>
<span id='Z525546'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_classify_calls</span><span class='lexic'>(</span><span id='Z526016'><span><span class='ident'>ts</span></span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;<span class='keyword'>map</span>&nbsp;<span id='Z526024'><span><span class='ident'>t</span></span></span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z526016",this)' onmouseleave='srcref_leave("Z526016",this)'><span><span class='ident'>ts</span></span></span>&nbsp;<span class='keyword'>do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0j</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>top</span><span class='lexic'>:</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z526024",this)' onmouseleave='srcref_leave("Z526024",this)'><span><span class='ident'>t</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>expr</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z526435'><span><span class='ident'>mkclosure</span></span></span>&nbsp;&#8594;&nbsp;<span class='keyword'>if</span>&nbsp;<span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z526435",this)' onmouseleave='srcref_leave("Z526435",this)'><span><span class='ident'>args</span></span></span><span class='hint'>mkclosure(df,args)</span></span><span class='lexic'>)</span>&nbsp;<span class='ident'>node</span><span class='lexic'>()</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>else</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>funref</span><span class='hint'>lang0j:expr:funref(id)</span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z526435",this)' onmouseleave='srcref_leave("Z526435",this)'><span><span class='ident'>df</span></span></span><span class='hint'>mkclosure(df,args)</span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='ident'>node</span><span class='lexic'>()</span><span class='lexic'>}}</span>
<p></div>


<h3>Flattening bindings</h3>

<p>Instead of our nice and clean functional variable binding we'll produce an
imperative sequence of destructive assignments here. Some other passes will also
introduce true destructive assignments, e.g., lifting the statement expressions
and optimising direct tail recursion, so we're not losing any purity here.  A
consequent SSA transform will make our IR clean again.


<p><div class='code'>
<span id='Z526571'><span class='lexic'>%</span></span><span class='const'>&quot;lang0j:expr&nbsp;-&gt;&nbsp;lang0j:expr&quot;</span><br>
<span class='keyword'>function</span>&nbsp;<span class='ident'>l0_flatten_lets_topexpr</span><span class='lexic'>(</span><span id='Z526956'><span><span class='ident'>e</span></span></span><span class='lexic'>)</span><br>
<span class='keyword'>collector</span><span class='lexic'>(</span><span id='Z527289'><span><span class='ident'>addalloca</span></span></span><span class='lexic'>,</span>&nbsp;<span id='Z527322'><span><span class='ident'>getallocas</span></span></span><span class='lexic'>)</span><br>
<span class='keyword'>with</span>&nbsp;<span class='keyword'>target</span>&nbsp;<span class='lexic'>(</span><span class='ident'>lang0j</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;<span id='Z527323'><span><span class='ident'>ret</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0j</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>expr</span><span class='lexic'>:</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z526956",this)' onmouseleave='srcref_leave("Z526956",this)'><span><span class='ident'>e</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>expr</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z527225'><span><span class='ident'>let</span></span></span>&nbsp;&#8594;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>seq</span><span class='hint'>lang0j:expr:seq(body)</span></span><span class='lexic'>(</span><span class='ident'>body</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z527225",this)' onmouseleave='srcref_leave("Z527225",this)'><span><span class='ident'>ps</span></span></span><span class='hint'>let(ps,body)</span></span><span class='lexic'>&#8853;</span><span class='lexic'>[</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z527225",this)' onmouseleave='srcref_leave("Z527225",this)'><span><span class='ident'>body</span></span></span><span class='hint'>let(ps,body)</span></span><span class='lexic'>])</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='ident'>node</span><span class='lexic'>()};</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>letpair</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z527293'><span><span class='ident'>p</span></span></span>&nbsp;&#8594;&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z527289",this)' onmouseleave='srcref_leave("Z527289",this)'><span><span class='ident'>addalloca</span></span></span><span class='lexic'>(</span><span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>expr</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>alloca</span><span class='hint'>lang0j:expr:alloca(id)</span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z527293",this)' onmouseleave='srcref_leave("Z527293",this)'><span><span class='ident'>id</span></span></span><span class='hint'>p(id,v)</span></span><span class='lexic'>));</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>expr</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>set</span><span class='hint'>lang0j:expr:set(id,v)</span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z527293",this)' onmouseleave='srcref_leave("Z527293",this)'><span><span class='ident'>id</span></span></span><span class='hint'>p(id,v)</span></span><span class='lexic'>,</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z527293",this)' onmouseleave='srcref_leave("Z527293",this)'><span><span class='ident'>v</span></span></span><span class='hint'>p(id,v)</span></span><span class='lexic'>)}}};</span><br>
&nbsp;&nbsp;&nbsp;<span class='keyword'>return</span>&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>expr</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>seq</span><span class='hint'>lang0j:expr:seq(body)</span></span><span class='lexic'>(</span><span class='ident'>body</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z527322",this)' onmouseleave='srcref_leave("Z527322",this)'><span><span class='ident'>getallocas</span></span></span><span class='lexic'>()</span>&nbsp;<span class='lexic'>&#8853;</span>&nbsp;<span class='lexic'>[</span><span class='idfrom' onmouseenter='srcref_over("Z527323",this)' onmouseleave='srcref_leave("Z527323",this)'><span><span class='ident'>ret</span></span></span><span class='lexic'>])}</span>
<p></div>



<p><div class='code'>
<span id='Z527394'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_flatten_lets</span><span class='lexic'>(</span><span id='Z527855'><span><span class='ident'>ts</span></span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;<span class='keyword'>map</span>&nbsp;<span id='Z527863'><span><span class='ident'>t</span></span></span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z527855",this)' onmouseleave='srcref_leave("Z527855",this)'><span><span class='ident'>ts</span></span></span>&nbsp;<span class='keyword'>do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0j</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>top</span><span class='lexic'>:</span><span class='idfrom' onmouseenter='srcref_over("Z527863",this)' onmouseleave='srcref_leave("Z527863",this)'><span><span class='ident'>t</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>once</span>&nbsp;<span class='ident'>expr</span>&nbsp;<span class='lexic'>{</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<a href='#Z526571'><span class='ident'>l0_flatten_lets_topexpr</span></a><span class='lexic'>(</span><span class='ident'>node</span><span class='lexic'>())</span>&nbsp;<span class='lexic'>}}</span>
<p></div>



<h3>Redundant nested seq</h3>

<p>There is no reason for doing this besides pure aesthetics. If you want to
dump IR somewhere in the middle, deeply nested <b>seq</b> may be quite annoying.


<p><div class='code'>
<span id='Z528395'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_seq_tidy_topexpr</span><span class='lexic'>(</span><span id='Z529822'><span><span class='ident'>e</span></span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;<span class='keyword'>do</span>&nbsp;<span id='Z529353'><span><span class='ident'>loop</span></span></span><span class='lexic'>(</span><span id='Z529821'><span><span class='ident'>e</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z529822",this)' onmouseleave='srcref_leave("Z529822",this)'><span><span class='ident'>e</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z529733'><span><span class='ident'>nested</span></span></span><span class='lexic'>(</span><span id='Z529451'><span><span class='ident'>e</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>=</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>do</span>&nbsp;<span id='Z529371'><span><span class='ident'>nestedloop</span></span></span><span class='lexic'>(</span><span id='Z529108'><span><span class='ident'>e</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z529451",this)' onmouseleave='srcref_leave("Z529451",this)'><span><span class='ident'>e</span></span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0j</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>expr</span><span class='lexic'>:</span><span class='idfrom' onmouseenter='srcref_over("Z529108",this)' onmouseleave='srcref_leave("Z529108",this)'><span><span class='ident'>e</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>once</span>&nbsp;<span class='ident'>expr</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z529366'><span><span class='ident'>seq</span></span></span>&nbsp;&#8594;&nbsp;<span class='keyword'>map</span>&nbsp;<span class='keyword'>append</span>&nbsp;<span id='Z529372'><span><span class='ident'>b</span></span></span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z529366",this)' onmouseleave='srcref_leave("Z529366",this)'><span><span class='ident'>body</span></span></span><span class='hint'>seq(body)</span></span>&nbsp;<span class='keyword'>do</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z529371",this)' onmouseleave='srcref_leave("Z529371",this)'><span><span class='ident'>nestedloop</span></span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z529372",this)' onmouseleave='srcref_leave("Z529372",this)'><span><span class='ident'>b</span></span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='lexic'>[</span><span class='idfrom' onmouseenter='srcref_over("Z529353",this)' onmouseleave='srcref_leave("Z529353",this)'><span><span class='ident'>loop</span></span></span><span class='lexic'>(</span><span class='ident'>node</span><span class='lexic'>())]}};</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z529820'><span><span class='ident'>entry</span></span></span><span class='lexic'>(</span><span id='Z529460'><span><span class='ident'>e</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>=</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0j</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>expr</span><span class='lexic'>:</span><span class='idfrom' onmouseenter='srcref_over("Z529460",this)' onmouseleave='srcref_leave("Z529460",this)'><span><span class='ident'>e</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>once</span>&nbsp;<span class='ident'>expr</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z529728'><span><span class='ident'>seq</span></span></span>&nbsp;&#8594;&nbsp;<span class='lexic'>{</span><span class='keyword'>match</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z529728",this)' onmouseleave='srcref_leave("Z529728",this)'><span><span class='ident'>body</span></span></span><span class='hint'>seq(body)</span></span>&nbsp;<span class='keyword'>with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'><span class='pattern'>[</span></span><span id='Z529714'><span><span class='ident'><span class='pattern'>one</span></span></span></span><span class='lexic'><span class='pattern'>]</span></span>&nbsp;&#8594;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z529353",this)' onmouseleave='srcref_leave("Z529353",this)'><span><span class='ident'>loop</span></span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z529714",this)' onmouseleave='srcref_leave("Z529714",this)'><span><span class='ident'>one</span></span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'><span class='pattern'>else</span></span>&nbsp;&#8594;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='keyword'>node</span><span class='hint'>lang0j:expr:seq(body)</span></span><span class='lexic'>(</span><span class='ident'>body</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='keyword'>map</span>&nbsp;<span class='keyword'>append</span>&nbsp;<span id='Z529734'><span><span class='ident'>b</span></span></span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z529728",this)' onmouseleave='srcref_leave("Z529728",this)'><span><span class='ident'>body</span></span></span><span class='hint'>seq(body)</span></span>&nbsp;<span class='keyword'>do</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z529733",this)' onmouseleave='srcref_leave("Z529733",this)'><span><span class='ident'>nested</span></span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z529734",this)' onmouseleave='srcref_leave("Z529734",this)'><span><span class='ident'>b</span></span></span><span class='lexic'>))}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;&#8594;&nbsp;<span class='lexic'>{</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='ident'>node</span><span class='lexic'>()</span>&nbsp;<span class='lexic'>}}};</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z529820",this)' onmouseleave='srcref_leave("Z529820",this)'><span><span class='ident'>entry</span></span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z529821",this)' onmouseleave='srcref_leave("Z529821",this)'><span><span class='ident'>e</span></span></span><span class='lexic'>)}</span>
<p></div>



<p><div class='code'>
<span id='Z529977'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_seq_tidy</span><span class='lexic'>(</span><span id='Z530438'><span><span class='ident'>ts</span></span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;<span class='keyword'>map</span>&nbsp;<span id='Z530446'><span><span class='ident'>t</span></span></span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z530438",this)' onmouseleave='srcref_leave("Z530438",this)'><span><span class='ident'>ts</span></span></span>&nbsp;<span class='keyword'>do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0j</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>top</span><span class='lexic'>:</span><span class='idfrom' onmouseenter='srcref_over("Z530446",this)' onmouseleave='srcref_leave("Z530446",this)'><span><span class='ident'>t</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>once</span>&nbsp;<span class='ident'>expr</span>&nbsp;<span class='lexic'>{</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<a href='#Z528395'><span class='ident'>l0_seq_tidy_topexpr</span></a><span class='lexic'>(</span><span class='ident'>node</span><span class='lexic'>())</span>&nbsp;<span class='lexic'>}}</span>
<p></div>


<h3 id="tails">Marking tail calls</h3>

<p>At this stage, IR is suitable for the tail call analysis, which could have
been more difficult previously and will be more clumsy later. Results of this
marking will be used further down in a direct tail recursion optimisation and
are required for the statement vs. expression split, since we're also
introducing explicit <b>return</b> statements here.


<p><div class='code'>
<span id='Z530978'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>tsplit</span><span class='lexic'>(</span><span id='Z531007'><span><span class='ident'>l0</span></span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;<span class='keyword'>do</span>&nbsp;<span id='Z531003'><span><span class='ident'>iloop</span></span></span><span class='lexic'>(</span><span id='Z531006'><span><span class='ident'>l</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z531007",this)' onmouseleave='srcref_leave("Z531007",this)'><span><span class='ident'>l0</span></span></span><span class='lexic'>,</span>&nbsp;<span id='Z530997'><span><span class='ident'>acc</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='lexic'>&#8709;</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>match</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z531006",this)' onmouseleave='srcref_leave("Z531006",this)'><span><span class='ident'>l</span></span></span>&nbsp;<span class='keyword'>with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'><span class='pattern'>[</span></span><span id='Z530998'><span><span class='ident'><span class='pattern'>hd</span></span></span></span><span class='lexic'><span class='pattern'>]</span></span>&nbsp;&#8594;&nbsp;<span class='lexic'>[</span><span class='idfrom' onmouseenter='srcref_over("Z530997",this)' onmouseleave='srcref_leave("Z530997",this)'><span><span class='ident'>acc</span></span></span><span class='lexic'>;</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z530998",this)' onmouseleave='srcref_leave("Z530998",this)'><span><span class='ident'>hd</span></span></span><span class='lexic'>]</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='lexic'><span class='pattern'>&#8709;</span></span>&nbsp;&#8594;&nbsp;<span class='lexic'>[</span><span class='lexic'>&#8709;</span><span class='lexic'>;</span><span class='lexic'>&#8709;</span><span class='lexic'>]</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span id='Z531005'><span><span class='ident'><span class='pattern'>hd</span></span></span></span><span class='lexic'><span class='pattern'>:</span></span><span id='Z531004'><span><span class='ident'><span class='pattern'>tl</span></span></span></span>&nbsp;&#8594;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z531003",this)' onmouseleave='srcref_leave("Z531003",this)'><span><span class='ident'>iloop</span></span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z531004",this)' onmouseleave='srcref_leave("Z531004",this)'><span><span class='ident'>tl</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z530997",this)' onmouseleave='srcref_leave("Z530997",this)'><span><span class='ident'>acc</span></span></span>&nbsp;<span class='lexic'>&#8853;</span>&nbsp;<span class='lexic'>[</span><span class='idfrom' onmouseenter='srcref_over("Z531005",this)' onmouseleave='srcref_leave("Z531005",this)'><span><span class='ident'>hd</span></span></span><span class='lexic'>])</span>
<p></div>



<p><div class='code'>
<span id='Z531026'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_tailcalls_topexpr</span><span class='lexic'>(</span><span id='Z531796'><span><span class='ident'>e0</span></span></span><span class='lexic'>)</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;<span class='keyword'>do</span>&nbsp;<span id='Z531682'><span><span class='ident'>loop</span></span></span><span class='lexic'>(</span><span id='Z531410'><span><span class='ident'>e</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z531796",this)' onmouseleave='srcref_leave("Z531796",this)'><span><span class='ident'>e0</span></span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0j</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>expr</span><span class='lexic'>:</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z531410",this)' onmouseleave='srcref_leave("Z531410",this)'><span><span class='ident'>e</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>once</span>&nbsp;<span class='ident'>expr</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z531666'><span><span class='ident'>seq</span></span></span>&nbsp;&#8594;&nbsp;<span class='keyword'>if</span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z531666",this)' onmouseleave='srcref_leave("Z531666",this)'><span><span class='ident'>body</span></span></span><span class='hint'>seq(body)</span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>&lt;</span><span class='lexic'><span class='pattern'>[</span></span><span id='Z531681'><span><span class='ident'><span class='pattern'>a</span></span></span></span><span class='lexic'><span class='pattern'>;</span></span><span id='Z531683'><span><span class='ident'><span class='pattern'>b</span></span></span></span><span class='lexic'><span class='pattern'>]</span></span><span class='lexic'>&gt;</span>&nbsp;<span class='lexic'>=</span>&nbsp;<a href='#Z530978'><span class='ident'>tsplit</span></a><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z531666",this)' onmouseleave='srcref_leave("Z531666",this)'><span><span class='ident'>body</span></span></span><span class='hint'>seq(body)</span></span><span class='lexic'>);</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='keyword'>node</span><span class='hint'>lang0j:expr:seq(body)</span></span><span class='lexic'>(</span><span class='ident'>body</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z531681",this)' onmouseleave='srcref_leave("Z531681",this)'><span><span class='ident'>a</span></span></span>&nbsp;<span class='lexic'>&#8853;</span>&nbsp;<span class='lexic'>[</span><span class='idfrom' onmouseenter='srcref_over("Z531682",this)' onmouseleave='srcref_leave("Z531682",this)'><span><span class='ident'>loop</span></span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z531683",this)' onmouseleave='srcref_leave("Z531683",this)'><span><span class='ident'>b</span></span></span><span class='lexic'>)])}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>else</span>&nbsp;<span class='ident'>node</span><span class='lexic'>()</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;&nbsp;<span id='Z531727'><span><span class='ident'>if3</span></span></span>&nbsp;&#8594;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='keyword'>node</span><span class='hint'>lang0j:expr:if3(cnd,tr,fl)<br>
&nbsp;&nbsp;&nbsp;with&nbsp;implicit&nbsp;arguments:&nbsp;cnd<br>
</span></span><span class='lexic'>(</span><span class='ident'>tr</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z531682",this)' onmouseleave='srcref_leave("Z531682",this)'><span><span class='ident'>loop</span></span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z531727",this)' onmouseleave='srcref_leave("Z531727",this)'><span><span class='ident'>tr</span></span></span><span class='hint'>if3(cnd,tr,fl)</span></span><span class='lexic'>),</span>&nbsp;<span class='ident'>fl</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z531682",this)' onmouseleave='srcref_leave("Z531682",this)'><span><span class='ident'>loop</span></span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z531727",this)' onmouseleave='srcref_leave("Z531727",this)'><span><span class='ident'>fl</span></span></span><span class='hint'>if3(cnd,tr,fl)</span></span><span class='lexic'>))</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;&nbsp;<span id='Z531704'><span><span class='ident'>apply</span></span></span>&nbsp;&#8594;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>tailapply</span><span class='hint'>lang0j:expr:tailapply(fn,args)</span></span><span class='lexic'>(</span><span class='ident'>fn</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z531704",this)' onmouseleave='srcref_leave("Z531704",this)'><span><span class='ident'>fn</span></span></span><span class='hint'>apply(fn,args)</span></span><span class='lexic'>,</span>&nbsp;<span class='ident'>args</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z531704",this)' onmouseleave='srcref_leave("Z531704",this)'><span><span class='ident'>args</span></span></span><span class='hint'>apply(fn,args)</span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>return</span><span class='hint'>lang0j:expr:return(v)</span></span><span class='lexic'>(</span><span class='ident'>node</span><span class='lexic'>())</span><span class='lexic'>}}</span>
<p></div>



<p><div class='code'>
<span id='Z531875'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_tailcalls</span><span class='lexic'>(</span><span id='Z532336'><span><span class='ident'>ts</span></span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;<span class='keyword'>map</span>&nbsp;<span id='Z532344'><span><span class='ident'>t</span></span></span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z532336",this)' onmouseleave='srcref_leave("Z532336",this)'><span><span class='ident'>ts</span></span></span>&nbsp;<span class='keyword'>do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0j</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>top</span><span class='lexic'>:</span><span class='idfrom' onmouseenter='srcref_over("Z532344",this)' onmouseleave='srcref_leave("Z532344",this)'><span><span class='ident'>t</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>once</span>&nbsp;<span class='ident'>expr</span>&nbsp;<span class='lexic'>{</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<a href='#Z531026'><span class='ident'>l0_tailcalls_topexpr</span></a><span class='lexic'>(</span><span class='ident'>node</span><span class='lexic'>())</span>&nbsp;<span class='lexic'>}}</span>
<p></div>


<h3>Statement expressions</h3>

<p>A procedure very similar to tail call marking, but for the statement
expressions (like <b>if</b> and <b>seq</b> yielding value that is used inside
another expression). We'll need it later on when we actually split statements
and expressions.

<p>The following function, just like a tail call marker pass before, will follow
the returning branches of expressions only --- i.e., last entry in a sequence
and both arms of an <b>if</b>, but instead of inserting a <b>return</b> or a
tail call marker it will assign that value to a variable or wrap it into a
<b>drop</b> marker, meaning that the result is going to be discarded anyway.


<p><div class='code'>
<span id='Z532876'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_stmtexpr_inner</span><span class='lexic'>(</span><span id='Z533643'><span><span class='ident'>e0</span></span></span><span class='lexic'>,</span>&nbsp;<span id='Z533506'><span><span class='ident'>dst</span></span></span><span class='lexic'>)</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;<span class='keyword'>do</span>&nbsp;<span id='Z533543'><span><span class='ident'>loop</span></span></span><span class='lexic'>(</span><span id='Z533261'><span><span class='ident'>e</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z533643",this)' onmouseleave='srcref_leave("Z533643",this)'><span><span class='ident'>e0</span></span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0j</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>expr</span><span class='lexic'>:</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z533261",this)' onmouseleave='srcref_leave("Z533261",this)'><span><span class='ident'>e</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>once</span>&nbsp;<span class='ident'>expr</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z533527'><span><span class='ident'>seq</span></span></span>&nbsp;&#8594;&nbsp;<span class='keyword'>if</span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z533527",this)' onmouseleave='srcref_leave("Z533527",this)'><span><span class='ident'>body</span></span></span><span class='hint'>seq(body)</span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>&lt;</span><span class='lexic'><span class='pattern'>[</span></span><span id='Z533542'><span><span class='ident'><span class='pattern'>a</span></span></span></span><span class='lexic'><span class='pattern'>;</span></span><span id='Z533544'><span><span class='ident'><span class='pattern'>b</span></span></span></span><span class='lexic'><span class='pattern'>]</span></span><span class='lexic'>&gt;</span>&nbsp;<span class='lexic'>=</span>&nbsp;<a href='#Z530978'><span class='ident'>tsplit</span></a><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z533527",this)' onmouseleave='srcref_leave("Z533527",this)'><span><span class='ident'>body</span></span></span><span class='hint'>seq(body)</span></span><span class='lexic'>);</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='keyword'>node</span><span class='hint'>lang0j:expr:seq(body)</span></span><span class='lexic'>(</span><span class='ident'>body</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z533542",this)' onmouseleave='srcref_leave("Z533542",this)'><span><span class='ident'>a</span></span></span>&nbsp;<span class='lexic'>&#8853;</span>&nbsp;<span class='lexic'>[</span><span class='idfrom' onmouseenter='srcref_over("Z533543",this)' onmouseleave='srcref_leave("Z533543",this)'><span><span class='ident'>loop</span></span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z533544",this)' onmouseleave='srcref_leave("Z533544",this)'><span><span class='ident'>b</span></span></span><span class='lexic'>)])}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>else</span>&nbsp;<span class='ident'>node</span><span class='lexic'>()</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;&nbsp;<span id='Z533574'><span><span class='ident'>if3</span></span></span>&nbsp;&#8594;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='keyword'>node</span><span class='hint'>lang0j:expr:if3(cnd,tr,fl)<br>
&nbsp;&nbsp;&nbsp;with&nbsp;implicit&nbsp;arguments:&nbsp;cnd<br>
</span></span><span class='lexic'>(</span><span class='ident'>tr</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z533543",this)' onmouseleave='srcref_leave("Z533543",this)'><span><span class='ident'>loop</span></span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z533574",this)' onmouseleave='srcref_leave("Z533574",this)'><span><span class='ident'>tr</span></span></span><span class='hint'>if3(cnd,tr,fl)</span></span><span class='lexic'>),</span>&nbsp;<span class='ident'>fl</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z533543",this)' onmouseleave='srcref_leave("Z533543",this)'><span><span class='ident'>loop</span></span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z533574",this)' onmouseleave='srcref_leave("Z533574",this)'><span><span class='ident'>fl</span></span></span><span class='hint'>if3(cnd,tr,fl)</span></span><span class='lexic'>))</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;&nbsp;<span class='ident'>alloca</span>&nbsp;&#8594;&nbsp;<span class='ident'>node</span><span class='lexic'>()</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;&nbsp;<span class='ident'>set</span>&nbsp;&#8594;&nbsp;<span class='ident'>node</span><span class='lexic'>()</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='keyword'>if</span>&nbsp;<span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z533506",this)' onmouseleave='srcref_leave("Z533506",this)'><span><span class='ident'>dst</span></span></span><span class='lexic'>)</span>&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>set</span><span class='hint'>lang0j:expr:set(id,v)</span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z533506",this)' onmouseleave='srcref_leave("Z533506",this)'><span><span class='ident'>dst</span></span></span><span class='lexic'>,</span>&nbsp;<span class='ident'>node</span><span class='lexic'>())</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>else</span>&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>drop</span><span class='hint'>lang0j:expr:drop(v)</span></span><span class='lexic'>(</span><span class='ident'>node</span><span class='lexic'>())</span><span class='lexic'>}}</span>
<p></div>


<p>The next function is identifying statement--expressions and treats them in a
special way: any value returned from the non--terminal sequence elements is
dropped, and any value of a complex statement--expression that is actually used
is assigned to a variable, and a special <b>splitexpr</b> variant is created,
holding both the statement that generates the value and an expression to access
this value. After the split between statements and expressions is completed
those inner statements will be lifted to their nearest statement scopes.


<p><div class='code'>
<span id='Z533724'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_stmtexpr_topexpr_inner</span><span class='lexic'>(</span><span id='Z535268'><span><span class='ident'>e0</span></span></span><span class='lexic'>,</span>&nbsp;<span id='Z534742'><span><span class='ident'>addalloca</span></span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;<span class='keyword'>do</span>&nbsp;<span id='Z534756'><span><span class='ident'>loop</span></span></span><span class='lexic'>(</span><span id='Z535267'><span><span class='ident'>e</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z535268",this)' onmouseleave='srcref_leave("Z535268",this)'><span><span class='ident'>e0</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;<span id='Z535127'><span><span class='ident'>inner</span></span></span><span class='lexic'>(</span><span id='Z534493'><span><span class='ident'>e</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>=</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0j</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>expr</span><span class='lexic'>:</span><span class='idfrom' onmouseenter='srcref_over("Z534493",this)' onmouseleave='srcref_leave("Z534493",this)'><span><span class='ident'>e</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>once</span>&nbsp;<span class='ident'>expr</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='ident'>seq</span>&nbsp;&#8594;&nbsp;<span class='keyword'>symbols</span><span class='lexic'>(</span><span id='Z534746'><span><span class='ident'>dst</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z534742",this)' onmouseleave='srcref_leave("Z534742",this)'><span><span class='ident'>addalloca</span></span></span><span class='lexic'>(</span><span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>alloca</span><span class='hint'>lang0j:expr:alloca(id)</span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z534746",this)' onmouseleave='srcref_leave("Z534746",this)'><span><span class='ident'>dst</span></span></span><span class='lexic'>));</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>splitexpr</span><span class='hint'>lang0j:expr:splitexpr(l,r)</span></span><span class='lexic'>(</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href='#Z532876'><span class='ident'>l0_stmtexpr_inner</span></a><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z534756",this)' onmouseleave='srcref_leave("Z534756",this)'><span><span class='ident'>loop</span></span></span><span class='lexic'>(</span><span class='ident'>node</span><span class='lexic'>()),</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z534746",this)' onmouseleave='srcref_leave("Z534746",this)'><span><span class='ident'>dst</span></span></span><span class='lexic'>),</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='ident'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>local</span><span class='hint'>lang0j:expr:local(id)</span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z534746",this)' onmouseleave='srcref_leave("Z534746",this)'><span><span class='ident'>dst</span></span></span><span class='lexic'>))}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>if3</span>&nbsp;&#8594;&nbsp;<span class='keyword'>symbols</span><span class='lexic'>(</span><span id='Z534792'><span><span class='ident'>dst</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z534742",this)' onmouseleave='srcref_leave("Z534742",this)'><span><span class='ident'>addalloca</span></span></span><span class='lexic'>(</span><span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>alloca</span><span class='hint'>lang0j:expr:alloca(id)</span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z534792",this)' onmouseleave='srcref_leave("Z534792",this)'><span><span class='ident'>dst</span></span></span><span class='lexic'>));</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>splitexpr</span><span class='hint'>lang0j:expr:splitexpr(l,r)</span></span><span class='lexic'>(</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href='#Z532876'><span class='ident'>l0_stmtexpr_inner</span></a><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z534756",this)' onmouseleave='srcref_leave("Z534756",this)'><span><span class='ident'>loop</span></span></span><span class='lexic'>(</span><span class='ident'>node</span><span class='lexic'>()),</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z534792",this)' onmouseleave='srcref_leave("Z534792",this)'><span><span class='ident'>dst</span></span></span><span class='lexic'>),</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='ident'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>local</span><span class='hint'>lang0j:expr:local(id)</span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z534792",this)' onmouseleave='srcref_leave("Z534792",this)'><span><span class='ident'>dst</span></span></span><span class='lexic'>))}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='keyword'>deep</span>&nbsp;&#8594;&nbsp;<span class='lexic'>{</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='ident'>node</span><span class='lexic'>()</span>&nbsp;<span class='lexic'>}}};</span><br>
&nbsp;&nbsp;&nbsp;<span id='Z535266'><span><span class='ident'>toplev</span></span></span><span class='lexic'>(</span><span id='Z534882'><span><span class='ident'>e</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>=</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0j</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>expr</span><span class='lexic'>:</span><span class='idfrom' onmouseenter='srcref_over("Z534882",this)' onmouseleave='srcref_leave("Z534882",this)'><span><span class='ident'>e</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>once</span>&nbsp;<span class='ident'>expr</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z535131'><span><span class='ident'>seq</span></span></span>&nbsp;&#8594;&nbsp;<span class='keyword'>if</span>&nbsp;<span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z535131",this)' onmouseleave='srcref_leave("Z535131",this)'><span><span class='ident'>body</span></span></span><span class='hint'>seq(body)</span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>&lt;</span><span class='lexic'><span class='pattern'>[</span></span><span id='Z535149'><span><span class='ident'><span class='pattern'>a</span></span></span></span><span class='lexic'><span class='pattern'>;</span></span><span id='Z535153'><span><span class='ident'><span class='pattern'>b</span></span></span></span><span class='lexic'><span class='pattern'>]</span></span><span class='lexic'>&gt;</span>&nbsp;<span class='lexic'>=</span>&nbsp;<a href='#Z530978'><span class='ident'>tsplit</span></a><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z535131",this)' onmouseleave='srcref_leave("Z535131",this)'><span><span class='ident'>body</span></span></span><span class='hint'>seq(body)</span></span><span class='lexic'>);</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='keyword'>node</span><span class='hint'>lang0j:expr:seq(body)</span></span><span class='lexic'>(</span><span class='ident'>body</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='lexic'>[@</span><span class='keyword'>map</span>&nbsp;<span id='Z535152'><span><span class='idfrom' onmouseenter='srcref_over("Z535149",this)' onmouseleave='srcref_leave("Z535149",this)'><span><span class='ident'>a</span></span></span></span></span>&nbsp;<span class='keyword'>do</span>&nbsp;<a href='#Z532876'><span class='ident'>l0_stmtexpr_inner</span></a><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z534756",this)' onmouseleave='srcref_leave("Z534756",this)'><span><span class='ident'>loop</span></span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z535152",this)' onmouseleave='srcref_leave("Z535152",this)'><span><span class='ident'>a</span></span></span><span class='lexic'>),</span>&nbsp;<span class='lexic'>&#8709;</span><span class='lexic'>);</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z534756",this)' onmouseleave='srcref_leave("Z534756",this)'><span><span class='ident'>loop</span></span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z535153",this)' onmouseleave='srcref_leave("Z535153",this)'><span><span class='ident'>b</span></span></span><span class='lexic'>)])</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>}</span>&nbsp;<span class='keyword'>else</span>&nbsp;<span class='ident'>node</span><span class='lexic'>()</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span id='Z535184'><span><span class='ident'>if3</span></span></span>&nbsp;&#8594;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='keyword'>node</span><span class='hint'>lang0j:expr:if3(cnd,tr,fl)</span></span><span class='lexic'>(</span><span class='ident'>cnd</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z535127",this)' onmouseleave='srcref_leave("Z535127",this)'><span><span class='ident'>inner</span></span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z535184",this)' onmouseleave='srcref_leave("Z535184",this)'><span><span class='ident'>cnd</span></span></span><span class='hint'>if3(cnd,tr,fl)</span></span><span class='lexic'>),</span>&nbsp;<span class='ident'>tr</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z534756",this)' onmouseleave='srcref_leave("Z534756",this)'><span><span class='ident'>loop</span></span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z535184",this)' onmouseleave='srcref_leave("Z535184",this)'><span><span class='ident'>tr</span></span></span><span class='hint'>if3(cnd,tr,fl)</span></span><span class='lexic'>),</span>&nbsp;<span class='ident'>fl</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z534756",this)' onmouseleave='srcref_leave("Z534756",this)'><span><span class='ident'>loop</span></span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z535184",this)' onmouseleave='srcref_leave("Z535184",this)'><span><span class='ident'>fl</span></span></span><span class='hint'>if3(cnd,tr,fl)</span></span><span class='lexic'>))</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span id='Z535232'><span><span class='ident'>set</span></span></span>&nbsp;&#8594;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='keyword'>node</span><span class='hint'>lang0j:expr:set(id,v)<br>
&nbsp;&nbsp;&nbsp;with&nbsp;implicit&nbsp;arguments:&nbsp;id<br>
</span></span><span class='lexic'>(</span><span class='ident'>v</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z535127",this)' onmouseleave='srcref_leave("Z535127",this)'><span><span class='ident'>inner</span></span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z535232",this)' onmouseleave='srcref_leave("Z535232",this)'><span><span class='ident'>v</span></span></span><span class='hint'>set(id,v)</span></span><span class='lexic'>))</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z535127",this)' onmouseleave='srcref_leave("Z535127",this)'><span><span class='ident'>inner</span></span></span><span class='lexic'>(</span><span class='ident'>node</span><span class='lexic'>())}};</span><br>
&nbsp;&nbsp;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z535266",this)' onmouseleave='srcref_leave("Z535266",this)'><span><span class='ident'>toplev</span></span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z535267",this)' onmouseleave='srcref_leave("Z535267",this)'><span><span class='ident'>e</span></span></span><span class='lexic'>)}</span>
<p></div>


<p>The previous function could have created some new variables, so we have to
add corresponding allocas to the beginning of the outer context.


<p><div class='code'>
<span id='Z535424'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_stmtexpr_topexpr</span><span class='lexic'>(</span><span id='Z535446'><span><span class='ident'>e0</span></span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;<span class='keyword'>collector</span>&nbsp;<span class='lexic'>(</span><span id='Z535447'><span><span class='ident'>addalloca</span></span></span><span class='lexic'>,</span>&nbsp;<span id='Z535449'><span><span class='ident'>getallocas</span></span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;<span class='keyword'>with</span>&nbsp;<span class='keyword'>target</span>&nbsp;<span class='lexic'>(</span><span class='ident'>lang0j</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z535454'><span><span class='ident'>ret</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<a href='#Z533724'><span class='ident'>l0_stmtexpr_topexpr_inner</span></a><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z535446",this)' onmouseleave='srcref_leave("Z535446",this)'><span><span class='ident'>e0</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z535447",this)' onmouseleave='srcref_leave("Z535447",this)'><span><span class='ident'>addalloca</span></span></span><span class='lexic'>);</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z535450'><span><span class='ident'>allocas</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z535449",this)' onmouseleave='srcref_leave("Z535449",this)'><span><span class='ident'>getallocas</span></span></span><span class='lexic'>();</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>if</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z535450",this)' onmouseleave='srcref_leave("Z535450",this)'><span><span class='ident'>allocas</span></span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>expr</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>seq</span><span class='hint'>lang0j:expr:seq(body)</span></span><span class='lexic'>(</span><span class='ident'>body</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='lexic'>[@</span><span class='idfrom' onmouseenter='srcref_over("Z535450",this)' onmouseleave='srcref_leave("Z535450",this)'><span><span class='ident'>allocas</span></span></span><span class='lexic'>;</span><span class='idfrom' onmouseenter='srcref_over("Z535454",this)' onmouseleave='srcref_leave("Z535454",this)'><span><span class='ident'>ret</span></span></span><span class='lexic'>])</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>else</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z535454",this)' onmouseleave='srcref_leave("Z535454",this)'><span><span class='ident'>ret</span></span></span><span class='lexic'>}</span>
<p></div>



<p><div class='code'>
<span id='Z535464'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_stmtexpr</span><span class='lexic'>(</span><span id='Z535925'><span><span class='ident'>ts</span></span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;<span class='keyword'>map</span>&nbsp;<span id='Z535933'><span><span class='ident'>t</span></span></span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z535925",this)' onmouseleave='srcref_leave("Z535925",this)'><span><span class='ident'>ts</span></span></span>&nbsp;<span class='keyword'>do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0j</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>top</span><span class='lexic'>:</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z535933",this)' onmouseleave='srcref_leave("Z535933",this)'><span><span class='ident'>t</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>once</span>&nbsp;<span class='ident'>expr</span>&nbsp;<span class='lexic'>{</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<a href='#Z535424'><span class='ident'>l0_stmtexpr_topexpr</span></a><span class='lexic'>(</span><span class='ident'>node</span><span class='lexic'>())</span>&nbsp;<span class='lexic'>}}</span>
<p></div>


<h3 id="tco">Detecting tail recursion</h3>

<p>Some tail calls are tail recursive, and this is a right moment to replace
them with a <b>goto</b>.  The language does not have gotos and labels? Not a
problem at all, we'll make a new language now:


<p><div class='code'>
<span class='keyword'>ast</span>&nbsp;<span class='ident'>lang0k</span>&nbsp;<span class='lexic'>:</span>&nbsp;<span class='ident'>lang0j</span>&nbsp;<span class='lexic'>()</span>&nbsp;<span class='keyword'>recform</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;<span class='ident'>expr</span>&nbsp;<span class='lexic'>+=</span>&nbsp;<span class='ident'>label</span><span class='lexic'>(</span><span class='ident'>labident</span><span class='lexic'>:</span><span class='ident'>id</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;&nbsp;<span class='ident'>goto</span><span class='lexic'>(</span><span class='ident'>labident</span><span class='lexic'>:</span><span class='ident'>id</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='lexic'>-</span><span class='ident'>let</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>;</span><br>
&nbsp;&nbsp;<span class='ident'>hint</span>&nbsp;<span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>alloca</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='ident'>newline</span><span class='lexic'>;</span><br>
&nbsp;&nbsp;<span class='ident'>hint</span>&nbsp;<span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>set</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='ident'>newline</span><span class='lexic'>;</span><br>
&nbsp;&nbsp;<span class='ident'>hint</span>&nbsp;<span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>seq</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='ident'>newline</span><span class='lexic'>;</span><br>
&nbsp;&nbsp;<span class='ident'>hint</span>&nbsp;<span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>if3</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='ident'>newline</span><span class='lexic'>;</span><br>
&nbsp;&nbsp;<span class='ident'>hint</span>&nbsp;<span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>goto</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='ident'>newline</span><span class='lexic'>;</span><br>
&nbsp;&nbsp;<span class='ident'>hint</span>&nbsp;<span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>label</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='ident'>newline</span><span class='lexic'>;</span><br>
&nbsp;&nbsp;<span class='ident'>hint</span>&nbsp;<span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>return</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='ident'>newline</span><span class='lexic'>;</span><br>
<span class='lexic'>}</span>
<p></div>


<p>If a function is directly tail recursive, we have to create temporary
variables that will initially contain copies of the argument values and then
will be used to pass arguments in a tail--recursive call. In this case all the
argument references in the function body must be replaced with local variable
references.


<p><div class='code'>
<span id='Z536465'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_tailrec_topexpr</span><span class='lexic'>(</span><span id='Z537759'><span><span class='ident'>self</span></span></span><span class='lexic'>,</span>&nbsp;<span id='Z538461'><span><span class='ident'>fnargs</span></span></span><span class='lexic'>,</span>&nbsp;<span id='Z538138'><span><span class='ident'>e</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;<span id='Z538453'><span><span class='ident'>trecp</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='ident'>mkref</span><span class='lexic'>(</span><span class='lexic'>&#8709;</span><span class='lexic'>);</span><br>
&nbsp;&nbsp;&nbsp;<span id='Z538449'><span><span class='ident'>isself</span></span></span><span class='lexic'>(</span><span id='Z537515'><span><span class='ident'>e</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>=</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0k</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>expr</span><span class='lexic'>:</span><span class='idfrom' onmouseenter='srcref_over("Z537515",this)' onmouseleave='srcref_leave("Z537515",this)'><span><span class='ident'>e</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>once</span>&nbsp;<span class='ident'>expr</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z537756'><span><span class='ident'>global</span></span></span>&nbsp;&#8594;&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z537756",this)' onmouseleave='srcref_leave("Z537756",this)'><span><span class='ident'>id</span></span></span><span class='hint'>global(id)</span></span>&nbsp;<span class='lexic'>===</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z537759",this)' onmouseleave='srcref_leave("Z537759",this)'><span><span class='ident'>self</span></span></span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='lexic'>&#8709;</span><span class='lexic'>}};</span><br>
&nbsp;&nbsp;&nbsp;<span id='Z538559'><span><span class='ident'>rewriteargs</span></span></span><span class='lexic'>(</span><span id='Z537824'><span><span class='ident'>e</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>=</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0k</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>expr</span><span class='lexic'>:</span><span class='idfrom' onmouseenter='srcref_over("Z537824",this)' onmouseleave='srcref_leave("Z537824",this)'><span><span class='ident'>e</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>expr</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z538074'><span><span class='ident'>arg</span></span></span>&nbsp;&#8594;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>local</span><span class='hint'>lang0k:expr:local(id)</span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z538074",this)' onmouseleave='srcref_leave("Z538074",this)'><span><span class='ident'>id</span></span></span><span class='hint'>arg(id)</span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='ident'>node</span><span class='lexic'>()}};</span><br>
&nbsp;&nbsp;&nbsp;<span id='Z538560'><span><span class='ident'>body0</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0j</span>&nbsp;<span class='lexic'>/rec,</span>&nbsp;<span class='lexic'>dst</span>&nbsp;<span class='ident'>lang0k</span><span class='lexic'>/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>expr</span><span class='lexic'>:</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z538138",this)' onmouseleave='srcref_leave("Z538138",this)'><span><span class='ident'>e</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>expr</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z538450'><span><span class='ident'>tailapply</span></span></span>&nbsp;&#8594;&nbsp;<span class='keyword'>if</span>&nbsp;<span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z538449",this)' onmouseleave='srcref_leave("Z538449",this)'><span><span class='ident'>isself</span></span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z538450",this)' onmouseleave='srcref_leave("Z538450",this)'><span><span class='ident'>fn</span></span></span><span class='hint'>tailapply(fn,args)</span></span><span class='lexic'>))</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z538453",this)' onmouseleave='srcref_leave("Z538453",this)'><span><span class='ident'>trecp</span></span></span>&nbsp;<span class='lexic'>:=</span>&nbsp;<span class='keyword'>true</span><span class='lexic'>;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>seq</span><span class='hint'>lang0k:expr:seq(body)</span></span><span class='lexic'>(</span><span class='ident'>body</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='lexic'>[@</span><span class='keyword'>map</span>&nbsp;<span class='lexic'>[</span><span id='Z538479'><span><span class='ident'><span class='pattern'>a</span></span></span></span><span class='lexic'>;</span><span id='Z538480'><span><span class='ident'><span class='pattern'>v</span></span></span></span><span class='lexic'>]</span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='withhint'><span class='ident'>zip</span><span class='hint'>function&nbsp;zip&nbsp;a,&nbsp;b:&nbsp;<br>
Returns&nbsp;the&nbsp;list&nbsp;of&nbsp;($a_i${}&nbsp;$b_i$)&nbsp;for&nbsp;all&nbsp;elements&nbsp;of&nbsp;[a]&nbsp;and&nbsp;[b].</span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z538461",this)' onmouseleave='srcref_leave("Z538461",this)'><span><span class='ident'>fnargs</span></span></span><span class='lexic'>,</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z538450",this)' onmouseleave='srcref_leave("Z538450",this)'><span><span class='ident'>args</span></span></span><span class='hint'>tailapply(fn,args)</span></span><span class='lexic'>)</span>&nbsp;<span class='keyword'>do</span>&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>set</span><span class='hint'>lang0k:expr:set(id,v)</span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z538479",this)' onmouseleave='srcref_leave("Z538479",this)'><span><span class='ident'>a</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z538480",this)' onmouseleave='srcref_leave("Z538480",this)'><span><span class='ident'>v</span></span></span><span class='lexic'>);</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>goto</span><span class='hint'>lang0k:expr:goto(id)</span></span><span class='lexic'>(</span><span class='symbol'>'tailrecentry'</span><span class='lexic'>)])</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>}</span>&nbsp;<span class='keyword'>else</span>&nbsp;<span class='ident'>node</span><span class='lexic'>()</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='ident'>node</span><span class='lexic'>()}};</span><br>
&nbsp;&nbsp;&nbsp;<span class='keyword'>if</span>&nbsp;<span class='lexic'>(^</span><span class='idfrom' onmouseenter='srcref_over("Z538453",this)' onmouseleave='srcref_leave("Z538453",this)'><span><span class='ident'>trecp</span></span></span><span class='lexic'>)</span>&nbsp;<span class='keyword'>with</span>&nbsp;<span class='keyword'>target</span>&nbsp;<span class='lexic'>(</span><span class='ident'>lang0k</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>expr</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>seq</span><span class='hint'>lang0k:expr:seq(body)</span></span><span class='lexic'>(</span><span class='ident'>body</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='lexic'>[@</span><span class='keyword'>map</span>&nbsp;<span id='Z538524'><span><span class='ident'>a</span></span></span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z538461",this)' onmouseleave='srcref_leave("Z538461",this)'><span><span class='ident'>fnargs</span></span></span>&nbsp;<span class='keyword'>do</span>&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>alloca</span><span class='hint'>lang0k:expr:alloca(id)</span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z538524",this)' onmouseleave='srcref_leave("Z538524",this)'><span><span class='ident'>a</span></span></span><span class='lexic'>);</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>@</span><span class='keyword'>map</span>&nbsp;<span id='Z538537'><span><span class='ident'>a</span></span></span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z538461",this)' onmouseleave='srcref_leave("Z538461",this)'><span><span class='ident'>fnargs</span></span></span>&nbsp;<span class='keyword'>do</span>&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>set</span><span class='hint'>lang0k:expr:set(id,v)</span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z538537",this)' onmouseleave='srcref_leave("Z538537",this)'><span><span class='ident'>a</span></span></span><span class='lexic'>,</span>&nbsp;<span class='ident'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>arg</span><span class='hint'>lang0k:expr:arg(id)</span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z538537",this)' onmouseleave='srcref_leave("Z538537",this)'><span><span class='ident'>a</span></span></span><span class='lexic'>));</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>goto</span><span class='hint'>lang0k:expr:goto(id)</span></span><span class='lexic'>(</span><span class='symbol'>'tailrecentry'</span><span class='lexic'>);</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>label</span><span class='hint'>lang0k:expr:label(id)</span></span><span class='lexic'>(</span><span class='symbol'>'tailrecentry'</span><span class='lexic'>);</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z538559",this)' onmouseleave='srcref_leave("Z538559",this)'><span><span class='ident'>rewriteargs</span></span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z538560",this)' onmouseleave='srcref_leave("Z538560",this)'><span><span class='ident'>body0</span></span></span><span class='lexic'>)])</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;<span class='lexic'>}</span>&nbsp;<span class='keyword'>else</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z538560",this)' onmouseleave='srcref_leave("Z538560",this)'><span><span class='ident'>body0</span></span></span><span class='lexic'>}</span>
<p></div>



<p><div class='code'>
<span id='Z538772'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_tailrec</span><span class='lexic'>(</span><span id='Z539242'><span><span class='ident'>ts</span></span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;<span class='keyword'>map</span>&nbsp;<span id='Z539250'><span><span class='ident'>t</span></span></span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z539242",this)' onmouseleave='srcref_leave("Z539242",this)'><span><span class='ident'>ts</span></span></span>&nbsp;<span class='keyword'>do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0j</span>&nbsp;<span class='lexic'>/rec,</span>&nbsp;<span class='lexic'>dst</span>&nbsp;<span class='ident'>lang0k</span><span class='lexic'>/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>top</span><span class='lexic'>:</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z539250",this)' onmouseleave='srcref_leave("Z539250",this)'><span><span class='ident'>t</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>once</span>&nbsp;<span class='ident'>top</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z539601'><span><span class='ident'>sfunction</span></span></span>&nbsp;&#8594;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='keyword'>node</span><span class='hint'>lang0k:top:sfunction(id,args,body)<br>
&nbsp;&nbsp;&nbsp;with&nbsp;implicit&nbsp;arguments:&nbsp;id,&nbsp;args<br>
</span></span><span class='lexic'>(</span><span class='ident'>body</span>&nbsp;<span class='lexic'>=</span>&nbsp;<a href='#Z536465'><span class='ident'>l0_tailrec_topexpr</span></a><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z539601",this)' onmouseleave='srcref_leave("Z539601",this)'><span><span class='ident'>id</span></span></span><span class='hint'>sfunction(id,args,body)</span></span><span class='lexic'>,</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z539601",this)' onmouseleave='srcref_leave("Z539601",this)'><span><span class='ident'>args</span></span></span><span class='hint'>sfunction(id,args,body)</span></span><span class='lexic'>,</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z539601",this)' onmouseleave='srcref_leave("Z539601",this)'><span><span class='ident'>body</span></span></span><span class='hint'>sfunction(id,args,body)</span></span><span class='lexic'>))</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='keyword'>deep</span>&nbsp;&#8594;&nbsp;<span class='lexic'>{</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='ident'>node</span><span class='lexic'>()</span>&nbsp;<span class='lexic'>}};</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>once</span>&nbsp;<span class='ident'>expr</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='comment'>//&nbsp;We&nbsp;still&nbsp;have&nbsp;to&nbsp;do&nbsp;this&nbsp;pass&nbsp;even&nbsp;if&nbsp;it's&nbsp;not&nbsp;a&nbsp;function,<br>
</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='comment'>//&nbsp;because&nbsp;we're&nbsp;moving&nbsp;to&nbsp;another&nbsp;AST&nbsp;version&nbsp;here.<br>
</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<a href='#Z536465'><span class='ident'>l0_tailrec_topexpr</span></a><span class='lexic'>(</span><span class='symbol'>'*dummy*'</span><span class='lexic'>,</span>&nbsp;<span class='lexic'>&#8709;</span><span class='lexic'>,</span>&nbsp;<span class='ident'>node</span><span class='lexic'>())</span><span class='lexic'>}}</span>
<p></div>


<h3>All together</h3>


<p><div class='code'>
<span id='Z539799'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_codegen_prep</span><span class='lexic'>(</span><span id='Z539801'><span><span class='ident'>ts</span></span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;<a href='#Z538772'><span class='ident'>l0_tailrec</span></a><span class='lexic'>(</span><br>
&nbsp;&nbsp;<a href='#Z535464'><span class='ident'>l0_stmtexpr</span></a><span class='lexic'>(</span><br>
&nbsp;&nbsp;<a href='#Z531875'><span class='ident'>l0_tailcalls</span></a><span class='lexic'>(</span><br>
&nbsp;&nbsp;<a href='#Z529977'><span class='ident'>l0_seq_tidy</span></a><span class='lexic'>(</span><br>
&nbsp;&nbsp;<a href='#Z527394'><span class='ident'>l0_flatten_lets</span></a><span class='lexic'>(</span><br>
&nbsp;&nbsp;<a href='#Z525546'><span class='ident'>l0_classify_calls</span></a><span class='lexic'>(</span><br>
&nbsp;&nbsp;<a href='#Z524627'><span class='ident'>l0_classify_functions</span></a><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z539801",this)' onmouseleave='srcref_leave("Z539801",this)'><span><span class='ident'>ts</span></span></span><span class='lexic'>)))))))</span>
<p></div>




<p><div class='code'>
<span id='Z539805'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_lowering_driver</span><span class='lexic'>(</span><span id='Z539808'><span><span class='ident'>src</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;<span id='Z539809'><span><span class='ident'>x1</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<a href='#Z539799'><span class='ident'>l0_codegen_prep</span></a><span class='lexic'>(</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href='#Z524621'><span class='ident'>l0_lexical</span></a><span class='lexic'>(</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href='#Z517221'><span class='ident'>l0_lowering</span></a><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z539808",this)' onmouseleave='srcref_leave("Z539808",this)'><span><span class='ident'>src</span></span></span><span class='lexic'>)));</span><br>
&nbsp;&nbsp;<span class='keyword'>return</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z539809",this)' onmouseleave='srcref_leave("Z539809",this)'><span><span class='ident'>x1</span></span></span>&nbsp;<br>
<span class='lexic'>}</span>
<p></div>


<p>At this point, the foldl function looks like this:



   

<p><div class='democode'>
<span class='lexic'>(</span><span class='ident'>sfunction</span>&nbsp;<span class='keyword'>foldl</span>&nbsp;<span class='lexic'>(</span><span class='ident'>Z541026</span>&nbsp;<span class='ident'>Z541027</span>&nbsp;<span class='ident'>Z541028</span><span class='lexic'>)</span>&nbsp;<br>
&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>seq</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>alloca</span>&nbsp;<span class='ident'>Z541026</span><span class='lexic'>)</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>alloca</span>&nbsp;<span class='ident'>Z541027</span><span class='lexic'>)</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>alloca</span>&nbsp;<span class='ident'>Z541028</span><span class='lexic'>)</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>set</span>&nbsp;<span class='ident'>Z541026</span>&nbsp;<span class='lexic'>(</span><span class='ident'>arg</span>&nbsp;<span class='ident'>Z541026</span><span class='lexic'>))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>set</span>&nbsp;<span class='ident'>Z541027</span>&nbsp;<span class='lexic'>(</span><span class='ident'>arg</span>&nbsp;<span class='ident'>Z541027</span><span class='lexic'>))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>set</span>&nbsp;<span class='ident'>Z541028</span>&nbsp;<span class='lexic'>(</span><span class='ident'>arg</span>&nbsp;<span class='ident'>Z541028</span><span class='lexic'>))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>goto</span>&nbsp;<span class='ident'>tailrecentry</span><span class='lexic'>)</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>label</span>&nbsp;<span class='ident'>tailrecentry</span><span class='lexic'>)</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>seq</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>alloca</span>&nbsp;<span class='ident'>Z541029</span><span class='lexic'>)</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>alloca</span>&nbsp;<span class='ident'>Z541030</span><span class='lexic'>)</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>if3</span>&nbsp;<span class='lexic'>(</span><span class='keyword'>apply</span>&nbsp;<span class='lexic'>(</span><span class='ident'>global</span>&nbsp;<span class='ident'>nullp</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>(</span><span class='ident'>local</span>&nbsp;<span class='ident'>Z541028</span><span class='lexic'>))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(return</span>&nbsp;<span class='lexic'>(</span><span class='ident'>local</span>&nbsp;<span class='ident'>Z541027</span><span class='lexic'>))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>seq</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>set</span>&nbsp;<span class='ident'>Z541029</span>&nbsp;<span class='lexic'>(</span><span class='keyword'>apply</span>&nbsp;<span class='lexic'>(</span><span class='ident'>global</span>&nbsp;<span class='ident'>head</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>(</span><span class='ident'>local</span>&nbsp;<span class='ident'>Z541028</span><span class='lexic'>)))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>set</span>&nbsp;<span class='ident'>Z541030</span>&nbsp;<span class='lexic'>(</span><span class='keyword'>apply</span>&nbsp;<span class='lexic'>(</span><span class='ident'>global</span>&nbsp;<span class='ident'>tail</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>(</span><span class='ident'>local</span>&nbsp;<span class='ident'>Z541028</span><span class='lexic'>)))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>seq</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>set</span>&nbsp;<span class='ident'>Z541026</span>&nbsp;<span class='lexic'>(</span><span class='ident'>local</span>&nbsp;<span class='ident'>Z541026</span><span class='lexic'>))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>set</span>&nbsp;<span class='ident'>Z541027</span>&nbsp;<span class='lexic'>(</span><span class='keyword'>apply</span>&nbsp;<span class='lexic'>(</span><span class='ident'>local</span>&nbsp;<span class='ident'>Z541026</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>(</span><span class='ident'>local</span>&nbsp;<span class='ident'>Z541027</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>(</span><span class='ident'>local</span>&nbsp;<span class='ident'>Z541029</span><span class='lexic'>)))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>set</span>&nbsp;<span class='ident'>Z541028</span>&nbsp;<span class='lexic'>(</span><span class='ident'>local</span>&nbsp;<span class='ident'>Z541030</span><span class='lexic'>))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>goto</span>&nbsp;<span class='ident'>tailrecentry</span><span class='lexic'>)))))))</span><br>

</div><p>




<h2 id="imperative">Code generation: an imperative IR</h2>

<p>By now our source functional language got transformed into an imperative one,
with explicitly allocated variables, destructive assignments and properly marked
tail calls. Nested lambda functions and lexical scope were eliminated. There is
already a clear separation between statements and expressions that occured
naturally during the previous passes. Goto, seq, drop, alloca, set, if, return
and tailapply are statements, while everything else is an expression.

<p>If our target was a stack machine, it would have been possible to keep an
expression-based IR all the way down.  Unfortunately, stack machines are not
quite fit for optimisations and analysis, and we're not going down the CPS route
either.

<p>In an SSA-based IR we have to *assign* results to named registers. Control
flow statements must be habdled differently from the expressions yielding
results, and for this reason we're starting this split here.

<p>It is an important compiler construction pattern that occurs even in the
languages that had distinct statements from the beginning.

<p>We can formalise this split now. The new AST <b>lang0k</b> defines everything
that returns a value as an expresssion and everything control flow as a
statement. An <b>if3</b> statement does not return anything any longer, we
ensured this by assigning its return value to a variable previously, in a
preparation phase.


<p><div class='code'>
<span class='keyword'>ast</span>&nbsp;<span class='ident'>lang0l</span>&nbsp;<span class='lexic'>:</span>&nbsp;<span class='ident'>lang0k</span>&nbsp;<span class='lexic'>()</span>&nbsp;<span class='keyword'>recform</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;<span class='ident'>top</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='ident'>define</span><span class='lexic'>(</span><span class='ident'>ident</span><span class='lexic'>:</span><span class='ident'>id</span><span class='lexic'>,</span>&nbsp;<span class='ident'>stmt</span><span class='lexic'>:</span><span class='ident'>e</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>defconst</span><span class='lexic'>(</span><span class='ident'>ident</span><span class='lexic'>:</span><span class='ident'>id</span><span class='lexic'>,</span>&nbsp;<span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>e</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>sfunction</span><span class='lexic'>(</span><span class='ident'>ident</span><span class='lexic'>:</span><span class='ident'>id</span><span class='lexic'>,</span>&nbsp;<span class='lexic'>*</span><span class='ident'>ident</span><span class='lexic'>:</span><span class='ident'>args</span><span class='lexic'>,</span>&nbsp;<span class='ident'>stmt</span><span class='lexic'>:</span><span class='ident'>body</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>closure</span><span class='lexic'>(</span><span class='ident'>ident</span><span class='lexic'>:</span><span class='ident'>id</span><span class='lexic'>,</span>&nbsp;<span class='lexic'>*</span><span class='ident'>ident</span><span class='lexic'>:</span><span class='ident'>clargs</span><span class='lexic'>,</span>&nbsp;<span class='lexic'>*</span><span class='ident'>ident</span><span class='lexic'>:</span><span class='ident'>args</span><span class='lexic'>,</span>&nbsp;<span class='ident'>stmt</span><span class='lexic'>:</span><span class='ident'>body</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>eval</span><span class='lexic'>(</span><span class='ident'>stmt</span><span class='lexic'>:</span><span class='ident'>e</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>debug</span><span class='lexic'>(.*</span><span class='ident'>any</span><span class='lexic'>:</span><span class='ident'>es</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>;</span><br>
&nbsp;&nbsp;<span class='ident'>expr</span>&nbsp;<span class='lexic'>=</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='ident'>const</span><span class='lexic'>(</span><span class='ident'>const</span><span class='lexic'>:</span><span class='ident'>c</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>global</span><span class='lexic'>(</span><span class='ident'>ident</span><span class='lexic'>:</span><span class='ident'>id</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>local</span><span class='lexic'>(</span><span class='ident'>ident</span><span class='lexic'>:</span><span class='ident'>id</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>arg</span><span class='lexic'>(</span><span class='ident'>ident</span><span class='lexic'>:</span><span class='ident'>id</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>clvar</span><span class='lexic'>(</span><span class='ident'>ident</span><span class='lexic'>:</span><span class='ident'>id</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>mkclosure</span><span class='lexic'>(</span><span class='ident'>ident</span><span class='lexic'>:</span><span class='ident'>df</span><span class='lexic'>,</span>&nbsp;<span class='lexic'>*</span><span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>args</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>funref</span><span class='lexic'>(</span><span class='ident'>ident</span><span class='lexic'>:</span><span class='ident'>id</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>apply</span><span class='lexic'>(</span><span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>fn</span><span class='lexic'>,</span>&nbsp;<span class='lexic'>.*</span><span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>args</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>splitexpr</span><span class='lexic'>(</span><span class='ident'>stmt</span><span class='lexic'>:</span><span class='ident'>l</span><span class='lexic'>,</span>&nbsp;<span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>r</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>;</span><br>
&nbsp;&nbsp;<span class='ident'>stmt</span>&nbsp;<span class='lexic'>=</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='ident'>seq</span><span class='lexic'>(.*</span><span class='ident'>stmt</span><span class='lexic'>:</span><span class='ident'>body</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>if3</span><span class='lexic'>(</span><span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>cnd</span><span class='lexic'>,</span>&nbsp;<span class='ident'>stmt</span><span class='lexic'>:</span><span class='ident'>tr</span><span class='lexic'>,</span>&nbsp;<span class='ident'>stmt</span><span class='lexic'>:</span><span class='ident'>fl</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>alloca</span><span class='lexic'>(</span><span class='ident'>ident</span><span class='lexic'>:</span><span class='ident'>id</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>set</span><span class='lexic'>(</span><span class='ident'>ident</span><span class='lexic'>:</span><span class='ident'>id</span><span class='lexic'>,</span>&nbsp;<span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>v</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>tailapply</span><span class='lexic'>(</span><span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>fn</span><span class='lexic'>,</span>&nbsp;<span class='lexic'>.*</span><span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>args</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>return</span><span class='lexic'>(</span><span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>v</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>label</span><span class='lexic'>(</span><span class='ident'>labident</span><span class='lexic'>:</span><span class='ident'>id</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>goto</span><span class='lexic'>(</span><span class='ident'>labident</span><span class='lexic'>:</span><span class='ident'>id</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>drop</span><span class='lexic'>(</span><span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>v</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>;</span><br>
<span class='lexic'>}</span>
<p></div>



The following pass dows not change the tree structure (besides renaming the
toplevel <b>expr</b> to <b>eval</b>), it merely sorts out the variants into their new
nodes.


<p><div class='code'>
<span id='Z541031'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_split_statements</span><span class='lexic'>(</span><span id='Z541553'><span><span class='ident'>ts</span></span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;<span class='keyword'>map</span>&nbsp;<span id='Z541561'><span><span class='ident'>t</span></span></span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z541553",this)' onmouseleave='srcref_leave("Z541553",this)'><span><span class='ident'>ts</span></span></span>&nbsp;<span class='keyword'>do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0k</span>&nbsp;<span class='lexic'>/rec,</span>&nbsp;<span class='lexic'>dst</span>&nbsp;<span class='ident'>lang0l</span><span class='lexic'>/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>top</span><span class='lexic'>:</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z541561",this)' onmouseleave='srcref_leave("Z541561",this)'><span><span class='ident'>t</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>top</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z541899'><span><span class='ident'>expr</span></span></span>&nbsp;&#8594;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>top</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>eval</span><span class='hint'>lang0l:top:eval(e)</span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z541899",this)' onmouseleave='srcref_leave("Z541899",this)'><span><span class='ident'>e</span></span></span><span class='hint'>expr(e)</span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='ident'>node</span><span class='lexic'>()</span><span class='lexic'>};</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>expr</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='ident'>seq</span>&nbsp;&#8594;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>stmt</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>seq</span><span class='hint'>lang0l:stmt:seq(body)</span></span><span class='lexic'>()</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>if3</span>&nbsp;&#8594;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>stmt</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>if3</span><span class='hint'>lang0l:stmt:if3(cnd,tr,fl)</span></span><span class='lexic'>()</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>alloca</span>&nbsp;&#8594;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>stmt</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>alloca</span><span class='hint'>lang0l:stmt:alloca(id)</span></span><span class='lexic'>()</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>set</span>&nbsp;&#8594;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>stmt</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>set</span><span class='hint'>lang0l:stmt:set(id,v)</span></span><span class='lexic'>()</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>tailapply</span>&nbsp;&#8594;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>stmt</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>tailapply</span><span class='hint'>lang0l:stmt:tailapply(fn,args)</span></span><span class='lexic'>()</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>return</span>&nbsp;&#8594;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>stmt</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>return</span><span class='hint'>lang0l:stmt:return(v)</span></span><span class='lexic'>()</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>label</span>&nbsp;&#8594;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>stmt</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>label</span><span class='hint'>lang0l:stmt:label(id)</span></span><span class='lexic'>()</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>goto</span>&nbsp;&#8594;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>stmt</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>goto</span><span class='hint'>lang0l:stmt:goto(id)</span></span><span class='lexic'>()</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>drop</span>&nbsp;&#8594;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>stmt</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>drop</span><span class='hint'>lang0l:stmt:drop(v)</span></span><span class='lexic'>()</span><br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='ident'>node</span><span class='lexic'>()</span><span class='lexic'>}}</span>
<p></div>


<p>After this pass we still have that <b>splitexpr</b> thing in our IR, and it
would be nice to flatten it before we go any further.


<p><div class='code'>
<span id='Z542133'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_lower_splitexpr_stmt</span><span class='lexic'>(</span><span id='Z543129'><span><span class='ident'>s</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;<span id='Z543409'><span><span class='ident'>collectsplit</span></span></span><span class='lexic'>(</span><span id='Z542803'><span><span class='ident'>s</span></span></span><span class='lexic'>,</span>&nbsp;<span id='Z543113'><span><span class='ident'>add</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>=</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0l</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>stmt</span><span class='lexic'>:</span><span class='idfrom' onmouseenter='srcref_over("Z542803",this)' onmouseleave='srcref_leave("Z542803",this)'><span><span class='ident'>s</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>expr</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z543114'><span><span class='ident'>splitexpr</span></span></span>&nbsp;&#8594;&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z543113",this)' onmouseleave='srcref_leave("Z543113",this)'><span><span class='ident'>add</span></span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z543114",this)' onmouseleave='srcref_leave("Z543114",this)'><span><span class='ident'>l</span></span></span><span class='hint'>splitexpr(l,r)</span></span><span class='lexic'>);</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>return</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z543114",this)' onmouseleave='srcref_leave("Z543114",this)'><span><span class='ident'>r</span></span></span><span class='hint'>splitexpr(l,r)</span></span><span class='lexic'>}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='ident'>node</span><span class='lexic'>()}};</span><br>
&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0l</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>stmt</span><span class='lexic'>:</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z543129",this)' onmouseleave='srcref_leave("Z543129",this)'><span><span class='ident'>s</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>stmt</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='keyword'>collector</span><span class='lexic'>(</span><span id='Z543410'><span><span class='ident'>add</span></span></span><span class='lexic'>,</span>&nbsp;<span id='Z543412'><span><span class='ident'>get</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z543417'><span><span class='ident'>nbody</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z543409",this)' onmouseleave='srcref_leave("Z543409",this)'><span><span class='ident'>collectsplit</span></span></span><span class='lexic'>(</span><span class='ident'>node</span><span class='lexic'>(),</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z543410",this)' onmouseleave='srcref_leave("Z543410",this)'><span><span class='ident'>add</span></span></span><span class='lexic'>);</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z543413'><span><span class='ident'>lifted</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z543412",this)' onmouseleave='srcref_leave("Z543412",this)'><span><span class='ident'>get</span></span></span><span class='lexic'>();</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>if</span>&nbsp;<span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z543413",this)' onmouseleave='srcref_leave("Z543413",this)'><span><span class='ident'>lifted</span></span></span><span class='lexic'>)</span>&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>seq</span><span class='hint'>lang0l:stmt:seq(body)</span></span><span class='lexic'>(</span><span class='ident'>body</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='lexic'>[@</span><span class='idfrom' onmouseenter='srcref_over("Z543413",this)' onmouseleave='srcref_leave("Z543413",this)'><span><span class='ident'>lifted</span></span></span><span class='lexic'>;</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z543417",this)' onmouseleave='srcref_leave("Z543417",this)'><span><span class='ident'>nbody</span></span></span><span class='lexic'>])</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>else</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z543417",this)' onmouseleave='srcref_leave("Z543417",this)'><span><span class='ident'>nbody</span></span></span><span class='lexic'>}}}}</span>
<p></div>



<p><div class='code'>
<span id='Z543600'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_lower_splitexprs</span><span class='lexic'>(</span><span id='Z544053'><span><span class='ident'>ts</span></span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;<span class='keyword'>map</span>&nbsp;<span id='Z544061'><span><span class='ident'>t</span></span></span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z544053",this)' onmouseleave='srcref_leave("Z544053",this)'><span><span class='ident'>ts</span></span></span>&nbsp;<span class='keyword'>do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0l</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>top</span><span class='lexic'>:</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z544061",this)' onmouseleave='srcref_leave("Z544061",this)'><span><span class='ident'>t</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>once</span>&nbsp;<span class='ident'>stmt</span>&nbsp;<span class='lexic'>{</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<a href='#Z542133'><span class='ident'>l0_lower_splitexpr_stmt</span></a><span class='lexic'>(</span><span class='ident'>node</span><span class='lexic'>())</span><span class='lexic'>}}</span>
<p></div>


<h3>Flat IR</h3>

<p>With a clean and simple low level imperative IR we can now turn to all the
different set of compiler construction tools. First we'll lower this IR into an
SSA form and apply all the standard SSA-based torture techniques to it.

<p>The first step in flattening will produce almost the same IR, with all the
complex expressions broken down to register assignments. We could have used
local variable assignments here, but since we're going into an SSA soon anyway
it does not matter if "registers" are introduced a bit earlier.

<p>Note this <b>lock</b> node here - it is merely an optimisation, to ensure the
visitor is not going into an already flattened code.


<p><div class='code'>
<span class='keyword'>ast</span>&nbsp;<span class='ident'>lang0flat0</span>&nbsp;<span class='lexic'>:</span>&nbsp;<span class='ident'>lang0l</span>&nbsp;<span class='lexic'>()</span>&nbsp;<span class='keyword'>recform</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;<span class='ident'>stmt</span>&nbsp;<span class='lexic'>+=</span>&nbsp;<span class='ident'>def</span><span class='lexic'>(</span><span class='ident'>ident</span><span class='lexic'>:</span><span class='ident'>id</span><span class='lexic'>,</span>&nbsp;<span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>v</span><span class='lexic'>);</span><br>
&nbsp;&nbsp;<span class='ident'>expr</span>&nbsp;<span class='lexic'>+=</span>&nbsp;<span class='ident'>reg</span><span class='lexic'>(</span><span class='ident'>ident</span><span class='lexic'>:</span><span class='ident'>id</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;&nbsp;<span class='ident'>load</span><span class='lexic'>(</span><span class='ident'>ident</span><span class='lexic'>:</span><span class='ident'>id</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;&nbsp;<span class='ident'>lock</span><span class='lexic'>(</span><span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>e</span><span class='lexic'>);}</span>
<p></div>


<h3>Expresison flattening</h3>

<p>Getting ready to descend to SSA. This involves adding explicit load and store
instructions for the local stack--allocated variables, so we'll lift local
references alongside with compound expressions here.


<p><div class='code'>
<span id='Z544583'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_flatten_stmt</span><span class='lexic'>(</span><span id='Z548723'><span><span class='ident'>s</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;<span id='Z547953'><span><span class='ident'>liftexpr</span></span></span><span class='lexic'>(</span><span id='Z546823'><span><span class='ident'>e</span></span></span><span class='lexic'>,</span>&nbsp;<span id='Z547146'><span><span class='ident'>add</span></span></span><span class='lexic'>,</span>&nbsp;<span id='Z547155'><span><span class='ident'>loop</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>=</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0flat0</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>expr</span><span class='lexic'>:</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z546823",this)' onmouseleave='srcref_leave("Z546823",this)'><span><span class='ident'>e</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>once</span>&nbsp;<span class='ident'>expr</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='ident'>const</span>&nbsp;&#8594;&nbsp;<span class='ident'>node</span><span class='lexic'>()</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>global</span>&nbsp;&#8594;&nbsp;<span class='ident'>node</span><span class='lexic'>()</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>arg</span>&nbsp;&#8594;&nbsp;<span class='ident'>node</span><span class='lexic'>()</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>clvar</span>&nbsp;&#8594;&nbsp;<span class='ident'>node</span><span class='lexic'>()</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>funref</span>&nbsp;&#8594;&nbsp;<span class='ident'>node</span><span class='lexic'>()</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span id='Z547195'><span><span class='ident'>local</span></span></span>&nbsp;&#8594;&nbsp;<span class='keyword'>symbols</span><span class='lexic'>(</span><span id='Z547188'><span><span class='ident'>newid</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z547146",this)' onmouseleave='srcref_leave("Z547146",this)'><span><span class='ident'>add</span></span></span><span class='lexic'>(</span><span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>stmt</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>def</span><span class='hint'>lang0flat0:stmt:def(id,v)</span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z547188",this)' onmouseleave='srcref_leave("Z547188",this)'><span><span class='ident'>newid</span></span></span><span class='lexic'>,</span>&nbsp;<span class='ident'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>lock</span><span class='hint'>lang0flat0:expr:lock(e)</span></span><span class='lexic'>(</span><span class='ident'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>load</span><span class='hint'>lang0flat0:expr:load(id)</span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z547195",this)' onmouseleave='srcref_leave("Z547195",this)'><span><span class='ident'>id</span></span></span><span class='hint'>local(id)</span></span><span class='lexic'>))));</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>return</span>&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>reg</span><span class='hint'>lang0flat0:expr:reg(id)</span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z547188",this)' onmouseleave='srcref_leave("Z547188",this)'><span><span class='ident'>newid</span></span></span><span class='lexic'>)}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='keyword'>symbols</span><span class='lexic'>(</span><span id='Z547151'><span><span class='ident'>newid</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z547146",this)' onmouseleave='srcref_leave("Z547146",this)'><span><span class='ident'>add</span></span></span><span class='lexic'>(</span><span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>stmt</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>def</span><span class='hint'>lang0flat0:stmt:def(id,v)</span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z547151",this)' onmouseleave='srcref_leave("Z547151",this)'><span><span class='ident'>newid</span></span></span><span class='lexic'>,</span>&nbsp;<span class='ident'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>lock</span><span class='hint'>lang0flat0:expr:lock(e)</span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z547155",this)' onmouseleave='srcref_leave("Z547155",this)'><span><span class='ident'>loop</span></span></span><span class='lexic'>(</span><span class='ident'>node</span><span class='lexic'>()))));</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>return</span>&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>reg</span><span class='hint'>lang0flat0:expr:reg(id)</span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z547151",this)' onmouseleave='srcref_leave("Z547151",this)'><span><span class='ident'>newid</span></span></span><span class='lexic'>)}}};</span><br>
&nbsp;&nbsp;<span class='comment'>//&nbsp;Skip&nbsp;the&nbsp;topmost&nbsp;expression&nbsp;and&nbsp;lift&nbsp;subexpressions&nbsp;only<br>
</span>&nbsp;&nbsp;<span id='Z548666'><span><span class='ident'>doexpr</span></span></span><span class='lexic'>(</span><span id='Z548006'><span><span class='ident'>e</span></span></span><span class='lexic'>,</span>&nbsp;<span id='Z547954'><span><span class='ident'>add</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='keyword'>do</span>&nbsp;<span id='Z547955'><span><span class='ident'>loop</span></span></span><span class='lexic'>(</span><span id='Z547273'><span><span class='ident'>e</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z548006",this)' onmouseleave='srcref_leave("Z548006",this)'><span><span class='ident'>e</span></span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0flat0</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>topexpr</span><span class='lexic'>:</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z547273",this)' onmouseleave='srcref_leave("Z547273",this)'><span><span class='ident'>e</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='ident'>topexpr</span>&nbsp;<span class='keyword'>as</span>&nbsp;<span class='ident'>expr</span>&nbsp;<span class='lexic'>{</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='ident'>node</span><span class='lexic'>()</span>&nbsp;<span class='lexic'>};</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>once</span>&nbsp;<span class='ident'>expr</span>&nbsp;<span class='lexic'>{</span>&nbsp;<span class='ident'>lock</span>&nbsp;&#8594;&nbsp;<span class='ident'>node</span><span class='lexic'>()</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z547953",this)' onmouseleave='srcref_leave("Z547953",this)'><span><span class='ident'>liftexpr</span></span></span><span class='lexic'>(</span><span class='ident'>node</span><span class='lexic'>(),</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z547954",this)' onmouseleave='srcref_leave("Z547954",this)'><span><span class='ident'>add</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z547955",this)' onmouseleave='srcref_leave("Z547955",this)'><span><span class='ident'>loop</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>}}</span><span class='lexic'>;</span><br>
&nbsp;&nbsp;<span class='comment'>//&nbsp;Skip&nbsp;the&nbsp;topmost&nbsp;statements&nbsp;and&nbsp;process&nbsp;statements&nbsp;one&nbsp;level&nbsp;down<br>
</span>&nbsp;&nbsp;<span id='Z549003'><span><span class='ident'>dostmt</span></span></span><span class='lexic'>(</span><span id='Z548016'><span><span class='ident'>s</span></span></span><span class='lexic'>,</span>&nbsp;<span id='Z548664'><span><span class='ident'>add</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>=</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0flat0</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>topstmt</span><span class='lexic'>:</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z548016",this)' onmouseleave='srcref_leave("Z548016",this)'><span><span class='ident'>s</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='ident'>topstmt</span>&nbsp;<span class='keyword'>as</span>&nbsp;<span class='ident'>stmt</span>&nbsp;<span class='lexic'>{</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='ident'>node</span><span class='lexic'>()</span>&nbsp;<span class='lexic'>};</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>once</span>&nbsp;<span class='ident'>stmt</span>&nbsp;<span class='lexic'>{</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='ident'>node</span><span class='lexic'>()</span>&nbsp;<span class='lexic'>};</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>once</span>&nbsp;<span class='ident'>expr</span>&nbsp;<span class='lexic'>{</span>&nbsp;<span class='ident'>lock</span>&nbsp;&#8594;&nbsp;<span class='ident'>node</span><span class='lexic'>()</span>&nbsp;<span class='lexic'>|</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z547953",this)' onmouseleave='srcref_leave("Z547953",this)'><span><span class='ident'>liftexpr</span></span></span><span class='lexic'>(</span><span class='ident'>node</span><span class='lexic'>(),</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z548664",this)' onmouseleave='srcref_leave("Z548664",this)'><span><span class='ident'>add</span></span></span><span class='lexic'>,</span>&nbsp;<span class='keyword'>&lambda;</span><span class='lexic'>(</span><span id='Z548667'><span><span class='ident'>e</span></span></span><span class='lexic'>)</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z548666",this)' onmouseleave='srcref_leave("Z548666",this)'><span><span class='ident'>doexpr</span></span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z548667",this)' onmouseleave='srcref_leave("Z548667",this)'><span><span class='ident'>e</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z548664",this)' onmouseleave='srcref_leave("Z548664",this)'><span><span class='ident'>add</span></span></span><span class='lexic'>)</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>}};</span><br>
&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0l</span>&nbsp;<span class='lexic'>/rec,</span>&nbsp;<span class='lexic'>dst</span>&nbsp;<span class='ident'>lang0flat0</span><span class='lexic'>/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>stmt</span><span class='lexic'>:</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z548723",this)' onmouseleave='srcref_leave("Z548723",this)'><span><span class='ident'>s</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>stmt</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='keyword'>collector</span><span class='lexic'>(</span><span id='Z549004'><span><span class='ident'>add</span></span></span><span class='lexic'>,</span>&nbsp;<span id='Z549006'><span><span class='ident'>get</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z549011'><span><span class='ident'>ret</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z549003",this)' onmouseleave='srcref_leave("Z549003",this)'><span><span class='ident'>dostmt</span></span></span><span class='lexic'>(</span><span class='ident'>node</span><span class='lexic'>(),</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z549004",this)' onmouseleave='srcref_leave("Z549004",this)'><span><span class='ident'>add</span></span></span><span class='lexic'>);</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z549007'><span><span class='ident'>lifted</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z549006",this)' onmouseleave='srcref_leave("Z549006",this)'><span><span class='ident'>get</span></span></span><span class='lexic'>();</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>if</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z549007",this)' onmouseleave='srcref_leave("Z549007",this)'><span><span class='ident'>lifted</span></span></span><span class='lexic'>)</span>&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>seq</span><span class='hint'>lang0flat0:stmt:seq(body)</span></span><span class='lexic'>(</span><span class='ident'>body</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='lexic'>[@</span><span class='idfrom' onmouseenter='srcref_over("Z549007",this)' onmouseleave='srcref_leave("Z549007",this)'><span><span class='ident'>lifted</span></span></span><span class='lexic'>;</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z549011",this)' onmouseleave='srcref_leave("Z549011",this)'><span><span class='ident'>ret</span></span></span><span class='lexic'>])</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>else</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z549011",this)' onmouseleave='srcref_leave("Z549011",this)'><span><span class='ident'>ret</span></span></span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>}}}}</span>
<p></div>


<p>The <b>lock</b> nodes introduced were temporary and must be eliminated now:


<p><div class='code'>
<span id='Z549460'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_flatten_unlock</span><span class='lexic'>(</span><span id='Z549846'><span><span class='ident'>s</span></span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0flat0</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>stmt</span><span class='lexic'>:</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z549846",this)' onmouseleave='srcref_leave("Z549846",this)'><span><span class='ident'>s</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>expr</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z550213'><span><span class='ident'>lock</span></span></span>&nbsp;&#8594;&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z550213",this)' onmouseleave='srcref_leave("Z550213",this)'><span><span class='ident'>e</span></span></span><span class='hint'>lock(e)</span></span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='ident'>node</span><span class='lexic'>()</span><span class='lexic'>}}</span>
<p></div>



<p><div class='code'>
<span id='Z550294'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_flatten</span><span class='lexic'>(</span><span id='Z550747'><span><span class='ident'>ts</span></span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;<span class='keyword'>map</span>&nbsp;<span id='Z550755'><span><span class='ident'>t</span></span></span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z550747",this)' onmouseleave='srcref_leave("Z550747",this)'><span><span class='ident'>ts</span></span></span>&nbsp;<span class='keyword'>do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0l</span>&nbsp;<span class='lexic'>/rec,</span>&nbsp;<span class='lexic'>dst</span>&nbsp;<span class='ident'>lang0flat0</span><span class='lexic'>/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>top</span><span class='lexic'>:</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z550755",this)' onmouseleave='srcref_leave("Z550755",this)'><span><span class='ident'>t</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>once</span>&nbsp;<span class='ident'>stmt</span>&nbsp;<span class='lexic'>{</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href='#Z549460'><span class='ident'>l0_flatten_unlock</span></a><span class='lexic'>(</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href='#Z544583'><span class='ident'>l0_flatten_stmt</span></a><span class='lexic'>(</span><span class='ident'>node</span><span class='lexic'>()))</span>&nbsp;<span class='lexic'>}}</span>
<p></div>



<h3>Statement flattening</h3>

<p>Now we can get rid of the compound statements, replacing them with a
<b>goto</b> and labels. At the moment we only have one kind of a compound
statement - an <b>if</b>.


<p><div class='code'>
<span class='keyword'>ast</span>&nbsp;<span class='ident'>lang0flat1</span>&nbsp;<span class='lexic'>:</span>&nbsp;<span class='ident'>lang0flat0</span>&nbsp;<span class='lexic'>()</span>&nbsp;<span class='keyword'>recform</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;<span class='ident'>stmt</span>&nbsp;<span class='lexic'>+=</span>&nbsp;<span class='ident'>gotoc</span><span class='lexic'>(</span><span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>cnd</span><span class='lexic'>,</span>&nbsp;<span class='ident'>labident</span><span class='lexic'>:</span><span class='ident'>tr</span><span class='lexic'>,</span>&nbsp;<span class='ident'>labident</span><span class='lexic'>:</span><span class='ident'>fl</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='lexic'>-</span><span class='ident'>if3</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>;</span><br>
&nbsp;&nbsp;<span class='ident'>expr</span>&nbsp;<span class='lexic'>+=</span>&nbsp;<span class='lexic'>-</span><span class='ident'>lock</span><span class='lexic'>;</span><br>
&nbsp;&nbsp;<span class='ident'>hint</span>&nbsp;<span class='ident'>stmt</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='ident'>newline</span><span class='lexic'>;</span><br>
&nbsp;&nbsp;<span class='lexic'>}</span>
<p></div>



<p><div class='code'>
<span id='Z551277'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_flatten_cfg_stmt</span><span class='lexic'>(</span><span id='Z551726'><span><span class='ident'>s</span></span></span><span class='lexic'>)</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0flat0</span>&nbsp;<span class='lexic'>/rec,</span>&nbsp;<span class='lexic'>dst</span>&nbsp;<span class='ident'>lang0flat1</span><span class='lexic'>/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>stmt</span><span class='lexic'>:</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z551726",this)' onmouseleave='srcref_leave("Z551726",this)'><span><span class='ident'>s</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>stmt</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z552071'><span><span class='ident'>if3</span></span></span>&nbsp;&#8594;&nbsp;<span class='keyword'>symbols</span><span class='lexic'>(</span><span id='Z552074'><span><span class='ident'>ltr</span></span></span><span class='lexic'>,</span>&nbsp;<span id='Z552075'><span><span class='ident'>lfl</span></span></span><span class='lexic'>,</span>&nbsp;<span id='Z552094'><span><span class='ident'>lnext</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>seq</span><span class='hint'>lang0flat1:stmt:seq(body)</span></span><span class='lexic'>(</span><span class='ident'>body</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='lexic'>[</span><span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>gotoc</span><span class='hint'>lang0flat1:stmt:gotoc(cnd,tr,fl)</span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z552071",this)' onmouseleave='srcref_leave("Z552071",this)'><span><span class='ident'>cnd</span></span></span><span class='hint'>if3(cnd,tr,fl)</span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z552074",this)' onmouseleave='srcref_leave("Z552074",this)'><span><span class='ident'>ltr</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z552075",this)' onmouseleave='srcref_leave("Z552075",this)'><span><span class='ident'>lfl</span></span></span><span class='lexic'>);</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>label</span><span class='hint'>lang0flat1:stmt:label(id)</span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z552074",this)' onmouseleave='srcref_leave("Z552074",this)'><span><span class='ident'>ltr</span></span></span><span class='lexic'>);</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z552071",this)' onmouseleave='srcref_leave("Z552071",this)'><span><span class='ident'>tr</span></span></span><span class='hint'>if3(cnd,tr,fl)</span></span><span class='lexic'>;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>goto</span><span class='hint'>lang0flat1:stmt:goto(id)</span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z552094",this)' onmouseleave='srcref_leave("Z552094",this)'><span><span class='ident'>lnext</span></span></span><span class='lexic'>);</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>label</span><span class='hint'>lang0flat1:stmt:label(id)</span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z552075",this)' onmouseleave='srcref_leave("Z552075",this)'><span><span class='ident'>lfl</span></span></span><span class='lexic'>);</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z552071",this)' onmouseleave='srcref_leave("Z552071",this)'><span><span class='ident'>fl</span></span></span><span class='hint'>if3(cnd,tr,fl)</span></span><span class='lexic'>;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>goto</span><span class='hint'>lang0flat1:stmt:goto(id)</span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z552094",this)' onmouseleave='srcref_leave("Z552094",this)'><span><span class='ident'>lnext</span></span></span><span class='lexic'>);</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>label</span><span class='hint'>lang0flat1:stmt:label(id)</span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z552094",this)' onmouseleave='srcref_leave("Z552094",this)'><span><span class='ident'>lnext</span></span></span><span class='lexic'>)])}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='ident'>node</span><span class='lexic'>()</span><span class='lexic'>}}</span>
<p></div>


<p>The previous passes could produce nested <b>seq</b> blocks. Since this is the
only compound statement left by now we can just flatten everything into a single
topmost sequence.


<p><div class='code'>
<span id='Z552242'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_flatten_seq</span><span class='lexic'>(</span><span id='Z552634'><span><span class='ident'>s</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;<span id='Z553012'><span><span class='ident'>seq</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0flat1</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>stmt</span><span class='lexic'>:</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z552634",this)' onmouseleave='srcref_leave("Z552634",this)'><span><span class='ident'>s</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>stmt</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z552955'><span><span class='ident'>seq</span></span></span>&nbsp;&#8594;&nbsp;<span class='keyword'>map</span>&nbsp;<span class='keyword'>append</span>&nbsp;<span id='Z552960'><span><span class='ident'>b</span></span></span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z552955",this)' onmouseleave='srcref_leave("Z552955",this)'><span><span class='ident'>body</span></span></span><span class='hint'>seq(body)</span></span>&nbsp;<span class='keyword'>do</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z552960",this)' onmouseleave='srcref_leave("Z552960",this)'><span><span class='ident'>b</span></span></span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='lexic'>[</span><span class='ident'>node</span><span class='lexic'>()]}};</span><br>
&nbsp;&nbsp;&nbsp;<span class='keyword'>with</span>&nbsp;<span class='keyword'>target</span>&nbsp;<span class='lexic'>(</span><span class='ident'>lang0flat1</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>stmt</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>seq</span><span class='hint'>lang0flat1:stmt:seq(body)</span></span><span class='lexic'>(</span><span class='ident'>body</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z553012",this)' onmouseleave='srcref_leave("Z553012",this)'><span><span class='ident'>seq</span></span></span><span class='lexic'>)}}</span>
<p></div>



<p><div class='code'>
<span id='Z553093'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_flatten_cfg</span><span class='lexic'>(</span><span id='Z553602'><span><span class='ident'>ts</span></span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;<span class='keyword'>map</span>&nbsp;<span id='Z553610'><span><span class='ident'>t</span></span></span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z553602",this)' onmouseleave='srcref_leave("Z553602",this)'><span><span class='ident'>ts</span></span></span>&nbsp;<span class='keyword'>do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0flat0</span>&nbsp;<span class='lexic'>/rec,</span>&nbsp;<span class='lexic'>dst</span>&nbsp;<span class='ident'>lang0flat1</span><span class='lexic'>/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>top</span><span class='lexic'>:</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z553610",this)' onmouseleave='srcref_leave("Z553610",this)'><span><span class='ident'>t</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>once</span>&nbsp;<span class='ident'>stmt</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<a href='#Z552242'><span class='ident'>l0_flatten_seq</span></a><span class='lexic'>(</span><a href='#Z551277'><span class='ident'>l0_flatten_cfg_stmt</span></a><span class='lexic'>(</span><span class='ident'>node</span><span class='lexic'>()))</span><span class='lexic'>}}</span>
<p></div>



<p><div class='code'>
<span id='Z554197'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_flatten_driver</span><span class='lexic'>(</span><span id='Z554200'><span><span class='ident'>src</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;<span id='Z554202'><span><span class='ident'>x1</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<a href='#Z539805'><span class='ident'>l0_lowering_driver</span></a><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z554200",this)' onmouseleave='srcref_leave("Z554200",this)'><span><span class='ident'>src</span></span></span><span class='lexic'>);</span><br>
&nbsp;&nbsp;<span id='Z554204'><span><span class='ident'>x2</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<a href='#Z543600'><span class='ident'>l0_lower_splitexprs</span></a><span class='lexic'>(</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href='#Z541031'><span class='ident'>l0_split_statements</span></a><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z554202",this)' onmouseleave='srcref_leave("Z554202",this)'><span><span class='ident'>x1</span></span></span><span class='lexic'>));</span><br>
&nbsp;&nbsp;<span id='Z554205'><span><span class='ident'>x3</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<a href='#Z553093'><span class='ident'>l0_flatten_cfg</span></a><span class='lexic'>(</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href='#Z550294'><span class='ident'>l0_flatten</span></a><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z554204",this)' onmouseleave='srcref_leave("Z554204",this)'><span><span class='ident'>x2</span></span></span><span class='lexic'>));</span><br>
&nbsp;&nbsp;<span class='keyword'>return</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z554205",this)' onmouseleave='srcref_leave("Z554205",this)'><span><span class='ident'>x3</span></span></span><br>
<span class='lexic'>}</span>
<p></div>


<p>And our sample <b>foldl</b> function looks like this after flattening:



   

<p><div class='democode'>
<span class='lexic'>(</span><span class='ident'>sfunction</span>&nbsp;<span class='keyword'>foldl</span>&nbsp;<span class='lexic'>(</span><span class='ident'>Z555561</span>&nbsp;<span class='ident'>Z555562</span>&nbsp;<span class='ident'>Z555563</span><span class='lexic'>)</span>&nbsp;<br>
&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>seq</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>alloca</span>&nbsp;<span class='ident'>Z555561</span><span class='lexic'>)</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>alloca</span>&nbsp;<span class='ident'>Z555562</span><span class='lexic'>)</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>alloca</span>&nbsp;<span class='ident'>Z555563</span><span class='lexic'>)</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>set</span>&nbsp;<span class='ident'>Z555561</span>&nbsp;<span class='lexic'>(</span><span class='ident'>arg</span>&nbsp;<span class='ident'>Z555561</span><span class='lexic'>))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>set</span>&nbsp;<span class='ident'>Z555562</span>&nbsp;<span class='lexic'>(</span><span class='ident'>arg</span>&nbsp;<span class='ident'>Z555562</span><span class='lexic'>))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>set</span>&nbsp;<span class='ident'>Z555563</span>&nbsp;<span class='lexic'>(</span><span class='ident'>arg</span>&nbsp;<span class='ident'>Z555563</span><span class='lexic'>))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>goto</span>&nbsp;<span class='ident'>tailrecentry</span><span class='lexic'>)</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>label</span>&nbsp;<span class='ident'>tailrecentry</span><span class='lexic'>)</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>alloca</span>&nbsp;<span class='ident'>Z555564</span><span class='lexic'>)</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>alloca</span>&nbsp;<span class='ident'>Z555565</span><span class='lexic'>)</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>def</span>&nbsp;<span class='ident'>Z555578</span>&nbsp;<span class='lexic'>(</span><span class='ident'>load</span>&nbsp;<span class='ident'>Z555563</span><span class='lexic'>))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>def</span>&nbsp;<span class='ident'>Z555577</span>&nbsp;<span class='lexic'>(</span><span class='keyword'>apply</span>&nbsp;<span class='lexic'>(</span><span class='ident'>global</span>&nbsp;<span class='ident'>nullp</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>(</span><span class='ident'>reg</span>&nbsp;<span class='ident'>Z555578</span><span class='lexic'>)))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>gotoc</span>&nbsp;<span class='lexic'>(</span><span class='ident'>reg</span>&nbsp;<span class='ident'>Z555577</span><span class='lexic'>)</span>&nbsp;<span class='ident'>Z555579</span>&nbsp;<span class='ident'>Z555580</span><span class='lexic'>)</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>label</span>&nbsp;<span class='ident'>Z555579</span><span class='lexic'>)</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>def</span>&nbsp;<span class='ident'>Z555566</span>&nbsp;<span class='lexic'>(</span><span class='ident'>load</span>&nbsp;<span class='ident'>Z555562</span><span class='lexic'>))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(return</span>&nbsp;<span class='lexic'>(</span><span class='ident'>reg</span>&nbsp;<span class='ident'>Z555566</span><span class='lexic'>))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>goto</span>&nbsp;<span class='ident'>Z555581</span><span class='lexic'>)</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>label</span>&nbsp;<span class='ident'>Z555580</span><span class='lexic'>)</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>def</span>&nbsp;<span class='ident'>Z555568</span>&nbsp;<span class='lexic'>(</span><span class='ident'>load</span>&nbsp;<span class='ident'>Z555563</span><span class='lexic'>))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>def</span>&nbsp;<span class='ident'>Z555567</span>&nbsp;<span class='lexic'>(</span><span class='keyword'>apply</span>&nbsp;<span class='lexic'>(</span><span class='ident'>global</span>&nbsp;<span class='ident'>head</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>(</span><span class='ident'>reg</span>&nbsp;<span class='ident'>Z555568</span><span class='lexic'>)))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>set</span>&nbsp;<span class='ident'>Z555564</span>&nbsp;<span class='lexic'>(</span><span class='ident'>reg</span>&nbsp;<span class='ident'>Z555567</span><span class='lexic'>))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>def</span>&nbsp;<span class='ident'>Z555570</span>&nbsp;<span class='lexic'>(</span><span class='ident'>load</span>&nbsp;<span class='ident'>Z555563</span><span class='lexic'>))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>def</span>&nbsp;<span class='ident'>Z555569</span>&nbsp;<span class='lexic'>(</span><span class='keyword'>apply</span>&nbsp;<span class='lexic'>(</span><span class='ident'>global</span>&nbsp;<span class='ident'>tail</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>(</span><span class='ident'>reg</span>&nbsp;<span class='ident'>Z555570</span><span class='lexic'>)))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>set</span>&nbsp;<span class='ident'>Z555565</span>&nbsp;<span class='lexic'>(</span><span class='ident'>reg</span>&nbsp;<span class='ident'>Z555569</span><span class='lexic'>))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>def</span>&nbsp;<span class='ident'>Z555571</span>&nbsp;<span class='lexic'>(</span><span class='ident'>load</span>&nbsp;<span class='ident'>Z555561</span><span class='lexic'>))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>set</span>&nbsp;<span class='ident'>Z555561</span>&nbsp;<span class='lexic'>(</span><span class='ident'>reg</span>&nbsp;<span class='ident'>Z555571</span><span class='lexic'>))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>def</span>&nbsp;<span class='ident'>Z555573</span>&nbsp;<span class='lexic'>(</span><span class='ident'>load</span>&nbsp;<span class='ident'>Z555561</span><span class='lexic'>))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>def</span>&nbsp;<span class='ident'>Z555574</span>&nbsp;<span class='lexic'>(</span><span class='ident'>load</span>&nbsp;<span class='ident'>Z555562</span><span class='lexic'>))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>def</span>&nbsp;<span class='ident'>Z555575</span>&nbsp;<span class='lexic'>(</span><span class='ident'>load</span>&nbsp;<span class='ident'>Z555564</span><span class='lexic'>))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>def</span>&nbsp;<span class='ident'>Z555572</span>&nbsp;<span class='lexic'>(</span><span class='keyword'>apply</span>&nbsp;<span class='lexic'>(</span><span class='ident'>reg</span>&nbsp;<span class='ident'>Z555573</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>(</span><span class='ident'>reg</span>&nbsp;<span class='ident'>Z555574</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>(</span><span class='ident'>reg</span>&nbsp;<span class='ident'>Z555575</span><span class='lexic'>)))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>set</span>&nbsp;<span class='ident'>Z555562</span>&nbsp;<span class='lexic'>(</span><span class='ident'>reg</span>&nbsp;<span class='ident'>Z555572</span><span class='lexic'>))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>def</span>&nbsp;<span class='ident'>Z555576</span>&nbsp;<span class='lexic'>(</span><span class='ident'>load</span>&nbsp;<span class='ident'>Z555565</span><span class='lexic'>))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>set</span>&nbsp;<span class='ident'>Z555563</span>&nbsp;<span class='lexic'>(</span><span class='ident'>reg</span>&nbsp;<span class='ident'>Z555576</span><span class='lexic'>))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>goto</span>&nbsp;<span class='ident'>tailrecentry</span><span class='lexic'>)</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>goto</span>&nbsp;<span class='ident'>Z555581</span><span class='lexic'>)</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>label</span>&nbsp;<span class='ident'>Z555581</span><span class='lexic'>)))</span><br>

</div><p>


<h3 id="ssa">Basic blocks</h3>

<p>Now everything is perfectly flat, so we can sort instructions into basic
blocks. Also it's a right moment to do another node split - separate compound
expressions and leaf values, it will help to enforce the SSA guarantee of not
reassigning simple values (with the only exception of the $\varphi$ nodes, but
this will be sorted out later).

<p>Note that <b>tailapply</b> is gone now as it served its purpose already,
replaced with an <b>expr</b> node - it will be useful later when we have to
annotate calls.

<p>This will be our main IR quite for a while now.


<p><div class='code'>
<span class='keyword'>ast</span>&nbsp;<span class='ident'>lang0flat2</span>&nbsp;<span class='lexic'>:</span>&nbsp;<span class='ident'>lang0flat1</span>&nbsp;<span class='lexic'>(</span><span class='ident'>stmt</span>&nbsp;&#8594;&nbsp;<span class='ident'>insn</span><span class='lexic'>)</span>&nbsp;<span class='keyword'>recform</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;<span class='ident'>top</span>&nbsp;<span class='lexic'>=</span>&nbsp;&nbsp;&nbsp;<span class='ident'>define</span><span class='lexic'>(</span><span class='ident'>ident</span><span class='lexic'>:</span><span class='ident'>id</span><span class='lexic'>,</span>&nbsp;<span class='ident'>code</span><span class='lexic'>:</span><span class='ident'>e</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>defconst</span><span class='lexic'>(</span><span class='ident'>ident</span><span class='lexic'>:</span><span class='ident'>id</span><span class='lexic'>,</span>&nbsp;<span class='ident'>value</span><span class='lexic'>:</span><span class='ident'>e</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>sfunction</span><span class='lexic'>(</span><span class='ident'>ident</span><span class='lexic'>:</span><span class='ident'>id</span><span class='lexic'>,</span>&nbsp;<span class='lexic'>*</span><span class='ident'>ident</span><span class='lexic'>:</span><span class='ident'>args</span><span class='lexic'>,</span>&nbsp;<span class='ident'>code</span><span class='lexic'>:</span><span class='ident'>body</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>closure</span><span class='lexic'>(</span><span class='ident'>ident</span><span class='lexic'>:</span><span class='ident'>id</span><span class='lexic'>,</span>&nbsp;<span class='lexic'>*</span><span class='ident'>ident</span><span class='lexic'>:</span><span class='ident'>clargs</span><span class='lexic'>,</span>&nbsp;<span class='lexic'>*</span><span class='ident'>ident</span><span class='lexic'>:</span><span class='ident'>args</span><span class='lexic'>,</span>&nbsp;<span class='ident'>code</span><span class='lexic'>:</span><span class='ident'>body</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>eval</span><span class='lexic'>(</span><span class='ident'>code</span><span class='lexic'>:</span><span class='ident'>e</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>debug</span><span class='lexic'>(.*</span><span class='ident'>any</span><span class='lexic'>:</span><span class='ident'>es</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>;</span><br>
&nbsp;&nbsp;<span class='ident'>code</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='ident'>c</span><span class='lexic'>(.*</span><span class='ident'>bblock</span><span class='lexic'>:</span><span class='ident'>bs</span><span class='lexic'>);</span><br>
&nbsp;&nbsp;<span class='ident'>bblock</span>&nbsp;<span class='lexic'>=</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='ident'>bb</span><span class='lexic'>(</span><span class='ident'>labident</span><span class='lexic'>:</span><span class='ident'>lbl</span><span class='lexic'>,</span>&nbsp;<span class='lexic'>*</span><span class='ident'>insn</span><span class='lexic'>:</span><span class='ident'>body</span><span class='lexic'>,</span>&nbsp;<span class='ident'>term</span><span class='lexic'>:</span><span class='ident'>t</span><span class='lexic'>);</span><br>
&nbsp;&nbsp;<span class='ident'>value</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='ident'>const</span><span class='lexic'>(</span><span class='ident'>const</span><span class='lexic'>:</span><span class='ident'>c</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>global</span><span class='lexic'>(</span><span class='ident'>ident</span><span class='lexic'>:</span><span class='ident'>id</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>arg</span><span class='lexic'>(</span><span class='ident'>ident</span><span class='lexic'>:</span><span class='ident'>id</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>clvar</span><span class='lexic'>(</span><span class='ident'>ident</span><span class='lexic'>:</span><span class='ident'>id</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>reg</span><span class='lexic'>(</span><span class='ident'>ident</span><span class='lexic'>:</span><span class='ident'>id</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>funref</span><span class='lexic'>(</span><span class='ident'>ident</span><span class='lexic'>:</span><span class='ident'>id</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>;</span><br>
&nbsp;&nbsp;<span class='ident'>expr</span>&nbsp;<span class='lexic'>=</span>&nbsp;&nbsp;<span class='ident'>mkclosure</span><span class='lexic'>(</span><span class='ident'>ident</span><span class='lexic'>:</span><span class='ident'>df</span><span class='lexic'>,</span>&nbsp;<span class='lexic'>*</span><span class='ident'>value</span><span class='lexic'>:</span><span class='ident'>args</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>apply</span><span class='lexic'>(</span><span class='ident'>bool</span><span class='lexic'>:</span><span class='ident'>purep</span><span class='lexic'>,</span>&nbsp;<span class='ident'>value</span><span class='lexic'>:</span><span class='ident'>fn</span><span class='lexic'>,</span>&nbsp;<span class='lexic'>.*</span><span class='ident'>value</span><span class='lexic'>:</span><span class='ident'>args</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>load</span><span class='lexic'>(</span><span class='ident'>ident</span><span class='lexic'>:</span><span class='ident'>id</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='comment'>//&nbsp;New&nbsp;nodes<br>
</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>phi</span><span class='lexic'>(.*</span><span class='ident'>phisrc</span><span class='lexic'>:</span><span class='ident'>ss</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>select</span><span class='lexic'>(</span><span class='ident'>value</span><span class='lexic'>:</span><span class='ident'>cnd</span><span class='lexic'>,</span>&nbsp;<span class='ident'>value</span><span class='lexic'>:</span><span class='ident'>tr</span><span class='lexic'>,</span>&nbsp;<span class='ident'>value</span><span class='lexic'>:</span><span class='ident'>fl</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='comment'>//&nbsp;Feedback&nbsp;only,&nbsp;not&nbsp;allowed&nbsp;for&nbsp;redefinitions<br>
</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>value</span><span class='lexic'>(</span><span class='ident'>value</span><span class='lexic'>:</span><span class='ident'>v</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>;</span><br>
&nbsp;&nbsp;<span class='ident'>phisrc</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='ident'>s</span><span class='lexic'>(</span><span class='ident'>labident</span><span class='lexic'>:</span><span class='ident'>from</span><span class='lexic'>,</span>&nbsp;<span class='ident'>value</span><span class='lexic'>:</span><span class='ident'>v</span><span class='lexic'>);</span><br>
&nbsp;&nbsp;<span class='ident'>insn</span>&nbsp;<span class='lexic'>=</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='ident'>alloca</span><span class='lexic'>(</span><span class='ident'>ident</span><span class='lexic'>:</span><span class='ident'>id</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>def</span><span class='lexic'>(</span><span class='ident'>ident</span><span class='lexic'>:</span><span class='ident'>id</span><span class='lexic'>,</span>&nbsp;<span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>v</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>set</span><span class='lexic'>(</span><span class='ident'>ident</span><span class='lexic'>:</span><span class='ident'>id</span><span class='lexic'>,</span>&nbsp;<span class='ident'>value</span><span class='lexic'>:</span><span class='ident'>v</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>;</span><br>
&nbsp;&nbsp;<span class='ident'>term</span>&nbsp;<span class='lexic'>=</span>&nbsp;&nbsp;<span class='ident'>tail</span><span class='lexic'>(</span><span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>e</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>goto</span><span class='lexic'>(</span><span class='ident'>labident</span><span class='lexic'>:</span><span class='ident'>id</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>gotoc</span><span class='lexic'>(</span><span class='ident'>value</span><span class='lexic'>:</span><span class='ident'>cnd</span><span class='lexic'>,</span>&nbsp;<span class='ident'>labident</span><span class='lexic'>:</span><span class='ident'>tr</span><span class='lexic'>,</span>&nbsp;<span class='ident'>labident</span><span class='lexic'>:</span><span class='ident'>fl</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>return</span><span class='lexic'>(</span><span class='ident'>value</span><span class='lexic'>:</span><span class='ident'>v</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>;</span><br>
&nbsp;&nbsp;<span class='ident'>hint</span>&nbsp;<span class='ident'>phisrc</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='ident'>newline</span><span class='lexic'>;</span><br>
&nbsp;&nbsp;<span class='ident'>hint</span>&nbsp;<span class='ident'>insn</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='ident'>newline</span><span class='lexic'>;</span><br>
&nbsp;&nbsp;<span class='ident'>hint</span>&nbsp;<span class='ident'>bblock</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='ident'>newline</span><span class='lexic'>;</span><br>
&nbsp;&nbsp;<span class='ident'>hint</span>&nbsp;<span class='ident'>term</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='ident'>newline</span><span class='lexic'>;</span><br>
&nbsp;&nbsp;<span class='ident'>hint</span>&nbsp;<span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>phi</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='ident'>itab</span><span class='lexic'>,</span>&nbsp;<span class='ident'>newline</span><span class='lexic'>;</span><br>
<span class='lexic'>}</span>
<p></div>



<p>First pass over a flat code is to eliminate redundancy: e.g., if there is a
sequence of labels, only one should remain (and be referred to), because a basic
block can only have one name. If a terminal instruction is following another
terminal instruction, it is unreachable and must be eliminated.

<p>Once this filtering is done, rules for accumulating instructions into basic
blocks are much simpler.


<p><div class='code'>
<span id='Z555582'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_seq_body</span><span class='lexic'>(</span><span id='Z555955'><span><span class='ident'>s</span></span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0flat1</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>stmt</span><span class='lexic'>:</span><span class='idfrom' onmouseenter='srcref_over("Z555955",this)' onmouseleave='srcref_leave("Z555955",this)'><span><span class='ident'>s</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>once</span>&nbsp;<span class='ident'>stmt</span>&nbsp;<span class='lexic'>{</span>&nbsp;<span id='Z556267'><span><span class='ident'>seq</span></span></span>&nbsp;&#8594;&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z556267",this)' onmouseleave='srcref_leave("Z556267",this)'><span><span class='ident'>body</span></span></span><span class='hint'>seq(body)</span></span>&nbsp;<span class='lexic'>|</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='withhint'><span class='ident'>ccerror</span><span class='hint'>function&nbsp;ccerror&nbsp;arg:&nbsp;<br>
Raises&nbsp;[MBaseException]&nbsp;with&nbsp;a&nbsp;given&nbsp;argument.</span></span><span class='lexic'>(</span><span class='symbol'>'IMPOSSIBLE'</span><span class='lexic'>())</span>&nbsp;<span class='lexic'>}}</span>
<p></div>



<p><div class='code'>
<span id='Z556388'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_classify_insn</span><span class='lexic'>(</span><span id='Z556761'><span><span class='ident'>i</span></span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0flat1</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>stmt</span><span class='lexic'>:</span><span class='idfrom' onmouseenter='srcref_over("Z556761",this)' onmouseleave='srcref_leave("Z556761",this)'><span><span class='ident'>i</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>once</span>&nbsp;<span class='ident'>stmt</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='ident'>tailapply</span>&nbsp;&#8594;&nbsp;<span class='symbol'>'term'</span><span class='lexic'>()</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>goto</span>&nbsp;&#8594;&nbsp;<span class='symbol'>'term'</span><span class='lexic'>()</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>gotoc</span>&nbsp;&#8594;&nbsp;<span class='symbol'>'term'</span><span class='lexic'>()</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>return</span>&nbsp;&#8594;&nbsp;<span class='symbol'>'term'</span><span class='lexic'>()</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>drop</span>&nbsp;&#8594;&nbsp;<span class='symbol'>'skip'</span><span class='lexic'>()</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span id='Z557094'><span><span class='ident'>label</span></span></span>&nbsp;&#8594;&nbsp;<span class='symbol'>'label'</span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z557094",this)' onmouseleave='srcref_leave("Z557094",this)'><span><span class='ident'>id</span></span></span><span class='hint'>label(id)</span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='symbol'>'insn'</span><span class='lexic'>()</span><span class='lexic'>}}</span>
<p></div>



<p><div class='code'>
<span id='Z557201'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_seq_sanitise</span><span class='lexic'>(</span><span id='Z557668'><span><span class='ident'>ss</span></span></span><span class='lexic'>)</span><br>
<span class='keyword'>collector</span><span class='lexic'>(</span><span id='Z557658'><span><span class='ident'>addinsn</span></span></span><span class='lexic'>,</span>&nbsp;<span id='Z557670'><span><span class='ident'>getinsns</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;<span id='Z557629'><span><span class='ident'>relabelht</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='ident'>mkhash</span><span class='lexic'>();</span><br>
&nbsp;&nbsp;<span id='Z557654'><span><span class='ident'>addlabelmap</span></span></span><span class='lexic'>(</span><span id='Z557630'><span><span class='ident'>f</span></span></span><span class='lexic'>,</span>&nbsp;<span id='Z557631'><span><span class='ident'>t</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='ident'>ohashput</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z557629",this)' onmouseleave='srcref_leave("Z557629",this)'><span><span class='ident'>relabelht</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z557630",this)' onmouseleave='srcref_leave("Z557630",this)'><span><span class='ident'>f</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z557631",this)' onmouseleave='srcref_leave("Z557631",this)'><span><span class='ident'>t</span></span></span><span class='lexic'>);</span><br>
&nbsp;&nbsp;<span class='keyword'>do</span>&nbsp;<span id='Z557656'><span><span class='ident'>loop</span></span></span><span class='lexic'>(</span><span id='Z557667'><span><span class='ident'>l</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z557668",this)' onmouseleave='srcref_leave("Z557668",this)'><span><span class='ident'>ss</span></span></span><span class='lexic'>,</span>&nbsp;<span id='Z557653'><span><span class='ident'>prevlbl</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='symbol'>'entry'</span><span class='lexic'>,</span>&nbsp;<span id='Z557661'><span><span class='ident'>prevterm</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='lexic'>&#8709;</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>match</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z557667",this)' onmouseleave='srcref_leave("Z557667",this)'><span><span class='ident'>l</span></span></span>&nbsp;<span class='keyword'>with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z557644'><span><span class='ident'><span class='pattern'>insn</span></span></span></span><span class='lexic'><span class='pattern'>:</span></span><span id='Z557657'><span><span class='ident'><span class='pattern'>rest</span></span></span></span>&nbsp;&#8594;&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z557666'><span><span class='ident'>class</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<a href='#Z556388'><span class='ident'>l0_classify_insn</span></a><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z557644",this)' onmouseleave='srcref_leave("Z557644",this)'><span><span class='ident'>insn</span></span></span><span class='lexic'>);</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>match</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z557666",this)' onmouseleave='srcref_leave("Z557666",this)'><span><span class='ident'>class</span></span></span>&nbsp;<span class='keyword'>with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='symbol'><span class='pattern'>'label'</span></span><span class='lexic'><span class='pattern'>(</span></span><span id='Z557655'><span><span class='ident'><span class='pattern'>id</span></span></span></span><span class='lexic'><span class='pattern'>)</span></span>&nbsp;&#8594;&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>if</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z557653",this)' onmouseleave='srcref_leave("Z557653",this)'><span><span class='ident'>prevlbl</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z557654",this)' onmouseleave='srcref_leave("Z557654",this)'><span><span class='ident'>addlabelmap</span></span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z557655",this)' onmouseleave='srcref_leave("Z557655",this)'><span><span class='ident'>id</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z557653",this)' onmouseleave='srcref_leave("Z557653",this)'><span><span class='ident'>prevlbl</span></span></span><span class='lexic'>);</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z557656",this)' onmouseleave='srcref_leave("Z557656",this)'><span><span class='ident'>loop</span></span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z557657",this)' onmouseleave='srcref_leave("Z557657",this)'><span><span class='ident'>rest</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z557653",this)' onmouseleave='srcref_leave("Z557653",this)'><span><span class='ident'>prevlbl</span></span></span><span class='lexic'>,</span>&nbsp;<span class='lexic'>&#8709;</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>}</span>&nbsp;<span class='keyword'>else</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z557658",this)' onmouseleave='srcref_leave("Z557658",this)'><span><span class='ident'>addinsn</span></span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z557644",this)' onmouseleave='srcref_leave("Z557644",this)'><span><span class='ident'>insn</span></span></span><span class='lexic'>);</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z557656",this)' onmouseleave='srcref_leave("Z557656",this)'><span><span class='ident'>loop</span></span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z557657",this)' onmouseleave='srcref_leave("Z557657",this)'><span><span class='ident'>rest</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z557655",this)' onmouseleave='srcref_leave("Z557655",this)'><span><span class='ident'>id</span></span></span><span class='lexic'>,</span>&nbsp;<span class='lexic'>&#8709;</span><span class='lexic'>)}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='symbol'><span class='pattern'>'term'</span></span><span class='lexic'><span class='pattern'>()</span></span>&nbsp;&#8594;&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>if</span>&nbsp;<span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z557661",this)' onmouseleave='srcref_leave("Z557661",this)'><span><span class='ident'>prevterm</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z557656",this)' onmouseleave='srcref_leave("Z557656",this)'><span><span class='ident'>loop</span></span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z557657",this)' onmouseleave='srcref_leave("Z557657",this)'><span><span class='ident'>rest</span></span></span><span class='lexic'>,</span>&nbsp;<span class='lexic'>&#8709;</span><span class='lexic'>,</span>&nbsp;<span class='keyword'>true</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>}</span>&nbsp;<span class='keyword'>else</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z557658",this)' onmouseleave='srcref_leave("Z557658",this)'><span><span class='ident'>addinsn</span></span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z557644",this)' onmouseleave='srcref_leave("Z557644",this)'><span><span class='ident'>insn</span></span></span><span class='lexic'>);</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z557656",this)' onmouseleave='srcref_leave("Z557656",this)'><span><span class='ident'>loop</span></span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z557657",this)' onmouseleave='srcref_leave("Z557657",this)'><span><span class='ident'>rest</span></span></span><span class='lexic'>,</span>&nbsp;<span class='lexic'>&#8709;</span><span class='lexic'>,</span>&nbsp;<span class='keyword'>true</span><span class='lexic'>)}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='symbol'><span class='pattern'>'skip'</span></span><span class='lexic'><span class='pattern'>()</span></span>&nbsp;&#8594;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z557656",this)' onmouseleave='srcref_leave("Z557656",this)'><span><span class='ident'>loop</span></span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z557657",this)' onmouseleave='srcref_leave("Z557657",this)'><span><span class='ident'>rest</span></span></span><span class='lexic'>,</span>&nbsp;<span class='lexic'>&#8709;</span><span class='lexic'>,</span>&nbsp;<span class='lexic'>&#8709;</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='symbol'><span class='pattern'>'insn'</span></span><span class='lexic'><span class='pattern'>()</span></span>&nbsp;&#8594;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>if</span>&nbsp;<span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z557661",this)' onmouseleave='srcref_leave("Z557661",this)'><span><span class='ident'>prevterm</span></span></span><span class='lexic'>)</span>&nbsp;<span class='withhint'><span class='ident'>ccerror</span><span class='hint'>function&nbsp;ccerror&nbsp;arg:&nbsp;<br>
Raises&nbsp;[MBaseException]&nbsp;with&nbsp;a&nbsp;given&nbsp;argument.</span></span><span class='lexic'>(</span><span class='symbol'>'IMPOSSIBLE'</span><span class='lexic'>())</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>else</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z557658",this)' onmouseleave='srcref_leave("Z557658",this)'><span><span class='ident'>addinsn</span></span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z557644",this)' onmouseleave='srcref_leave("Z557644",this)'><span><span class='ident'>insn</span></span></span><span class='lexic'>);</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z557656",this)' onmouseleave='srcref_leave("Z557656",this)'><span><span class='ident'>loop</span></span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z557657",this)' onmouseleave='srcref_leave("Z557657",this)'><span><span class='ident'>rest</span></span></span><span class='lexic'>,</span>&nbsp;<span class='lexic'>&#8709;</span><span class='lexic'>,</span>&nbsp;<span class='lexic'>&#8709;</span><span class='lexic'>)}}}</span><span class='lexic'>;</span><br>
&nbsp;&nbsp;<span id='Z557674'><span><span class='ident'>ss0</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z557670",this)' onmouseleave='srcref_leave("Z557670",this)'><span><span class='ident'>getinsns</span></span></span><span class='lexic'>();</span><br>
&nbsp;&nbsp;<span class='comment'>//&nbsp;Rename&nbsp;goto&nbsp;targets&nbsp;since&nbsp;we&nbsp;eliminated&nbsp;redundant&nbsp;labels<br>
</span>&nbsp;&nbsp;<span class='keyword'>return</span>&nbsp;<span class='keyword'>map</span>&nbsp;<span id='Z557687'><span><span class='ident'>s</span></span></span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z557674",this)' onmouseleave='srcref_leave("Z557674",this)'><span><span class='ident'>ss0</span></span></span>&nbsp;<span class='keyword'>do</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z558026'><span><span class='ident'>fixlabel</span></span></span><span class='lexic'>(</span><span id='Z557681'><span><span class='ident'>lbl</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>=</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>aif</span><span class='lexic'>(</span><span class='ident'>chk</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='ident'>ohashget</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z557629",this)' onmouseleave='srcref_leave("Z557629",this)'><span><span class='ident'>relabelht</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z557681",this)' onmouseleave='srcref_leave("Z557681",this)'><span><span class='ident'>lbl</span></span></span><span class='lexic'>))</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>return</span>&nbsp;<span class='ident'>chk</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>}</span>&nbsp;<span class='keyword'>else</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z557681",this)' onmouseleave='srcref_leave("Z557681",this)'><span><span class='ident'>lbl</span></span></span><span class='lexic'>;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0flat1</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>stmt</span><span class='lexic'>:</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z557687",this)' onmouseleave='srcref_leave("Z557687",this)'><span><span class='ident'>s</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>stmt</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z558027'><span><span class='ident'>goto</span></span></span>&nbsp;&#8594;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='keyword'>node</span><span class='hint'>lang0flat1:stmt:goto(id)</span></span><span class='lexic'>(</span><span class='ident'>id</span><span class='lexic'>=</span><span class='idfrom' onmouseenter='srcref_over("Z558026",this)' onmouseleave='srcref_leave("Z558026",this)'><span><span class='ident'>fixlabel</span></span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z558027",this)' onmouseleave='srcref_leave("Z558027",this)'><span><span class='ident'>id</span></span></span><span class='hint'>goto(id)</span></span><span class='lexic'>))</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;&nbsp;<span id='Z558057'><span><span class='ident'>gotoc</span></span></span>&nbsp;&#8594;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='keyword'>node</span><span class='hint'>lang0flat1:stmt:gotoc(cnd,tr,fl)<br>
&nbsp;&nbsp;&nbsp;with&nbsp;implicit&nbsp;arguments:&nbsp;cnd<br>
</span></span><span class='lexic'>(</span><span class='ident'>tr</span><span class='lexic'>=</span><span class='idfrom' onmouseenter='srcref_over("Z558026",this)' onmouseleave='srcref_leave("Z558026",this)'><span><span class='ident'>fixlabel</span></span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z558057",this)' onmouseleave='srcref_leave("Z558057",this)'><span><span class='ident'>tr</span></span></span><span class='hint'>gotoc(cnd,tr,fl)</span></span><span class='lexic'>),</span>&nbsp;<span class='ident'>fl</span><span class='lexic'>=</span><span class='idfrom' onmouseenter='srcref_over("Z558026",this)' onmouseleave='srcref_leave("Z558026",this)'><span><span class='ident'>fixlabel</span></span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z558057",this)' onmouseleave='srcref_leave("Z558057",this)'><span><span class='ident'>fl</span></span></span><span class='hint'>gotoc(cnd,tr,fl)</span></span><span class='lexic'>))</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;&nbsp;<span class='keyword'>else</span>&nbsp;&nbsp;&#8594;&nbsp;<span class='ident'>node</span><span class='lexic'>()}}}}</span>
<p></div>



<p><div class='code'>
<span id='Z558207'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_flat2</span><span class='lexic'>(</span><span id='Z558733'><span><span class='ident'>i</span></span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0flat1</span>&nbsp;<span class='lexic'>/rec,</span>&nbsp;<span class='lexic'>dst</span>&nbsp;<span class='ident'>lang0flat2</span><span class='lexic'>/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>stmt</span><span class='lexic'>:</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z558733",this)' onmouseleave='srcref_leave("Z558733",this)'><span><span class='ident'>i</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>stmt</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='ident'>tailapply</span>&nbsp;&#8594;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>term</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>tail</span><span class='hint'>lang0flat2:term:tail(e)</span></span><span class='lexic'>(</span><span class='ident'>mk</span><span class='lexic'>:</span><span class='ident'>expr</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>apply</span><span class='hint'>lang0flat2:expr:apply(purep,fn,args)<br>
&nbsp;&nbsp;&nbsp;with&nbsp;implicit&nbsp;arguments:&nbsp;fn,&nbsp;args<br>
</span></span><span class='lexic'>(</span><span class='ident'>purep</span><span class='lexic'>=</span><span class='lexic'>&#8709;</span><span class='lexic'>))</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>goto</span>&nbsp;&#8594;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>term</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>goto</span><span class='hint'>lang0flat2:term:goto(id)</span></span><span class='lexic'>()</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>gotoc</span>&nbsp;&#8594;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>term</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>gotoc</span><span class='hint'>lang0flat2:term:gotoc(cnd,tr,fl)</span></span><span class='lexic'>()</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>return</span>&nbsp;&#8594;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>term</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>return</span><span class='hint'>lang0flat2:term:return(v)</span></span><span class='lexic'>()</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>label</span>&nbsp;&#8594;&nbsp;<span class='withhint'><span class='ident'>ccerror</span><span class='hint'>function&nbsp;ccerror&nbsp;arg:&nbsp;<br>
Raises&nbsp;[MBaseException]&nbsp;with&nbsp;a&nbsp;given&nbsp;argument.</span></span><span class='lexic'>(</span><span class='symbol'>'IMPOSSIBLE'</span><span class='lexic'>())</span><br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>alloca</span>&nbsp;&#8594;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>insn</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>alloca</span><span class='hint'>lang0flat2:insn:alloca(id)</span></span><span class='lexic'>()</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>def</span>&nbsp;&#8594;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>insn</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>def</span><span class='hint'>lang0flat2:insn:def(id,v)</span></span><span class='lexic'>()</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>set</span>&nbsp;&#8594;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>insn</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>set</span><span class='hint'>lang0flat2:insn:set(id,v)</span></span><span class='lexic'>()</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>drop</span>&nbsp;&#8594;&nbsp;<span class='withhint'><span class='ident'>ccerror</span><span class='hint'>function&nbsp;ccerror&nbsp;arg:&nbsp;<br>
Raises&nbsp;[MBaseException]&nbsp;with&nbsp;a&nbsp;given&nbsp;argument.</span></span><span class='lexic'>(</span><span class='symbol'>'IMPOSSIBLE'</span><span class='lexic'>())</span><span class='lexic'>};</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>expr</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='ident'>const</span>&nbsp;&#8594;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>value</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>const</span><span class='hint'>lang0flat2:value:const(c)</span></span><span class='lexic'>()</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>global</span>&nbsp;&#8594;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>value</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>global</span><span class='hint'>lang0flat2:value:global(id)</span></span><span class='lexic'>()</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>arg</span>&nbsp;&#8594;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>value</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>arg</span><span class='hint'>lang0flat2:value:arg(id)</span></span><span class='lexic'>()</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>clvar</span>&nbsp;&#8594;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>value</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>clvar</span><span class='hint'>lang0flat2:value:clvar(id)</span></span><span class='lexic'>()</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>reg</span>&nbsp;&#8594;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>value</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>reg</span><span class='hint'>lang0flat2:value:reg(id)</span></span><span class='lexic'>()</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>funref</span>&nbsp;&#8594;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>value</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>funref</span><span class='hint'>lang0flat2:value:funref(id)</span></span><span class='lexic'>()</span><br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>mkclosure</span>&nbsp;&#8594;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>expr</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>mkclosure</span><span class='hint'>lang0flat2:expr:mkclosure(df,args)</span></span><span class='lexic'>()</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>apply</span>&nbsp;&#8594;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>expr</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>apply</span><span class='hint'>lang0flat2:expr:apply(purep,fn,args)<br>
&nbsp;&nbsp;&nbsp;with&nbsp;implicit&nbsp;arguments:&nbsp;fn,&nbsp;args<br>
</span></span><span class='lexic'>(</span><span class='ident'>purep</span><span class='lexic'>=</span><span class='lexic'>&#8709;</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>load</span>&nbsp;&#8594;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>expr</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>load</span><span class='hint'>lang0flat2:expr:load(id)</span></span><span class='lexic'>()</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>}}</span>
<p></div>



<p><div class='code'>
<span id='Z559284'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_basic_blocks_stmts</span><span class='lexic'>(</span><span id='Z559330'><span><span class='ident'>s</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;<span id='Z559395'><span><span class='ident'>ss</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<a href='#Z557201'><span class='ident'>l0_seq_sanitise</span></a><span class='lexic'>(</span><a href='#Z555582'><span class='ident'>l0_seq_body</span></a><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z559330",this)' onmouseleave='srcref_leave("Z559330",this)'><span><span class='ident'>s</span></span></span><span class='lexic'>));</span><br>
&nbsp;&nbsp;<span class='keyword'>collector</span><span class='lexic'>(</span><span id='Z559364'><span><span class='ident'>bbadd</span></span></span><span class='lexic'>,</span>&nbsp;<span id='Z559399'><span><span class='ident'>bbget</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>do</span>&nbsp;<span id='Z559383'><span><span class='ident'>loop</span></span></span><span class='lexic'>(</span><span id='Z559394'><span><span class='ident'>l</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z559395",this)' onmouseleave='srcref_leave("Z559395",this)'><span><span class='ident'>ss</span></span></span><span class='lexic'>,</span>&nbsp;<span id='Z559352'><span><span class='ident'>bb</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='symbol'>'entry'</span><span class='lexic'>,</span>&nbsp;<span id='Z559356'><span><span class='ident'>insns</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='lexic'>&#8709;</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z559392'><span><span class='ident'>flush</span></span></span><span class='lexic'>(</span><span id='Z559360'><span><span class='ident'>term</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='keyword'>with</span>&nbsp;<span class='keyword'>target</span><span class='lexic'>(</span><span class='ident'>lang0flat2</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z559365'><span><span class='ident'>bb</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>bblock</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>bb</span><span class='hint'>lang0flat2:bblock:bb(lbl,body,t)</span></span><span class='lexic'>(</span><span class='ident'>lbl</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z559352",this)' onmouseleave='srcref_leave("Z559352",this)'><span><span class='ident'>bb</span></span></span><span class='lexic'>,</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='ident'>body</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='keyword'>map</span>&nbsp;<span id='Z559359'><span><span class='ident'>i</span></span></span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z559356",this)' onmouseleave='srcref_leave("Z559356",this)'><span><span class='ident'>insns</span></span></span>&nbsp;<span class='keyword'>do</span>&nbsp;<a href='#Z558207'><span class='ident'>l0_flat2</span></a><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z559359",this)' onmouseleave='srcref_leave("Z559359",this)'><span><span class='ident'>i</span></span></span><span class='lexic'>),</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='ident'>t</span>&nbsp;<span class='lexic'>=</span>&nbsp;<a href='#Z558207'><span class='ident'>l0_flat2</span></a><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z559360",this)' onmouseleave='srcref_leave("Z559360",this)'><span><span class='ident'>term</span></span></span><span class='lexic'>));</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z559364",this)' onmouseleave='srcref_leave("Z559364",this)'><span><span class='ident'>bbadd</span></span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z559365",this)' onmouseleave='srcref_leave("Z559365",this)'><span><span class='ident'>bb</span></span></span><span class='lexic'>)};</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>match</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z559394",this)' onmouseleave='srcref_leave("Z559394",this)'><span><span class='ident'>l</span></span></span>&nbsp;<span class='keyword'>with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z559374'><span><span class='ident'><span class='pattern'>insn</span></span></span></span><span class='lexic'><span class='pattern'>:</span></span><span id='Z559384'><span><span class='ident'><span class='pattern'>rest</span></span></span></span>&nbsp;&#8594;&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z559393'><span><span class='ident'>class</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<a href='#Z556388'><span class='ident'>l0_classify_insn</span></a><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z559374",this)' onmouseleave='srcref_leave("Z559374",this)'><span><span class='ident'>insn</span></span></span><span class='lexic'>);</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>match</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z559393",this)' onmouseleave='srcref_leave("Z559393",this)'><span><span class='ident'>class</span></span></span>&nbsp;<span class='keyword'>with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='symbol'><span class='pattern'>'label'</span></span><span class='lexic'><span class='pattern'>(</span></span><span id='Z559385'><span><span class='ident'><span class='pattern'>id</span></span></span></span><span class='lexic'><span class='pattern'>)</span></span>&nbsp;&#8594;&nbsp;<span class='lexic'>{</span>&nbsp;<span class='comment'>//&nbsp;Assuming&nbsp;no&nbsp;flocking&nbsp;labels&nbsp;left<br>
</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>if</span>&nbsp;<span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z559356",this)' onmouseleave='srcref_leave("Z559356",this)'><span><span class='ident'>insns</span></span></span><span class='lexic'>)</span>&nbsp;<span class='withhint'><span class='ident'>ccerror</span><span class='hint'>function&nbsp;ccerror&nbsp;arg:&nbsp;<br>
Raises&nbsp;[MBaseException]&nbsp;with&nbsp;a&nbsp;given&nbsp;argument.</span></span><span class='lexic'>(</span><span class='symbol'>'IMPOSSIBLE'</span><span class='lexic'>());</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z559383",this)' onmouseleave='srcref_leave("Z559383",this)'><span><span class='ident'>loop</span></span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z559384",this)' onmouseleave='srcref_leave("Z559384",this)'><span><span class='ident'>rest</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z559385",this)' onmouseleave='srcref_leave("Z559385",this)'><span><span class='ident'>id</span></span></span><span class='lexic'>,</span>&nbsp;<span class='lexic'>&#8709;</span><span class='lexic'>)}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='symbol'><span class='pattern'>'insn'</span></span><span class='lexic'><span class='pattern'>()</span></span>&nbsp;&#8594;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z559383",this)' onmouseleave='srcref_leave("Z559383",this)'><span><span class='ident'>loop</span></span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z559384",this)' onmouseleave='srcref_leave("Z559384",this)'><span><span class='ident'>rest</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z559352",this)' onmouseleave='srcref_leave("Z559352",this)'><span><span class='ident'>bb</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z559356",this)' onmouseleave='srcref_leave("Z559356",this)'><span><span class='ident'>insns</span></span></span>&nbsp;<span class='lexic'>&#8853;</span>&nbsp;<span class='lexic'>[</span><span class='idfrom' onmouseenter='srcref_over("Z559374",this)' onmouseleave='srcref_leave("Z559374",this)'><span><span class='ident'>insn</span></span></span><span class='lexic'>])</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='symbol'><span class='pattern'>'skip'</span></span><span class='lexic'><span class='pattern'>()</span></span>&nbsp;&#8594;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z559383",this)' onmouseleave='srcref_leave("Z559383",this)'><span><span class='ident'>loop</span></span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z559384",this)' onmouseleave='srcref_leave("Z559384",this)'><span><span class='ident'>rest</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z559352",this)' onmouseleave='srcref_leave("Z559352",this)'><span><span class='ident'>bb</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z559356",this)' onmouseleave='srcref_leave("Z559356",this)'><span><span class='ident'>insns</span></span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='symbol'><span class='pattern'>'term'</span></span><span class='lexic'><span class='pattern'>()</span></span>&nbsp;&#8594;&nbsp;<span class='lexic'>{</span><span class='idfrom' onmouseenter='srcref_over("Z559392",this)' onmouseleave='srcref_leave("Z559392",this)'><span><span class='ident'>flush</span></span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z559374",this)' onmouseleave='srcref_leave("Z559374",this)'><span><span class='ident'>insn</span></span></span><span class='lexic'>);</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z559383",this)' onmouseleave='srcref_leave("Z559383",this)'><span><span class='ident'>loop</span></span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z559384",this)' onmouseleave='srcref_leave("Z559384",this)'><span><span class='ident'>rest</span></span></span><span class='lexic'>,</span>&nbsp;<span class='lexic'>&#8709;</span><span class='lexic'>,</span>&nbsp;<span class='lexic'>&#8709;</span><span class='lexic'>)}}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='lexic'><span class='pattern'>&#8709;</span></span>&nbsp;&#8594;&nbsp;<span class='lexic'>{</span><span class='keyword'>if</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z559356",this)' onmouseleave='srcref_leave("Z559356",this)'><span><span class='ident'>insns</span></span></span><span class='lexic'>)</span>&nbsp;<span class='withhint'><span class='ident'>ccerror</span><span class='hint'>function&nbsp;ccerror&nbsp;arg:&nbsp;<br>
Raises&nbsp;[MBaseException]&nbsp;with&nbsp;a&nbsp;given&nbsp;argument.</span></span><span class='lexic'>(</span><span class='symbol'>'IMPOSSIBLE'</span><span class='lexic'>())}}</span><span class='lexic'>;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>with</span>&nbsp;<span class='keyword'>target</span>&nbsp;<span class='lexic'>(</span><span class='ident'>lang0flat2</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>return</span>&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>code</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>c</span><span class='hint'>lang0flat2:code:c(bs)</span></span><span class='lexic'>(</span><span class='ident'>bs</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z559399",this)' onmouseleave='srcref_leave("Z559399",this)'><span><span class='ident'>bbget</span></span></span><span class='lexic'>())}}}</span>
<p></div>



<p><div class='code'>
<span id='Z559462'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_basic_blocks</span><span class='lexic'>(</span><span id='Z559958'><span><span class='ident'>ts</span></span></span><span class='lexic'>)</span>&nbsp;<br>
&nbsp;&nbsp;<span class='keyword'>map</span>&nbsp;<span id='Z559966'><span><span class='ident'>t</span></span></span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z559958",this)' onmouseleave='srcref_leave("Z559958",this)'><span><span class='ident'>ts</span></span></span>&nbsp;<span class='keyword'>do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0flat1</span>&nbsp;<span class='lexic'>/rec,</span>&nbsp;<span class='lexic'>dst</span>&nbsp;<span class='ident'>lang0flat2</span><span class='lexic'>/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>top</span><span class='lexic'>:</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z559966",this)' onmouseleave='srcref_leave("Z559966",this)'><span><span class='ident'>t</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>once</span>&nbsp;<span class='ident'>stmt</span>&nbsp;<span class='lexic'>{</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<a href='#Z559284'><span class='ident'>l0_basic_blocks_stmts</span></a><span class='lexic'>(</span><span class='ident'>node</span><span class='lexic'>())</span>&nbsp;<span class='lexic'>}}</span>
<p></div>








The code after basic blocks extraction and before the generic SSA transform is
following:


<p><div class='democode'>
<span class='lexic'>(</span><span class='ident'>sfunction</span>&nbsp;<span class='keyword'>foldl</span>&nbsp;<span class='lexic'>(</span><span class='ident'>Z562128</span>&nbsp;<span class='ident'>Z562129</span>&nbsp;<span class='ident'>Z562130</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>(</span><span class='ident'>c</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>bb</span>&nbsp;<span class='ident'>entry</span>&nbsp;<span class='lexic'>(</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>alloca</span>&nbsp;<span class='ident'>Z562128</span><span class='lexic'>)</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>alloca</span>&nbsp;<span class='ident'>Z562129</span><span class='lexic'>)</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>alloca</span>&nbsp;<span class='ident'>Z562130</span><span class='lexic'>)</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>set</span>&nbsp;<span class='ident'>Z562128</span>&nbsp;<span class='lexic'>(</span><span class='ident'>arg</span>&nbsp;<span class='ident'>Z562128</span><span class='lexic'>))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>set</span>&nbsp;<span class='ident'>Z562129</span>&nbsp;<span class='lexic'>(</span><span class='ident'>arg</span>&nbsp;<span class='ident'>Z562129</span><span class='lexic'>))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>set</span>&nbsp;<span class='ident'>Z562130</span>&nbsp;<span class='lexic'>(</span><span class='ident'>arg</span>&nbsp;<span class='ident'>Z562130</span><span class='lexic'>)))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>goto</span>&nbsp;<span class='ident'>tailrecentry</span><span class='lexic'>))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>bb</span>&nbsp;<span class='ident'>tailrecentry</span>&nbsp;<span class='lexic'>(</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>alloca</span>&nbsp;<span class='ident'>Z562131</span><span class='lexic'>)</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>alloca</span>&nbsp;<span class='ident'>Z562132</span><span class='lexic'>)</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>def</span>&nbsp;<span class='ident'>Z562145</span>&nbsp;<span class='lexic'>(</span><span class='ident'>load</span>&nbsp;<span class='ident'>Z562130</span><span class='lexic'>))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>def</span>&nbsp;<span class='ident'>Z562144</span>&nbsp;<span class='lexic'>(</span><span class='keyword'>apply</span>&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>global</span>&nbsp;<span class='ident'>nullp</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>(</span><span class='ident'>reg</span>&nbsp;<span class='ident'>Z562145</span><span class='lexic'>))))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>gotoc</span>&nbsp;<span class='lexic'>(</span><span class='ident'>reg</span>&nbsp;<span class='ident'>Z562144</span><span class='lexic'>)</span>&nbsp;<span class='ident'>Z562146</span>&nbsp;<span class='ident'>Z562147</span><span class='lexic'>))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>bb</span>&nbsp;<span class='ident'>Z562146</span>&nbsp;<span class='lexic'>(</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>def</span>&nbsp;<span class='ident'>Z562133</span>&nbsp;<span class='lexic'>(</span><span class='ident'>load</span>&nbsp;<span class='ident'>Z562129</span><span class='lexic'>)))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(return</span>&nbsp;<span class='lexic'>(</span><span class='ident'>reg</span>&nbsp;<span class='ident'>Z562133</span><span class='lexic'>)))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>bb</span>&nbsp;<span class='ident'>Z562147</span>&nbsp;<span class='lexic'>(</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>def</span>&nbsp;<span class='ident'>Z562135</span>&nbsp;<span class='lexic'>(</span><span class='ident'>load</span>&nbsp;<span class='ident'>Z562130</span><span class='lexic'>))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>def</span>&nbsp;<span class='ident'>Z562134</span>&nbsp;<span class='lexic'>(</span><span class='keyword'>apply</span>&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>global</span>&nbsp;<span class='ident'>head</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>(</span><span class='ident'>reg</span>&nbsp;<span class='ident'>Z562135</span><span class='lexic'>)))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>set</span>&nbsp;<span class='ident'>Z562131</span>&nbsp;<span class='lexic'>(</span><span class='ident'>reg</span>&nbsp;<span class='ident'>Z562134</span><span class='lexic'>))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>def</span>&nbsp;<span class='ident'>Z562137</span>&nbsp;<span class='lexic'>(</span><span class='ident'>load</span>&nbsp;<span class='ident'>Z562130</span><span class='lexic'>))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>def</span>&nbsp;<span class='ident'>Z562136</span>&nbsp;<span class='lexic'>(</span><span class='keyword'>apply</span>&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>global</span>&nbsp;<span class='ident'>tail</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>(</span><span class='ident'>reg</span>&nbsp;<span class='ident'>Z562137</span><span class='lexic'>)))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>set</span>&nbsp;<span class='ident'>Z562132</span>&nbsp;<span class='lexic'>(</span><span class='ident'>reg</span>&nbsp;<span class='ident'>Z562136</span><span class='lexic'>))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>def</span>&nbsp;<span class='ident'>Z562138</span>&nbsp;<span class='lexic'>(</span><span class='ident'>load</span>&nbsp;<span class='ident'>Z562128</span><span class='lexic'>))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>set</span>&nbsp;<span class='ident'>Z562128</span>&nbsp;<span class='lexic'>(</span><span class='ident'>reg</span>&nbsp;<span class='ident'>Z562138</span><span class='lexic'>))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>def</span>&nbsp;<span class='ident'>Z562140</span>&nbsp;<span class='lexic'>(</span><span class='ident'>load</span>&nbsp;<span class='ident'>Z562128</span><span class='lexic'>))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>def</span>&nbsp;<span class='ident'>Z562141</span>&nbsp;<span class='lexic'>(</span><span class='ident'>load</span>&nbsp;<span class='ident'>Z562129</span><span class='lexic'>))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>def</span>&nbsp;<span class='ident'>Z562142</span>&nbsp;<span class='lexic'>(</span><span class='ident'>load</span>&nbsp;<span class='ident'>Z562131</span><span class='lexic'>))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>def</span>&nbsp;<span class='ident'>Z562139</span>&nbsp;<span class='lexic'>(</span><span class='keyword'>apply</span>&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>reg</span>&nbsp;<span class='ident'>Z562140</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>(</span><span class='ident'>reg</span>&nbsp;<span class='ident'>Z562141</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>(</span><span class='ident'>reg</span>&nbsp;<span class='ident'>Z562142</span><span class='lexic'>)))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>set</span>&nbsp;<span class='ident'>Z562129</span>&nbsp;<span class='lexic'>(</span><span class='ident'>reg</span>&nbsp;<span class='ident'>Z562139</span><span class='lexic'>))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>def</span>&nbsp;<span class='ident'>Z562143</span>&nbsp;<span class='lexic'>(</span><span class='ident'>load</span>&nbsp;<span class='ident'>Z562132</span><span class='lexic'>))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>set</span>&nbsp;<span class='ident'>Z562130</span>&nbsp;<span class='lexic'>(</span><span class='ident'>reg</span>&nbsp;<span class='ident'>Z562143</span><span class='lexic'>)))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>goto</span>&nbsp;<span class='ident'>tailrecentry</span><span class='lexic'>))))</span><br>

</div><p>





<h2>Generic SSA</h2>

<p>Now we're all set for an SSA--transform (i.e., memory to register). For this
we'll use a specific simplified IR, not to be confused with a more complex
<i>Abstract SSA</i> we'll use later.




<p><div class='code'>
<span id='Z562149'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_to_genssa</span><span class='lexic'>(</span><span id='Z563627'><span><span class='ident'>c</span></span></span><span class='lexic'>)</span><br>
<span class='keyword'>collector</span><span class='lexic'>(</span><span id='Z563152'><span><span class='ident'>liftadd</span></span></span><span class='lexic'>,</span>&nbsp;<span id='Z564014'><span><span class='ident'>liftget</span></span></span><span class='lexic'>)</span><br>
<span class='keyword'>collector</span><span class='lexic'>(</span><span id='Z564037'><span><span class='ident'>addalloca</span></span></span><span class='lexic'>,</span>&nbsp;<span id='Z564135'><span><span class='ident'>getallocas</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;<span id='Z563142'><span><span class='ident'>vals</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='ident'>mkhash</span><span class='lexic'>();</span><br>
&nbsp;&nbsp;&nbsp;<span id='Z563149'><span><span class='ident'>addval</span></span></span><span class='lexic'>(</span><span id='Z563143'><span><span class='ident'>nm</span></span></span><span class='lexic'>,</span>&nbsp;<span id='Z563144'><span><span class='ident'>v</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='ident'>ohashput</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z563142",this)' onmouseleave='srcref_leave("Z563142",this)'><span><span class='ident'>vals</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z563143",this)' onmouseleave='srcref_leave("Z563143",this)'><span><span class='ident'>nm</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z563144",this)' onmouseleave='srcref_leave("Z563144",this)'><span><span class='ident'>v</span></span></span><span class='lexic'>);</span><br>
&nbsp;&nbsp;&nbsp;<span id='Z564107'><span><span class='ident'>newlift</span></span></span><span class='lexic'>(</span><span id='Z563151'><span><span class='ident'>v</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>=</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>symbols</span><span class='lexic'>(</span><span id='Z563150'><span><span class='ident'>id</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z563149",this)' onmouseleave='srcref_leave("Z563149",this)'><span><span class='ident'>addval</span></span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z563150",this)' onmouseleave='srcref_leave("Z563150",this)'><span><span class='ident'>id</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z563151",this)' onmouseleave='srcref_leave("Z563151",this)'><span><span class='ident'>v</span></span></span><span class='lexic'>);</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z563152",this)' onmouseleave='srcref_leave("Z563152",this)'><span><span class='ident'>liftadd</span></span></span><span class='lexic'>([</span><span class='idfrom' onmouseenter='srcref_over("Z563150",this)' onmouseleave='srcref_leave("Z563150",this)'><span><span class='ident'>id</span></span></span><span class='lexic'>;</span><span class='symbol'>'use'</span><span class='lexic'>()]);</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z563150",this)' onmouseleave='srcref_leave("Z563150",this)'><span><span class='ident'>id</span></span></span>&nbsp;<span class='lexic'>};</span><br>
&nbsp;&nbsp;&nbsp;<span id='Z563503'><span><span class='ident'>getexitsterm</span></span></span><span class='lexic'>(</span><span id='Z563169'><span><span class='ident'>t</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>=</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>collector</span><span class='lexic'>(</span><span id='Z563324'><span><span class='ident'>add</span></span></span><span class='lexic'>,</span>&nbsp;<span id='Z563397'><span><span class='ident'>get</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0flat2</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>term</span><span class='lexic'>:</span><span class='idfrom' onmouseenter='srcref_over("Z563169",this)' onmouseleave='srcref_leave("Z563169",this)'><span><span class='ident'>t</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>once</span>&nbsp;<span class='ident'>labident</span>&nbsp;<span class='lexic'>:</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z563324",this)' onmouseleave='srcref_leave("Z563324",this)'><span><span class='ident'>add</span></span></span><span class='lexic'>(</span><span class='ident'>thisnodesrc</span><span class='lexic'>())};</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>return</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z563397",this)' onmouseleave='srcref_leave("Z563397",this)'><span><span class='ident'>get</span></span></span><span class='lexic'>()};</span><br>
&nbsp;&nbsp;&nbsp;<span id='Z564033'><span><span class='ident'>getbbexits</span></span></span><span class='lexic'>(</span><span id='Z563414'><span><span class='ident'>bb</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='keyword'>collector</span><span class='lexic'>(</span><span id='Z563502'><span><span class='ident'>add</span></span></span><span class='lexic'>,</span>&nbsp;<span id='Z563527'><span><span class='ident'>get</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0flat2</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>bblock</span><span class='lexic'>:</span><span class='idfrom' onmouseenter='srcref_over("Z563414",this)' onmouseleave='srcref_leave("Z563414",this)'><span><span class='ident'>bb</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>once</span>&nbsp;<span class='ident'>term</span>&nbsp;<span class='lexic'>{</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z563502",this)' onmouseleave='srcref_leave("Z563502",this)'><span><span class='ident'>add</span></span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z563503",this)' onmouseleave='srcref_leave("Z563503",this)'><span><span class='ident'>getexitsterm</span></span></span><span class='lexic'>(</span><span class='ident'>node</span><span class='lexic'>()))}};</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>return</span>&nbsp;<span class='ident'>car</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z563527",this)' onmouseleave='srcref_leave("Z563527",this)'><span><span class='ident'>get</span></span></span><span class='lexic'>())};</span><br>
&nbsp;&nbsp;&nbsp;<span id='Z564030'><span><span class='ident'>getcode</span></span></span><span class='lexic'>(</span><span id='Z563536'><span><span class='ident'>t</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>=</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0flat2</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>term</span><span class='lexic'>:</span><span class='idfrom' onmouseenter='srcref_over("Z563536",this)' onmouseleave='srcref_leave("Z563536",this)'><span><span class='ident'>t</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>once</span>&nbsp;<span class='ident'>term</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z563598'><span><span class='ident'>tail</span></span></span>&nbsp;&#8594;&nbsp;<span class='keyword'>symbols</span><span class='lexic'>(</span><span id='Z563597'><span><span class='ident'>retn</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>[[</span><span class='idfrom' onmouseenter='srcref_over("Z563597",this)' onmouseleave='srcref_leave("Z563597",this)'><span><span class='ident'>retn</span></span></span><span class='lexic'>;</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z563598",this)' onmouseleave='srcref_leave("Z563598",this)'><span><span class='ident'>e</span></span></span><span class='hint'>tail(e)</span></span><span class='lexic'>]]</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='lexic'>&#8709;</span><span class='lexic'>}};</span><br>
&nbsp;&nbsp;&nbsp;<span id='Z564137'><span><span class='ident'>gs</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0flat2</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>code</span><span class='lexic'>:</span><span class='idfrom' onmouseenter='srcref_over("Z563627",this)' onmouseleave='srcref_leave("Z563627",this)'><span><span class='ident'>c</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>code</span>&nbsp;<span class='lexic'>{</span>&nbsp;<span id='Z563999'><span><span class='ident'>c</span></span></span>&nbsp;&#8594;&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z563999",this)' onmouseleave='srcref_leave("Z563999",this)'><span><span class='ident'>bs</span></span></span><span class='hint'>c(bs)</span></span>&nbsp;<span class='lexic'>};</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>bblock</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z564011'><span><span class='ident'>bb</span></span></span>&nbsp;&#8594;&nbsp;<span class='symbol'>'b'</span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z564011",this)' onmouseleave='srcref_leave("Z564011",this)'><span><span class='ident'>lbl</span></span></span><span class='hint'>bb(lbl,body,t)</span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z564014",this)' onmouseleave='srcref_leave("Z564014",this)'><span><span class='ident'>liftget</span></span></span><span class='lexic'>()</span><span class='lexic'>&#8853;</span><span class='lexic'>(</span><span class='keyword'>map</span>&nbsp;<span class='keyword'>append</span>&nbsp;<span id='Z564028'><span><span class='ident'>b</span></span></span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z564011",this)' onmouseleave='srcref_leave("Z564011",this)'><span><span class='ident'>body</span></span></span><span class='hint'>bb(lbl,body,t)</span></span>&nbsp;<span class='keyword'>do</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z564028",this)' onmouseleave='srcref_leave("Z564028",this)'><span><span class='ident'>b</span></span></span><span class='lexic'>)</span><span class='lexic'>&#8853;</span><span class='idfrom' onmouseenter='srcref_over("Z564030",this)' onmouseleave='srcref_leave("Z564030",this)'><span><span class='ident'>getcode</span></span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z564011",this)' onmouseleave='srcref_leave("Z564011",this)'><span><span class='ident'>t</span></span></span><span class='hint'>bb(lbl,body,t)</span></span><span class='lexic'>),</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z564033",this)' onmouseleave='srcref_leave("Z564033",this)'><span><span class='ident'>getbbexits</span></span></span><span class='lexic'>(</span><span class='ident'>thisnodesrc</span><span class='lexic'>()))};</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>insn</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z564038'><span><span class='ident'>alloca</span></span></span>&nbsp;&#8594;&nbsp;<span class='lexic'>{</span><span class='idfrom' onmouseenter='srcref_over("Z564037",this)' onmouseleave='srcref_leave("Z564037",this)'><span><span class='ident'>addalloca</span></span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z564038",this)' onmouseleave='srcref_leave("Z564038",this)'><span><span class='ident'>id</span></span></span><span class='hint'>alloca(id)</span></span><span class='lexic'>);</span>&nbsp;<span class='lexic'>&#8709;</span><span class='lexic'>}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span id='Z564047'><span><span class='ident'>def</span></span></span>&nbsp;&nbsp;&nbsp;&nbsp;&#8594;&nbsp;<span class='lexic'>[[</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z564047",this)' onmouseleave='srcref_leave("Z564047",this)'><span><span class='ident'>id</span></span></span><span class='hint'>def(id,v)</span></span><span class='lexic'>;</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z564047",this)' onmouseleave='srcref_leave("Z564047",this)'><span><span class='ident'>v</span></span></span><span class='hint'>def(id,v)</span></span><span class='lexic'>]]</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span id='Z564058'><span><span class='ident'>set</span></span></span>&nbsp;&nbsp;&nbsp;&nbsp;&#8594;&nbsp;<span class='lexic'>[[</span><span class='withhint'><span class='ident'>gensym</span><span class='hint'>function&nbsp;gensym&nbsp;:&nbsp;<br>
Returns&nbsp;a&nbsp;unique&nbsp;symbol&nbsp;every&nbsp;time&nbsp;it&nbsp;is&nbsp;called.<br>
Uniqueness&nbsp;is&nbsp;guaranteed&nbsp;within&nbsp;one&nbsp;run&nbsp;only.</span></span><span class='lexic'>();</span>&nbsp;<span class='symbol'>'store'</span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z564058",this)' onmouseleave='srcref_leave("Z564058",this)'><span><span class='ident'>id</span></span></span><span class='hint'>set(id,v)</span></span><span class='lexic'>,</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z564058",this)' onmouseleave='srcref_leave("Z564058",this)'><span><span class='ident'>v</span></span></span><span class='hint'>set(id,v)</span></span><span class='lexic'>)]]</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>drop</span>&nbsp;&nbsp;&nbsp;&#8594;&nbsp;<span class='lexic'>&#8709;</span><span class='lexic'>};</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>expr</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z564089'><span><span class='ident'>load</span></span></span>&nbsp;&nbsp;&nbsp;&#8594;&nbsp;<span class='symbol'>'load'</span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z564089",this)' onmouseleave='srcref_leave("Z564089",this)'><span><span class='ident'>id</span></span></span><span class='hint'>load(id)</span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span id='Z564081'><span><span class='ident'>apply</span></span></span>&nbsp;&nbsp;&#8594;&nbsp;<span class='symbol'>'use'</span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z564081",this)' onmouseleave='srcref_leave("Z564081",this)'><span><span class='ident'>fn</span></span></span><span class='hint'>apply(purep,fn,args)</span></span><span class='lexic'>,@</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z564081",this)' onmouseleave='srcref_leave("Z564081",this)'><span><span class='ident'>args</span></span></span><span class='hint'>apply(purep,fn,args)</span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span id='Z564069'><span><span class='ident'>mkclosure</span></span></span>&nbsp;&#8594;&nbsp;<span class='symbol'>'use'</span><span class='lexic'>(@</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z564069",this)' onmouseleave='srcref_leave("Z564069",this)'><span><span class='ident'>args</span></span></span><span class='hint'>mkclosure(df,args)</span></span><span class='lexic'>)};</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>value</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z564123'><span><span class='ident'>reg</span></span></span>&nbsp;&nbsp;&nbsp;&nbsp;&#8594;&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z564123",this)' onmouseleave='srcref_leave("Z564123",this)'><span><span class='ident'>id</span></span></span><span class='hint'>reg(id)</span></span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='keyword'>else</span>&nbsp;&nbsp;&nbsp;&#8594;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z564107",this)' onmouseleave='srcref_leave("Z564107",this)'><span><span class='ident'>newlift</span></span></span><span class='lexic'>(</span><span class='ident'>node</span><span class='lexic'>())}};</span><br>
&nbsp;&nbsp;&nbsp;<span id='Z564138'><span><span class='ident'>allocas</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z564135",this)' onmouseleave='srcref_leave("Z564135",this)'><span><span class='ident'>getallocas</span></span></span><span class='lexic'>();</span><br>
&nbsp;&nbsp;&nbsp;<span class='comment'>//&nbsp;Use&nbsp;the&nbsp;library&nbsp;function&nbsp;to&nbsp;run&nbsp;mem2reg&nbsp;pass&nbsp;on&nbsp;a&nbsp;generic&nbsp;SSA:<br>
</span>&nbsp;&nbsp;&nbsp;<span id='Z564139'><span><span class='ident'>nssa</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='ident'>ssa_transform</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z564137",this)' onmouseleave='srcref_leave("Z564137",this)'><span><span class='ident'>gs</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z564138",this)' onmouseleave='srcref_leave("Z564138",this)'><span><span class='ident'>allocas</span></span></span><span class='lexic'>);</span><br>
&nbsp;&nbsp;&nbsp;<span class='keyword'>return</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z563142",this)' onmouseleave='srcref_leave("Z563142",this)'><span><span class='ident'>vals</span></span></span><span class='lexic'>:</span><span class='idfrom' onmouseenter='srcref_over("Z564139",this)' onmouseleave='srcref_leave("Z564139",this)'><span><span class='ident'>nssa</span></span></span><span class='lexic'>}</span>
<p></div>



<h3>Back from the generic SSA</h3>

<p>After the generic SSA transform, we have all allocas, loads and stores
eliminated, new phi nodes introduced and equivalent registers renamed. Now
we have to apply the results back to our original AST.


<p><div class='code'>
<span id='Z564376'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_from_genssa</span><span class='lexic'>(</span><span id='Z565246'><span><span class='ident'>c</span></span></span><span class='lexic'>,</span>&nbsp;<span id='Z565734'><span><span class='ident'>p</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;<span class='lexic'>&lt;</span><span id='Z565056'><span><span class='ident'><span class='pattern'>valsht</span></span></span></span><span class='lexic'><span class='pattern'>:[</span></span><span id='Z565046'><span><span class='ident'><span class='pattern'>vmap</span></span></span></span><span class='lexic'><span class='pattern'>;</span></span><span id='Z565235'><span><span class='ident'><span class='pattern'>ngen</span></span></span></span><span class='lexic'><span class='pattern'>;</span></span><span class='ident'><span class='pattern'>DT</span></span><span class='lexic'><span class='pattern'>]</span></span><span class='lexic'>&gt;</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z565734",this)' onmouseleave='srcref_leave("Z565734",this)'><span><span class='ident'>p</span></span></span><span class='lexic'>;</span><br>
<br>
&nbsp;&nbsp;&nbsp;<span class='comment'>//&nbsp;Generic&nbsp;SSA&nbsp;transform&nbsp;collected&nbsp;register&nbsp;renames,&nbsp;we<br>
</span>&nbsp;&nbsp;&nbsp;<span class='comment'>//&nbsp;have&nbsp;to&nbsp;follow&nbsp;them&nbsp;here.&nbsp;Also,&nbsp;lifted&nbsp;constant&nbsp;values&nbsp;were<br>
</span>&nbsp;&nbsp;&nbsp;<span class='comment'>//&nbsp;given&nbsp;temporary&nbsp;register&nbsp;names&nbsp;in&nbsp;the&nbsp;previous&nbsp;transform,<br>
</span>&nbsp;&nbsp;&nbsp;<span class='comment'>//&nbsp;we&nbsp;have&nbsp;to&nbsp;recover&nbsp;them&nbsp;back.<br>
</span>&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z565053'><span><span class='ident'>getrenamed0</span></span></span><span class='lexic'>(</span><span id='Z565048'><span><span class='ident'>n</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>do</span>&nbsp;<span id='Z565045'><span><span class='ident'>loop</span></span></span><span class='lexic'>(</span><span id='Z565044'><span><span class='ident'>x</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='ident'>ohashget</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z565046",this)' onmouseleave='srcref_leave("Z565046",this)'><span><span class='ident'>vmap</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z565048",this)' onmouseleave='srcref_leave("Z565048",this)'><span><span class='ident'>n</span></span></span><span class='lexic'>),</span>&nbsp;<span id='Z565047'><span><span class='ident'>p</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z565048",this)' onmouseleave='srcref_leave("Z565048",this)'><span><span class='ident'>n</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>if</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z565044",this)' onmouseleave='srcref_leave("Z565044",this)'><span><span class='ident'>x</span></span></span><span class='lexic'>)</span>&nbsp;<span class='keyword'>return</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z565045",this)' onmouseleave='srcref_leave("Z565045",this)'><span><span class='ident'>loop</span></span></span><span class='lexic'>(</span><span class='ident'>ohashget</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z565046",this)' onmouseleave='srcref_leave("Z565046",this)'><span><span class='ident'>vmap</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z565044",this)' onmouseleave='srcref_leave("Z565044",this)'><span><span class='ident'>x</span></span></span><span class='lexic'>),</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z565044",this)' onmouseleave='srcref_leave("Z565044",this)'><span><span class='ident'>x</span></span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>else</span>&nbsp;<span class='keyword'>return</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z565047",this)' onmouseleave='srcref_leave("Z565047",this)'><span><span class='ident'>p</span></span></span>&nbsp;<span class='lexic'>}</span><span class='lexic'>};</span><br>
&nbsp;&nbsp;&nbsp;<span id='Z565196'><span><span class='ident'>getrenamed</span></span></span><span class='lexic'>(</span><span id='Z565054'><span><span class='ident'>n</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='keyword'>with</span>&nbsp;<span class='keyword'>target</span>&nbsp;<span class='lexic'>(</span><span class='ident'>lang0flat2</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z565057'><span><span class='ident'>nreg</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z565053",this)' onmouseleave='srcref_leave("Z565053",this)'><span><span class='ident'>getrenamed0</span></span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z565054",this)' onmouseleave='srcref_leave("Z565054",this)'><span><span class='ident'>n</span></span></span><span class='lexic'>);</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>aif</span><span class='lexic'>(</span><span class='ident'>chk</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='ident'>ohashget</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z565056",this)' onmouseleave='srcref_leave("Z565056",this)'><span><span class='ident'>valsht</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z565057",this)' onmouseleave='srcref_leave("Z565057",this)'><span><span class='ident'>nreg</span></span></span><span class='lexic'>))</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='ident'>chk</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>}</span>&nbsp;<span class='keyword'>else</span>&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>value</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>reg</span><span class='hint'>lang0flat2:value:reg(id)</span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z565057",this)' onmouseleave='srcref_leave("Z565057",this)'><span><span class='ident'>nreg</span></span></span><span class='lexic'>)};</span><br>
<br>
&nbsp;&nbsp;&nbsp;<span id='Z565698'><span><span class='ident'>isrenamed</span></span></span><span class='lexic'>(</span><span id='Z565067'><span><span class='ident'>n</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='ident'>ohashget</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z565046",this)' onmouseleave='srcref_leave("Z565046",this)'><span><span class='ident'>vmap</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z565067",this)' onmouseleave='srcref_leave("Z565067",this)'><span><span class='ident'>n</span></span></span><span class='lexic'>);</span><br>
<br>
&nbsp;&nbsp;&nbsp;<span class='comment'>//&nbsp;Now&nbsp;we&nbsp;can&nbsp;collect&nbsp;the&nbsp;phi&nbsp;nodes&nbsp;from&nbsp;the&nbsp;generic&nbsp;SSA&nbsp;representation,<br>
</span>&nbsp;&nbsp;&nbsp;<span class='comment'>//&nbsp;and&nbsp;then&nbsp;add&nbsp;them&nbsp;to&nbsp;their&nbsp;corresponding&nbsp;source&nbsp;basic&nbsp;blocks.<br>
</span>&nbsp;&nbsp;&nbsp;<span id='Z565207'><span><span class='ident'>phis</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='ident'>mkhash</span><span class='lexic'>();</span><br>
&nbsp;&nbsp;&nbsp;<span id='Z565236'><span><span class='ident'>fillphis</span></span></span><span class='lexic'>()</span>&nbsp;<span class='lexic'>=</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>genssa</span>&nbsp;<span class='lexic'>(</span><span class='ident'>code</span><span class='lexic'>:</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z565235",this)' onmouseleave='srcref_leave("Z565235",this)'><span><span class='ident'>ngen</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>bblock</span>&nbsp;<span class='lexic'>{</span>&nbsp;<span id='Z565107'><span><span class='ident'>b</span></span></span>&nbsp;&#8594;&nbsp;<span class='keyword'>iter</span>&nbsp;<span class='ident'>ops</span>&nbsp;<span class='keyword'>do</span>&nbsp;<span class='ident'>ops</span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z565107",this)' onmouseleave='srcref_leave("Z565107",this)'><span><span class='ident'>name</span></span></span><span class='hint'>b(name,ops,nexts)</span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>};</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>oppair</span>&nbsp;<span class='lexic'>:</span>&nbsp;<span class='keyword'>&lambda;</span><span class='lexic'>(</span><span id='Z565138'><span><span class='ident'>bb</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span>&nbsp;<span class='ident'>op</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z565138",this)' onmouseleave='srcref_leave("Z565138",this)'><span><span class='ident'>bb</span></span></span><span class='lexic'>,</span>&nbsp;<span class='ident'>name</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>}</span><span class='lexic'>;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>iop</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z565175'><span><span class='ident'>phi</span></span></span>&nbsp;&#8594;&nbsp;<span class='keyword'>&lambda;</span><span class='lexic'>(</span><span id='Z565208'><span><span class='ident'>bb</span></span></span><span class='lexic'>,</span>&nbsp;<span id='Z565168'><span><span class='ident'>tgt</span></span></span><span class='lexic'>)</span>&nbsp;<span class='keyword'>with</span>&nbsp;<span class='keyword'>target</span>&nbsp;<span class='lexic'>(</span><span class='ident'>lang0flat2</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z565209'><span><span class='ident'>nphi</span></span></span>&nbsp;<span class='lexic'>=</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>insn</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>def</span><span class='hint'>lang0flat2:insn:def(id,v)</span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z565168",this)' onmouseleave='srcref_leave("Z565168",this)'><span><span class='ident'>tgt</span></span></span><span class='lexic'>,</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='ident'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>phi</span><span class='hint'>lang0flat2:expr:phi(ss)</span></span><span class='lexic'>(</span><span class='ident'>ss</span>&nbsp;<span class='lexic'>=</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>map</span>&nbsp;<span class='lexic'>[</span><span id='Z565195'><span><span class='ident'><span class='pattern'>f</span></span></span></span><span class='lexic'>;</span><span id='Z565197'><span><span class='ident'><span class='pattern'>v</span></span></span></span><span class='lexic'>]</span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='withhint'><span class='ident'>zip</span><span class='hint'>function&nbsp;zip&nbsp;a,&nbsp;b:&nbsp;<br>
Returns&nbsp;the&nbsp;list&nbsp;of&nbsp;($a_i${}&nbsp;$b_i$)&nbsp;for&nbsp;all&nbsp;elements&nbsp;of&nbsp;[a]&nbsp;and&nbsp;[b].</span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z565175",this)' onmouseleave='srcref_leave("Z565175",this)'><span><span class='ident'>prevs</span></span></span><span class='hint'>phi(orig,prevs,vals)</span></span><span class='lexic'>,</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z565175",this)' onmouseleave='srcref_leave("Z565175",this)'><span><span class='ident'>vals</span></span></span><span class='hint'>phi(orig,prevs,vals)</span></span><span class='lexic'>)</span>&nbsp;<span class='keyword'>do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>s</span><span class='hint'>lang0flat2:phisrc:s(from,v)</span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z565195",this)' onmouseleave='srcref_leave("Z565195",this)'><span><span class='ident'>f</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z565196",this)' onmouseleave='srcref_leave("Z565196",this)'><span><span class='ident'>getrenamed</span></span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z565197",this)' onmouseleave='srcref_leave("Z565197",this)'><span><span class='ident'>v</span></span></span><span class='lexic'>))));</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='ident'>ohashput</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z565207",this)' onmouseleave='srcref_leave("Z565207",this)'><span><span class='ident'>phis</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z565208",this)' onmouseleave='srcref_leave("Z565208",this)'><span><span class='ident'>bb</span></span></span><span class='lexic'>,</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='ident'>ohashget</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z565207",this)' onmouseleave='srcref_leave("Z565207",this)'><span><span class='ident'>phis</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z565208",this)' onmouseleave='srcref_leave("Z565208",this)'><span><span class='ident'>bb</span></span></span><span class='lexic'>)</span><span class='lexic'>&#8853;</span><span class='lexic'>[</span><span class='idfrom' onmouseenter='srcref_over("Z565209",this)' onmouseleave='srcref_leave("Z565209",this)'><span><span class='ident'>nphi</span></span></span><span class='lexic'>])}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='keyword'>&lambda;</span><span class='lexic'>(</span><span class='ident'>bb</span><span class='lexic'>,</span>&nbsp;<span class='ident'>tgt</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>&#8709;</span>&nbsp;<span class='lexic'>}};</span><br>
&nbsp;&nbsp;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z565236",this)' onmouseleave='srcref_leave("Z565236",this)'><span><span class='ident'>fillphis</span></span></span><span class='lexic'>();</span><br>
&nbsp;&nbsp;&nbsp;<span id='Z565661'><span><span class='ident'>getphis</span></span></span><span class='lexic'>(</span><span id='Z565240'><span><span class='ident'>lbl</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='ident'>ohashget</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z565207",this)' onmouseleave='srcref_leave("Z565207",this)'><span><span class='ident'>phis</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z565240",this)' onmouseleave='srcref_leave("Z565240",this)'><span><span class='ident'>lbl</span></span></span><span class='lexic'>);</span><br>
<br>
&nbsp;&nbsp;&nbsp;<span class='comment'>//&nbsp;Apply&nbsp;all&nbsp;the&nbsp;changes&nbsp;to&nbsp;the&nbsp;original&nbsp;lang0flat2&nbsp;code<br>
</span>&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0flat2</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>code</span><span class='lexic'>:</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z565246",this)' onmouseleave='srcref_leave("Z565246",this)'><span><span class='ident'>c</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>bblock</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z565662'><span><span class='ident'>bb</span></span></span>&nbsp;&#8594;&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z565668'><span><span class='ident'>phis</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z565661",this)' onmouseleave='srcref_leave("Z565661",this)'><span><span class='ident'>getphis</span></span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z565662",this)' onmouseleave='srcref_leave("Z565662",this)'><span><span class='ident'>lbl</span></span></span><span class='hint'>bb(lbl,body,t)</span></span><span class='lexic'>);</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='keyword'>node</span><span class='hint'>lang0flat2:bblock:bb(lbl,body,t)<br>
&nbsp;&nbsp;&nbsp;with&nbsp;implicit&nbsp;arguments:&nbsp;lbl,&nbsp;t<br>
</span></span><span class='lexic'>(</span><span class='ident'>body</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z565668",this)' onmouseleave='srcref_leave("Z565668",this)'><span><span class='ident'>phis</span></span></span>&nbsp;<span class='lexic'>&#8853;</span>&nbsp;<span class='keyword'>map</span>&nbsp;<span class='keyword'>append</span>&nbsp;<span id='Z565682'><span><span class='ident'>b</span></span></span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z565662",this)' onmouseleave='srcref_leave("Z565662",this)'><span><span class='ident'>body</span></span></span><span class='hint'>bb(lbl,body,t)</span></span>&nbsp;<span class='keyword'>do</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z565682",this)' onmouseleave='srcref_leave("Z565682",this)'><span><span class='ident'>b</span></span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>}};</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>insn</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='ident'>alloca</span>&nbsp;&#8594;&nbsp;<span class='lexic'>&#8709;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;&nbsp;<span class='ident'>set</span>&nbsp;&#8594;&nbsp;<span class='lexic'>&#8709;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;&nbsp;<span id='Z565699'><span><span class='ident'>def</span></span></span>&nbsp;&#8594;&nbsp;<span class='keyword'>if</span>&nbsp;<span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z565698",this)' onmouseleave='srcref_leave("Z565698",this)'><span><span class='ident'>isrenamed</span></span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z565699",this)' onmouseleave='srcref_leave("Z565699",this)'><span><span class='ident'>id</span></span></span><span class='hint'>def(id,v)</span></span><span class='lexic'>))</span>&nbsp;<span class='lexic'>&#8709;</span>&nbsp;<span class='keyword'>else</span>&nbsp;<span class='lexic'>[</span><span class='ident'>node</span><span class='lexic'>()]</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='lexic'>[</span><span class='ident'>node</span><span class='lexic'>()]};</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>value</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z565723'><span><span class='ident'>reg</span></span></span>&nbsp;&#8594;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z565196",this)' onmouseleave='srcref_leave("Z565196",this)'><span><span class='ident'>getrenamed</span></span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z565723",this)' onmouseleave='srcref_leave("Z565723",this)'><span><span class='ident'>id</span></span></span><span class='hint'>reg(id)</span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='ident'>node</span><span class='lexic'>()}}}</span>
<p></div>


<p>And a simple wrapper function to run the generic SSA transform over top level entries:


<p><div class='code'>
<span id='Z565993'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_genssa</span><span class='lexic'>(</span><span id='Z566169'><span><span class='ident'>ts</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;<span class='keyword'>map</span>&nbsp;<span id='Z566177'><span><span class='ident'>t</span></span></span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z566169",this)' onmouseleave='srcref_leave("Z566169",this)'><span><span class='ident'>ts</span></span></span>&nbsp;<span class='keyword'>do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0flat2</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>top</span><span class='lexic'>:</span><span class='idfrom' onmouseenter='srcref_over("Z566177",this)' onmouseleave='srcref_leave("Z566177",this)'><span><span class='ident'>t</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>once</span>&nbsp;<span class='ident'>code</span>&nbsp;<span class='lexic'>{</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<a href='#Z564376'><span class='ident'>l0_from_genssa</span></a><span class='lexic'>(</span><span class='ident'>node</span><span class='lexic'>(),</span>&nbsp;<a href='#Z562149'><span class='ident'>l0_to_genssa</span></a><span class='lexic'>(</span><span class='ident'>node</span><span class='lexic'>()))</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>}}}</span>
<p></div>


<h3>Everything to this point</h3>


<p><div class='code'>
<span id='Z566372'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_genssa_driver</span><span class='lexic'>(</span><span id='Z566375'><span><span class='ident'>src</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;<span id='Z566377'><span><span class='ident'>x3</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<a href='#Z554197'><span class='ident'>l0_flatten_driver</span></a><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z566375",this)' onmouseleave='srcref_leave("Z566375",this)'><span><span class='ident'>src</span></span></span><span class='lexic'>);</span><br>
&nbsp;&nbsp;<span id='Z566379'><span><span class='ident'>x4</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<a href='#Z559462'><span class='ident'>l0_basic_blocks</span></a><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z566377",this)' onmouseleave='srcref_leave("Z566377",this)'><span><span class='ident'>x3</span></span></span><span class='lexic'>);</span><br>
&nbsp;&nbsp;<span id='Z566380'><span><span class='ident'>x5</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<a href='#Z565993'><span class='ident'>l0_genssa</span></a><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z566379",this)' onmouseleave='srcref_leave("Z566379",this)'><span><span class='ident'>x4</span></span></span><span class='lexic'>);</span><br>
&nbsp;&nbsp;<span class='keyword'>return</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z566380",this)' onmouseleave='srcref_leave("Z566380",this)'><span><span class='ident'>x5</span></span></span><span class='lexic'>;</span><br>
<span class='lexic'>}</span>
<p></div>


<p>Now, back from the generic SSA, our foldl function looks like this:









   

<p><div class='democode'>
<span class='lexic'>(</span><span class='ident'>sfunction</span>&nbsp;<span class='keyword'>foldl</span>&nbsp;<span class='lexic'>(</span><span class='ident'>Z567409</span>&nbsp;<span class='ident'>Z567410</span>&nbsp;<span class='ident'>Z567411</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>(</span><span class='ident'>c</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>bb</span>&nbsp;<span class='ident'>entry</span>&nbsp;<span class='lexic'>()</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>goto</span>&nbsp;<span class='ident'>tailrecentry</span><span class='lexic'>))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>bb</span>&nbsp;<span class='ident'>tailrecentry</span>&nbsp;<span class='lexic'>(</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>def</span>&nbsp;<span class='ident'>Z567446</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>phi</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>s</span>&nbsp;<span class='ident'>Z567428</span>&nbsp;<span class='lexic'>(</span><span class='ident'>reg</span>&nbsp;<span class='ident'>Z567417</span><span class='lexic'>))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>s</span>&nbsp;<span class='ident'>entry</span>&nbsp;<span class='lexic'>(</span><span class='ident'>arg</span>&nbsp;<span class='ident'>Z567411</span><span class='lexic'>))))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>def</span>&nbsp;<span class='ident'>Z567445</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>phi</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>s</span>&nbsp;<span class='ident'>Z567428</span>&nbsp;<span class='lexic'>(</span><span class='ident'>reg</span>&nbsp;<span class='ident'>Z567420</span><span class='lexic'>))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>s</span>&nbsp;<span class='ident'>entry</span>&nbsp;<span class='lexic'>(</span><span class='ident'>arg</span>&nbsp;<span class='ident'>Z567410</span><span class='lexic'>))))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>def</span>&nbsp;<span class='ident'>Z567444</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>phi</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>s</span>&nbsp;<span class='ident'>Z567428</span>&nbsp;<span class='lexic'>(</span><span class='ident'>reg</span>&nbsp;<span class='ident'>Z567444</span><span class='lexic'>))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>s</span>&nbsp;<span class='ident'>entry</span>&nbsp;<span class='lexic'>(</span><span class='ident'>arg</span>&nbsp;<span class='ident'>Z567409</span><span class='lexic'>))))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>def</span>&nbsp;<span class='ident'>Z567425</span>&nbsp;<span class='lexic'>(</span><span class='keyword'>apply</span>&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>global</span>&nbsp;<span class='ident'>nullp</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>(</span><span class='ident'>reg</span>&nbsp;<span class='ident'>Z567446</span><span class='lexic'>))))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>gotoc</span>&nbsp;<span class='lexic'>(</span><span class='ident'>reg</span>&nbsp;<span class='ident'>Z567425</span><span class='lexic'>)</span>&nbsp;<span class='ident'>Z567427</span>&nbsp;<span class='ident'>Z567428</span><span class='lexic'>))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>bb</span>&nbsp;<span class='ident'>Z567427</span>&nbsp;<span class='lexic'>()</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(return</span>&nbsp;<span class='lexic'>(</span><span class='ident'>reg</span>&nbsp;<span class='ident'>Z567445</span><span class='lexic'>)))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>bb</span>&nbsp;<span class='ident'>Z567428</span>&nbsp;<span class='lexic'>(</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>def</span>&nbsp;<span class='ident'>Z567415</span>&nbsp;<span class='lexic'>(</span><span class='keyword'>apply</span>&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>global</span>&nbsp;<span class='ident'>head</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>(</span><span class='ident'>reg</span>&nbsp;<span class='ident'>Z567446</span><span class='lexic'>)))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>def</span>&nbsp;<span class='ident'>Z567417</span>&nbsp;<span class='lexic'>(</span><span class='keyword'>apply</span>&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>global</span>&nbsp;<span class='ident'>tail</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>(</span><span class='ident'>reg</span>&nbsp;<span class='ident'>Z567446</span><span class='lexic'>)))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>def</span>&nbsp;<span class='ident'>Z567420</span>&nbsp;<span class='lexic'>(</span><span class='keyword'>apply</span>&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>reg</span>&nbsp;<span class='ident'>Z567444</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>(</span><span class='ident'>reg</span>&nbsp;<span class='ident'>Z567445</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>(</span><span class='ident'>reg</span>&nbsp;<span class='ident'>Z567415</span><span class='lexic'>))))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>goto</span>&nbsp;<span class='ident'>tailrecentry</span><span class='lexic'>))))</span><br>

</div><p>


<p>And a control flow graph for this example is following:

<p><div class='democode'><object data="foldl_lang0flat2.svg" type="image/svg+xml" style="transform: scale(0.5);"></object></div>








<h2 id='abstract'>Abstract SSA</h2>

<p>The next few sections are entirely optional. We already have an IR suitable
for code generation, but also fit for SSA-based optimisations. MBase provides an
abstract SSA library which, with a help of a user--defined IR model, provide,
among others, the following transforms:

<ul>
<li> Constant folding
<li> ADCE
<li> CFG simplification
<li> Loop analysis
<li> Loop invariant motion
<li> Loop unrolling
<li> Common subexpression elimination
</ul>

<p>For the implementation details see <a href="ssa-fold.pdf">ssa-fold.pdf</a>.

<p>Some of these optimisations are enabling and may be useful for our code
generation even if the target platform is capable of doing the similar
optimisations on a lower level.

<p>Keep in mind that Abstract SSA is an old, list--form AST, and by converting
our nice recform AST into it we're discarding any associated metadata (most
importantly, source code locations). Also, some semantics is lost and must be
recovered on a way back (e.g., both arguments and closure variables are
represented as registers).

<p>We did not have any <b>select</b> instructions before, but they may appear
after the Abstract SSA optimisations.  Backend must be aware of this.




<p><div class='code'>
<span id='Z567449'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_to_abstract_ssa_code</span><span class='lexic'>(</span><span id='Z567970'><span><span class='ident'>c</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;<span id='Z567961'><span><span class='ident'>isintrinsicfn</span></span></span><span class='lexic'>(</span><span id='Z567949'><span><span class='ident'>id</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>case</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z567949",this)' onmouseleave='srcref_leave("Z567949",this)'><span><span class='ident'>id</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='symbol'>'binopadd'</span>&nbsp;<span class='lexic'>|</span>&nbsp;<span class='symbol'>'binopsub'</span>&nbsp;<span class='lexic'>|</span>&nbsp;<span class='symbol'>'binopmul'</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='symbol'>'binopdiv'</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='symbol'>'binopeq'</span>&nbsp;<span class='lexic'>|</span>&nbsp;<span class='symbol'>'binopneq'</span>&nbsp;&#8594;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z567949",this)' onmouseleave='srcref_leave("Z567949",this)'><span><span class='ident'>id</span></span></span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='lexic'>&#8709;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>}};</span><br>
&nbsp;&nbsp;<span id='Z568423'><span><span class='ident'>isintrinsic</span></span></span><span class='lexic'>(</span><span id='Z567964'><span><span class='ident'>f</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>=</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>{</span><span class='keyword'>match</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z567964",this)' onmouseleave='srcref_leave("Z567964",this)'><span><span class='ident'>f</span></span></span>&nbsp;<span class='keyword'>with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='symbol'><span class='pattern'>'glob'</span></span><span class='lexic'><span class='pattern'>(</span></span><span id='Z567962'><span><span class='ident'><span class='pattern'>id</span></span></span></span><span class='lexic'><span class='pattern'>)</span></span>&nbsp;&#8594;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z567961",this)' onmouseleave='srcref_leave("Z567961",this)'><span><span class='ident'>isintrinsicfn</span></span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z567962",this)' onmouseleave='srcref_leave("Z567962",this)'><span><span class='ident'>id</span></span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'><span class='pattern'>else</span></span>&nbsp;&#8594;&nbsp;<span class='lexic'>&#8709;</span><span class='lexic'>};</span><br>
&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0flat2</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>code</span><span class='lexic'>:</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z567970",this)' onmouseleave='srcref_leave("Z567970",this)'><span><span class='ident'>c</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>code</span>&nbsp;<span class='lexic'>{</span>&nbsp;<span id='Z568318'><span><span class='ident'>c</span></span></span>&nbsp;&#8594;&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z568318",this)' onmouseleave='srcref_leave("Z568318",this)'><span><span class='ident'>bs</span></span></span><span class='hint'>c(bs)</span></span>&nbsp;<span class='lexic'>};</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>bblock</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z568337'><span><span class='ident'>bb</span></span></span>&nbsp;&#8594;&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>&lt;</span><span id='Z568342'><span><span class='ident'><span class='pattern'>te</span></span></span></span><span class='lexic'><span class='pattern'>:</span></span><span id='Z568343'><span><span class='ident'><span class='pattern'>t1</span></span></span></span><span class='lexic'>&gt;</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z568337",this)' onmouseleave='srcref_leave("Z568337",this)'><span><span class='ident'>t</span></span></span><span class='hint'>bb(lbl,body,t)</span></span><span class='lexic'>;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='symbol'>'b'</span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z568337",this)' onmouseleave='srcref_leave("Z568337",this)'><span><span class='ident'>lbl</span></span></span><span class='hint'>bb(lbl,body,t)</span></span><span class='lexic'>,</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z568337",this)' onmouseleave='srcref_leave("Z568337",this)'><span><span class='ident'>body</span></span></span><span class='hint'>bb(lbl,body,t)</span></span><span class='lexic'>&#8853;</span><span class='idfrom' onmouseenter='srcref_over("Z568342",this)' onmouseleave='srcref_leave("Z568342",this)'><span><span class='ident'>te</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z568343",this)' onmouseleave='srcref_leave("Z568343",this)'><span><span class='ident'>t1</span></span></span><span class='lexic'>)}};</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>insn</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z568355'><span><span class='ident'>def</span></span></span>&nbsp;&#8594;&nbsp;<span class='lexic'>[</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z568355",this)' onmouseleave='srcref_leave("Z568355",this)'><span><span class='ident'>id</span></span></span><span class='hint'>def(id,v)</span></span><span class='lexic'>;</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z568355",this)' onmouseleave='srcref_leave("Z568355",this)'><span><span class='ident'>v</span></span></span><span class='hint'>def(id,v)</span></span><span class='lexic'>]</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='withhint'><span class='ident'>ccerror</span><span class='hint'>function&nbsp;ccerror&nbsp;arg:&nbsp;<br>
Raises&nbsp;[MBaseException]&nbsp;with&nbsp;a&nbsp;given&nbsp;argument.</span></span><span class='lexic'>(</span><span class='symbol'>'IMPOSSIBLE'</span><span class='lexic'>())};</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>term</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z568377'><span><span class='ident'>goto</span></span></span>&nbsp;&#8594;&nbsp;<span class='lexic'>&#8709;</span><span class='lexic'>:</span><span class='symbol'>'br'</span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z568377",this)' onmouseleave='srcref_leave("Z568377",this)'><span><span class='ident'>id</span></span></span><span class='hint'>goto(id)</span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span id='Z568389'><span><span class='ident'>gotoc</span></span></span>&nbsp;&#8594;&nbsp;<span class='lexic'>&#8709;</span><span class='lexic'>:</span><span class='symbol'>'brc'</span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z568389",this)' onmouseleave='srcref_leave("Z568389",this)'><span><span class='ident'>cnd</span></span></span><span class='hint'>gotoc(cnd,tr,fl)</span></span><span class='lexic'>,</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z568389",this)' onmouseleave='srcref_leave("Z568389",this)'><span><span class='ident'>tr</span></span></span><span class='hint'>gotoc(cnd,tr,fl)</span></span><span class='lexic'>,</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z568389",this)' onmouseleave='srcref_leave("Z568389",this)'><span><span class='ident'>fl</span></span></span><span class='hint'>gotoc(cnd,tr,fl)</span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span id='Z568399'><span><span class='ident'>return</span></span></span>&nbsp;&#8594;&nbsp;<span class='lexic'>[[</span><span class='withhint'><span class='ident'>gensym</span><span class='hint'>function&nbsp;gensym&nbsp;:&nbsp;<br>
Returns&nbsp;a&nbsp;unique&nbsp;symbol&nbsp;every&nbsp;time&nbsp;it&nbsp;is&nbsp;called.<br>
Uniqueness&nbsp;is&nbsp;guaranteed&nbsp;within&nbsp;one&nbsp;run&nbsp;only.</span></span><span class='lexic'>();</span><span class='symbol'>'call'</span><span class='lexic'>([</span><span class='symbol'>'other'</span><span class='lexic'>(</span><span class='symbol'>'src'</span><span class='lexic'>(</span><span class='ident'>thisnodesrc</span><span class='lexic'>()))],</span>&nbsp;<span class='symbol'>'*return*'</span><span class='lexic'>,</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z568399",this)' onmouseleave='srcref_leave("Z568399",this)'><span><span class='ident'>v</span></span></span><span class='hint'>return(v)</span></span><span class='lexic'>)]]:</span><span class='symbol'>'none'</span><span class='lexic'>()</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span id='Z568371'><span><span class='ident'>tail</span></span></span>&nbsp;&#8594;&nbsp;<span class='keyword'>symbols</span><span class='lexic'>(</span><span id='Z568370'><span><span class='ident'>ret</span></span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>[[</span><span class='idfrom' onmouseenter='srcref_over("Z568370",this)' onmouseleave='srcref_leave("Z568370",this)'><span><span class='ident'>ret</span></span></span><span class='lexic'>;</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z568371",this)' onmouseleave='srcref_leave("Z568371",this)'><span><span class='ident'>e</span></span></span><span class='hint'>tail(e)</span></span><span class='lexic'>];</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>[</span><span class='withhint'><span class='ident'>gensym</span><span class='hint'>function&nbsp;gensym&nbsp;:&nbsp;<br>
Returns&nbsp;a&nbsp;unique&nbsp;symbol&nbsp;every&nbsp;time&nbsp;it&nbsp;is&nbsp;called.<br>
Uniqueness&nbsp;is&nbsp;guaranteed&nbsp;within&nbsp;one&nbsp;run&nbsp;only.</span></span><span class='lexic'>();</span><span class='symbol'>'call'</span><span class='lexic'>([</span><span class='symbol'>'other'</span><span class='lexic'>(</span><span class='symbol'>'src'</span><span class='lexic'>(</span><span class='ident'>thisnodesrc</span><span class='lexic'>()))],</span>&nbsp;<span class='symbol'>'*tailreturn*'</span><span class='lexic'>,</span>&nbsp;<span class='symbol'>'var'</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z568370",this)' onmouseleave='srcref_leave("Z568370",this)'><span><span class='ident'>ret</span></span></span><span class='lexic'>))]]:</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='symbol'>'none'</span><span class='lexic'>()};</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>expr</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z568408'><span><span class='ident'>mkclosure</span></span></span>&nbsp;&#8594;&nbsp;<span class='symbol'>'call'</span><span class='lexic'>([</span><span class='symbol'>'other'</span><span class='lexic'>(</span><span class='symbol'>'src'</span><span class='lexic'>(</span><span class='ident'>thisnodesrc</span><span class='lexic'>()))],</span>&nbsp;<span class='symbol'>'*mkclosure*'</span><span class='lexic'>,</span>&nbsp;<span class='symbol'>'glob'</span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z568408",this)' onmouseleave='srcref_leave("Z568408",this)'><span><span class='ident'>df</span></span></span><span class='hint'>mkclosure(df,args)</span></span><span class='lexic'>),@</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z568408",this)' onmouseleave='srcref_leave("Z568408",this)'><span><span class='ident'>args</span></span></span><span class='hint'>mkclosure(df,args)</span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span id='Z568424'><span><span class='ident'>apply</span></span></span>&nbsp;&#8594;&nbsp;<span class='keyword'>aif</span>&nbsp;<span class='lexic'>(</span><span class='ident'>intr</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z568423",this)' onmouseleave='srcref_leave("Z568423",this)'><span><span class='ident'>isintrinsic</span></span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z568424",this)' onmouseleave='srcref_leave("Z568424",this)'><span><span class='ident'>fn</span></span></span><span class='hint'>apply(purep,fn,args)</span></span><span class='lexic'>))</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='symbol'>'call'</span><span class='lexic'>([</span><span class='symbol'>'other'</span><span class='lexic'>(</span><span class='symbol'>'src'</span><span class='lexic'>(</span><span class='ident'>thisnodesrc</span><span class='lexic'>()))],</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='ident'>intr</span><span class='lexic'>,</span>&nbsp;<span class='lexic'>@</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z568424",this)' onmouseleave='srcref_leave("Z568424",this)'><span><span class='ident'>args</span></span></span><span class='hint'>apply(purep,fn,args)</span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>}</span>&nbsp;<span class='keyword'>else</span>&nbsp;<span class='symbol'>'call'</span><span class='lexic'>([</span><span class='symbol'>'other'</span><span class='lexic'>(</span><span class='symbol'>'src'</span><span class='lexic'>(</span><span class='ident'>thisnodesrc</span><span class='lexic'>()))],</span>&nbsp;<span class='symbol'>'*funcall*'</span><span class='lexic'>,</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z568424",this)' onmouseleave='srcref_leave("Z568424",this)'><span><span class='ident'>fn</span></span></span><span class='hint'>apply(purep,fn,args)</span></span><span class='lexic'>,</span>&nbsp;<span class='lexic'>@</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z568424",this)' onmouseleave='srcref_leave("Z568424",this)'><span><span class='ident'>args</span></span></span><span class='hint'>apply(purep,fn,args)</span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>load</span>&nbsp;&#8594;&nbsp;<span class='withhint'><span class='ident'>ccerror</span><span class='hint'>function&nbsp;ccerror&nbsp;arg:&nbsp;<br>
Raises&nbsp;[MBaseException]&nbsp;with&nbsp;a&nbsp;given&nbsp;argument.</span></span><span class='lexic'>(</span><span class='symbol'>'IMPOSSIBLE'</span><span class='lexic'>())</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span id='Z568439'><span><span class='ident'>phi</span></span></span>&nbsp;&#8594;&nbsp;<span class='symbol'>'phi'</span><span class='lexic'>(@</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z568439",this)' onmouseleave='srcref_leave("Z568439",this)'><span><span class='ident'>ss</span></span></span><span class='hint'>phi(ss)</span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span id='Z568451'><span><span class='ident'>select</span></span></span>&nbsp;&#8594;&nbsp;<span class='symbol'>'select'</span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z568451",this)' onmouseleave='srcref_leave("Z568451",this)'><span><span class='ident'>cnd</span></span></span><span class='hint'>select(cnd,tr,fl)</span></span><span class='lexic'>,</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z568451",this)' onmouseleave='srcref_leave("Z568451",this)'><span><span class='ident'>tr</span></span></span><span class='hint'>select(cnd,tr,fl)</span></span><span class='lexic'>,</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z568451",this)' onmouseleave='srcref_leave("Z568451",this)'><span><span class='ident'>fl</span></span></span><span class='hint'>select(cnd,tr,fl)</span></span><span class='lexic'>)};</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>phisrc</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z568467'><span><span class='ident'>s</span></span></span>&nbsp;&#8594;&nbsp;<span class='symbol'>'a'</span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z568467",this)' onmouseleave='srcref_leave("Z568467",this)'><span><span class='ident'>from</span></span></span><span class='hint'>s(from,v)</span></span><span class='lexic'>,</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z568467",this)' onmouseleave='srcref_leave("Z568467",this)'><span><span class='ident'>v</span></span></span><span class='hint'>s(from,v)</span></span><span class='lexic'>)};</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>value</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z568475'><span><span class='ident'>const</span></span></span>&nbsp;&#8594;&nbsp;<span class='symbol'>'const'</span><span class='lexic'>(</span><span class='symbol'>'any'</span><span class='lexic'>(),</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z568475",this)' onmouseleave='srcref_leave("Z568475",this)'><span><span class='ident'>c</span></span></span><span class='hint'>const(c)</span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span id='Z568481'><span><span class='ident'>global</span></span></span>&nbsp;&#8594;&nbsp;<span class='symbol'>'glob'</span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z568481",this)' onmouseleave='srcref_leave("Z568481",this)'><span><span class='ident'>id</span></span></span><span class='hint'>global(id)</span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span id='Z568487'><span><span class='ident'>arg</span></span></span>&nbsp;&#8594;&nbsp;<span class='symbol'>'var'</span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z568487",this)' onmouseleave='srcref_leave("Z568487",this)'><span><span class='ident'>id</span></span></span><span class='hint'>arg(id)</span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span id='Z568493'><span><span class='ident'>clvar</span></span></span>&nbsp;&#8594;&nbsp;<span class='symbol'>'var'</span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z568493",this)' onmouseleave='srcref_leave("Z568493",this)'><span><span class='ident'>id</span></span></span><span class='hint'>clvar(id)</span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span id='Z568499'><span><span class='ident'>reg</span></span></span>&nbsp;&#8594;&nbsp;<span class='symbol'>'var'</span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z568499",this)' onmouseleave='srcref_leave("Z568499",this)'><span><span class='ident'>id</span></span></span><span class='hint'>reg(id)</span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span id='Z568505'><span><span class='ident'>funref</span></span></span>&nbsp;&#8594;&nbsp;<span class='symbol'>'glob'</span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z568505",this)' onmouseleave='srcref_leave("Z568505",this)'><span><span class='ident'>id</span></span></span><span class='hint'>funref(id)</span></span><span class='lexic'>)}}}</span>
<p></div>




<p><div class='code'>
<span id='Z568672'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_to_abstract_ssa</span><span class='lexic'>(</span><span id='Z568848'><span><span class='ident'>ts</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;<span class='keyword'>map</span>&nbsp;<span class='keyword'>append</span>&nbsp;<span id='Z568856'><span><span class='ident'>t</span></span></span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z568848",this)' onmouseleave='srcref_leave("Z568848",this)'><span><span class='ident'>ts</span></span></span>&nbsp;<span class='keyword'>do</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0flat2</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>top</span><span class='lexic'>:</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z568856",this)' onmouseleave='srcref_leave("Z568856",this)'><span><span class='ident'>t</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>top</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z568964'><span><span class='ident'>sfunction</span></span></span>&nbsp;&#8594;&nbsp;<span class='lexic'>[</span><span class='symbol'>'f'</span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z568964",this)' onmouseleave='srcref_leave("Z568964",this)'><span><span class='ident'>id</span></span></span><span class='hint'>sfunction(id,args,body)</span></span><span class='lexic'>,</span>&nbsp;<span class='symbol'>'any'</span><span class='lexic'>(),</span>&nbsp;<span class='keyword'>map</span>&nbsp;<span id='Z568974'><span><span class='ident'>a</span></span></span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z568964",this)' onmouseleave='srcref_leave("Z568964",this)'><span><span class='ident'>args</span></span></span><span class='hint'>sfunction(id,args,body)</span></span>&nbsp;<span class='keyword'>do</span>&nbsp;<span class='lexic'>[</span><span class='symbol'>'any'</span><span class='lexic'>();</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z568974",this)' onmouseleave='srcref_leave("Z568974",this)'><span><span class='ident'>a</span></span></span><span class='lexic'>],</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href='#Z567449'><span class='ident'>l0_to_abstract_ssa_code</span></a><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z568964",this)' onmouseleave='srcref_leave("Z568964",this)'><span><span class='ident'>body</span></span></span><span class='hint'>sfunction(id,args,body)</span></span><span class='lexic'>))]</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span id='Z568989'><span><span class='ident'>closure</span></span></span>&nbsp;&#8594;&nbsp;<span class='lexic'>[</span><span class='symbol'>'f'</span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z568989",this)' onmouseleave='srcref_leave("Z568989",this)'><span><span class='ident'>id</span></span></span><span class='hint'>closure(id,clargs,args,body)</span></span><span class='lexic'>,</span>&nbsp;<span class='symbol'>'any'</span><span class='lexic'>(),</span>&nbsp;<span class='lexic'>[@</span><span class='keyword'>map</span>&nbsp;<span id='Z568999'><span><span class='ident'>a</span></span></span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z568989",this)' onmouseleave='srcref_leave("Z568989",this)'><span><span class='ident'>args</span></span></span><span class='hint'>closure(id,clargs,args,body)</span></span>&nbsp;<span class='keyword'>do</span>&nbsp;<span class='lexic'>[</span><span class='symbol'>'any'</span><span class='lexic'>();</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z568999",this)' onmouseleave='srcref_leave("Z568999",this)'><span><span class='ident'>a</span></span></span><span class='lexic'>];</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>@</span><span class='keyword'>map</span>&nbsp;<span id='Z569007'><span><span class='ident'>a</span></span></span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z568989",this)' onmouseleave='srcref_leave("Z568989",this)'><span><span class='ident'>clargs</span></span></span><span class='hint'>closure(id,clargs,args,body)</span></span>&nbsp;<span class='keyword'>do</span>&nbsp;<span class='lexic'>[</span><span class='symbol'>'any'</span><span class='lexic'>();</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z569007",this)' onmouseleave='srcref_leave("Z569007",this)'><span><span class='ident'>a</span></span></span><span class='lexic'>]],</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href='#Z567449'><span class='ident'>l0_to_abstract_ssa_code</span></a><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z568989",this)' onmouseleave='srcref_leave("Z568989",this)'><span><span class='ident'>body</span></span></span><span class='hint'>closure(id,clargs,args,body)</span></span><span class='lexic'>))]</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='lexic'>&#8709;</span><span class='lexic'>}}}</span>
<p></div>

     

<h3>Model</h3>

<p> Abstract SSA implementation is IR-agnostic and therefore must be provided
with some hints about the nature of this particular IR. We have to be able to
tell pure intrinsics from those that might have some side effects in order to
get the constant folding working. We have to provide a way to evaluate those
intrinsics when all of their arguments are constant. We must tell how to create
a boolean constant and how to tell if a constant is a boolean truth. All such
things are forming a model which compliments abstract SSA passes.


<p><div class='code'>
<span id='Z569073'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_make_model</span><span class='lexic'>()</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;<span id='Z569426'><span><span class='ident'>ht</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='ident'>mkhash</span><span class='lexic'>();</span><br>
<br>
&nbsp;&nbsp;&nbsp;<span id='Z569321'><span><span class='ident'>getconst</span></span></span><span class='lexic'>(</span><span id='Z569238'><span><span class='ident'>c</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z569244'><span><span class='ident'>vc</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='lexic'>(</span><span class='keyword'>match</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z569238",this)' onmouseleave='srcref_leave("Z569238",this)'><span><span class='ident'>c</span></span></span>&nbsp;<span class='keyword'>with</span>&nbsp;<span class='symbol'><span class='pattern'>'const'</span></span><span class='lexic'><span class='pattern'>(</span></span><span class='ident'><span class='pattern'>tp</span></span><span class='lexic'><span class='pattern'>,</span></span><span class='pattern'>&nbsp;</span><span id='Z569237'><span><span class='ident'><span class='pattern'>v</span></span></span></span><span class='lexic'><span class='pattern'>)</span></span>&nbsp;&#8594;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z569237",this)' onmouseleave='srcref_leave("Z569237",this)'><span><span class='ident'>v</span></span></span><span class='lexic'>);</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0flat2</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>const</span><span class='lexic'>:</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z569244",this)' onmouseleave='srcref_leave("Z569244",this)'><span><span class='ident'>vc</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>once</span>&nbsp;<span class='ident'>const</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z569298'><span><span class='ident'>number</span></span></span>&nbsp;&#8594;&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z569298",this)' onmouseleave='srcref_leave("Z569298",this)'><span><span class='ident'>n</span></span></span><span class='hint'>number(n)</span></span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span id='Z569304'><span><span class='ident'>string</span></span></span>&nbsp;&#8594;&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z569304",this)' onmouseleave='srcref_leave("Z569304",this)'><span><span class='ident'>s</span></span></span><span class='hint'>string(s)</span></span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span id='Z569310'><span><span class='ident'>symbol</span></span></span>&nbsp;&#8594;&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z569310",this)' onmouseleave='srcref_leave("Z569310",this)'><span><span class='ident'>s</span></span></span><span class='hint'>symbol(s)</span></span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>nil</span>&nbsp;&#8594;&nbsp;<span class='lexic'>&#8709;</span><span class='lexic'>}}};</span><br>
<br>
&nbsp;&nbsp;&nbsp;<span id='Z569437'><span><span class='ident'>istrueconst</span></span></span><span class='lexic'>(</span><span id='Z569322'><span><span class='ident'>c</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z569321",this)' onmouseleave='srcref_leave("Z569321",this)'><span><span class='ident'>getconst</span></span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z569322",this)' onmouseleave='srcref_leave("Z569322",this)'><span><span class='ident'>c</span></span></span><span class='lexic'>);</span><br>
<br>
&nbsp;&nbsp;&nbsp;<br>
&nbsp;&nbsp;&nbsp;<span id='Z569369'><span><span class='ident'>mknumconst</span></span></span><span class='lexic'>(</span><span id='Z569329'><span><span class='ident'>c</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>=</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>with</span>&nbsp;<span class='keyword'>target</span>&nbsp;<span class='lexic'>(</span><span class='ident'>lang0flat2</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='symbol'>'const'</span><span class='lexic'>(</span><span class='symbol'>'any'</span><span class='lexic'>(),</span>&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>const</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>number</span><span class='hint'>lang0flat2:const:number(n)</span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z569329",this)' onmouseleave='srcref_leave("Z569329",this)'><span><span class='ident'>c</span></span></span><span class='lexic'>))};</span><br>
<br>
&nbsp;&nbsp;&nbsp;<span id='Z569393'><span><span class='ident'>mkboolconst</span></span></span><span class='lexic'>(</span><span id='Z569336'><span><span class='ident'>c</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>=</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>with</span>&nbsp;<span class='keyword'>target</span>&nbsp;<span class='lexic'>(</span><span class='ident'>lang0flat2</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='symbol'>'const'</span><span class='lexic'>(</span><span class='symbol'>'any'</span><span class='lexic'>(),</span>&nbsp;<span class='keyword'>if</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z569336",this)' onmouseleave='srcref_leave("Z569336",this)'><span><span class='ident'>c</span></span></span><span class='lexic'>)</span>&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>const</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>symbol</span><span class='hint'>lang0flat2:const:symbol(s)</span></span><span class='lexic'>(</span><span class='symbol'>'t'</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>else</span>&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>const</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>nil</span><span class='hint'>lang0flat2:const:nil()</span></span><span class='lexic'>())};</span><br>
<br>
&nbsp;&nbsp;&nbsp;<span id='Z569397'><span><span class='ident'>mkbinfun</span></span></span><span class='lexic'>(</span><span id='Z569366'><span><span class='ident'>fn</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>=</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>&lambda;</span><span class='lexic'>(</span><span id='Z569371'><span><span class='ident'>args</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>&lt;</span><span class='lexic'><span class='pattern'>[</span></span><span id='Z569362'><span><span class='ident'><span class='pattern'>l</span></span></span></span><span class='lexic'><span class='pattern'>;</span></span><span id='Z569364'><span><span class='ident'><span class='pattern'>r</span></span></span></span><span class='lexic'><span class='pattern'>]</span></span><span class='lexic'>&gt;</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z569371",this)' onmouseleave='srcref_leave("Z569371",this)'><span><span class='ident'>args</span></span></span><span class='lexic'>;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z569367'><span><span class='ident'>vl</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z569321",this)' onmouseleave='srcref_leave("Z569321",this)'><span><span class='ident'>getconst</span></span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z569362",this)' onmouseleave='srcref_leave("Z569362",this)'><span><span class='ident'>l</span></span></span><span class='lexic'>);</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z569368'><span><span class='ident'>vr</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z569321",this)' onmouseleave='srcref_leave("Z569321",this)'><span><span class='ident'>getconst</span></span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z569364",this)' onmouseleave='srcref_leave("Z569364",this)'><span><span class='ident'>r</span></span></span><span class='lexic'>);</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z569370'><span><span class='ident'>tmp</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z569366",this)' onmouseleave='srcref_leave("Z569366",this)'><span><span class='ident'>fn</span></span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z569367",this)' onmouseleave='srcref_leave("Z569367",this)'><span><span class='ident'>vl</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z569368",this)' onmouseleave='srcref_leave("Z569368",this)'><span><span class='ident'>vr</span></span></span><span class='lexic'>);</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>return</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z569369",this)' onmouseleave='srcref_leave("Z569369",this)'><span><span class='ident'>mknumconst</span></span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z569370",this)' onmouseleave='srcref_leave("Z569370",this)'><span><span class='ident'>tmp</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>}</span><span class='lexic'>;</span><br>
&nbsp;&nbsp;&nbsp;<span id='Z569398'><span><span class='ident'>mkboolfun</span></span></span><span class='lexic'>(</span><span id='Z569390'><span><span class='ident'>fn</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>=</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>&lambda;</span><span class='lexic'>(</span><span id='Z569395'><span><span class='ident'>args</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>&lt;</span><span class='lexic'><span class='pattern'>[</span></span><span id='Z569386'><span><span class='ident'><span class='pattern'>l</span></span></span></span><span class='lexic'><span class='pattern'>;</span></span><span id='Z569388'><span><span class='ident'><span class='pattern'>r</span></span></span></span><span class='lexic'><span class='pattern'>]</span></span><span class='lexic'>&gt;</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z569395",this)' onmouseleave='srcref_leave("Z569395",this)'><span><span class='ident'>args</span></span></span><span class='lexic'>;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z569391'><span><span class='ident'>vl</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z569321",this)' onmouseleave='srcref_leave("Z569321",this)'><span><span class='ident'>getconst</span></span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z569386",this)' onmouseleave='srcref_leave("Z569386",this)'><span><span class='ident'>l</span></span></span><span class='lexic'>);</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z569392'><span><span class='ident'>vr</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z569321",this)' onmouseleave='srcref_leave("Z569321",this)'><span><span class='ident'>getconst</span></span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z569388",this)' onmouseleave='srcref_leave("Z569388",this)'><span><span class='ident'>r</span></span></span><span class='lexic'>);</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z569394'><span><span class='ident'>tmp</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z569390",this)' onmouseleave='srcref_leave("Z569390",this)'><span><span class='ident'>fn</span></span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z569391",this)' onmouseleave='srcref_leave("Z569391",this)'><span><span class='ident'>vl</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z569392",this)' onmouseleave='srcref_leave("Z569392",this)'><span><span class='ident'>vr</span></span></span><span class='lexic'>);</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>return</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z569393",this)' onmouseleave='srcref_leave("Z569393",this)'><span><span class='ident'>mkboolconst</span></span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z569394",this)' onmouseleave='srcref_leave("Z569394",this)'><span><span class='ident'>tmp</span></span></span><span class='lexic'>)}</span><span class='lexic'>;</span><br>
<br>
&nbsp;&nbsp;&nbsp;<span class='keyword'>iter</span>&nbsp;<span class='lexic'>[</span><span id='Z569427'><span><span class='ident'><span class='pattern'>nm</span></span></span></span><span class='lexic'>;</span><span id='Z569432'><span><span class='ident'><span class='pattern'>c</span></span></span></span><span class='lexic'>;</span><span id='Z569433'><span><span class='ident'><span class='pattern'>p</span></span></span></span><span class='lexic'>;</span><span id='Z569434'><span><span class='ident'><span class='pattern'>efun</span></span></span></span><span class='lexic'>;@</span><span id='Z569425'><span><span class='ident'><span class='pattern'>rst</span></span></span></span><span class='lexic'>]</span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='lexic'>[</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>[</span><span class='symbol'>'binopadd'</span><span class='lexic'>;</span><span class='const'>1</span><span class='lexic'>;</span><span class='const'>1</span><span class='lexic'>;</span><span class='idfrom' onmouseenter='srcref_over("Z569397",this)' onmouseleave='srcref_leave("Z569397",this)'><span><span class='ident'>mkbinfun</span></span></span><span class='lexic'>(</span>&nbsp;<span class='ident'>%+</span>&nbsp;<span class='lexic'>);</span><span class='symbol'>'add'</span><span class='lexic'>];</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>[</span><span class='symbol'>'binopsub'</span><span class='lexic'>;</span><span class='const'>1</span><span class='lexic'>;</span><span class='const'>1</span><span class='lexic'>;</span><span class='idfrom' onmouseenter='srcref_over("Z569397",this)' onmouseleave='srcref_leave("Z569397",this)'><span><span class='ident'>mkbinfun</span></span></span><span class='lexic'>(</span>&nbsp;<span class='ident'>%-</span>&nbsp;<span class='lexic'>);</span><span class='symbol'>'sub'</span><span class='lexic'>];</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>[</span><span class='symbol'>'binopmul'</span><span class='lexic'>;</span><span class='const'>1</span><span class='lexic'>;</span><span class='const'>1</span><span class='lexic'>;</span><span class='idfrom' onmouseenter='srcref_over("Z569397",this)' onmouseleave='srcref_leave("Z569397",this)'><span><span class='ident'>mkbinfun</span></span></span><span class='lexic'>(</span>&nbsp;<span class='ident'>%*</span>&nbsp;<span class='lexic'>);</span><span class='symbol'>'mul'</span><span class='lexic'>];</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>[</span><span class='symbol'>'binopdiv'</span><span class='lexic'>;</span><span class='const'>1</span><span class='lexic'>;</span><span class='const'>1</span><span class='lexic'>;</span><span class='idfrom' onmouseenter='srcref_over("Z569397",this)' onmouseleave='srcref_leave("Z569397",this)'><span><span class='ident'>mkbinfun</span></span></span><span class='lexic'>(</span>&nbsp;<span class='ident'>%/</span>&nbsp;<span class='lexic'>);</span><span class='symbol'>'div'</span><span class='lexic'>];</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>[</span><span class='symbol'>'binopeq'</span><span class='lexic'>;</span><span class='const'>1</span><span class='lexic'>;</span><span class='const'>1</span><span class='lexic'>;</span><span class='idfrom' onmouseenter='srcref_over("Z569398",this)' onmouseleave='srcref_leave("Z569398",this)'><span><span class='ident'>mkboolfun</span></span></span><span class='lexic'>(</span>&nbsp;<span class='keyword'>&lambda;</span><span class='lexic'>(</span><span id='Z569401'><span><span class='ident'>l</span></span></span><span class='lexic'>,</span><span id='Z569402'><span><span class='ident'>r</span></span></span><span class='lexic'>)</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z569401",this)' onmouseleave='srcref_leave("Z569401",this)'><span><span class='ident'>l</span></span></span><span class='lexic'>=</span>=<span class='idfrom' onmouseenter='srcref_over("Z569402",this)' onmouseleave='srcref_leave("Z569402",this)'><span><span class='ident'>r</span></span></span>&nbsp;<span class='lexic'>);</span><span class='symbol'>'eq'</span><span class='lexic'>];</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>[</span><span class='symbol'>'binopneq'</span><span class='lexic'>;</span><span class='const'>1</span><span class='lexic'>;</span><span class='const'>1</span><span class='lexic'>;</span><span class='idfrom' onmouseenter='srcref_over("Z569398",this)' onmouseleave='srcref_leave("Z569398",this)'><span><span class='ident'>mkboolfun</span></span></span><span class='lexic'>(</span>&nbsp;<span class='keyword'>&lambda;</span><span class='lexic'>(</span><span id='Z569405'><span><span class='ident'>l</span></span></span><span class='lexic'>,</span><span id='Z569406'><span><span class='ident'>r</span></span></span><span class='lexic'>)</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z569405",this)' onmouseleave='srcref_leave("Z569405",this)'><span><span class='ident'>l</span></span></span>!=<span class='idfrom' onmouseenter='srcref_over("Z569406",this)' onmouseleave='srcref_leave("Z569406",this)'><span><span class='ident'>r</span></span></span>&nbsp;<span class='lexic'>);</span><span class='symbol'>'neq'</span><span class='lexic'>]</span><br>
&nbsp;&nbsp;&nbsp;<span class='lexic'>]</span>&nbsp;<span class='keyword'>do</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z569435'><span><span class='ident'>cls</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='keyword'>if</span>&nbsp;<span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z569425",this)' onmouseleave='srcref_leave("Z569425",this)'><span><span class='ident'>rst</span></span></span><span class='lexic'>)</span>&nbsp;<span class='ident'>car</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z569425",this)' onmouseleave='srcref_leave("Z569425",this)'><span><span class='ident'>rst</span></span></span><span class='lexic'>)</span>&nbsp;<span class='keyword'>else</span>&nbsp;<span class='lexic'>&#8709;</span><span class='lexic'>;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='ident'>ohashput</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z569426",this)' onmouseleave='srcref_leave("Z569426",this)'><span><span class='ident'>ht</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z569427",this)' onmouseleave='srcref_leave("Z569427",this)'><span><span class='ident'>nm</span></span></span><span class='lexic'>,</span>&nbsp;<span class='keyword'>&lambda;</span><span class='lexic'>(</span><span id='Z569436'><span><span class='ident'>tg</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>match</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z569436",this)' onmouseleave='srcref_leave("Z569436",this)'><span><span class='ident'>tg</span></span></span>&nbsp;<span class='keyword'>with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='symbol'><span class='pattern'>'constantp'</span></span>&nbsp;&#8594;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z569432",this)' onmouseleave='srcref_leave("Z569432",this)'><span><span class='ident'>c</span></span></span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='symbol'><span class='pattern'>'purep'</span></span>&nbsp;&#8594;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z569433",this)' onmouseleave='srcref_leave("Z569433",this)'><span><span class='ident'>p</span></span></span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='symbol'><span class='pattern'>'evalfun'</span></span>&nbsp;&#8594;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z569434",this)' onmouseleave='srcref_leave("Z569434",this)'><span><span class='ident'>efun</span></span></span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='symbol'><span class='pattern'>'classify'</span></span>&nbsp;&#8594;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z569435",this)' onmouseleave='srcref_leave("Z569435",this)'><span><span class='ident'>cls</span></span></span><span class='lexic'>}</span><span class='lexic'>)};</span><br>
<br>
&nbsp;&nbsp;&nbsp;<span class='ident'>ohashput</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z569426",this)' onmouseleave='srcref_leave("Z569426",this)'><span><span class='ident'>ht</span></span></span><span class='lexic'>,</span>&nbsp;<span class='symbol'>'*true?*'</span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z569437",this)' onmouseleave='srcref_leave("Z569437",this)'><span><span class='ident'>istrueconst</span></span></span><span class='lexic'>);</span><br>
&nbsp;&nbsp;&nbsp;<span class='ident'>ohashput</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z569426",this)' onmouseleave='srcref_leave("Z569426",this)'><span><span class='ident'>ht</span></span></span><span class='lexic'>,</span>&nbsp;<span class='symbol'>'*boolean-type*'</span><span class='lexic'>,</span>&nbsp;<span class='symbol'>'any'</span><span class='lexic'>());</span><br>
&nbsp;&nbsp;&nbsp;<span class='ident'>ohashput</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z569426",this)' onmouseleave='srcref_leave("Z569426",this)'><span><span class='ident'>ht</span></span></span><span class='lexic'>,</span>&nbsp;<span class='symbol'>'*type-maker*'</span><span class='lexic'>,</span>&nbsp;<span class='keyword'>&lambda;</span><span class='lexic'>(</span><span class='ident'>lenv</span><span class='lexic'>,</span>&nbsp;<span class='ident'>t</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><span class='symbol'>'any'</span><span class='lexic'>()}</span><span class='lexic'>);</span><br>
&nbsp;&nbsp;&nbsp;<span class='ident'>ohashput</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z569426",this)' onmouseleave='srcref_leave("Z569426",this)'><span><span class='ident'>ht</span></span></span><span class='lexic'>,</span>&nbsp;<span class='symbol'>'*ctype-maker*'</span><span class='lexic'>,</span>&nbsp;<span class='keyword'>&lambda;</span><span class='lexic'>(</span><span class='ident'>lenv</span><span class='lexic'>,</span>&nbsp;<span class='ident'>t</span><span class='lexic'>,</span>&nbsp;<span class='ident'>c</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><span class='symbol'>'any'</span><span class='lexic'>()}</span><span class='lexic'>);</span><br>
&nbsp;&nbsp;&nbsp;<span class='ident'>ohashput</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z569426",this)' onmouseleave='srcref_leave("Z569426",this)'><span><span class='ident'>ht</span></span></span><span class='lexic'>,</span>&nbsp;<span class='symbol'>'*type-equation-maker*'</span><span class='lexic'>,</span>&nbsp;<span class='keyword'>&lambda;</span><span class='lexic'>(</span><span class='ident'>dst</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><span class='lexic'>&#8709;</span><span class='lexic'>}</span><span class='lexic'>);</span><br>
<br>
&nbsp;&nbsp;&nbsp;<span class='ident'>ohashput</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z569426",this)' onmouseleave='srcref_leave("Z569426",this)'><span><span class='ident'>ht</span></span></span><span class='lexic'>,</span>&nbsp;<span class='symbol'>'*get-integer-constant*'</span><span class='lexic'>,</span>&nbsp;<span class='keyword'>&lambda;</span><span class='lexic'>(</span><span class='ident'>tp</span><span class='lexic'>,</span>&nbsp;<span class='ident'>vl</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>&#8709;</span><span class='lexic'>}</span><span class='lexic'>);</span><br>
&nbsp;&nbsp;&nbsp;<span class='keyword'>return</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z569426",this)' onmouseleave='srcref_leave("Z569426",this)'><span><span class='ident'>ht</span></span></span><span class='lexic'>}</span>
<p></div>



<p><div class='code'>
<span id='Z569593'><span class='keyword'>d</span></span><span class='keyword'>efine</span>&nbsp;<span class='ident'>l0_default_model</span>&nbsp;<span class='lexic'>=</span>&nbsp;<a href='#Z569073'><span class='ident'>l0_make_model</span></a><span class='lexic'>()</span>
<p></div>


<h3>Optimisations</h3>


<p><div class='code'>
<span id='Z569596'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_genssa_opt</span><span class='lexic'>(</span><span id='Z569612'><span><span class='ident'>ts</span></span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;<span class='keyword'>map</span>&nbsp;<span id='Z569616'><span><span class='ident'>t</span></span></span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z569612",this)' onmouseleave='srcref_leave("Z569612",this)'><span><span class='ident'>ts</span></span></span>&nbsp;<span class='keyword'>do</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z569617'><span><span class='ident'>t0</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<a href='#Z568672'><span class='ident'>l0_to_abstract_ssa</span></a><span class='lexic'>([</span><span class='idfrom' onmouseenter='srcref_over("Z569616",this)' onmouseleave='srcref_leave("Z569616",this)'><span><span class='ident'>t</span></span></span><span class='lexic'>]);</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>if</span>&nbsp;<span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z569617",this)' onmouseleave='srcref_leave("Z569617",this)'><span><span class='ident'>t0</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>&lt;</span><span class='ident'><span class='pattern'>ht</span></span><span class='lexic'><span class='pattern'>:</span></span><span id='Z569625'><span><span class='ident'><span class='pattern'>nv</span></span></span></span><span class='lexic'>&gt;</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='ident'>genssa2_process</span><span class='lexic'>(</span><span class='ident'>l0_default_model</span><span class='lexic'>,</span>&nbsp;<span class='ident'>mkhash</span><span class='lexic'>(),</span>&nbsp;<span class='ident'>car</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z569617",this)' onmouseleave='srcref_leave("Z569617",this)'><span><span class='ident'>t0</span></span></span><span class='lexic'>));</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>return</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z569625",this)' onmouseleave='srcref_leave("Z569625",this)'><span><span class='ident'>nv</span></span></span><span class='lexic'>}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>}</span>
<p></div>


<h3>Back from the abstract SSA</h3>


<p><div class='code'>
<span id='Z569642'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_from_abstract_ssa_code</span><span class='lexic'>(</span><span id='Z570216'><span><span class='ident'>varht</span></span></span><span class='lexic'>,</span>&nbsp;<span id='Z570901'><span><span class='ident'>c</span></span></span><span class='lexic'>)</span><br>
<span class='keyword'>with</span>&nbsp;<span class='keyword'>target</span>&nbsp;<span class='lexic'>(</span><span class='ident'>lang0flat2</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;<span id='Z570711'><span><span class='ident'>classvar</span></span></span><span class='lexic'>(</span><span id='Z570217'><span><span class='ident'>id</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='keyword'>aif</span><span class='lexic'>(</span><span class='ident'>chk</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='ident'>ohashget</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z570216",this)' onmouseleave='srcref_leave("Z570216",this)'><span><span class='ident'>varht</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z570217",this)' onmouseleave='srcref_leave("Z570217",this)'><span><span class='ident'>id</span></span></span><span class='lexic'>))</span>&nbsp;<span class='ident'>chk</span>&nbsp;<span class='keyword'>else</span>&nbsp;<span class='symbol'>'var'</span><span class='lexic'>;</span><br>
&nbsp;&nbsp;&nbsp;<span id='Z570582'><span><span class='ident'>getglob</span></span></span><span class='lexic'>(</span><span id='Z570226'><span><span class='ident'>v</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>=</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0flat2</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>value</span><span class='lexic'>:</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z570226",this)' onmouseleave='srcref_leave("Z570226",this)'><span><span class='ident'>v</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>once</span>&nbsp;<span class='ident'>value</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z570305'><span><span class='ident'>global</span></span></span>&nbsp;&#8594;&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z570305",this)' onmouseleave='srcref_leave("Z570305",this)'><span><span class='ident'>id</span></span></span><span class='hint'>global(id)</span></span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='withhint'><span class='ident'>ccerror</span><span class='hint'>function&nbsp;ccerror&nbsp;arg:&nbsp;<br>
Raises&nbsp;[MBaseException]&nbsp;with&nbsp;a&nbsp;given&nbsp;argument.</span></span><span class='lexic'>(</span><span class='symbol'>'IMPOSSIBLE'</span><span class='lexic'>())}};</span><br>
&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>genssa2</span>&nbsp;<span class='lexic'>(</span><span class='ident'>code</span><span class='lexic'>:</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z570901",this)' onmouseleave='srcref_leave("Z570901",this)'><span><span class='ident'>c</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>code</span><span class='lexic'>:</span>&nbsp;<span class='lexic'>{</span><span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>code</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>c</span><span class='hint'>lang0flat2:code:c(bs)</span></span><span class='lexic'>(</span><span class='ident'>bs</span><span class='lexic'>)};</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>bblock</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z570406'><span><span class='ident'>b</span></span></span>&nbsp;&#8594;&nbsp;<span class='keyword'>collector</span><span class='lexic'>(</span><span id='Z570412'><span><span class='ident'>addx</span></span></span><span class='lexic'>,</span>&nbsp;<span id='Z570415'><span><span class='ident'>getx</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z570423'><span><span class='ident'>nops</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='keyword'>map</span>&nbsp;<span class='keyword'>append</span>&nbsp;<span id='Z570411'><span><span class='ident'>o</span></span></span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z570406",this)' onmouseleave='srcref_leave("Z570406",this)'><span><span class='ident'>ops</span></span></span><span class='hint'>b(name,ops,t)</span></span>&nbsp;<span class='keyword'>do</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z570411",this)' onmouseleave='srcref_leave("Z570411",this)'><span><span class='ident'>o</span></span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z570412",this)' onmouseleave='srcref_leave("Z570412",this)'><span><span class='ident'>addx</span></span></span><span class='lexic'>);</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z570424'><span><span class='ident'>nt</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z570415",this)' onmouseleave='srcref_leave("Z570415",this)'><span><span class='ident'>getx</span></span></span><span class='lexic'>();</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>bblock</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>bb</span><span class='hint'>lang0flat2:bblock:bb(lbl,body,t)</span></span><span class='lexic'>(</span><span class='ident'>lbl</span><span class='lexic'>=</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z570406",this)' onmouseleave='srcref_leave("Z570406",this)'><span><span class='ident'>name</span></span></span><span class='hint'>b(name,ops,t)</span></span><span class='lexic'>,</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='ident'>body</span><span class='lexic'>=</span><span class='idfrom' onmouseenter='srcref_over("Z570423",this)' onmouseleave='srcref_leave("Z570423",this)'><span><span class='ident'>nops</span></span></span><span class='lexic'>,</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='ident'>t</span><span class='lexic'>=</span><span class='keyword'>if</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z570424",this)' onmouseleave='srcref_leave("Z570424",this)'><span><span class='ident'>nt</span></span></span><span class='lexic'>)</span>&nbsp;<span class='ident'>car</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z570424",this)' onmouseleave='srcref_leave("Z570424",this)'><span><span class='ident'>nt</span></span></span><span class='lexic'>)</span>&nbsp;<span class='keyword'>else</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z570406",this)' onmouseleave='srcref_leave("Z570406",this)'><span><span class='ident'>t</span></span></span><span class='hint'>b(name,ops,t)</span></span><span class='lexic'>)}};</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>oppair</span><span class='lexic'>:</span>&nbsp;<span class='keyword'>&lambda;</span><span class='lexic'>(</span><span id='Z570462'><span><span class='ident'>addx</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><span class='ident'>op</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z570462",this)' onmouseleave='srcref_leave("Z570462",this)'><span><span class='ident'>addx</span></span></span><span class='lexic'>,</span>&nbsp;<span class='ident'>name</span><span class='lexic'>)}</span><span class='lexic'>;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>iop</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z570490'><span><span class='ident'>phi</span></span></span>&nbsp;&#8594;&nbsp;<span class='keyword'>&lambda;</span><span class='lexic'>(</span><span class='ident'>addx</span><span class='lexic'>,</span>&nbsp;<span id='Z570486'><span><span class='ident'>name</span></span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>[</span><span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>insn</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>def</span><span class='hint'>lang0flat2:insn:def(id,v)</span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z570486",this)' onmouseleave='srcref_leave("Z570486",this)'><span><span class='ident'>name</span></span></span><span class='lexic'>,</span>&nbsp;<span class='ident'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>phi</span><span class='hint'>lang0flat2:expr:phi(ss)</span></span><span class='lexic'>(</span><span class='ident'>ss</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z570490",this)' onmouseleave='srcref_leave("Z570490",this)'><span><span class='ident'>args</span></span></span><span class='hint'>phi(args)</span></span><span class='lexic'>))]</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span id='Z570519'><span><span class='ident'>select</span></span></span>&nbsp;&#8594;&nbsp;<span class='keyword'>&lambda;</span><span class='lexic'>(</span><span class='ident'>addx</span><span class='lexic'>,</span>&nbsp;<span id='Z570513'><span><span class='ident'>name</span></span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>[</span><span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>insn</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>def</span><span class='hint'>lang0flat2:insn:def(id,v)</span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z570513",this)' onmouseleave='srcref_leave("Z570513",this)'><span><span class='ident'>name</span></span></span><span class='lexic'>,</span>&nbsp;<span class='ident'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>select</span><span class='hint'>lang0flat2:expr:select(cnd,tr,fl)</span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z570519",this)' onmouseleave='srcref_leave("Z570519",this)'><span><span class='ident'>cnd</span></span></span><span class='hint'>select(cnd,t,f)</span></span><span class='lexic'>,</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z570519",this)' onmouseleave='srcref_leave("Z570519",this)'><span><span class='ident'>t</span></span></span><span class='hint'>select(cnd,t,f)</span></span><span class='lexic'>,</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z570519",this)' onmouseleave='srcref_leave("Z570519",this)'><span><span class='ident'>f</span></span></span><span class='hint'>select(cnd,t,f)</span></span><span class='lexic'>))]</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span id='Z570548'><span><span class='ident'>call</span></span></span>&nbsp;&#8594;&nbsp;<span class='keyword'>&lambda;</span><span class='lexic'>(</span><span id='Z570544'><span><span class='ident'>addx</span></span></span><span class='lexic'>,</span>&nbsp;<span id='Z570558'><span><span class='ident'>dstname</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>match</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z570548",this)' onmouseleave='srcref_leave("Z570548",this)'><span><span class='ident'>dst</span></span></span><span class='hint'>call(a,dst,args)</span></span>&nbsp;<span class='keyword'>with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='symbol'><span class='pattern'>'*tailreturn*'</span></span>&nbsp;&#8594;&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='comment'>//&nbsp;Override&nbsp;the&nbsp;terminal&nbsp;and&nbsp;remove&nbsp;the&nbsp;argument<br>
</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='comment'>//&nbsp;from&nbsp;the&nbsp;insns&nbsp;list<br>
</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z570544",this)' onmouseleave='srcref_leave("Z570544",this)'><span><span class='ident'>addx</span></span></span><span class='lexic'>(</span><span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>term</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>return</span><span class='hint'>lang0flat2:term:return(v)</span></span><span class='lexic'>(</span><span class='ident'>car</span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z570548",this)' onmouseleave='srcref_leave("Z570548",this)'><span><span class='ident'>args</span></span></span><span class='hint'>call(a,dst,args)</span></span><span class='lexic'>)));</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>return</span>&nbsp;<span class='lexic'>&#8709;</span><span class='lexic'>}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='symbol'><span class='pattern'>'*funcall*'</span></span>&nbsp;&#8594;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>[</span><span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>insn</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>def</span><span class='hint'>lang0flat2:insn:def(id,v)</span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z570558",this)' onmouseleave='srcref_leave("Z570558",this)'><span><span class='ident'>dstname</span></span></span><span class='lexic'>,</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='ident'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>apply</span><span class='hint'>lang0flat2:expr:apply(purep,fn,args)</span></span><span class='lexic'>(</span><span class='lexic'>&#8709;</span><span class='lexic'>,</span>&nbsp;<span class='ident'>car</span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z570548",this)' onmouseleave='srcref_leave("Z570548",this)'><span><span class='ident'>args</span></span></span><span class='hint'>call(a,dst,args)</span></span><span class='lexic'>),</span>&nbsp;<span class='ident'>cdr</span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z570548",this)' onmouseleave='srcref_leave("Z570548",this)'><span><span class='ident'>args</span></span></span><span class='hint'>call(a,dst,args)</span></span><span class='lexic'>)))]</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='symbol'><span class='pattern'>'*mkclosure*'</span></span>&nbsp;&#8594;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>[</span><span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>insn</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>def</span><span class='hint'>lang0flat2:insn:def(id,v)</span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z570558",this)' onmouseleave='srcref_leave("Z570558",this)'><span><span class='ident'>dstname</span></span></span><span class='lexic'>,</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='ident'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>mkclosure</span><span class='hint'>lang0flat2:expr:mkclosure(df,args)</span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z570582",this)' onmouseleave='srcref_leave("Z570582",this)'><span><span class='ident'>getglob</span></span></span><span class='lexic'>(</span><span class='ident'>car</span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z570548",this)' onmouseleave='srcref_leave("Z570548",this)'><span><span class='ident'>args</span></span></span><span class='hint'>call(a,dst,args)</span></span><span class='lexic'>)),</span>&nbsp;<span class='ident'>cdr</span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z570548",this)' onmouseleave='srcref_leave("Z570548",this)'><span><span class='ident'>args</span></span></span><span class='hint'>call(a,dst,args)</span></span><span class='lexic'>)))]</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='symbol'><span class='pattern'>'*return*'</span></span>&nbsp;&#8594;&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z570544",this)' onmouseleave='srcref_leave("Z570544",this)'><span><span class='ident'>addx</span></span></span><span class='lexic'>(</span><span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>term</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>return</span><span class='hint'>lang0flat2:term:return(v)</span></span><span class='lexic'>(</span><span class='ident'>car</span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z570548",this)' onmouseleave='srcref_leave("Z570548",this)'><span><span class='ident'>args</span></span></span><span class='hint'>call(a,dst,args)</span></span><span class='lexic'>)));</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>return</span>&nbsp;<span class='lexic'>&#8709;</span><span class='lexic'>}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'><span class='pattern'>else</span></span>&nbsp;&#8594;&nbsp;<span class='lexic'>{</span>&nbsp;<span class='comment'>//&nbsp;intrinsic<br>
</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>[</span><span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>insn</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>def</span><span class='hint'>lang0flat2:insn:def(id,v)</span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z570558",this)' onmouseleave='srcref_leave("Z570558",this)'><span><span class='ident'>dstname</span></span></span><span class='lexic'>,</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='ident'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>apply</span><span class='hint'>lang0flat2:expr:apply(purep,fn,args)</span></span><span class='lexic'>(</span><span class='lexic'>&#8709;</span><span class='lexic'>,</span>&nbsp;<span class='ident'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>global</span><span class='hint'>lang0flat2:value:global(id)</span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z570548",this)' onmouseleave='srcref_leave("Z570548",this)'><span><span class='ident'>dst</span></span></span><span class='hint'>call(a,dst,args)</span></span><span class='lexic'>),</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z570548",this)' onmouseleave='srcref_leave("Z570548",this)'><span><span class='ident'>args</span></span></span><span class='hint'>call(a,dst,args)</span></span><span class='lexic'>))]</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>}}</span><span class='lexic'>};</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>expr</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z570688'><span><span class='ident'>var</span></span></span>&nbsp;&#8594;&nbsp;<span class='lexic'>{</span><span class='keyword'>match</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z570711",this)' onmouseleave='srcref_leave("Z570711",this)'><span><span class='ident'>classvar</span></span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z570688",this)' onmouseleave='srcref_leave("Z570688",this)'><span><span class='ident'>id</span></span></span><span class='hint'>var(id)</span></span><span class='lexic'>)</span>&nbsp;<span class='keyword'>with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='symbol'><span class='pattern'>'var'</span></span>&nbsp;&#8594;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>value</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>reg</span><span class='hint'>lang0flat2:value:reg(id)</span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z570688",this)' onmouseleave='srcref_leave("Z570688",this)'><span><span class='ident'>id</span></span></span><span class='hint'>var(id)</span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='symbol'><span class='pattern'>'arg'</span></span>&nbsp;&#8594;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>value</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>arg</span><span class='hint'>lang0flat2:value:arg(id)</span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z570688",this)' onmouseleave='srcref_leave("Z570688",this)'><span><span class='ident'>id</span></span></span><span class='hint'>var(id)</span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='symbol'><span class='pattern'>'clvar'</span></span>&nbsp;&#8594;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>value</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>clvar</span><span class='hint'>lang0flat2:value:clvar(id)</span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z570688",this)' onmouseleave='srcref_leave("Z570688",this)'><span><span class='ident'>id</span></span></span><span class='hint'>var(id)</span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'><span class='pattern'>else</span></span>&nbsp;&#8594;&nbsp;<span class='withhint'><span class='ident'>ccerror</span><span class='hint'>function&nbsp;ccerror&nbsp;arg:&nbsp;<br>
Raises&nbsp;[MBaseException]&nbsp;with&nbsp;a&nbsp;given&nbsp;argument.</span></span><span class='lexic'>(</span><span class='symbol'>'IMPOSSIBLE'</span><span class='lexic'>())}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span id='Z570721'><span><span class='ident'>glob</span></span></span>&nbsp;&#8594;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>value</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>global</span><span class='hint'>lang0flat2:value:global(id)</span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z570721",this)' onmouseleave='srcref_leave("Z570721",this)'><span><span class='ident'>id</span></span></span><span class='hint'>glob(id)</span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span id='Z570736'><span><span class='ident'>const</span></span></span>&nbsp;&#8594;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>value</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>const</span><span class='hint'>lang0flat2:value:const(c)</span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z570736",this)' onmouseleave='srcref_leave("Z570736",this)'><span><span class='ident'>v</span></span></span><span class='hint'>const(t,v)</span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>other</span>&nbsp;&#8594;&nbsp;<span class='withhint'><span class='ident'>ccerror</span><span class='hint'>function&nbsp;ccerror&nbsp;arg:&nbsp;<br>
Raises&nbsp;[MBaseException]&nbsp;with&nbsp;a&nbsp;given&nbsp;argument.</span></span><span class='lexic'>(</span><span class='symbol'>'IMPOSSIBLE'</span><span class='lexic'>())};</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>phiarg</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z570781'><span><span class='ident'>a</span></span></span>&nbsp;&#8594;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>phisrc</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>s</span><span class='hint'>lang0flat2:phisrc:s(from,v)</span></span><span class='lexic'>(</span><span class='ident'>from</span><span class='lexic'>=</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z570781",this)' onmouseleave='srcref_leave("Z570781",this)'><span><span class='ident'>src</span></span></span><span class='hint'>a(src,v)</span></span><span class='lexic'>,</span>&nbsp;<span class='ident'>v</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z570781",this)' onmouseleave='srcref_leave("Z570781",this)'><span><span class='ident'>v</span></span></span><span class='hint'>a(src,v)</span></span><span class='lexic'>)};</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>term</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z570815'><span><span class='ident'>br</span></span></span>&nbsp;&nbsp;&#8594;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>term</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>goto</span><span class='hint'>lang0flat2:term:goto(id)</span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z570815",this)' onmouseleave='srcref_leave("Z570815",this)'><span><span class='ident'>dst</span></span></span><span class='hint'>br(dst)</span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span id='Z570834'><span><span class='ident'>brc</span></span></span>&nbsp;&#8594;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>term</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>gotoc</span><span class='hint'>lang0flat2:term:gotoc(cnd,tr,fl)</span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z570834",this)' onmouseleave='srcref_leave("Z570834",this)'><span><span class='ident'>c</span></span></span><span class='hint'>brc(c,tr,fl)</span></span><span class='lexic'>,</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z570834",this)' onmouseleave='srcref_leave("Z570834",this)'><span><span class='ident'>tr</span></span></span><span class='hint'>brc(c,tr,fl)</span></span><span class='lexic'>,</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z570834",this)' onmouseleave='srcref_leave("Z570834",this)'><span><span class='ident'>fl</span></span></span><span class='hint'>brc(c,tr,fl)</span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>switch</span>&nbsp;&#8594;&nbsp;<span class='withhint'><span class='ident'>ccerror</span><span class='hint'>function&nbsp;ccerror&nbsp;arg:&nbsp;<br>
Raises&nbsp;[MBaseException]&nbsp;with&nbsp;a&nbsp;given&nbsp;argument.</span></span><span class='lexic'>(</span><span class='symbol'>'IMPOSSIBLE'</span><span class='lexic'>())</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>none</span>&nbsp;&#8594;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>term</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>return</span><span class='hint'>lang0flat2:term:return(v)</span></span><span class='lexic'>(</span><span class='ident'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>reg</span><span class='hint'>lang0flat2:value:reg(id)</span></span><span class='lexic'>(</span><span class='symbol'>'*WTF*'</span><span class='lexic'>))};</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>}}</span>
<p></div>




<p><div class='code'>
<span id='Z571248'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_varht</span><span class='lexic'>(</span><span id='Z571401'><span><span class='ident'>t</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;<span id='Z571514'><span><span class='ident'>ht</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='ident'>mkhash</span><span class='lexic'>();</span><br>
&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0flat2</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>top</span><span class='lexic'>:</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z571401",this)' onmouseleave='srcref_leave("Z571401",this)'><span><span class='ident'>t</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>once</span>&nbsp;<span class='ident'>top</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z571510'><span><span class='ident'>sfunction</span></span></span>&nbsp;&#8594;&nbsp;<span class='lexic'>{</span>&nbsp;<span class='keyword'>iter</span>&nbsp;<span id='Z571515'><span><span class='ident'>a</span></span></span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z571510",this)' onmouseleave='srcref_leave("Z571510",this)'><span><span class='ident'>args</span></span></span><span class='hint'>sfunction(id,args,body)</span></span>&nbsp;<span class='keyword'>do</span>&nbsp;<span class='ident'>ohashput</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z571514",this)' onmouseleave='srcref_leave("Z571514",this)'><span><span class='ident'>ht</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z571515",this)' onmouseleave='srcref_leave("Z571515",this)'><span><span class='ident'>a</span></span></span><span class='lexic'>,</span>&nbsp;<span class='symbol'>'arg'</span><span class='lexic'>);</span>&nbsp;<span class='lexic'>}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span id='Z571529'><span><span class='ident'>closure</span></span></span>&nbsp;&#8594;&nbsp;<span class='lexic'>{</span>&nbsp;<span class='keyword'>iter</span>&nbsp;<span id='Z571533'><span><span class='ident'>a</span></span></span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z571529",this)' onmouseleave='srcref_leave("Z571529",this)'><span><span class='ident'>args</span></span></span><span class='hint'>closure(id,clargs,args,body)</span></span>&nbsp;<span class='keyword'>do</span>&nbsp;<span class='ident'>ohashput</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z571514",this)' onmouseleave='srcref_leave("Z571514",this)'><span><span class='ident'>ht</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z571533",this)' onmouseleave='srcref_leave("Z571533",this)'><span><span class='ident'>a</span></span></span><span class='lexic'>,</span>&nbsp;<span class='symbol'>'arg'</span><span class='lexic'>);</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>iter</span>&nbsp;<span id='Z571538'><span><span class='ident'>c</span></span></span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z571529",this)' onmouseleave='srcref_leave("Z571529",this)'><span><span class='ident'>clargs</span></span></span><span class='hint'>closure(id,clargs,args,body)</span></span>&nbsp;<span class='keyword'>do</span>&nbsp;<span class='ident'>ohashput</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z571514",this)' onmouseleave='srcref_leave("Z571514",this)'><span><span class='ident'>ht</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z571538",this)' onmouseleave='srcref_leave("Z571538",this)'><span><span class='ident'>c</span></span></span><span class='lexic'>,</span>&nbsp;<span class='symbol'>'clvar'</span><span class='lexic'>)}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='lexic'>&#8709;</span><span class='lexic'>}};</span><br>
&nbsp;&nbsp;&nbsp;<span class='keyword'>return</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z571514",this)' onmouseleave='srcref_leave("Z571514",this)'><span><span class='ident'>ht</span></span></span><span class='lexic'>}</span>
<p></div>



<p><div class='code'>
<span id='Z571588'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_do_abstract_ssa</span><span class='lexic'>(</span><span id='Z571819'><span><span class='ident'>ts</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;<span id='Z571959'><span><span class='ident'>getcode</span></span></span><span class='lexic'>(</span><span id='Z571815'><span><span class='ident'>t</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>=</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>genssa2</span>&nbsp;<span class='lexic'>(</span><span class='ident'>top</span><span class='lexic'>:</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z571815",this)' onmouseleave='srcref_leave("Z571815",this)'><span><span class='ident'>t</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>once</span>&nbsp;<span class='ident'>top</span>&nbsp;<span class='lexic'>{</span>&nbsp;<span id='Z571812'><span><span class='ident'>f</span></span></span>&nbsp;&#8594;&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z571812",this)' onmouseleave='srcref_leave("Z571812",this)'><span><span class='ident'>body</span></span></span><span class='hint'>f(nm,ret,args,body)</span></span>&nbsp;<span class='lexic'>}};</span><br>
&nbsp;&nbsp;<span class='keyword'>map</span>&nbsp;<span id='Z571827'><span><span class='ident'>t</span></span></span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z571819",this)' onmouseleave='srcref_leave("Z571819",this)'><span><span class='ident'>ts</span></span></span>&nbsp;<span class='keyword'>do</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0flat2</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>top</span><span class='lexic'>:</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z571827",this)' onmouseleave='srcref_leave("Z571827",this)'><span><span class='ident'>t</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>once</span>&nbsp;<span class='ident'>top</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z571936'><span><span class='ident'>sfunction</span></span></span>&nbsp;&#8594;&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z571970'><span><span class='ident'>assa</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='symbol'>'f'</span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z571936",this)' onmouseleave='srcref_leave("Z571936",this)'><span><span class='ident'>id</span></span></span><span class='hint'>sfunction(id,args,body)</span></span><span class='lexic'>,</span>&nbsp;<span class='symbol'>'any'</span><span class='lexic'>(),</span>&nbsp;<span class='keyword'>map</span>&nbsp;<span id='Z571946'><span><span class='ident'>a</span></span></span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z571936",this)' onmouseleave='srcref_leave("Z571936",this)'><span><span class='ident'>args</span></span></span><span class='hint'>sfunction(id,args,body)</span></span>&nbsp;<span class='keyword'>do</span>&nbsp;<span class='lexic'>[</span><span class='symbol'>'any'</span><span class='lexic'>();</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z571946",this)' onmouseleave='srcref_leave("Z571946",this)'><span><span class='ident'>a</span></span></span><span class='lexic'>],</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href='#Z567449'><span class='ident'>l0_to_abstract_ssa_code</span></a><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z571936",this)' onmouseleave='srcref_leave("Z571936",this)'><span><span class='ident'>body</span></span></span><span class='hint'>sfunction(id,args,body)</span></span><span class='lexic'>));</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z571958'><span><span class='ident'>varht</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<a href='#Z571248'><span class='ident'>l0_varht</span></a><span class='lexic'>(</span><span class='ident'>thisnodesrc</span><span class='lexic'>());</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>&lt;</span><span class='ident'><span class='pattern'>ht</span></span><span class='lexic'><span class='pattern'>:</span></span><span id='Z571960'><span><span class='ident'><span class='pattern'>nv</span></span></span></span><span class='lexic'>&gt;</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='ident'>genssa2_process</span><span class='lexic'>(</span><span class='ident'>l0_default_model</span><span class='lexic'>,</span>&nbsp;<span class='ident'>mkhash</span><span class='lexic'>(),</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z571970",this)' onmouseleave='srcref_leave("Z571970",this)'><span><span class='ident'>assa</span></span></span><span class='lexic'>);</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z571964'><span><span class='ident'>back</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<a href='#Z569642'><span class='ident'>l0_from_abstract_ssa_code</span></a><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z571958",this)' onmouseleave='srcref_leave("Z571958",this)'><span><span class='ident'>varht</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z571959",this)' onmouseleave='srcref_leave("Z571959",this)'><span><span class='ident'>getcode</span></span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z571960",this)' onmouseleave='srcref_leave("Z571960",this)'><span><span class='ident'>nv</span></span></span><span class='lexic'>));</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='keyword'>node</span><span class='hint'>lang0flat2:top:sfunction(id,args,body)<br>
&nbsp;&nbsp;&nbsp;with&nbsp;implicit&nbsp;arguments:&nbsp;id,&nbsp;args<br>
</span></span><span class='lexic'>(</span><span class='ident'>body</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z571964",this)' onmouseleave='srcref_leave("Z571964",this)'><span><span class='ident'>back</span></span></span><span class='lexic'>)}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span id='Z571984'><span><span class='ident'>closure</span></span></span>&nbsp;&#8594;&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z572025'><span><span class='ident'>assa</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='symbol'>'f'</span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z571984",this)' onmouseleave='srcref_leave("Z571984",this)'><span><span class='ident'>id</span></span></span><span class='hint'>closure(id,clargs,args,body)</span></span><span class='lexic'>,</span>&nbsp;<span class='symbol'>'any'</span><span class='lexic'>(),</span>&nbsp;<span class='lexic'>[@</span><span class='keyword'>map</span>&nbsp;<span id='Z571994'><span><span class='ident'>a</span></span></span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z571984",this)' onmouseleave='srcref_leave("Z571984",this)'><span><span class='ident'>args</span></span></span><span class='hint'>closure(id,clargs,args,body)</span></span>&nbsp;<span class='keyword'>do</span>&nbsp;<span class='lexic'>[</span><span class='symbol'>'any'</span><span class='lexic'>();</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z571994",this)' onmouseleave='srcref_leave("Z571994",this)'><span><span class='ident'>a</span></span></span><span class='lexic'>];</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>@</span><span class='keyword'>map</span>&nbsp;<span id='Z572002'><span><span class='ident'>a</span></span></span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z571984",this)' onmouseleave='srcref_leave("Z571984",this)'><span><span class='ident'>clargs</span></span></span><span class='hint'>closure(id,clargs,args,body)</span></span>&nbsp;<span class='keyword'>do</span>&nbsp;<span class='lexic'>[</span><span class='symbol'>'any'</span><span class='lexic'>();</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z572002",this)' onmouseleave='srcref_leave("Z572002",this)'><span><span class='ident'>a</span></span></span><span class='lexic'>]],</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href='#Z567449'><span class='ident'>l0_to_abstract_ssa_code</span></a><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z571984",this)' onmouseleave='srcref_leave("Z571984",this)'><span><span class='ident'>body</span></span></span><span class='hint'>closure(id,clargs,args,body)</span></span><span class='lexic'>));</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z572014'><span><span class='ident'>varht</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<a href='#Z571248'><span class='ident'>l0_varht</span></a><span class='lexic'>(</span><span class='ident'>thisnodesrc</span><span class='lexic'>());</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>&lt;</span><span class='ident'><span class='pattern'>ht</span></span><span class='lexic'><span class='pattern'>:</span></span><span id='Z572015'><span><span class='ident'><span class='pattern'>nv</span></span></span></span><span class='lexic'>&gt;</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='ident'>genssa2_process</span><span class='lexic'>(</span><span class='ident'>l0_default_model</span><span class='lexic'>,</span>&nbsp;<span class='ident'>mkhash</span><span class='lexic'>(),</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z572025",this)' onmouseleave='srcref_leave("Z572025",this)'><span><span class='ident'>assa</span></span></span><span class='lexic'>);</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z572019'><span><span class='ident'>back</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<a href='#Z569642'><span class='ident'>l0_from_abstract_ssa_code</span></a><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z572014",this)' onmouseleave='srcref_leave("Z572014",this)'><span><span class='ident'>varht</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z571959",this)' onmouseleave='srcref_leave("Z571959",this)'><span><span class='ident'>getcode</span></span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z572015",this)' onmouseleave='srcref_leave("Z572015",this)'><span><span class='ident'>nv</span></span></span><span class='lexic'>));</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='keyword'>node</span><span class='hint'>lang0flat2:top:closure(id,clargs,args,body)<br>
&nbsp;&nbsp;&nbsp;with&nbsp;implicit&nbsp;arguments:&nbsp;id,&nbsp;clargs,&nbsp;args<br>
</span></span><span class='lexic'>(</span><span class='ident'>body</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z572019",this)' onmouseleave='srcref_leave("Z572019",this)'><span><span class='ident'>back</span></span></span><span class='lexic'>)}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='ident'>node</span><span class='lexic'>()}}}}</span>
<p></div>





<h2>Feedback codegen backend</h2>

Since this language allows compile time macros, we need two different backends -
one for emiting the final code, and another for interpreting the code that might
be used by the macros.

For the latter we'll implement a primitive .net backend. Partly because it's an
opportunity to showcase a few patterns in compiling an SSA IR into a stack-based
target. It will consist of the following steps:

<ul>

  <li>Out of SSA: we'll simply eliminate all the phi nodes and replace them with
loads and stores placed accordingly.

  <li>Back to trees: collapse the register assignment sequences into expression
trees where possible without affecting the effect order.

  <li>Register elimination: all the register assignments left after the previous
pass must now be converted into local variables (with explicit loads and
stores).

  <li>Stack machine codegen.

</ul>

One might ask, why did we go through all those complex rewrite steps to get back
to the expression trees again? Firstly, the expression trees are a bit different
now - they do not contain any control flow inside, it's broken into basic blocks
already. Secondly, we had an opportunity to do all the SSA-based stuff which is
not possible on a primitive expression tree based IR.

And, also, it is a bit ironic, but we're doing a redundant work here by making
our IR stack-friendly - the .net engine will quickly turn it back into SSA again
at a first opportunity.

<h3>Out of SSA</h3>


<p><div class='code'>
<span id='Z572105'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_naive_phi_removal</span><span class='lexic'>(</span><span id='Z573317'><span><span class='ident'>c</span></span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;<span class='keyword'>collector</span><span class='lexic'>(</span><span id='Z573269'><span><span class='ident'>newvaradd</span></span></span><span class='lexic'>,</span>&nbsp;<span id='Z573578'><span><span class='ident'>newvarsget</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z573285'><span><span class='ident'>srcbbs</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='ident'>mkhash</span><span class='lexic'>();</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='comment'>//&nbsp;1.&nbsp;Collect&nbsp;phi&nbsp;variables&nbsp;and&nbsp;the&nbsp;values&nbsp;to<br>
</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='comment'>//&nbsp;&nbsp;&nbsp;&nbsp;be&nbsp;assigned&nbsp;to&nbsp;them.<br>
</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z573316'><span><span class='ident'>getphis</span></span></span><span class='lexic'>(</span><span id='Z572926'><span><span class='ident'>c</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>=</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0flat2</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>code</span><span class='lexic'>:</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z572926",this)' onmouseleave='srcref_leave("Z572926",this)'><span><span class='ident'>c</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>insn</span>&nbsp;<span class='lexic'>{</span>&nbsp;&nbsp;<span id='Z573214'><span><span class='ident'>def</span></span></span>&nbsp;&#8594;&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z573214",this)' onmouseleave='srcref_leave("Z573214",this)'><span><span class='ident'>v</span></span></span><span class='hint'>def(id,v)</span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z573214",this)' onmouseleave='srcref_leave("Z573214",this)'><span><span class='ident'>id</span></span></span><span class='hint'>def(id,v)</span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='lexic'>&#8709;</span><span class='lexic'>};</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>term</span>&nbsp;<span class='lexic'>{</span>&nbsp;&nbsp;<span id='Z573228'><span><span class='ident'>tail</span></span></span>&nbsp;&#8594;&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z573228",this)' onmouseleave='srcref_leave("Z573228",this)'><span><span class='ident'>e</span></span></span><span class='hint'>tail(e)</span></span><span class='lexic'>(</span><span class='symbol'>'*tail*'</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='lexic'>&#8709;</span><span class='lexic'>};</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>expr</span><span class='lexic'>(</span><span id='Z573270'><span><span class='ident'>dst</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z573272'><span><span class='ident'>phi</span></span></span>&nbsp;&#8594;&nbsp;<span class='lexic'>{</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z573269",this)' onmouseleave='srcref_leave("Z573269",this)'><span><span class='ident'>newvaradd</span></span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z573270",this)' onmouseleave='srcref_leave("Z573270",this)'><span><span class='ident'>dst</span></span></span><span class='lexic'>);</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>iter</span>&nbsp;<span class='lexic'>[</span><span id='Z573286'><span><span class='ident'><span class='pattern'>s</span></span></span></span><span class='lexic'>;</span><span id='Z573287'><span><span class='ident'><span class='pattern'>v</span></span></span></span><span class='lexic'>]</span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z573272",this)' onmouseleave='srcref_leave("Z573272",this)'><span><span class='ident'>ss</span></span></span><span class='hint'>phi(ss)</span></span>&nbsp;<span class='keyword'>do</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='ident'>ohashput</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z573285",this)' onmouseleave='srcref_leave("Z573285",this)'><span><span class='ident'>srcbbs</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z573286",this)' onmouseleave='srcref_leave("Z573286",this)'><span><span class='ident'>s</span></span></span><span class='lexic'>,</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>[</span><span class='idfrom' onmouseenter='srcref_over("Z573270",this)' onmouseleave='srcref_leave("Z573270",this)'><span><span class='ident'>dst</span></span></span><span class='lexic'>;</span><span class='idfrom' onmouseenter='srcref_over("Z573287",this)' onmouseleave='srcref_leave("Z573287",this)'><span><span class='ident'>v</span></span></span><span class='lexic'>]:</span><span class='ident'>ohashget</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z573285",this)' onmouseleave='srcref_leave("Z573285",this)'><span><span class='ident'>srcbbs</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z573286",this)' onmouseleave='srcref_leave("Z573286",this)'><span><span class='ident'>s</span></span></span><span class='lexic'>))}}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='lexic'>&#8709;</span><span class='lexic'>};</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>phisrc</span>&nbsp;<span class='lexic'>{</span>&nbsp;<span id='Z573306'><span><span class='ident'>s</span></span></span>&nbsp;&#8594;&nbsp;<span class='lexic'>[</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z573306",this)' onmouseleave='srcref_leave("Z573306",this)'><span><span class='ident'>from</span></span></span><span class='hint'>s(from,v)</span></span><span class='lexic'>;</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z573306",this)' onmouseleave='srcref_leave("Z573306",this)'><span><span class='ident'>v</span></span></span><span class='hint'>s(from,v)</span></span><span class='lexic'>]</span>&nbsp;<span class='lexic'>}};</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z573316",this)' onmouseleave='srcref_leave("Z573316",this)'><span><span class='ident'>getphis</span></span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z573317",this)' onmouseleave='srcref_leave("Z573317",this)'><span><span class='ident'>c</span></span></span><span class='lexic'>);</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='comment'>//&nbsp;2.&nbsp;Rewrite&nbsp;the&nbsp;phi&nbsp;origin&nbsp;basic&nbsp;blocks&nbsp;and<br>
</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='comment'>//&nbsp;&nbsp;&nbsp;&nbsp;add&nbsp;all&nbsp;the&nbsp;allocas&nbsp;to&nbsp;the&nbsp;'entry'&nbsp;basic&nbsp;block.<br>
</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0flat2</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>code</span><span class='lexic'>:</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z573317",this)' onmouseleave='srcref_leave("Z573317",this)'><span><span class='ident'>c</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>bblock</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z573572'><span><span class='ident'>bb</span></span></span>&nbsp;&#8594;&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z573625'><span><span class='ident'>pfx</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='keyword'>if</span>&nbsp;<span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z573572",this)' onmouseleave='srcref_leave("Z573572",this)'><span><span class='ident'>lbl</span></span></span><span class='hint'>bb(lbl,body,t)</span></span>&nbsp;<span class='lexic'>===</span>&nbsp;<span class='symbol'>'entry'</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>map</span>&nbsp;<span id='Z573582'><span><span class='ident'>v</span></span></span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z573578",this)' onmouseleave='srcref_leave("Z573578",this)'><span><span class='ident'>newvarsget</span></span></span><span class='lexic'>()</span>&nbsp;<span class='keyword'>do</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z573586'><span><span class='ident'>vnm</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='withhint'><span class='ident'>%Sm&lt;&lt;</span><span class='hint'>macro&nbsp;Sm&lt;&lt;&nbsp;args:&nbsp;<br>
Same&nbsp;as&nbsp;[(string-&gt;symbol&nbsp;(S&lt;&lt;&nbsp;...))]</span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z573582",this)' onmouseleave='srcref_leave("Z573582",this)'><span><span class='ident'>v</span></span></span><span class='lexic'>,</span>&nbsp;<span class='const'>&quot;_alloc&quot;</span><span class='lexic'>);</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>insn</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>alloca</span><span class='hint'>lang0flat2:insn:alloca(id)</span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z573586",this)' onmouseleave='srcref_leave("Z573586",this)'><span><span class='ident'>vnm</span></span></span><span class='lexic'>)}}</span>&nbsp;<span class='keyword'>else</span>&nbsp;<span class='lexic'>&#8709;</span><span class='lexic'>;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z573628'><span><span class='ident'>sfx</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z573599'><span><span class='ident'>chk</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='ident'>ohashget</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z573285",this)' onmouseleave='srcref_leave("Z573285",this)'><span><span class='ident'>srcbbs</span></span></span><span class='lexic'>,</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z573572",this)' onmouseleave='srcref_leave("Z573572",this)'><span><span class='ident'>lbl</span></span></span><span class='hint'>bb(lbl,body,t)</span></span><span class='lexic'>);</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>map</span>&nbsp;<span class='lexic'>[</span><span id='Z573615'><span><span class='ident'><span class='pattern'>dst</span></span></span></span><span class='lexic'>;</span><span id='Z573616'><span><span class='ident'><span class='pattern'>v</span></span></span></span><span class='lexic'>]</span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z573599",this)' onmouseleave='srcref_leave("Z573599",this)'><span><span class='ident'>chk</span></span></span>&nbsp;<span class='keyword'>do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>insn</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>set</span><span class='hint'>lang0flat2:insn:set(id,v)</span></span><span class='lexic'>(</span><span class='withhint'><span class='ident'>%Sm&lt;&lt;</span><span class='hint'>macro&nbsp;Sm&lt;&lt;&nbsp;args:&nbsp;<br>
Same&nbsp;as&nbsp;[(string-&gt;symbol&nbsp;(S&lt;&lt;&nbsp;...))]</span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z573615",this)' onmouseleave='srcref_leave("Z573615",this)'><span><span class='ident'>dst</span></span></span><span class='lexic'>,</span>&nbsp;<span class='const'>&quot;_alloc&quot;</span><span class='lexic'>),</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z573616",this)' onmouseleave='srcref_leave("Z573616",this)'><span><span class='ident'>v</span></span></span><span class='lexic'>)};</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='keyword'>node</span><span class='hint'>lang0flat2:bblock:bb(lbl,body,t)<br>
&nbsp;&nbsp;&nbsp;with&nbsp;implicit&nbsp;arguments:&nbsp;lbl,&nbsp;t<br>
</span></span><span class='lexic'>(</span><span class='ident'>body</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z573625",this)' onmouseleave='srcref_leave("Z573625",this)'><span><span class='ident'>pfx</span></span></span>&nbsp;<span class='lexic'>&#8853;</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z573572",this)' onmouseleave='srcref_leave("Z573572",this)'><span><span class='ident'>body</span></span></span><span class='hint'>bb(lbl,body,t)</span></span>&nbsp;<span class='lexic'>&#8853;</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z573628",this)' onmouseleave='srcref_leave("Z573628",this)'><span><span class='ident'>sfx</span></span></span><span class='lexic'>)}};</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>term</span>&nbsp;<span class='lexic'>{</span>&nbsp;<span id='Z573637'><span><span class='ident'>tail</span></span></span>&nbsp;&#8594;&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z573637",this)' onmouseleave='srcref_leave("Z573637",this)'><span><span class='ident'>e</span></span></span><span class='hint'>tail(e)</span></span><span class='lexic'>(</span><span class='symbol'>'*tail*'</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>|</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='ident'>node</span><span class='lexic'>()</span>&nbsp;<span class='lexic'>};</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>insn</span>&nbsp;<span class='lexic'>{</span>&nbsp;<span id='Z573667'><span><span class='ident'>def</span></span></span>&nbsp;&#8594;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='keyword'>node</span><span class='hint'>lang0flat2:insn:def(id,v)<br>
&nbsp;&nbsp;&nbsp;with&nbsp;implicit&nbsp;arguments:&nbsp;id<br>
</span></span><span class='lexic'>(</span><span class='ident'>v</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z573667",this)' onmouseleave='srcref_leave("Z573667",this)'><span><span class='ident'>v</span></span></span><span class='hint'>def(id,v)</span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z573667",this)' onmouseleave='srcref_leave("Z573667",this)'><span><span class='ident'>id</span></span></span><span class='hint'>def(id,v)</span></span><span class='lexic'>))</span>&nbsp;<span class='lexic'>|</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='ident'>node</span><span class='lexic'>()</span>&nbsp;<span class='lexic'>};</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>expr</span><span class='lexic'>(</span><span id='Z573709'><span><span class='ident'>dst</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='ident'>phi</span>&nbsp;&#8594;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>load</span><span class='hint'>lang0flat2:expr:load(id)</span></span><span class='lexic'>(</span><span class='withhint'><span class='ident'>%Sm&lt;&lt;</span><span class='hint'>macro&nbsp;Sm&lt;&lt;&nbsp;args:&nbsp;<br>
Same&nbsp;as&nbsp;[(string-&gt;symbol&nbsp;(S&lt;&lt;&nbsp;...))]</span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z573709",this)' onmouseleave='srcref_leave("Z573709",this)'><span><span class='ident'>dst</span></span></span><span class='lexic'>,</span>&nbsp;<span class='const'>&quot;_alloc&quot;</span><span class='lexic'>))</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='ident'>node</span><span class='lexic'>()}}}</span>
<p></div>


The only cases where a registers are set to <b>load(something)</b> are from the
previous pass here, and it is safe to demote all such loads to values.


<p><div class='code'>
<span class='keyword'>ast</span>&nbsp;<span class='ident'>lang0flat2x</span>&nbsp;<span class='lexic'>:</span>&nbsp;<span class='ident'>lang0flat2</span>&nbsp;<span class='lexic'>()</span>&nbsp;<span class='keyword'>recform</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;<span class='ident'>value</span>&nbsp;<span class='lexic'>+=</span>&nbsp;<span class='ident'>load</span><span class='lexic'>(</span><span class='ident'>ident</span><span class='lexic'>:</span><span class='ident'>id</span><span class='lexic'>);</span><br>
<span class='lexic'>}</span>
<p></div>



<p><div class='code'>
<span id='Z573937'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_reduce_loads</span><span class='lexic'>(</span><span id='Z574797'><span><span class='ident'>c</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;<span id='Z575066'><span><span class='ident'>lht</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='ident'>mkhash</span><span class='lexic'>();</span><br>
&nbsp;&nbsp;&nbsp;<span id='Z575132'><span><span class='ident'>fill</span></span></span><span class='lexic'>()</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0flat2</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>code</span><span class='lexic'>:</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z574797",this)' onmouseleave='srcref_leave("Z574797",this)'><span><span class='ident'>c</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>expr</span><span class='lexic'>(</span><span id='Z575067'><span><span class='ident'>dst</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z575068'><span><span class='ident'>load</span></span></span>&nbsp;&#8594;&nbsp;<span class='ident'>ohashput</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z575066",this)' onmouseleave='srcref_leave("Z575066",this)'><span><span class='ident'>lht</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z575067",this)' onmouseleave='srcref_leave("Z575067",this)'><span><span class='ident'>dst</span></span></span><span class='lexic'>,</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z575068",this)' onmouseleave='srcref_leave("Z575068",this)'><span><span class='ident'>id</span></span></span><span class='hint'>load(id)</span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='lexic'>&#8709;</span><span class='lexic'>};</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>term</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z575089'><span><span class='ident'>tail</span></span></span>&nbsp;&#8594;&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z575089",this)' onmouseleave='srcref_leave("Z575089",this)'><span><span class='ident'>e</span></span></span><span class='hint'>tail(e)</span></span><span class='lexic'>(</span><span class='symbol'>'_'</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>|</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='lexic'>&#8709;</span><span class='lexic'>};</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>insn</span>&nbsp;<span class='lexic'>{</span>&nbsp;<span id='Z575116'><span><span class='ident'>def</span></span></span>&nbsp;&#8594;&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z575116",this)' onmouseleave='srcref_leave("Z575116",this)'><span><span class='ident'>v</span></span></span><span class='hint'>def(id,v)</span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z575116",this)' onmouseleave='srcref_leave("Z575116",this)'><span><span class='ident'>id</span></span></span><span class='hint'>def(id,v)</span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>|</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='lexic'>&#8709;</span><span class='lexic'>}};</span><br>
&nbsp;&nbsp;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z575132",this)' onmouseleave='srcref_leave("Z575132",this)'><span><span class='ident'>fill</span></span></span><span class='lexic'>();</span><br>
&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0flat2</span>&nbsp;<span class='lexic'>/rec,</span>&nbsp;<span class='lexic'>dst</span>&nbsp;<span class='ident'>lang0flat2x</span><span class='lexic'>/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>code</span><span class='lexic'>:</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z574797",this)' onmouseleave='srcref_leave("Z574797",this)'><span><span class='ident'>c</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>insn</span>&nbsp;<span class='lexic'>{</span>&nbsp;<span id='Z575551'><span><span class='ident'>def</span></span></span>&nbsp;&#8594;&nbsp;<span class='keyword'>if</span>&nbsp;<span class='lexic'>(</span><span class='ident'>ohashget</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z575066",this)' onmouseleave='srcref_leave("Z575066",this)'><span><span class='ident'>lht</span></span></span><span class='lexic'>,</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z575551",this)' onmouseleave='srcref_leave("Z575551",this)'><span><span class='ident'>id</span></span></span><span class='hint'>def(id,v)</span></span><span class='lexic'>))</span>&nbsp;<span class='lexic'>&#8709;</span>&nbsp;<span class='keyword'>else</span>&nbsp;<span class='lexic'>[</span><span class='ident'>node</span><span class='lexic'>()]</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='lexic'>[</span><span class='ident'>node</span><span class='lexic'>()]};</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>bblock</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z575581'><span><span class='ident'>bb</span></span></span>&nbsp;&#8594;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='keyword'>node</span><span class='hint'>lang0flat2x:bblock:bb(lbl,body,t)<br>
&nbsp;&nbsp;&nbsp;with&nbsp;implicit&nbsp;arguments:&nbsp;lbl,&nbsp;t<br>
</span></span><span class='lexic'>(</span><span class='ident'>body</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='keyword'>map</span>&nbsp;<span class='keyword'>append</span>&nbsp;<span id='Z575586'><span><span class='ident'>b</span></span></span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z575581",this)' onmouseleave='srcref_leave("Z575581",this)'><span><span class='ident'>body</span></span></span><span class='hint'>bb(lbl,body,t)</span></span>&nbsp;<span class='keyword'>do</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z575586",this)' onmouseleave='srcref_leave("Z575586",this)'><span><span class='ident'>b</span></span></span><span class='lexic'>)};</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>value</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z575609'><span><span class='ident'>reg</span></span></span>&nbsp;&#8594;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>aif</span>&nbsp;<span class='lexic'>(</span><span class='ident'>chk</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='ident'>ohashget</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z575066",this)' onmouseleave='srcref_leave("Z575066",this)'><span><span class='ident'>lht</span></span></span><span class='lexic'>,</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z575609",this)' onmouseleave='srcref_leave("Z575609",this)'><span><span class='ident'>id</span></span></span><span class='hint'>reg(id)</span></span><span class='lexic'>))</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>value</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>load</span><span class='hint'>lang0flat2x:value:load(id)</span></span><span class='lexic'>(</span><span class='ident'>chk</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>else</span>&nbsp;<span class='ident'>node</span><span class='lexic'>()}}}</span>
<p></div>


<h3>Back to trees</h3>

.NET target is a stack machine, so it makes sense to fold the sequential single use register
assignments back into expression trees.


<p><div class='code'>
<span class='keyword'>ast</span>&nbsp;<span class='ident'>lang0unflat1</span>&nbsp;<span class='lexic'>:</span>&nbsp;<span class='ident'>lang0flat2x</span>&nbsp;<span class='lexic'>()</span>&nbsp;<span class='keyword'>recform</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;<span class='ident'>value</span>&nbsp;<span class='lexic'>+=</span>&nbsp;<span class='ident'>expr</span><span class='lexic'>(</span><span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>e</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>load</span><span class='lexic'>(</span><span class='ident'>ident</span><span class='lexic'>:</span><span class='ident'>id</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>;</span><br>
<span class='lexic'>}</span>
<p></div>



<p><div class='code'>
<span id='Z575818'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_is_ordered</span><span class='lexic'>(</span><span class='ident'>e</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;<span class='comment'>//TODO!!!<br>
</span>&nbsp;&nbsp;<span class='keyword'>return</span>&nbsp;<span class='lexic'>&#8709;</span><br>
<span class='lexic'>}</span>
<p></div>



<p><div class='code'>
<span id='Z575823'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_bblock_to_trees</span><span class='lexic'>(</span><span id='Z579749'><span><span class='ident'>cnt</span></span></span><span class='lexic'>,</span>&nbsp;<span id='Z578720'><span><span class='ident'>bb</span></span></span><span class='lexic'>)</span><br>
<span class='keyword'>collector</span><span class='lexic'>(</span><span id='Z578710'><span><span class='ident'>ordlistadd</span></span></span><span class='lexic'>,</span>&nbsp;<span id='Z579299'><span><span class='ident'>ordget</span></span></span><span class='lexic'>)</span><br>
<span class='keyword'>collector</span><span class='lexic'>(</span><span id='Z579272'><span><span class='ident'>useadd</span></span></span><span class='lexic'>,</span>&nbsp;<span id='Z579300'><span><span class='ident'>useget</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;<span class='comment'>//&nbsp;1.&nbsp;Collect&nbsp;the&nbsp;register&nbsp;definitions&nbsp;and<br>
</span>&nbsp;&nbsp;<span class='comment'>//&nbsp;&nbsp;&nbsp;&nbsp;fill&nbsp;the&nbsp;ordered&nbsp;list.<br>
</span>&nbsp;&nbsp;<span id='Z578817'><span><span class='ident'>defsht</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='ident'>mkhash</span><span class='lexic'>();</span>&nbsp;<span id='Z578712'><span><span class='ident'>ordered</span></span></span><span class='lexic'>=</span><span class='ident'>mkhash</span><span class='lexic'>();</span><br>
&nbsp;&nbsp;<span id='Z578825'><span><span class='ident'>ordadd</span></span></span><span class='lexic'>(</span><span id='Z578711'><span><span class='ident'>id</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='lexic'>{</span><span class='idfrom' onmouseenter='srcref_over("Z578710",this)' onmouseleave='srcref_leave("Z578710",this)'><span><span class='ident'>ordlistadd</span></span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z578711",this)' onmouseleave='srcref_leave("Z578711",this)'><span><span class='ident'>id</span></span></span><span class='lexic'>);</span>&nbsp;<span class='ident'>ohashput</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z578712",this)' onmouseleave='srcref_leave("Z578712",this)'><span><span class='ident'>ordered</span></span></span><span class='lexic'>,</span><span class='idfrom' onmouseenter='srcref_over("Z578711",this)' onmouseleave='srcref_leave("Z578711",this)'><span><span class='ident'>id</span></span></span><span class='lexic'>,</span><span class='idfrom' onmouseenter='srcref_over("Z578711",this)' onmouseleave='srcref_leave("Z578711",this)'><span><span class='ident'>id</span></span></span><span class='lexic'>)};</span><br>
&nbsp;&nbsp;<span id='Z578839'><span><span class='ident'>fillht</span></span></span><span class='lexic'>()</span>&nbsp;<span class='lexic'>=</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0flat2x</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>bblock</span><span class='lexic'>:</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z578720",this)' onmouseleave='srcref_leave("Z578720",this)'><span><span class='ident'>bb</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>once</span>&nbsp;<span class='ident'>insn</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z578818'><span><span class='ident'>def</span></span></span>&nbsp;&#8594;&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='ident'>ohashput</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z578817",this)' onmouseleave='srcref_leave("Z578817",this)'><span><span class='ident'>defsht</span></span></span><span class='lexic'>,</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z578818",this)' onmouseleave='srcref_leave("Z578818",this)'><span><span class='ident'>id</span></span></span><span class='hint'>def(id,v)</span></span><span class='lexic'>,</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z578818",this)' onmouseleave='srcref_leave("Z578818",this)'><span><span class='ident'>v</span></span></span><span class='hint'>def(id,v)</span></span><span class='lexic'>);</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>if</span>&nbsp;<span class='lexic'>(</span><a href='#Z575818'><span class='ident'>l0_is_ordered</span></a><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z578818",this)' onmouseleave='srcref_leave("Z578818",this)'><span><span class='ident'>v</span></span></span><span class='hint'>def(id,v)</span></span><span class='lexic'>))</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z578825",this)' onmouseleave='srcref_leave("Z578825",this)'><span><span class='ident'>ordadd</span></span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z578818",this)' onmouseleave='srcref_leave("Z578818",this)'><span><span class='ident'>id</span></span></span><span class='hint'>def(id,v)</span></span><span class='lexic'>);}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='lexic'>&#8709;</span><span class='lexic'>}};</span><br>
&nbsp;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z578839",this)' onmouseleave='srcref_leave("Z578839",this)'><span><span class='ident'>fillht</span></span></span><span class='lexic'>();</span><br>
&nbsp;&nbsp;<span class='comment'>//&nbsp;2.&nbsp;See&nbsp;which&nbsp;register&nbsp;references&nbsp;defies&nbsp;The&nbsp;Order.<br>
</span>&nbsp;&nbsp;<span id='Z579286'><span><span class='ident'>mkord</span></span></span><span class='lexic'>()</span>&nbsp;<span class='lexic'>=</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0flat2x</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>bblock</span><span class='lexic'>:</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z578720",this)' onmouseleave='srcref_leave("Z578720",this)'><span><span class='ident'>bb</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>once</span>&nbsp;<span class='ident'>value</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z579269'><span><span class='ident'>reg</span></span></span>&nbsp;&#8594;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>if</span>&nbsp;<span class='lexic'>(</span><span class='ident'>ohashget</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z578712",this)' onmouseleave='srcref_leave("Z578712",this)'><span><span class='ident'>ordered</span></span></span><span class='lexic'>,</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z579269",this)' onmouseleave='srcref_leave("Z579269",this)'><span><span class='ident'>id</span></span></span><span class='hint'>reg(id)</span></span><span class='lexic'>))</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z579272",this)' onmouseleave='srcref_leave("Z579272",this)'><span><span class='ident'>useadd</span></span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z579269",this)' onmouseleave='srcref_leave("Z579269",this)'><span><span class='ident'>id</span></span></span><span class='hint'>reg(id)</span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='lexic'>&#8709;</span><span class='lexic'>}};</span><br>
&nbsp;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z579286",this)' onmouseleave='srcref_leave("Z579286",this)'><span><span class='ident'>mkord</span></span></span><span class='lexic'>();</span><br>
&nbsp;&nbsp;<span id='Z579298'><span><span class='ident'>outoford</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='ident'>mkhash</span><span class='lexic'>();</span><br>
&nbsp;&nbsp;<span class='keyword'>do</span>&nbsp;<span id='Z579297'><span><span class='ident'>loop</span></span></span><span class='lexic'>(</span><span id='Z579291'><span><span class='ident'>defs</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z579299",this)' onmouseleave='srcref_leave("Z579299",this)'><span><span class='ident'>ordget</span></span></span><span class='lexic'>(),</span>&nbsp;<span id='Z579292'><span><span class='ident'>uses</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z579300",this)' onmouseleave='srcref_leave("Z579300",this)'><span><span class='ident'>useget</span></span></span><span class='lexic'>())</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>if</span>&nbsp;<span class='lexic'>(</span><span class='ident'>not</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z579291",this)' onmouseleave='srcref_leave("Z579291",this)'><span><span class='ident'>defs</span></span></span><span class='lexic'>)</span>&nbsp;||&nbsp;<span class='ident'>not</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z579292",this)' onmouseleave='srcref_leave("Z579292",this)'><span><span class='ident'>uses</span></span></span><span class='lexic'>))</span>&nbsp;<span class='lexic'>&#8709;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>else</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z579295'><span><span class='ident'>d</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='ident'>car</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z579291",this)' onmouseleave='srcref_leave("Z579291",this)'><span><span class='ident'>defs</span></span></span><span class='lexic'>);</span>&nbsp;<span id='Z579296'><span><span class='ident'>u</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='ident'>car</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z579292",this)' onmouseleave='srcref_leave("Z579292",this)'><span><span class='ident'>uses</span></span></span><span class='lexic'>);</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>if</span>&nbsp;<span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z579295",this)' onmouseleave='srcref_leave("Z579295",this)'><span><span class='ident'>d</span></span></span>&nbsp;<span class='lexic'>===</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z579296",this)' onmouseleave='srcref_leave("Z579296",this)'><span><span class='ident'>u</span></span></span><span class='lexic'>)</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z579297",this)' onmouseleave='srcref_leave("Z579297",this)'><span><span class='ident'>loop</span></span></span><span class='lexic'>(</span><span class='ident'>cdr</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z579291",this)' onmouseleave='srcref_leave("Z579291",this)'><span><span class='ident'>defs</span></span></span><span class='lexic'>),</span>&nbsp;<span class='ident'>cdr</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z579292",this)' onmouseleave='srcref_leave("Z579292",this)'><span><span class='ident'>uses</span></span></span><span class='lexic'>))</span>&nbsp;<span class='keyword'>else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='ident'>ohashput</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z579298",this)' onmouseleave='srcref_leave("Z579298",this)'><span><span class='ident'>outoford</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z579295",this)' onmouseleave='srcref_leave("Z579295",this)'><span><span class='ident'>d</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z579295",this)' onmouseleave='srcref_leave("Z579295",this)'><span><span class='ident'>d</span></span></span><span class='lexic'>);</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z579297",this)' onmouseleave='srcref_leave("Z579297",this)'><span><span class='ident'>loop</span></span></span><span class='lexic'>(</span><span class='ident'>cdr</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z579291",this)' onmouseleave='srcref_leave("Z579291",this)'><span><span class='ident'>defs</span></span></span><span class='lexic'>),</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z579292",this)' onmouseleave='srcref_leave("Z579292",this)'><span><span class='ident'>uses</span></span></span><span class='lexic'>)</span>&nbsp;<span class='comment'>//&nbsp;TODO!!!&nbsp;wrong!!!<br>
</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>}}}</span><span class='lexic'>;</span><br>
&nbsp;&nbsp;<span class='comment'>//&nbsp;3.&nbsp;Walk&nbsp;in&nbsp;the&nbsp;reverse&nbsp;order&nbsp;and&nbsp;substitute&nbsp;the&nbsp;single-use&nbsp;definitions,<br>
</span>&nbsp;&nbsp;<span class='comment'>//&nbsp;&nbsp;&nbsp;&nbsp;as&nbsp;long&nbsp;as&nbsp;this&nbsp;substitution&nbsp;does&nbsp;not&nbsp;break&nbsp;an&nbsp;order.<br>
</span>&nbsp;&nbsp;<span id='Z579483'><span><span class='ident'>getinsns</span></span></span><span class='lexic'>()</span>&nbsp;<span class='lexic'>=</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0flat2x</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>bblock</span><span class='lexic'>:</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z578720",this)' onmouseleave='srcref_leave("Z578720",this)'><span><span class='ident'>bb</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>bblock</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z579395'><span><span class='ident'>bb</span></span></span>&nbsp;&#8594;&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z579395",this)' onmouseleave='srcref_leave("Z579395",this)'><span><span class='ident'>t</span></span></span><span class='hint'>bb(lbl,body,t)</span></span><span class='lexic'>&#8853;</span><span class='withhint'><span class='ident'>reverse</span><span class='hint'>function&nbsp;reverse&nbsp;lst:&nbsp;<br>
Returns&nbsp;the&nbsp;reversed&nbsp;list.</span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z579395",this)' onmouseleave='srcref_leave("Z579395",this)'><span><span class='ident'>body</span></span></span><span class='hint'>bb(lbl,body,t)</span></span><span class='lexic'>)};</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>once</span>&nbsp;<span class='ident'>term</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z579408'><span><span class='ident'>tail</span></span></span>&nbsp;&#8594;&nbsp;<span class='lexic'>[</span><span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>insn</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>def</span><span class='hint'>lang0flat2x:insn:def(id,v)</span></span><span class='lexic'>(</span><span class='symbol'>'_'</span><span class='lexic'>,</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z579408",this)' onmouseleave='srcref_leave("Z579408",this)'><span><span class='ident'>e</span></span></span><span class='hint'>tail(e)</span></span><span class='lexic'>)]</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span id='Z579435'><span><span class='ident'>gotoc</span></span></span>&nbsp;&#8594;&nbsp;<span class='lexic'>[</span><span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>insn</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>def</span><span class='hint'>lang0flat2x:insn:def(id,v)</span></span><span class='lexic'>(</span><span class='symbol'>'_'</span><span class='lexic'>,</span>&nbsp;<span class='ident'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>value</span><span class='hint'>lang0flat2x:expr:value(v)</span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z579435",this)' onmouseleave='srcref_leave("Z579435",this)'><span><span class='ident'>cnd</span></span></span><span class='hint'>gotoc(cnd,tr,fl)</span></span><span class='lexic'>))]</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span id='Z579458'><span><span class='ident'>return</span></span></span>&nbsp;&#8594;&nbsp;<span class='lexic'>[</span><span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>insn</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>def</span><span class='hint'>lang0flat2x:insn:def(id,v)</span></span><span class='lexic'>(</span><span class='symbol'>'_'</span><span class='lexic'>,</span>&nbsp;<span class='ident'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>value</span><span class='hint'>lang0flat2x:expr:value(v)</span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z579458",this)' onmouseleave='srcref_leave("Z579458",this)'><span><span class='ident'>v</span></span></span><span class='hint'>return(v)</span></span><span class='lexic'>))]</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='lexic'>&#8709;</span><span class='lexic'>}};</span><br>
&nbsp;&nbsp;<span id='Z579480'><span><span class='ident'>removedht</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='ident'>mkhash</span><span class='lexic'>();</span><br>
&nbsp;&nbsp;<span id='Z579857'><span><span class='ident'>removed</span></span></span><span class='lexic'>(</span><span id='Z579481'><span><span class='ident'>id</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='ident'>ohashget</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z579480",this)' onmouseleave='srcref_leave("Z579480",this)'><span><span class='ident'>removedht</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z579481",this)' onmouseleave='srcref_leave("Z579481",this)'><span><span class='ident'>id</span></span></span><span class='lexic'>);</span><br>
&nbsp;&nbsp;<span id='Z579793'><span><span class='ident'>insns</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z579483",this)' onmouseleave='srcref_leave("Z579483",this)'><span><span class='ident'>getinsns</span></span></span><span class='lexic'>();</span><br>
&nbsp;&nbsp;<span id='Z579864'><span><span class='ident'>process_expr</span></span></span><span class='lexic'>(</span><span id='Z579782'><span><span class='ident'>e0</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>=</span><br>
&nbsp;&nbsp;<span class='keyword'>do</span>&nbsp;<span id='Z579765'><span><span class='ident'>loop</span></span></span><span class='lexic'>(</span><span id='Z579494'><span><span class='ident'>e</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z579782",this)' onmouseleave='srcref_leave("Z579782",this)'><span><span class='ident'>e0</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0flat2x</span>&nbsp;<span class='lexic'>/rec,</span>&nbsp;<span class='lexic'>dst</span>&nbsp;<span class='ident'>lang0unflat1</span><span class='lexic'>/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>expr</span><span class='lexic'>:</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z579494",this)' onmouseleave='srcref_leave("Z579494",this)'><span><span class='ident'>e</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>once</span>&nbsp;<span class='ident'>value</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z579750'><span><span class='ident'>reg</span></span></span>&nbsp;&#8594;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>if</span>&nbsp;<span class='lexic'>(</span><span class='ident'>ohashget</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z579749",this)' onmouseleave='srcref_leave("Z579749",this)'><span><span class='ident'>cnt</span></span></span><span class='lexic'>,</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z579750",this)' onmouseleave='srcref_leave("Z579750",this)'><span><span class='ident'>id</span></span></span><span class='hint'>reg(id)</span></span><span class='lexic'>)</span>&nbsp;==&nbsp;<span class='const'>1</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='comment'>//&nbsp;is&nbsp;it&nbsp;defined&nbsp;in&nbsp;the&nbsp;same&nbsp;bb?<br>
</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>aif</span>&nbsp;<span class='lexic'>(</span><span class='ident'>chk</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='ident'>ohashget</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z578817",this)' onmouseleave='srcref_leave("Z578817",this)'><span><span class='ident'>defsht</span></span></span><span class='lexic'>,</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z579750",this)' onmouseleave='srcref_leave("Z579750",this)'><span><span class='ident'>id</span></span></span><span class='hint'>reg(id)</span></span><span class='lexic'>))</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>if</span>&nbsp;<span class='lexic'>(</span><span class='ident'>not</span>&nbsp;<span class='lexic'>(</span><span class='ident'>ohashget</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z579298",this)' onmouseleave='srcref_leave("Z579298",this)'><span><span class='ident'>outoford</span></span></span><span class='lexic'>,</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z579750",this)' onmouseleave='srcref_leave("Z579750",this)'><span><span class='ident'>id</span></span></span><span class='hint'>reg(id)</span></span><span class='lexic'>)))</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='ident'>ohashput</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z579480",this)' onmouseleave='srcref_leave("Z579480",this)'><span><span class='ident'>removedht</span></span></span><span class='lexic'>,</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z579750",this)' onmouseleave='srcref_leave("Z579750",this)'><span><span class='ident'>id</span></span></span><span class='hint'>reg(id)</span></span><span class='lexic'>,</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z579750",this)' onmouseleave='srcref_leave("Z579750",this)'><span><span class='ident'>id</span></span></span><span class='hint'>reg(id)</span></span><span class='lexic'>);</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>value</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>expr</span><span class='hint'>lang0unflat1:value:expr(e)</span></span><span class='lexic'>(</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z579765",this)' onmouseleave='srcref_leave("Z579765",this)'><span><span class='ident'>loop</span></span></span>&nbsp;<span class='lexic'>(</span><span class='ident'>chk</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>}</span>&nbsp;<span class='keyword'>else</span>&nbsp;<span class='ident'>node</span><span class='lexic'>()</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>}</span>&nbsp;<span class='keyword'>else</span>&nbsp;<span class='ident'>node</span><span class='lexic'>()</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>}</span>&nbsp;<span class='keyword'>else</span>&nbsp;<span class='ident'>node</span><span class='lexic'>()</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='ident'>node</span><span class='lexic'>()}}}</span><span class='lexic'>;</span><br>
&nbsp;&nbsp;<span id='Z581546'><span><span class='ident'>newinsns</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='keyword'>map</span>&nbsp;<span class='keyword'>append</span>&nbsp;<span id='Z579801'><span><span class='ident'>i</span></span></span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z579793",this)' onmouseleave='srcref_leave("Z579793",this)'><span><span class='ident'>insns</span></span></span>&nbsp;<span class='keyword'>do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0flat2x</span>&nbsp;<span class='lexic'>/rec,</span>&nbsp;<span class='lexic'>dst</span>&nbsp;<span class='ident'>lang0unflat1</span><span class='lexic'>/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>insn</span><span class='lexic'>:</span><span class='idfrom' onmouseenter='srcref_over("Z579801",this)' onmouseleave='srcref_leave("Z579801",this)'><span><span class='ident'>i</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>once</span>&nbsp;<span class='ident'>insn</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z579858'><span><span class='ident'>def</span></span></span>&nbsp;&#8594;&nbsp;<span class='keyword'>if</span>&nbsp;<span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z579857",this)' onmouseleave='srcref_leave("Z579857",this)'><span><span class='ident'>removed</span></span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z579858",this)' onmouseleave='srcref_leave("Z579858",this)'><span><span class='ident'>id</span></span></span><span class='hint'>def(id,v)</span></span><span class='lexic'>))</span>&nbsp;<span class='lexic'>&#8709;</span>&nbsp;<span class='keyword'>else</span>&nbsp;<span class='lexic'>[</span><span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='keyword'>node</span><span class='hint'>lang0unflat1:insn:def(id,v)<br>
&nbsp;&nbsp;&nbsp;with&nbsp;implicit&nbsp;arguments:&nbsp;id<br>
</span></span><span class='lexic'>(</span><span class='ident'>v</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z579864",this)' onmouseleave='srcref_leave("Z579864",this)'><span><span class='ident'>process_expr</span></span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z579858",this)' onmouseleave='srcref_leave("Z579858",this)'><span><span class='ident'>v</span></span></span><span class='hint'>def(id,v)</span></span><span class='lexic'>))]</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span id='Z579887'><span><span class='ident'>set</span></span></span>&nbsp;&#8594;&nbsp;<span class='lexic'>[</span><span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='keyword'>node</span><span class='hint'>lang0unflat1:insn:set(id,v)<br>
&nbsp;&nbsp;&nbsp;with&nbsp;implicit&nbsp;arguments:&nbsp;id<br>
</span></span><span class='lexic'>(</span><span class='ident'>v</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>expr</span><span class='hint'>lang0unflat1:value:expr(e)</span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z579864",this)' onmouseleave='srcref_leave("Z579864",this)'><span><span class='ident'>process_expr</span></span></span><span class='lexic'>(</span><span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>expr</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>value</span><span class='hint'>lang0unflat1:expr:value(v)</span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z579887",this)' onmouseleave='srcref_leave("Z579887",this)'><span><span class='ident'>v</span></span></span><span class='hint'>set(id,v)</span></span><span class='lexic'>))))]</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='lexic'>[</span><span class='ident'>node</span><span class='lexic'>()]}};</span><br>
&nbsp;&nbsp;<span id='Z581502'><span><span class='ident'>getexpr</span></span></span><span class='lexic'>(</span><span id='Z579920'><span><span class='ident'>i</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z580231'><span><span class='ident'>ret</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='ident'>mkref</span><span class='lexic'>();</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0unflat1</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>insn</span><span class='lexic'>:</span><span class='idfrom' onmouseenter='srcref_over("Z579920",this)' onmouseleave='srcref_leave("Z579920",this)'><span><span class='ident'>i</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>once</span>&nbsp;<span class='ident'>expr</span>&nbsp;<span class='lexic'>{</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z580231",this)' onmouseleave='srcref_leave("Z580231",this)'><span><span class='ident'>ret</span></span></span>&nbsp;<span class='lexic'>:=</span>&nbsp;<span class='ident'>node</span><span class='lexic'>()</span>&nbsp;<span class='lexic'>}};</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>return</span>&nbsp;<span class='lexic'>^</span><span class='idfrom' onmouseenter='srcref_over("Z580231",this)' onmouseleave='srcref_leave("Z580231",this)'><span><span class='ident'>ret</span></span></span><span class='lexic'>};</span><br>
&nbsp;&nbsp;<span id='Z581523'><span><span class='ident'>getvalue</span></span></span><span class='lexic'>(</span><span id='Z580279'><span><span class='ident'>i</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z580596'><span><span class='ident'>ret</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='ident'>mkref</span><span class='lexic'>();</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0unflat1</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>insn</span><span class='lexic'>:</span><span class='idfrom' onmouseenter='srcref_over("Z580279",this)' onmouseleave='srcref_leave("Z580279",this)'><span><span class='ident'>i</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>once</span>&nbsp;<span class='ident'>value</span>&nbsp;<span class='lexic'>{</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z580596",this)' onmouseleave='srcref_leave("Z580596",this)'><span><span class='ident'>ret</span></span></span>&nbsp;<span class='lexic'>:=</span>&nbsp;<span class='ident'>node</span><span class='lexic'>()</span>&nbsp;<span class='lexic'>}};</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>return</span>&nbsp;<span class='lexic'>^</span><span class='idfrom' onmouseenter='srcref_over("Z580596",this)' onmouseleave='srcref_leave("Z580596",this)'><span><span class='ident'>ret</span></span></span><span class='lexic'>};</span><br>
&nbsp;&nbsp;<span id='Z581545'><span><span class='ident'>reapplyinsns</span></span></span><span class='lexic'>(</span><span id='Z581479'><span><span class='ident'>lst</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>=</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0flat2x</span>&nbsp;<span class='lexic'>/rec,</span>&nbsp;<span class='lexic'>dst</span>&nbsp;<span class='ident'>lang0unflat1</span><span class='lexic'>/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>bblock</span><span class='lexic'>:</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z578720",this)' onmouseleave='srcref_leave("Z578720",this)'><span><span class='ident'>bb</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>bblock</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z580732'><span><span class='ident'>bb</span></span></span>&nbsp;&#8594;&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>&lt;</span><span id='Z580735'><span><span class='ident'><span class='pattern'>chgp</span></span></span></span><span class='lexic'><span class='pattern'>:</span></span><span id='Z581488'><span><span class='ident'><span class='pattern'>nt</span></span></span></span><span class='lexic'>&gt;</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z580732",this)' onmouseleave='srcref_leave("Z580732",this)'><span><span class='ident'>t</span></span></span><span class='hint'>bb(lbl,body,t)</span></span><span class='lexic'>;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='ident'>println</span><span class='lexic'>(</span><span class='symbol'>'lbl'</span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z580732",this)' onmouseleave='srcref_leave("Z580732",this)'><span><span class='ident'>lbl</span></span></span><span class='hint'>bb(lbl,body,t)</span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z580735",this)' onmouseleave='srcref_leave("Z580735",this)'><span><span class='ident'>chgp</span></span></span><span class='lexic'>));</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z581482'><span><span class='ident'>tmp</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='ident'>gen_pprint_ast</span><span class='lexic'>(</span><span class='ident'>lang0unflat1</span><span class='lexic'>,</span>&nbsp;<span class='ident'>insn</span><span class='lexic'>);</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>iter</span>&nbsp;<span id='Z581483'><span><span class='ident'>x</span></span></span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z581479",this)' onmouseleave='srcref_leave("Z581479",this)'><span><span class='ident'>lst</span></span></span>&nbsp;<span class='keyword'>do</span>&nbsp;<span class='ident'>println</span><span class='lexic'>(</span><span class='withhint'><span class='ident'>%S&lt;&lt;</span><span class='hint'>macro&nbsp;S&lt;&lt;&nbsp;args:&nbsp;<br>
A&nbsp;short&nbsp;form&nbsp;for&nbsp;[(buildstring&nbsp;...)]</span></span><span class='lexic'>(</span><span class='const'>&quot;::&nbsp;&quot;</span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z581482",this)' onmouseleave='srcref_leave("Z581482",this)'><span><span class='ident'>tmp</span></span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z581483",this)' onmouseleave='srcref_leave("Z581483",this)'><span><span class='ident'>x</span></span></span><span class='lexic'>)));</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='keyword'>node</span><span class='hint'>lang0unflat1:bblock:bb(lbl,body,t)<br>
&nbsp;&nbsp;&nbsp;with&nbsp;implicit&nbsp;arguments:&nbsp;lbl<br>
</span></span><span class='lexic'>(</span><span class='ident'>body</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='withhint'><span class='ident'>reverse</span><span class='hint'>function&nbsp;reverse&nbsp;lst:&nbsp;<br>
Returns&nbsp;the&nbsp;reversed&nbsp;list.</span></span><span class='lexic'>(</span><span class='keyword'>if</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z580735",this)' onmouseleave='srcref_leave("Z580735",this)'><span><span class='ident'>chgp</span></span></span><span class='lexic'>)</span>&nbsp;<span class='ident'>cdr</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z581479",this)' onmouseleave='srcref_leave("Z581479",this)'><span><span class='ident'>lst</span></span></span><span class='lexic'>)</span>&nbsp;<span class='keyword'>else</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z581479",this)' onmouseleave='srcref_leave("Z581479",this)'><span><span class='ident'>lst</span></span></span><span class='lexic'>),</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='ident'>t</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z581488",this)' onmouseleave='srcref_leave("Z581488",this)'><span><span class='ident'>nt</span></span></span><span class='lexic'>)}};</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>term</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='ident'>tail</span>&nbsp;&#8594;&nbsp;<span class='keyword'>true</span><span class='lexic'>:</span>&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='keyword'>node</span><span class='hint'>lang0unflat1:term:tail(e)</span></span><span class='lexic'>(</span><span class='ident'>e</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z581502",this)' onmouseleave='srcref_leave("Z581502",this)'><span><span class='ident'>getexpr</span></span></span><span class='lexic'>(</span><span class='ident'>car</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z581479",this)' onmouseleave='srcref_leave("Z581479",this)'><span><span class='ident'>lst</span></span></span><span class='lexic'>)))</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>gotoc</span>&nbsp;&#8594;&nbsp;<span class='keyword'>true</span><span class='lexic'>:</span>&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='keyword'>node</span><span class='hint'>lang0unflat1:term:gotoc(cnd,tr,fl)<br>
&nbsp;&nbsp;&nbsp;with&nbsp;implicit&nbsp;arguments:&nbsp;tr,&nbsp;fl<br>
</span></span><span class='lexic'>(</span><span class='ident'>cnd</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z581523",this)' onmouseleave='srcref_leave("Z581523",this)'><span><span class='ident'>getvalue</span></span></span><span class='lexic'>(</span><span class='ident'>car</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z581479",this)' onmouseleave='srcref_leave("Z581479",this)'><span><span class='ident'>lst</span></span></span><span class='lexic'>)))</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>return</span>&nbsp;&#8594;&nbsp;<span class='keyword'>true</span><span class='lexic'>:</span>&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='keyword'>node</span><span class='hint'>lang0unflat1:term:return(v)</span></span><span class='lexic'>(</span><span class='ident'>v</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z581523",this)' onmouseleave='srcref_leave("Z581523",this)'><span><span class='ident'>getvalue</span></span></span><span class='lexic'>(</span><span class='ident'>car</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z581479",this)' onmouseleave='srcref_leave("Z581479",this)'><span><span class='ident'>lst</span></span></span><span class='lexic'>)))</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='lexic'>&#8709;</span><span class='lexic'>:</span><span class='ident'>node</span><span class='lexic'>()</span>&nbsp;<span class='lexic'>}};</span><br>
&nbsp;&nbsp;<span class='keyword'>return</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z581545",this)' onmouseleave='srcref_leave("Z581545",this)'><span><span class='ident'>reapplyinsns</span></span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z581546",this)' onmouseleave='srcref_leave("Z581546",this)'><span><span class='ident'>newinsns</span></span></span><span class='lexic'>)}</span>
<p></div>



<p><div class='code'>
<span id='Z582181'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_bblocks_to_trees</span><span class='lexic'>(</span><span id='Z582944'><span><span class='ident'>c</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;<span class='comment'>//&nbsp;1.&nbsp;We&nbsp;can&nbsp;only&nbsp;move&nbsp;the&nbsp;single&nbsp;use&nbsp;registers.&nbsp;Let's&nbsp;count&nbsp;the&nbsp;number&nbsp;of<br>
</span>&nbsp;&nbsp;<span class='comment'>//&nbsp;&nbsp;&nbsp;&nbsp;uses&nbsp;for&nbsp;all&nbsp;the&nbsp;registers.<br>
</span>&nbsp;&nbsp;<span id='Z582934'><span><span class='ident'>countht</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='ident'>mkhash</span><span class='lexic'>();</span><br>
&nbsp;&nbsp;<span id='Z583398'><span><span class='ident'>count</span></span></span><span class='lexic'>(</span><span id='Z582935'><span><span class='ident'>id</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='lexic'>{</span>&nbsp;<span id='Z582936'><span><span class='ident'>nxt</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='keyword'>aif</span><span class='lexic'>(</span><span class='ident'>chk</span><span class='lexic'>=</span><span class='ident'>ohashget</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z582934",this)' onmouseleave='srcref_leave("Z582934",this)'><span><span class='ident'>countht</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z582935",this)' onmouseleave='srcref_leave("Z582935",this)'><span><span class='ident'>id</span></span></span><span class='lexic'>))</span>&nbsp;<span class='ident'>chk</span><span class='lexic'>+</span><span class='const'>1</span>&nbsp;<span class='keyword'>else</span>&nbsp;<span class='const'>1</span><span class='lexic'>;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='ident'>ohashput</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z582934",this)' onmouseleave='srcref_leave("Z582934",this)'><span><span class='ident'>countht</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z582935",this)' onmouseleave='srcref_leave("Z582935",this)'><span><span class='ident'>id</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z582936",this)' onmouseleave='srcref_leave("Z582936",this)'><span><span class='ident'>nxt</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>};</span><br>
&nbsp;&nbsp;<span id='Z583413'><span><span class='ident'>mkcount</span></span></span><span class='lexic'>()</span>&nbsp;<span class='lexic'>=</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0flat2x</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>code</span><span class='lexic'>:</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z582944",this)' onmouseleave='srcref_leave("Z582944",this)'><span><span class='ident'>c</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>once</span>&nbsp;<span class='ident'>value</span>&nbsp;<span class='lexic'>{</span>&nbsp;<span id='Z583399'><span><span class='ident'>reg</span></span></span>&nbsp;&#8594;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z583398",this)' onmouseleave='srcref_leave("Z583398",this)'><span><span class='ident'>count</span></span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z583399",this)' onmouseleave='srcref_leave("Z583399",this)'><span><span class='ident'>id</span></span></span><span class='hint'>reg(id)</span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>|</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='lexic'>&#8709;</span><span class='lexic'>}};</span><br>
&nbsp;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z583413",this)' onmouseleave='srcref_leave("Z583413",this)'><span><span class='ident'>mkcount</span></span></span><span class='lexic'>();</span><br>
&nbsp;&nbsp;<span class='comment'>//&nbsp;2.&nbsp;For&nbsp;each&nbsp;basic&nbsp;block&nbsp;we&nbsp;maintain&nbsp;the&nbsp;order&nbsp;of&nbsp;expressions&nbsp;that&nbsp;cannot&nbsp;be&nbsp;reordered&nbsp;and&nbsp;move&nbsp;everything<br>
</span>&nbsp;&nbsp;<span class='comment'>//&nbsp;&nbsp;&nbsp;&nbsp;else&nbsp;freely.<br>
</span>&nbsp;&nbsp;<span id='Z583493'><span><span class='ident'>mktree</span></span></span><span class='lexic'>()</span>&nbsp;<span class='lexic'>=</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0flat2x</span>&nbsp;<span class='lexic'>/rec,</span>&nbsp;<span class='lexic'>dst</span>&nbsp;<span class='ident'>lang0unflat1</span><span class='lexic'>/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>code</span><span class='lexic'>:</span><span class='idfrom' onmouseenter='srcref_over("Z582944",this)' onmouseleave='srcref_leave("Z582944",this)'><span><span class='ident'>c</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>once</span>&nbsp;<span class='ident'>bblock</span>&nbsp;<span class='lexic'>{</span>&nbsp;<span class='ident'>bb</span>&nbsp;&#8594;&nbsp;<a href='#Z575823'><span class='ident'>l0_bblock_to_trees</span></a><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z582934",this)' onmouseleave='srcref_leave("Z582934",this)'><span><span class='ident'>countht</span></span></span><span class='lexic'>,</span>&nbsp;<span class='ident'>node</span><span class='lexic'>())</span>&nbsp;<span class='lexic'>}};</span><br>
&nbsp;&nbsp;<span id='Z583499'><span><span class='ident'>nxt</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z583493",this)' onmouseleave='srcref_leave("Z583493",this)'><span><span class='ident'>mktree</span></span></span><span class='lexic'>();</span><br>
&nbsp;&nbsp;<span class='comment'>//&nbsp;3.&nbsp;Use&nbsp;the&nbsp;count&nbsp;table&nbsp;again,&nbsp;to&nbsp;remove&nbsp;the&nbsp;unused&nbsp;register&nbsp;names<br>
</span>&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0unflat1</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>code</span><span class='lexic'>:</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z583499",this)' onmouseleave='srcref_leave("Z583499",this)'><span><span class='ident'>nxt</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>insn</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z583627'><span><span class='ident'>def</span></span></span>&nbsp;&#8594;&nbsp;<span class='keyword'>if</span>&nbsp;<span class='lexic'>(</span><span class='ident'>not</span><span class='lexic'>(</span><span class='ident'>ohashget</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z582934",this)' onmouseleave='srcref_leave("Z582934",this)'><span><span class='ident'>countht</span></span></span><span class='lexic'>,</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z583627",this)' onmouseleave='srcref_leave("Z583627",this)'><span><span class='ident'>id</span></span></span><span class='hint'>def(id,v)</span></span><span class='lexic'>)))</span>&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='keyword'>node</span><span class='hint'>lang0unflat1:insn:def(id,v)<br>
&nbsp;&nbsp;&nbsp;with&nbsp;implicit&nbsp;arguments:&nbsp;v<br>
</span></span><span class='lexic'>(</span><span class='ident'>id</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='lexic'>&#8709;</span><span class='lexic'>)</span>&nbsp;<span class='keyword'>else</span>&nbsp;<span class='ident'>node</span><span class='lexic'>()</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='ident'>node</span><span class='lexic'>()}}}</span>
<p></div>


<h3>No more registers</h3>

Just a nominal pass by now - just demote the remaining registers to loads/stores
and issue explicit allocas for them.


<p><div class='code'>
<span id='Z583828'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_registers_are_not_welcome</span><span class='lexic'>(</span><span id='Z584568'><span><span class='ident'>c</span></span></span><span class='lexic'>)</span><br>
<span class='keyword'>collector</span><span class='lexic'>(</span><span id='Z584699'><span><span class='ident'>addreg</span></span></span><span class='lexic'>,</span>&nbsp;<span id='Z585176'><span><span class='ident'>getregs</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;<span id='Z584721'><span><span class='ident'>genregs</span></span></span><span class='lexic'>()</span>&nbsp;<span class='lexic'>=</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0unflat1</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>code</span><span class='lexic'>:</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z584568",this)' onmouseleave='srcref_leave("Z584568",this)'><span><span class='ident'>c</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>once</span>&nbsp;<span class='ident'>insn</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z584696'><span><span class='ident'>def</span></span></span>&nbsp;&#8594;&nbsp;<span class='keyword'>if</span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z584696",this)' onmouseleave='srcref_leave("Z584696",this)'><span><span class='ident'>id</span></span></span><span class='hint'>def(id,v)</span></span><span class='lexic'>)</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z584699",this)' onmouseleave='srcref_leave("Z584699",this)'><span><span class='ident'>addreg</span></span></span><span class='lexic'>(</span><span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>insn</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>alloca</span><span class='hint'>lang0unflat1:insn:alloca(id)</span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z584696",this)' onmouseleave='srcref_leave("Z584696",this)'><span><span class='ident'>id</span></span></span><span class='hint'>def(id,v)</span></span><span class='lexic'>))</span>&nbsp;<span class='lexic'>|</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='lexic'>&#8709;</span><span class='lexic'>}};</span><br>
&nbsp;&nbsp;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z584721",this)' onmouseleave='srcref_leave("Z584721",this)'><span><span class='ident'>genregs</span></span></span><span class='lexic'>();</span><br>
<br>
&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0unflat1</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>code</span><span class='lexic'>:</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z584568",this)' onmouseleave='srcref_leave("Z584568",this)'><span><span class='ident'>c</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>bblock</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z585170'><span><span class='ident'>bb</span></span></span>&nbsp;&#8594;&nbsp;<span class='keyword'>if</span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z585170",this)' onmouseleave='srcref_leave("Z585170",this)'><span><span class='ident'>lbl</span></span></span><span class='hint'>bb(lbl,body,t)</span></span>&nbsp;<span class='lexic'>===</span>&nbsp;<span class='symbol'>'entry'</span><span class='lexic'>)</span>&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='keyword'>node</span><span class='hint'>lang0unflat1:bblock:bb(lbl,body,t)<br>
&nbsp;&nbsp;&nbsp;with&nbsp;implicit&nbsp;arguments:&nbsp;lbl,&nbsp;t<br>
</span></span><span class='lexic'>(</span><span class='ident'>body</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z585176",this)' onmouseleave='srcref_leave("Z585176",this)'><span><span class='ident'>getregs</span></span></span><span class='lexic'>()</span><span class='lexic'>&#8853;</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z585170",this)' onmouseleave='srcref_leave("Z585170",this)'><span><span class='ident'>body</span></span></span><span class='hint'>bb(lbl,body,t)</span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>else</span>&nbsp;<span class='ident'>node</span><span class='lexic'>()};</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>value</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z585202'><span><span class='ident'>reg</span></span></span>&nbsp;&#8594;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>load</span><span class='hint'>lang0unflat1:value:load(id)</span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z585202",this)' onmouseleave='srcref_leave("Z585202",this)'><span><span class='ident'>id</span></span></span><span class='hint'>reg(id)</span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='ident'>node</span><span class='lexic'>()};</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>insn</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z585231'><span><span class='ident'>def</span></span></span>&nbsp;&#8594;&nbsp;<span class='keyword'>if</span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z585231",this)' onmouseleave='srcref_leave("Z585231",this)'><span><span class='ident'>id</span></span></span><span class='hint'>def(id,v)</span></span><span class='lexic'>)</span>&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>set</span><span class='hint'>lang0unflat1:insn:set(id,v)</span></span><span class='lexic'>(</span><span class='ident'>id</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z585231",this)' onmouseleave='srcref_leave("Z585231",this)'><span><span class='ident'>id</span></span></span><span class='hint'>def(id,v)</span></span><span class='lexic'>,</span>&nbsp;<span class='ident'>v</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>expr</span><span class='hint'>lang0unflat1:value:expr(e)</span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z585231",this)' onmouseleave='srcref_leave("Z585231",this)'><span><span class='ident'>v</span></span></span><span class='hint'>def(id,v)</span></span><span class='lexic'>))</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>else</span>&nbsp;<span class='ident'>node</span><span class='lexic'>()</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='ident'>node</span><span class='lexic'>()}}}</span>
<p></div>


<h3>Environment</h3>

We managed to keep the compiler clean and self-contained up until now, but for a
real backend we have to deal with a runtime library and a global environment, so
this final pass will have to keep looking things up and keeping a track of
classes, fields and methods it generated.

Environment contains references to some core library methods (e.g., a select
function), FFI methods, the already compiled classes and methods and, in another
layer, fields and methods in the class that is being compiled now.



<h3>.NET codegen</h3>

The general approach is simple - for every chunk of code (a number of
definitions) a class is created. Constants are stored in static fields, all
functions are turned into static methods. A special 'init' method is generated
to fill all the static fields. We're not using static constructors here, because
some side effect actions of this init method may not touch any of this class
static fields, but affect the other global variables instead, so we have to
ensure the initialisation order explicitly.




<p><div class='code'>
<span id='Z587612'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_feedback_dumb</span><span class='lexic'>(</span><span id='Z588661'><span><span class='ident'>env</span></span></span><span class='lexic'>,</span>&nbsp;<span id='Z588182'><span><span class='ident'>c</span></span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0unflat1</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>code</span><span class='lexic'>:</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z588182",this)' onmouseleave='srcref_leave("Z588182",this)'><span><span class='ident'>c</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>bblock</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z588572'><span><span class='ident'>bb</span></span></span>&nbsp;&#8594;&nbsp;<span class='lexic'>[</span><span class='symbol'>'label'</span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z588572",this)' onmouseleave='srcref_leave("Z588572",this)'><span><span class='ident'>lbl</span></span></span><span class='hint'>bb(lbl,body,t)</span></span><span class='lexic'>);@</span><span class='keyword'>map</span>&nbsp;<span class='keyword'>append</span>&nbsp;<span id='Z588588'><span><span class='ident'>b</span></span></span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z588572",this)' onmouseleave='srcref_leave("Z588572",this)'><span><span class='ident'>body</span></span></span><span class='hint'>bb(lbl,body,t)</span></span>&nbsp;<span class='keyword'>do</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z588588",this)' onmouseleave='srcref_leave("Z588588",this)'><span><span class='ident'>b</span></span></span><span class='lexic'>;@</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z588572",this)' onmouseleave='srcref_leave("Z588572",this)'><span><span class='ident'>t</span></span></span><span class='hint'>bb(lbl,body,t)</span></span><span class='lexic'>]</span><span class='lexic'>};</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>code</span>&nbsp;<span class='lexic'>{</span>&nbsp;<span id='Z588604'><span><span class='ident'>c</span></span></span>&nbsp;&#8594;&nbsp;<span class='keyword'>map</span>&nbsp;<span class='keyword'>append</span>&nbsp;<span id='Z588609'><span><span class='ident'>b</span></span></span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z588604",this)' onmouseleave='srcref_leave("Z588604",this)'><span><span class='ident'>bs</span></span></span><span class='hint'>c(bs)</span></span>&nbsp;<span class='keyword'>do</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z588609",this)' onmouseleave='srcref_leave("Z588609",this)'><span><span class='ident'>b</span></span></span>&nbsp;<span class='lexic'>};</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>insn</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z588614'><span><span class='ident'>alloca</span></span></span>&nbsp;&#8594;&nbsp;<span class='lexic'>[</span><span class='symbol'>'local'</span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z588614",this)' onmouseleave='srcref_leave("Z588614",this)'><span><span class='ident'>id</span></span></span><span class='hint'>alloca(id)</span></span><span class='lexic'>,</span>&nbsp;<span class='ident'>t_object</span><span class='lexic'>)]</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span id='Z588623'><span><span class='ident'>def</span></span></span>&nbsp;&#8594;&nbsp;<span class='keyword'>if</span>&nbsp;<span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z588623",this)' onmouseleave='srcref_leave("Z588623",this)'><span><span class='ident'>id</span></span></span><span class='hint'>def(id,v)</span></span><span class='lexic'>)</span>&nbsp;<span class='withhint'><span class='ident'>ccerror</span><span class='hint'>function&nbsp;ccerror&nbsp;arg:&nbsp;<br>
Raises&nbsp;[MBaseException]&nbsp;with&nbsp;a&nbsp;given&nbsp;argument.</span></span><span class='lexic'>(</span><span class='symbol'>'IMPOSSIBLE'</span><span class='lexic'>())</span>&nbsp;<span class='keyword'>else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>[@</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z588623",this)' onmouseleave='srcref_leave("Z588623",this)'><span><span class='ident'>v</span></span></span><span class='hint'>def(id,v)</span></span><span class='lexic'>;</span>&nbsp;<span class='symbol'>'Pop'</span><span class='lexic'>()]</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span id='Z588634'><span><span class='ident'>set</span></span></span>&nbsp;&#8594;&nbsp;<span class='lexic'>[@</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z588634",this)' onmouseleave='srcref_leave("Z588634",this)'><span><span class='ident'>v</span></span></span><span class='hint'>set(id,v)</span></span><span class='lexic'>;</span>&nbsp;<span class='symbol'>'Stloc'</span><span class='lexic'>(</span><span class='symbol'>'var'</span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z588634",this)' onmouseleave='srcref_leave("Z588634",this)'><span><span class='ident'>id</span></span></span><span class='hint'>set(id,v)</span></span><span class='lexic'>))]</span><span class='lexic'>};</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>expr</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z588654'><span><span class='ident'>mkclosure</span></span></span>&nbsp;&#8594;&nbsp;<span class='lexic'>[@</span><span class='keyword'>map</span>&nbsp;<span class='keyword'>append</span>&nbsp;<span id='Z588659'><span><span class='ident'>a</span></span></span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z588654",this)' onmouseleave='srcref_leave("Z588654",this)'><span><span class='ident'>args</span></span></span><span class='hint'>mkclosure(df,args)</span></span>&nbsp;<span class='keyword'>do</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z588659",this)' onmouseleave='srcref_leave("Z588659",this)'><span><span class='ident'>a</span></span></span><span class='lexic'>;</span>&nbsp;<span class='lexic'>@</span><a href='#Z585426'><span class='ident'>l0_compile_mkclosure</span></a><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z588661",this)' onmouseleave='srcref_leave("Z588661",this)'><span><span class='ident'>env</span></span></span><span class='lexic'>,</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z588654",this)' onmouseleave='srcref_leave("Z588654",this)'><span><span class='ident'>df</span></span></span><span class='hint'>mkclosure(df,args)</span></span><span class='lexic'>,</span>&nbsp;<span class='ident'>length</span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z588654",this)' onmouseleave='srcref_leave("Z588654",this)'><span><span class='ident'>args</span></span></span><span class='hint'>mkclosure(df,args)</span></span><span class='lexic'>))]</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span id='Z588675'><span><span class='ident'>apply</span></span></span>&nbsp;&#8594;&nbsp;<span class='lexic'>[@</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z588675",this)' onmouseleave='srcref_leave("Z588675",this)'><span><span class='ident'>fn</span></span></span><span class='hint'>apply(purep,fn,args)</span></span><span class='lexic'>;</span>&nbsp;<span class='lexic'>@</span><span class='keyword'>map</span>&nbsp;<span class='keyword'>append</span>&nbsp;<span id='Z588691'><span><span class='ident'>a</span></span></span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z588675",this)' onmouseleave='srcref_leave("Z588675",this)'><span><span class='ident'>args</span></span></span><span class='hint'>apply(purep,fn,args)</span></span>&nbsp;<span class='keyword'>do</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z588691",this)' onmouseleave='srcref_leave("Z588691",this)'><span><span class='ident'>a</span></span></span><span class='lexic'>;</span>&nbsp;<span class='lexic'>@</span><a href='#Z585427'><span class='ident'>l0_compile_run_method</span></a><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z588661",this)' onmouseleave='srcref_leave("Z588661",this)'><span><span class='ident'>env</span></span></span><span class='lexic'>,</span>&nbsp;<span class='ident'>length</span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z588675",this)' onmouseleave='srcref_leave("Z588675",this)'><span><span class='ident'>args</span></span></span><span class='hint'>apply(purep,fn,args)</span></span><span class='lexic'>))]</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span id='Z588698'><span><span class='ident'>load</span></span></span>&nbsp;&#8594;&nbsp;<span class='lexic'>[</span><span class='symbol'>'Ldloc'</span><span class='lexic'>(</span><span class='symbol'>'var'</span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z588698",this)' onmouseleave='srcref_leave("Z588698",this)'><span><span class='ident'>id</span></span></span><span class='hint'>load(id)</span></span><span class='lexic'>))]</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>phi</span>&nbsp;&#8594;&nbsp;<span class='withhint'><span class='ident'>ccerror</span><span class='hint'>function&nbsp;ccerror&nbsp;arg:&nbsp;<br>
Raises&nbsp;[MBaseException]&nbsp;with&nbsp;a&nbsp;given&nbsp;argument.</span></span><span class='lexic'>(</span><span class='symbol'>'IMPOSSIBLE'</span><span class='lexic'>())</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span id='Z588723'><span><span class='ident'>value</span></span></span>&nbsp;&#8594;&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z588723",this)' onmouseleave='srcref_leave("Z588723",this)'><span><span class='ident'>v</span></span></span><span class='hint'>value(v)</span></span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span id='Z588713'><span><span class='ident'>select</span></span></span>&nbsp;&#8594;&nbsp;<span class='lexic'>[@</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z588713",this)' onmouseleave='srcref_leave("Z588713",this)'><span><span class='ident'>tr</span></span></span><span class='hint'>select(cnd,tr,fl)</span></span><span class='lexic'>;</span>&nbsp;<span class='lexic'>@</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z588713",this)' onmouseleave='srcref_leave("Z588713",this)'><span><span class='ident'>fl</span></span></span><span class='hint'>select(cnd,tr,fl)</span></span><span class='lexic'>;</span>&nbsp;<span class='lexic'>@</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z588713",this)' onmouseleave='srcref_leave("Z588713",this)'><span><span class='ident'>cnd</span></span></span><span class='hint'>select(cnd,tr,fl)</span></span><span class='lexic'>;</span>&nbsp;<span class='lexic'>@</span><a href='#Z585428'><span class='ident'>l0_compile_select_function</span></a><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z588661",this)' onmouseleave='srcref_leave("Z588661",this)'><span><span class='ident'>env</span></span></span><span class='lexic'>)]</span><span class='lexic'>};</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>value</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z588768'><span><span class='ident'>expr</span></span></span>&nbsp;&#8594;&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z588768",this)' onmouseleave='srcref_leave("Z588768",this)'><span><span class='ident'>e</span></span></span><span class='hint'>expr(e)</span></span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span id='Z588729'><span><span class='ident'>const</span></span></span>&nbsp;&#8594;&nbsp;<a href='#Z585431'><span class='ident'>l0_compile_constant</span></a><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z588661",this)' onmouseleave='srcref_leave("Z588661",this)'><span><span class='ident'>env</span></span></span><span class='lexic'>,</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z588729",this)' onmouseleave='srcref_leave("Z588729",this)'><span><span class='ident'>c</span></span></span><span class='hint'>const(c)</span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span id='Z588735'><span><span class='ident'>global</span></span></span>&nbsp;&#8594;&nbsp;<a href='#Z585432'><span class='ident'>l0_compile_global</span></a><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z588661",this)' onmouseleave='srcref_leave("Z588661",this)'><span><span class='ident'>env</span></span></span><span class='lexic'>,</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z588735",this)' onmouseleave='srcref_leave("Z588735",this)'><span><span class='ident'>id</span></span></span><span class='hint'>global(id)</span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span id='Z588741'><span><span class='ident'>arg</span></span></span>&nbsp;&#8594;&nbsp;<span class='lexic'>[</span><span class='symbol'>'Ldarg'</span><span class='lexic'>(</span><a href='#Z585433'><span class='ident'>l0_map_argument</span></a><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z588661",this)' onmouseleave='srcref_leave("Z588661",this)'><span><span class='ident'>env</span></span></span><span class='lexic'>,</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z588741",this)' onmouseleave='srcref_leave("Z588741",this)'><span><span class='ident'>id</span></span></span><span class='hint'>arg(id)</span></span><span class='lexic'>))]</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span id='Z588747'><span><span class='ident'>clvar</span></span></span>&nbsp;&#8594;&nbsp;<span class='lexic'>[</span><span class='symbol'>'Ldarg_0'</span><span class='lexic'>();</span>&nbsp;<span class='symbol'>'Ldfld'</span><span class='lexic'>(</span><span class='symbol'>'field'</span><span class='lexic'>(</span><a href='#Z585434'><span class='ident'>l0_map_clenv</span></a><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z588661",this)' onmouseleave='srcref_leave("Z588661",this)'><span><span class='ident'>env</span></span></span><span class='lexic'>,</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z588747",this)' onmouseleave='srcref_leave("Z588747",this)'><span><span class='ident'>id</span></span></span><span class='hint'>clvar(id)</span></span><span class='lexic'>)))]</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>reg</span>&nbsp;&#8594;&nbsp;<span class='withhint'><span class='ident'>ccerror</span><span class='hint'>function&nbsp;ccerror&nbsp;arg:&nbsp;<br>
Raises&nbsp;[MBaseException]&nbsp;with&nbsp;a&nbsp;given&nbsp;argument.</span></span><span class='lexic'>(</span><span class='symbol'>'IMPOSSIBLE'</span><span class='lexic'>())</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span id='Z588762'><span><span class='ident'>load</span></span></span>&nbsp;&#8594;&nbsp;<span class='lexic'>[</span><span class='symbol'>'Ldloc'</span><span class='lexic'>(</span><span class='symbol'>'var'</span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z588762",this)' onmouseleave='srcref_leave("Z588762",this)'><span><span class='ident'>id</span></span></span><span class='hint'>load(id)</span></span><span class='lexic'>))]</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span id='Z588756'><span><span class='ident'>funref</span></span></span>&nbsp;&#8594;&nbsp;<a href='#Z585432'><span class='ident'>l0_compile_global</span></a><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z588661",this)' onmouseleave='srcref_leave("Z588661",this)'><span><span class='ident'>env</span></span></span><span class='lexic'>,</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z588756",this)' onmouseleave='srcref_leave("Z588756",this)'><span><span class='ident'>id</span></span></span><span class='hint'>funref(id)</span></span><span class='lexic'>)</span><span class='lexic'>};</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>term</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z588785'><span><span class='ident'>goto</span></span></span>&nbsp;&#8594;&nbsp;<span class='lexic'>[</span><span class='symbol'>'Br'</span><span class='lexic'>(</span><span class='symbol'>'label'</span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z588785",this)' onmouseleave='srcref_leave("Z588785",this)'><span><span class='ident'>id</span></span></span><span class='hint'>goto(id)</span></span><span class='lexic'>))]</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span id='Z588797'><span><span class='ident'>gotoc</span></span></span>&nbsp;&#8594;&nbsp;<span class='lexic'>[@</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z588797",this)' onmouseleave='srcref_leave("Z588797",this)'><span><span class='ident'>cnd</span></span></span><span class='hint'>gotoc(cnd,tr,fl)</span></span><span class='lexic'>;</span>&nbsp;<span class='lexic'>@</span><a href='#Z585429'><span class='ident'>l0_compile_cndcheck</span></a><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z588661",this)' onmouseleave='srcref_leave("Z588661",this)'><span><span class='ident'>env</span></span></span><span class='lexic'>);</span>&nbsp;<span class='symbol'>'Brc'</span><span class='lexic'>(</span><span class='symbol'>'label'</span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z588797",this)' onmouseleave='srcref_leave("Z588797",this)'><span><span class='ident'>tr</span></span></span><span class='hint'>gotoc(cnd,tr,fl)</span></span><span class='lexic'>));</span>&nbsp;<span class='symbol'>'Br'</span><span class='lexic'>(</span><span class='symbol'>'label'</span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z588797",this)' onmouseleave='srcref_leave("Z588797",this)'><span><span class='ident'>fl</span></span></span><span class='hint'>gotoc(cnd,tr,fl)</span></span><span class='lexic'>))]</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span id='Z588807'><span><span class='ident'>return</span></span></span>&nbsp;&#8594;&nbsp;<span class='lexic'>[@</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z588807",this)' onmouseleave='srcref_leave("Z588807",this)'><span><span class='ident'>v</span></span></span><span class='hint'>return(v)</span></span><span class='lexic'>;</span>&nbsp;<span class='symbol'>'Ret'</span><span class='lexic'>()]</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span id='Z588779'><span><span class='ident'>tail</span></span></span>&nbsp;&#8594;&nbsp;<span class='lexic'>[@</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z588779",this)' onmouseleave='srcref_leave("Z588779",this)'><span><span class='ident'>e</span></span></span><span class='hint'>tail(e)</span></span><span class='lexic'>;</span>&nbsp;<span class='symbol'>'Ret'</span><span class='lexic'>()]</span><span class='lexic'>}}</span>
<p></div>




<h3>Driver</h3>


<p><div class='code'>
<span id='Z588961'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_net_prep</span><span class='lexic'>(</span><span id='Z589137'><span><span class='ident'>ts</span></span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;<span class='keyword'>map</span>&nbsp;<span id='Z589145'><span><span class='ident'>t</span></span></span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z589137",this)' onmouseleave='srcref_leave("Z589137",this)'><span><span class='ident'>ts</span></span></span>&nbsp;<span class='keyword'>do</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0flat2</span>&nbsp;<span class='lexic'>/rec,</span>&nbsp;<span class='lexic'>dst</span>&nbsp;<span class='ident'>lang0unflat1</span><span class='lexic'>/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>top</span><span class='lexic'>:</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z589145",this)' onmouseleave='srcref_leave("Z589145",this)'><span><span class='ident'>t</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>once</span>&nbsp;<span class='ident'>code</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<a href='#Z583828'><span class='ident'>l0_registers_are_not_welcome</span></a><span class='lexic'>(</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href='#Z582181'><span class='ident'>l0_bblocks_to_trees</span></a><span class='lexic'>(</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href='#Z573937'><span class='ident'>l0_reduce_loads</span></a><span class='lexic'>(</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href='#Z572105'><span class='ident'>l0_naive_phi_removal</span></a><span class='lexic'>(</span><span class='ident'>node</span><span class='lexic'>()))))</span>&nbsp;<span class='lexic'>}}}</span>
<p></div>



<p><div class='code'>
<span id='Z589340'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_net_backend</span><span class='lexic'>(</span><span id='Z591207'><span><span class='ident'>env</span></span></span><span class='lexic'>,</span>&nbsp;<span id='Z590298'><span><span class='ident'>ts</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;<span id='Z591042'><span><span class='ident'>x1</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<a href='#Z588961'><span class='ident'>l0_net_prep</span></a><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z590298",this)' onmouseleave='srcref_leave("Z590298",this)'><span><span class='ident'>ts</span></span></span><span class='lexic'>);</span><br>
&nbsp;&nbsp;&nbsp;<span id='Z591045'><span><span class='ident'>tmp</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='ident'>gen_pprint_ast</span><span class='lexic'>(</span><span class='ident'>lang0unflat1</span><span class='lexic'>,</span>&nbsp;<span class='ident'>top</span><span class='lexic'>);</span><br>
&nbsp;&nbsp;&nbsp;<span class='keyword'>iter</span>&nbsp;<span id='Z591046'><span><span class='ident'>x</span></span></span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z591042",this)' onmouseleave='srcref_leave("Z591042",this)'><span><span class='ident'>x1</span></span></span>&nbsp;<span class='keyword'>do</span>&nbsp;<span class='ident'>println</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z591045",this)' onmouseleave='srcref_leave("Z591045",this)'><span><span class='ident'>tmp</span></span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z591046",this)' onmouseleave='srcref_leave("Z591046",this)'><span><span class='ident'>x</span></span></span><span class='lexic'>));</span><br>
&nbsp;&nbsp;&nbsp;<span class='ident'>println</span><span class='lexic'>(</span><span class='const'>&quot;--------------------&quot;</span><span class='lexic'>);</span><br>
&nbsp;&nbsp;&nbsp;<span class='ident'>x2</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='keyword'>map</span>&nbsp;<span id='Z591059'><span><span class='ident'>x</span></span></span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z591042",this)' onmouseleave='srcref_leave("Z591042",this)'><span><span class='ident'>x1</span></span></span>&nbsp;<span class='keyword'>do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0unflat1</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>top</span><span class='lexic'>:</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z591059",this)' onmouseleave='srcref_leave("Z591059",this)'><span><span class='ident'>x</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>once</span>&nbsp;<span class='ident'>code</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='ident'>c</span>&nbsp;&#8594;&nbsp;<span class='lexic'>{</span>&nbsp;<span id='Z591209'><span><span class='ident'>tmp1</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<a href='#Z587612'><span class='ident'>l0_feedback_dumb</span></a><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z591207",this)' onmouseleave='srcref_leave("Z591207",this)'><span><span class='ident'>env</span></span></span><span class='lexic'>,</span>&nbsp;<span class='ident'>node</span><span class='lexic'>());</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>iter</span>&nbsp;<span id='Z591212'><span><span class='ident'>t</span></span></span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z591209",this)' onmouseleave='srcref_leave("Z591209",this)'><span><span class='ident'>tmp1</span></span></span>&nbsp;<span class='keyword'>do</span>&nbsp;<span class='ident'>println</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z591212",this)' onmouseleave='srcref_leave("Z591212",this)'><span><span class='ident'>t</span></span></span><span class='lexic'>);</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='ident'>println</span><span class='lexic'>(</span><span class='const'>&quot;=========&quot;</span><span class='lexic'>);</span>&nbsp;<span class='lexic'>}}};</span><br>
&nbsp;&nbsp;&nbsp;<span class='keyword'>return</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z590298",this)' onmouseleave='srcref_leave("Z590298",this)'><span><span class='ident'>ts</span></span></span><span class='lexic'>;</span><br>
<span class='lexic'>}</span>
<p></div>



<h2>Top level driver</h2>

<p>Bringing all the passes together here:

<svg width="20%" height="20%"
 viewBox="0.00 0.00 282.00 1002.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 998)">
<title>G</title>
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-998 278,-998 278,4 -4,4"/>
<g id="clust1" class="cluster">
<title>cluster_Z591433</title>
<polygon fill="#ebebeb" stroke="#000000" points="31,-136 31,-282 243,-282 243,-136 31,-136"/>
<text text-anchor="middle" x="137" y="-266.8" font-family="Times,serif" font-size="14.00" fill="#000000">l0_genssa_driver</text>
</g>
<g id="clust2" class="cluster">
<title>cluster_Z591434</title>
<polygon fill="#ebebeb" stroke="#000000" points="11,-290 11,-652 263,-652 263,-290 11,-290"/>
<text text-anchor="middle" x="137" y="-636.8" font-family="Times,serif" font-size="14.00" fill="#000000">l0_flatten_driver</text>
</g>
<g id="clust3" class="cluster">
<title>cluster_Z591435</title>
<polygon fill="#ebebeb" stroke="#000000" points="8,-660 8,-950 266,-950 266,-660 8,-660"/>
<text text-anchor="middle" x="137" y="-934.8" font-family="Times,serif" font-size="14.00" fill="#000000">l0_lowering_driver</text>
</g>
<!-- Z591420 -->
<g id="node1" class="node">
<title>Z591420</title>
<polygon fill="none" stroke="#000000" points="250.4665,-108 69.9667,-108 23.5335,-72 204.0333,-72 250.4665,-108"/>
<text text-anchor="middle" x="137" y="-85.8" font-family="Times,serif" font-size="14.00" fill="#000000">l0_do_abstract_ssa</text>
</g>
<!-- EXIT -->
<g id="node3" class="node">
<title>EXIT</title>
<path fill="none" stroke="#000000" d="M152,-36C152,-36 122,-36 122,-36 116,-36 110,-30 110,-24 110,-24 110,-12 110,-12 110,-6 116,0 122,0 122,0 152,0 152,0 158,0 164,-6 164,-12 164,-12 164,-24 164,-24 164,-30 158,-36 152,-36"/>
<text text-anchor="middle" x="137" y="-13.8" font-family="Times,serif" font-size="14.00" fill="#000000">END</text>
</g>
<!-- Z591420&#45;&gt;EXIT -->
<g id="edge1" class="edge">
<title>Z591420&#45;&gt;EXIT</title>
<path fill="none" stroke="#000000" d="M137,-71.8314C137,-71.8314 137,-46.4133 137,-46.4133"/>
<polygon fill="#000000" stroke="#000000" points="140.5001,-46.4132 137,-36.4133 133.5001,-46.4133 140.5001,-46.4132"/>
</g>
<!-- START -->
<g id="node2" class="node">
<title>START</title>
<path fill="none" stroke="#000000" d="M154.391,-994C154.391,-994 119.609,-994 119.609,-994 113.609,-994 107.609,-988 107.609,-982 107.609,-982 107.609,-970 107.609,-970 107.609,-964 113.609,-958 119.609,-958 119.609,-958 154.391,-958 154.391,-958 160.391,-958 166.391,-964 166.391,-970 166.391,-970 166.391,-982 166.391,-982 166.391,-988 160.391,-994 154.391,-994"/>
<text text-anchor="middle" x="137" y="-971.8" font-family="Times,serif" font-size="14.00" fill="#000000">START</text>
</g>
<!-- Z591431 -->
<g id="node14" class="node">
<title>Z591431</title>
<polygon fill="none" stroke="#000000" points="251.8662,-920 69.1398,-920 22.1338,-884 204.8602,-884 251.8662,-920"/>
<text text-anchor="middle" x="137" y="-897.8" font-family="Times,serif" font-size="14.00" fill="#000000">l0_expand_dummy</text>
</g>
<!-- START&#45;&gt;Z591431 -->
<g id="edge13" class="edge">
<title>START&#45;&gt;Z591431</title>
<path fill="none" stroke="#000000" d="M137,-957.7079C137,-957.7079 137,-930.0817 137,-930.0817"/>
<polygon fill="#000000" stroke="#000000" points="140.5001,-930.0817 137,-920.0817 133.5001,-930.0818 140.5001,-930.0817"/>
</g>
<!-- Z591421 -->
<g id="node4" class="node">
<title>Z591421</title>
<polygon fill="none" stroke="#000000" points="202.9105,-180 98.0616,-180 71.0895,-144 175.9384,-144 202.9105,-180"/>
<text text-anchor="middle" x="137" y="-157.8" font-family="Times,serif" font-size="14.00" fill="#000000">l0_genssa</text>
</g>
<!-- Z591421&#45;&gt;Z591420 -->
<g id="edge2" class="edge">
<title>Z591421&#45;&gt;Z591420</title>
<path fill="none" stroke="#000000" d="M137,-143.8314C137,-143.8314 137,-118.4133 137,-118.4133"/>
<polygon fill="#000000" stroke="#000000" points="140.5001,-118.4132 137,-108.4133 133.5001,-118.4133 140.5001,-118.4132"/>
</g>
<!-- Z591422 -->
<g id="node5" class="node">
<title>Z591422</title>
<polygon fill="none" stroke="#000000" points="235.2291,-252 78.9686,-252 38.7709,-216 195.0314,-216 235.2291,-252"/>
<text text-anchor="middle" x="137" y="-229.8" font-family="Times,serif" font-size="14.00" fill="#000000">l0_basic_blocks</text>
</g>
<!-- Z591422&#45;&gt;Z591421 -->
<g id="edge3" class="edge">
<title>Z591422&#45;&gt;Z591421</title>
<path fill="none" stroke="#000000" d="M137,-215.8314C137,-215.8314 137,-190.4133 137,-190.4133"/>
<polygon fill="#000000" stroke="#000000" points="140.5001,-190.4132 137,-180.4133 133.5001,-190.4133 140.5001,-190.4132"/>
</g>
<!-- Z591423 -->
<g id="node6" class="node">
<title>Z591423</title>
<polygon fill="none" stroke="#000000" points="223.6711,-334 85.7968,-334 50.3289,-298 188.2032,-298 223.6711,-334"/>
<text text-anchor="middle" x="137" y="-311.8" font-family="Times,serif" font-size="14.00" fill="#000000">l0_flatten_cfg</text>
</g>
<!-- Z591423&#45;&gt;Z591422 -->
<g id="edge4" class="edge">
<title>Z591423&#45;&gt;Z591422</title>
<path fill="none" stroke="#000000" d="M137,-297.8015C137,-297.8015 137,-262.1476 137,-262.1476"/>
<polygon fill="#000000" stroke="#000000" points="140.5001,-262.1476 137,-252.1476 133.5001,-262.1476 140.5001,-262.1476"/>
</g>
<!-- Z591424 -->
<g id="node7" class="node">
<title>Z591424</title>
<polygon fill="none" stroke="#000000" points="200.5933,-406 99.4306,-406 73.4067,-370 174.5694,-370 200.5933,-406"/>
<text text-anchor="middle" x="137" y="-383.8" font-family="Times,serif" font-size="14.00" fill="#000000">l0_flatten</text>
</g>
<!-- Z591424&#45;&gt;Z591423 -->
<g id="edge5" class="edge">
<title>Z591424&#45;&gt;Z591423</title>
<path fill="none" stroke="#000000" d="M137,-369.8314C137,-369.8314 137,-344.4133 137,-344.4133"/>
<polygon fill="#000000" stroke="#000000" points="140.5001,-344.4132 137,-334.4133 133.5001,-344.4133 140.5001,-344.4132"/>
</g>
<!-- Z591425 -->
<g id="node8" class="node">
<title>Z591425</title>
<polygon fill="none" stroke="#000000" points="254.6278,-478 67.5083,-478 19.3722,-442 206.4917,-442 254.6278,-478"/>
<text text-anchor="middle" x="137" y="-455.8" font-family="Times,serif" font-size="14.00" fill="#000000">l0_lower_splitexprs</text>
</g>
<!-- Z591425&#45;&gt;Z591424 -->
<g id="edge6" class="edge">
<title>Z591425&#45;&gt;Z591424</title>
<path fill="none" stroke="#000000" d="M137,-441.8314C137,-441.8314 137,-416.4133 137,-416.4133"/>
<polygon fill="#000000" stroke="#000000" points="140.5001,-416.4132 137,-406.4133 133.5001,-416.4133 140.5001,-416.4132"/>
</g>
<!-- Z591426 -->
<g id="node9" class="node">
<title>Z591426</title>
<polygon fill="none" stroke="#000000" points="251.8788,-550 69.1323,-550 22.1212,-514 204.8677,-514 251.8788,-550"/>
<text text-anchor="middle" x="137" y="-527.8" font-family="Times,serif" font-size="14.00" fill="#000000">l0_split_statements</text>
</g>
<!-- Z591426&#45;&gt;Z591425 -->
<g id="edge7" class="edge">
<title>Z591426&#45;&gt;Z591425</title>
<path fill="none" stroke="#000000" d="M137,-513.8314C137,-513.8314 137,-488.4133 137,-488.4133"/>
<polygon fill="#000000" stroke="#000000" points="140.5001,-488.4132 137,-478.4133 133.5001,-488.4133 140.5001,-488.4132"/>
</g>
<!-- Z591427 -->
<g id="node10" class="node">
<title>Z591427</title>
<polygon fill="none" stroke="#000000" points="251.8409,-622 69.1547,-622 22.1591,-586 204.8453,-586 251.8409,-622"/>
<text text-anchor="middle" x="137" y="-599.8" font-family="Times,serif" font-size="14.00" fill="#000000">l0_lowering_driver</text>
</g>
<!-- Z591427&#45;&gt;Z591426 -->
<g id="edge8" class="edge">
<title>Z591427&#45;&gt;Z591426</title>
<path fill="none" stroke="#000000" d="M137,-585.8314C137,-585.8314 137,-560.4133 137,-560.4133"/>
<polygon fill="#000000" stroke="#000000" points="140.5001,-560.4132 137,-550.4133 133.5001,-560.4133 140.5001,-560.4132"/>
</g>
<!-- Z591428 -->
<g id="node11" class="node">
<title>Z591428</title>
<polygon fill="none" stroke="#000000" points="238.9337,-704 76.78,-704 35.0663,-668 197.22,-668 238.9337,-704"/>
<text text-anchor="middle" x="137" y="-681.8" font-family="Times,serif" font-size="14.00" fill="#000000">l0_eliminate_list</text>
</g>
<!-- Z591428&#45;&gt;Z591427 -->
<g id="edge9" class="edge">
<title>Z591428&#45;&gt;Z591427</title>
<path fill="none" stroke="#000000" d="M137,-667.8015C137,-667.8015 137,-632.1476 137,-632.1476"/>
<polygon fill="#000000" stroke="#000000" points="140.5001,-632.1476 137,-622.1476 133.5001,-632.1476 140.5001,-632.1476"/>
</g>
<!-- Z591429 -->
<g id="node12" class="node">
<title>Z591429</title>
<polygon fill="none" stroke="#000000" points="237.5341,-776 77.6069,-776 36.4659,-740 196.3931,-740 237.5341,-776"/>
<text text-anchor="middle" x="137" y="-753.8" font-family="Times,serif" font-size="14.00" fill="#000000">l0_eliminate_if2</text>
</g>
<!-- Z591429&#45;&gt;Z591428 -->
<g id="edge10" class="edge">
<title>Z591429&#45;&gt;Z591428</title>
<path fill="none" stroke="#000000" d="M137,-739.8314C137,-739.8314 137,-714.4133 137,-714.4133"/>
<polygon fill="#000000" stroke="#000000" points="140.5001,-714.4132 137,-704.4133 133.5001,-714.4133 140.5001,-714.4132"/>
</g>
<!-- Z591430 -->
<g id="node13" class="node">
<title>Z591430</title>
<polygon fill="none" stroke="#000000" points="258.3071,-848 65.3347,-848 15.6929,-812 208.6653,-812 258.3071,-848"/>
<text text-anchor="middle" x="137" y="-825.8" font-family="Times,serif" font-size="14.00" fill="#000000">l0_eliminate_apply2</text>
</g>
<!-- Z591430&#45;&gt;Z591429 -->
<g id="edge11" class="edge">
<title>Z591430&#45;&gt;Z591429</title>
<path fill="none" stroke="#000000" d="M137,-811.8314C137,-811.8314 137,-786.4133 137,-786.4133"/>
<polygon fill="#000000" stroke="#000000" points="140.5001,-786.4132 137,-776.4133 133.5001,-786.4133 140.5001,-786.4132"/>
</g>
<!-- Z591431&#45;&gt;Z591430 -->
<g id="edge12" class="edge">
<title>Z591431&#45;&gt;Z591430</title>
<path fill="none" stroke="#000000" d="M137,-883.8314C137,-883.8314 137,-858.4133 137,-858.4133"/>
<polygon fill="#000000" stroke="#000000" points="140.5001,-858.4132 137,-848.4133 133.5001,-858.4133 140.5001,-858.4132"/>
</g>
</g>
</svg>


<p><div class='code'>
<span id='Z591436'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_compiler_driver</span><span class='lexic'>(</span><span id='Z591439'><span><span class='ident'>src</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;<span id='Z591441'><span><span class='ident'>x1</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<a href='#Z566372'><span class='ident'>l0_genssa_driver</span></a><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z591439",this)' onmouseleave='srcref_leave("Z591439",this)'><span><span class='ident'>src</span></span></span><span class='lexic'>);</span><br>
&nbsp;&nbsp;<span id='Z591442'><span><span class='ident'>x2</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<a href='#Z571588'><span class='ident'>l0_do_abstract_ssa</span></a><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z591441",this)' onmouseleave='srcref_leave("Z591441",this)'><span><span class='ident'>x1</span></span></span><span class='lexic'>);</span><br>
&nbsp;&nbsp;<span class='keyword'>return</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z591442",this)' onmouseleave='srcref_leave("Z591442",this)'><span><span class='ident'>x2</span></span></span><br>
<span class='lexic'>}</span>
<p></div>



<div class='none'>
  <span id='dummy_to'><span id='too'>&nbsp;</span></span>
  <span id='dummy_from'><span id='frm'>&nbsp;</span></span>
</div>



    <svg class='svgarrows'>
      <defs>
        <marker id="m1" markerWidth="8" markerHeight="8" refx="5" refy="5">
          <circle cx="5" cy="5" r="1.5"></circle>
        </marker>
        <marker id="m2" 
                markerWidth="5" markerHeight="5" viewBox="-6 -6 12 12" 
                refX="-2" refY="0" 
                markerUnits="strokeWidth" 
                orient="auto">
          <polygon points="-2,0 -5,5 5,0 -5,-5" fill="grey" stroke="black" stroke-width="1px"/>
        </marker>
      </defs>
      <g data-source="frm" data-target="too">
        <line marker-start="url(#m1)" marker-end="url(#m2)"></line>
      </g>
    </svg>
    
</div>


</body>

</html>





