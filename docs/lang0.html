<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN">
<html>
  <head>
    <script src="scripts.js" type="text/javascript"></script>
    <script src="scripts1.js" type="text/javascript"></script>
    <link rel="stylesheet" href="stylesheets.css" type="text/css">

    <meta http-equiv=Content-Type content="text/html; charset=iso-8859-1">
    <title>Literate output</title>
  </head>
  
<body lang="EN-GB" link=blue vlink=purple>

<div class="column">





<h2>Constructing a compiler - UNFINISHED, WORK IN PROGRESS</h2>

<p>There is a lot of tutorials out there on how to write a simple interpreter or a compiler. There is most
certainly no need in just another one of this kind. This tutorial is the opposite, it tells how to write a
<i>complex</i> compiler with all the bells and whistles, while still leaving the unimportant details out and
keeping things easy to understand.

<p>As a source language we're using a very simple, somewhat functional language. It's eager, expression--oriented,
no explicit destructive assignment to variables, functions may have I/O and memory side effects
(using some impure intrinsics). No explicit looping constructs besides recursion, tail recursion optimisation
is guaranteed by the compiler.

<p>We build a compiler on top of this simple language, and then extend the core language with more features
added as syntax extensions and compile-time macros, demonstrating a number of different important
approaches used together.

<p>There is no intention to write just another one short and dense compiler. We're fully embracing
the <i>nanopass</i>-style of compiler construction, therefore code is deliberately verbose, but on the other hand,
every step made in the compilation pipeline is easy to understand and easy to reason about.

<p>This compiler takes its eager functional source language and reduces it to an <i>imperative</i>
low level intermediate representation, so both functional and imperative compilation techniques
are covered here, with more emphasis on the imperative side (e.g., we do not go the CPS way,
using an SSA representation instead).

<p>Naming languages is hard and does not make much sense, so we'll simply call our source language <i>lang0</i>,
with all the consequent IR names derived from this notation.

<p>Topics covered in this tutorial include (but not limited to):

<ul>
  <li> <a href="#ast">ASTs</a>
  <li> <a href="#parser">Parsing</a>
  <li> <a href="#macros">Macro expansion</a>
  <li> <a href="#sugar">Syntax sugar elimination</a>
  <li> <a href="#lexical">Lexical scope handling</a>
  <li> <a href="#lifting">Lambda lifting<a>
  <li> <a href="#tails">Tail calls handling</a>, <a href="#tco">tail recursion optimisation</a>
  <li> <a href="#imperative">Converting an expression-oriented language to statements + expressions</a>
  <li> <a href="#ssa">Producing a flat SSA IR</a>
  <li> <a href="#abstract">Converting to the abstract SSA IR and back</a>
</ul>

<p>This is also a showcase for a range of new MBase features - recform ASTs support, abstract SSA library,
AST pretty printing, etc.

<h2 id="ast">Initial AST</h2>

<p>Language starts with a definition of its Abstract Syntax Tree. This is the very first AST in our compilation
chain, it is generated by the parser frontend directly and contains some syntax sugar that ought to be
eliminated straight away.

<p>Since this is a "functional" (sort of) language, everything is an expression. We will split statements and
expressions further down the compilation pipeline.


<p><div class='code'>
<span class='keyword'>ast</span>&nbsp;<span class='ident'>lang0src</span>&nbsp;<span class='keyword'>recform</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;<span class='comment'>//&nbsp;Toplevel&nbsp;statements&nbsp;-&nbsp;definitions&nbsp;and&nbsp;raw&nbsp;expressions<br>
</span>&nbsp;&nbsp;<span class='ident'>top</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='ident'>define</span><span class='lexic'>(</span><span class='ident'>ident</span><span class='lexic'>:</span><span class='ident'>id</span><span class='lexic'>,</span>&nbsp;<span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>e</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>defmacro</span><span class='lexic'>(</span><span class='ident'>ident</span><span class='lexic'>:</span><span class='ident'>id</span><span class='lexic'>,</span>&nbsp;<span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>e</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>expr</span><span class='lexic'>(</span><span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>e</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>debug</span><span class='lexic'>(.*</span><span class='ident'>any</span><span class='lexic'>:</span><span class='ident'>es</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>;</span><br>
&nbsp;&nbsp;<span class='comment'>//&nbsp;All&nbsp;possible&nbsp;expressions<br>
</span>&nbsp;&nbsp;<span class='ident'>expr</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='ident'>lambda</span><span class='lexic'>(*</span><span class='ident'>ident</span><span class='lexic'>:</span><span class='ident'>args</span><span class='lexic'>,</span>&nbsp;<span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>body</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>seq</span><span class='lexic'>(.*</span><span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>body</span><span class='lexic'>)</span><br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>const</span><span class='lexic'>(</span><span class='ident'>const</span><span class='lexic'>:</span><span class='ident'>c</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>var</span><span class='lexic'>(</span><span class='ident'>ident</span><span class='lexic'>:</span><span class='ident'>id</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>apply</span><span class='lexic'>(</span><span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>fn</span><span class='lexic'>,</span>&nbsp;<span class='lexic'>.*</span><span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>args</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>apply2</span><span class='lexic'>(</span><span class='ident'>vident</span><span class='lexic'>:</span><span class='ident'>fn</span><span class='lexic'>,</span>&nbsp;<span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>L</span><span class='lexic'>,</span>&nbsp;<span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>R</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>if3</span><span class='lexic'>(</span><span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>cnd</span><span class='lexic'>,</span>&nbsp;<span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>tr</span><span class='lexic'>,</span>&nbsp;<span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>fl</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>if2</span><span class='lexic'>(</span><span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>cnd</span><span class='lexic'>,</span>&nbsp;<span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>tr</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>let</span><span class='lexic'>(*</span><span class='ident'>letpair</span><span class='lexic'>:</span><span class='ident'>ps</span><span class='lexic'>,</span>&nbsp;<span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>body</span><span class='lexic'>)</span><br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>mklist</span><span class='lexic'>(*</span><span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>es</span><span class='lexic'>)</span><br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='comment'>//&nbsp;This&nbsp;one&nbsp;does&nbsp;not&nbsp;come&nbsp;from&nbsp;a&nbsp;parser,&nbsp;but&nbsp;is<br>
</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='comment'>//&nbsp;produced&nbsp;by&nbsp;a&nbsp;lexical&nbsp;scoping&nbsp;pass&nbsp;later&nbsp;on.<br>
</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>elambda</span><span class='lexic'>(*</span><span class='ident'>ident</span><span class='lexic'>:</span><span class='ident'>args</span><span class='lexic'>,</span>&nbsp;<span class='ident'>lenv</span><span class='lexic'>:</span><span class='ident'>benv</span><span class='lexic'>,</span>&nbsp;<span class='ident'>lenv</span><span class='lexic'>:</span><span class='ident'>fenv</span><span class='lexic'>,</span>&nbsp;<span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>body</span><span class='lexic'>)</span><br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='comment'>//&nbsp;And&nbsp;the&nbsp;following&nbsp;is&nbsp;for&nbsp;macros<br>
</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>toplift</span><span class='lexic'>(</span><span class='ident'>top</span><span class='lexic'>:</span><span class='ident'>t</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>quasiquote</span><span class='lexic'>(</span><span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>e</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>unquote</span><span class='lexic'>(</span><span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>e</span><span class='lexic'>)</span>&nbsp;&nbsp;&nbsp;<span class='comment'>//&nbsp;only&nbsp;valid&nbsp;inside&nbsp;a&nbsp;quasiquote&nbsp;expression<br>
</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>;</span><br>
&nbsp;&nbsp;<span class='comment'>//&nbsp;All&nbsp;possible&nbsp;constant&nbsp;literals<br>
</span>&nbsp;&nbsp;<span class='ident'>const</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='ident'>number</span><span class='lexic'>(</span><span class='ident'>any</span><span class='lexic'>:</span><span class='ident'>n</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>string</span><span class='lexic'>(</span><span class='ident'>any</span><span class='lexic'>:</span><span class='ident'>s</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>symbol</span><span class='lexic'>(</span><span class='ident'>any</span><span class='lexic'>:</span><span class='ident'>s</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>nil</span><span class='lexic'>()</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>;</span><br>
&nbsp;&nbsp;<span class='comment'>//&nbsp;A&nbsp;let&nbsp;binding&nbsp;node<br>
</span>&nbsp;&nbsp;<span class='ident'>letpair</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='ident'>p</span><span class='lexic'>(</span><span class='ident'>ident</span><span class='lexic'>:</span><span class='ident'>id</span><span class='lexic'>,</span>&nbsp;<span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>v</span><span class='lexic'>);</span><br>
<br>
&nbsp;&nbsp;<span class='ident'>ident</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='ident'>unquote</span><span class='lexic'>(</span><span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>e</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>v</span><span class='lexic'>(</span><span class='ident'>vident</span><span class='lexic'>:</span><span class='ident'>id</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>;</span><br>
<span class='lexic'>}</span>
<p></div>


And the language after macro expansion will be the following:


<p><div class='code'>
<span class='keyword'>ast</span>&nbsp;<span class='ident'>lang0</span>&nbsp;<span class='lexic'>:</span>&nbsp;<span class='ident'>lang0src</span>&nbsp;<span class='lexic'>(</span>&nbsp;<span class='ident'>ident</span>&nbsp;&#8594;&nbsp;<span class='ident'>oident</span>&nbsp;<span class='lexic'>)</span>&nbsp;<span class='keyword'>recform</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;<span class='ident'>top</span>&nbsp;<span class='lexic'>+=</span>&nbsp;<span class='lexic'>-</span><span class='ident'>defmacro</span><span class='lexic'>;</span><br>
&nbsp;&nbsp;<span class='ident'>expr</span>&nbsp;<span class='lexic'>+=</span>&nbsp;<span class='lexic'>-</span><span class='ident'>toplift</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;&nbsp;<span class='lexic'>-</span><span class='ident'>quasiquote</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;&nbsp;<span class='lexic'>-</span><span class='ident'>unquote</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>;</span><br>
<span class='lexic'>}</span>
<p></div>


<h2 id="parser">Parser</h2>

<p>As we have a structure of a language now, we can start building a parser for it.

<p>Parsers in PFront are based on an extended PEG. Normally, a new language parser will inherit one of the
existing parsers, to avoid defining common stuff like whitespace, comments, identifiers, number and string
literals and so on. In this case we're inheriting an entire PFront language (though only use few nodes from
there).

<p>Let's not dwell on it, ok? Far too many compiler tutorials are stuck on parsing, and parsing is the least
important part of a language implementation.


<p><div class='code'>
<span class='keyword'>parser</span>&nbsp;<span class='ident'>plang0</span>&nbsp;<span class='keyword'>(</span><span class='ident'>pfront</span><span class='keyword'>)</span>&nbsp;<span class='keyword'>{</span><br>
&nbsp;&nbsp;<span class='comment'>//&nbsp;A&nbsp;target&nbsp;AST&nbsp;produced&nbsp;by&nbsp;this&nbsp;parser<br>
</span>&nbsp;&nbsp;<span class='keyword'>target</span>&nbsp;<span class='ident'>lang0src</span><span class='keyword'>;</span><br>
&nbsp;&nbsp;<span class='comment'>//&nbsp;Which&nbsp;node&nbsp;should&nbsp;be&nbsp;used&nbsp;as&nbsp;a&nbsp;whitespace&nbsp;-&nbsp;inherited&nbsp;from&nbsp;PFront<br>
</span>&nbsp;&nbsp;<span class='keyword'>!!</span><span class='ident'>Spaces</span><span class='keyword'>;</span><br>
&nbsp;&nbsp;<br>
&nbsp;&nbsp;<span class='comment'>//&nbsp;Rules&nbsp;-&nbsp;for&nbsp;syntax&nbsp;highlighting&nbsp;and&nbsp;for&nbsp;separating&nbsp;keywords<br>
</span>&nbsp;&nbsp;<span class='comment'>//&nbsp;from&nbsp;identifiers<br>
</span>&nbsp;&nbsp;<span class='keyword'>[</span><span class='ident'>lexical</span><span class='keyword'>:]</span>&nbsp;&#8656;&nbsp;<span class='pattern'><span class='keyword'>[lexical]</span></span>&nbsp;&#8658;&nbsp;<span class='keyword'>{</span><span class='ident'>ctoken</span>&nbsp;<span class='keyword'>=</span>&nbsp;<span class='ident'>lexic</span><span class='keyword'>};</span><br>
&nbsp;&nbsp;<span class='keyword'>[</span><span class='ident'>keyword</span><span class='keyword'>:]</span>&nbsp;&#8656;&nbsp;<span class='pattern'><span class='keyword'>[keyword]</span></span>&nbsp;<span class='keyword'><span class='pattern'>![IdentRest]</span></span>&nbsp;&#8658;&nbsp;<span class='keyword'>{</span><span class='ident'>ctoken</span>&nbsp;<span class='keyword'>=</span>&nbsp;<span class='ident'>keyword</span><span class='keyword'>};</span><br>
<br>
&nbsp;&nbsp;<span class='comment'>//&nbsp;Top&nbsp;entry&nbsp;node&nbsp;-&nbsp;returns&nbsp;a&nbsp;list&nbsp;of&nbsp;lang0&nbsp;toplevel&nbsp;statements.<br>
</span>&nbsp;&nbsp;<span class='comment'>//&nbsp;Note&nbsp;the&nbsp;trailing&nbsp;whitespaces&nbsp;-&nbsp;it&nbsp;is&nbsp;important&nbsp;to&nbsp;add&nbsp;them&nbsp;to&nbsp;a<br>
</span>&nbsp;&nbsp;<span class='comment'>//&nbsp;top&nbsp;node,&nbsp;since&nbsp;the&nbsp;whitespaces&nbsp;are&nbsp;only&nbsp;implicitly&nbsp;ignored&nbsp;at<br>
</span>&nbsp;&nbsp;<span class='comment'>//&nbsp;beginnings&nbsp;of&nbsp;tokens.<br>
</span>&nbsp;&nbsp;<span class='ident'>plang0</span>&nbsp;&#8656;&nbsp;<span class='pattern'>eslist</span><span class='keyword'><span class='pattern'>&lt;[l0topexpr]&gt;:</span></span><span class='pattern'>ts</span>&nbsp;<span class='keyword'><span class='pattern'>[Spaces]*</span></span>&nbsp;&#8658;&nbsp;<span class='ident'>ts</span><span class='keyword'>;</span><br>
<br>
&nbsp;&nbsp;<span class='comment'>//&nbsp;A&nbsp;single&nbsp;toplevel&nbsp;statement,&nbsp;including&nbsp;standalone&nbsp;expressions<br>
</span>&nbsp;&nbsp;<span class='ident'>l0topexpr</span>&nbsp;<span class='keyword'>&gt;&gt;</span>&nbsp;<span class='ident'>top</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#8656;&nbsp;<span class='keyword'>{</span>&nbsp;<span class='const'><span class='pattern'>define</span></span>&nbsp;<span class='keyword'><span class='pattern'>[l0qident]:</span></span><span class='pattern'>name</span>&nbsp;<span class='pattern'><span class='const'>&quot;=&quot;</span></span>&nbsp;<span class='keyword'><span class='pattern'>[l0expr]:</span></span><span class='pattern'>e</span>&nbsp;<span class='const'><span class='pattern'>&quot;;&quot;</span></span><span class='keyword'><span class='pattern'>?</span></span>&nbsp;&#8658;&nbsp;<span class='ident'>define</span><span class='keyword'>(</span><span class='ident'>name</span><span class='keyword'>,</span>&nbsp;<span class='ident'>e</span><span class='keyword'>)</span>&nbsp;<span class='keyword'>}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>/</span>&nbsp;&nbsp;<span class='keyword'>{</span>&nbsp;<span class='const'><span class='pattern'>function</span></span>&nbsp;<span class='keyword'><span class='pattern'>[l0qident]:</span></span><span class='pattern'>name</span>&nbsp;<span class='pattern'><span class='const'>&quot;(&quot;</span></span>&nbsp;<span class='pattern'>ecslist</span><span class='keyword'><span class='pattern'>&lt;[l0qident],</span></span><span class='const'><span class='pattern'>&quot;,&quot;</span></span><span class='keyword'><span class='pattern'>&gt;:</span></span><span class='pattern'>args</span>&nbsp;<span class='pattern'><span class='const'>&quot;)&quot;</span></span>&nbsp;<span class='keyword'><span class='pattern'>[l0expr]:</span></span><span class='pattern'>b</span>&nbsp;&#8658;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='ident'>define</span><span class='keyword'>(</span><span class='ident'>name</span><span class='keyword'>,</span>&nbsp;<span class='ident'>lambda</span><span class='keyword'>(</span><span class='ident'>args</span><span class='keyword'>,</span>&nbsp;<span class='ident'>b</span><span class='keyword'>))</span>&nbsp;<span class='keyword'>}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>/</span>&nbsp;&nbsp;<span class='keyword'>{</span>&nbsp;<span class='const'><span class='pattern'>macro</span></span>&nbsp;<span class='keyword'><span class='pattern'>[l0qident]:</span></span><span class='pattern'>name</span>&nbsp;<span class='pattern'><span class='const'>&quot;(&quot;</span></span>&nbsp;<span class='pattern'>ecslist</span><span class='keyword'><span class='pattern'>&lt;[l0qident],</span></span><span class='const'><span class='pattern'>&quot;,&quot;</span></span><span class='keyword'><span class='pattern'>&gt;:</span></span><span class='pattern'>args</span>&nbsp;<span class='pattern'><span class='const'>&quot;)&quot;</span></span>&nbsp;<span class='keyword'><span class='pattern'>[l0expr]:</span></span><span class='pattern'>b</span>&nbsp;&#8658;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='ident'>defmacro</span><span class='keyword'>(</span><span class='ident'>name</span><span class='keyword'>,</span>&nbsp;<span class='ident'>lambda</span><span class='keyword'>(</span><span class='ident'>args</span><span class='keyword'>,</span>&nbsp;<span class='ident'>b</span><span class='keyword'>))</span>&nbsp;<span class='keyword'>}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>/</span>&nbsp;&nbsp;<span class='keyword'>{</span>&nbsp;<span class='keyword'><span class='pattern'>[l0expr]:</span></span><span class='pattern'>e</span>&nbsp;&#8658;&nbsp;<span class='ident'>expr</span><span class='keyword'>(</span><span class='ident'>e</span><span class='keyword'>)</span>&nbsp;<span class='keyword'>}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>;</span><br>
&nbsp;&nbsp;<span class='comment'>//&nbsp;Binary&nbsp;operators&nbsp;classified&nbsp;by&nbsp;their&nbsp;priority<br>
</span>&nbsp;&nbsp;<span class='ident'>p0binop10</span>&nbsp;&#8656;&nbsp;<span class='keyword'>{</span><span class='pattern'><span class='const'>&quot;*&quot;</span></span>&nbsp;&#8658;&nbsp;<span class='keyword'>`</span><span class='ident'>binopmul</span>&nbsp;<span class='keyword'>}</span>&nbsp;<span class='keyword'>/</span>&nbsp;<span class='keyword'>{</span><span class='pattern'><span class='const'>&quot;/&quot;</span></span>&nbsp;&#8658;&nbsp;<span class='keyword'>`</span><span class='ident'>binopdiv</span>&nbsp;<span class='keyword'>};</span><br>
&nbsp;&nbsp;<span class='ident'>p0binop9x</span>&nbsp;&nbsp;&#8656;&nbsp;<span class='keyword'>{</span><span class='const'><span class='pattern'>&quot;&amp;&amp;&quot;</span></span>&nbsp;&#8658;&nbsp;<span class='keyword'>`</span><span class='ident'>binopand</span>&nbsp;<span class='keyword'>}</span>&nbsp;<span class='keyword'>/</span>&nbsp;<span class='keyword'>{</span><span class='pattern'><span class='const'>&quot;&amp;&quot;</span></span>&nbsp;&nbsp;&#8658;&nbsp;<span class='keyword'>`</span><span class='ident'>binopbinand</span>&nbsp;<span class='keyword'>}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>/</span>&nbsp;&nbsp;<span class='keyword'>{</span><span class='const'><span class='pattern'>&quot;||&quot;</span></span>&nbsp;&nbsp;&#8658;&nbsp;<span class='keyword'>`</span><span class='ident'>binopor</span>&nbsp;<span class='keyword'>}</span>&nbsp;<span class='keyword'>/</span>&nbsp;<span class='keyword'>{</span><span class='pattern'><span class='const'>&quot;|&quot;</span></span>&nbsp;&nbsp;&#8658;&nbsp;<span class='keyword'>`</span><span class='ident'>binopbinor</span>&nbsp;<span class='keyword'>};</span><br>
&nbsp;&nbsp;<span class='ident'>p0binop9</span>&nbsp;&nbsp;&#8656;&nbsp;<span class='keyword'>{</span><span class='const'><span class='pattern'>&quot;&lt;&lt;&quot;</span></span>&nbsp;&#8658;&nbsp;<span class='keyword'>`</span><span class='ident'>binopshl</span>&nbsp;<span class='keyword'>}</span>&nbsp;<span class='keyword'>/</span>&nbsp;<span class='keyword'>{</span><span class='const'><span class='pattern'>&quot;&gt;&gt;&quot;</span></span>&nbsp;&#8658;&nbsp;<span class='keyword'>`</span><span class='ident'>binopshr</span>&nbsp;<span class='keyword'>};</span><br>
&nbsp;&nbsp;<span class='ident'>p0binop8</span>&nbsp;&nbsp;&#8656;&nbsp;<span class='keyword'>{</span><span class='pattern'><span class='const'>&quot;+&quot;</span></span>&nbsp;&#8658;&nbsp;<span class='keyword'>`</span><span class='ident'>binopadd</span>&nbsp;<span class='keyword'>}</span>&nbsp;<span class='keyword'>/</span>&nbsp;<span class='keyword'>{</span><span class='pattern'><span class='const'>&quot;-&quot;</span></span>&nbsp;&#8658;&nbsp;<span class='keyword'>`</span><span class='ident'>binopsub</span>&nbsp;<span class='keyword'>};</span><br>
&nbsp;&nbsp;<span class='ident'>p0binop7</span>&nbsp;&nbsp;&#8656;&nbsp;<span class='keyword'>{</span><span class='const'><span class='pattern'>&quot;&lt;=&quot;</span></span>&nbsp;&#8658;&nbsp;<span class='keyword'>`</span><span class='ident'>binople</span>&nbsp;<span class='keyword'>}</span>&nbsp;<span class='keyword'>/</span>&nbsp;<span class='keyword'>{</span><span class='const'><span class='pattern'>&quot;&gt;=&quot;</span></span>&nbsp;&#8658;&nbsp;<span class='keyword'>`</span><span class='ident'>binopge</span>&nbsp;<span class='keyword'>}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>/</span>&nbsp;&nbsp;<span class='keyword'>{</span><span class='const'><span class='pattern'>&quot;==&quot;</span></span>&nbsp;&#8658;&nbsp;<span class='keyword'>`</span><span class='ident'>binopeq</span>&nbsp;<span class='keyword'>}</span>&nbsp;<span class='keyword'>/</span>&nbsp;<span class='keyword'>{</span><span class='const'><span class='pattern'>&quot;!=&quot;</span></span>&nbsp;&#8658;&nbsp;<span class='keyword'>`</span><span class='ident'>binopneq</span>&nbsp;<span class='keyword'>}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>/</span>&nbsp;&nbsp;<span class='keyword'>{</span><span class='pattern'><span class='const'>&quot;&lt;&quot;</span></span>&nbsp;&#8658;&nbsp;<span class='keyword'>`</span><span class='ident'>binoplt</span>&nbsp;<span class='keyword'>}</span>&nbsp;<span class='keyword'>/</span>&nbsp;<span class='keyword'>{</span><span class='pattern'><span class='const'>&quot;&gt;&quot;</span></span>&nbsp;&#8658;&nbsp;<span class='keyword'>`</span><span class='ident'>binopgt</span>&nbsp;<span class='keyword'>};</span><br>
&nbsp;&nbsp;<span class='comment'>//&nbsp;Expressions,&nbsp;starting&nbsp;with&nbsp;a&nbsp;binary.&nbsp;This&nbsp;is&nbsp;compiled&nbsp;as&nbsp;a&nbsp;Pratt&nbsp;parser&nbsp;embedded<br>
</span>&nbsp;&nbsp;<span class='comment'>//&nbsp;into&nbsp;a&nbsp;PEG.<br>
</span>&nbsp;&nbsp;<span class='keyword'>binary</span>&nbsp;<span class='ident'>l0expr</span>&nbsp;<span class='keyword'>&gt;&gt;</span>&nbsp;<span class='ident'>expr</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#8656;&nbsp;<span class='keyword'>(</span><span class='const'>1000</span><span class='keyword'>)</span>&nbsp;<span class='pattern'><span class='keyword'>[l0expr]</span></span>&nbsp;<span class='pattern'><span class='keyword'>[p0binop10]</span></span>&nbsp;<span class='pattern'><span class='keyword'>[l0expr]</span></span>&nbsp;&#8658;&nbsp;<span class='ident'>apply2</span><span class='keyword'>(</span><span class='ident'>op</span><span class='keyword'>,</span>&nbsp;<span class='ident'>L</span><span class='keyword'>,</span>&nbsp;<span class='ident'>R</span><span class='keyword'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>|</span>&nbsp;&nbsp;&nbsp;<span class='keyword'>(</span><span class='const'>950</span><span class='keyword'>)</span>&nbsp;<span class='pattern'><span class='keyword'>[l0expr]</span></span>&nbsp;<span class='pattern'><span class='keyword'>[p0binop9x]</span></span>&nbsp;<span class='pattern'><span class='keyword'>[l0expr]</span></span>&nbsp;&#8658;&nbsp;<span class='ident'>apply2</span><span class='keyword'>(</span><span class='ident'>op</span><span class='keyword'>,</span>&nbsp;<span class='ident'>L</span><span class='keyword'>,</span>&nbsp;<span class='ident'>R</span><span class='keyword'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>|</span>&nbsp;&nbsp;&nbsp;<span class='keyword'>(</span><span class='const'>900</span><span class='keyword'>)</span>&nbsp;<span class='pattern'><span class='keyword'>[l0expr]</span></span>&nbsp;<span class='pattern'><span class='keyword'>[p0binop9]</span></span>&nbsp;&nbsp;<span class='pattern'><span class='keyword'>[l0expr]</span></span>&nbsp;&#8658;&nbsp;<span class='ident'>apply2</span><span class='keyword'>(</span><span class='ident'>op</span><span class='keyword'>,</span>&nbsp;<span class='ident'>L</span><span class='keyword'>,</span>&nbsp;<span class='ident'>R</span><span class='keyword'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>|</span>&nbsp;&nbsp;&nbsp;<span class='keyword'>(</span><span class='const'>800</span><span class='keyword'>)</span>&nbsp;<span class='pattern'><span class='keyword'>[l0expr]</span></span>&nbsp;<span class='pattern'><span class='keyword'>[p0binop8]</span></span>&nbsp;&nbsp;<span class='pattern'><span class='keyword'>[l0expr]</span></span>&nbsp;&#8658;&nbsp;<span class='ident'>apply2</span><span class='keyword'>(</span><span class='ident'>op</span><span class='keyword'>,</span>&nbsp;<span class='ident'>L</span><span class='keyword'>,</span>&nbsp;<span class='ident'>R</span><span class='keyword'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>|</span>&nbsp;&nbsp;&nbsp;<span class='keyword'>(</span><span class='const'>700</span><span class='keyword'>)</span>&nbsp;<span class='pattern'><span class='keyword'>[l0expr]</span></span>&nbsp;<span class='pattern'><span class='keyword'>[p0binop7]</span></span>&nbsp;&nbsp;<span class='pattern'><span class='keyword'>[l0expr]</span></span>&nbsp;&#8658;&nbsp;<span class='ident'>apply2</span><span class='keyword'>(</span><span class='ident'>op</span><span class='keyword'>,</span>&nbsp;<span class='ident'>L</span><span class='keyword'>,</span>&nbsp;<span class='ident'>R</span><span class='keyword'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>|</span>&nbsp;&nbsp;&nbsp;<span class='keyword'>(</span><span class='const'>600</span><span class='keyword'>)</span>&nbsp;<span class='pattern'><span class='keyword'>[l0expr]</span></span>&nbsp;<span class='const'><span class='pattern'>&quot;::&quot;</span></span>&nbsp;&nbsp;<span class='pattern'><span class='keyword'>[l0expr]</span></span>&nbsp;&#8658;&nbsp;<span class='ident'>apply2</span><span class='keyword'>(</span><span class='keyword'>`</span><span class='ident'>cons</span><span class='keyword'>,</span>&nbsp;<span class='ident'>L</span><span class='keyword'>,</span>&nbsp;<span class='ident'>R</span><span class='keyword'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>|</span>&nbsp;&nbsp;&nbsp;<span class='keyword'>(</span><span class='const'>500</span><span class='keyword'>)</span>&nbsp;<span class='pattern'><span class='keyword'>[l0expr]</span></span>&nbsp;<span class='pattern'><span class='const'>&quot;@&quot;</span></span>&nbsp;&nbsp;<span class='pattern'><span class='keyword'>[l0expr]</span></span>&nbsp;&#8658;&nbsp;<span class='ident'>apply2</span><span class='keyword'>(</span><span class='keyword'>`</span><span class='ident'>append</span><span class='keyword'>,</span>&nbsp;<span class='ident'>L</span><span class='keyword'>,</span>&nbsp;<span class='ident'>R</span><span class='keyword'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>|</span>&nbsp;&nbsp;&nbsp;<span class='pattern'><span class='keyword'>[l0expr1]</span></span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>;</span><br>
&nbsp;&nbsp;<span class='comment'>//&nbsp;Simple&nbsp;expressions<br>
</span>&nbsp;&nbsp;<span class='ident'>l0expr1</span>&nbsp;&#8656;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>{</span>&nbsp;<span class='pattern'><span class='const'>&quot;(&quot;</span></span>&nbsp;<span class='keyword'><span class='pattern'>[l0expr]:</span></span><span class='pattern'>e</span>&nbsp;<span class='pattern'><span class='const'>&quot;)&quot;</span></span>&nbsp;<span class='pattern'><span class='const'>&quot;(&quot;</span></span>&nbsp;<span class='pattern'>ecslist</span><span class='keyword'><span class='pattern'>&lt;[l0expr],</span></span><span class='const'><span class='pattern'>&quot;,&quot;</span></span><span class='keyword'><span class='pattern'>&gt;:</span></span><span class='pattern'>args</span>&nbsp;<span class='pattern'><span class='const'>&quot;)&quot;</span></span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#8658;&nbsp;<span class='ident'>apply</span><span class='keyword'>(</span><span class='ident'>e</span><span class='keyword'>,@</span><span class='ident'>args</span><span class='keyword'>)</span>&nbsp;<span class='keyword'>}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>/</span>&nbsp;&nbsp;<span class='keyword'>{</span>&nbsp;<span class='pattern'><span class='const'>&quot;(&quot;</span></span>&nbsp;<span class='keyword'><span class='pattern'>[l0expr]:</span></span><span class='pattern'>e</span>&nbsp;<span class='pattern'><span class='const'>&quot;)&quot;</span></span>&nbsp;&#8658;&nbsp;<span class='ident'>e</span>&nbsp;<span class='keyword'>}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>/</span>&nbsp;&nbsp;<span class='keyword'>{</span>&nbsp;<span class='pattern'><span class='const'>&quot;{&quot;</span></span>&nbsp;<span class='pattern'>cslist</span><span class='keyword'><span class='pattern'>&lt;[l0expr],</span></span><span class='pattern'>&nbsp;</span><span class='const'><span class='pattern'>&quot;;&quot;</span></span><span class='keyword'><span class='pattern'>&gt;:</span></span><span class='pattern'>es</span>&nbsp;<span class='const'><span class='pattern'>&quot;;&quot;</span></span><span class='keyword'><span class='pattern'>?</span></span>&nbsp;<span class='pattern'><span class='const'>&quot;}&quot;</span></span>&nbsp;&#8658;&nbsp;<span class='ident'>seq</span><span class='keyword'>(</span><span class='keyword'>@</span><span class='ident'>es</span><span class='keyword'>)</span>&nbsp;<span class='keyword'>}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>/</span>&nbsp;&nbsp;<span class='keyword'>{</span>&nbsp;<span class='pattern'><span class='const'>&quot;`&quot;</span></span>&nbsp;<span class='keyword'><span class='pattern'>[l0expr]:</span></span><span class='pattern'>e</span>&nbsp;<span class='pattern'><span class='const'>&quot;`&quot;</span></span>&nbsp;&#8658;&nbsp;<span class='ident'>quasiquote</span><span class='keyword'>(</span><span class='ident'>e</span><span class='keyword'>)</span>&nbsp;<span class='keyword'>}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>/</span>&nbsp;&nbsp;<span class='keyword'>{</span>&nbsp;<span class='const'><span class='pattern'>&quot;::expr&quot;</span></span>&nbsp;<span class='pattern'><span class='const'>&quot;\&quot;</span></span>&nbsp;<span class='keyword'><span class='pattern'>[l0expr]:</span></span><span class='pattern'>e</span>&nbsp;<span class='pattern'><span class='const'>&quot;\&quot;</span></span>&nbsp;&#8658;&nbsp;<span class='ident'>unquote</span><span class='keyword'>(</span><span class='ident'>e</span><span class='keyword'>)</span>&nbsp;<span class='keyword'>}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>/</span>&nbsp;&nbsp;<span class='keyword'>{</span>&nbsp;<span class='const'><span class='pattern'>&quot;::lift&quot;</span></span>&nbsp;<span class='keyword'><span class='pattern'>[l0topexpr]:</span></span><span class='pattern'>t</span>&nbsp;&#8658;&nbsp;<span class='ident'>toplift</span><span class='keyword'>(</span><span class='ident'>t</span><span class='keyword'>)</span>&nbsp;<span class='keyword'>}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>/</span>&nbsp;&nbsp;<span class='keyword'>{</span>&nbsp;<span class='const'><span class='pattern'>if</span></span>&nbsp;<span class='pattern'><span class='const'>&quot;(&quot;</span></span>&nbsp;<span class='keyword'><span class='pattern'>[l0expr]:</span></span><span class='pattern'>cnd</span>&nbsp;<span class='pattern'><span class='const'>&quot;)&quot;</span></span>&nbsp;<span class='keyword'><span class='pattern'>[l0expr]:</span></span><span class='pattern'>tr</span>&nbsp;<span class='const'><span class='pattern'>else</span></span>&nbsp;<span class='keyword'><span class='pattern'>[l0expr]:</span></span><span class='pattern'>fl</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#8658;&nbsp;<span class='ident'>if3</span><span class='keyword'>(</span><span class='ident'>cnd</span><span class='keyword'>,</span>&nbsp;<span class='ident'>tr</span><span class='keyword'>,</span>&nbsp;<span class='ident'>fl</span><span class='keyword'>)</span>&nbsp;<span class='keyword'>}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>/</span>&nbsp;&nbsp;<span class='keyword'>{</span>&nbsp;<span class='const'><span class='pattern'>if</span></span>&nbsp;<span class='pattern'><span class='const'>&quot;(&quot;</span></span>&nbsp;<span class='keyword'><span class='pattern'>[l0expr]:</span></span><span class='pattern'>cnd</span>&nbsp;<span class='pattern'><span class='const'>&quot;)&quot;</span></span>&nbsp;<span class='keyword'><span class='pattern'>[l0expr]:</span></span><span class='pattern'>tr</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#8658;&nbsp;<span class='ident'>if2</span><span class='keyword'>(</span><span class='ident'>cnd</span><span class='keyword'>,</span>&nbsp;<span class='ident'>tr</span><span class='keyword'>,</span>&nbsp;<span class='ident'>fl</span><span class='keyword'>)</span>&nbsp;<span class='keyword'>}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>/</span>&nbsp;&nbsp;<span class='keyword'>{</span>&nbsp;<span class='const'><span class='pattern'>fun</span></span>&nbsp;<span class='pattern'><span class='const'>&quot;(&quot;</span></span>&nbsp;<span class='pattern'>ecslist</span><span class='keyword'><span class='pattern'>&lt;[l0qident],</span></span><span class='const'><span class='pattern'>&quot;,&quot;</span></span><span class='keyword'><span class='pattern'>&gt;:</span></span><span class='pattern'>args</span>&nbsp;<span class='pattern'><span class='const'>&quot;)&quot;</span></span>&nbsp;<span class='keyword'><span class='pattern'>[l0expr]:</span></span><span class='pattern'>b</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#8658;&nbsp;<span class='ident'>lambda</span><span class='keyword'>(</span><span class='ident'>args</span><span class='keyword'>,</span>&nbsp;<span class='ident'>b</span><span class='keyword'>)</span>&nbsp;<span class='keyword'>}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>/</span>&nbsp;&nbsp;<span class='keyword'>{</span>&nbsp;<span class='const'><span class='pattern'>let</span></span>&nbsp;<span class='pattern'>cslist</span><span class='keyword'><span class='pattern'>&lt;[l0letpair],</span></span><span class='const'><span class='pattern'>&quot;,&quot;</span></span><span class='keyword'><span class='pattern'>&gt;:</span></span><span class='pattern'>ps</span>&nbsp;<span class='const'><span class='pattern'>in</span></span>&nbsp;<span class='keyword'><span class='pattern'>[l0expr]:</span></span><span class='pattern'>b</span>&nbsp;&#8658;&nbsp;<span class='ident'>let</span><span class='keyword'>(</span><span class='ident'>ps</span><span class='keyword'>,</span>&nbsp;<span class='ident'>b</span><span class='keyword'>)</span>&nbsp;<span class='keyword'>}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>/</span>&nbsp;&nbsp;<span class='keyword'>{</span>&nbsp;<span class='const'><span class='pattern'>return</span></span>&nbsp;<span class='keyword'><span class='pattern'>[l0expr]:</span></span><span class='pattern'>e</span>&nbsp;&#8658;&nbsp;<span class='ident'>e</span>&nbsp;<span class='keyword'>}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>/</span>&nbsp;&nbsp;<span class='keyword'>{</span>&nbsp;<span class='keyword'><span class='pattern'>[number]:</span></span><span class='pattern'>n</span>&nbsp;&#8658;&nbsp;<span class='ident'>const</span><span class='keyword'>(</span><span class='ident'>number</span><span class='keyword'>(</span><span class='ident'>n</span><span class='keyword'>))</span>&nbsp;<span class='keyword'>}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>/</span>&nbsp;&nbsp;<span class='keyword'>{</span>&nbsp;<span class='keyword'><span class='pattern'>[string]:</span></span><span class='pattern'>s</span>&nbsp;&#8658;&nbsp;<span class='ident'>const</span><span class='keyword'>(</span><span class='ident'>string</span><span class='keyword'>(</span><span class='ident'>s</span><span class='keyword'>))</span>&nbsp;<span class='keyword'>}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>/</span>&nbsp;&nbsp;<span class='keyword'>{</span>&nbsp;<span class='pattern'><span class='const'>&quot;[&quot;</span></span>&nbsp;<span class='pattern'>cslist</span><span class='keyword'><span class='pattern'>&lt;[l0expr],</span></span><span class='const'><span class='pattern'>&quot;;&quot;</span></span><span class='keyword'><span class='pattern'>&gt;:</span></span><span class='pattern'>es</span>&nbsp;<span class='pattern'><span class='const'>&quot;]&quot;</span></span>&nbsp;&#8658;&nbsp;<span class='ident'>mklist</span><span class='keyword'>(</span><span class='ident'>es</span><span class='keyword'>)</span>&nbsp;<span class='keyword'>}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>/</span>&nbsp;&nbsp;<span class='keyword'>{</span>&nbsp;<span class='pattern'><span class='const'>&quot;[&quot;</span></span>&nbsp;<span class='pattern'><span class='const'>&quot;]&quot;</span></span>&nbsp;&#8658;&nbsp;<span class='ident'>const</span><span class='keyword'>(</span><span class='ident'>nil</span><span class='keyword'>())</span>&nbsp;<span class='keyword'>}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>/</span>&nbsp;&nbsp;<span class='keyword'>{</span>&nbsp;<span class='pattern'><span class='const'>&quot;'&quot;</span></span>&nbsp;<span class='keyword'><span class='pattern'>[l0qident]:</span></span><span class='pattern'>s</span>&nbsp;&#8658;&nbsp;<span class='ident'>const</span><span class='keyword'>(</span><span class='ident'>symbol</span><span class='keyword'>(</span><span class='ident'>s</span><span class='keyword'>))</span>&nbsp;<span class='keyword'>}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>/</span>&nbsp;&nbsp;<span class='keyword'>{</span>&nbsp;<span class='keyword'><span class='pattern'>[l0qident]:</span></span><span class='pattern'>id</span>&nbsp;<span class='pattern'><span class='const'>&quot;(&quot;</span></span>&nbsp;<span class='pattern'>ecslist</span><span class='keyword'><span class='pattern'>&lt;[l0expr],</span></span><span class='const'><span class='pattern'>&quot;,&quot;</span></span><span class='keyword'><span class='pattern'>&gt;:</span></span><span class='pattern'>args</span>&nbsp;<span class='pattern'><span class='const'>&quot;)&quot;</span></span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#8658;&nbsp;<span class='ident'>apply</span><span class='keyword'>(</span><span class='ident'>var</span><span class='keyword'>(</span><span class='ident'>id</span><span class='keyword'>),@</span><span class='ident'>args</span><span class='keyword'>)</span>&nbsp;<span class='keyword'>}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>/</span>&nbsp;&nbsp;<span class='keyword'>{</span>&nbsp;<span class='keyword'><span class='pattern'>[l0qident]:</span></span><span class='pattern'>id</span>&nbsp;&#8658;&nbsp;<span class='ident'>var</span><span class='keyword'>(</span><span class='ident'>id</span><span class='keyword'>)</span>&nbsp;<span class='keyword'>}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>;</span><br>
&nbsp;&nbsp;<span class='comment'>//&nbsp;A&nbsp;single&nbsp;let&nbsp;binding&nbsp;node<br>
</span>&nbsp;&nbsp;<span class='ident'>l0letpair</span>&nbsp;<span class='keyword'>&gt;&gt;</span>&nbsp;<span class='ident'>letpair</span>&nbsp;&#8656;&nbsp;<span class='keyword'><span class='pattern'>[l0qident]:</span></span><span class='pattern'>id</span>&nbsp;<span class='pattern'><span class='const'>&quot;=&quot;</span></span>&nbsp;<span class='keyword'><span class='pattern'>[l0expr]:</span></span><span class='pattern'>e</span>&nbsp;&#8658;&nbsp;<span class='ident'>p</span><span class='keyword'>(</span><span class='ident'>id</span><span class='keyword'>,</span>&nbsp;<span class='ident'>e</span><span class='keyword'>)</span><span class='keyword'>;</span><br>
<br>
&nbsp;&nbsp;<span class='comment'>//&nbsp;Potentially&nbsp;unquoted&nbsp;identifiers<br>
</span>&nbsp;&nbsp;<span class='ident'>l0qident</span>&nbsp;&#8656;&nbsp;<span class='keyword'>{</span>&nbsp;<span class='pattern'><span class='const'>&quot;\&quot;</span></span>&nbsp;<span class='keyword'><span class='pattern'>[l0expr]:</span></span><span class='pattern'>e</span>&nbsp;<span class='pattern'><span class='const'>&quot;\&quot;</span></span>&nbsp;&#8658;&nbsp;<span class='ident'>unquote</span><span class='keyword'>(</span><span class='ident'>e</span><span class='keyword'>)</span>&nbsp;<span class='keyword'>}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>/</span>&nbsp;&nbsp;<span class='keyword'>{</span>&nbsp;<span class='keyword'><span class='pattern'>[ident]:</span></span><span class='pattern'>id</span>&nbsp;&#8658;&nbsp;<span class='ident'>v</span><span class='keyword'>(</span><span class='ident'>id</span><span class='keyword'>)</span>&nbsp;<span class='keyword'>}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>;</span><br>
<span class='keyword'>}</span>
<p></div>


<p>An example of a language accepted by this parser would look like this:






<p><div class='democode'>
<span class='comment'>/*&nbsp;Comment&nbsp;*/</span><br>
<span class='keyword'>function</span>&nbsp;<span class='ident'>foldl</span><span class='lexic'>(</span><span class='ident'>fn</span><span class='lexic'>,</span>&nbsp;<span class='ident'>i</span><span class='lexic'>,</span>&nbsp;<span class='ident'>l</span><span class='lexic'>)</span><br>
<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;<span class='keyword'>if</span><span class='lexic'>(</span><span class='ident'>nullp</span><span class='lexic'>(</span><span class='ident'>l</span><span class='lexic'>))</span>&nbsp;<span class='keyword'>return</span>&nbsp;<span class='ident'>i</span><br>
&nbsp;&nbsp;&nbsp;<span class='keyword'>else</span>&nbsp;<span class='keyword'>let</span>&nbsp;<span class='ident'>hd</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='ident'>head</span><span class='lexic'>(</span><span class='ident'>l</span><span class='lexic'>),</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='ident'>tl</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='ident'>tail</span><span class='lexic'>(</span><span class='ident'>l</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>in</span>&nbsp;<span class='ident'>foldl</span><span class='lexic'>(</span><span class='ident'>fn</span><span class='lexic'>,</span>&nbsp;<span class='ident'>fn</span><span class='lexic'>(</span><span class='ident'>i</span><span class='lexic'>,</span>&nbsp;<span class='ident'>hd</span><span class='lexic'>),</span>&nbsp;<span class='ident'>tl</span><span class='lexic'>)</span><br>
<span class='lexic'>}</span>
</div><p>



<p><div class='democode'>
<br>
<span class='comment'>//&nbsp;One-line&nbsp;comment<br>
</span><span class='ident'>print</span><span class='lexic'>(</span><span class='ident'>foldl</span><span class='lexic'>(</span><span class='keyword'>fun</span><span class='lexic'>(</span><span class='ident'>a</span><span class='lexic'>,</span><span class='ident'>b</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><span class='ident'>a</span><span class='lexic'>+</span><span class='ident'>b</span><span class='lexic'>},</span>&nbsp;<span class='const'>0</span><span class='lexic'>,</span>&nbsp;<span class='lexic'>[</span><span class='const'>1</span><span class='lexic'>;</span><span class='const'>2</span><span class='lexic'>;</span><span class='const'>3</span><span class='lexic'>;</span><span class='const'>4</span><span class='lexic'>;</span><span class='const'>5</span><span class='lexic'>;</span><span class='const'>6</span><span class='lexic'>]))</span>
</div><p>


<p>We will use this foldl function to illustrate the compilation pipeline.

<p>There is nothing interesting to see there yet. Leaving it here just for a reference - this
function straight after parsing:



   

<p><div class='democode'>
<span class='lexic'>(define</span>&nbsp;<span class='lexic'>(</span><span class='ident'>v</span>&nbsp;<span class='keyword'>foldl</span><span class='lexic'>)</span>&nbsp;<br>
&nbsp;&nbsp;<span class='lexic'>(lambda</span>&nbsp;<span class='lexic'>((</span><span class='ident'>v</span>&nbsp;<span class='ident'>fn</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>(</span><span class='ident'>v</span>&nbsp;<span class='ident'>i</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>(</span><span class='ident'>v</span>&nbsp;<span class='ident'>l</span><span class='lexic'>))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>seq</span>&nbsp;<span class='lexic'>(</span><span class='ident'>if3</span>&nbsp;<span class='lexic'>(</span><span class='keyword'>apply</span>&nbsp;<span class='lexic'>(</span><span class='ident'>var</span>&nbsp;<span class='lexic'>(</span><span class='ident'>v</span>&nbsp;<span class='ident'>nullp</span><span class='lexic'>))</span>&nbsp;<span class='lexic'>(</span><span class='ident'>var</span>&nbsp;<span class='lexic'>(</span><span class='ident'>v</span>&nbsp;<span class='ident'>l</span><span class='lexic'>)))</span>&nbsp;<span class='lexic'>(</span><span class='ident'>var</span>&nbsp;<span class='lexic'>(</span><span class='ident'>v</span>&nbsp;<span class='ident'>i</span><span class='lexic'>))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(let</span>&nbsp;<span class='lexic'>((</span><span class='ident'>p</span>&nbsp;<span class='lexic'>(</span><span class='ident'>v</span>&nbsp;<span class='ident'>hd</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>(</span><span class='keyword'>apply</span>&nbsp;<span class='lexic'>(</span><span class='ident'>var</span>&nbsp;<span class='lexic'>(</span><span class='ident'>v</span>&nbsp;<span class='ident'>head</span><span class='lexic'>))</span>&nbsp;<span class='lexic'>(</span><span class='ident'>var</span>&nbsp;<span class='lexic'>(</span><span class='ident'>v</span>&nbsp;<span class='ident'>l</span><span class='lexic'>))))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>p</span>&nbsp;<span class='lexic'>(</span><span class='ident'>v</span>&nbsp;<span class='ident'>tl</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>(</span><span class='keyword'>apply</span>&nbsp;<span class='lexic'>(</span><span class='ident'>var</span>&nbsp;<span class='lexic'>(</span><span class='ident'>v</span>&nbsp;<span class='ident'>tail</span><span class='lexic'>))</span>&nbsp;<span class='lexic'>(</span><span class='ident'>var</span>&nbsp;<span class='lexic'>(</span><span class='ident'>v</span>&nbsp;<span class='ident'>l</span><span class='lexic'>)))))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='keyword'>apply</span>&nbsp;<span class='lexic'>(</span><span class='ident'>var</span>&nbsp;<span class='lexic'>(</span><span class='ident'>v</span>&nbsp;<span class='keyword'>foldl</span><span class='lexic'>))</span>&nbsp;<span class='lexic'>(</span><span class='ident'>var</span>&nbsp;<span class='lexic'>(</span><span class='ident'>v</span>&nbsp;<span class='ident'>fn</span><span class='lexic'>))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='keyword'>apply</span>&nbsp;<span class='lexic'>(</span><span class='ident'>var</span>&nbsp;<span class='lexic'>(</span><span class='ident'>v</span>&nbsp;<span class='ident'>fn</span><span class='lexic'>))</span>&nbsp;<span class='lexic'>(</span><span class='ident'>var</span>&nbsp;<span class='lexic'>(</span><span class='ident'>v</span>&nbsp;<span class='ident'>i</span><span class='lexic'>))</span>&nbsp;<span class='lexic'>(</span><span class='ident'>var</span>&nbsp;<span class='lexic'>(</span><span class='ident'>v</span>&nbsp;<span class='ident'>hd</span><span class='lexic'>)))</span>&nbsp;<span class='lexic'>(</span><span class='ident'>var</span>&nbsp;<span class='lexic'>(</span><span class='ident'>v</span>&nbsp;<span class='ident'>tl</span><span class='lexic'>))))))))</span><br>

</div><p>




<h2 id="macros">Macro expansion</h2>

Logically, this is the next step straight after parsing. Though, it is a
relatively advanced subject that probably should be skipped at first, straight
to the <a href="#sugar">syntax sugar lowering</a>. Feel free to come back and
review this section after reading about the runtime-compiler feedback loop.

At this moment we don't have any feedback loop, it can only be defined later,
when the rest of the compiler pipeline is finalised. We'll leave an empty stub
here meanwhile.


<p><div class='code'>
<span id='Z486812'><span class='keyword'>d</span></span><span class='keyword'>efine</span>&nbsp;<span class='ident'>l0_env_feedback_hook</span>&nbsp;<span class='lexic'>=</span><br>
&nbsp;&nbsp;<span class='ident'>mkref</span><span class='lexic'>(</span><span class='keyword'>&lambda;</span><span class='lexic'>(</span><span class='ident'>globenv</span><span class='lexic'>,</span>&nbsp;<span class='ident'>t</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>&#8709;</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;<br>
<span id='Z486813'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_env_feedback_loop</span><span class='lexic'>(</span><span id='Z486818'><span><span class='ident'>globenv</span></span></span><span class='lexic'>,</span>&nbsp;<span id='Z486819'><span><span class='ident'>t</span></span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;<span class='lexic'>(^</span><span class='ident'>l0_env_feedback_hook</span><span class='lexic'>)(</span><span class='idfrom' onmouseenter='srcref_over("Z486818",this)' onmouseleave='srcref_leave("Z486818",this)'><span><span class='ident'>globenv</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z486819",this)' onmouseleave='srcref_leave("Z486819",this)'><span><span class='ident'>t</span></span></span><span class='lexic'>)</span>
<p></div>


Unfortunately, macros imply a very eary exposure to the concept of environment,
which, again, we'd prefer to leave for much later down the pipeline. We'll keep
a dummy stub here instead.


<p><div class='code'>
<span id='Z486827'><span class='keyword'>d</span></span><span class='keyword'>efine</span>&nbsp;<span class='ident'>l0_env_find_macro_hook</span>&nbsp;<span class='lexic'>=</span><br>
&nbsp;&nbsp;<span class='ident'>mkref</span><span class='lexic'>(</span><span class='keyword'>&lambda;</span><span class='lexic'>(</span><span class='ident'>globenv</span><span class='lexic'>,</span>&nbsp;<span class='ident'>id</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>&#8709;</span><span class='lexic'>)</span>
<p></div>



<p><div class='code'>
<span id='Z486834'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_env_find_macro</span><span class='lexic'>(</span><span id='Z487691'><span><span class='ident'>globenv</span></span></span><span class='lexic'>,</span>&nbsp;<span id='Z487693'><span><span class='ident'>fn</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;<span id='Z487692'><span><span class='ident'>getid</span></span></span><span class='lexic'>(</span><span id='Z487270'><span><span class='ident'>fn</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>=</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0src</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>expr</span><span class='lexic'>:</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z487270",this)' onmouseleave='srcref_leave("Z487270",this)'><span><span class='ident'>fn</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>expr</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z487614'><span><span class='ident'>var</span></span></span>&nbsp;&#8594;&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z487614",this)' onmouseleave='srcref_leave("Z487614",this)'><span><span class='ident'>id</span></span></span><span class='hint'>var(id)</span></span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='lexic'>&#8709;</span><span class='lexic'>};</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>ident</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z487683'><span><span class='ident'>v</span></span></span>&nbsp;&#8594;&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z487683",this)' onmouseleave='srcref_leave("Z487683",this)'><span><span class='ident'>id</span></span></span><span class='hint'>v(id)</span></span>&nbsp;<span class='lexic'>|</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='lexic'>&#8709;</span><span class='lexic'>}};</span><br>
&nbsp;&nbsp;<span class='lexic'>(^</span><span class='ident'>l0_env_find_macro_hook</span><span class='lexic'>)(</span><span class='idfrom' onmouseenter='srcref_over("Z487691",this)' onmouseleave='srcref_leave("Z487691",this)'><span><span class='ident'>globenv</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z487692",this)' onmouseleave='srcref_leave("Z487692",this)'><span><span class='ident'>getid</span></span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z487693",this)' onmouseleave='srcref_leave("Z487693",this)'><span><span class='ident'>fn</span></span></span><span class='lexic'>))}</span>
<p></div>


In order to be able to implement macros we need an access to AST constructing
functions.  The easiest way of abstracting them out nicely is to use
quasiquotation: any AST inside the quasiquotation is translated into an
AST-constructing code that calls the appropriate runtime library functions.


<p><div class='code'>
<span id='Z487781'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_compile_quasiquote</span><span class='lexic'>(</span><span class='ident'>loop</span><span class='lexic'>,</span>&nbsp;<span id='Z488335'><span><span class='ident'>e</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;<span id='Z488646'><span><span class='ident'>mkapp</span></span></span><span class='lexic'>(</span><span id='Z488303'><span><span class='ident'>id</span></span></span><span class='lexic'>,</span>&nbsp;<span id='Z488310'><span><span class='ident'>args</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='keyword'>with</span>&nbsp;<span class='keyword'>target</span>&nbsp;<span class='lexic'>(</span><span class='ident'>lang0src</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>expr</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>apply</span><span class='hint'>lang0src:expr:apply(fn,args)</span></span><span class='lexic'>(</span><span class='ident'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>var</span><span class='hint'>lang0src:expr:var(id)</span></span><span class='lexic'>(</span><span class='ident'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>v</span><span class='hint'>lang0src:ident:v(id)</span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z488303",this)' onmouseleave='srcref_leave("Z488303",this)'><span><span class='ident'>id</span></span></span><span class='lexic'>)),</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z488310",this)' onmouseleave='srcref_leave("Z488310",this)'><span><span class='ident'>args</span></span></span><span class='lexic'>)};</span><br>
&nbsp;&nbsp;&nbsp;<span id='Z488814'><span><span class='ident'>mkqsymbol</span></span></span><span class='lexic'>(</span><span id='Z488323'><span><span class='ident'>id</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='keyword'>with</span>&nbsp;<span class='keyword'>target</span>&nbsp;<span class='lexic'>(</span><span class='ident'>lang0src</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>expr</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>const</span><span class='hint'>lang0src:expr:const(c)</span></span><span class='lexic'>(</span><span class='ident'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>symbol</span><span class='hint'>lang0src:const:symbol(s)</span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z488323",this)' onmouseleave='srcref_leave("Z488323",this)'><span><span class='ident'>id</span></span></span><span class='lexic'>))};</span><br>
&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0src</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>expr</span><span class='lexic'>:</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z488335",this)' onmouseleave='srcref_leave("Z488335",this)'><span><span class='ident'>e</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>once</span>&nbsp;<span class='ident'>expr</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z488802'><span><span class='ident'>unquote</span></span></span>&nbsp;&#8594;&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z488802",this)' onmouseleave='srcref_leave("Z488802",this)'><span><span class='ident'>e</span></span></span><span class='hint'>unquote(e)</span></span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='keyword'>deep</span>&nbsp;&#8594;&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z488650'><span><span class='ident'>lambda</span></span></span>&nbsp;&#8594;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z488646",this)' onmouseleave='srcref_leave("Z488646",this)'><span><span class='ident'>mkapp</span></span></span><span class='lexic'>(</span><span class='symbol'>'macrolib.make_lambda'</span><span class='lexic'>,</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>[</span><span class='idfrom' onmouseenter='srcref_over("Z488646",this)' onmouseleave='srcref_leave("Z488646",this)'><span><span class='ident'>mkapp</span></span></span><span class='lexic'>(</span><span class='symbol'>'macrolib.make_list'</span><span class='lexic'>,</span>&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>mklist</span><span class='hint'>lang0src:expr:mklist(es)</span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z488650",this)' onmouseleave='srcref_leave("Z488650",this)'><span><span class='ident'>args</span></span></span><span class='hint'>lambda(args,body)</span></span><span class='lexic'>));</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z488650",this)' onmouseleave='srcref_leave("Z488650",this)'><span><span class='ident'>body</span></span></span><span class='hint'>lambda(args,body)</span></span><span class='lexic'>])</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;&nbsp;<span id='Z488666'><span><span class='ident'>seq</span></span></span>&nbsp;&#8594;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z488646",this)' onmouseleave='srcref_leave("Z488646",this)'><span><span class='ident'>mkapp</span></span></span><span class='lexic'>(</span><span class='symbol'>'macrolib.make_seq'</span><span class='lexic'>,</span>&nbsp;<span class='lexic'>[</span><span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>mklist</span><span class='hint'>lang0src:expr:mklist(es)</span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z488666",this)' onmouseleave='srcref_leave("Z488666",this)'><span><span class='ident'>body</span></span></span><span class='hint'>seq(body)</span></span><span class='lexic'>)])</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;&nbsp;<span class='ident'>const</span>&nbsp;&#8594;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z488646",this)' onmouseleave='srcref_leave("Z488646",this)'><span><span class='ident'>mkapp</span></span></span><span class='lexic'>(</span><span class='symbol'>'macrolib.make_const'</span><span class='lexic'>,</span>&nbsp;<span class='lexic'>[</span><span class='ident'>node</span><span class='lexic'>()])</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;&nbsp;<span id='Z488680'><span><span class='ident'>var</span></span></span>&nbsp;&#8594;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z488646",this)' onmouseleave='srcref_leave("Z488646",this)'><span><span class='ident'>mkapp</span></span></span><span class='lexic'>(</span><span class='symbol'>'macrolib.make_var'</span><span class='lexic'>,</span>&nbsp;<span class='lexic'>[</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z488680",this)' onmouseleave='srcref_leave("Z488680",this)'><span><span class='ident'>id</span></span></span><span class='hint'>var(id)</span></span><span class='lexic'>])</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;&nbsp;<span id='Z488689'><span><span class='ident'>apply</span></span></span>&nbsp;&#8594;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z488646",this)' onmouseleave='srcref_leave("Z488646",this)'><span><span class='ident'>mkapp</span></span></span><span class='lexic'>(</span><span class='symbol'>'macrolib.make_apply'</span><span class='lexic'>,</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>[</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z488689",this)' onmouseleave='srcref_leave("Z488689",this)'><span><span class='ident'>fn</span></span></span><span class='hint'>apply(fn,args)</span></span><span class='lexic'>;</span>&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>mklist</span><span class='hint'>lang0src:expr:mklist(es)</span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z488689",this)' onmouseleave='srcref_leave("Z488689",this)'><span><span class='ident'>args</span></span></span><span class='hint'>apply(fn,args)</span></span><span class='lexic'>)])</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;&nbsp;<span id='Z488711'><span><span class='ident'>apply2</span></span></span>&nbsp;&#8594;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z488646",this)' onmouseleave='srcref_leave("Z488646",this)'><span><span class='ident'>mkapp</span></span></span><span class='lexic'>(</span><span class='symbol'>'macrolib.make_apply2'</span><span class='lexic'>,</span>&nbsp;<span class='lexic'>[</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z488711",this)' onmouseleave='srcref_leave("Z488711",this)'><span><span class='ident'>fn</span></span></span><span class='hint'>apply2(fn,L,R)</span></span><span class='lexic'>;</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z488711",this)' onmouseleave='srcref_leave("Z488711",this)'><span><span class='ident'>L</span></span></span><span class='hint'>apply2(fn,L,R)</span></span><span class='lexic'>;</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z488711",this)' onmouseleave='srcref_leave("Z488711",this)'><span><span class='ident'>R</span></span></span><span class='hint'>apply2(fn,L,R)</span></span><span class='lexic'>])</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;&nbsp;<span id='Z488727'><span><span class='ident'>if3</span></span></span>&nbsp;&#8594;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z488646",this)' onmouseleave='srcref_leave("Z488646",this)'><span><span class='ident'>mkapp</span></span></span><span class='lexic'>(</span><span class='symbol'>'macrolib.make_if3'</span><span class='lexic'>,</span>&nbsp;<span class='lexic'>[</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z488727",this)' onmouseleave='srcref_leave("Z488727",this)'><span><span class='ident'>cnd</span></span></span><span class='hint'>if3(cnd,tr,fl)</span></span><span class='lexic'>;</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z488727",this)' onmouseleave='srcref_leave("Z488727",this)'><span><span class='ident'>tr</span></span></span><span class='hint'>if3(cnd,tr,fl)</span></span><span class='lexic'>;</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z488727",this)' onmouseleave='srcref_leave("Z488727",this)'><span><span class='ident'>fl</span></span></span><span class='hint'>if3(cnd,tr,fl)</span></span><span class='lexic'>])</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;&nbsp;<span id='Z488740'><span><span class='ident'>if2</span></span></span>&nbsp;&#8594;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z488646",this)' onmouseleave='srcref_leave("Z488646",this)'><span><span class='ident'>mkapp</span></span></span><span class='lexic'>(</span><span class='symbol'>'macrolib.make_if2'</span><span class='lexic'>,</span>&nbsp;<span class='lexic'>[</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z488740",this)' onmouseleave='srcref_leave("Z488740",this)'><span><span class='ident'>cnd</span></span></span><span class='hint'>if2(cnd,tr)</span></span><span class='lexic'>;</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z488740",this)' onmouseleave='srcref_leave("Z488740",this)'><span><span class='ident'>tr</span></span></span><span class='hint'>if2(cnd,tr)</span></span><span class='lexic'>])</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;&nbsp;<span id='Z488754'><span><span class='ident'>let</span></span></span>&nbsp;&#8594;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z488646",this)' onmouseleave='srcref_leave("Z488646",this)'><span><span class='ident'>mkapp</span></span></span><span class='lexic'>(</span><span class='symbol'>'macrolib.make_let'</span><span class='lexic'>,</span>&nbsp;<span class='lexic'>[</span><span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>mklist</span><span class='hint'>lang0src:expr:mklist(es)</span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z488754",this)' onmouseleave='srcref_leave("Z488754",this)'><span><span class='ident'>ps</span></span></span><span class='hint'>let(ps,body)</span></span><span class='lexic'>);</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z488754",this)' onmouseleave='srcref_leave("Z488754",this)'><span><span class='ident'>body</span></span></span><span class='hint'>let(ps,body)</span></span><span class='lexic'>])</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;&nbsp;<span id='Z488770'><span><span class='ident'>mklist</span></span></span>&nbsp;&#8594;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z488646",this)' onmouseleave='srcref_leave("Z488646",this)'><span><span class='ident'>mkapp</span></span></span><span class='lexic'>(</span><span class='symbol'>'macrolib.make_mklist'</span><span class='lexic'>,</span>&nbsp;<span class='lexic'>[</span><span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>mklist</span><span class='hint'>lang0src:expr:mklist(es)</span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z488770",this)' onmouseleave='srcref_leave("Z488770",this)'><span><span class='ident'>es</span></span></span><span class='hint'>mklist(es)</span></span><span class='lexic'>)])</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;&nbsp;<span id='Z488793'><span><span class='ident'>toplift</span></span></span>&nbsp;&#8594;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z488646",this)' onmouseleave='srcref_leave("Z488646",this)'><span><span class='ident'>mkapp</span></span></span><span class='lexic'>(</span><span class='symbol'>'macrolib.make_toplift'</span><span class='lexic'>,</span>&nbsp;<span class='lexic'>[</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z488793",this)' onmouseleave='srcref_leave("Z488793",this)'><span><span class='ident'>t</span></span></span><span class='hint'>toplift(t)</span></span><span class='lexic'>])</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='withhint'><span class='ident'>ccerror</span><span class='hint'>function&nbsp;ccerror&nbsp;arg:&nbsp;<br>
Raises&nbsp;[MBaseException]&nbsp;with&nbsp;a&nbsp;given&nbsp;argument.</span></span><span class='lexic'>(</span><span class='symbol'>'IMPOSSIBLE'</span><span class='lexic'>())}};</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>ident</span>&nbsp;<span class='lexic'>{</span>&nbsp;<span id='Z488815'><span><span class='ident'>v</span></span></span>&nbsp;&#8594;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z488814",this)' onmouseleave='srcref_leave("Z488814",this)'><span><span class='ident'>mkqsymbol</span></span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z488815",this)' onmouseleave='srcref_leave("Z488815",this)'><span><span class='ident'>id</span></span></span><span class='hint'>v(id)</span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>|</span>&nbsp;<span id='Z488808'><span><span class='ident'>unquote</span></span></span>&nbsp;&#8594;&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z488808",this)' onmouseleave='srcref_leave("Z488808",this)'><span><span class='ident'>e</span></span></span><span class='hint'>unquote(e)</span></span>&nbsp;<span class='lexic'>};</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>letpair</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z488824'><span><span class='ident'>p</span></span></span>&nbsp;&#8594;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z488646",this)' onmouseleave='srcref_leave("Z488646",this)'><span><span class='ident'>mkapp</span></span></span><span class='lexic'>(</span><span class='symbol'>'macrolib.make_letpair'</span><span class='lexic'>,</span>&nbsp;<span class='lexic'>[</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z488824",this)' onmouseleave='srcref_leave("Z488824",this)'><span><span class='ident'>id</span></span></span><span class='hint'>p(id,v)</span></span><span class='lexic'>;</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z488824",this)' onmouseleave='srcref_leave("Z488824",this)'><span><span class='ident'>v</span></span></span><span class='hint'>p(id,v)</span></span><span class='lexic'>])};</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>top</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z488835'><span><span class='ident'>define</span></span></span>&nbsp;&#8594;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z488646",this)' onmouseleave='srcref_leave("Z488646",this)'><span><span class='ident'>mkapp</span></span></span><span class='lexic'>(</span><span class='symbol'>'macrolib.make_define'</span><span class='lexic'>,</span>&nbsp;<span class='lexic'>[</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z488835",this)' onmouseleave='srcref_leave("Z488835",this)'><span><span class='ident'>id</span></span></span><span class='hint'>define(id,e)</span></span><span class='lexic'>;</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z488835",this)' onmouseleave='srcref_leave("Z488835",this)'><span><span class='ident'>e</span></span></span><span class='hint'>define(id,e)</span></span><span class='lexic'>])</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span id='Z488846'><span><span class='ident'>defmacro</span></span></span>&nbsp;&#8594;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z488646",this)' onmouseleave='srcref_leave("Z488646",this)'><span><span class='ident'>mkapp</span></span></span><span class='lexic'>(</span><span class='symbol'>'macrolib.make_defmacro'</span><span class='lexic'>,</span>&nbsp;<span class='lexic'>[</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z488846",this)' onmouseleave='srcref_leave("Z488846",this)'><span><span class='ident'>id</span></span></span><span class='hint'>defmacro(id,e)</span></span><span class='lexic'>;</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z488846",this)' onmouseleave='srcref_leave("Z488846",this)'><span><span class='ident'>e</span></span></span><span class='hint'>defmacro(id,e)</span></span><span class='lexic'>])</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span id='Z488854'><span><span class='ident'>expr</span></span></span>&nbsp;&#8594;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z488646",this)' onmouseleave='srcref_leave("Z488646",this)'><span><span class='ident'>mkapp</span></span></span><span class='lexic'>(</span><span class='symbol'>'macrolib.make_expr'</span><span class='lexic'>,</span>&nbsp;<span class='lexic'>[</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z488854",this)' onmouseleave='srcref_leave("Z488854",this)'><span><span class='ident'>e</span></span></span><span class='hint'>expr(e)</span></span><span class='lexic'>])</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>debug</span>&nbsp;&#8594;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z488646",this)' onmouseleave='srcref_leave("Z488646",this)'><span><span class='ident'>mkapp</span></span></span><span class='lexic'>(</span><span class='symbol'>'macrolib.make_debug'</span><span class='lexic'>,</span>&nbsp;<span class='lexic'>&#8709;</span><span class='lexic'>)}}}</span>
<p></div>


Expression expansion pass includes handling the quasiquote nodes (consider
quasiquote a special kind of a "macro") and user-defined macros applied via the
compiler feedback loop.


<p><div class='code'>
<span id='Z488985'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_macro_expand_expr</span><span class='lexic'>(</span><span id='Z489799'><span><span class='ident'>globenv</span></span></span><span class='lexic'>,</span>&nbsp;<span id='Z489805'><span><span class='ident'>addtop</span></span></span><span class='lexic'>,</span>&nbsp;<span id='Z489442'><span><span class='ident'>e</span></span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0src</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>expr</span><span class='lexic'>:</span><span class='idfrom' onmouseenter='srcref_over("Z489442",this)' onmouseleave='srcref_leave("Z489442",this)'><span><span class='ident'>e</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>once</span>&nbsp;<span class='ident'>expr</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z489887'><span><span class='ident'>quasiquote</span></span></span>&nbsp;&#8594;&nbsp;<a href='#Z487781'><span class='ident'>l0_compile_quasiquote</span></a><span class='lexic'>(</span><span class='keyword'>&lambda;</span><span class='lexic'>(</span><span id='Z489886'><span><span class='ident'>e0</span></span></span><span class='lexic'>)</span>&nbsp;<a href='#Z488985'><span class='ident'>l0_macro_expand_expr</span></a><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z489799",this)' onmouseleave='srcref_leave("Z489799",this)'><span><span class='ident'>globenv</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z489805",this)' onmouseleave='srcref_leave("Z489805",this)'><span><span class='ident'>addtop</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z489886",this)' onmouseleave='srcref_leave("Z489886",this)'><span><span class='ident'>e0</span></span></span><span class='lexic'>)</span><span class='lexic'>,</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z489887",this)' onmouseleave='srcref_leave("Z489887",this)'><span><span class='ident'>e</span></span></span><span class='hint'>quasiquote(e)</span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>unquote</span>&nbsp;&#8594;&nbsp;<span class='withhint'><span class='ident'>ccerror</span><span class='hint'>function&nbsp;ccerror&nbsp;arg:&nbsp;<br>
Raises&nbsp;[MBaseException]&nbsp;with&nbsp;a&nbsp;given&nbsp;argument.</span></span><span class='lexic'>(</span><span class='symbol'>'MISPLACED-UNQUOTE'</span><span class='lexic'>())</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span id='Z489800'><span><span class='ident'>apply</span></span></span>&nbsp;&nbsp;&nbsp;&#8594;&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z489803'><span><span class='ident'>ismacro</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<a href='#Z486834'><span class='ident'>l0_env_find_macro</span></a><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z489799",this)' onmouseleave='srcref_leave("Z489799",this)'><span><span class='ident'>globenv</span></span></span><span class='lexic'>,</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z489800",this)' onmouseleave='srcref_leave("Z489800",this)'><span><span class='ident'>fn</span></span></span><span class='hint'>apply(fn,args)</span></span><span class='lexic'>);</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>if</span>&nbsp;<span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z489803",this)' onmouseleave='srcref_leave("Z489803",this)'><span><span class='ident'>ismacro</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z489806'><span><span class='ident'>nxt</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z489803",this)' onmouseleave='srcref_leave("Z489803",this)'><span><span class='ident'>ismacro</span></span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z489799",this)' onmouseleave='srcref_leave("Z489799",this)'><span><span class='ident'>globenv</span></span></span><span class='lexic'>,</span>&nbsp;<span class='ident'>node</span><span class='lexic'>());</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href='#Z488985'><span class='ident'>l0_macro_expand_expr</span></a><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z489799",this)' onmouseleave='srcref_leave("Z489799",this)'><span><span class='ident'>globenv</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z489805",this)' onmouseleave='srcref_leave("Z489805",this)'><span><span class='ident'>addtop</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z489806",this)' onmouseleave='srcref_leave("Z489806",this)'><span><span class='ident'>nxt</span></span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>}</span>&nbsp;<span class='keyword'>else</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='keyword'>node</span><span class='hint'>lang0src:expr:apply(fn,args)</span></span><span class='lexic'>(</span><span class='ident'>fn</span>&nbsp;<span class='lexic'>=</span>&nbsp;<a href='#Z488985'><span class='ident'>l0_macro_expand_expr</span></a><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z489799",this)' onmouseleave='srcref_leave("Z489799",this)'><span><span class='ident'>globenv</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z489805",this)' onmouseleave='srcref_leave("Z489805",this)'><span><span class='ident'>addtop</span></span></span><span class='lexic'>,</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z489800",this)' onmouseleave='srcref_leave("Z489800",this)'><span><span class='ident'>fn</span></span></span><span class='hint'>apply(fn,args)</span></span><span class='lexic'>),</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='ident'>args</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='keyword'>map</span>&nbsp;<span id='Z489820'><span><span class='ident'>a</span></span></span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z489800",this)' onmouseleave='srcref_leave("Z489800",this)'><span><span class='ident'>args</span></span></span><span class='hint'>apply(fn,args)</span></span>&nbsp;<span class='keyword'>do</span>&nbsp;<a href='#Z488985'><span class='ident'>l0_macro_expand_expr</span></a><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z489799",this)' onmouseleave='srcref_leave("Z489799",this)'><span><span class='ident'>globenv</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z489805",this)' onmouseleave='srcref_leave("Z489805",this)'><span><span class='ident'>addtop</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z489820",this)' onmouseleave='srcref_leave("Z489820",this)'><span><span class='ident'>a</span></span></span><span class='lexic'>))</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='keyword'>deep</span>&nbsp;&#8594;&nbsp;<span class='lexic'>{</span>&nbsp;<span class='ident'>toplift</span>&nbsp;&#8594;&nbsp;<span class='lexic'>{</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z489805",this)' onmouseleave='srcref_leave("Z489805",this)'><span><span class='ident'>addtop</span></span></span><span class='lexic'>(</span><span class='ident'>node</span><span class='lexic'>());</span>&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>seq</span><span class='hint'>lang0src:expr:seq(body)</span></span><span class='lexic'>(</span><span class='ident'>body</span><span class='lexic'>=</span><span class='lexic'>&#8709;</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='ident'>node</span><span class='lexic'>()</span>&nbsp;<span class='lexic'>}}}</span>
<p></div>



<p><div class='code'>
<span id='Z489992'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_macro_expand_top</span><span class='lexic'>(</span><span id='Z490761'><span><span class='ident'>globenv</span></span></span><span class='lexic'>,</span>&nbsp;<span id='Z490762'><span><span class='ident'>addtop</span></span></span><span class='lexic'>,</span>&nbsp;<span id='Z490426'><span><span class='ident'>t</span></span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0src</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>top</span><span class='lexic'>:</span><span class='idfrom' onmouseenter='srcref_over("Z490426",this)' onmouseleave='srcref_leave("Z490426",this)'><span><span class='ident'>t</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>once</span>&nbsp;<span class='ident'>expr</span>&nbsp;<span class='lexic'>{</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href='#Z488985'><span class='ident'>l0_macro_expand_expr</span></a><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z490761",this)' onmouseleave='srcref_leave("Z490761",this)'><span><span class='ident'>globenv</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z490762",this)' onmouseleave='srcref_leave("Z490762",this)'><span><span class='ident'>addtop</span></span></span><span class='lexic'>,</span>&nbsp;<span class='ident'>node</span><span class='lexic'>())</span>&nbsp;<span class='lexic'>}}</span>
<p></div>



<p><div class='code'>
<span id='Z490926'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_macro_expand</span><span class='lexic'>(</span><span id='Z491769'><span><span class='ident'>globenv</span></span></span><span class='lexic'>,</span>&nbsp;<span id='Z491369'><span><span class='ident'>ts</span></span></span><span class='lexic'>)</span><br>
<span class='keyword'>collector</span>&nbsp;<span class='lexic'>(</span><span id='Z491768'><span><span class='ident'>addtop</span></span></span><span class='lexic'>,</span>&nbsp;<span id='Z491793'><span><span class='ident'>gettop</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;<span class='keyword'>iter</span>&nbsp;<span id='Z491376'><span><span class='ident'>t</span></span></span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z491369",this)' onmouseleave='srcref_leave("Z491369",this)'><span><span class='ident'>ts</span></span></span>&nbsp;<span class='keyword'>do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0src</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>top</span><span class='lexic'>:</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z491376",this)' onmouseleave='srcref_leave("Z491376",this)'><span><span class='ident'>t</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>once</span>&nbsp;<span class='ident'>top</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='ident'>defmacro</span>&nbsp;&#8594;&nbsp;<a href='#Z486813'><span class='ident'>l0_env_feedback_loop</span></a><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z491769",this)' onmouseleave='srcref_leave("Z491769",this)'><span><span class='ident'>globenv</span></span></span><span class='lexic'>,</span>&nbsp;<span class='ident'>node</span><span class='lexic'>())</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z491768",this)' onmouseleave='srcref_leave("Z491768",this)'><span><span class='ident'>addtop</span></span></span><span class='lexic'>(</span><a href='#Z489992'><span class='ident'>l0_macro_expand_top</span></a><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z491769",this)' onmouseleave='srcref_leave("Z491769",this)'><span><span class='ident'>globenv</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z491768",this)' onmouseleave='srcref_leave("Z491768",this)'><span><span class='ident'>addtop</span></span></span><span class='lexic'>,</span>&nbsp;<span class='ident'>node</span><span class='lexic'>()))}};</span><br>
&nbsp;&nbsp;&nbsp;<span class='keyword'>return</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z491793",this)' onmouseleave='srcref_leave("Z491793",this)'><span><span class='ident'>gettop</span></span></span><span class='lexic'>()}</span>
<p></div>


<h3>Cleanup</h3>

Now all the quasiquotations, macro applications and top lift nodes are eliminated and we can turn our AST
into a form suitable for the rest of the compiler pipeline.


<p><div class='code'>
<span id='Z491881'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_postexpand_sanitise</span><span class='lexic'>(</span><span id='Z492316'><span><span class='ident'>ts</span></span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;<span class='keyword'>map</span>&nbsp;<span id='Z492324'><span><span class='ident'>t</span></span></span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z492316",this)' onmouseleave='srcref_leave("Z492316",this)'><span><span class='ident'>ts</span></span></span>&nbsp;<span class='keyword'>do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0src</span>&nbsp;<span class='lexic'>/rec,</span>&nbsp;<span class='lexic'>dst</span>&nbsp;<span class='ident'>lang0</span><span class='lexic'>/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>top</span><span class='lexic'>:</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z492324",this)' onmouseleave='srcref_leave("Z492324",this)'><span><span class='ident'>t</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>expr</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='ident'>toplift</span>&nbsp;&#8594;&nbsp;<span class='withhint'><span class='ident'>ccerror</span><span class='hint'>function&nbsp;ccerror&nbsp;arg:&nbsp;<br>
Raises&nbsp;[MBaseException]&nbsp;with&nbsp;a&nbsp;given&nbsp;argument.</span></span><span class='lexic'>(</span><span class='symbol'>'IMPOSSIBLE'</span><span class='lexic'>())</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>quasiquote</span>&nbsp;&#8594;&nbsp;<span class='withhint'><span class='ident'>ccerror</span><span class='hint'>function&nbsp;ccerror&nbsp;arg:&nbsp;<br>
Raises&nbsp;[MBaseException]&nbsp;with&nbsp;a&nbsp;given&nbsp;argument.</span></span><span class='lexic'>(</span><span class='symbol'>'IMPOSSIBLE'</span><span class='lexic'>())</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>unquote</span>&nbsp;&#8594;&nbsp;<span class='withhint'><span class='ident'>ccerror</span><span class='hint'>function&nbsp;ccerror&nbsp;arg:&nbsp;<br>
Raises&nbsp;[MBaseException]&nbsp;with&nbsp;a&nbsp;given&nbsp;argument.</span></span><span class='lexic'>(</span><span class='symbol'>'IMPOSSIBLE'</span><span class='lexic'>())</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='ident'>node</span><span class='lexic'>()</span><span class='lexic'>};</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>ident</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='ident'>unquote</span>&nbsp;&#8594;&nbsp;<span class='withhint'><span class='ident'>ccerror</span><span class='hint'>function&nbsp;ccerror&nbsp;arg:&nbsp;<br>
Raises&nbsp;[MBaseException]&nbsp;with&nbsp;a&nbsp;given&nbsp;argument.</span></span><span class='lexic'>(</span><span class='symbol'>'IMPOSSIBLE'</span><span class='lexic'>())</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span id='Z492734'><span><span class='ident'>v</span></span></span>&nbsp;&#8594;&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z492734",this)' onmouseleave='srcref_leave("Z492734",this)'><span><span class='ident'>id</span></span></span><span class='hint'>v(id)</span></span><span class='lexic'>}}</span>
<p></div>


For the compiler pipeline demo purposes we need a dummy environment:


<p><div class='code'>
<span id='Z492829'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_expand_dummy</span><span class='lexic'>(</span><span id='Z492831'><span><span class='ident'>ts</span></span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;<a href='#Z491881'><span class='ident'>l0_postexpand_sanitise</span></a><span class='lexic'>(</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<a href='#Z490926'><span class='ident'>l0_macro_expand</span></a><span class='lexic'>(</span><span class='ident'>mkhash</span><span class='lexic'>(),</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z492831",this)' onmouseleave='srcref_leave("Z492831",this)'><span><span class='ident'>ts</span></span></span><span class='lexic'>))</span>
<p></div>






<h2 id="sugar">Lowering</h2>

<p>Our first AST is designed for parsing, but it is not very useful for any further analysis, optimisations and
a code generation. Before we start actually compiling anything we have to eliminate some syntax sugar and make this
AST simpler.

<h3>Eliminating syntax sugar</h3>

<p>The two argument application node was only introduced to simplify binary expressions parsing and must go.

<p>This is our first introduction to <i>visitors</i> - a fundamental building block in PFront. Visitor walks
over an AST in a defined order and builds a new AST, transforming certain nodes with given expressions. In this
case we only rewrite <b>apply2</b> variant of an <b>expr</b> node, with all the boilerplate covering all possible
paths to <b>expr</b> nodes being inferred automatically.

<p>Variant constructors like <b>mk:apply</b> are context-dependent, in this visitor we know that the resulting
AST is the same as the original AST, so it constructs <b>lang0:expr:apply</b> variants.

<p>This function takes a list of toplevel statements as an argument, and returns a list of transformed toplevel
statements.


<p><div class='code'>
<span id='Z492835'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_eliminate_apply2</span><span class='lexic'>(</span><span id='Z493185'><span><span class='ident'>ts</span></span></span><span class='lexic'>)</span><br>
&nbsp;<span class='comment'>//&nbsp;'ts'&nbsp;is&nbsp;a&nbsp;list&nbsp;of&nbsp;top&nbsp;statements,<br>
</span>&nbsp;<span class='comment'>//&nbsp;&nbsp;&nbsp;we'll&nbsp;visit&nbsp;them&nbsp;one&nbsp;by&nbsp;one<br>
</span>&nbsp;<span class='keyword'>map</span>&nbsp;<span id='Z493193'><span><span class='ident'>t</span></span></span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z493185",this)' onmouseleave='srcref_leave("Z493185",this)'><span><span class='ident'>ts</span></span></span>&nbsp;<span class='keyword'>do</span><br>
&nbsp;&nbsp;<span class='comment'>//&nbsp;A&nbsp;visitor&nbsp;block:<br>
</span>&nbsp;&nbsp;<span class='comment'>//&nbsp;&nbsp;*&nbsp;&nbsp;The&nbsp;source&nbsp;AST&nbsp;is&nbsp;'lang0',&nbsp;destination&nbsp;is&nbsp;the&nbsp;same<br>
</span>&nbsp;&nbsp;<span class='comment'>//&nbsp;&nbsp;*&nbsp;&nbsp;It's&nbsp;a&nbsp;recform&nbsp;AST&nbsp;(not&nbsp;an&nbsp;old&nbsp;list-based&nbsp;one)<br>
</span>&nbsp;&nbsp;<span class='comment'>//&nbsp;&nbsp;*&nbsp;&nbsp;The&nbsp;entry&nbsp;point&nbsp;is&nbsp;a&nbsp;'top'&nbsp;node<br>
</span>&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>top</span><span class='lexic'>:</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z493193",this)' onmouseleave='srcref_leave("Z493193",this)'><span><span class='ident'>t</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='comment'>//&nbsp;All&nbsp;the&nbsp;'expr'&nbsp;nodes&nbsp;are&nbsp;visited&nbsp;in&nbsp;a&nbsp;depth-first&nbsp;order<br>
</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>expr</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='comment'>//&nbsp;All&nbsp;the&nbsp;'apply2'&nbsp;variants&nbsp;of&nbsp;'expr'&nbsp;are&nbsp;rewritten<br>
</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='comment'>//&nbsp;&nbsp;as&nbsp;'apply'&nbsp;variants<br>
</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z493473'><span><span class='ident'>apply2</span></span></span>&nbsp;&#8594;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>apply</span><span class='hint'>lang0:expr:apply(fn,args)</span></span><span class='lexic'>(</span><span class='ident'>fn</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>var</span><span class='hint'>lang0:expr:var(id)</span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z493473",this)' onmouseleave='srcref_leave("Z493473",this)'><span><span class='ident'>fn</span></span></span><span class='hint'>apply2(fn,L,R)</span></span><span class='lexic'>),</span>&nbsp;<span class='ident'>args</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='lexic'>[</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z493473",this)' onmouseleave='srcref_leave("Z493473",this)'><span><span class='ident'>L</span></span></span><span class='hint'>apply2(fn,L,R)</span></span><span class='lexic'>;</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z493473",this)' onmouseleave='srcref_leave("Z493473",this)'><span><span class='ident'>R</span></span></span><span class='hint'>apply2(fn,L,R)</span></span><span class='lexic'>])</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='comment'>//&nbsp;All&nbsp;the&nbsp;other&nbsp;variants&nbsp;will&nbsp;remain&nbsp;the&nbsp;same<br>
</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='ident'>node</span><span class='lexic'>()</span><span class='lexic'>}}</span>
<p></div>


<p>A two-armed <b>if</b> does not make sense in an expression--based language and it must go. An implicit false branch
returns a nil constant.


<p><div class='code'>
<span id='Z493599'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_eliminate_if2</span><span class='lexic'>(</span><span id='Z493958'><span><span class='ident'>ts</span></span></span><span class='lexic'>)</span><br>
&nbsp;<span class='keyword'>map</span>&nbsp;<span id='Z493966'><span><span class='ident'>t</span></span></span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z493958",this)' onmouseleave='srcref_leave("Z493958",this)'><span><span class='ident'>ts</span></span></span>&nbsp;<span class='keyword'>do</span><br>
&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>top</span><span class='lexic'>:</span><span class='idfrom' onmouseenter='srcref_over("Z493966",this)' onmouseleave='srcref_leave("Z493966",this)'><span><span class='ident'>t</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>expr</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='ident'>if2</span>&nbsp;&#8594;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>if3</span><span class='hint'>lang0:expr:if3(cnd,tr,fl)<br>
&nbsp;&nbsp;&nbsp;with&nbsp;implicit&nbsp;arguments:&nbsp;cnd,&nbsp;tr<br>
</span></span><span class='lexic'>(</span><span class='ident'>fl</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>const</span><span class='hint'>lang0:expr:const(c)</span></span><span class='lexic'>(</span><span class='ident'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>nil</span><span class='hint'>lang0:const:nil()</span></span><span class='lexic'>()))</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='ident'>node</span><span class='lexic'>()</span><span class='lexic'>}}</span>
<p></div>


<p>And a list constructor is just a sequence of nested <b>cons</b> applications. We do not care if it's entirely
constant at this stage, all the optimisations can be done at a later stage.


<p><div class='code'>
<span id='Z494371'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_eliminate_list</span><span class='lexic'>(</span><span id='Z494745'><span><span class='ident'>ts</span></span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;<span class='keyword'>map</span>&nbsp;<span id='Z494753'><span><span class='ident'>t</span></span></span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z494745",this)' onmouseleave='srcref_leave("Z494745",this)'><span><span class='ident'>ts</span></span></span>&nbsp;<span class='keyword'>do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>top</span><span class='lexic'>:</span><span class='idfrom' onmouseenter='srcref_over("Z494753",this)' onmouseleave='srcref_leave("Z494753",this)'><span><span class='ident'>t</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>expr</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z495095'><span><span class='ident'>mklist</span></span></span>&nbsp;&#8594;&nbsp;<span class='keyword'>do</span>&nbsp;<span id='Z495072'><span><span class='ident'>loop</span></span></span><span class='lexic'>(</span><span id='Z495094'><span><span class='ident'>e</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z495095",this)' onmouseleave='srcref_leave("Z495095",this)'><span><span class='ident'>es</span></span></span><span class='hint'>mklist(es)</span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>match</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z495094",this)' onmouseleave='srcref_leave("Z495094",this)'><span><span class='ident'>e</span></span></span>&nbsp;<span class='keyword'>with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z495071'><span><span class='ident'><span class='pattern'>hd</span></span></span></span><span class='pattern'>&nbsp;</span><span class='lexic'><span class='pattern'>:</span></span><span class='pattern'>&nbsp;</span><span id='Z495073'><span><span class='ident'><span class='pattern'>tl</span></span></span></span>&nbsp;&#8594;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>apply</span><span class='hint'>lang0:expr:apply(fn,args)</span></span><span class='lexic'>(</span><span class='ident'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>var</span><span class='hint'>lang0:expr:var(id)</span></span><span class='lexic'>(</span><span class='symbol'>'cons'</span><span class='lexic'>),</span>&nbsp;<span class='lexic'>[</span><span class='idfrom' onmouseenter='srcref_over("Z495071",this)' onmouseleave='srcref_leave("Z495071",this)'><span><span class='ident'>hd</span></span></span><span class='lexic'>;</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z495072",this)' onmouseleave='srcref_leave("Z495072",this)'><span><span class='ident'>loop</span></span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z495073",this)' onmouseleave='srcref_leave("Z495073",this)'><span><span class='ident'>tl</span></span></span><span class='lexic'>)])</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='lexic'><span class='pattern'>&#8709;</span></span>&nbsp;&#8594;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>const</span><span class='hint'>lang0:expr:const(c)</span></span><span class='lexic'>(</span><span class='ident'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>nil</span><span class='hint'>lang0:const:nil()</span></span><span class='lexic'>())}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='ident'>node</span><span class='lexic'>()</span><span class='lexic'>}}</span>
<p></div>


<p>And everything together now:


<p><div class='code'>
<span id='Z495193'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_lowering</span><span class='lexic'>(</span><span id='Z495195'><span><span class='ident'>ts</span></span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;<a href='#Z494371'><span class='ident'>l0_eliminate_list</span></a><span class='lexic'>(</span><br>
&nbsp;&nbsp;&nbsp;<a href='#Z493599'><span class='ident'>l0_eliminate_if2</span></a><span class='lexic'>(</span><br>
&nbsp;&nbsp;&nbsp;<a href='#Z492835'><span class='ident'>l0_eliminate_apply2</span></a><span class='lexic'>(</span><br>
&nbsp;&nbsp;&nbsp;<a href='#Z492829'><span class='ident'>l0_expand_dummy</span></a><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z495195",this)' onmouseleave='srcref_leave("Z495195",this)'><span><span class='ident'>ts</span></span></span><span class='lexic'>))))</span>
<p></div>



<h2 id="lexical">Lexical scope</h2>

<p>This is a lexically scoped language, allowing new definitions to override an outer scope. This is a default
design decision for languages with pattern matching, for example. Our core language does not have any pattern
matching support, but it can be added later with macros and syntax extensions.

<p>The simplest approach to lexical scope implementation is to just rename all the variables to make them unique.
In a consequent pass we'll collect variable and argument declarations and sort everything into categories -
global variables, local variables and lambda arguments. Another category to appear later (after a lambda
lifting pass) is a closure variable.


<p><div class='code'>
<span id='Z495199'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_lexical_scope_expr</span><span class='lexic'>(</span><span id='Z497020'><span><span class='ident'>e0</span></span></span><span class='lexic'>,</span>&nbsp;<span id='Z496882'><span><span class='ident'>addrenames</span></span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;<span class='keyword'>do</span>&nbsp;<span id='Z496655'><span><span class='ident'>loop</span></span></span><span class='lexic'>(</span><span id='Z496674'><span><span class='ident'>e</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z497020",this)' onmouseleave='srcref_leave("Z497020",this)'><span><span class='ident'>e0</span></span></span><span class='lexic'>,</span>&nbsp;<span id='Z496658'><span><span class='ident'>env</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='lexic'>&#8709;</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='comment'>//&nbsp;A&nbsp;helper&nbsp;function,&nbsp;returns&nbsp;a&nbsp;new&nbsp;name&nbsp;if&nbsp;it&nbsp;is&nbsp;in&nbsp;the&nbsp;current<br>
</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='comment'>//&nbsp;environment&nbsp;or&nbsp;id&nbsp;unchanged&nbsp;(meaning&nbsp;it's&nbsp;a&nbsp;global&nbsp;name)<br>
</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z496650'><span><span class='ident'>renamevar</span></span></span><span class='lexic'>(</span><span id='Z496106'><span><span class='ident'>venv</span></span></span><span class='lexic'>,</span>&nbsp;<span id='Z496092'><span><span class='ident'>id</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>=</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>do</span>&nbsp;<span id='Z496102'><span><span class='ident'>iloop</span></span></span><span class='lexic'>(</span><span id='Z496105'><span><span class='ident'>e</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z496106",this)' onmouseleave='srcref_leave("Z496106",this)'><span><span class='ident'>venv</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>match</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z496105",this)' onmouseleave='srcref_leave("Z496105",this)'><span><span class='ident'>e</span></span></span>&nbsp;<span class='keyword'>with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'><span class='pattern'>[(</span></span><span class='ident'><span class='pattern'>iid</span></span><span class='pattern'>&nbsp;</span><span class='keyword'><span class='pattern'>when</span></span><span class='pattern'>&nbsp;</span><span class='ident'><span class='pattern'>iid</span></span><span class='pattern'>&nbsp;</span><span class='lexic'><span class='pattern'>===</span></span><span class='pattern'>&nbsp;</span><span class='idfrom' onmouseenter='srcref_over("Z496092",this)' onmouseleave='srcref_leave("Z496092",this)'><span><span class='ident'><span class='pattern'>id</span></span></span></span><span class='lexic'><span class='pattern'>);</span></span><span class='pattern'>&nbsp;</span><span id='Z496097'><span><span class='ident'><span class='pattern'>nnm</span></span></span></span><span class='lexic'><span class='pattern'>]:</span></span><span class='ident'><span class='pattern'>tl</span></span>&nbsp;&#8594;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z496097",this)' onmouseleave='srcref_leave("Z496097",this)'><span><span class='ident'>nnm</span></span></span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'><span class='pattern'>hd</span></span><span class='lexic'><span class='pattern'>:</span></span><span id='Z496103'><span><span class='ident'><span class='pattern'>tl</span></span></span></span>&nbsp;&#8594;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z496102",this)' onmouseleave='srcref_leave("Z496102",this)'><span><span class='ident'>iloop</span></span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z496103",this)' onmouseleave='srcref_leave("Z496103",this)'><span><span class='ident'>tl</span></span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'><span class='pattern'>else</span></span>&nbsp;&#8594;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z496092",this)' onmouseleave='srcref_leave("Z496092",this)'><span><span class='ident'>id</span></span></span><span class='lexic'>};</span><br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='comment'>//&nbsp;A&nbsp;helper&nbsp;function&nbsp;to&nbsp;access&nbsp;an&nbsp;identifier&nbsp;bound<br>
</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='comment'>//&nbsp;in&nbsp;a&nbsp;let&nbsp;pair<br>
</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z496977'><span><span class='ident'>getpident</span></span></span><span class='lexic'>(</span><span id='Z496115'><span><span class='ident'>p</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>letpair</span><span class='lexic'>:</span><span class='idfrom' onmouseenter='srcref_over("Z496115",this)' onmouseleave='srcref_leave("Z496115",this)'><span><span class='ident'>p</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>once</span>&nbsp;<span class='ident'>letpair</span>&nbsp;<span class='lexic'>{</span>&nbsp;<span id='Z496372'><span><span class='ident'>p</span></span></span>&nbsp;&#8594;&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z496372",this)' onmouseleave='srcref_leave("Z496372",this)'><span><span class='ident'>id</span></span></span><span class='hint'>p(id,v)</span></span>&nbsp;<span class='lexic'>}};</span><br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='comment'>//&nbsp;A&nbsp;helper&nbsp;function:&nbsp;loop&nbsp;into&nbsp;a&nbsp;right&nbsp;hand&nbsp;side<br>
</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='comment'>//&nbsp;of&nbsp;a&nbsp;let&nbsp;pair&nbsp;and&nbsp;rename&nbsp;a&nbsp;bound&nbsp;identifier<br>
</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z496991'><span><span class='ident'>loopps</span></span></span><span class='lexic'>(</span><span id='Z496651'><span><span class='ident'>ne</span></span></span><span class='lexic'>,</span>&nbsp;<span id='Z496389'><span><span class='ident'>p</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>letpair</span><span class='lexic'>:</span><span class='idfrom' onmouseenter='srcref_over("Z496389",this)' onmouseleave='srcref_leave("Z496389",this)'><span><span class='ident'>p</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>letpair</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z496652'><span><span class='ident'>p</span></span></span>&nbsp;&#8594;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='keyword'>node</span><span class='hint'>lang0:letpair:p(id,v)</span></span><span class='lexic'>(</span><span class='ident'>id</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z496650",this)' onmouseleave='srcref_leave("Z496650",this)'><span><span class='ident'>renamevar</span></span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z496651",this)' onmouseleave='srcref_leave("Z496651",this)'><span><span class='ident'>ne</span></span></span><span class='lexic'>,</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z496652",this)' onmouseleave='srcref_leave("Z496652",this)'><span><span class='ident'>id</span></span></span><span class='hint'>p(id,v)</span></span><span class='lexic'>),</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='ident'>v</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z496655",this)' onmouseleave='srcref_leave("Z496655",this)'><span><span class='ident'>loop</span></span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z496652",this)' onmouseleave='srcref_leave("Z496652",this)'><span><span class='ident'>v</span></span></span><span class='hint'>p(id,v)</span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z496658",this)' onmouseleave='srcref_leave("Z496658",this)'><span><span class='ident'>env</span></span></span><span class='lexic'>))}};</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='comment'>//&nbsp;Main&nbsp;visitor:&nbsp;for&nbsp;lambda&nbsp;and&nbsp;let&nbsp;nodes&nbsp;it<br>
</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='comment'>//&nbsp;stops&nbsp;and&nbsp;recurses&nbsp;into&nbsp;their&nbsp;sub-nodes&nbsp;explicitly,<br>
</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='comment'>//&nbsp;while&nbsp;all&nbsp;the&nbsp;other&nbsp;variants&nbsp;are&nbsp;traversed&nbsp;in&nbsp;the&nbsp;depth-first<br>
</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='comment'>//&nbsp;order.<br>
</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>expr</span><span class='lexic'>:</span><span class='idfrom' onmouseenter='srcref_over("Z496674",this)' onmouseleave='srcref_leave("Z496674",this)'><span><span class='ident'>e</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>once</span>&nbsp;<span class='ident'>expr</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z496875'><span><span class='ident'>lambda</span></span></span>&nbsp;&#8594;&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z496883'><span><span class='ident'>newenv</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='keyword'>map</span>&nbsp;<span id='Z496880'><span><span class='ident'>a</span></span></span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z496875",this)' onmouseleave='srcref_leave("Z496875",this)'><span><span class='ident'>args</span></span></span><span class='hint'>lambda(args,body)</span></span>&nbsp;<span class='keyword'>do</span>&nbsp;<span class='lexic'>[</span><span class='idfrom' onmouseenter='srcref_over("Z496880",this)' onmouseleave='srcref_leave("Z496880",this)'><span><span class='ident'>a</span></span></span><span class='lexic'>;</span>&nbsp;<span class='withhint'><span class='ident'>gensym</span><span class='hint'>function&nbsp;gensym&nbsp;:&nbsp;<br>
Returns&nbsp;a&nbsp;unique&nbsp;symbol&nbsp;every&nbsp;time&nbsp;it&nbsp;is&nbsp;called.<br>
Uniqueness&nbsp;is&nbsp;guaranteed&nbsp;within&nbsp;one&nbsp;run&nbsp;only.</span></span><span class='lexic'>()];</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z496882",this)' onmouseleave='srcref_leave("Z496882",this)'><span><span class='ident'>addrenames</span></span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z496883",this)' onmouseleave='srcref_leave("Z496883",this)'><span><span class='ident'>newenv</span></span></span><span class='lexic'>);</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>elambda</span><span class='hint'>lang0:expr:elambda(args,benv,fenv,body)</span></span><span class='lexic'>(</span><span class='ident'>args</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='keyword'>map</span>&nbsp;<span class='lexic'>[</span><span class='ident'><span class='pattern'>a</span></span><span class='lexic'>;</span><span id='Z496904'><span><span class='ident'><span class='pattern'>b</span></span></span></span><span class='lexic'>]</span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z496883",this)' onmouseleave='srcref_leave("Z496883",this)'><span><span class='ident'>newenv</span></span></span>&nbsp;<span class='keyword'>do</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z496904",this)' onmouseleave='srcref_leave("Z496904",this)'><span><span class='ident'>b</span></span></span><span class='lexic'>,</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='ident'>benv</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z496658",this)' onmouseleave='srcref_leave("Z496658",this)'><span><span class='ident'>env</span></span></span><span class='lexic'>,</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='ident'>fenv</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='lexic'>&#8709;</span><span class='lexic'>,</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='ident'>body</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z496655",this)' onmouseleave='srcref_leave("Z496655",this)'><span><span class='ident'>loop</span></span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z496875",this)' onmouseleave='srcref_leave("Z496875",this)'><span><span class='ident'>body</span></span></span><span class='hint'>lambda(args,body)</span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z496883",this)' onmouseleave='srcref_leave("Z496883",this)'><span><span class='ident'>newenv</span></span></span>&nbsp;<span class='lexic'>&#8853;</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z496658",this)' onmouseleave='srcref_leave("Z496658",this)'><span><span class='ident'>env</span></span></span><span class='lexic'>))}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span id='Z496972'><span><span class='ident'>let</span></span></span>&nbsp;&#8594;&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z496979'><span><span class='ident'>newenv</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='keyword'>map</span>&nbsp;<span id='Z496978'><span><span class='ident'>p</span></span></span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z496972",this)' onmouseleave='srcref_leave("Z496972",this)'><span><span class='ident'>ps</span></span></span><span class='hint'>let(ps,body)</span></span>&nbsp;<span class='keyword'>do</span>&nbsp;<span class='lexic'>[</span><span class='idfrom' onmouseenter='srcref_over("Z496977",this)' onmouseleave='srcref_leave("Z496977",this)'><span><span class='ident'>getpident</span></span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z496978",this)' onmouseleave='srcref_leave("Z496978",this)'><span><span class='ident'>p</span></span></span><span class='lexic'>);</span>&nbsp;<span class='withhint'><span class='ident'>gensym</span><span class='hint'>function&nbsp;gensym&nbsp;:&nbsp;<br>
Returns&nbsp;a&nbsp;unique&nbsp;symbol&nbsp;every&nbsp;time&nbsp;it&nbsp;is&nbsp;called.<br>
Uniqueness&nbsp;is&nbsp;guaranteed&nbsp;within&nbsp;one&nbsp;run&nbsp;only.</span></span><span class='lexic'>()];</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z496882",this)' onmouseleave='srcref_leave("Z496882",this)'><span><span class='ident'>addrenames</span></span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z496979",this)' onmouseleave='srcref_leave("Z496979",this)'><span><span class='ident'>newenv</span></span></span><span class='lexic'>);</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='keyword'>node</span><span class='hint'>lang0:expr:let(ps,body)</span></span><span class='lexic'>(</span><span class='ident'>ps</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='keyword'>map</span>&nbsp;<span id='Z496992'><span><span class='ident'>p</span></span></span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z496972",this)' onmouseleave='srcref_leave("Z496972",this)'><span><span class='ident'>ps</span></span></span><span class='hint'>let(ps,body)</span></span>&nbsp;<span class='keyword'>do</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z496991",this)' onmouseleave='srcref_leave("Z496991",this)'><span><span class='ident'>loopps</span></span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z496979",this)' onmouseleave='srcref_leave("Z496979",this)'><span><span class='ident'>newenv</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z496992",this)' onmouseleave='srcref_leave("Z496992",this)'><span><span class='ident'>p</span></span></span><span class='lexic'>),</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='ident'>body</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z496655",this)' onmouseleave='srcref_leave("Z496655",this)'><span><span class='ident'>loop</span></span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z496972",this)' onmouseleave='srcref_leave("Z496972",this)'><span><span class='ident'>body</span></span></span><span class='hint'>let(ps,body)</span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z496979",this)' onmouseleave='srcref_leave("Z496979",this)'><span><span class='ident'>newenv</span></span></span><span class='lexic'>&#8853;</span><span class='idfrom' onmouseenter='srcref_over("Z496658",this)' onmouseleave='srcref_leave("Z496658",this)'><span><span class='ident'>env</span></span></span><span class='lexic'>))}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='keyword'>deep</span>&nbsp;&#8594;&nbsp;<span class='lexic'>{</span>&nbsp;<span id='Z496924'><span><span class='ident'>var</span></span></span>&nbsp;&#8594;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='keyword'>node</span><span class='hint'>lang0:expr:var(id)</span></span><span class='lexic'>(</span><span class='ident'>id</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z496650",this)' onmouseleave='srcref_leave("Z496650",this)'><span><span class='ident'>renamevar</span></span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z496658",this)' onmouseleave='srcref_leave("Z496658",this)'><span><span class='ident'>env</span></span></span><span class='lexic'>,</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z496924",this)' onmouseleave='srcref_leave("Z496924",this)'><span><span class='ident'>id</span></span></span><span class='hint'>var(id)</span></span><span class='lexic'>))</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='ident'>node</span><span class='lexic'>()</span>&nbsp;<span class='lexic'>}}}}</span>
<p></div>


<p>It would be nice to keep a track of all the renames we did, it could help
with producing debug information and with giving error messages more context.


<p><div class='code'>
<span id='Z497228'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_lexical_scope</span><span class='lexic'>(</span><span id='Z497591'><span><span class='ident'>ts</span></span></span><span class='lexic'>)</span><br>
&nbsp;<span class='keyword'>collector</span><span class='lexic'>(</span><span id='Z497842'><span><span class='ident'>add</span></span></span><span class='lexic'>,</span>&nbsp;<span id='Z497926'><span><span class='ident'>get</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;<span id='Z497934'><span><span class='ident'>ret</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='keyword'>map</span>&nbsp;<span id='Z497599'><span><span class='ident'>t</span></span></span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z497591",this)' onmouseleave='srcref_leave("Z497591",this)'><span><span class='ident'>ts</span></span></span>&nbsp;<span class='keyword'>do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>top</span><span class='lexic'>:</span><span class='idfrom' onmouseenter='srcref_over("Z497599",this)' onmouseleave='srcref_leave("Z497599",this)'><span><span class='ident'>t</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>once</span>&nbsp;<span class='ident'>expr</span>&nbsp;<span class='lexic'>{</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<a href='#Z495199'><span class='ident'>l0_lexical_scope_expr</span></a><span class='lexic'>(</span><span class='ident'>node</span><span class='lexic'>(),</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z497842",this)' onmouseleave='srcref_leave("Z497842",this)'><span><span class='ident'>add</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>}};</span><br>
&nbsp;&nbsp;&nbsp;<span class='keyword'>with</span>&nbsp;<span class='keyword'>target</span>&nbsp;<span class='lexic'>(</span><span class='ident'>lang0</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>top</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>debug</span><span class='hint'>lang0:top:debug(es)</span></span><span class='lexic'>(</span><span class='symbol'>'renames'</span><span class='lexic'>(@</span><span class='keyword'>map</span>&nbsp;<span class='keyword'>append</span>&nbsp;<span id='Z497929'><span><span class='ident'>g</span></span></span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z497926",this)' onmouseleave='srcref_leave("Z497926",this)'><span><span class='ident'>get</span></span></span><span class='lexic'>()</span>&nbsp;<span class='keyword'>do</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z497929",this)' onmouseleave='srcref_leave("Z497929",this)'><span><span class='ident'>g</span></span></span><span class='lexic'>))</span>&nbsp;<span class='lexic'>:</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z497934",this)' onmouseleave='srcref_leave("Z497934",this)'><span><span class='ident'>ret</span></span></span><br>
&nbsp;&nbsp;&nbsp;<span class='lexic'>}}</span>
<p></div>


<p>Now it's time to stop using the initial AST and move on. We eliminated few variants, and are going to introduce
more specific variable variants: global, local, argument or a closure variable. We're also introducing variants
for a consequent lambda lifting.

<p>The new AST is derived from the previous one (<b>lang0</b>), with few modifications
made to the <b>expr</b> node.


<p><div class='code'>
<span class='keyword'>ast</span>&nbsp;<span class='ident'>lang0i</span>&nbsp;<span class='lexic'>:</span>&nbsp;<span class='ident'>lang0</span>&nbsp;<span class='lexic'>()</span>&nbsp;<span class='keyword'>recform</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;<span class='ident'>expr</span>&nbsp;<span class='lexic'>+=</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='ident'>global</span><span class='lexic'>(</span><span class='ident'>ident</span><span class='lexic'>:</span><span class='ident'>id</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>local</span><span class='lexic'>(</span><span class='ident'>ident</span><span class='lexic'>:</span><span class='ident'>id</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>arg</span><span class='lexic'>(</span><span class='ident'>ident</span><span class='lexic'>:</span><span class='ident'>id</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>clvar</span><span class='lexic'>(</span><span class='ident'>ident</span><span class='lexic'>:</span><span class='ident'>id</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>mkclosure</span><span class='lexic'>(</span><span class='ident'>ident</span><span class='lexic'>:</span><span class='ident'>df</span><span class='lexic'>,</span>&nbsp;<span class='lexic'>*</span><span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>args</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>clambda</span><span class='lexic'>(*</span><span class='ident'>ident</span><span class='lexic'>:</span><span class='ident'>clenv</span><span class='lexic'>,</span>&nbsp;<span class='lexic'>*</span><span class='ident'>ident</span><span class='lexic'>:</span><span class='ident'>args</span><span class='lexic'>,</span>&nbsp;<span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>body</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='lexic'>-</span><span class='ident'>var</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='lexic'>-</span><span class='ident'>apply2</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='lexic'>-</span><span class='ident'>if2</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='lexic'>-</span><span class='ident'>mklist</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='lexic'>-</span><span class='ident'>lambda</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>;}</span>
<p></div>


<p>Now we can make our variables more specific, and since all the names are unique now we can do it easily in
a depth--first order. Of course we could do it in the previous pass, but it's better to keep passes as simple
as possible.


<p><div class='code'>
<span id='Z498011'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_classify_vars_top</span><span class='lexic'>(</span><span id='Z498717'><span><span class='ident'>t</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;<span id='Z499025'><span><span class='ident'>dict</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='ident'>mkhash</span><span class='lexic'>();</span><br>
&nbsp;&nbsp;<span class='comment'>//&nbsp;Fill&nbsp;a&nbsp;hash&nbsp;table&nbsp;with&nbsp;origins&nbsp;of&nbsp;all&nbsp;the&nbsp;definitions<br>
</span>&nbsp;&nbsp;<span id='Z499041'><span><span class='ident'>filldict</span></span></span><span class='lexic'>()</span>&nbsp;<span class='lexic'>=</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>top</span><span class='lexic'>:</span><span class='idfrom' onmouseenter='srcref_over("Z498717",this)' onmouseleave='srcref_leave("Z498717",this)'><span><span class='ident'>t</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>expr</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z499021'><span><span class='ident'>elambda</span></span></span>&nbsp;&#8594;&nbsp;<span class='keyword'>iter</span>&nbsp;<span id='Z499026'><span><span class='ident'>a</span></span></span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z499021",this)' onmouseleave='srcref_leave("Z499021",this)'><span><span class='ident'>args</span></span></span><span class='hint'>elambda(args,benv,fenv,body)</span></span>&nbsp;<span class='keyword'>do</span>&nbsp;<span class='ident'>ohashput</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z499025",this)' onmouseleave='srcref_leave("Z499025",this)'><span><span class='ident'>dict</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z499026",this)' onmouseleave='srcref_leave("Z499026",this)'><span><span class='ident'>a</span></span></span><span class='lexic'>,</span>&nbsp;<span class='symbol'>'arg'</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='lexic'>&#8709;</span><span class='lexic'>};</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>letpair</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z499033'><span><span class='ident'>p</span></span></span>&nbsp;&#8594;&nbsp;<span class='ident'>ohashput</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z499025",this)' onmouseleave='srcref_leave("Z499025",this)'><span><span class='ident'>dict</span></span></span><span class='lexic'>,</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z499033",this)' onmouseleave='srcref_leave("Z499033",this)'><span><span class='ident'>id</span></span></span><span class='hint'>p(id,v)</span></span><span class='lexic'>,</span>&nbsp;<span class='symbol'>'local'</span><span class='lexic'>)}};</span><br>
&nbsp;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z499041",this)' onmouseleave='srcref_leave("Z499041",this)'><span><span class='ident'>filldict</span></span></span><span class='lexic'>();</span><br>
<br>
&nbsp;&nbsp;<span class='comment'>//&nbsp;Replace&nbsp;all&nbsp;the&nbsp;var&nbsp;nodes&nbsp;with&nbsp;specific&nbsp;versions<br>
</span>&nbsp;&nbsp;<span class='comment'>//&nbsp;and&nbsp;use&nbsp;this&nbsp;opportunity&nbsp;to&nbsp;mark&nbsp;lambda&nbsp;bound&nbsp;variables&nbsp;lists&nbsp;with<br>
</span>&nbsp;&nbsp;<span class='comment'>//&nbsp;nearly&nbsp;correct&nbsp;origins.&nbsp;We're&nbsp;still&nbsp;missing&nbsp;closure&nbsp;variables,&nbsp;they&nbsp;will<br>
</span>&nbsp;&nbsp;<span class='comment'>//&nbsp;appear&nbsp;later.<br>
</span>&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0</span>&nbsp;<span class='lexic'>/rec,</span>&nbsp;<span class='lexic'>dst</span>&nbsp;<span class='ident'>lang0i</span><span class='lexic'>/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>top</span><span class='lexic'>:</span><span class='idfrom' onmouseenter='srcref_over("Z498717",this)' onmouseleave='srcref_leave("Z498717",this)'><span><span class='ident'>t</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>expr</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z499395'><span><span class='ident'>elambda</span></span></span>&nbsp;&#8594;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='keyword'>node</span><span class='hint'>lang0i:expr:elambda(args,benv,fenv,body)<br>
&nbsp;&nbsp;&nbsp;with&nbsp;implicit&nbsp;arguments:&nbsp;args,&nbsp;fenv,&nbsp;body<br>
</span></span><span class='lexic'>(</span><span class='ident'>benv</span>&nbsp;<span class='lexic'>=</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>map</span>&nbsp;<span class='lexic'>[</span><span class='ident'><span class='pattern'>o</span></span><span class='lexic'>;</span><span id='Z499409'><span><span class='ident'><span class='pattern'>n</span></span></span></span><span class='lexic'>]</span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z499395",this)' onmouseleave='srcref_leave("Z499395",this)'><span><span class='ident'>benv</span></span></span><span class='hint'>elambda(args,benv,fenv,body)</span></span>&nbsp;<span class='keyword'>do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>[</span><span class='idfrom' onmouseenter='srcref_over("Z499409",this)' onmouseleave='srcref_leave("Z499409",this)'><span><span class='ident'>n</span></span></span><span class='lexic'>;</span>&nbsp;<span class='ident'>ohashget</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z499025",this)' onmouseleave='srcref_leave("Z499025",this)'><span><span class='ident'>dict</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z499409",this)' onmouseleave='srcref_leave("Z499409",this)'><span><span class='ident'>n</span></span></span><span class='lexic'>)])</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span id='Z499305'><span><span class='ident'>var</span></span></span>&nbsp;&#8594;&nbsp;<span class='keyword'>aif</span>&nbsp;<span class='lexic'>(</span><span class='ident'>ct</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='ident'>ohashget</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z499025",this)' onmouseleave='srcref_leave("Z499025",this)'><span><span class='ident'>dict</span></span></span><span class='lexic'>,</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z499305",this)' onmouseleave='srcref_leave("Z499305",this)'><span><span class='ident'>id</span></span></span><span class='hint'>var(id)</span></span><span class='lexic'>))</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>if</span><span class='lexic'>(</span><span class='ident'>ct</span>&nbsp;<span class='lexic'>===</span>&nbsp;<span class='symbol'>'arg'</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>arg</span><span class='hint'>lang0i:expr:arg(id)</span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z499305",this)' onmouseleave='srcref_leave("Z499305",this)'><span><span class='ident'>id</span></span></span><span class='hint'>var(id)</span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>else</span>&nbsp;<span class='keyword'>if</span><span class='lexic'>(</span><span class='ident'>ct</span>&nbsp;<span class='lexic'>===</span>&nbsp;<span class='symbol'>'local'</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>local</span><span class='hint'>lang0i:expr:local(id)</span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z499305",this)' onmouseleave='srcref_leave("Z499305",this)'><span><span class='ident'>id</span></span></span><span class='hint'>var(id)</span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>else</span>&nbsp;<span class='withhint'><span class='ident'>ccerror</span><span class='hint'>function&nbsp;ccerror&nbsp;arg:&nbsp;<br>
Raises&nbsp;[MBaseException]&nbsp;with&nbsp;a&nbsp;given&nbsp;argument.</span></span><span class='lexic'>(</span><span class='symbol'>'WHAT?'</span><span class='lexic'>(</span><span class='ident'>ct</span><span class='lexic'>))</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>}</span>&nbsp;<span class='keyword'>else</span>&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>global</span><span class='hint'>lang0i:expr:global(id)</span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z499305",this)' onmouseleave='srcref_leave("Z499305",this)'><span><span class='ident'>id</span></span></span><span class='hint'>var(id)</span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='ident'>node</span><span class='lexic'>()}}}</span>
<p></div>



<p><div class='code'>
<span id='Z499573'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_classify_vars</span><span class='lexic'>(</span><span id='Z499583'><span><span class='ident'>ts</span></span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;<span class='keyword'>map</span>&nbsp;<span id='Z499586'><span><span class='ident'>t</span></span></span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z499583",this)' onmouseleave='srcref_leave("Z499583",this)'><span><span class='ident'>ts</span></span></span>&nbsp;<span class='keyword'>do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<a href='#Z498011'><span class='ident'>l0_classify_vars_top</span></a><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z499586",this)' onmouseleave='srcref_leave("Z499586",this)'><span><span class='ident'>t</span></span></span><span class='lexic'>)</span>
<p></div>



<h2 id="lifting">Lambda lifting</h2>

<p>Lambda lifting pass will turn all the nested lambda functions into toplevel definitions, capturing closure
environments where necessary. We did the lexical scoping pass previously, and now all the names inside any
given context are unique, which makes it easy to produce lists of externally defined variables used under each
lambda context.

<p>First we have to propagate the free variables lists (with bound variables already collected in the
lexical scoping pass), from top to bottom.


<p><div class='code'>
<span id='Z499594'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_lambda_lift_freevars</span><span class='lexic'>(</span><span id='Z500464'><span><span class='ident'>e</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;<span class='comment'>//&nbsp;A&nbsp;helper&nbsp;function:&nbsp;returns&nbsp;a&nbsp;list&nbsp;of&nbsp;all<br>
</span>&nbsp;&nbsp;<span class='comment'>//&nbsp;identifiers&nbsp;used&nbsp;in&nbsp;a&nbsp;given&nbsp;expression&nbsp;(bound&nbsp;or&nbsp;not)<br>
</span>&nbsp;&nbsp;<span id='Z500705'><span><span class='ident'>collectvars</span></span></span><span class='lexic'>(</span><span id='Z500175'><span><span class='ident'>e</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='keyword'>collector</span><span class='lexic'>(</span><span id='Z500418'><span><span class='ident'>addv</span></span></span><span class='lexic'>,</span>&nbsp;<span id='Z500458'><span><span class='ident'>getvs</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0i</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>expr</span><span class='lexic'>:</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z500175",this)' onmouseleave='srcref_leave("Z500175",this)'><span><span class='ident'>e</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>once</span>&nbsp;<span class='ident'>expr</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z500414'><span><span class='ident'>elambda</span></span></span>&nbsp;&#8594;&nbsp;<span class='lexic'>{</span><span class='keyword'>iter</span>&nbsp;<span id='Z500419'><span><span class='ident'>v</span></span></span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z500414",this)' onmouseleave='srcref_leave("Z500414",this)'><span><span class='ident'>fenv</span></span></span><span class='hint'>elambda(args,benv,fenv,body)</span></span>&nbsp;<span class='keyword'>do</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z500418",this)' onmouseleave='srcref_leave("Z500418",this)'><span><span class='ident'>addv</span></span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z500419",this)' onmouseleave='srcref_leave("Z500419",this)'><span><span class='ident'>v</span></span></span><span class='lexic'>)}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='keyword'>deep</span>&nbsp;&#8594;&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z500426'><span><span class='ident'>local</span></span></span>&nbsp;&#8594;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z500418",this)' onmouseleave='srcref_leave("Z500418",this)'><span><span class='ident'>addv</span></span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z500426",this)' onmouseleave='srcref_leave("Z500426",this)'><span><span class='ident'>id</span></span></span><span class='hint'>local(id)</span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span id='Z500432'><span><span class='ident'>arg</span></span></span>&nbsp;&#8594;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z500418",this)' onmouseleave='srcref_leave("Z500418",this)'><span><span class='ident'>addv</span></span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z500432",this)' onmouseleave='srcref_leave("Z500432",this)'><span><span class='ident'>id</span></span></span><span class='hint'>arg(id)</span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='lexic'>&#8709;</span><span class='lexic'>}}};</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>return</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z500458",this)' onmouseleave='srcref_leave("Z500458",this)'><span><span class='ident'>getvs</span></span></span><span class='lexic'>()};</span><br>
&nbsp;&nbsp;<span class='comment'>//&nbsp;Add&nbsp;free&nbsp;variable&nbsp;lists&nbsp;to&nbsp;all&nbsp;the&nbsp;lambda&nbsp;nodes,<br>
</span>&nbsp;&nbsp;<span class='comment'>//&nbsp;in&nbsp;a&nbsp;depth--first&nbsp;order.<br>
</span>&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0i</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>expr</span><span class='lexic'>:</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z500464",this)' onmouseleave='srcref_leave("Z500464",this)'><span><span class='ident'>e</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>expr</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z500706'><span><span class='ident'>elambda</span></span></span>&nbsp;&#8594;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='keyword'>node</span><span class='hint'>lang0i:expr:elambda(args,benv,fenv,body)<br>
&nbsp;&nbsp;&nbsp;with&nbsp;implicit&nbsp;arguments:&nbsp;args,&nbsp;benv,&nbsp;body<br>
</span></span><span class='lexic'>(</span><span class='ident'>fenv</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z500705",this)' onmouseleave='srcref_leave("Z500705",this)'><span><span class='ident'>collectvars</span></span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z500706",this)' onmouseleave='srcref_leave("Z500706",this)'><span><span class='ident'>body</span></span></span><span class='hint'>elambda(args,benv,fenv,body)</span></span><span class='lexic'>))</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='ident'>node</span><span class='lexic'>()}}}</span>
<p></div>


<p>Now we can use an intersection between a bound variables list and
a free variable list to form a closure environment.


<p><div class='code'>
<span id='Z500861'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_lambda_lift_expr</span><span class='lexic'>(</span><span id='Z501690'><span><span class='ident'>e</span></span></span><span class='lexic'>,</span>&nbsp;<span class='ident'>clenv</span><span class='lexic'>,</span>&nbsp;<span id='Z501596'><span><span class='ident'>adddef</span></span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;<span class='comment'>//&nbsp;An&nbsp;entry&nbsp;for&nbsp;nested&nbsp;lambdas,&nbsp;to&nbsp;keep&nbsp;a&nbsp;track&nbsp;of&nbsp;variables<br>
</span>&nbsp;&nbsp;<span class='comment'>//&nbsp;that&nbsp;were&nbsp;turned&nbsp;into&nbsp;closure&nbsp;variables&nbsp;in&nbsp;a&nbsp;lifted&nbsp;context.<br>
</span>&nbsp;&nbsp;<span class='keyword'>do</span>&nbsp;<span id='Z501587'><span><span class='ident'>loop</span></span></span><span class='lexic'>(</span><span id='Z501316'><span><span class='ident'>e</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z501690",this)' onmouseleave='srcref_leave("Z501690",this)'><span><span class='ident'>e</span></span></span><span class='lexic'>,</span>&nbsp;<span id='Z501290'><span><span class='ident'>renv</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='lexic'>&#8709;</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;<span class='comment'>//&nbsp;A&nbsp;helper&nbsp;function,&nbsp;generating&nbsp;a&nbsp;list&nbsp;of<br>
</span>&nbsp;&nbsp;&nbsp;<span class='comment'>//&nbsp;captured&nbsp;closure&nbsp;variables&nbsp;out&nbsp;of&nbsp;bound&nbsp;and&nbsp;free&nbsp;variables&nbsp;lists<br>
</span>&nbsp;&nbsp;&nbsp;<span id='Z501555'><span><span class='ident'>getclenv</span></span></span><span class='lexic'>(</span><span id='Z501277'><span><span class='ident'>benv</span></span></span><span class='lexic'>,</span>&nbsp;<span id='Z501264'><span><span class='ident'>fenv</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='keyword'>with</span>&nbsp;<span class='keyword'>target</span><span class='lexic'>(</span><span class='ident'>lang0i</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z501266'><span><span class='ident'>ht</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='ident'>mkhash</span><span class='lexic'>();</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>iter</span>&nbsp;<span id='Z501267'><span><span class='ident'>nm</span></span></span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z501264",this)' onmouseleave='srcref_leave("Z501264",this)'><span><span class='ident'>fenv</span></span></span>&nbsp;<span class='keyword'>do</span>&nbsp;<span class='ident'>ohashput</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z501266",this)' onmouseleave='srcref_leave("Z501266",this)'><span><span class='ident'>ht</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z501267",this)' onmouseleave='srcref_leave("Z501267",this)'><span><span class='ident'>nm</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z501267",this)' onmouseleave='srcref_leave("Z501267",this)'><span><span class='ident'>nm</span></span></span><span class='lexic'>);</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>map</span>&nbsp;<span class='keyword'>append</span>&nbsp;<span class='lexic'>[</span><span id='Z501289'><span><span class='ident'><span class='pattern'>nm</span></span></span></span><span class='lexic'>;</span><span id='Z501297'><span><span class='ident'><span class='pattern'>cl</span></span></span></span><span class='lexic'>]</span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z501277",this)' onmouseleave='srcref_leave("Z501277",this)'><span><span class='ident'>benv</span></span></span>&nbsp;<span class='keyword'>do</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>if</span><span class='lexic'>(</span><span class='ident'>ohashget</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z501266",this)' onmouseleave='srcref_leave("Z501266",this)'><span><span class='ident'>ht</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z501289",this)' onmouseleave='srcref_leave("Z501289",this)'><span><span class='ident'>nm</span></span></span><span class='lexic'>))</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>if</span>&nbsp;<span class='lexic'>(</span><span class='ident'>memq</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z501289",this)' onmouseleave='srcref_leave("Z501289",this)'><span><span class='ident'>nm</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z501290",this)' onmouseleave='srcref_leave("Z501290",this)'><span><span class='ident'>renv</span></span></span><span class='lexic'>))</span>&nbsp;<span class='lexic'>[[</span><span class='idfrom' onmouseenter='srcref_over("Z501289",this)' onmouseleave='srcref_leave("Z501289",this)'><span><span class='ident'>nm</span></span></span><span class='lexic'>;</span>&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>expr</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>clvar</span><span class='hint'>lang0i:expr:clvar(id)</span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z501289",this)' onmouseleave='srcref_leave("Z501289",this)'><span><span class='ident'>nm</span></span></span><span class='lexic'>)]]</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>else</span>&nbsp;<span class='keyword'>if</span>&nbsp;<span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z501297",this)' onmouseleave='srcref_leave("Z501297",this)'><span><span class='ident'>cl</span></span></span>&nbsp;<span class='lexic'>===</span>&nbsp;<span class='symbol'>'local'</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>[[</span><span class='idfrom' onmouseenter='srcref_over("Z501289",this)' onmouseleave='srcref_leave("Z501289",this)'><span><span class='ident'>nm</span></span></span><span class='lexic'>;</span>&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>expr</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>local</span><span class='hint'>lang0i:expr:local(id)</span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z501289",this)' onmouseleave='srcref_leave("Z501289",this)'><span><span class='ident'>nm</span></span></span><span class='lexic'>)]]</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>else</span>&nbsp;<span class='keyword'>if</span>&nbsp;<span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z501297",this)' onmouseleave='srcref_leave("Z501297",this)'><span><span class='ident'>cl</span></span></span>&nbsp;<span class='lexic'>===</span>&nbsp;<span class='symbol'>'arg'</span><span class='lexic'>)</span>&nbsp;&nbsp;&nbsp;<span class='lexic'>[[</span><span class='idfrom' onmouseenter='srcref_over("Z501289",this)' onmouseleave='srcref_leave("Z501289",this)'><span><span class='ident'>nm</span></span></span><span class='lexic'>;</span>&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>expr</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>arg</span><span class='hint'>lang0i:expr:arg(id)</span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z501289",this)' onmouseleave='srcref_leave("Z501289",this)'><span><span class='ident'>nm</span></span></span><span class='lexic'>)]]</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>else</span>&nbsp;<span class='withhint'><span class='ident'>ccerror</span><span class='hint'>function&nbsp;ccerror&nbsp;arg:&nbsp;<br>
Raises&nbsp;[MBaseException]&nbsp;with&nbsp;a&nbsp;given&nbsp;argument.</span></span><span class='lexic'>(</span><span class='symbol'>'WHAT?'</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z501297",this)' onmouseleave='srcref_leave("Z501297",this)'><span><span class='ident'>cl</span></span></span><span class='lexic'>))</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>}</span>&nbsp;<span class='keyword'>else</span>&nbsp;<span class='lexic'>&#8709;</span><span class='lexic'>}};</span><br>
&nbsp;&nbsp;&nbsp;<span class='comment'>//&nbsp;A&nbsp;main&nbsp;visitor,&nbsp;lifting&nbsp;all&nbsp;the&nbsp;lambda&nbsp;nodes&nbsp;into&nbsp;new<br>
</span>&nbsp;&nbsp;&nbsp;<span class='comment'>//&nbsp;toplevel&nbsp;definitions&nbsp;and&nbsp;replacing&nbsp;them&nbsp;with&nbsp;closure&nbsp;allocations,<br>
</span>&nbsp;&nbsp;&nbsp;<span class='comment'>//&nbsp;even&nbsp;if&nbsp;no&nbsp;closure&nbsp;environment&nbsp;is&nbsp;captured&nbsp;(we'll&nbsp;deal&nbsp;with&nbsp;this<br>
</span>&nbsp;&nbsp;&nbsp;<span class='comment'>//&nbsp;case&nbsp;later).&nbsp;Also&nbsp;using&nbsp;this&nbsp;opportunity&nbsp;to&nbsp;make&nbsp;closure&nbsp;variable<br>
</span>&nbsp;&nbsp;&nbsp;<span class='comment'>//&nbsp;references&nbsp;specific.<br>
</span>&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0i</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>expr</span><span class='lexic'>:</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z501316",this)' onmouseleave='srcref_leave("Z501316",this)'><span><span class='ident'>e</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>once</span>&nbsp;<span class='ident'>expr</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z501556'><span><span class='ident'>elambda</span></span></span>&nbsp;&#8594;&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z501565'><span><span class='ident'>intersect</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z501555",this)' onmouseleave='srcref_leave("Z501555",this)'><span><span class='ident'>getclenv</span></span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z501556",this)' onmouseleave='srcref_leave("Z501556",this)'><span><span class='ident'>benv</span></span></span><span class='hint'>elambda(args,benv,fenv,body)</span></span><span class='lexic'>,</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z501556",this)' onmouseleave='srcref_leave("Z501556",this)'><span><span class='ident'>fenv</span></span></span><span class='hint'>elambda(args,benv,fenv,body)</span></span><span class='lexic'>);</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z501584'><span><span class='ident'>clargs</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='keyword'>map</span>&nbsp;<span class='lexic'>[</span><span id='Z501577'><span><span class='ident'><span class='pattern'>nm</span></span></span></span><span class='lexic'>;</span><span class='ident'><span class='pattern'>cl</span></span><span class='lexic'>]</span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z501565",this)' onmouseleave='srcref_leave("Z501565",this)'><span><span class='ident'>intersect</span></span></span>&nbsp;<span class='keyword'>do</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z501577",this)' onmouseleave='srcref_leave("Z501577",this)'><span><span class='ident'>nm</span></span></span><span class='lexic'>;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z501602'><span><span class='ident'>newlambda</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>clambda</span><span class='hint'>lang0i:expr:clambda(clenv,args,body)</span></span><span class='lexic'>(</span><span class='ident'>clenv</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z501584",this)' onmouseleave='srcref_leave("Z501584",this)'><span><span class='ident'>clargs</span></span></span><span class='lexic'>,</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='ident'>args</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z501556",this)' onmouseleave='srcref_leave("Z501556",this)'><span><span class='ident'>args</span></span></span><span class='hint'>elambda(args,benv,fenv,body)</span></span><span class='lexic'>,</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='ident'>body</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z501587",this)' onmouseleave='srcref_leave("Z501587",this)'><span><span class='ident'>loop</span></span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z501556",this)' onmouseleave='srcref_leave("Z501556",this)'><span><span class='ident'>body</span></span></span><span class='hint'>elambda(args,benv,fenv,body)</span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z501584",this)' onmouseleave='srcref_leave("Z501584",this)'><span><span class='ident'>clargs</span></span></span>&nbsp;<span class='lexic'>&#8853;</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z501290",this)' onmouseleave='srcref_leave("Z501290",this)'><span><span class='ident'>renv</span></span></span><span class='lexic'>));</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z501601'><span><span class='ident'>newnm</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='withhint'><span class='ident'>gensym</span><span class='hint'>function&nbsp;gensym&nbsp;:&nbsp;<br>
Returns&nbsp;a&nbsp;unique&nbsp;symbol&nbsp;every&nbsp;time&nbsp;it&nbsp;is&nbsp;called.<br>
Uniqueness&nbsp;is&nbsp;guaranteed&nbsp;within&nbsp;one&nbsp;run&nbsp;only.</span></span><span class='lexic'>();</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z501596",this)' onmouseleave='srcref_leave("Z501596",this)'><span><span class='ident'>adddef</span></span></span><span class='lexic'>(</span><span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>top</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>define</span><span class='hint'>lang0i:top:define(id,e)</span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z501601",this)' onmouseleave='srcref_leave("Z501601",this)'><span><span class='ident'>newnm</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z501602",this)' onmouseleave='srcref_leave("Z501602",this)'><span><span class='ident'>newlambda</span></span></span><span class='lexic'>));</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>return</span>&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>mkclosure</span><span class='hint'>lang0i:expr:mkclosure(df,args)</span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z501601",this)' onmouseleave='srcref_leave("Z501601",this)'><span><span class='ident'>newnm</span></span></span><span class='lexic'>,</span>&nbsp;<span class='keyword'>map</span>&nbsp;<span class='lexic'>[</span><span class='ident'><span class='pattern'>nm</span></span><span class='lexic'>;</span><span id='Z501626'><span><span class='ident'><span class='pattern'>cl</span></span></span></span><span class='lexic'>]</span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z501565",this)' onmouseleave='srcref_leave("Z501565",this)'><span><span class='ident'>intersect</span></span></span>&nbsp;<span class='keyword'>do</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z501626",this)' onmouseleave='srcref_leave("Z501626",this)'><span><span class='ident'>cl</span></span></span><span class='lexic'>)}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span id='Z501638'><span><span class='ident'>local</span></span></span>&nbsp;&#8594;&nbsp;<span class='keyword'>if</span><span class='lexic'>(</span><span class='ident'>memq</span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z501638",this)' onmouseleave='srcref_leave("Z501638",this)'><span><span class='ident'>id</span></span></span><span class='hint'>local(id)</span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z501290",this)' onmouseleave='srcref_leave("Z501290",this)'><span><span class='ident'>renv</span></span></span><span class='lexic'>))</span>&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>clvar</span><span class='hint'>lang0i:expr:clvar(id)</span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z501638",this)' onmouseleave='srcref_leave("Z501638",this)'><span><span class='ident'>id</span></span></span><span class='hint'>local(id)</span></span><span class='lexic'>)</span>&nbsp;<span class='keyword'>else</span>&nbsp;<span class='ident'>node</span><span class='lexic'>()</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span id='Z501654'><span><span class='ident'>arg</span></span></span>&nbsp;&nbsp;&nbsp;&#8594;&nbsp;<span class='keyword'>if</span><span class='lexic'>(</span><span class='ident'>memq</span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z501654",this)' onmouseleave='srcref_leave("Z501654",this)'><span><span class='ident'>id</span></span></span><span class='hint'>arg(id)</span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z501290",this)' onmouseleave='srcref_leave("Z501290",this)'><span><span class='ident'>renv</span></span></span><span class='lexic'>))</span>&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>clvar</span><span class='hint'>lang0i:expr:clvar(id)</span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z501654",this)' onmouseleave='srcref_leave("Z501654",this)'><span><span class='ident'>id</span></span></span><span class='hint'>arg(id)</span></span><span class='lexic'>)</span>&nbsp;<span class='keyword'>else</span>&nbsp;<span class='ident'>node</span><span class='lexic'>()</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='keyword'>deep</span>&nbsp;&#8594;&nbsp;<span class='lexic'>{</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='ident'>node</span><span class='lexic'>()</span>&nbsp;<span class='lexic'>}}}}</span>
<p></div>


<p>Obviously we do not need to lift lambda expressions that are already on top,
so we have to make an exception for this case.


<p><div class='code'>
<span id='Z501805'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_lambda_lift_top</span><span class='lexic'>(</span><span id='Z502158'><span><span class='ident'>t</span></span></span><span class='lexic'>,</span>&nbsp;<span id='Z502152'><span><span class='ident'>adddef</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;<span id='Z502409'><span><span class='ident'>liftexpr</span></span></span><span class='lexic'>(</span><span id='Z502151'><span><span class='ident'>e</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>=</span>&nbsp;<a href='#Z500861'><span class='ident'>l0_lambda_lift_expr</span></a><span class='lexic'>(</span><a href='#Z499594'><span class='ident'>l0_lambda_lift_freevars</span></a><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z502151",this)' onmouseleave='srcref_leave("Z502151",this)'><span><span class='ident'>e</span></span></span><span class='lexic'>),</span>&nbsp;<span class='lexic'>&#8709;</span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z502152",this)' onmouseleave='srcref_leave("Z502152",this)'><span><span class='ident'>adddef</span></span></span><span class='lexic'>);</span><br>
&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0i</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>top</span><span class='lexic'>:</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z502158",this)' onmouseleave='srcref_leave("Z502158",this)'><span><span class='ident'>t</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>once</span>&nbsp;<span class='ident'>expr</span>&nbsp;<span class='lexic'>{</span>&nbsp;<span id='Z502454'><span><span class='ident'>elambda</span></span></span>&nbsp;&#8594;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>clambda</span><span class='hint'>lang0i:expr:clambda(clenv,args,body)</span></span><span class='lexic'>(</span><span class='ident'>clenv</span><span class='lexic'>=</span><span class='lexic'>&#8709;</span><span class='lexic'>,</span>&nbsp;<span class='ident'>args</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z502454",this)' onmouseleave='srcref_leave("Z502454",this)'><span><span class='ident'>args</span></span></span><span class='hint'>elambda(args,benv,fenv,body)</span></span><span class='lexic'>,</span>&nbsp;<span class='ident'>body</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z502409",this)' onmouseleave='srcref_leave("Z502409",this)'><span><span class='ident'>liftexpr</span></span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z502454",this)' onmouseleave='srcref_leave("Z502454",this)'><span><span class='ident'>body</span></span></span><span class='hint'>elambda(args,benv,fenv,body)</span></span><span class='lexic'>))</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z502409",this)' onmouseleave='srcref_leave("Z502409",this)'><span><span class='ident'>liftexpr</span></span></span><span class='lexic'>(</span><span class='ident'>node</span><span class='lexic'>())</span>&nbsp;<span class='lexic'>}}}</span>
<p></div>


<p>Lambda--lifting a single top level statement may produce any number of new top level statements, so
we'll just collect all the new statements together into one flat list.


<p><div class='code'>
<span id='Z502564'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_lambda_lift</span><span class='lexic'>(</span><span id='Z502581'><span><span class='ident'>ts</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;<span class='keyword'>collector</span><span class='lexic'>(</span><span id='Z502583'><span><span class='ident'>adddef</span></span></span><span class='lexic'>,</span>&nbsp;<span id='Z502585'><span><span class='ident'>getdefs</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>iter</span>&nbsp;<span id='Z502584'><span><span class='ident'>t</span></span></span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z502581",this)' onmouseleave='srcref_leave("Z502581",this)'><span><span class='ident'>ts</span></span></span>&nbsp;<span class='keyword'>do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z502583",this)' onmouseleave='srcref_leave("Z502583",this)'><span><span class='ident'>adddef</span></span></span><span class='lexic'>(</span><a href='#Z501805'><span class='ident'>l0_lambda_lift_top</span></a><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z502584",this)' onmouseleave='srcref_leave("Z502584",this)'><span><span class='ident'>t</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z502583",this)' onmouseleave='srcref_leave("Z502583",this)'><span><span class='ident'>adddef</span></span></span><span class='lexic'>));</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>return</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z502585",this)' onmouseleave='srcref_leave("Z502585",this)'><span><span class='ident'>getdefs</span></span></span><span class='lexic'>()}}</span>
<p></div>


<p>And now, all the lexical scope and lambda lifting passes together:


<p><div class='code'>
<span id='Z502593'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_lexical</span><span class='lexic'>(</span><span id='Z502595'><span><span class='ident'>ts</span></span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;<a href='#Z502564'><span class='ident'>l0_lambda_lift</span></a><span class='lexic'>(</span><br>
&nbsp;&nbsp;&nbsp;<a href='#Z499573'><span class='ident'>l0_classify_vars</span></a><span class='lexic'>(</span><br>
&nbsp;&nbsp;&nbsp;<a href='#Z497228'><span class='ident'>l0_lexical_scope</span></a><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z502595",this)' onmouseleave='srcref_leave("Z502595",this)'><span><span class='ident'>ts</span></span></span><span class='lexic'>)))</span>
<p></div>



<h2>Preparing for a code generation</h2>

<p>By now we moved all the lambdas into top level definitions, made closure environments explicit, eliminated lexical
scope and reduced some syntax sugar.

<p>Let's refine our AST further. We can classify top level statements as functions (i.e., lambdas with an empty
closure environment), closures, constants, evaluated definitions and, finally, toplevel expressions.

<p>We also eliminated the temporary <b>elambda</b> variant previously, and are going to get rid of
nested <b>let</b> bindings and replace them with flat imperative assignments. Same AST is
introducing a special tail call variant.

<p>Another variant introduced here is <b>splitexpr</b>, it is required for separating expressions and statements
further down the pipeline.


<p><div class='code'>
<span class='keyword'>ast</span>&nbsp;<span class='ident'>lang0j</span>&nbsp;<span class='lexic'>:</span>&nbsp;<span class='ident'>lang0i</span>&nbsp;<span class='lexic'>()</span>&nbsp;<span class='keyword'>recform</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;<span class='ident'>top</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='ident'>define</span><span class='lexic'>(</span><span class='ident'>ident</span><span class='lexic'>:</span><span class='ident'>id</span><span class='lexic'>,</span>&nbsp;<span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>e</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>defconst</span><span class='lexic'>(</span><span class='ident'>ident</span><span class='lexic'>:</span><span class='ident'>id</span><span class='lexic'>,</span>&nbsp;<span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>e</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>sfunction</span><span class='lexic'>(</span><span class='ident'>ident</span><span class='lexic'>:</span><span class='ident'>id</span><span class='lexic'>,</span>&nbsp;<span class='lexic'>*</span><span class='ident'>ident</span><span class='lexic'>:</span><span class='ident'>args</span><span class='lexic'>,</span>&nbsp;<span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>body</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>closure</span><span class='lexic'>(</span><span class='ident'>ident</span><span class='lexic'>:</span><span class='ident'>id</span><span class='lexic'>,</span>&nbsp;<span class='lexic'>*</span><span class='ident'>ident</span><span class='lexic'>:</span><span class='ident'>clargs</span><span class='lexic'>,</span>&nbsp;<span class='lexic'>*</span><span class='ident'>ident</span><span class='lexic'>:</span><span class='ident'>args</span><span class='lexic'>,</span>&nbsp;<span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>body</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>expr</span><span class='lexic'>(</span><span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>e</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>debug</span><span class='lexic'>(.*</span><span class='ident'>any</span><span class='lexic'>:</span><span class='ident'>es</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>;</span><br>
&nbsp;&nbsp;<span class='ident'>expr</span>&nbsp;<span class='lexic'>+=</span>&nbsp;<span class='lexic'>-</span><span class='ident'>elambda</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;&nbsp;<span class='lexic'>-</span><span class='ident'>clambda</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;&nbsp;<span class='ident'>alloca</span><span class='lexic'>(</span><span class='ident'>ident</span><span class='lexic'>:</span><span class='ident'>id</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;&nbsp;<span class='ident'>set</span><span class='lexic'>(</span><span class='ident'>ident</span><span class='lexic'>:</span><span class='ident'>id</span><span class='lexic'>,</span>&nbsp;<span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>v</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;&nbsp;<span class='ident'>drop</span><span class='lexic'>(</span><span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>v</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;&nbsp;<span class='ident'>funref</span><span class='lexic'>(</span><span class='ident'>ident</span><span class='lexic'>:</span><span class='ident'>id</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;&nbsp;<span class='ident'>tailapply</span><span class='lexic'>(</span><span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>fn</span><span class='lexic'>,</span>&nbsp;<span class='lexic'>.*</span><span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>args</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;&nbsp;<span class='ident'>return</span><span class='lexic'>(</span><span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>v</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;&nbsp;<span class='ident'>splitexpr</span><span class='lexic'>(</span><span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>l</span><span class='lexic'>,</span>&nbsp;<span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>r</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>;}</span>
<p></div>


<h3>Removing toplevel lambdas</h3>


<p><div class='code'>
<span id='Z502599'><span class='lexic'>%</span></span><span class='const'>&quot;lang0i:*top&nbsp;-&gt;&nbsp;lang0j:*top&quot;</span><br>
<span class='keyword'>function</span>&nbsp;<span class='ident'>l0_classify_functions</span><span class='lexic'>(</span><span id='Z503012'><span><span class='ident'>ts</span></span></span><span class='lexic'>)</span><br>
&nbsp;<span class='keyword'>map</span>&nbsp;<span id='Z503020'><span><span class='ident'>t</span></span></span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z503012",this)' onmouseleave='srcref_leave("Z503012",this)'><span><span class='ident'>ts</span></span></span>&nbsp;<span class='keyword'>do</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0i</span>&nbsp;<span class='lexic'>/rec,</span>&nbsp;<span class='lexic'>dst</span>&nbsp;<span class='ident'>lang0j</span><span class='lexic'>/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>top</span><span class='lexic'>:</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z503020",this)' onmouseleave='srcref_leave("Z503020",this)'><span><span class='ident'>t</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>top</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z503265'><span><span class='ident'>define</span></span></span>&nbsp;&#8594;&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z503265",this)' onmouseleave='srcref_leave("Z503265",this)'><span><span class='ident'>e</span></span></span><span class='hint'>define(id,e)</span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z503265",this)' onmouseleave='srcref_leave("Z503265",this)'><span><span class='ident'>id</span></span></span><span class='hint'>define(id,e)</span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span id='Z503273'><span><span class='ident'>expr</span></span></span>&nbsp;&#8594;&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z503273",this)' onmouseleave='srcref_leave("Z503273",this)'><span><span class='ident'>e</span></span></span><span class='hint'>expr(e)</span></span><span class='lexic'>(</span><span class='lexic'>&#8709;</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>debug</span>&nbsp;&#8594;&nbsp;<span class='ident'>node</span><span class='lexic'>()</span><span class='lexic'>};</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>once</span>&nbsp;<span class='ident'>expr</span><span class='lexic'>(</span><span id='Z503280'><span><span class='ident'>dst</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z503398'><span><span class='ident'>clambda</span></span></span>&nbsp;&#8594;&nbsp;<span class='keyword'>if</span>&nbsp;<span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z503398",this)' onmouseleave='srcref_leave("Z503398",this)'><span><span class='ident'>clenv</span></span></span><span class='hint'>clambda(clenv,args,body)</span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>top</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>closure</span><span class='hint'>lang0j:top:closure(id,clargs,args,body)</span></span><span class='lexic'>(</span><span class='ident'>id</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z503280",this)' onmouseleave='srcref_leave("Z503280",this)'><span><span class='ident'>dst</span></span></span><span class='lexic'>,</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='ident'>clargs</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z503398",this)' onmouseleave='srcref_leave("Z503398",this)'><span><span class='ident'>clenv</span></span></span><span class='hint'>clambda(clenv,args,body)</span></span><span class='lexic'>,</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='ident'>args</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z503398",this)' onmouseleave='srcref_leave("Z503398",this)'><span><span class='ident'>args</span></span></span><span class='hint'>clambda(clenv,args,body)</span></span><span class='lexic'>,</span>&nbsp;<span class='ident'>body</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z503398",this)' onmouseleave='srcref_leave("Z503398",this)'><span><span class='ident'>body</span></span></span><span class='hint'>clambda(clenv,args,body)</span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>else</span>&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>top</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>sfunction</span><span class='hint'>lang0j:top:sfunction(id,args,body)</span></span><span class='lexic'>(</span><span class='ident'>id</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z503280",this)' onmouseleave='srcref_leave("Z503280",this)'><span><span class='ident'>dst</span></span></span><span class='lexic'>,</span>&nbsp;<span class='ident'>args</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z503398",this)' onmouseleave='srcref_leave("Z503398",this)'><span><span class='ident'>args</span></span></span><span class='hint'>clambda(clenv,args,body)</span></span><span class='lexic'>,</span>&nbsp;<span class='ident'>body</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z503398",this)' onmouseleave='srcref_leave("Z503398",this)'><span><span class='ident'>body</span></span></span><span class='hint'>clambda(clenv,args,body)</span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;&nbsp;<span class='ident'>const</span>&nbsp;&#8594;&nbsp;<span class='keyword'>if</span>&nbsp;<span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z503280",this)' onmouseleave='srcref_leave("Z503280",this)'><span><span class='ident'>dst</span></span></span><span class='lexic'>)</span>&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>top</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>defconst</span><span class='hint'>lang0j:top:defconst(id,e)</span></span><span class='lexic'>(</span><span class='ident'>id</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z503280",this)' onmouseleave='srcref_leave("Z503280",this)'><span><span class='ident'>dst</span></span></span><span class='lexic'>,</span>&nbsp;<span class='ident'>e</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='ident'>node</span><span class='lexic'>())</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>else</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>top</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>expr</span><span class='hint'>lang0j:top:expr(e)</span></span><span class='lexic'>(</span><span class='ident'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>const</span><span class='hint'>lang0j:expr:const(c)</span></span><span class='lexic'>(</span><span class='ident'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>nil</span><span class='hint'>lang0j:const:nil()</span></span><span class='lexic'>()))</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;&nbsp;<span class='keyword'>else</span>&nbsp;&nbsp;&#8594;&nbsp;<span class='keyword'>if</span>&nbsp;<span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z503280",this)' onmouseleave='srcref_leave("Z503280",this)'><span><span class='ident'>dst</span></span></span><span class='lexic'>)</span>&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>top</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>define</span><span class='hint'>lang0j:top:define(id,e)</span></span><span class='lexic'>(</span><span class='ident'>id</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z503280",this)' onmouseleave='srcref_leave("Z503280",this)'><span><span class='ident'>dst</span></span></span><span class='lexic'>,</span>&nbsp;<span class='ident'>e</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='ident'>node</span><span class='lexic'>())</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>else</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>top</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>expr</span><span class='hint'>lang0j:top:expr(e)</span></span><span class='lexic'>(</span><span class='ident'>node</span><span class='lexic'>())</span><span class='lexic'>}}</span>
<p></div>



<p><div class='code'>
<span id='Z503518'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_classify_calls</span><span class='lexic'>(</span><span id='Z503988'><span><span class='ident'>ts</span></span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;<span class='keyword'>map</span>&nbsp;<span id='Z503996'><span><span class='ident'>t</span></span></span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z503988",this)' onmouseleave='srcref_leave("Z503988",this)'><span><span class='ident'>ts</span></span></span>&nbsp;<span class='keyword'>do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0j</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>top</span><span class='lexic'>:</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z503996",this)' onmouseleave='srcref_leave("Z503996",this)'><span><span class='ident'>t</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>expr</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z504407'><span><span class='ident'>mkclosure</span></span></span>&nbsp;&#8594;&nbsp;<span class='keyword'>if</span>&nbsp;<span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z504407",this)' onmouseleave='srcref_leave("Z504407",this)'><span><span class='ident'>args</span></span></span><span class='hint'>mkclosure(df,args)</span></span><span class='lexic'>)</span>&nbsp;<span class='ident'>node</span><span class='lexic'>()</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>else</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>funref</span><span class='hint'>lang0j:expr:funref(id)</span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z504407",this)' onmouseleave='srcref_leave("Z504407",this)'><span><span class='ident'>df</span></span></span><span class='hint'>mkclosure(df,args)</span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='ident'>node</span><span class='lexic'>()</span><span class='lexic'>}}</span>
<p></div>


<h3>Flattening bindings</h3>

<p>Instead of our nice and clean functional variable binding we'll produce an imperative sequence of
destructive assignments here. Some other passes will also introduce true destructive assignments, e.g.,
lifting the statement expressions and optimising direct tail recursion, so we're not losing any purity here.
A consequent SSA transform will make our IR clean again.


<p><div class='code'>
<span id='Z504543'><span class='lexic'>%</span></span><span class='const'>&quot;lang0j:expr&nbsp;-&gt;&nbsp;lang0j:expr&quot;</span><br>
<span class='keyword'>function</span>&nbsp;<span class='ident'>l0_flatten_lets_topexpr</span><span class='lexic'>(</span><span id='Z504928'><span><span class='ident'>e</span></span></span><span class='lexic'>)</span><br>
<span class='keyword'>collector</span><span class='lexic'>(</span><span id='Z505261'><span><span class='ident'>addalloca</span></span></span><span class='lexic'>,</span>&nbsp;<span id='Z505294'><span><span class='ident'>getallocas</span></span></span><span class='lexic'>)</span><br>
<span class='keyword'>with</span>&nbsp;<span class='keyword'>target</span>&nbsp;<span class='lexic'>(</span><span class='ident'>lang0j</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;<span id='Z505295'><span><span class='ident'>ret</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0j</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>expr</span><span class='lexic'>:</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z504928",this)' onmouseleave='srcref_leave("Z504928",this)'><span><span class='ident'>e</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>expr</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z505197'><span><span class='ident'>let</span></span></span>&nbsp;&#8594;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>seq</span><span class='hint'>lang0j:expr:seq(body)</span></span><span class='lexic'>(</span><span class='ident'>body</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z505197",this)' onmouseleave='srcref_leave("Z505197",this)'><span><span class='ident'>ps</span></span></span><span class='hint'>let(ps,body)</span></span><span class='lexic'>&#8853;</span><span class='lexic'>[</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z505197",this)' onmouseleave='srcref_leave("Z505197",this)'><span><span class='ident'>body</span></span></span><span class='hint'>let(ps,body)</span></span><span class='lexic'>])</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='ident'>node</span><span class='lexic'>()};</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>letpair</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z505265'><span><span class='ident'>p</span></span></span>&nbsp;&#8594;&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z505261",this)' onmouseleave='srcref_leave("Z505261",this)'><span><span class='ident'>addalloca</span></span></span><span class='lexic'>(</span><span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>expr</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>alloca</span><span class='hint'>lang0j:expr:alloca(id)</span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z505265",this)' onmouseleave='srcref_leave("Z505265",this)'><span><span class='ident'>id</span></span></span><span class='hint'>p(id,v)</span></span><span class='lexic'>));</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>expr</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>set</span><span class='hint'>lang0j:expr:set(id,v)</span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z505265",this)' onmouseleave='srcref_leave("Z505265",this)'><span><span class='ident'>id</span></span></span><span class='hint'>p(id,v)</span></span><span class='lexic'>,</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z505265",this)' onmouseleave='srcref_leave("Z505265",this)'><span><span class='ident'>v</span></span></span><span class='hint'>p(id,v)</span></span><span class='lexic'>)}}};</span><br>
&nbsp;&nbsp;&nbsp;<span class='keyword'>return</span>&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>expr</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>seq</span><span class='hint'>lang0j:expr:seq(body)</span></span><span class='lexic'>(</span><span class='ident'>body</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z505294",this)' onmouseleave='srcref_leave("Z505294",this)'><span><span class='ident'>getallocas</span></span></span><span class='lexic'>()</span>&nbsp;<span class='lexic'>&#8853;</span>&nbsp;<span class='lexic'>[</span><span class='idfrom' onmouseenter='srcref_over("Z505295",this)' onmouseleave='srcref_leave("Z505295",this)'><span><span class='ident'>ret</span></span></span><span class='lexic'>])}</span>
<p></div>



<p><div class='code'>
<span id='Z505366'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_flatten_lets</span><span class='lexic'>(</span><span id='Z505827'><span><span class='ident'>ts</span></span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;<span class='keyword'>map</span>&nbsp;<span id='Z505835'><span><span class='ident'>t</span></span></span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z505827",this)' onmouseleave='srcref_leave("Z505827",this)'><span><span class='ident'>ts</span></span></span>&nbsp;<span class='keyword'>do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0j</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>top</span><span class='lexic'>:</span><span class='idfrom' onmouseenter='srcref_over("Z505835",this)' onmouseleave='srcref_leave("Z505835",this)'><span><span class='ident'>t</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>once</span>&nbsp;<span class='ident'>expr</span>&nbsp;<span class='lexic'>{</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<a href='#Z504543'><span class='ident'>l0_flatten_lets_topexpr</span></a><span class='lexic'>(</span><span class='ident'>node</span><span class='lexic'>())</span>&nbsp;<span class='lexic'>}}</span>
<p></div>



<h3>Redundant nested seq</h3>

<p>There is no reason for doing this besides pure aesthetics. If you want to dump IR somewhere in the middle,
deeply nested <b>seq</b> may be quite annoying.


<p><div class='code'>
<span id='Z506367'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_seq_tidy_topexpr</span><span class='lexic'>(</span><span id='Z507794'><span><span class='ident'>e</span></span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;<span class='keyword'>do</span>&nbsp;<span id='Z507325'><span><span class='ident'>loop</span></span></span><span class='lexic'>(</span><span id='Z507793'><span><span class='ident'>e</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z507794",this)' onmouseleave='srcref_leave("Z507794",this)'><span><span class='ident'>e</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z507705'><span><span class='ident'>nested</span></span></span><span class='lexic'>(</span><span id='Z507423'><span><span class='ident'>e</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>=</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>do</span>&nbsp;<span id='Z507343'><span><span class='ident'>nestedloop</span></span></span><span class='lexic'>(</span><span id='Z507080'><span><span class='ident'>e</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z507423",this)' onmouseleave='srcref_leave("Z507423",this)'><span><span class='ident'>e</span></span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0j</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>expr</span><span class='lexic'>:</span><span class='idfrom' onmouseenter='srcref_over("Z507080",this)' onmouseleave='srcref_leave("Z507080",this)'><span><span class='ident'>e</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>once</span>&nbsp;<span class='ident'>expr</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z507338'><span><span class='ident'>seq</span></span></span>&nbsp;&#8594;&nbsp;<span class='keyword'>map</span>&nbsp;<span class='keyword'>append</span>&nbsp;<span id='Z507344'><span><span class='ident'>b</span></span></span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z507338",this)' onmouseleave='srcref_leave("Z507338",this)'><span><span class='ident'>body</span></span></span><span class='hint'>seq(body)</span></span>&nbsp;<span class='keyword'>do</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z507343",this)' onmouseleave='srcref_leave("Z507343",this)'><span><span class='ident'>nestedloop</span></span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z507344",this)' onmouseleave='srcref_leave("Z507344",this)'><span><span class='ident'>b</span></span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='lexic'>[</span><span class='idfrom' onmouseenter='srcref_over("Z507325",this)' onmouseleave='srcref_leave("Z507325",this)'><span><span class='ident'>loop</span></span></span><span class='lexic'>(</span><span class='ident'>node</span><span class='lexic'>())]}};</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z507792'><span><span class='ident'>entry</span></span></span><span class='lexic'>(</span><span id='Z507432'><span><span class='ident'>e</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>=</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0j</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>expr</span><span class='lexic'>:</span><span class='idfrom' onmouseenter='srcref_over("Z507432",this)' onmouseleave='srcref_leave("Z507432",this)'><span><span class='ident'>e</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>once</span>&nbsp;<span class='ident'>expr</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z507700'><span><span class='ident'>seq</span></span></span>&nbsp;&#8594;&nbsp;<span class='lexic'>{</span><span class='keyword'>match</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z507700",this)' onmouseleave='srcref_leave("Z507700",this)'><span><span class='ident'>body</span></span></span><span class='hint'>seq(body)</span></span>&nbsp;<span class='keyword'>with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'><span class='pattern'>[</span></span><span id='Z507686'><span><span class='ident'><span class='pattern'>one</span></span></span></span><span class='lexic'><span class='pattern'>]</span></span>&nbsp;&#8594;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z507325",this)' onmouseleave='srcref_leave("Z507325",this)'><span><span class='ident'>loop</span></span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z507686",this)' onmouseleave='srcref_leave("Z507686",this)'><span><span class='ident'>one</span></span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'><span class='pattern'>else</span></span>&nbsp;&#8594;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='keyword'>node</span><span class='hint'>lang0j:expr:seq(body)</span></span><span class='lexic'>(</span><span class='ident'>body</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='keyword'>map</span>&nbsp;<span class='keyword'>append</span>&nbsp;<span id='Z507706'><span><span class='ident'>b</span></span></span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z507700",this)' onmouseleave='srcref_leave("Z507700",this)'><span><span class='ident'>body</span></span></span><span class='hint'>seq(body)</span></span>&nbsp;<span class='keyword'>do</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z507705",this)' onmouseleave='srcref_leave("Z507705",this)'><span><span class='ident'>nested</span></span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z507706",this)' onmouseleave='srcref_leave("Z507706",this)'><span><span class='ident'>b</span></span></span><span class='lexic'>))}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;&#8594;&nbsp;<span class='lexic'>{</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='ident'>node</span><span class='lexic'>()</span>&nbsp;<span class='lexic'>}}};</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z507792",this)' onmouseleave='srcref_leave("Z507792",this)'><span><span class='ident'>entry</span></span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z507793",this)' onmouseleave='srcref_leave("Z507793",this)'><span><span class='ident'>e</span></span></span><span class='lexic'>)}</span>
<p></div>



<p><div class='code'>
<span id='Z507949'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_seq_tidy</span><span class='lexic'>(</span><span id='Z508410'><span><span class='ident'>ts</span></span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;<span class='keyword'>map</span>&nbsp;<span id='Z508418'><span><span class='ident'>t</span></span></span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z508410",this)' onmouseleave='srcref_leave("Z508410",this)'><span><span class='ident'>ts</span></span></span>&nbsp;<span class='keyword'>do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0j</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>top</span><span class='lexic'>:</span><span class='idfrom' onmouseenter='srcref_over("Z508418",this)' onmouseleave='srcref_leave("Z508418",this)'><span><span class='ident'>t</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>once</span>&nbsp;<span class='ident'>expr</span>&nbsp;<span class='lexic'>{</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<a href='#Z506367'><span class='ident'>l0_seq_tidy_topexpr</span></a><span class='lexic'>(</span><span class='ident'>node</span><span class='lexic'>())</span>&nbsp;<span class='lexic'>}}</span>
<p></div>


<h3 id="tails">Marking tail calls</h3>

<p>At this stage, IR is suitable for the tail call analysis, which could have been more difficult previously and
will be more clumsy later. Results of this marking will be used further down in a direct tail recursion
optimisation and are required for the statement vs. expression split, since we're also introducing explicit
<b>return</b> statements here.


<p><div class='code'>
<span id='Z508950'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>tsplit</span><span class='lexic'>(</span><span id='Z508979'><span><span class='ident'>l0</span></span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;<span class='keyword'>do</span>&nbsp;<span id='Z508975'><span><span class='ident'>iloop</span></span></span><span class='lexic'>(</span><span id='Z508978'><span><span class='ident'>l</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z508979",this)' onmouseleave='srcref_leave("Z508979",this)'><span><span class='ident'>l0</span></span></span><span class='lexic'>,</span>&nbsp;<span id='Z508969'><span><span class='ident'>acc</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='lexic'>&#8709;</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>match</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z508978",this)' onmouseleave='srcref_leave("Z508978",this)'><span><span class='ident'>l</span></span></span>&nbsp;<span class='keyword'>with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'><span class='pattern'>[</span></span><span id='Z508970'><span><span class='ident'><span class='pattern'>hd</span></span></span></span><span class='lexic'><span class='pattern'>]</span></span>&nbsp;&#8594;&nbsp;<span class='lexic'>[</span><span class='idfrom' onmouseenter='srcref_over("Z508969",this)' onmouseleave='srcref_leave("Z508969",this)'><span><span class='ident'>acc</span></span></span><span class='lexic'>;</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z508970",this)' onmouseleave='srcref_leave("Z508970",this)'><span><span class='ident'>hd</span></span></span><span class='lexic'>]</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='lexic'><span class='pattern'>&#8709;</span></span>&nbsp;&#8594;&nbsp;<span class='lexic'>[</span><span class='lexic'>&#8709;</span><span class='lexic'>;</span><span class='lexic'>&#8709;</span><span class='lexic'>]</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span id='Z508977'><span><span class='ident'><span class='pattern'>hd</span></span></span></span><span class='lexic'><span class='pattern'>:</span></span><span id='Z508976'><span><span class='ident'><span class='pattern'>tl</span></span></span></span>&nbsp;&#8594;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z508975",this)' onmouseleave='srcref_leave("Z508975",this)'><span><span class='ident'>iloop</span></span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z508976",this)' onmouseleave='srcref_leave("Z508976",this)'><span><span class='ident'>tl</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z508969",this)' onmouseleave='srcref_leave("Z508969",this)'><span><span class='ident'>acc</span></span></span>&nbsp;<span class='lexic'>&#8853;</span>&nbsp;<span class='lexic'>[</span><span class='idfrom' onmouseenter='srcref_over("Z508977",this)' onmouseleave='srcref_leave("Z508977",this)'><span><span class='ident'>hd</span></span></span><span class='lexic'>])</span>
<p></div>



<p><div class='code'>
<span id='Z508998'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_tailcalls_topexpr</span><span class='lexic'>(</span><span id='Z509768'><span><span class='ident'>e0</span></span></span><span class='lexic'>)</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;<span class='keyword'>do</span>&nbsp;<span id='Z509654'><span><span class='ident'>loop</span></span></span><span class='lexic'>(</span><span id='Z509382'><span><span class='ident'>e</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z509768",this)' onmouseleave='srcref_leave("Z509768",this)'><span><span class='ident'>e0</span></span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0j</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>expr</span><span class='lexic'>:</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z509382",this)' onmouseleave='srcref_leave("Z509382",this)'><span><span class='ident'>e</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>once</span>&nbsp;<span class='ident'>expr</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z509638'><span><span class='ident'>seq</span></span></span>&nbsp;&#8594;&nbsp;<span class='keyword'>if</span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z509638",this)' onmouseleave='srcref_leave("Z509638",this)'><span><span class='ident'>body</span></span></span><span class='hint'>seq(body)</span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>&lt;</span><span class='lexic'><span class='pattern'>[</span></span><span id='Z509653'><span><span class='ident'><span class='pattern'>a</span></span></span></span><span class='lexic'><span class='pattern'>;</span></span><span id='Z509655'><span><span class='ident'><span class='pattern'>b</span></span></span></span><span class='lexic'><span class='pattern'>]</span></span><span class='lexic'>&gt;</span>&nbsp;<span class='lexic'>=</span>&nbsp;<a href='#Z508950'><span class='ident'>tsplit</span></a><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z509638",this)' onmouseleave='srcref_leave("Z509638",this)'><span><span class='ident'>body</span></span></span><span class='hint'>seq(body)</span></span><span class='lexic'>);</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='keyword'>node</span><span class='hint'>lang0j:expr:seq(body)</span></span><span class='lexic'>(</span><span class='ident'>body</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z509653",this)' onmouseleave='srcref_leave("Z509653",this)'><span><span class='ident'>a</span></span></span>&nbsp;<span class='lexic'>&#8853;</span>&nbsp;<span class='lexic'>[</span><span class='idfrom' onmouseenter='srcref_over("Z509654",this)' onmouseleave='srcref_leave("Z509654",this)'><span><span class='ident'>loop</span></span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z509655",this)' onmouseleave='srcref_leave("Z509655",this)'><span><span class='ident'>b</span></span></span><span class='lexic'>)])}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>else</span>&nbsp;<span class='ident'>node</span><span class='lexic'>()</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;&nbsp;<span id='Z509699'><span><span class='ident'>if3</span></span></span>&nbsp;&#8594;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='keyword'>node</span><span class='hint'>lang0j:expr:if3(cnd,tr,fl)<br>
&nbsp;&nbsp;&nbsp;with&nbsp;implicit&nbsp;arguments:&nbsp;cnd<br>
</span></span><span class='lexic'>(</span><span class='ident'>tr</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z509654",this)' onmouseleave='srcref_leave("Z509654",this)'><span><span class='ident'>loop</span></span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z509699",this)' onmouseleave='srcref_leave("Z509699",this)'><span><span class='ident'>tr</span></span></span><span class='hint'>if3(cnd,tr,fl)</span></span><span class='lexic'>),</span>&nbsp;<span class='ident'>fl</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z509654",this)' onmouseleave='srcref_leave("Z509654",this)'><span><span class='ident'>loop</span></span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z509699",this)' onmouseleave='srcref_leave("Z509699",this)'><span><span class='ident'>fl</span></span></span><span class='hint'>if3(cnd,tr,fl)</span></span><span class='lexic'>))</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;&nbsp;<span id='Z509676'><span><span class='ident'>apply</span></span></span>&nbsp;&#8594;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>tailapply</span><span class='hint'>lang0j:expr:tailapply(fn,args)</span></span><span class='lexic'>(</span><span class='ident'>fn</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z509676",this)' onmouseleave='srcref_leave("Z509676",this)'><span><span class='ident'>fn</span></span></span><span class='hint'>apply(fn,args)</span></span><span class='lexic'>,</span>&nbsp;<span class='ident'>args</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z509676",this)' onmouseleave='srcref_leave("Z509676",this)'><span><span class='ident'>args</span></span></span><span class='hint'>apply(fn,args)</span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>return</span><span class='hint'>lang0j:expr:return(v)</span></span><span class='lexic'>(</span><span class='ident'>node</span><span class='lexic'>())</span><span class='lexic'>}}</span>
<p></div>



<p><div class='code'>
<span id='Z509847'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_tailcalls</span><span class='lexic'>(</span><span id='Z510308'><span><span class='ident'>ts</span></span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;<span class='keyword'>map</span>&nbsp;<span id='Z510316'><span><span class='ident'>t</span></span></span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z510308",this)' onmouseleave='srcref_leave("Z510308",this)'><span><span class='ident'>ts</span></span></span>&nbsp;<span class='keyword'>do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0j</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>top</span><span class='lexic'>:</span><span class='idfrom' onmouseenter='srcref_over("Z510316",this)' onmouseleave='srcref_leave("Z510316",this)'><span><span class='ident'>t</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>once</span>&nbsp;<span class='ident'>expr</span>&nbsp;<span class='lexic'>{</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<a href='#Z508998'><span class='ident'>l0_tailcalls_topexpr</span></a><span class='lexic'>(</span><span class='ident'>node</span><span class='lexic'>())</span>&nbsp;<span class='lexic'>}}</span>
<p></div>


<h3>Statement expressions</h3>

<p>A procedure very similar to tail call marking, but for the statement expressions (like <b>if</b> and <b>seq</b>
yielding value that is used inside another expression). We'll need it later on when we actually
split statements and expressions.

<p>The following function, just like a tail call marker pass before, will follow the returning branches of
expressions only --- i.e., last entry in a sequence and both arms of an <b>if</b>, but instead of inserting a
<b>return</b> or a tail call marker it will assign that value to a variable or wrap it into a <b>drop</b> marker,
meaning that the result is going to be discarded anyway.


<p><div class='code'>
<span id='Z510848'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_stmtexpr_inner</span><span class='lexic'>(</span><span id='Z511615'><span><span class='ident'>e0</span></span></span><span class='lexic'>,</span>&nbsp;<span id='Z511478'><span><span class='ident'>dst</span></span></span><span class='lexic'>)</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;<span class='keyword'>do</span>&nbsp;<span id='Z511515'><span><span class='ident'>loop</span></span></span><span class='lexic'>(</span><span id='Z511233'><span><span class='ident'>e</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z511615",this)' onmouseleave='srcref_leave("Z511615",this)'><span><span class='ident'>e0</span></span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0j</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>expr</span><span class='lexic'>:</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z511233",this)' onmouseleave='srcref_leave("Z511233",this)'><span><span class='ident'>e</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>once</span>&nbsp;<span class='ident'>expr</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z511499'><span><span class='ident'>seq</span></span></span>&nbsp;&#8594;&nbsp;<span class='keyword'>if</span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z511499",this)' onmouseleave='srcref_leave("Z511499",this)'><span><span class='ident'>body</span></span></span><span class='hint'>seq(body)</span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>&lt;</span><span class='lexic'><span class='pattern'>[</span></span><span id='Z511514'><span><span class='ident'><span class='pattern'>a</span></span></span></span><span class='lexic'><span class='pattern'>;</span></span><span id='Z511516'><span><span class='ident'><span class='pattern'>b</span></span></span></span><span class='lexic'><span class='pattern'>]</span></span><span class='lexic'>&gt;</span>&nbsp;<span class='lexic'>=</span>&nbsp;<a href='#Z508950'><span class='ident'>tsplit</span></a><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z511499",this)' onmouseleave='srcref_leave("Z511499",this)'><span><span class='ident'>body</span></span></span><span class='hint'>seq(body)</span></span><span class='lexic'>);</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='keyword'>node</span><span class='hint'>lang0j:expr:seq(body)</span></span><span class='lexic'>(</span><span class='ident'>body</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z511514",this)' onmouseleave='srcref_leave("Z511514",this)'><span><span class='ident'>a</span></span></span>&nbsp;<span class='lexic'>&#8853;</span>&nbsp;<span class='lexic'>[</span><span class='idfrom' onmouseenter='srcref_over("Z511515",this)' onmouseleave='srcref_leave("Z511515",this)'><span><span class='ident'>loop</span></span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z511516",this)' onmouseleave='srcref_leave("Z511516",this)'><span><span class='ident'>b</span></span></span><span class='lexic'>)])}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>else</span>&nbsp;<span class='ident'>node</span><span class='lexic'>()</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;&nbsp;<span id='Z511546'><span><span class='ident'>if3</span></span></span>&nbsp;&#8594;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='keyword'>node</span><span class='hint'>lang0j:expr:if3(cnd,tr,fl)<br>
&nbsp;&nbsp;&nbsp;with&nbsp;implicit&nbsp;arguments:&nbsp;cnd<br>
</span></span><span class='lexic'>(</span><span class='ident'>tr</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z511515",this)' onmouseleave='srcref_leave("Z511515",this)'><span><span class='ident'>loop</span></span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z511546",this)' onmouseleave='srcref_leave("Z511546",this)'><span><span class='ident'>tr</span></span></span><span class='hint'>if3(cnd,tr,fl)</span></span><span class='lexic'>),</span>&nbsp;<span class='ident'>fl</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z511515",this)' onmouseleave='srcref_leave("Z511515",this)'><span><span class='ident'>loop</span></span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z511546",this)' onmouseleave='srcref_leave("Z511546",this)'><span><span class='ident'>fl</span></span></span><span class='hint'>if3(cnd,tr,fl)</span></span><span class='lexic'>))</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;&nbsp;<span class='ident'>alloca</span>&nbsp;&#8594;&nbsp;<span class='ident'>node</span><span class='lexic'>()</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;&nbsp;<span class='ident'>set</span>&nbsp;&#8594;&nbsp;<span class='ident'>node</span><span class='lexic'>()</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='keyword'>if</span>&nbsp;<span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z511478",this)' onmouseleave='srcref_leave("Z511478",this)'><span><span class='ident'>dst</span></span></span><span class='lexic'>)</span>&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>set</span><span class='hint'>lang0j:expr:set(id,v)</span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z511478",this)' onmouseleave='srcref_leave("Z511478",this)'><span><span class='ident'>dst</span></span></span><span class='lexic'>,</span>&nbsp;<span class='ident'>node</span><span class='lexic'>())</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>else</span>&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>drop</span><span class='hint'>lang0j:expr:drop(v)</span></span><span class='lexic'>(</span><span class='ident'>node</span><span class='lexic'>())</span><span class='lexic'>}}</span>
<p></div>


<p>The next function is identifying statement--expressions and treats them in a special way: any value returned
from the non--terminal sequence elements is dropped, and any value of a complex statement--expression that is
actually used is assigned to a variable, and a special <b>splitexpr</b> variant is created, holding both the
statement that generates the value and an expression to access this value. After the split between statements
and expressions is completed those inner statements will be lifted to their nearest statement scopes.


<p><div class='code'>
<span id='Z511696'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_stmtexpr_topexpr_inner</span><span class='lexic'>(</span><span id='Z513240'><span><span class='ident'>e0</span></span></span><span class='lexic'>,</span>&nbsp;<span id='Z512714'><span><span class='ident'>addalloca</span></span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;<span class='keyword'>do</span>&nbsp;<span id='Z512728'><span><span class='ident'>loop</span></span></span><span class='lexic'>(</span><span id='Z513239'><span><span class='ident'>e</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z513240",this)' onmouseleave='srcref_leave("Z513240",this)'><span><span class='ident'>e0</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;<span id='Z513099'><span><span class='ident'>inner</span></span></span><span class='lexic'>(</span><span id='Z512465'><span><span class='ident'>e</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>=</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0j</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>expr</span><span class='lexic'>:</span><span class='idfrom' onmouseenter='srcref_over("Z512465",this)' onmouseleave='srcref_leave("Z512465",this)'><span><span class='ident'>e</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>once</span>&nbsp;<span class='ident'>expr</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='ident'>seq</span>&nbsp;&#8594;&nbsp;<span class='keyword'>symbols</span><span class='lexic'>(</span><span id='Z512718'><span><span class='ident'>dst</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z512714",this)' onmouseleave='srcref_leave("Z512714",this)'><span><span class='ident'>addalloca</span></span></span><span class='lexic'>(</span><span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>alloca</span><span class='hint'>lang0j:expr:alloca(id)</span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z512718",this)' onmouseleave='srcref_leave("Z512718",this)'><span><span class='ident'>dst</span></span></span><span class='lexic'>));</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>splitexpr</span><span class='hint'>lang0j:expr:splitexpr(l,r)</span></span><span class='lexic'>(</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href='#Z510848'><span class='ident'>l0_stmtexpr_inner</span></a><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z512728",this)' onmouseleave='srcref_leave("Z512728",this)'><span><span class='ident'>loop</span></span></span><span class='lexic'>(</span><span class='ident'>node</span><span class='lexic'>()),</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z512718",this)' onmouseleave='srcref_leave("Z512718",this)'><span><span class='ident'>dst</span></span></span><span class='lexic'>),</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='ident'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>local</span><span class='hint'>lang0j:expr:local(id)</span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z512718",this)' onmouseleave='srcref_leave("Z512718",this)'><span><span class='ident'>dst</span></span></span><span class='lexic'>))}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>if3</span>&nbsp;&#8594;&nbsp;<span class='keyword'>symbols</span><span class='lexic'>(</span><span id='Z512764'><span><span class='ident'>dst</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z512714",this)' onmouseleave='srcref_leave("Z512714",this)'><span><span class='ident'>addalloca</span></span></span><span class='lexic'>(</span><span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>alloca</span><span class='hint'>lang0j:expr:alloca(id)</span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z512764",this)' onmouseleave='srcref_leave("Z512764",this)'><span><span class='ident'>dst</span></span></span><span class='lexic'>));</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>splitexpr</span><span class='hint'>lang0j:expr:splitexpr(l,r)</span></span><span class='lexic'>(</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href='#Z510848'><span class='ident'>l0_stmtexpr_inner</span></a><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z512728",this)' onmouseleave='srcref_leave("Z512728",this)'><span><span class='ident'>loop</span></span></span><span class='lexic'>(</span><span class='ident'>node</span><span class='lexic'>()),</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z512764",this)' onmouseleave='srcref_leave("Z512764",this)'><span><span class='ident'>dst</span></span></span><span class='lexic'>),</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='ident'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>local</span><span class='hint'>lang0j:expr:local(id)</span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z512764",this)' onmouseleave='srcref_leave("Z512764",this)'><span><span class='ident'>dst</span></span></span><span class='lexic'>))}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='keyword'>deep</span>&nbsp;&#8594;&nbsp;<span class='lexic'>{</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='ident'>node</span><span class='lexic'>()</span>&nbsp;<span class='lexic'>}}};</span><br>
&nbsp;&nbsp;&nbsp;<span id='Z513238'><span><span class='ident'>toplev</span></span></span><span class='lexic'>(</span><span id='Z512854'><span><span class='ident'>e</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>=</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0j</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>expr</span><span class='lexic'>:</span><span class='idfrom' onmouseenter='srcref_over("Z512854",this)' onmouseleave='srcref_leave("Z512854",this)'><span><span class='ident'>e</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>once</span>&nbsp;<span class='ident'>expr</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z513103'><span><span class='ident'>seq</span></span></span>&nbsp;&#8594;&nbsp;<span class='keyword'>if</span>&nbsp;<span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z513103",this)' onmouseleave='srcref_leave("Z513103",this)'><span><span class='ident'>body</span></span></span><span class='hint'>seq(body)</span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>&lt;</span><span class='lexic'><span class='pattern'>[</span></span><span id='Z513121'><span><span class='ident'><span class='pattern'>a</span></span></span></span><span class='lexic'><span class='pattern'>;</span></span><span id='Z513125'><span><span class='ident'><span class='pattern'>b</span></span></span></span><span class='lexic'><span class='pattern'>]</span></span><span class='lexic'>&gt;</span>&nbsp;<span class='lexic'>=</span>&nbsp;<a href='#Z508950'><span class='ident'>tsplit</span></a><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z513103",this)' onmouseleave='srcref_leave("Z513103",this)'><span><span class='ident'>body</span></span></span><span class='hint'>seq(body)</span></span><span class='lexic'>);</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='keyword'>node</span><span class='hint'>lang0j:expr:seq(body)</span></span><span class='lexic'>(</span><span class='ident'>body</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='lexic'>[@</span><span class='keyword'>map</span>&nbsp;<span id='Z513124'><span><span class='idfrom' onmouseenter='srcref_over("Z513121",this)' onmouseleave='srcref_leave("Z513121",this)'><span><span class='ident'>a</span></span></span></span></span>&nbsp;<span class='keyword'>do</span>&nbsp;<a href='#Z510848'><span class='ident'>l0_stmtexpr_inner</span></a><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z512728",this)' onmouseleave='srcref_leave("Z512728",this)'><span><span class='ident'>loop</span></span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z513124",this)' onmouseleave='srcref_leave("Z513124",this)'><span><span class='ident'>a</span></span></span><span class='lexic'>),</span>&nbsp;<span class='lexic'>&#8709;</span><span class='lexic'>);</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z512728",this)' onmouseleave='srcref_leave("Z512728",this)'><span><span class='ident'>loop</span></span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z513125",this)' onmouseleave='srcref_leave("Z513125",this)'><span><span class='ident'>b</span></span></span><span class='lexic'>)])</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>}</span>&nbsp;<span class='keyword'>else</span>&nbsp;<span class='ident'>node</span><span class='lexic'>()</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span id='Z513156'><span><span class='ident'>if3</span></span></span>&nbsp;&#8594;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='keyword'>node</span><span class='hint'>lang0j:expr:if3(cnd,tr,fl)</span></span><span class='lexic'>(</span><span class='ident'>cnd</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z513099",this)' onmouseleave='srcref_leave("Z513099",this)'><span><span class='ident'>inner</span></span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z513156",this)' onmouseleave='srcref_leave("Z513156",this)'><span><span class='ident'>cnd</span></span></span><span class='hint'>if3(cnd,tr,fl)</span></span><span class='lexic'>),</span>&nbsp;<span class='ident'>tr</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z512728",this)' onmouseleave='srcref_leave("Z512728",this)'><span><span class='ident'>loop</span></span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z513156",this)' onmouseleave='srcref_leave("Z513156",this)'><span><span class='ident'>tr</span></span></span><span class='hint'>if3(cnd,tr,fl)</span></span><span class='lexic'>),</span>&nbsp;<span class='ident'>fl</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z512728",this)' onmouseleave='srcref_leave("Z512728",this)'><span><span class='ident'>loop</span></span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z513156",this)' onmouseleave='srcref_leave("Z513156",this)'><span><span class='ident'>fl</span></span></span><span class='hint'>if3(cnd,tr,fl)</span></span><span class='lexic'>))</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span id='Z513204'><span><span class='ident'>set</span></span></span>&nbsp;&#8594;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='keyword'>node</span><span class='hint'>lang0j:expr:set(id,v)<br>
&nbsp;&nbsp;&nbsp;with&nbsp;implicit&nbsp;arguments:&nbsp;id<br>
</span></span><span class='lexic'>(</span><span class='ident'>v</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z513099",this)' onmouseleave='srcref_leave("Z513099",this)'><span><span class='ident'>inner</span></span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z513204",this)' onmouseleave='srcref_leave("Z513204",this)'><span><span class='ident'>v</span></span></span><span class='hint'>set(id,v)</span></span><span class='lexic'>))</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z513099",this)' onmouseleave='srcref_leave("Z513099",this)'><span><span class='ident'>inner</span></span></span><span class='lexic'>(</span><span class='ident'>node</span><span class='lexic'>())}};</span><br>
&nbsp;&nbsp;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z513238",this)' onmouseleave='srcref_leave("Z513238",this)'><span><span class='ident'>toplev</span></span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z513239",this)' onmouseleave='srcref_leave("Z513239",this)'><span><span class='ident'>e</span></span></span><span class='lexic'>)}</span>
<p></div>


<p>The previous function could have created some new variables, so we have to add corresponding allocas to the
beginning of the outer context.


<p><div class='code'>
<span id='Z513396'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_stmtexpr_topexpr</span><span class='lexic'>(</span><span id='Z513418'><span><span class='ident'>e0</span></span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;<span class='keyword'>collector</span>&nbsp;<span class='lexic'>(</span><span id='Z513419'><span><span class='ident'>addalloca</span></span></span><span class='lexic'>,</span>&nbsp;<span id='Z513421'><span><span class='ident'>getallocas</span></span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;<span class='keyword'>with</span>&nbsp;<span class='keyword'>target</span>&nbsp;<span class='lexic'>(</span><span class='ident'>lang0j</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z513426'><span><span class='ident'>ret</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<a href='#Z511696'><span class='ident'>l0_stmtexpr_topexpr_inner</span></a><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z513418",this)' onmouseleave='srcref_leave("Z513418",this)'><span><span class='ident'>e0</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z513419",this)' onmouseleave='srcref_leave("Z513419",this)'><span><span class='ident'>addalloca</span></span></span><span class='lexic'>);</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z513422'><span><span class='ident'>allocas</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z513421",this)' onmouseleave='srcref_leave("Z513421",this)'><span><span class='ident'>getallocas</span></span></span><span class='lexic'>();</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>if</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z513422",this)' onmouseleave='srcref_leave("Z513422",this)'><span><span class='ident'>allocas</span></span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>expr</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>seq</span><span class='hint'>lang0j:expr:seq(body)</span></span><span class='lexic'>(</span><span class='ident'>body</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='lexic'>[@</span><span class='idfrom' onmouseenter='srcref_over("Z513422",this)' onmouseleave='srcref_leave("Z513422",this)'><span><span class='ident'>allocas</span></span></span><span class='lexic'>;</span><span class='idfrom' onmouseenter='srcref_over("Z513426",this)' onmouseleave='srcref_leave("Z513426",this)'><span><span class='ident'>ret</span></span></span><span class='lexic'>])</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>else</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z513426",this)' onmouseleave='srcref_leave("Z513426",this)'><span><span class='ident'>ret</span></span></span><span class='lexic'>}</span>
<p></div>



<p><div class='code'>
<span id='Z513436'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_stmtexpr</span><span class='lexic'>(</span><span id='Z513897'><span><span class='ident'>ts</span></span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;<span class='keyword'>map</span>&nbsp;<span id='Z513905'><span><span class='ident'>t</span></span></span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z513897",this)' onmouseleave='srcref_leave("Z513897",this)'><span><span class='ident'>ts</span></span></span>&nbsp;<span class='keyword'>do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0j</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>top</span><span class='lexic'>:</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z513905",this)' onmouseleave='srcref_leave("Z513905",this)'><span><span class='ident'>t</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>once</span>&nbsp;<span class='ident'>expr</span>&nbsp;<span class='lexic'>{</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<a href='#Z513396'><span class='ident'>l0_stmtexpr_topexpr</span></a><span class='lexic'>(</span><span class='ident'>node</span><span class='lexic'>())</span>&nbsp;<span class='lexic'>}}</span>
<p></div>


<h3 id="tco">Detecting tail recursion</h3>

<p>Some tail calls are tail recursive, and this is a right moment to replace them with a <b>goto</b>.
The language does not have gotos and labels? Not a problem at all, we'll make a new language now:


<p><div class='code'>
<span class='keyword'>ast</span>&nbsp;<span class='ident'>lang0k</span>&nbsp;<span class='lexic'>:</span>&nbsp;<span class='ident'>lang0j</span>&nbsp;<span class='lexic'>()</span>&nbsp;<span class='keyword'>recform</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;<span class='ident'>expr</span>&nbsp;<span class='lexic'>+=</span>&nbsp;<span class='ident'>label</span><span class='lexic'>(</span><span class='ident'>labident</span><span class='lexic'>:</span><span class='ident'>id</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;&nbsp;<span class='ident'>goto</span><span class='lexic'>(</span><span class='ident'>labident</span><span class='lexic'>:</span><span class='ident'>id</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='lexic'>-</span><span class='ident'>let</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>;</span><br>
&nbsp;&nbsp;<span class='ident'>hint</span>&nbsp;<span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>alloca</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='ident'>newline</span><span class='lexic'>;</span><br>
&nbsp;&nbsp;<span class='ident'>hint</span>&nbsp;<span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>set</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='ident'>newline</span><span class='lexic'>;</span><br>
&nbsp;&nbsp;<span class='ident'>hint</span>&nbsp;<span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>seq</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='ident'>newline</span><span class='lexic'>;</span><br>
&nbsp;&nbsp;<span class='ident'>hint</span>&nbsp;<span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>if3</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='ident'>newline</span><span class='lexic'>;</span><br>
&nbsp;&nbsp;<span class='ident'>hint</span>&nbsp;<span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>goto</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='ident'>newline</span><span class='lexic'>;</span><br>
&nbsp;&nbsp;<span class='ident'>hint</span>&nbsp;<span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>label</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='ident'>newline</span><span class='lexic'>;</span><br>
&nbsp;&nbsp;<span class='ident'>hint</span>&nbsp;<span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>return</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='ident'>newline</span><span class='lexic'>;</span><br>
<span class='lexic'>}</span>
<p></div>


<p>If a function is directly tail recursive, we have to create temporary variables that will initially contain
copies of the argument values and then will be used to pass arguments in a tail--recursive call. In this case
all the argument references in the function body must be replaced with local variable references.


<p><div class='code'>
<span id='Z514437'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_tailrec_topexpr</span><span class='lexic'>(</span><span id='Z515731'><span><span class='ident'>self</span></span></span><span class='lexic'>,</span>&nbsp;<span id='Z516433'><span><span class='ident'>fnargs</span></span></span><span class='lexic'>,</span>&nbsp;<span id='Z516110'><span><span class='ident'>e</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;<span id='Z516425'><span><span class='ident'>trecp</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='ident'>mkref</span><span class='lexic'>(</span><span class='lexic'>&#8709;</span><span class='lexic'>);</span><br>
&nbsp;&nbsp;&nbsp;<span id='Z516421'><span><span class='ident'>isself</span></span></span><span class='lexic'>(</span><span id='Z515487'><span><span class='ident'>e</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>=</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0k</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>expr</span><span class='lexic'>:</span><span class='idfrom' onmouseenter='srcref_over("Z515487",this)' onmouseleave='srcref_leave("Z515487",this)'><span><span class='ident'>e</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>once</span>&nbsp;<span class='ident'>expr</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z515728'><span><span class='ident'>global</span></span></span>&nbsp;&#8594;&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z515728",this)' onmouseleave='srcref_leave("Z515728",this)'><span><span class='ident'>id</span></span></span><span class='hint'>global(id)</span></span>&nbsp;<span class='lexic'>===</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z515731",this)' onmouseleave='srcref_leave("Z515731",this)'><span><span class='ident'>self</span></span></span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='lexic'>&#8709;</span><span class='lexic'>}};</span><br>
&nbsp;&nbsp;&nbsp;<span id='Z516531'><span><span class='ident'>rewriteargs</span></span></span><span class='lexic'>(</span><span id='Z515796'><span><span class='ident'>e</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>=</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0k</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>expr</span><span class='lexic'>:</span><span class='idfrom' onmouseenter='srcref_over("Z515796",this)' onmouseleave='srcref_leave("Z515796",this)'><span><span class='ident'>e</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>expr</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z516046'><span><span class='ident'>arg</span></span></span>&nbsp;&#8594;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>local</span><span class='hint'>lang0k:expr:local(id)</span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z516046",this)' onmouseleave='srcref_leave("Z516046",this)'><span><span class='ident'>id</span></span></span><span class='hint'>arg(id)</span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='ident'>node</span><span class='lexic'>()}};</span><br>
&nbsp;&nbsp;&nbsp;<span id='Z516532'><span><span class='ident'>body0</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0j</span>&nbsp;<span class='lexic'>/rec,</span>&nbsp;<span class='lexic'>dst</span>&nbsp;<span class='ident'>lang0k</span><span class='lexic'>/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>expr</span><span class='lexic'>:</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z516110",this)' onmouseleave='srcref_leave("Z516110",this)'><span><span class='ident'>e</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>expr</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z516422'><span><span class='ident'>tailapply</span></span></span>&nbsp;&#8594;&nbsp;<span class='keyword'>if</span>&nbsp;<span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z516421",this)' onmouseleave='srcref_leave("Z516421",this)'><span><span class='ident'>isself</span></span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z516422",this)' onmouseleave='srcref_leave("Z516422",this)'><span><span class='ident'>fn</span></span></span><span class='hint'>tailapply(fn,args)</span></span><span class='lexic'>))</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z516425",this)' onmouseleave='srcref_leave("Z516425",this)'><span><span class='ident'>trecp</span></span></span>&nbsp;<span class='lexic'>:=</span>&nbsp;<span class='keyword'>true</span><span class='lexic'>;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>seq</span><span class='hint'>lang0k:expr:seq(body)</span></span><span class='lexic'>(</span><span class='ident'>body</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='lexic'>[@</span><span class='keyword'>map</span>&nbsp;<span class='lexic'>[</span><span id='Z516451'><span><span class='ident'><span class='pattern'>a</span></span></span></span><span class='lexic'>;</span><span id='Z516452'><span><span class='ident'><span class='pattern'>v</span></span></span></span><span class='lexic'>]</span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='withhint'><span class='ident'>zip</span><span class='hint'>function&nbsp;zip&nbsp;a,&nbsp;b:&nbsp;<br>
Returns&nbsp;the&nbsp;list&nbsp;of&nbsp;($a_i${}&nbsp;$b_i$)&nbsp;for&nbsp;all&nbsp;elements&nbsp;of&nbsp;[a]&nbsp;and&nbsp;[b].</span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z516433",this)' onmouseleave='srcref_leave("Z516433",this)'><span><span class='ident'>fnargs</span></span></span><span class='lexic'>,</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z516422",this)' onmouseleave='srcref_leave("Z516422",this)'><span><span class='ident'>args</span></span></span><span class='hint'>tailapply(fn,args)</span></span><span class='lexic'>)</span>&nbsp;<span class='keyword'>do</span>&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>set</span><span class='hint'>lang0k:expr:set(id,v)</span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z516451",this)' onmouseleave='srcref_leave("Z516451",this)'><span><span class='ident'>a</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z516452",this)' onmouseleave='srcref_leave("Z516452",this)'><span><span class='ident'>v</span></span></span><span class='lexic'>);</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>goto</span><span class='hint'>lang0k:expr:goto(id)</span></span><span class='lexic'>(</span><span class='symbol'>'tailrecentry'</span><span class='lexic'>)])</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>}</span>&nbsp;<span class='keyword'>else</span>&nbsp;<span class='ident'>node</span><span class='lexic'>()</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='ident'>node</span><span class='lexic'>()}};</span><br>
&nbsp;&nbsp;&nbsp;<span class='keyword'>if</span>&nbsp;<span class='lexic'>(^</span><span class='idfrom' onmouseenter='srcref_over("Z516425",this)' onmouseleave='srcref_leave("Z516425",this)'><span><span class='ident'>trecp</span></span></span><span class='lexic'>)</span>&nbsp;<span class='keyword'>with</span>&nbsp;<span class='keyword'>target</span>&nbsp;<span class='lexic'>(</span><span class='ident'>lang0k</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>expr</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>seq</span><span class='hint'>lang0k:expr:seq(body)</span></span><span class='lexic'>(</span><span class='ident'>body</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='lexic'>[@</span><span class='keyword'>map</span>&nbsp;<span id='Z516496'><span><span class='ident'>a</span></span></span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z516433",this)' onmouseleave='srcref_leave("Z516433",this)'><span><span class='ident'>fnargs</span></span></span>&nbsp;<span class='keyword'>do</span>&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>alloca</span><span class='hint'>lang0k:expr:alloca(id)</span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z516496",this)' onmouseleave='srcref_leave("Z516496",this)'><span><span class='ident'>a</span></span></span><span class='lexic'>);</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>@</span><span class='keyword'>map</span>&nbsp;<span id='Z516509'><span><span class='ident'>a</span></span></span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z516433",this)' onmouseleave='srcref_leave("Z516433",this)'><span><span class='ident'>fnargs</span></span></span>&nbsp;<span class='keyword'>do</span>&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>set</span><span class='hint'>lang0k:expr:set(id,v)</span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z516509",this)' onmouseleave='srcref_leave("Z516509",this)'><span><span class='ident'>a</span></span></span><span class='lexic'>,</span>&nbsp;<span class='ident'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>arg</span><span class='hint'>lang0k:expr:arg(id)</span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z516509",this)' onmouseleave='srcref_leave("Z516509",this)'><span><span class='ident'>a</span></span></span><span class='lexic'>));</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>goto</span><span class='hint'>lang0k:expr:goto(id)</span></span><span class='lexic'>(</span><span class='symbol'>'tailrecentry'</span><span class='lexic'>);</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>label</span><span class='hint'>lang0k:expr:label(id)</span></span><span class='lexic'>(</span><span class='symbol'>'tailrecentry'</span><span class='lexic'>);</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z516531",this)' onmouseleave='srcref_leave("Z516531",this)'><span><span class='ident'>rewriteargs</span></span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z516532",this)' onmouseleave='srcref_leave("Z516532",this)'><span><span class='ident'>body0</span></span></span><span class='lexic'>)])</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;<span class='lexic'>}</span>&nbsp;<span class='keyword'>else</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z516532",this)' onmouseleave='srcref_leave("Z516532",this)'><span><span class='ident'>body0</span></span></span><span class='lexic'>}</span>
<p></div>



<p><div class='code'>
<span id='Z516744'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_tailrec</span><span class='lexic'>(</span><span id='Z517214'><span><span class='ident'>ts</span></span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;<span class='keyword'>map</span>&nbsp;<span id='Z517222'><span><span class='ident'>t</span></span></span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z517214",this)' onmouseleave='srcref_leave("Z517214",this)'><span><span class='ident'>ts</span></span></span>&nbsp;<span class='keyword'>do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0j</span>&nbsp;<span class='lexic'>/rec,</span>&nbsp;<span class='lexic'>dst</span>&nbsp;<span class='ident'>lang0k</span><span class='lexic'>/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>top</span><span class='lexic'>:</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z517222",this)' onmouseleave='srcref_leave("Z517222",this)'><span><span class='ident'>t</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>once</span>&nbsp;<span class='ident'>top</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z517573'><span><span class='ident'>sfunction</span></span></span>&nbsp;&#8594;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='keyword'>node</span><span class='hint'>lang0k:top:sfunction(id,args,body)<br>
&nbsp;&nbsp;&nbsp;with&nbsp;implicit&nbsp;arguments:&nbsp;id,&nbsp;args<br>
</span></span><span class='lexic'>(</span><span class='ident'>body</span>&nbsp;<span class='lexic'>=</span>&nbsp;<a href='#Z514437'><span class='ident'>l0_tailrec_topexpr</span></a><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z517573",this)' onmouseleave='srcref_leave("Z517573",this)'><span><span class='ident'>id</span></span></span><span class='hint'>sfunction(id,args,body)</span></span><span class='lexic'>,</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z517573",this)' onmouseleave='srcref_leave("Z517573",this)'><span><span class='ident'>args</span></span></span><span class='hint'>sfunction(id,args,body)</span></span><span class='lexic'>,</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z517573",this)' onmouseleave='srcref_leave("Z517573",this)'><span><span class='ident'>body</span></span></span><span class='hint'>sfunction(id,args,body)</span></span><span class='lexic'>))</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='keyword'>deep</span>&nbsp;&#8594;&nbsp;<span class='lexic'>{</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='ident'>node</span><span class='lexic'>()</span>&nbsp;<span class='lexic'>}};</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>once</span>&nbsp;<span class='ident'>expr</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='comment'>//&nbsp;We&nbsp;still&nbsp;have&nbsp;to&nbsp;do&nbsp;this&nbsp;pass&nbsp;even&nbsp;if&nbsp;it's&nbsp;not&nbsp;a&nbsp;function,<br>
</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='comment'>//&nbsp;because&nbsp;we're&nbsp;moving&nbsp;to&nbsp;another&nbsp;AST&nbsp;version&nbsp;here.<br>
</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<a href='#Z514437'><span class='ident'>l0_tailrec_topexpr</span></a><span class='lexic'>(</span><span class='symbol'>'*dummy*'</span><span class='lexic'>,</span>&nbsp;<span class='lexic'>&#8709;</span><span class='lexic'>,</span>&nbsp;<span class='ident'>node</span><span class='lexic'>())</span><span class='lexic'>}}</span>
<p></div>


<h3>All together</h3>


<p><div class='code'>
<span id='Z517771'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_codegen_prep</span><span class='lexic'>(</span><span id='Z517773'><span><span class='ident'>ts</span></span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;<a href='#Z516744'><span class='ident'>l0_tailrec</span></a><span class='lexic'>(</span><br>
&nbsp;&nbsp;<a href='#Z513436'><span class='ident'>l0_stmtexpr</span></a><span class='lexic'>(</span><br>
&nbsp;&nbsp;<a href='#Z509847'><span class='ident'>l0_tailcalls</span></a><span class='lexic'>(</span><br>
&nbsp;&nbsp;<a href='#Z507949'><span class='ident'>l0_seq_tidy</span></a><span class='lexic'>(</span><br>
&nbsp;&nbsp;<a href='#Z505366'><span class='ident'>l0_flatten_lets</span></a><span class='lexic'>(</span><br>
&nbsp;&nbsp;<a href='#Z503518'><span class='ident'>l0_classify_calls</span></a><span class='lexic'>(</span><br>
&nbsp;&nbsp;<a href='#Z502599'><span class='ident'>l0_classify_functions</span></a><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z517773",this)' onmouseleave='srcref_leave("Z517773",this)'><span><span class='ident'>ts</span></span></span><span class='lexic'>)))))))</span>
<p></div>




<p><div class='code'>
<span id='Z517777'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_lowering_driver</span><span class='lexic'>(</span><span id='Z517780'><span><span class='ident'>src</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;<span id='Z517781'><span><span class='ident'>x1</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<a href='#Z517771'><span class='ident'>l0_codegen_prep</span></a><span class='lexic'>(</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href='#Z502593'><span class='ident'>l0_lexical</span></a><span class='lexic'>(</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href='#Z495193'><span class='ident'>l0_lowering</span></a><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z517780",this)' onmouseleave='srcref_leave("Z517780",this)'><span><span class='ident'>src</span></span></span><span class='lexic'>)));</span><br>
&nbsp;&nbsp;<span class='keyword'>return</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z517781",this)' onmouseleave='srcref_leave("Z517781",this)'><span><span class='ident'>x1</span></span></span>&nbsp;<br>
<span class='lexic'>}</span>
<p></div>


<p>At this point, the foldl function looks like this:



   

<p><div class='democode'>
<span class='lexic'>(</span><span class='ident'>sfunction</span>&nbsp;<span class='keyword'>foldl</span>&nbsp;<span class='lexic'>(</span><span class='ident'>Z518998</span>&nbsp;<span class='ident'>Z518999</span>&nbsp;<span class='ident'>Z519000</span><span class='lexic'>)</span>&nbsp;<br>
&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>seq</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>alloca</span>&nbsp;<span class='ident'>Z518998</span><span class='lexic'>)</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>alloca</span>&nbsp;<span class='ident'>Z518999</span><span class='lexic'>)</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>alloca</span>&nbsp;<span class='ident'>Z519000</span><span class='lexic'>)</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>set</span>&nbsp;<span class='ident'>Z518998</span>&nbsp;<span class='lexic'>(</span><span class='ident'>arg</span>&nbsp;<span class='ident'>Z518998</span><span class='lexic'>))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>set</span>&nbsp;<span class='ident'>Z518999</span>&nbsp;<span class='lexic'>(</span><span class='ident'>arg</span>&nbsp;<span class='ident'>Z518999</span><span class='lexic'>))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>set</span>&nbsp;<span class='ident'>Z519000</span>&nbsp;<span class='lexic'>(</span><span class='ident'>arg</span>&nbsp;<span class='ident'>Z519000</span><span class='lexic'>))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>goto</span>&nbsp;<span class='ident'>tailrecentry</span><span class='lexic'>)</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>label</span>&nbsp;<span class='ident'>tailrecentry</span><span class='lexic'>)</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>seq</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>alloca</span>&nbsp;<span class='ident'>Z519001</span><span class='lexic'>)</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>alloca</span>&nbsp;<span class='ident'>Z519002</span><span class='lexic'>)</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>if3</span>&nbsp;<span class='lexic'>(</span><span class='keyword'>apply</span>&nbsp;<span class='lexic'>(</span><span class='ident'>global</span>&nbsp;<span class='ident'>nullp</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>(</span><span class='ident'>local</span>&nbsp;<span class='ident'>Z519000</span><span class='lexic'>))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(return</span>&nbsp;<span class='lexic'>(</span><span class='ident'>local</span>&nbsp;<span class='ident'>Z518999</span><span class='lexic'>))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>seq</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>set</span>&nbsp;<span class='ident'>Z519001</span>&nbsp;<span class='lexic'>(</span><span class='keyword'>apply</span>&nbsp;<span class='lexic'>(</span><span class='ident'>global</span>&nbsp;<span class='ident'>head</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>(</span><span class='ident'>local</span>&nbsp;<span class='ident'>Z519000</span><span class='lexic'>)))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>set</span>&nbsp;<span class='ident'>Z519002</span>&nbsp;<span class='lexic'>(</span><span class='keyword'>apply</span>&nbsp;<span class='lexic'>(</span><span class='ident'>global</span>&nbsp;<span class='ident'>tail</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>(</span><span class='ident'>local</span>&nbsp;<span class='ident'>Z519000</span><span class='lexic'>)))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>seq</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>set</span>&nbsp;<span class='ident'>Z518998</span>&nbsp;<span class='lexic'>(</span><span class='ident'>local</span>&nbsp;<span class='ident'>Z518998</span><span class='lexic'>))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>set</span>&nbsp;<span class='ident'>Z518999</span>&nbsp;<span class='lexic'>(</span><span class='keyword'>apply</span>&nbsp;<span class='lexic'>(</span><span class='ident'>local</span>&nbsp;<span class='ident'>Z518998</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>(</span><span class='ident'>local</span>&nbsp;<span class='ident'>Z518999</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>(</span><span class='ident'>local</span>&nbsp;<span class='ident'>Z519001</span><span class='lexic'>)))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>set</span>&nbsp;<span class='ident'>Z519000</span>&nbsp;<span class='lexic'>(</span><span class='ident'>local</span>&nbsp;<span class='ident'>Z519002</span><span class='lexic'>))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>goto</span>&nbsp;<span class='ident'>tailrecentry</span><span class='lexic'>)))))))</span><br>

</div><p>




<h2 id="imperative">Code generation: an imperative IR</h2>

<p>By now our source functional language got transformed into an imperative one, with explicitly allocated variables,
destructive assignments and properly marked tail calls. Nested lambda functions and lexical scope were
eliminated. There is already a clear separation between statements and expressions that occured naturally during
the previous passes. Goto, seq, drop, alloca, set, if, return and tailapply are statements, while everything else
is an expression.

<p>If our target was a stack machine, it would have been possible to keep an expression-based IR all the way down.
Unfortunately, stack machines are not quite fit for optimisations and analysis, and we're not going the CPS route neither.

<p>In an SSA-based IR we have to *assign* results to named registers. Control flow statements must be habdled differently
from the expressions yielding results, and for this reason we're starting this split here.

<p>It is an important compiler construction pattern that occurs even in the languages that had distinct
statements from the beginning.

<p>We can formalise this split now. The new AST <b>lang0k</b> defines everything that returns a value as an expresssion
and everything control flow as a statement. An <b>if3</b> statement does not return anything any longer, we ensured
this by assigning its return value to a variable previously, in a preparation phase.


<p><div class='code'>
<span class='keyword'>ast</span>&nbsp;<span class='ident'>lang0l</span>&nbsp;<span class='lexic'>:</span>&nbsp;<span class='ident'>lang0k</span>&nbsp;<span class='lexic'>()</span>&nbsp;<span class='keyword'>recform</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;<span class='ident'>top</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='ident'>define</span><span class='lexic'>(</span><span class='ident'>ident</span><span class='lexic'>:</span><span class='ident'>id</span><span class='lexic'>,</span>&nbsp;<span class='ident'>stmt</span><span class='lexic'>:</span><span class='ident'>e</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>defconst</span><span class='lexic'>(</span><span class='ident'>ident</span><span class='lexic'>:</span><span class='ident'>id</span><span class='lexic'>,</span>&nbsp;<span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>e</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>sfunction</span><span class='lexic'>(</span><span class='ident'>ident</span><span class='lexic'>:</span><span class='ident'>id</span><span class='lexic'>,</span>&nbsp;<span class='lexic'>*</span><span class='ident'>ident</span><span class='lexic'>:</span><span class='ident'>args</span><span class='lexic'>,</span>&nbsp;<span class='ident'>stmt</span><span class='lexic'>:</span><span class='ident'>body</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>closure</span><span class='lexic'>(</span><span class='ident'>ident</span><span class='lexic'>:</span><span class='ident'>id</span><span class='lexic'>,</span>&nbsp;<span class='lexic'>*</span><span class='ident'>ident</span><span class='lexic'>:</span><span class='ident'>clargs</span><span class='lexic'>,</span>&nbsp;<span class='lexic'>*</span><span class='ident'>ident</span><span class='lexic'>:</span><span class='ident'>args</span><span class='lexic'>,</span>&nbsp;<span class='ident'>stmt</span><span class='lexic'>:</span><span class='ident'>body</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>eval</span><span class='lexic'>(</span><span class='ident'>stmt</span><span class='lexic'>:</span><span class='ident'>e</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>debug</span><span class='lexic'>(.*</span><span class='ident'>any</span><span class='lexic'>:</span><span class='ident'>es</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>;</span><br>
&nbsp;&nbsp;<span class='ident'>expr</span>&nbsp;<span class='lexic'>=</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='ident'>const</span><span class='lexic'>(</span><span class='ident'>const</span><span class='lexic'>:</span><span class='ident'>c</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>global</span><span class='lexic'>(</span><span class='ident'>ident</span><span class='lexic'>:</span><span class='ident'>id</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>local</span><span class='lexic'>(</span><span class='ident'>ident</span><span class='lexic'>:</span><span class='ident'>id</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>arg</span><span class='lexic'>(</span><span class='ident'>ident</span><span class='lexic'>:</span><span class='ident'>id</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>clvar</span><span class='lexic'>(</span><span class='ident'>ident</span><span class='lexic'>:</span><span class='ident'>id</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>mkclosure</span><span class='lexic'>(</span><span class='ident'>ident</span><span class='lexic'>:</span><span class='ident'>df</span><span class='lexic'>,</span>&nbsp;<span class='lexic'>*</span><span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>args</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>funref</span><span class='lexic'>(</span><span class='ident'>ident</span><span class='lexic'>:</span><span class='ident'>id</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>apply</span><span class='lexic'>(</span><span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>fn</span><span class='lexic'>,</span>&nbsp;<span class='lexic'>.*</span><span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>args</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>splitexpr</span><span class='lexic'>(</span><span class='ident'>stmt</span><span class='lexic'>:</span><span class='ident'>l</span><span class='lexic'>,</span>&nbsp;<span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>r</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>;</span><br>
&nbsp;&nbsp;<span class='ident'>stmt</span>&nbsp;<span class='lexic'>=</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='ident'>seq</span><span class='lexic'>(.*</span><span class='ident'>stmt</span><span class='lexic'>:</span><span class='ident'>body</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>if3</span><span class='lexic'>(</span><span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>cnd</span><span class='lexic'>,</span>&nbsp;<span class='ident'>stmt</span><span class='lexic'>:</span><span class='ident'>tr</span><span class='lexic'>,</span>&nbsp;<span class='ident'>stmt</span><span class='lexic'>:</span><span class='ident'>fl</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>alloca</span><span class='lexic'>(</span><span class='ident'>ident</span><span class='lexic'>:</span><span class='ident'>id</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>set</span><span class='lexic'>(</span><span class='ident'>ident</span><span class='lexic'>:</span><span class='ident'>id</span><span class='lexic'>,</span>&nbsp;<span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>v</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>tailapply</span><span class='lexic'>(</span><span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>fn</span><span class='lexic'>,</span>&nbsp;<span class='lexic'>.*</span><span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>args</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>return</span><span class='lexic'>(</span><span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>v</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>label</span><span class='lexic'>(</span><span class='ident'>labident</span><span class='lexic'>:</span><span class='ident'>id</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>goto</span><span class='lexic'>(</span><span class='ident'>labident</span><span class='lexic'>:</span><span class='ident'>id</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>drop</span><span class='lexic'>(</span><span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>v</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>;</span><br>
<span class='lexic'>}</span>
<p></div>



The following pass dows not change the tree structure (besides renaming the toplevel 'expr' to 'eval'),
it merely sorts out the variants into their new nodes.


<p><div class='code'>
<span id='Z519003'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_split_statements</span><span class='lexic'>(</span><span id='Z519525'><span><span class='ident'>ts</span></span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;<span class='keyword'>map</span>&nbsp;<span id='Z519533'><span><span class='ident'>t</span></span></span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z519525",this)' onmouseleave='srcref_leave("Z519525",this)'><span><span class='ident'>ts</span></span></span>&nbsp;<span class='keyword'>do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0k</span>&nbsp;<span class='lexic'>/rec,</span>&nbsp;<span class='lexic'>dst</span>&nbsp;<span class='ident'>lang0l</span><span class='lexic'>/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>top</span><span class='lexic'>:</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z519533",this)' onmouseleave='srcref_leave("Z519533",this)'><span><span class='ident'>t</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>top</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z519871'><span><span class='ident'>expr</span></span></span>&nbsp;&#8594;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>top</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>eval</span><span class='hint'>lang0l:top:eval(e)</span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z519871",this)' onmouseleave='srcref_leave("Z519871",this)'><span><span class='ident'>e</span></span></span><span class='hint'>expr(e)</span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='ident'>node</span><span class='lexic'>()</span><span class='lexic'>};</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>expr</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='ident'>seq</span>&nbsp;&#8594;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>stmt</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>seq</span><span class='hint'>lang0l:stmt:seq(body)</span></span><span class='lexic'>()</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>if3</span>&nbsp;&#8594;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>stmt</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>if3</span><span class='hint'>lang0l:stmt:if3(cnd,tr,fl)</span></span><span class='lexic'>()</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>alloca</span>&nbsp;&#8594;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>stmt</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>alloca</span><span class='hint'>lang0l:stmt:alloca(id)</span></span><span class='lexic'>()</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>set</span>&nbsp;&#8594;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>stmt</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>set</span><span class='hint'>lang0l:stmt:set(id,v)</span></span><span class='lexic'>()</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>tailapply</span>&nbsp;&#8594;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>stmt</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>tailapply</span><span class='hint'>lang0l:stmt:tailapply(fn,args)</span></span><span class='lexic'>()</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>return</span>&nbsp;&#8594;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>stmt</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>return</span><span class='hint'>lang0l:stmt:return(v)</span></span><span class='lexic'>()</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>label</span>&nbsp;&#8594;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>stmt</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>label</span><span class='hint'>lang0l:stmt:label(id)</span></span><span class='lexic'>()</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>goto</span>&nbsp;&#8594;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>stmt</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>goto</span><span class='hint'>lang0l:stmt:goto(id)</span></span><span class='lexic'>()</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>drop</span>&nbsp;&#8594;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>stmt</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>drop</span><span class='hint'>lang0l:stmt:drop(v)</span></span><span class='lexic'>()</span><br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='ident'>node</span><span class='lexic'>()</span><span class='lexic'>}}</span>
<p></div>


<p>After this pass we still have that <b>splitexpr</b> thing in our IR, and it would be nice to flatten it
before we go any further.


<p><div class='code'>
<span id='Z520105'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_lower_splitexpr_stmt</span><span class='lexic'>(</span><span id='Z521101'><span><span class='ident'>s</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;<span id='Z521381'><span><span class='ident'>collectsplit</span></span></span><span class='lexic'>(</span><span id='Z520775'><span><span class='ident'>s</span></span></span><span class='lexic'>,</span>&nbsp;<span id='Z521085'><span><span class='ident'>add</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>=</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0l</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>stmt</span><span class='lexic'>:</span><span class='idfrom' onmouseenter='srcref_over("Z520775",this)' onmouseleave='srcref_leave("Z520775",this)'><span><span class='ident'>s</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>expr</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z521086'><span><span class='ident'>splitexpr</span></span></span>&nbsp;&#8594;&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z521085",this)' onmouseleave='srcref_leave("Z521085",this)'><span><span class='ident'>add</span></span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z521086",this)' onmouseleave='srcref_leave("Z521086",this)'><span><span class='ident'>l</span></span></span><span class='hint'>splitexpr(l,r)</span></span><span class='lexic'>);</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>return</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z521086",this)' onmouseleave='srcref_leave("Z521086",this)'><span><span class='ident'>r</span></span></span><span class='hint'>splitexpr(l,r)</span></span><span class='lexic'>}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='ident'>node</span><span class='lexic'>()}};</span><br>
&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0l</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>stmt</span><span class='lexic'>:</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z521101",this)' onmouseleave='srcref_leave("Z521101",this)'><span><span class='ident'>s</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>stmt</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='keyword'>collector</span><span class='lexic'>(</span><span id='Z521382'><span><span class='ident'>add</span></span></span><span class='lexic'>,</span>&nbsp;<span id='Z521384'><span><span class='ident'>get</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z521389'><span><span class='ident'>nbody</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z521381",this)' onmouseleave='srcref_leave("Z521381",this)'><span><span class='ident'>collectsplit</span></span></span><span class='lexic'>(</span><span class='ident'>node</span><span class='lexic'>(),</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z521382",this)' onmouseleave='srcref_leave("Z521382",this)'><span><span class='ident'>add</span></span></span><span class='lexic'>);</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z521385'><span><span class='ident'>lifted</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z521384",this)' onmouseleave='srcref_leave("Z521384",this)'><span><span class='ident'>get</span></span></span><span class='lexic'>();</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>if</span>&nbsp;<span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z521385",this)' onmouseleave='srcref_leave("Z521385",this)'><span><span class='ident'>lifted</span></span></span><span class='lexic'>)</span>&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>seq</span><span class='hint'>lang0l:stmt:seq(body)</span></span><span class='lexic'>(</span><span class='ident'>body</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='lexic'>[@</span><span class='idfrom' onmouseenter='srcref_over("Z521385",this)' onmouseleave='srcref_leave("Z521385",this)'><span><span class='ident'>lifted</span></span></span><span class='lexic'>;</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z521389",this)' onmouseleave='srcref_leave("Z521389",this)'><span><span class='ident'>nbody</span></span></span><span class='lexic'>])</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>else</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z521389",this)' onmouseleave='srcref_leave("Z521389",this)'><span><span class='ident'>nbody</span></span></span><span class='lexic'>}}}}</span>
<p></div>



<p><div class='code'>
<span id='Z521572'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_lower_splitexprs</span><span class='lexic'>(</span><span id='Z522025'><span><span class='ident'>ts</span></span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;<span class='keyword'>map</span>&nbsp;<span id='Z522033'><span><span class='ident'>t</span></span></span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z522025",this)' onmouseleave='srcref_leave("Z522025",this)'><span><span class='ident'>ts</span></span></span>&nbsp;<span class='keyword'>do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0l</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>top</span><span class='lexic'>:</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z522033",this)' onmouseleave='srcref_leave("Z522033",this)'><span><span class='ident'>t</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>once</span>&nbsp;<span class='ident'>stmt</span>&nbsp;<span class='lexic'>{</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<a href='#Z520105'><span class='ident'>l0_lower_splitexpr_stmt</span></a><span class='lexic'>(</span><span class='ident'>node</span><span class='lexic'>())</span><span class='lexic'>}}</span>
<p></div>


<h3>Flat IR</h3>

<p>With a clean and simple low level imperative IR we can now turn to all the different set of compiler construction
tools. First we'll lower this IR into an SSA form and apply all the standard SSA-based torture techniques to it.

<p>The first step in flattening will produce almost the same IR, with all the complex expressions broken down to
register assignments. We could have used local variable assignments here, but since we're going into an
SSA soon anyway it does not matter if "registers" are introduced a bit earlier.

<p>Note this <b>lock</b> node here - it is merely an optimisation, to ensure the visitor is not going into an already
flattened code.


<p><div class='code'>
<span class='keyword'>ast</span>&nbsp;<span class='ident'>lang0flat0</span>&nbsp;<span class='lexic'>:</span>&nbsp;<span class='ident'>lang0l</span>&nbsp;<span class='lexic'>()</span>&nbsp;<span class='keyword'>recform</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;<span class='ident'>stmt</span>&nbsp;<span class='lexic'>+=</span>&nbsp;<span class='ident'>def</span><span class='lexic'>(</span><span class='ident'>ident</span><span class='lexic'>:</span><span class='ident'>id</span><span class='lexic'>,</span>&nbsp;<span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>v</span><span class='lexic'>);</span><br>
&nbsp;&nbsp;<span class='ident'>expr</span>&nbsp;<span class='lexic'>+=</span>&nbsp;<span class='ident'>reg</span><span class='lexic'>(</span><span class='ident'>ident</span><span class='lexic'>:</span><span class='ident'>id</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;&nbsp;<span class='ident'>load</span><span class='lexic'>(</span><span class='ident'>ident</span><span class='lexic'>:</span><span class='ident'>id</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;&nbsp;<span class='ident'>lock</span><span class='lexic'>(</span><span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>e</span><span class='lexic'>);}</span>
<p></div>


<h3>Expresison flattening</h3>

<p>Getting ready to descend to SSA. This involves adding explicit load and store instructions for the local
stack--allocated variables, so we'll lift local references alongside with compound expressions here.


<p><div class='code'>
<span id='Z522555'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_flatten_stmt</span><span class='lexic'>(</span><span id='Z526695'><span><span class='ident'>s</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;<span id='Z525925'><span><span class='ident'>liftexpr</span></span></span><span class='lexic'>(</span><span id='Z524795'><span><span class='ident'>e</span></span></span><span class='lexic'>,</span>&nbsp;<span id='Z525118'><span><span class='ident'>add</span></span></span><span class='lexic'>,</span>&nbsp;<span id='Z525127'><span><span class='ident'>loop</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>=</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0flat0</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>expr</span><span class='lexic'>:</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z524795",this)' onmouseleave='srcref_leave("Z524795",this)'><span><span class='ident'>e</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>once</span>&nbsp;<span class='ident'>expr</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='ident'>const</span>&nbsp;&#8594;&nbsp;<span class='ident'>node</span><span class='lexic'>()</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>global</span>&nbsp;&#8594;&nbsp;<span class='ident'>node</span><span class='lexic'>()</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>arg</span>&nbsp;&#8594;&nbsp;<span class='ident'>node</span><span class='lexic'>()</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>clvar</span>&nbsp;&#8594;&nbsp;<span class='ident'>node</span><span class='lexic'>()</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>funref</span>&nbsp;&#8594;&nbsp;<span class='ident'>node</span><span class='lexic'>()</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span id='Z525167'><span><span class='ident'>local</span></span></span>&nbsp;&#8594;&nbsp;<span class='keyword'>symbols</span><span class='lexic'>(</span><span id='Z525160'><span><span class='ident'>newid</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z525118",this)' onmouseleave='srcref_leave("Z525118",this)'><span><span class='ident'>add</span></span></span><span class='lexic'>(</span><span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>stmt</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>def</span><span class='hint'>lang0flat0:stmt:def(id,v)</span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z525160",this)' onmouseleave='srcref_leave("Z525160",this)'><span><span class='ident'>newid</span></span></span><span class='lexic'>,</span>&nbsp;<span class='ident'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>lock</span><span class='hint'>lang0flat0:expr:lock(e)</span></span><span class='lexic'>(</span><span class='ident'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>load</span><span class='hint'>lang0flat0:expr:load(id)</span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z525167",this)' onmouseleave='srcref_leave("Z525167",this)'><span><span class='ident'>id</span></span></span><span class='hint'>local(id)</span></span><span class='lexic'>))));</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>return</span>&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>reg</span><span class='hint'>lang0flat0:expr:reg(id)</span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z525160",this)' onmouseleave='srcref_leave("Z525160",this)'><span><span class='ident'>newid</span></span></span><span class='lexic'>)}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='keyword'>symbols</span><span class='lexic'>(</span><span id='Z525123'><span><span class='ident'>newid</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z525118",this)' onmouseleave='srcref_leave("Z525118",this)'><span><span class='ident'>add</span></span></span><span class='lexic'>(</span><span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>stmt</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>def</span><span class='hint'>lang0flat0:stmt:def(id,v)</span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z525123",this)' onmouseleave='srcref_leave("Z525123",this)'><span><span class='ident'>newid</span></span></span><span class='lexic'>,</span>&nbsp;<span class='ident'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>lock</span><span class='hint'>lang0flat0:expr:lock(e)</span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z525127",this)' onmouseleave='srcref_leave("Z525127",this)'><span><span class='ident'>loop</span></span></span><span class='lexic'>(</span><span class='ident'>node</span><span class='lexic'>()))));</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>return</span>&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>reg</span><span class='hint'>lang0flat0:expr:reg(id)</span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z525123",this)' onmouseleave='srcref_leave("Z525123",this)'><span><span class='ident'>newid</span></span></span><span class='lexic'>)}}};</span><br>
&nbsp;&nbsp;<span class='comment'>//&nbsp;Skip&nbsp;the&nbsp;topmost&nbsp;expression&nbsp;and&nbsp;lift&nbsp;subexpressions&nbsp;only<br>
</span>&nbsp;&nbsp;<span id='Z526638'><span><span class='ident'>doexpr</span></span></span><span class='lexic'>(</span><span id='Z525978'><span><span class='ident'>e</span></span></span><span class='lexic'>,</span>&nbsp;<span id='Z525926'><span><span class='ident'>add</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='keyword'>do</span>&nbsp;<span id='Z525927'><span><span class='ident'>loop</span></span></span><span class='lexic'>(</span><span id='Z525245'><span><span class='ident'>e</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z525978",this)' onmouseleave='srcref_leave("Z525978",this)'><span><span class='ident'>e</span></span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0flat0</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>topexpr</span><span class='lexic'>:</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z525245",this)' onmouseleave='srcref_leave("Z525245",this)'><span><span class='ident'>e</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='ident'>topexpr</span>&nbsp;<span class='keyword'>as</span>&nbsp;<span class='ident'>expr</span>&nbsp;<span class='lexic'>{</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='ident'>node</span><span class='lexic'>()</span>&nbsp;<span class='lexic'>};</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>once</span>&nbsp;<span class='ident'>expr</span>&nbsp;<span class='lexic'>{</span>&nbsp;<span class='ident'>lock</span>&nbsp;&#8594;&nbsp;<span class='ident'>node</span><span class='lexic'>()</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z525925",this)' onmouseleave='srcref_leave("Z525925",this)'><span><span class='ident'>liftexpr</span></span></span><span class='lexic'>(</span><span class='ident'>node</span><span class='lexic'>(),</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z525926",this)' onmouseleave='srcref_leave("Z525926",this)'><span><span class='ident'>add</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z525927",this)' onmouseleave='srcref_leave("Z525927",this)'><span><span class='ident'>loop</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>}}</span><span class='lexic'>;</span><br>
&nbsp;&nbsp;<span class='comment'>//&nbsp;Skip&nbsp;the&nbsp;topmost&nbsp;statements&nbsp;and&nbsp;process&nbsp;statements&nbsp;one&nbsp;level&nbsp;down<br>
</span>&nbsp;&nbsp;<span id='Z526975'><span><span class='ident'>dostmt</span></span></span><span class='lexic'>(</span><span id='Z525988'><span><span class='ident'>s</span></span></span><span class='lexic'>,</span>&nbsp;<span id='Z526636'><span><span class='ident'>add</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>=</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0flat0</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>topstmt</span><span class='lexic'>:</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z525988",this)' onmouseleave='srcref_leave("Z525988",this)'><span><span class='ident'>s</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='ident'>topstmt</span>&nbsp;<span class='keyword'>as</span>&nbsp;<span class='ident'>stmt</span>&nbsp;<span class='lexic'>{</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='ident'>node</span><span class='lexic'>()</span>&nbsp;<span class='lexic'>};</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>once</span>&nbsp;<span class='ident'>stmt</span>&nbsp;<span class='lexic'>{</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='ident'>node</span><span class='lexic'>()</span>&nbsp;<span class='lexic'>};</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>once</span>&nbsp;<span class='ident'>expr</span>&nbsp;<span class='lexic'>{</span>&nbsp;<span class='ident'>lock</span>&nbsp;&#8594;&nbsp;<span class='ident'>node</span><span class='lexic'>()</span>&nbsp;<span class='lexic'>|</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z525925",this)' onmouseleave='srcref_leave("Z525925",this)'><span><span class='ident'>liftexpr</span></span></span><span class='lexic'>(</span><span class='ident'>node</span><span class='lexic'>(),</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z526636",this)' onmouseleave='srcref_leave("Z526636",this)'><span><span class='ident'>add</span></span></span><span class='lexic'>,</span>&nbsp;<span class='keyword'>&lambda;</span><span class='lexic'>(</span><span id='Z526639'><span><span class='ident'>e</span></span></span><span class='lexic'>)</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z526638",this)' onmouseleave='srcref_leave("Z526638",this)'><span><span class='ident'>doexpr</span></span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z526639",this)' onmouseleave='srcref_leave("Z526639",this)'><span><span class='ident'>e</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z526636",this)' onmouseleave='srcref_leave("Z526636",this)'><span><span class='ident'>add</span></span></span><span class='lexic'>)</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>}};</span><br>
&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0l</span>&nbsp;<span class='lexic'>/rec,</span>&nbsp;<span class='lexic'>dst</span>&nbsp;<span class='ident'>lang0flat0</span><span class='lexic'>/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>stmt</span><span class='lexic'>:</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z526695",this)' onmouseleave='srcref_leave("Z526695",this)'><span><span class='ident'>s</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>stmt</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='keyword'>collector</span><span class='lexic'>(</span><span id='Z526976'><span><span class='ident'>add</span></span></span><span class='lexic'>,</span>&nbsp;<span id='Z526978'><span><span class='ident'>get</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z526983'><span><span class='ident'>ret</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z526975",this)' onmouseleave='srcref_leave("Z526975",this)'><span><span class='ident'>dostmt</span></span></span><span class='lexic'>(</span><span class='ident'>node</span><span class='lexic'>(),</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z526976",this)' onmouseleave='srcref_leave("Z526976",this)'><span><span class='ident'>add</span></span></span><span class='lexic'>);</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z526979'><span><span class='ident'>lifted</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z526978",this)' onmouseleave='srcref_leave("Z526978",this)'><span><span class='ident'>get</span></span></span><span class='lexic'>();</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>if</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z526979",this)' onmouseleave='srcref_leave("Z526979",this)'><span><span class='ident'>lifted</span></span></span><span class='lexic'>)</span>&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>seq</span><span class='hint'>lang0flat0:stmt:seq(body)</span></span><span class='lexic'>(</span><span class='ident'>body</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='lexic'>[@</span><span class='idfrom' onmouseenter='srcref_over("Z526979",this)' onmouseleave='srcref_leave("Z526979",this)'><span><span class='ident'>lifted</span></span></span><span class='lexic'>;</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z526983",this)' onmouseleave='srcref_leave("Z526983",this)'><span><span class='ident'>ret</span></span></span><span class='lexic'>])</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>else</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z526983",this)' onmouseleave='srcref_leave("Z526983",this)'><span><span class='ident'>ret</span></span></span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>}}}}</span>
<p></div>


<p>The <b>lock</b> nodes introduced were temporary and must be eliminated now:


<p><div class='code'>
<span id='Z527432'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_flatten_unlock</span><span class='lexic'>(</span><span id='Z527818'><span><span class='ident'>s</span></span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0flat0</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>stmt</span><span class='lexic'>:</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z527818",this)' onmouseleave='srcref_leave("Z527818",this)'><span><span class='ident'>s</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>expr</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z528185'><span><span class='ident'>lock</span></span></span>&nbsp;&#8594;&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z528185",this)' onmouseleave='srcref_leave("Z528185",this)'><span><span class='ident'>e</span></span></span><span class='hint'>lock(e)</span></span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='ident'>node</span><span class='lexic'>()</span><span class='lexic'>}}</span>
<p></div>



<p><div class='code'>
<span id='Z528266'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_flatten</span><span class='lexic'>(</span><span id='Z528719'><span><span class='ident'>ts</span></span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;<span class='keyword'>map</span>&nbsp;<span id='Z528727'><span><span class='ident'>t</span></span></span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z528719",this)' onmouseleave='srcref_leave("Z528719",this)'><span><span class='ident'>ts</span></span></span>&nbsp;<span class='keyword'>do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0l</span>&nbsp;<span class='lexic'>/rec,</span>&nbsp;<span class='lexic'>dst</span>&nbsp;<span class='ident'>lang0flat0</span><span class='lexic'>/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>top</span><span class='lexic'>:</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z528727",this)' onmouseleave='srcref_leave("Z528727",this)'><span><span class='ident'>t</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>once</span>&nbsp;<span class='ident'>stmt</span>&nbsp;<span class='lexic'>{</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href='#Z527432'><span class='ident'>l0_flatten_unlock</span></a><span class='lexic'>(</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href='#Z522555'><span class='ident'>l0_flatten_stmt</span></a><span class='lexic'>(</span><span class='ident'>node</span><span class='lexic'>()))</span>&nbsp;<span class='lexic'>}}</span>
<p></div>



<h3>Statement flattening</h3>

<p>Now we can get rid of the compound statements, replacing them with a <b>goto</b> and labels. At the moment we
only have one kind of a compound statement - an <b>if</b>.


<p><div class='code'>
<span class='keyword'>ast</span>&nbsp;<span class='ident'>lang0flat1</span>&nbsp;<span class='lexic'>:</span>&nbsp;<span class='ident'>lang0flat0</span>&nbsp;<span class='lexic'>()</span>&nbsp;<span class='keyword'>recform</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;<span class='ident'>stmt</span>&nbsp;<span class='lexic'>+=</span>&nbsp;<span class='ident'>gotoc</span><span class='lexic'>(</span><span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>cnd</span><span class='lexic'>,</span>&nbsp;<span class='ident'>labident</span><span class='lexic'>:</span><span class='ident'>tr</span><span class='lexic'>,</span>&nbsp;<span class='ident'>labident</span><span class='lexic'>:</span><span class='ident'>fl</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='lexic'>-</span><span class='ident'>if3</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>;</span><br>
&nbsp;&nbsp;<span class='ident'>expr</span>&nbsp;<span class='lexic'>+=</span>&nbsp;<span class='lexic'>-</span><span class='ident'>lock</span><span class='lexic'>;</span><br>
&nbsp;&nbsp;<span class='ident'>hint</span>&nbsp;<span class='ident'>stmt</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='ident'>newline</span><span class='lexic'>;</span><br>
&nbsp;&nbsp;<span class='lexic'>}</span>
<p></div>



<p><div class='code'>
<span id='Z529249'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_flatten_cfg_stmt</span><span class='lexic'>(</span><span id='Z529698'><span><span class='ident'>s</span></span></span><span class='lexic'>)</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0flat0</span>&nbsp;<span class='lexic'>/rec,</span>&nbsp;<span class='lexic'>dst</span>&nbsp;<span class='ident'>lang0flat1</span><span class='lexic'>/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>stmt</span><span class='lexic'>:</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z529698",this)' onmouseleave='srcref_leave("Z529698",this)'><span><span class='ident'>s</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>stmt</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z530043'><span><span class='ident'>if3</span></span></span>&nbsp;&#8594;&nbsp;<span class='keyword'>symbols</span><span class='lexic'>(</span><span id='Z530046'><span><span class='ident'>ltr</span></span></span><span class='lexic'>,</span>&nbsp;<span id='Z530047'><span><span class='ident'>lfl</span></span></span><span class='lexic'>,</span>&nbsp;<span id='Z530066'><span><span class='ident'>lnext</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>seq</span><span class='hint'>lang0flat1:stmt:seq(body)</span></span><span class='lexic'>(</span><span class='ident'>body</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='lexic'>[</span><span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>gotoc</span><span class='hint'>lang0flat1:stmt:gotoc(cnd,tr,fl)</span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z530043",this)' onmouseleave='srcref_leave("Z530043",this)'><span><span class='ident'>cnd</span></span></span><span class='hint'>if3(cnd,tr,fl)</span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z530046",this)' onmouseleave='srcref_leave("Z530046",this)'><span><span class='ident'>ltr</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z530047",this)' onmouseleave='srcref_leave("Z530047",this)'><span><span class='ident'>lfl</span></span></span><span class='lexic'>);</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>label</span><span class='hint'>lang0flat1:stmt:label(id)</span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z530046",this)' onmouseleave='srcref_leave("Z530046",this)'><span><span class='ident'>ltr</span></span></span><span class='lexic'>);</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z530043",this)' onmouseleave='srcref_leave("Z530043",this)'><span><span class='ident'>tr</span></span></span><span class='hint'>if3(cnd,tr,fl)</span></span><span class='lexic'>;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>goto</span><span class='hint'>lang0flat1:stmt:goto(id)</span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z530066",this)' onmouseleave='srcref_leave("Z530066",this)'><span><span class='ident'>lnext</span></span></span><span class='lexic'>);</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>label</span><span class='hint'>lang0flat1:stmt:label(id)</span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z530047",this)' onmouseleave='srcref_leave("Z530047",this)'><span><span class='ident'>lfl</span></span></span><span class='lexic'>);</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z530043",this)' onmouseleave='srcref_leave("Z530043",this)'><span><span class='ident'>fl</span></span></span><span class='hint'>if3(cnd,tr,fl)</span></span><span class='lexic'>;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>goto</span><span class='hint'>lang0flat1:stmt:goto(id)</span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z530066",this)' onmouseleave='srcref_leave("Z530066",this)'><span><span class='ident'>lnext</span></span></span><span class='lexic'>);</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>label</span><span class='hint'>lang0flat1:stmt:label(id)</span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z530066",this)' onmouseleave='srcref_leave("Z530066",this)'><span><span class='ident'>lnext</span></span></span><span class='lexic'>)])}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='ident'>node</span><span class='lexic'>()</span><span class='lexic'>}}</span>
<p></div>


<p>The previous passes could produce nested <b>seq</b> blocks. Since this is the only compound statement left by
now we can just flatten everything into a single topmost sequence.


<p><div class='code'>
<span id='Z530214'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_flatten_seq</span><span class='lexic'>(</span><span id='Z530606'><span><span class='ident'>s</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;<span id='Z530984'><span><span class='ident'>seq</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0flat1</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>stmt</span><span class='lexic'>:</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z530606",this)' onmouseleave='srcref_leave("Z530606",this)'><span><span class='ident'>s</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>stmt</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z530927'><span><span class='ident'>seq</span></span></span>&nbsp;&#8594;&nbsp;<span class='keyword'>map</span>&nbsp;<span class='keyword'>append</span>&nbsp;<span id='Z530932'><span><span class='ident'>b</span></span></span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z530927",this)' onmouseleave='srcref_leave("Z530927",this)'><span><span class='ident'>body</span></span></span><span class='hint'>seq(body)</span></span>&nbsp;<span class='keyword'>do</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z530932",this)' onmouseleave='srcref_leave("Z530932",this)'><span><span class='ident'>b</span></span></span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='lexic'>[</span><span class='ident'>node</span><span class='lexic'>()]}};</span><br>
&nbsp;&nbsp;&nbsp;<span class='keyword'>with</span>&nbsp;<span class='keyword'>target</span>&nbsp;<span class='lexic'>(</span><span class='ident'>lang0flat1</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>stmt</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>seq</span><span class='hint'>lang0flat1:stmt:seq(body)</span></span><span class='lexic'>(</span><span class='ident'>body</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z530984",this)' onmouseleave='srcref_leave("Z530984",this)'><span><span class='ident'>seq</span></span></span><span class='lexic'>)}}</span>
<p></div>



<p><div class='code'>
<span id='Z531065'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_flatten_cfg</span><span class='lexic'>(</span><span id='Z531574'><span><span class='ident'>ts</span></span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;<span class='keyword'>map</span>&nbsp;<span id='Z531582'><span><span class='ident'>t</span></span></span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z531574",this)' onmouseleave='srcref_leave("Z531574",this)'><span><span class='ident'>ts</span></span></span>&nbsp;<span class='keyword'>do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0flat0</span>&nbsp;<span class='lexic'>/rec,</span>&nbsp;<span class='lexic'>dst</span>&nbsp;<span class='ident'>lang0flat1</span><span class='lexic'>/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>top</span><span class='lexic'>:</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z531582",this)' onmouseleave='srcref_leave("Z531582",this)'><span><span class='ident'>t</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>once</span>&nbsp;<span class='ident'>stmt</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<a href='#Z530214'><span class='ident'>l0_flatten_seq</span></a><span class='lexic'>(</span><a href='#Z529249'><span class='ident'>l0_flatten_cfg_stmt</span></a><span class='lexic'>(</span><span class='ident'>node</span><span class='lexic'>()))</span><span class='lexic'>}}</span>
<p></div>



<p><div class='code'>
<span id='Z532169'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_flatten_driver</span><span class='lexic'>(</span><span id='Z532172'><span><span class='ident'>src</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;<span id='Z532174'><span><span class='ident'>x1</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<a href='#Z517777'><span class='ident'>l0_lowering_driver</span></a><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z532172",this)' onmouseleave='srcref_leave("Z532172",this)'><span><span class='ident'>src</span></span></span><span class='lexic'>);</span><br>
&nbsp;&nbsp;<span id='Z532176'><span><span class='ident'>x2</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<a href='#Z521572'><span class='ident'>l0_lower_splitexprs</span></a><span class='lexic'>(</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href='#Z519003'><span class='ident'>l0_split_statements</span></a><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z532174",this)' onmouseleave='srcref_leave("Z532174",this)'><span><span class='ident'>x1</span></span></span><span class='lexic'>));</span><br>
&nbsp;&nbsp;<span id='Z532177'><span><span class='ident'>x3</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<a href='#Z531065'><span class='ident'>l0_flatten_cfg</span></a><span class='lexic'>(</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href='#Z528266'><span class='ident'>l0_flatten</span></a><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z532176",this)' onmouseleave='srcref_leave("Z532176",this)'><span><span class='ident'>x2</span></span></span><span class='lexic'>));</span><br>
&nbsp;&nbsp;<span class='keyword'>return</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z532177",this)' onmouseleave='srcref_leave("Z532177",this)'><span><span class='ident'>x3</span></span></span><br>
<span class='lexic'>}</span>
<p></div>


<p>And our sample <b>foldl</b> function looks like this after flattening:



   

<p><div class='democode'>
<span class='lexic'>(</span><span class='ident'>sfunction</span>&nbsp;<span class='keyword'>foldl</span>&nbsp;<span class='lexic'>(</span><span class='ident'>Z533533</span>&nbsp;<span class='ident'>Z533534</span>&nbsp;<span class='ident'>Z533535</span><span class='lexic'>)</span>&nbsp;<br>
&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>seq</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>alloca</span>&nbsp;<span class='ident'>Z533533</span><span class='lexic'>)</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>alloca</span>&nbsp;<span class='ident'>Z533534</span><span class='lexic'>)</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>alloca</span>&nbsp;<span class='ident'>Z533535</span><span class='lexic'>)</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>set</span>&nbsp;<span class='ident'>Z533533</span>&nbsp;<span class='lexic'>(</span><span class='ident'>arg</span>&nbsp;<span class='ident'>Z533533</span><span class='lexic'>))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>set</span>&nbsp;<span class='ident'>Z533534</span>&nbsp;<span class='lexic'>(</span><span class='ident'>arg</span>&nbsp;<span class='ident'>Z533534</span><span class='lexic'>))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>set</span>&nbsp;<span class='ident'>Z533535</span>&nbsp;<span class='lexic'>(</span><span class='ident'>arg</span>&nbsp;<span class='ident'>Z533535</span><span class='lexic'>))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>goto</span>&nbsp;<span class='ident'>tailrecentry</span><span class='lexic'>)</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>label</span>&nbsp;<span class='ident'>tailrecentry</span><span class='lexic'>)</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>alloca</span>&nbsp;<span class='ident'>Z533536</span><span class='lexic'>)</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>alloca</span>&nbsp;<span class='ident'>Z533537</span><span class='lexic'>)</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>def</span>&nbsp;<span class='ident'>Z533550</span>&nbsp;<span class='lexic'>(</span><span class='ident'>load</span>&nbsp;<span class='ident'>Z533535</span><span class='lexic'>))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>def</span>&nbsp;<span class='ident'>Z533549</span>&nbsp;<span class='lexic'>(</span><span class='keyword'>apply</span>&nbsp;<span class='lexic'>(</span><span class='ident'>global</span>&nbsp;<span class='ident'>nullp</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>(</span><span class='ident'>reg</span>&nbsp;<span class='ident'>Z533550</span><span class='lexic'>)))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>gotoc</span>&nbsp;<span class='lexic'>(</span><span class='ident'>reg</span>&nbsp;<span class='ident'>Z533549</span><span class='lexic'>)</span>&nbsp;<span class='ident'>Z533551</span>&nbsp;<span class='ident'>Z533552</span><span class='lexic'>)</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>label</span>&nbsp;<span class='ident'>Z533551</span><span class='lexic'>)</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>def</span>&nbsp;<span class='ident'>Z533538</span>&nbsp;<span class='lexic'>(</span><span class='ident'>load</span>&nbsp;<span class='ident'>Z533534</span><span class='lexic'>))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(return</span>&nbsp;<span class='lexic'>(</span><span class='ident'>reg</span>&nbsp;<span class='ident'>Z533538</span><span class='lexic'>))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>goto</span>&nbsp;<span class='ident'>Z533553</span><span class='lexic'>)</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>label</span>&nbsp;<span class='ident'>Z533552</span><span class='lexic'>)</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>def</span>&nbsp;<span class='ident'>Z533540</span>&nbsp;<span class='lexic'>(</span><span class='ident'>load</span>&nbsp;<span class='ident'>Z533535</span><span class='lexic'>))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>def</span>&nbsp;<span class='ident'>Z533539</span>&nbsp;<span class='lexic'>(</span><span class='keyword'>apply</span>&nbsp;<span class='lexic'>(</span><span class='ident'>global</span>&nbsp;<span class='ident'>head</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>(</span><span class='ident'>reg</span>&nbsp;<span class='ident'>Z533540</span><span class='lexic'>)))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>set</span>&nbsp;<span class='ident'>Z533536</span>&nbsp;<span class='lexic'>(</span><span class='ident'>reg</span>&nbsp;<span class='ident'>Z533539</span><span class='lexic'>))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>def</span>&nbsp;<span class='ident'>Z533542</span>&nbsp;<span class='lexic'>(</span><span class='ident'>load</span>&nbsp;<span class='ident'>Z533535</span><span class='lexic'>))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>def</span>&nbsp;<span class='ident'>Z533541</span>&nbsp;<span class='lexic'>(</span><span class='keyword'>apply</span>&nbsp;<span class='lexic'>(</span><span class='ident'>global</span>&nbsp;<span class='ident'>tail</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>(</span><span class='ident'>reg</span>&nbsp;<span class='ident'>Z533542</span><span class='lexic'>)))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>set</span>&nbsp;<span class='ident'>Z533537</span>&nbsp;<span class='lexic'>(</span><span class='ident'>reg</span>&nbsp;<span class='ident'>Z533541</span><span class='lexic'>))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>def</span>&nbsp;<span class='ident'>Z533543</span>&nbsp;<span class='lexic'>(</span><span class='ident'>load</span>&nbsp;<span class='ident'>Z533533</span><span class='lexic'>))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>set</span>&nbsp;<span class='ident'>Z533533</span>&nbsp;<span class='lexic'>(</span><span class='ident'>reg</span>&nbsp;<span class='ident'>Z533543</span><span class='lexic'>))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>def</span>&nbsp;<span class='ident'>Z533545</span>&nbsp;<span class='lexic'>(</span><span class='ident'>load</span>&nbsp;<span class='ident'>Z533533</span><span class='lexic'>))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>def</span>&nbsp;<span class='ident'>Z533546</span>&nbsp;<span class='lexic'>(</span><span class='ident'>load</span>&nbsp;<span class='ident'>Z533534</span><span class='lexic'>))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>def</span>&nbsp;<span class='ident'>Z533547</span>&nbsp;<span class='lexic'>(</span><span class='ident'>load</span>&nbsp;<span class='ident'>Z533536</span><span class='lexic'>))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>def</span>&nbsp;<span class='ident'>Z533544</span>&nbsp;<span class='lexic'>(</span><span class='keyword'>apply</span>&nbsp;<span class='lexic'>(</span><span class='ident'>reg</span>&nbsp;<span class='ident'>Z533545</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>(</span><span class='ident'>reg</span>&nbsp;<span class='ident'>Z533546</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>(</span><span class='ident'>reg</span>&nbsp;<span class='ident'>Z533547</span><span class='lexic'>)))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>set</span>&nbsp;<span class='ident'>Z533534</span>&nbsp;<span class='lexic'>(</span><span class='ident'>reg</span>&nbsp;<span class='ident'>Z533544</span><span class='lexic'>))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>def</span>&nbsp;<span class='ident'>Z533548</span>&nbsp;<span class='lexic'>(</span><span class='ident'>load</span>&nbsp;<span class='ident'>Z533537</span><span class='lexic'>))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>set</span>&nbsp;<span class='ident'>Z533535</span>&nbsp;<span class='lexic'>(</span><span class='ident'>reg</span>&nbsp;<span class='ident'>Z533548</span><span class='lexic'>))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>goto</span>&nbsp;<span class='ident'>tailrecentry</span><span class='lexic'>)</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>goto</span>&nbsp;<span class='ident'>Z533553</span><span class='lexic'>)</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>label</span>&nbsp;<span class='ident'>Z533553</span><span class='lexic'>)))</span><br>

</div><p>


<h3 id="ssa">Basic blocks</h3>

<p>Now everything is perfectly flat, so we can sort instructions into basic blocks. Also it's a right moment to
do another node split - separate compound expressions and leaf values, it will help to enforce the SSA guarantee
of not reassigning simple values (with the only exception of the $\varphi$ nodes, but this will be sorted out
later).

<p>Note that <b>tailapply</b> is gone now as it served its purpose already, replaced with
an <b>expr</b> node - it will be useful later when we have to annotate calls.

<p>This will be our main IR quite for a while now.


<p><div class='code'>
<span class='keyword'>ast</span>&nbsp;<span class='ident'>lang0flat2</span>&nbsp;<span class='lexic'>:</span>&nbsp;<span class='ident'>lang0flat1</span>&nbsp;<span class='lexic'>(</span><span class='ident'>stmt</span>&nbsp;&#8594;&nbsp;<span class='ident'>insn</span><span class='lexic'>)</span>&nbsp;<span class='keyword'>recform</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;<span class='ident'>top</span>&nbsp;<span class='lexic'>=</span>&nbsp;&nbsp;&nbsp;<span class='ident'>define</span><span class='lexic'>(</span><span class='ident'>ident</span><span class='lexic'>:</span><span class='ident'>id</span><span class='lexic'>,</span>&nbsp;<span class='ident'>code</span><span class='lexic'>:</span><span class='ident'>e</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>defconst</span><span class='lexic'>(</span><span class='ident'>ident</span><span class='lexic'>:</span><span class='ident'>id</span><span class='lexic'>,</span>&nbsp;<span class='ident'>value</span><span class='lexic'>:</span><span class='ident'>e</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>sfunction</span><span class='lexic'>(</span><span class='ident'>ident</span><span class='lexic'>:</span><span class='ident'>id</span><span class='lexic'>,</span>&nbsp;<span class='lexic'>*</span><span class='ident'>ident</span><span class='lexic'>:</span><span class='ident'>args</span><span class='lexic'>,</span>&nbsp;<span class='ident'>code</span><span class='lexic'>:</span><span class='ident'>body</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>closure</span><span class='lexic'>(</span><span class='ident'>ident</span><span class='lexic'>:</span><span class='ident'>id</span><span class='lexic'>,</span>&nbsp;<span class='lexic'>*</span><span class='ident'>ident</span><span class='lexic'>:</span><span class='ident'>clargs</span><span class='lexic'>,</span>&nbsp;<span class='lexic'>*</span><span class='ident'>ident</span><span class='lexic'>:</span><span class='ident'>args</span><span class='lexic'>,</span>&nbsp;<span class='ident'>code</span><span class='lexic'>:</span><span class='ident'>body</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>eval</span><span class='lexic'>(</span><span class='ident'>code</span><span class='lexic'>:</span><span class='ident'>e</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>debug</span><span class='lexic'>(.*</span><span class='ident'>any</span><span class='lexic'>:</span><span class='ident'>es</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>;</span><br>
&nbsp;&nbsp;<span class='ident'>code</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='ident'>c</span><span class='lexic'>(.*</span><span class='ident'>bblock</span><span class='lexic'>:</span><span class='ident'>bs</span><span class='lexic'>);</span><br>
&nbsp;&nbsp;<span class='ident'>bblock</span>&nbsp;<span class='lexic'>=</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='ident'>bb</span><span class='lexic'>(</span><span class='ident'>labident</span><span class='lexic'>:</span><span class='ident'>lbl</span><span class='lexic'>,</span>&nbsp;<span class='lexic'>*</span><span class='ident'>insn</span><span class='lexic'>:</span><span class='ident'>body</span><span class='lexic'>,</span>&nbsp;<span class='ident'>term</span><span class='lexic'>:</span><span class='ident'>t</span><span class='lexic'>);</span><br>
&nbsp;&nbsp;<span class='ident'>value</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='ident'>const</span><span class='lexic'>(</span><span class='ident'>const</span><span class='lexic'>:</span><span class='ident'>c</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>global</span><span class='lexic'>(</span><span class='ident'>ident</span><span class='lexic'>:</span><span class='ident'>id</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>arg</span><span class='lexic'>(</span><span class='ident'>ident</span><span class='lexic'>:</span><span class='ident'>id</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>clvar</span><span class='lexic'>(</span><span class='ident'>ident</span><span class='lexic'>:</span><span class='ident'>id</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>reg</span><span class='lexic'>(</span><span class='ident'>ident</span><span class='lexic'>:</span><span class='ident'>id</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>funref</span><span class='lexic'>(</span><span class='ident'>ident</span><span class='lexic'>:</span><span class='ident'>id</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>;</span><br>
&nbsp;&nbsp;<span class='ident'>expr</span>&nbsp;<span class='lexic'>=</span>&nbsp;&nbsp;<span class='ident'>mkclosure</span><span class='lexic'>(</span><span class='ident'>ident</span><span class='lexic'>:</span><span class='ident'>df</span><span class='lexic'>,</span>&nbsp;<span class='lexic'>*</span><span class='ident'>value</span><span class='lexic'>:</span><span class='ident'>args</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>apply</span><span class='lexic'>(</span><span class='ident'>bool</span><span class='lexic'>:</span><span class='ident'>purep</span><span class='lexic'>,</span>&nbsp;<span class='ident'>value</span><span class='lexic'>:</span><span class='ident'>fn</span><span class='lexic'>,</span>&nbsp;<span class='lexic'>.*</span><span class='ident'>value</span><span class='lexic'>:</span><span class='ident'>args</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>load</span><span class='lexic'>(</span><span class='ident'>ident</span><span class='lexic'>:</span><span class='ident'>id</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='comment'>//&nbsp;New&nbsp;nodes<br>
</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>phi</span><span class='lexic'>(.*</span><span class='ident'>phisrc</span><span class='lexic'>:</span><span class='ident'>ss</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>select</span><span class='lexic'>(</span><span class='ident'>value</span><span class='lexic'>:</span><span class='ident'>cnd</span><span class='lexic'>,</span>&nbsp;<span class='ident'>value</span><span class='lexic'>:</span><span class='ident'>tr</span><span class='lexic'>,</span>&nbsp;<span class='ident'>value</span><span class='lexic'>:</span><span class='ident'>fl</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='comment'>//&nbsp;Feedback&nbsp;only,&nbsp;not&nbsp;allowed&nbsp;for&nbsp;redefinitions<br>
</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>value</span><span class='lexic'>(</span><span class='ident'>value</span><span class='lexic'>:</span><span class='ident'>v</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>;</span><br>
&nbsp;&nbsp;<span class='ident'>phisrc</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='ident'>s</span><span class='lexic'>(</span><span class='ident'>labident</span><span class='lexic'>:</span><span class='ident'>from</span><span class='lexic'>,</span>&nbsp;<span class='ident'>value</span><span class='lexic'>:</span><span class='ident'>v</span><span class='lexic'>);</span><br>
&nbsp;&nbsp;<span class='ident'>insn</span>&nbsp;<span class='lexic'>=</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='ident'>alloca</span><span class='lexic'>(</span><span class='ident'>ident</span><span class='lexic'>:</span><span class='ident'>id</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>def</span><span class='lexic'>(</span><span class='ident'>ident</span><span class='lexic'>:</span><span class='ident'>id</span><span class='lexic'>,</span>&nbsp;<span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>v</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>set</span><span class='lexic'>(</span><span class='ident'>ident</span><span class='lexic'>:</span><span class='ident'>id</span><span class='lexic'>,</span>&nbsp;<span class='ident'>value</span><span class='lexic'>:</span><span class='ident'>v</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>;</span><br>
&nbsp;&nbsp;<span class='ident'>term</span>&nbsp;<span class='lexic'>=</span>&nbsp;&nbsp;<span class='ident'>tail</span><span class='lexic'>(</span><span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>e</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>goto</span><span class='lexic'>(</span><span class='ident'>labident</span><span class='lexic'>:</span><span class='ident'>id</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>gotoc</span><span class='lexic'>(</span><span class='ident'>value</span><span class='lexic'>:</span><span class='ident'>cnd</span><span class='lexic'>,</span>&nbsp;<span class='ident'>labident</span><span class='lexic'>:</span><span class='ident'>tr</span><span class='lexic'>,</span>&nbsp;<span class='ident'>labident</span><span class='lexic'>:</span><span class='ident'>fl</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>return</span><span class='lexic'>(</span><span class='ident'>value</span><span class='lexic'>:</span><span class='ident'>v</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>;</span><br>
&nbsp;&nbsp;<span class='ident'>hint</span>&nbsp;<span class='ident'>phisrc</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='ident'>newline</span><span class='lexic'>;</span><br>
&nbsp;&nbsp;<span class='ident'>hint</span>&nbsp;<span class='ident'>insn</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='ident'>newline</span><span class='lexic'>;</span><br>
&nbsp;&nbsp;<span class='ident'>hint</span>&nbsp;<span class='ident'>bblock</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='ident'>newline</span><span class='lexic'>;</span><br>
&nbsp;&nbsp;<span class='ident'>hint</span>&nbsp;<span class='ident'>term</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='ident'>newline</span><span class='lexic'>;</span><br>
&nbsp;&nbsp;<span class='ident'>hint</span>&nbsp;<span class='ident'>expr</span><span class='lexic'>:</span><span class='ident'>phi</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='ident'>itab</span><span class='lexic'>,</span>&nbsp;<span class='ident'>newline</span><span class='lexic'>;</span><br>
<span class='lexic'>}</span>
<p></div>



<p>First pass over a flat code is to eliminate redundancy: e.g., if there is a sequence of labels, only one
should remain (and be referred to), because a basic block can only have one name. If a terminal instruction
is following another terminal instruction, it is unreachable and must be eliminated.

<p>Once this filtering is done, rules for accumulating instructions into basic blocks are much simpler.


<p><div class='code'>
<span id='Z533554'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_seq_body</span><span class='lexic'>(</span><span id='Z533927'><span><span class='ident'>s</span></span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0flat1</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>stmt</span><span class='lexic'>:</span><span class='idfrom' onmouseenter='srcref_over("Z533927",this)' onmouseleave='srcref_leave("Z533927",this)'><span><span class='ident'>s</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>once</span>&nbsp;<span class='ident'>stmt</span>&nbsp;<span class='lexic'>{</span>&nbsp;<span id='Z534239'><span><span class='ident'>seq</span></span></span>&nbsp;&#8594;&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z534239",this)' onmouseleave='srcref_leave("Z534239",this)'><span><span class='ident'>body</span></span></span><span class='hint'>seq(body)</span></span>&nbsp;<span class='lexic'>|</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='withhint'><span class='ident'>ccerror</span><span class='hint'>function&nbsp;ccerror&nbsp;arg:&nbsp;<br>
Raises&nbsp;[MBaseException]&nbsp;with&nbsp;a&nbsp;given&nbsp;argument.</span></span><span class='lexic'>(</span><span class='symbol'>'IMPOSSIBLE'</span><span class='lexic'>())</span>&nbsp;<span class='lexic'>}}</span>
<p></div>



<p><div class='code'>
<span id='Z534360'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_classify_insn</span><span class='lexic'>(</span><span id='Z534733'><span><span class='ident'>i</span></span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0flat1</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>stmt</span><span class='lexic'>:</span><span class='idfrom' onmouseenter='srcref_over("Z534733",this)' onmouseleave='srcref_leave("Z534733",this)'><span><span class='ident'>i</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>once</span>&nbsp;<span class='ident'>stmt</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='ident'>tailapply</span>&nbsp;&#8594;&nbsp;<span class='symbol'>'term'</span><span class='lexic'>()</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>goto</span>&nbsp;&#8594;&nbsp;<span class='symbol'>'term'</span><span class='lexic'>()</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>gotoc</span>&nbsp;&#8594;&nbsp;<span class='symbol'>'term'</span><span class='lexic'>()</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>return</span>&nbsp;&#8594;&nbsp;<span class='symbol'>'term'</span><span class='lexic'>()</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>drop</span>&nbsp;&#8594;&nbsp;<span class='symbol'>'skip'</span><span class='lexic'>()</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span id='Z535066'><span><span class='ident'>label</span></span></span>&nbsp;&#8594;&nbsp;<span class='symbol'>'label'</span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z535066",this)' onmouseleave='srcref_leave("Z535066",this)'><span><span class='ident'>id</span></span></span><span class='hint'>label(id)</span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='symbol'>'insn'</span><span class='lexic'>()</span><span class='lexic'>}}</span>
<p></div>



<p><div class='code'>
<span id='Z535173'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_seq_sanitise</span><span class='lexic'>(</span><span id='Z535640'><span><span class='ident'>ss</span></span></span><span class='lexic'>)</span><br>
<span class='keyword'>collector</span><span class='lexic'>(</span><span id='Z535630'><span><span class='ident'>addinsn</span></span></span><span class='lexic'>,</span>&nbsp;<span id='Z535642'><span><span class='ident'>getinsns</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;<span id='Z535601'><span><span class='ident'>relabelht</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='ident'>mkhash</span><span class='lexic'>();</span><br>
&nbsp;&nbsp;<span id='Z535626'><span><span class='ident'>addlabelmap</span></span></span><span class='lexic'>(</span><span id='Z535602'><span><span class='ident'>f</span></span></span><span class='lexic'>,</span>&nbsp;<span id='Z535603'><span><span class='ident'>t</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='ident'>ohashput</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z535601",this)' onmouseleave='srcref_leave("Z535601",this)'><span><span class='ident'>relabelht</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z535602",this)' onmouseleave='srcref_leave("Z535602",this)'><span><span class='ident'>f</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z535603",this)' onmouseleave='srcref_leave("Z535603",this)'><span><span class='ident'>t</span></span></span><span class='lexic'>);</span><br>
&nbsp;&nbsp;<span class='keyword'>do</span>&nbsp;<span id='Z535628'><span><span class='ident'>loop</span></span></span><span class='lexic'>(</span><span id='Z535639'><span><span class='ident'>l</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z535640",this)' onmouseleave='srcref_leave("Z535640",this)'><span><span class='ident'>ss</span></span></span><span class='lexic'>,</span>&nbsp;<span id='Z535625'><span><span class='ident'>prevlbl</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='symbol'>'entry'</span><span class='lexic'>,</span>&nbsp;<span id='Z535633'><span><span class='ident'>prevterm</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='lexic'>&#8709;</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>match</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z535639",this)' onmouseleave='srcref_leave("Z535639",this)'><span><span class='ident'>l</span></span></span>&nbsp;<span class='keyword'>with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z535616'><span><span class='ident'><span class='pattern'>insn</span></span></span></span><span class='lexic'><span class='pattern'>:</span></span><span id='Z535629'><span><span class='ident'><span class='pattern'>rest</span></span></span></span>&nbsp;&#8594;&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z535638'><span><span class='ident'>class</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<a href='#Z534360'><span class='ident'>l0_classify_insn</span></a><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z535616",this)' onmouseleave='srcref_leave("Z535616",this)'><span><span class='ident'>insn</span></span></span><span class='lexic'>);</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>match</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z535638",this)' onmouseleave='srcref_leave("Z535638",this)'><span><span class='ident'>class</span></span></span>&nbsp;<span class='keyword'>with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='symbol'><span class='pattern'>'label'</span></span><span class='lexic'><span class='pattern'>(</span></span><span id='Z535627'><span><span class='ident'><span class='pattern'>id</span></span></span></span><span class='lexic'><span class='pattern'>)</span></span>&nbsp;&#8594;&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>if</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z535625",this)' onmouseleave='srcref_leave("Z535625",this)'><span><span class='ident'>prevlbl</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z535626",this)' onmouseleave='srcref_leave("Z535626",this)'><span><span class='ident'>addlabelmap</span></span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z535627",this)' onmouseleave='srcref_leave("Z535627",this)'><span><span class='ident'>id</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z535625",this)' onmouseleave='srcref_leave("Z535625",this)'><span><span class='ident'>prevlbl</span></span></span><span class='lexic'>);</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z535628",this)' onmouseleave='srcref_leave("Z535628",this)'><span><span class='ident'>loop</span></span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z535629",this)' onmouseleave='srcref_leave("Z535629",this)'><span><span class='ident'>rest</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z535625",this)' onmouseleave='srcref_leave("Z535625",this)'><span><span class='ident'>prevlbl</span></span></span><span class='lexic'>,</span>&nbsp;<span class='lexic'>&#8709;</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>}</span>&nbsp;<span class='keyword'>else</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z535630",this)' onmouseleave='srcref_leave("Z535630",this)'><span><span class='ident'>addinsn</span></span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z535616",this)' onmouseleave='srcref_leave("Z535616",this)'><span><span class='ident'>insn</span></span></span><span class='lexic'>);</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z535628",this)' onmouseleave='srcref_leave("Z535628",this)'><span><span class='ident'>loop</span></span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z535629",this)' onmouseleave='srcref_leave("Z535629",this)'><span><span class='ident'>rest</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z535627",this)' onmouseleave='srcref_leave("Z535627",this)'><span><span class='ident'>id</span></span></span><span class='lexic'>,</span>&nbsp;<span class='lexic'>&#8709;</span><span class='lexic'>)}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='symbol'><span class='pattern'>'term'</span></span><span class='lexic'><span class='pattern'>()</span></span>&nbsp;&#8594;&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>if</span>&nbsp;<span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z535633",this)' onmouseleave='srcref_leave("Z535633",this)'><span><span class='ident'>prevterm</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z535628",this)' onmouseleave='srcref_leave("Z535628",this)'><span><span class='ident'>loop</span></span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z535629",this)' onmouseleave='srcref_leave("Z535629",this)'><span><span class='ident'>rest</span></span></span><span class='lexic'>,</span>&nbsp;<span class='lexic'>&#8709;</span><span class='lexic'>,</span>&nbsp;<span class='keyword'>true</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>}</span>&nbsp;<span class='keyword'>else</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z535630",this)' onmouseleave='srcref_leave("Z535630",this)'><span><span class='ident'>addinsn</span></span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z535616",this)' onmouseleave='srcref_leave("Z535616",this)'><span><span class='ident'>insn</span></span></span><span class='lexic'>);</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z535628",this)' onmouseleave='srcref_leave("Z535628",this)'><span><span class='ident'>loop</span></span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z535629",this)' onmouseleave='srcref_leave("Z535629",this)'><span><span class='ident'>rest</span></span></span><span class='lexic'>,</span>&nbsp;<span class='lexic'>&#8709;</span><span class='lexic'>,</span>&nbsp;<span class='keyword'>true</span><span class='lexic'>)}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='symbol'><span class='pattern'>'skip'</span></span><span class='lexic'><span class='pattern'>()</span></span>&nbsp;&#8594;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z535628",this)' onmouseleave='srcref_leave("Z535628",this)'><span><span class='ident'>loop</span></span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z535629",this)' onmouseleave='srcref_leave("Z535629",this)'><span><span class='ident'>rest</span></span></span><span class='lexic'>,</span>&nbsp;<span class='lexic'>&#8709;</span><span class='lexic'>,</span>&nbsp;<span class='lexic'>&#8709;</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='symbol'><span class='pattern'>'insn'</span></span><span class='lexic'><span class='pattern'>()</span></span>&nbsp;&#8594;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>if</span>&nbsp;<span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z535633",this)' onmouseleave='srcref_leave("Z535633",this)'><span><span class='ident'>prevterm</span></span></span><span class='lexic'>)</span>&nbsp;<span class='withhint'><span class='ident'>ccerror</span><span class='hint'>function&nbsp;ccerror&nbsp;arg:&nbsp;<br>
Raises&nbsp;[MBaseException]&nbsp;with&nbsp;a&nbsp;given&nbsp;argument.</span></span><span class='lexic'>(</span><span class='symbol'>'IMPOSSIBLE'</span><span class='lexic'>())</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>else</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z535630",this)' onmouseleave='srcref_leave("Z535630",this)'><span><span class='ident'>addinsn</span></span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z535616",this)' onmouseleave='srcref_leave("Z535616",this)'><span><span class='ident'>insn</span></span></span><span class='lexic'>);</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z535628",this)' onmouseleave='srcref_leave("Z535628",this)'><span><span class='ident'>loop</span></span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z535629",this)' onmouseleave='srcref_leave("Z535629",this)'><span><span class='ident'>rest</span></span></span><span class='lexic'>,</span>&nbsp;<span class='lexic'>&#8709;</span><span class='lexic'>,</span>&nbsp;<span class='lexic'>&#8709;</span><span class='lexic'>)}}}</span><span class='lexic'>;</span><br>
&nbsp;&nbsp;<span id='Z535646'><span><span class='ident'>ss0</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z535642",this)' onmouseleave='srcref_leave("Z535642",this)'><span><span class='ident'>getinsns</span></span></span><span class='lexic'>();</span><br>
&nbsp;&nbsp;<span class='comment'>//&nbsp;Rename&nbsp;goto&nbsp;targets&nbsp;since&nbsp;we&nbsp;eliminated&nbsp;redundant&nbsp;labels<br>
</span>&nbsp;&nbsp;<span class='keyword'>return</span>&nbsp;<span class='keyword'>map</span>&nbsp;<span id='Z535659'><span><span class='ident'>s</span></span></span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z535646",this)' onmouseleave='srcref_leave("Z535646",this)'><span><span class='ident'>ss0</span></span></span>&nbsp;<span class='keyword'>do</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z535998'><span><span class='ident'>fixlabel</span></span></span><span class='lexic'>(</span><span id='Z535653'><span><span class='ident'>lbl</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>=</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>aif</span><span class='lexic'>(</span><span class='ident'>chk</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='ident'>ohashget</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z535601",this)' onmouseleave='srcref_leave("Z535601",this)'><span><span class='ident'>relabelht</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z535653",this)' onmouseleave='srcref_leave("Z535653",this)'><span><span class='ident'>lbl</span></span></span><span class='lexic'>))</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>return</span>&nbsp;<span class='ident'>chk</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>}</span>&nbsp;<span class='keyword'>else</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z535653",this)' onmouseleave='srcref_leave("Z535653",this)'><span><span class='ident'>lbl</span></span></span><span class='lexic'>;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0flat1</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>stmt</span><span class='lexic'>:</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z535659",this)' onmouseleave='srcref_leave("Z535659",this)'><span><span class='ident'>s</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>stmt</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z535999'><span><span class='ident'>goto</span></span></span>&nbsp;&#8594;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='keyword'>node</span><span class='hint'>lang0flat1:stmt:goto(id)</span></span><span class='lexic'>(</span><span class='ident'>id</span><span class='lexic'>=</span><span class='idfrom' onmouseenter='srcref_over("Z535998",this)' onmouseleave='srcref_leave("Z535998",this)'><span><span class='ident'>fixlabel</span></span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z535999",this)' onmouseleave='srcref_leave("Z535999",this)'><span><span class='ident'>id</span></span></span><span class='hint'>goto(id)</span></span><span class='lexic'>))</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;&nbsp;<span id='Z536029'><span><span class='ident'>gotoc</span></span></span>&nbsp;&#8594;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='keyword'>node</span><span class='hint'>lang0flat1:stmt:gotoc(cnd,tr,fl)<br>
&nbsp;&nbsp;&nbsp;with&nbsp;implicit&nbsp;arguments:&nbsp;cnd<br>
</span></span><span class='lexic'>(</span><span class='ident'>tr</span><span class='lexic'>=</span><span class='idfrom' onmouseenter='srcref_over("Z535998",this)' onmouseleave='srcref_leave("Z535998",this)'><span><span class='ident'>fixlabel</span></span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z536029",this)' onmouseleave='srcref_leave("Z536029",this)'><span><span class='ident'>tr</span></span></span><span class='hint'>gotoc(cnd,tr,fl)</span></span><span class='lexic'>),</span>&nbsp;<span class='ident'>fl</span><span class='lexic'>=</span><span class='idfrom' onmouseenter='srcref_over("Z535998",this)' onmouseleave='srcref_leave("Z535998",this)'><span><span class='ident'>fixlabel</span></span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z536029",this)' onmouseleave='srcref_leave("Z536029",this)'><span><span class='ident'>fl</span></span></span><span class='hint'>gotoc(cnd,tr,fl)</span></span><span class='lexic'>))</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;&nbsp;<span class='keyword'>else</span>&nbsp;&nbsp;&#8594;&nbsp;<span class='ident'>node</span><span class='lexic'>()}}}}</span>
<p></div>



<p><div class='code'>
<span id='Z536179'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_flat2</span><span class='lexic'>(</span><span id='Z536705'><span><span class='ident'>i</span></span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0flat1</span>&nbsp;<span class='lexic'>/rec,</span>&nbsp;<span class='lexic'>dst</span>&nbsp;<span class='ident'>lang0flat2</span><span class='lexic'>/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>stmt</span><span class='lexic'>:</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z536705",this)' onmouseleave='srcref_leave("Z536705",this)'><span><span class='ident'>i</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>stmt</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='ident'>tailapply</span>&nbsp;&#8594;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>term</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>tail</span><span class='hint'>lang0flat2:term:tail(e)</span></span><span class='lexic'>(</span><span class='ident'>mk</span><span class='lexic'>:</span><span class='ident'>expr</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>apply</span><span class='hint'>lang0flat2:expr:apply(purep,fn,args)<br>
&nbsp;&nbsp;&nbsp;with&nbsp;implicit&nbsp;arguments:&nbsp;fn,&nbsp;args<br>
</span></span><span class='lexic'>(</span><span class='ident'>purep</span><span class='lexic'>=</span><span class='lexic'>&#8709;</span><span class='lexic'>))</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>goto</span>&nbsp;&#8594;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>term</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>goto</span><span class='hint'>lang0flat2:term:goto(id)</span></span><span class='lexic'>()</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>gotoc</span>&nbsp;&#8594;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>term</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>gotoc</span><span class='hint'>lang0flat2:term:gotoc(cnd,tr,fl)</span></span><span class='lexic'>()</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>return</span>&nbsp;&#8594;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>term</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>return</span><span class='hint'>lang0flat2:term:return(v)</span></span><span class='lexic'>()</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>label</span>&nbsp;&#8594;&nbsp;<span class='withhint'><span class='ident'>ccerror</span><span class='hint'>function&nbsp;ccerror&nbsp;arg:&nbsp;<br>
Raises&nbsp;[MBaseException]&nbsp;with&nbsp;a&nbsp;given&nbsp;argument.</span></span><span class='lexic'>(</span><span class='symbol'>'IMPOSSIBLE'</span><span class='lexic'>())</span><br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>alloca</span>&nbsp;&#8594;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>insn</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>alloca</span><span class='hint'>lang0flat2:insn:alloca(id)</span></span><span class='lexic'>()</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>def</span>&nbsp;&#8594;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>insn</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>def</span><span class='hint'>lang0flat2:insn:def(id,v)</span></span><span class='lexic'>()</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>set</span>&nbsp;&#8594;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>insn</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>set</span><span class='hint'>lang0flat2:insn:set(id,v)</span></span><span class='lexic'>()</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>drop</span>&nbsp;&#8594;&nbsp;<span class='withhint'><span class='ident'>ccerror</span><span class='hint'>function&nbsp;ccerror&nbsp;arg:&nbsp;<br>
Raises&nbsp;[MBaseException]&nbsp;with&nbsp;a&nbsp;given&nbsp;argument.</span></span><span class='lexic'>(</span><span class='symbol'>'IMPOSSIBLE'</span><span class='lexic'>())</span><span class='lexic'>};</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>expr</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='ident'>const</span>&nbsp;&#8594;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>value</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>const</span><span class='hint'>lang0flat2:value:const(c)</span></span><span class='lexic'>()</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>global</span>&nbsp;&#8594;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>value</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>global</span><span class='hint'>lang0flat2:value:global(id)</span></span><span class='lexic'>()</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>arg</span>&nbsp;&#8594;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>value</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>arg</span><span class='hint'>lang0flat2:value:arg(id)</span></span><span class='lexic'>()</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>clvar</span>&nbsp;&#8594;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>value</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>clvar</span><span class='hint'>lang0flat2:value:clvar(id)</span></span><span class='lexic'>()</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>reg</span>&nbsp;&#8594;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>value</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>reg</span><span class='hint'>lang0flat2:value:reg(id)</span></span><span class='lexic'>()</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>funref</span>&nbsp;&#8594;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>value</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>funref</span><span class='hint'>lang0flat2:value:funref(id)</span></span><span class='lexic'>()</span><br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>mkclosure</span>&nbsp;&#8594;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>expr</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>mkclosure</span><span class='hint'>lang0flat2:expr:mkclosure(df,args)</span></span><span class='lexic'>()</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>apply</span>&nbsp;&#8594;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>expr</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>apply</span><span class='hint'>lang0flat2:expr:apply(purep,fn,args)<br>
&nbsp;&nbsp;&nbsp;with&nbsp;implicit&nbsp;arguments:&nbsp;fn,&nbsp;args<br>
</span></span><span class='lexic'>(</span><span class='ident'>purep</span><span class='lexic'>=</span><span class='lexic'>&#8709;</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>load</span>&nbsp;&#8594;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>expr</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>load</span><span class='hint'>lang0flat2:expr:load(id)</span></span><span class='lexic'>()</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>}}</span>
<p></div>



<p><div class='code'>
<span id='Z537256'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_basic_blocks_stmts</span><span class='lexic'>(</span><span id='Z537302'><span><span class='ident'>s</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;<span id='Z537367'><span><span class='ident'>ss</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<a href='#Z535173'><span class='ident'>l0_seq_sanitise</span></a><span class='lexic'>(</span><a href='#Z533554'><span class='ident'>l0_seq_body</span></a><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z537302",this)' onmouseleave='srcref_leave("Z537302",this)'><span><span class='ident'>s</span></span></span><span class='lexic'>));</span><br>
&nbsp;&nbsp;<span class='keyword'>collector</span><span class='lexic'>(</span><span id='Z537336'><span><span class='ident'>bbadd</span></span></span><span class='lexic'>,</span>&nbsp;<span id='Z537371'><span><span class='ident'>bbget</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>do</span>&nbsp;<span id='Z537355'><span><span class='ident'>loop</span></span></span><span class='lexic'>(</span><span id='Z537366'><span><span class='ident'>l</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z537367",this)' onmouseleave='srcref_leave("Z537367",this)'><span><span class='ident'>ss</span></span></span><span class='lexic'>,</span>&nbsp;<span id='Z537324'><span><span class='ident'>bb</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='symbol'>'entry'</span><span class='lexic'>,</span>&nbsp;<span id='Z537328'><span><span class='ident'>insns</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='lexic'>&#8709;</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z537364'><span><span class='ident'>flush</span></span></span><span class='lexic'>(</span><span id='Z537332'><span><span class='ident'>term</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='keyword'>with</span>&nbsp;<span class='keyword'>target</span><span class='lexic'>(</span><span class='ident'>lang0flat2</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z537337'><span><span class='ident'>bb</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>bblock</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>bb</span><span class='hint'>lang0flat2:bblock:bb(lbl,body,t)</span></span><span class='lexic'>(</span><span class='ident'>lbl</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z537324",this)' onmouseleave='srcref_leave("Z537324",this)'><span><span class='ident'>bb</span></span></span><span class='lexic'>,</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='ident'>body</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='keyword'>map</span>&nbsp;<span id='Z537331'><span><span class='ident'>i</span></span></span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z537328",this)' onmouseleave='srcref_leave("Z537328",this)'><span><span class='ident'>insns</span></span></span>&nbsp;<span class='keyword'>do</span>&nbsp;<a href='#Z536179'><span class='ident'>l0_flat2</span></a><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z537331",this)' onmouseleave='srcref_leave("Z537331",this)'><span><span class='ident'>i</span></span></span><span class='lexic'>),</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='ident'>t</span>&nbsp;<span class='lexic'>=</span>&nbsp;<a href='#Z536179'><span class='ident'>l0_flat2</span></a><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z537332",this)' onmouseleave='srcref_leave("Z537332",this)'><span><span class='ident'>term</span></span></span><span class='lexic'>));</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z537336",this)' onmouseleave='srcref_leave("Z537336",this)'><span><span class='ident'>bbadd</span></span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z537337",this)' onmouseleave='srcref_leave("Z537337",this)'><span><span class='ident'>bb</span></span></span><span class='lexic'>)};</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>match</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z537366",this)' onmouseleave='srcref_leave("Z537366",this)'><span><span class='ident'>l</span></span></span>&nbsp;<span class='keyword'>with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z537346'><span><span class='ident'><span class='pattern'>insn</span></span></span></span><span class='lexic'><span class='pattern'>:</span></span><span id='Z537356'><span><span class='ident'><span class='pattern'>rest</span></span></span></span>&nbsp;&#8594;&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z537365'><span><span class='ident'>class</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<a href='#Z534360'><span class='ident'>l0_classify_insn</span></a><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z537346",this)' onmouseleave='srcref_leave("Z537346",this)'><span><span class='ident'>insn</span></span></span><span class='lexic'>);</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>match</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z537365",this)' onmouseleave='srcref_leave("Z537365",this)'><span><span class='ident'>class</span></span></span>&nbsp;<span class='keyword'>with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='symbol'><span class='pattern'>'label'</span></span><span class='lexic'><span class='pattern'>(</span></span><span id='Z537357'><span><span class='ident'><span class='pattern'>id</span></span></span></span><span class='lexic'><span class='pattern'>)</span></span>&nbsp;&#8594;&nbsp;<span class='lexic'>{</span>&nbsp;<span class='comment'>//&nbsp;Assuming&nbsp;no&nbsp;flocking&nbsp;labels&nbsp;left<br>
</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>if</span>&nbsp;<span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z537328",this)' onmouseleave='srcref_leave("Z537328",this)'><span><span class='ident'>insns</span></span></span><span class='lexic'>)</span>&nbsp;<span class='withhint'><span class='ident'>ccerror</span><span class='hint'>function&nbsp;ccerror&nbsp;arg:&nbsp;<br>
Raises&nbsp;[MBaseException]&nbsp;with&nbsp;a&nbsp;given&nbsp;argument.</span></span><span class='lexic'>(</span><span class='symbol'>'IMPOSSIBLE'</span><span class='lexic'>());</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z537355",this)' onmouseleave='srcref_leave("Z537355",this)'><span><span class='ident'>loop</span></span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z537356",this)' onmouseleave='srcref_leave("Z537356",this)'><span><span class='ident'>rest</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z537357",this)' onmouseleave='srcref_leave("Z537357",this)'><span><span class='ident'>id</span></span></span><span class='lexic'>,</span>&nbsp;<span class='lexic'>&#8709;</span><span class='lexic'>)}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='symbol'><span class='pattern'>'insn'</span></span><span class='lexic'><span class='pattern'>()</span></span>&nbsp;&#8594;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z537355",this)' onmouseleave='srcref_leave("Z537355",this)'><span><span class='ident'>loop</span></span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z537356",this)' onmouseleave='srcref_leave("Z537356",this)'><span><span class='ident'>rest</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z537324",this)' onmouseleave='srcref_leave("Z537324",this)'><span><span class='ident'>bb</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z537328",this)' onmouseleave='srcref_leave("Z537328",this)'><span><span class='ident'>insns</span></span></span>&nbsp;<span class='lexic'>&#8853;</span>&nbsp;<span class='lexic'>[</span><span class='idfrom' onmouseenter='srcref_over("Z537346",this)' onmouseleave='srcref_leave("Z537346",this)'><span><span class='ident'>insn</span></span></span><span class='lexic'>])</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='symbol'><span class='pattern'>'skip'</span></span><span class='lexic'><span class='pattern'>()</span></span>&nbsp;&#8594;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z537355",this)' onmouseleave='srcref_leave("Z537355",this)'><span><span class='ident'>loop</span></span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z537356",this)' onmouseleave='srcref_leave("Z537356",this)'><span><span class='ident'>rest</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z537324",this)' onmouseleave='srcref_leave("Z537324",this)'><span><span class='ident'>bb</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z537328",this)' onmouseleave='srcref_leave("Z537328",this)'><span><span class='ident'>insns</span></span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='symbol'><span class='pattern'>'term'</span></span><span class='lexic'><span class='pattern'>()</span></span>&nbsp;&#8594;&nbsp;<span class='lexic'>{</span><span class='idfrom' onmouseenter='srcref_over("Z537364",this)' onmouseleave='srcref_leave("Z537364",this)'><span><span class='ident'>flush</span></span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z537346",this)' onmouseleave='srcref_leave("Z537346",this)'><span><span class='ident'>insn</span></span></span><span class='lexic'>);</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z537355",this)' onmouseleave='srcref_leave("Z537355",this)'><span><span class='ident'>loop</span></span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z537356",this)' onmouseleave='srcref_leave("Z537356",this)'><span><span class='ident'>rest</span></span></span><span class='lexic'>,</span>&nbsp;<span class='lexic'>&#8709;</span><span class='lexic'>,</span>&nbsp;<span class='lexic'>&#8709;</span><span class='lexic'>)}}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='lexic'><span class='pattern'>&#8709;</span></span>&nbsp;&#8594;&nbsp;<span class='lexic'>{</span><span class='keyword'>if</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z537328",this)' onmouseleave='srcref_leave("Z537328",this)'><span><span class='ident'>insns</span></span></span><span class='lexic'>)</span>&nbsp;<span class='withhint'><span class='ident'>ccerror</span><span class='hint'>function&nbsp;ccerror&nbsp;arg:&nbsp;<br>
Raises&nbsp;[MBaseException]&nbsp;with&nbsp;a&nbsp;given&nbsp;argument.</span></span><span class='lexic'>(</span><span class='symbol'>'IMPOSSIBLE'</span><span class='lexic'>())}}</span><span class='lexic'>;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>with</span>&nbsp;<span class='keyword'>target</span>&nbsp;<span class='lexic'>(</span><span class='ident'>lang0flat2</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>return</span>&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>code</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>c</span><span class='hint'>lang0flat2:code:c(bs)</span></span><span class='lexic'>(</span><span class='ident'>bs</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z537371",this)' onmouseleave='srcref_leave("Z537371",this)'><span><span class='ident'>bbget</span></span></span><span class='lexic'>())}}}</span>
<p></div>



<p><div class='code'>
<span id='Z537434'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_basic_blocks</span><span class='lexic'>(</span><span id='Z537930'><span><span class='ident'>ts</span></span></span><span class='lexic'>)</span>&nbsp;<br>
&nbsp;&nbsp;<span class='keyword'>map</span>&nbsp;<span id='Z537938'><span><span class='ident'>t</span></span></span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z537930",this)' onmouseleave='srcref_leave("Z537930",this)'><span><span class='ident'>ts</span></span></span>&nbsp;<span class='keyword'>do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0flat1</span>&nbsp;<span class='lexic'>/rec,</span>&nbsp;<span class='lexic'>dst</span>&nbsp;<span class='ident'>lang0flat2</span><span class='lexic'>/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>top</span><span class='lexic'>:</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z537938",this)' onmouseleave='srcref_leave("Z537938",this)'><span><span class='ident'>t</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>once</span>&nbsp;<span class='ident'>stmt</span>&nbsp;<span class='lexic'>{</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<a href='#Z537256'><span class='ident'>l0_basic_blocks_stmts</span></a><span class='lexic'>(</span><span class='ident'>node</span><span class='lexic'>())</span>&nbsp;<span class='lexic'>}}</span>
<p></div>








The code after basic blocks extraction and before the generic SSA transform is
following:


<p><div class='democode'>
<span class='lexic'>(</span><span class='ident'>sfunction</span>&nbsp;<span class='keyword'>foldl</span>&nbsp;<span class='lexic'>(</span><span class='ident'>Z540100</span>&nbsp;<span class='ident'>Z540101</span>&nbsp;<span class='ident'>Z540102</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>(</span><span class='ident'>c</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>bb</span>&nbsp;<span class='ident'>entry</span>&nbsp;<span class='lexic'>(</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>alloca</span>&nbsp;<span class='ident'>Z540100</span><span class='lexic'>)</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>alloca</span>&nbsp;<span class='ident'>Z540101</span><span class='lexic'>)</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>alloca</span>&nbsp;<span class='ident'>Z540102</span><span class='lexic'>)</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>set</span>&nbsp;<span class='ident'>Z540100</span>&nbsp;<span class='lexic'>(</span><span class='ident'>arg</span>&nbsp;<span class='ident'>Z540100</span><span class='lexic'>))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>set</span>&nbsp;<span class='ident'>Z540101</span>&nbsp;<span class='lexic'>(</span><span class='ident'>arg</span>&nbsp;<span class='ident'>Z540101</span><span class='lexic'>))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>set</span>&nbsp;<span class='ident'>Z540102</span>&nbsp;<span class='lexic'>(</span><span class='ident'>arg</span>&nbsp;<span class='ident'>Z540102</span><span class='lexic'>)))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>goto</span>&nbsp;<span class='ident'>tailrecentry</span><span class='lexic'>))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>bb</span>&nbsp;<span class='ident'>tailrecentry</span>&nbsp;<span class='lexic'>(</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>alloca</span>&nbsp;<span class='ident'>Z540103</span><span class='lexic'>)</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>alloca</span>&nbsp;<span class='ident'>Z540104</span><span class='lexic'>)</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>def</span>&nbsp;<span class='ident'>Z540117</span>&nbsp;<span class='lexic'>(</span><span class='ident'>load</span>&nbsp;<span class='ident'>Z540102</span><span class='lexic'>))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>def</span>&nbsp;<span class='ident'>Z540116</span>&nbsp;<span class='lexic'>(</span><span class='keyword'>apply</span>&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>global</span>&nbsp;<span class='ident'>nullp</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>(</span><span class='ident'>reg</span>&nbsp;<span class='ident'>Z540117</span><span class='lexic'>))))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>gotoc</span>&nbsp;<span class='lexic'>(</span><span class='ident'>reg</span>&nbsp;<span class='ident'>Z540116</span><span class='lexic'>)</span>&nbsp;<span class='ident'>Z540118</span>&nbsp;<span class='ident'>Z540119</span><span class='lexic'>))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>bb</span>&nbsp;<span class='ident'>Z540118</span>&nbsp;<span class='lexic'>(</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>def</span>&nbsp;<span class='ident'>Z540105</span>&nbsp;<span class='lexic'>(</span><span class='ident'>load</span>&nbsp;<span class='ident'>Z540101</span><span class='lexic'>)))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(return</span>&nbsp;<span class='lexic'>(</span><span class='ident'>reg</span>&nbsp;<span class='ident'>Z540105</span><span class='lexic'>)))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>bb</span>&nbsp;<span class='ident'>Z540119</span>&nbsp;<span class='lexic'>(</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>def</span>&nbsp;<span class='ident'>Z540107</span>&nbsp;<span class='lexic'>(</span><span class='ident'>load</span>&nbsp;<span class='ident'>Z540102</span><span class='lexic'>))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>def</span>&nbsp;<span class='ident'>Z540106</span>&nbsp;<span class='lexic'>(</span><span class='keyword'>apply</span>&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>global</span>&nbsp;<span class='ident'>head</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>(</span><span class='ident'>reg</span>&nbsp;<span class='ident'>Z540107</span><span class='lexic'>)))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>set</span>&nbsp;<span class='ident'>Z540103</span>&nbsp;<span class='lexic'>(</span><span class='ident'>reg</span>&nbsp;<span class='ident'>Z540106</span><span class='lexic'>))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>def</span>&nbsp;<span class='ident'>Z540109</span>&nbsp;<span class='lexic'>(</span><span class='ident'>load</span>&nbsp;<span class='ident'>Z540102</span><span class='lexic'>))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>def</span>&nbsp;<span class='ident'>Z540108</span>&nbsp;<span class='lexic'>(</span><span class='keyword'>apply</span>&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>global</span>&nbsp;<span class='ident'>tail</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>(</span><span class='ident'>reg</span>&nbsp;<span class='ident'>Z540109</span><span class='lexic'>)))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>set</span>&nbsp;<span class='ident'>Z540104</span>&nbsp;<span class='lexic'>(</span><span class='ident'>reg</span>&nbsp;<span class='ident'>Z540108</span><span class='lexic'>))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>def</span>&nbsp;<span class='ident'>Z540110</span>&nbsp;<span class='lexic'>(</span><span class='ident'>load</span>&nbsp;<span class='ident'>Z540100</span><span class='lexic'>))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>set</span>&nbsp;<span class='ident'>Z540100</span>&nbsp;<span class='lexic'>(</span><span class='ident'>reg</span>&nbsp;<span class='ident'>Z540110</span><span class='lexic'>))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>def</span>&nbsp;<span class='ident'>Z540112</span>&nbsp;<span class='lexic'>(</span><span class='ident'>load</span>&nbsp;<span class='ident'>Z540100</span><span class='lexic'>))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>def</span>&nbsp;<span class='ident'>Z540113</span>&nbsp;<span class='lexic'>(</span><span class='ident'>load</span>&nbsp;<span class='ident'>Z540101</span><span class='lexic'>))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>def</span>&nbsp;<span class='ident'>Z540114</span>&nbsp;<span class='lexic'>(</span><span class='ident'>load</span>&nbsp;<span class='ident'>Z540103</span><span class='lexic'>))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>def</span>&nbsp;<span class='ident'>Z540111</span>&nbsp;<span class='lexic'>(</span><span class='keyword'>apply</span>&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>reg</span>&nbsp;<span class='ident'>Z540112</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>(</span><span class='ident'>reg</span>&nbsp;<span class='ident'>Z540113</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>(</span><span class='ident'>reg</span>&nbsp;<span class='ident'>Z540114</span><span class='lexic'>)))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>set</span>&nbsp;<span class='ident'>Z540101</span>&nbsp;<span class='lexic'>(</span><span class='ident'>reg</span>&nbsp;<span class='ident'>Z540111</span><span class='lexic'>))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>def</span>&nbsp;<span class='ident'>Z540115</span>&nbsp;<span class='lexic'>(</span><span class='ident'>load</span>&nbsp;<span class='ident'>Z540104</span><span class='lexic'>))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>set</span>&nbsp;<span class='ident'>Z540102</span>&nbsp;<span class='lexic'>(</span><span class='ident'>reg</span>&nbsp;<span class='ident'>Z540115</span><span class='lexic'>)))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>goto</span>&nbsp;<span class='ident'>tailrecentry</span><span class='lexic'>))))</span><br>

</div><p>





<h2>Generic SSA</h2>

<p>Now we're all set for an SSA--transform (i.e., memory $\to$ register). For this we'll use a specific
simplified IR, not to be confused with a more complex <i>Abstract SSA</i> we'll use later.




<p><div class='code'>
<span id='Z540121'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_to_genssa</span><span class='lexic'>(</span><span id='Z541599'><span><span class='ident'>c</span></span></span><span class='lexic'>)</span><br>
<span class='keyword'>collector</span><span class='lexic'>(</span><span id='Z541124'><span><span class='ident'>liftadd</span></span></span><span class='lexic'>,</span>&nbsp;<span id='Z541986'><span><span class='ident'>liftget</span></span></span><span class='lexic'>)</span><br>
<span class='keyword'>collector</span><span class='lexic'>(</span><span id='Z542009'><span><span class='ident'>addalloca</span></span></span><span class='lexic'>,</span>&nbsp;<span id='Z542107'><span><span class='ident'>getallocas</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;<span id='Z541114'><span><span class='ident'>vals</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='ident'>mkhash</span><span class='lexic'>();</span><br>
&nbsp;&nbsp;&nbsp;<span id='Z541121'><span><span class='ident'>addval</span></span></span><span class='lexic'>(</span><span id='Z541115'><span><span class='ident'>nm</span></span></span><span class='lexic'>,</span>&nbsp;<span id='Z541116'><span><span class='ident'>v</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='ident'>ohashput</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z541114",this)' onmouseleave='srcref_leave("Z541114",this)'><span><span class='ident'>vals</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z541115",this)' onmouseleave='srcref_leave("Z541115",this)'><span><span class='ident'>nm</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z541116",this)' onmouseleave='srcref_leave("Z541116",this)'><span><span class='ident'>v</span></span></span><span class='lexic'>);</span><br>
&nbsp;&nbsp;&nbsp;<span id='Z542079'><span><span class='ident'>newlift</span></span></span><span class='lexic'>(</span><span id='Z541123'><span><span class='ident'>v</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>=</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>symbols</span><span class='lexic'>(</span><span id='Z541122'><span><span class='ident'>id</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z541121",this)' onmouseleave='srcref_leave("Z541121",this)'><span><span class='ident'>addval</span></span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z541122",this)' onmouseleave='srcref_leave("Z541122",this)'><span><span class='ident'>id</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z541123",this)' onmouseleave='srcref_leave("Z541123",this)'><span><span class='ident'>v</span></span></span><span class='lexic'>);</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z541124",this)' onmouseleave='srcref_leave("Z541124",this)'><span><span class='ident'>liftadd</span></span></span><span class='lexic'>([</span><span class='idfrom' onmouseenter='srcref_over("Z541122",this)' onmouseleave='srcref_leave("Z541122",this)'><span><span class='ident'>id</span></span></span><span class='lexic'>;</span><span class='symbol'>'use'</span><span class='lexic'>()]);</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z541122",this)' onmouseleave='srcref_leave("Z541122",this)'><span><span class='ident'>id</span></span></span>&nbsp;<span class='lexic'>};</span><br>
&nbsp;&nbsp;&nbsp;<span id='Z541475'><span><span class='ident'>getexitsterm</span></span></span><span class='lexic'>(</span><span id='Z541141'><span><span class='ident'>t</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>=</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>collector</span><span class='lexic'>(</span><span id='Z541296'><span><span class='ident'>add</span></span></span><span class='lexic'>,</span>&nbsp;<span id='Z541369'><span><span class='ident'>get</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0flat2</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>term</span><span class='lexic'>:</span><span class='idfrom' onmouseenter='srcref_over("Z541141",this)' onmouseleave='srcref_leave("Z541141",this)'><span><span class='ident'>t</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>once</span>&nbsp;<span class='ident'>labident</span>&nbsp;<span class='lexic'>:</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z541296",this)' onmouseleave='srcref_leave("Z541296",this)'><span><span class='ident'>add</span></span></span><span class='lexic'>(</span><span class='ident'>thisnodesrc</span><span class='lexic'>())};</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>return</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z541369",this)' onmouseleave='srcref_leave("Z541369",this)'><span><span class='ident'>get</span></span></span><span class='lexic'>()};</span><br>
&nbsp;&nbsp;&nbsp;<span id='Z542005'><span><span class='ident'>getbbexits</span></span></span><span class='lexic'>(</span><span id='Z541386'><span><span class='ident'>bb</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='keyword'>collector</span><span class='lexic'>(</span><span id='Z541474'><span><span class='ident'>add</span></span></span><span class='lexic'>,</span>&nbsp;<span id='Z541499'><span><span class='ident'>get</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0flat2</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>bblock</span><span class='lexic'>:</span><span class='idfrom' onmouseenter='srcref_over("Z541386",this)' onmouseleave='srcref_leave("Z541386",this)'><span><span class='ident'>bb</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>once</span>&nbsp;<span class='ident'>term</span>&nbsp;<span class='lexic'>{</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z541474",this)' onmouseleave='srcref_leave("Z541474",this)'><span><span class='ident'>add</span></span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z541475",this)' onmouseleave='srcref_leave("Z541475",this)'><span><span class='ident'>getexitsterm</span></span></span><span class='lexic'>(</span><span class='ident'>node</span><span class='lexic'>()))}};</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>return</span>&nbsp;<span class='ident'>car</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z541499",this)' onmouseleave='srcref_leave("Z541499",this)'><span><span class='ident'>get</span></span></span><span class='lexic'>())};</span><br>
&nbsp;&nbsp;&nbsp;<span id='Z542002'><span><span class='ident'>getcode</span></span></span><span class='lexic'>(</span><span id='Z541508'><span><span class='ident'>t</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>=</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0flat2</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>term</span><span class='lexic'>:</span><span class='idfrom' onmouseenter='srcref_over("Z541508",this)' onmouseleave='srcref_leave("Z541508",this)'><span><span class='ident'>t</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>once</span>&nbsp;<span class='ident'>term</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z541570'><span><span class='ident'>tail</span></span></span>&nbsp;&#8594;&nbsp;<span class='keyword'>symbols</span><span class='lexic'>(</span><span id='Z541569'><span><span class='ident'>retn</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>[[</span><span class='idfrom' onmouseenter='srcref_over("Z541569",this)' onmouseleave='srcref_leave("Z541569",this)'><span><span class='ident'>retn</span></span></span><span class='lexic'>;</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z541570",this)' onmouseleave='srcref_leave("Z541570",this)'><span><span class='ident'>e</span></span></span><span class='hint'>tail(e)</span></span><span class='lexic'>]]</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='lexic'>&#8709;</span><span class='lexic'>}};</span><br>
&nbsp;&nbsp;&nbsp;<span id='Z542109'><span><span class='ident'>gs</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0flat2</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>code</span><span class='lexic'>:</span><span class='idfrom' onmouseenter='srcref_over("Z541599",this)' onmouseleave='srcref_leave("Z541599",this)'><span><span class='ident'>c</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>code</span>&nbsp;<span class='lexic'>{</span>&nbsp;<span id='Z541971'><span><span class='ident'>c</span></span></span>&nbsp;&#8594;&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z541971",this)' onmouseleave='srcref_leave("Z541971",this)'><span><span class='ident'>bs</span></span></span><span class='hint'>c(bs)</span></span>&nbsp;<span class='lexic'>};</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>bblock</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z541983'><span><span class='ident'>bb</span></span></span>&nbsp;&#8594;&nbsp;<span class='symbol'>'b'</span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z541983",this)' onmouseleave='srcref_leave("Z541983",this)'><span><span class='ident'>lbl</span></span></span><span class='hint'>bb(lbl,body,t)</span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z541986",this)' onmouseleave='srcref_leave("Z541986",this)'><span><span class='ident'>liftget</span></span></span><span class='lexic'>()</span><span class='lexic'>&#8853;</span><span class='lexic'>(</span><span class='keyword'>map</span>&nbsp;<span class='keyword'>append</span>&nbsp;<span id='Z542000'><span><span class='ident'>b</span></span></span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z541983",this)' onmouseleave='srcref_leave("Z541983",this)'><span><span class='ident'>body</span></span></span><span class='hint'>bb(lbl,body,t)</span></span>&nbsp;<span class='keyword'>do</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z542000",this)' onmouseleave='srcref_leave("Z542000",this)'><span><span class='ident'>b</span></span></span><span class='lexic'>)</span><span class='lexic'>&#8853;</span><span class='idfrom' onmouseenter='srcref_over("Z542002",this)' onmouseleave='srcref_leave("Z542002",this)'><span><span class='ident'>getcode</span></span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z541983",this)' onmouseleave='srcref_leave("Z541983",this)'><span><span class='ident'>t</span></span></span><span class='hint'>bb(lbl,body,t)</span></span><span class='lexic'>),</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z542005",this)' onmouseleave='srcref_leave("Z542005",this)'><span><span class='ident'>getbbexits</span></span></span><span class='lexic'>(</span><span class='ident'>thisnodesrc</span><span class='lexic'>()))};</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>insn</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z542010'><span><span class='ident'>alloca</span></span></span>&nbsp;&#8594;&nbsp;<span class='lexic'>{</span><span class='idfrom' onmouseenter='srcref_over("Z542009",this)' onmouseleave='srcref_leave("Z542009",this)'><span><span class='ident'>addalloca</span></span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z542010",this)' onmouseleave='srcref_leave("Z542010",this)'><span><span class='ident'>id</span></span></span><span class='hint'>alloca(id)</span></span><span class='lexic'>);</span>&nbsp;<span class='lexic'>&#8709;</span><span class='lexic'>}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span id='Z542019'><span><span class='ident'>def</span></span></span>&nbsp;&nbsp;&nbsp;&nbsp;&#8594;&nbsp;<span class='lexic'>[[</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z542019",this)' onmouseleave='srcref_leave("Z542019",this)'><span><span class='ident'>id</span></span></span><span class='hint'>def(id,v)</span></span><span class='lexic'>;</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z542019",this)' onmouseleave='srcref_leave("Z542019",this)'><span><span class='ident'>v</span></span></span><span class='hint'>def(id,v)</span></span><span class='lexic'>]]</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span id='Z542030'><span><span class='ident'>set</span></span></span>&nbsp;&nbsp;&nbsp;&nbsp;&#8594;&nbsp;<span class='lexic'>[[</span><span class='withhint'><span class='ident'>gensym</span><span class='hint'>function&nbsp;gensym&nbsp;:&nbsp;<br>
Returns&nbsp;a&nbsp;unique&nbsp;symbol&nbsp;every&nbsp;time&nbsp;it&nbsp;is&nbsp;called.<br>
Uniqueness&nbsp;is&nbsp;guaranteed&nbsp;within&nbsp;one&nbsp;run&nbsp;only.</span></span><span class='lexic'>();</span>&nbsp;<span class='symbol'>'store'</span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z542030",this)' onmouseleave='srcref_leave("Z542030",this)'><span><span class='ident'>id</span></span></span><span class='hint'>set(id,v)</span></span><span class='lexic'>,</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z542030",this)' onmouseleave='srcref_leave("Z542030",this)'><span><span class='ident'>v</span></span></span><span class='hint'>set(id,v)</span></span><span class='lexic'>)]]</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>drop</span>&nbsp;&nbsp;&nbsp;&#8594;&nbsp;<span class='lexic'>&#8709;</span><span class='lexic'>};</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>expr</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z542061'><span><span class='ident'>load</span></span></span>&nbsp;&nbsp;&nbsp;&#8594;&nbsp;<span class='symbol'>'load'</span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z542061",this)' onmouseleave='srcref_leave("Z542061",this)'><span><span class='ident'>id</span></span></span><span class='hint'>load(id)</span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span id='Z542053'><span><span class='ident'>apply</span></span></span>&nbsp;&nbsp;&#8594;&nbsp;<span class='symbol'>'use'</span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z542053",this)' onmouseleave='srcref_leave("Z542053",this)'><span><span class='ident'>fn</span></span></span><span class='hint'>apply(purep,fn,args)</span></span><span class='lexic'>,@</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z542053",this)' onmouseleave='srcref_leave("Z542053",this)'><span><span class='ident'>args</span></span></span><span class='hint'>apply(purep,fn,args)</span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span id='Z542041'><span><span class='ident'>mkclosure</span></span></span>&nbsp;&#8594;&nbsp;<span class='symbol'>'use'</span><span class='lexic'>(@</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z542041",this)' onmouseleave='srcref_leave("Z542041",this)'><span><span class='ident'>args</span></span></span><span class='hint'>mkclosure(df,args)</span></span><span class='lexic'>)};</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>value</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z542095'><span><span class='ident'>reg</span></span></span>&nbsp;&nbsp;&nbsp;&nbsp;&#8594;&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z542095",this)' onmouseleave='srcref_leave("Z542095",this)'><span><span class='ident'>id</span></span></span><span class='hint'>reg(id)</span></span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='keyword'>else</span>&nbsp;&nbsp;&nbsp;&#8594;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z542079",this)' onmouseleave='srcref_leave("Z542079",this)'><span><span class='ident'>newlift</span></span></span><span class='lexic'>(</span><span class='ident'>node</span><span class='lexic'>())}};</span><br>
&nbsp;&nbsp;&nbsp;<span id='Z542110'><span><span class='ident'>allocas</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z542107",this)' onmouseleave='srcref_leave("Z542107",this)'><span><span class='ident'>getallocas</span></span></span><span class='lexic'>();</span><br>
&nbsp;&nbsp;&nbsp;<span class='comment'>//&nbsp;Use&nbsp;the&nbsp;library&nbsp;function&nbsp;to&nbsp;run&nbsp;mem2reg&nbsp;pass&nbsp;on&nbsp;a&nbsp;generic&nbsp;SSA:<br>
</span>&nbsp;&nbsp;&nbsp;<span id='Z542111'><span><span class='ident'>nssa</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='ident'>ssa_transform</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z542109",this)' onmouseleave='srcref_leave("Z542109",this)'><span><span class='ident'>gs</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z542110",this)' onmouseleave='srcref_leave("Z542110",this)'><span><span class='ident'>allocas</span></span></span><span class='lexic'>);</span><br>
&nbsp;&nbsp;&nbsp;<span class='keyword'>return</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z541114",this)' onmouseleave='srcref_leave("Z541114",this)'><span><span class='ident'>vals</span></span></span><span class='lexic'>:</span><span class='idfrom' onmouseenter='srcref_over("Z542111",this)' onmouseleave='srcref_leave("Z542111",this)'><span><span class='ident'>nssa</span></span></span><span class='lexic'>}</span>
<p></div>



<h3>Back from the generic SSA</h3>

<p>After the generic SSA transform, we have all allocas, loads and stores eliminated,
new $\varphi$ nodes introduced and equivalent registers renamed. Now we have to apply
the results back to our original AST.


<p><div class='code'>
<span id='Z542348'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_from_genssa</span><span class='lexic'>(</span><span id='Z543218'><span><span class='ident'>c</span></span></span><span class='lexic'>,</span>&nbsp;<span id='Z543706'><span><span class='ident'>p</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;<span class='lexic'>&lt;</span><span id='Z543028'><span><span class='ident'><span class='pattern'>valsht</span></span></span></span><span class='lexic'><span class='pattern'>:[</span></span><span id='Z543018'><span><span class='ident'><span class='pattern'>vmap</span></span></span></span><span class='lexic'><span class='pattern'>;</span></span><span id='Z543207'><span><span class='ident'><span class='pattern'>ngen</span></span></span></span><span class='lexic'><span class='pattern'>;</span></span><span class='ident'><span class='pattern'>DT</span></span><span class='lexic'><span class='pattern'>]</span></span><span class='lexic'>&gt;</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z543706",this)' onmouseleave='srcref_leave("Z543706",this)'><span><span class='ident'>p</span></span></span><span class='lexic'>;</span><br>
<br>
&nbsp;&nbsp;&nbsp;<span class='comment'>//&nbsp;Generic&nbsp;SSA&nbsp;transform&nbsp;collected&nbsp;register&nbsp;renames,&nbsp;we<br>
</span>&nbsp;&nbsp;&nbsp;<span class='comment'>//&nbsp;have&nbsp;to&nbsp;follow&nbsp;them&nbsp;here.&nbsp;Also,&nbsp;lifted&nbsp;constant&nbsp;values&nbsp;were<br>
</span>&nbsp;&nbsp;&nbsp;<span class='comment'>//&nbsp;given&nbsp;temporary&nbsp;register&nbsp;names&nbsp;in&nbsp;the&nbsp;previous&nbsp;transform,<br>
</span>&nbsp;&nbsp;&nbsp;<span class='comment'>//&nbsp;we&nbsp;have&nbsp;to&nbsp;recover&nbsp;them&nbsp;back.<br>
</span>&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z543025'><span><span class='ident'>getrenamed0</span></span></span><span class='lexic'>(</span><span id='Z543020'><span><span class='ident'>n</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>do</span>&nbsp;<span id='Z543017'><span><span class='ident'>loop</span></span></span><span class='lexic'>(</span><span id='Z543016'><span><span class='ident'>x</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='ident'>ohashget</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z543018",this)' onmouseleave='srcref_leave("Z543018",this)'><span><span class='ident'>vmap</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z543020",this)' onmouseleave='srcref_leave("Z543020",this)'><span><span class='ident'>n</span></span></span><span class='lexic'>),</span>&nbsp;<span id='Z543019'><span><span class='ident'>p</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z543020",this)' onmouseleave='srcref_leave("Z543020",this)'><span><span class='ident'>n</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>if</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z543016",this)' onmouseleave='srcref_leave("Z543016",this)'><span><span class='ident'>x</span></span></span><span class='lexic'>)</span>&nbsp;<span class='keyword'>return</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z543017",this)' onmouseleave='srcref_leave("Z543017",this)'><span><span class='ident'>loop</span></span></span><span class='lexic'>(</span><span class='ident'>ohashget</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z543018",this)' onmouseleave='srcref_leave("Z543018",this)'><span><span class='ident'>vmap</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z543016",this)' onmouseleave='srcref_leave("Z543016",this)'><span><span class='ident'>x</span></span></span><span class='lexic'>),</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z543016",this)' onmouseleave='srcref_leave("Z543016",this)'><span><span class='ident'>x</span></span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>else</span>&nbsp;<span class='keyword'>return</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z543019",this)' onmouseleave='srcref_leave("Z543019",this)'><span><span class='ident'>p</span></span></span>&nbsp;<span class='lexic'>}</span><span class='lexic'>};</span><br>
&nbsp;&nbsp;&nbsp;<span id='Z543168'><span><span class='ident'>getrenamed</span></span></span><span class='lexic'>(</span><span id='Z543026'><span><span class='ident'>n</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='keyword'>with</span>&nbsp;<span class='keyword'>target</span>&nbsp;<span class='lexic'>(</span><span class='ident'>lang0flat2</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z543029'><span><span class='ident'>nreg</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z543025",this)' onmouseleave='srcref_leave("Z543025",this)'><span><span class='ident'>getrenamed0</span></span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z543026",this)' onmouseleave='srcref_leave("Z543026",this)'><span><span class='ident'>n</span></span></span><span class='lexic'>);</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>aif</span><span class='lexic'>(</span><span class='ident'>chk</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='ident'>ohashget</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z543028",this)' onmouseleave='srcref_leave("Z543028",this)'><span><span class='ident'>valsht</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z543029",this)' onmouseleave='srcref_leave("Z543029",this)'><span><span class='ident'>nreg</span></span></span><span class='lexic'>))</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='ident'>chk</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>}</span>&nbsp;<span class='keyword'>else</span>&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>value</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>reg</span><span class='hint'>lang0flat2:value:reg(id)</span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z543029",this)' onmouseleave='srcref_leave("Z543029",this)'><span><span class='ident'>nreg</span></span></span><span class='lexic'>)};</span><br>
<br>
&nbsp;&nbsp;&nbsp;<span id='Z543670'><span><span class='ident'>isrenamed</span></span></span><span class='lexic'>(</span><span id='Z543039'><span><span class='ident'>n</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='ident'>ohashget</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z543018",this)' onmouseleave='srcref_leave("Z543018",this)'><span><span class='ident'>vmap</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z543039",this)' onmouseleave='srcref_leave("Z543039",this)'><span><span class='ident'>n</span></span></span><span class='lexic'>);</span><br>
<br>
&nbsp;&nbsp;&nbsp;<span class='comment'>//&nbsp;Now&nbsp;we&nbsp;can&nbsp;collect&nbsp;the&nbsp;phi&nbsp;nodes&nbsp;from&nbsp;the&nbsp;generic&nbsp;SSA&nbsp;representation,<br>
</span>&nbsp;&nbsp;&nbsp;<span class='comment'>//&nbsp;and&nbsp;then&nbsp;add&nbsp;them&nbsp;to&nbsp;their&nbsp;corresponding&nbsp;source&nbsp;basic&nbsp;blocks.<br>
</span>&nbsp;&nbsp;&nbsp;<span id='Z543179'><span><span class='ident'>phis</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='ident'>mkhash</span><span class='lexic'>();</span><br>
&nbsp;&nbsp;&nbsp;<span id='Z543208'><span><span class='ident'>fillphis</span></span></span><span class='lexic'>()</span>&nbsp;<span class='lexic'>=</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>genssa</span>&nbsp;<span class='lexic'>(</span><span class='ident'>code</span><span class='lexic'>:</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z543207",this)' onmouseleave='srcref_leave("Z543207",this)'><span><span class='ident'>ngen</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>bblock</span>&nbsp;<span class='lexic'>{</span>&nbsp;<span id='Z543079'><span><span class='ident'>b</span></span></span>&nbsp;&#8594;&nbsp;<span class='keyword'>iter</span>&nbsp;<span class='ident'>ops</span>&nbsp;<span class='keyword'>do</span>&nbsp;<span class='ident'>ops</span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z543079",this)' onmouseleave='srcref_leave("Z543079",this)'><span><span class='ident'>name</span></span></span><span class='hint'>b(name,ops,nexts)</span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>};</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>oppair</span>&nbsp;<span class='lexic'>:</span>&nbsp;<span class='keyword'>&lambda;</span><span class='lexic'>(</span><span id='Z543110'><span><span class='ident'>bb</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span>&nbsp;<span class='ident'>op</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z543110",this)' onmouseleave='srcref_leave("Z543110",this)'><span><span class='ident'>bb</span></span></span><span class='lexic'>,</span>&nbsp;<span class='ident'>name</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>}</span><span class='lexic'>;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>iop</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z543147'><span><span class='ident'>phi</span></span></span>&nbsp;&#8594;&nbsp;<span class='keyword'>&lambda;</span><span class='lexic'>(</span><span id='Z543180'><span><span class='ident'>bb</span></span></span><span class='lexic'>,</span>&nbsp;<span id='Z543140'><span><span class='ident'>tgt</span></span></span><span class='lexic'>)</span>&nbsp;<span class='keyword'>with</span>&nbsp;<span class='keyword'>target</span>&nbsp;<span class='lexic'>(</span><span class='ident'>lang0flat2</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z543181'><span><span class='ident'>nphi</span></span></span>&nbsp;<span class='lexic'>=</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>insn</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>def</span><span class='hint'>lang0flat2:insn:def(id,v)</span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z543140",this)' onmouseleave='srcref_leave("Z543140",this)'><span><span class='ident'>tgt</span></span></span><span class='lexic'>,</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='ident'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>phi</span><span class='hint'>lang0flat2:expr:phi(ss)</span></span><span class='lexic'>(</span><span class='ident'>ss</span>&nbsp;<span class='lexic'>=</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>map</span>&nbsp;<span class='lexic'>[</span><span id='Z543167'><span><span class='ident'><span class='pattern'>f</span></span></span></span><span class='lexic'>;</span><span id='Z543169'><span><span class='ident'><span class='pattern'>v</span></span></span></span><span class='lexic'>]</span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='withhint'><span class='ident'>zip</span><span class='hint'>function&nbsp;zip&nbsp;a,&nbsp;b:&nbsp;<br>
Returns&nbsp;the&nbsp;list&nbsp;of&nbsp;($a_i${}&nbsp;$b_i$)&nbsp;for&nbsp;all&nbsp;elements&nbsp;of&nbsp;[a]&nbsp;and&nbsp;[b].</span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z543147",this)' onmouseleave='srcref_leave("Z543147",this)'><span><span class='ident'>prevs</span></span></span><span class='hint'>phi(orig,prevs,vals)</span></span><span class='lexic'>,</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z543147",this)' onmouseleave='srcref_leave("Z543147",this)'><span><span class='ident'>vals</span></span></span><span class='hint'>phi(orig,prevs,vals)</span></span><span class='lexic'>)</span>&nbsp;<span class='keyword'>do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>s</span><span class='hint'>lang0flat2:phisrc:s(from,v)</span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z543167",this)' onmouseleave='srcref_leave("Z543167",this)'><span><span class='ident'>f</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z543168",this)' onmouseleave='srcref_leave("Z543168",this)'><span><span class='ident'>getrenamed</span></span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z543169",this)' onmouseleave='srcref_leave("Z543169",this)'><span><span class='ident'>v</span></span></span><span class='lexic'>))));</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='ident'>ohashput</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z543179",this)' onmouseleave='srcref_leave("Z543179",this)'><span><span class='ident'>phis</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z543180",this)' onmouseleave='srcref_leave("Z543180",this)'><span><span class='ident'>bb</span></span></span><span class='lexic'>,</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='ident'>ohashget</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z543179",this)' onmouseleave='srcref_leave("Z543179",this)'><span><span class='ident'>phis</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z543180",this)' onmouseleave='srcref_leave("Z543180",this)'><span><span class='ident'>bb</span></span></span><span class='lexic'>)</span><span class='lexic'>&#8853;</span><span class='lexic'>[</span><span class='idfrom' onmouseenter='srcref_over("Z543181",this)' onmouseleave='srcref_leave("Z543181",this)'><span><span class='ident'>nphi</span></span></span><span class='lexic'>])}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='keyword'>&lambda;</span><span class='lexic'>(</span><span class='ident'>bb</span><span class='lexic'>,</span>&nbsp;<span class='ident'>tgt</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>&#8709;</span>&nbsp;<span class='lexic'>}};</span><br>
&nbsp;&nbsp;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z543208",this)' onmouseleave='srcref_leave("Z543208",this)'><span><span class='ident'>fillphis</span></span></span><span class='lexic'>();</span><br>
&nbsp;&nbsp;&nbsp;<span id='Z543633'><span><span class='ident'>getphis</span></span></span><span class='lexic'>(</span><span id='Z543212'><span><span class='ident'>lbl</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='ident'>ohashget</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z543179",this)' onmouseleave='srcref_leave("Z543179",this)'><span><span class='ident'>phis</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z543212",this)' onmouseleave='srcref_leave("Z543212",this)'><span><span class='ident'>lbl</span></span></span><span class='lexic'>);</span><br>
<br>
&nbsp;&nbsp;&nbsp;<span class='comment'>//&nbsp;Apply&nbsp;all&nbsp;the&nbsp;changes&nbsp;to&nbsp;the&nbsp;original&nbsp;lang0flat2&nbsp;code<br>
</span>&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0flat2</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>code</span><span class='lexic'>:</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z543218",this)' onmouseleave='srcref_leave("Z543218",this)'><span><span class='ident'>c</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>bblock</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z543634'><span><span class='ident'>bb</span></span></span>&nbsp;&#8594;&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z543640'><span><span class='ident'>phis</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z543633",this)' onmouseleave='srcref_leave("Z543633",this)'><span><span class='ident'>getphis</span></span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z543634",this)' onmouseleave='srcref_leave("Z543634",this)'><span><span class='ident'>lbl</span></span></span><span class='hint'>bb(lbl,body,t)</span></span><span class='lexic'>);</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='keyword'>node</span><span class='hint'>lang0flat2:bblock:bb(lbl,body,t)<br>
&nbsp;&nbsp;&nbsp;with&nbsp;implicit&nbsp;arguments:&nbsp;lbl,&nbsp;t<br>
</span></span><span class='lexic'>(</span><span class='ident'>body</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z543640",this)' onmouseleave='srcref_leave("Z543640",this)'><span><span class='ident'>phis</span></span></span>&nbsp;<span class='lexic'>&#8853;</span>&nbsp;<span class='keyword'>map</span>&nbsp;<span class='keyword'>append</span>&nbsp;<span id='Z543654'><span><span class='ident'>b</span></span></span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z543634",this)' onmouseleave='srcref_leave("Z543634",this)'><span><span class='ident'>body</span></span></span><span class='hint'>bb(lbl,body,t)</span></span>&nbsp;<span class='keyword'>do</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z543654",this)' onmouseleave='srcref_leave("Z543654",this)'><span><span class='ident'>b</span></span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>}};</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>insn</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='ident'>alloca</span>&nbsp;&#8594;&nbsp;<span class='lexic'>&#8709;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;&nbsp;<span class='ident'>set</span>&nbsp;&#8594;&nbsp;<span class='lexic'>&#8709;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;&nbsp;<span id='Z543671'><span><span class='ident'>def</span></span></span>&nbsp;&#8594;&nbsp;<span class='keyword'>if</span>&nbsp;<span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z543670",this)' onmouseleave='srcref_leave("Z543670",this)'><span><span class='ident'>isrenamed</span></span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z543671",this)' onmouseleave='srcref_leave("Z543671",this)'><span><span class='ident'>id</span></span></span><span class='hint'>def(id,v)</span></span><span class='lexic'>))</span>&nbsp;<span class='lexic'>&#8709;</span>&nbsp;<span class='keyword'>else</span>&nbsp;<span class='lexic'>[</span><span class='ident'>node</span><span class='lexic'>()]</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='lexic'>[</span><span class='ident'>node</span><span class='lexic'>()]};</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>value</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z543695'><span><span class='ident'>reg</span></span></span>&nbsp;&#8594;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z543168",this)' onmouseleave='srcref_leave("Z543168",this)'><span><span class='ident'>getrenamed</span></span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z543695",this)' onmouseleave='srcref_leave("Z543695",this)'><span><span class='ident'>id</span></span></span><span class='hint'>reg(id)</span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='ident'>node</span><span class='lexic'>()}}}</span>
<p></div>


<p>And a simple wrapper function to run the generic SSA transform over top level entries:


<p><div class='code'>
<span id='Z543965'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_genssa</span><span class='lexic'>(</span><span id='Z544141'><span><span class='ident'>ts</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;<span class='keyword'>map</span>&nbsp;<span id='Z544149'><span><span class='ident'>t</span></span></span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z544141",this)' onmouseleave='srcref_leave("Z544141",this)'><span><span class='ident'>ts</span></span></span>&nbsp;<span class='keyword'>do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0flat2</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>top</span><span class='lexic'>:</span><span class='idfrom' onmouseenter='srcref_over("Z544149",this)' onmouseleave='srcref_leave("Z544149",this)'><span><span class='ident'>t</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>once</span>&nbsp;<span class='ident'>code</span>&nbsp;<span class='lexic'>{</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<a href='#Z542348'><span class='ident'>l0_from_genssa</span></a><span class='lexic'>(</span><span class='ident'>node</span><span class='lexic'>(),</span>&nbsp;<a href='#Z540121'><span class='ident'>l0_to_genssa</span></a><span class='lexic'>(</span><span class='ident'>node</span><span class='lexic'>()))</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>}}}</span>
<p></div>


<h3>Everything to this point</h3>


<p><div class='code'>
<span id='Z544344'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_genssa_driver</span><span class='lexic'>(</span><span id='Z544347'><span><span class='ident'>src</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;<span id='Z544349'><span><span class='ident'>x3</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<a href='#Z532169'><span class='ident'>l0_flatten_driver</span></a><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z544347",this)' onmouseleave='srcref_leave("Z544347",this)'><span><span class='ident'>src</span></span></span><span class='lexic'>);</span><br>
&nbsp;&nbsp;<span id='Z544351'><span><span class='ident'>x4</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<a href='#Z537434'><span class='ident'>l0_basic_blocks</span></a><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z544349",this)' onmouseleave='srcref_leave("Z544349",this)'><span><span class='ident'>x3</span></span></span><span class='lexic'>);</span><br>
&nbsp;&nbsp;<span id='Z544352'><span><span class='ident'>x5</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<a href='#Z543965'><span class='ident'>l0_genssa</span></a><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z544351",this)' onmouseleave='srcref_leave("Z544351",this)'><span><span class='ident'>x4</span></span></span><span class='lexic'>);</span><br>
&nbsp;&nbsp;<span class='keyword'>return</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z544352",this)' onmouseleave='srcref_leave("Z544352",this)'><span><span class='ident'>x5</span></span></span><span class='lexic'>;</span><br>
<span class='lexic'>}</span>
<p></div>


<p>Now, back from the generic SSA, our foldl function looks like this:









   

<p><div class='democode'>
<span class='lexic'>(</span><span class='ident'>sfunction</span>&nbsp;<span class='keyword'>foldl</span>&nbsp;<span class='lexic'>(</span><span class='ident'>Z545381</span>&nbsp;<span class='ident'>Z545382</span>&nbsp;<span class='ident'>Z545383</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>(</span><span class='ident'>c</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>bb</span>&nbsp;<span class='ident'>entry</span>&nbsp;<span class='lexic'>()</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>goto</span>&nbsp;<span class='ident'>tailrecentry</span><span class='lexic'>))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>bb</span>&nbsp;<span class='ident'>tailrecentry</span>&nbsp;<span class='lexic'>(</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>def</span>&nbsp;<span class='ident'>Z545418</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>phi</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>s</span>&nbsp;<span class='ident'>Z545400</span>&nbsp;<span class='lexic'>(</span><span class='ident'>reg</span>&nbsp;<span class='ident'>Z545389</span><span class='lexic'>))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>s</span>&nbsp;<span class='ident'>entry</span>&nbsp;<span class='lexic'>(</span><span class='ident'>arg</span>&nbsp;<span class='ident'>Z545383</span><span class='lexic'>))))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>def</span>&nbsp;<span class='ident'>Z545417</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>phi</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>s</span>&nbsp;<span class='ident'>Z545400</span>&nbsp;<span class='lexic'>(</span><span class='ident'>reg</span>&nbsp;<span class='ident'>Z545392</span><span class='lexic'>))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>s</span>&nbsp;<span class='ident'>entry</span>&nbsp;<span class='lexic'>(</span><span class='ident'>arg</span>&nbsp;<span class='ident'>Z545382</span><span class='lexic'>))))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>def</span>&nbsp;<span class='ident'>Z545416</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>phi</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>s</span>&nbsp;<span class='ident'>Z545400</span>&nbsp;<span class='lexic'>(</span><span class='ident'>reg</span>&nbsp;<span class='ident'>Z545416</span><span class='lexic'>))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>s</span>&nbsp;<span class='ident'>entry</span>&nbsp;<span class='lexic'>(</span><span class='ident'>arg</span>&nbsp;<span class='ident'>Z545381</span><span class='lexic'>))))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>def</span>&nbsp;<span class='ident'>Z545397</span>&nbsp;<span class='lexic'>(</span><span class='keyword'>apply</span>&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>global</span>&nbsp;<span class='ident'>nullp</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>(</span><span class='ident'>reg</span>&nbsp;<span class='ident'>Z545418</span><span class='lexic'>))))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>gotoc</span>&nbsp;<span class='lexic'>(</span><span class='ident'>reg</span>&nbsp;<span class='ident'>Z545397</span><span class='lexic'>)</span>&nbsp;<span class='ident'>Z545399</span>&nbsp;<span class='ident'>Z545400</span><span class='lexic'>))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>bb</span>&nbsp;<span class='ident'>Z545399</span>&nbsp;<span class='lexic'>()</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(return</span>&nbsp;<span class='lexic'>(</span><span class='ident'>reg</span>&nbsp;<span class='ident'>Z545417</span><span class='lexic'>)))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>bb</span>&nbsp;<span class='ident'>Z545400</span>&nbsp;<span class='lexic'>(</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>def</span>&nbsp;<span class='ident'>Z545387</span>&nbsp;<span class='lexic'>(</span><span class='keyword'>apply</span>&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>global</span>&nbsp;<span class='ident'>head</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>(</span><span class='ident'>reg</span>&nbsp;<span class='ident'>Z545418</span><span class='lexic'>)))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>def</span>&nbsp;<span class='ident'>Z545389</span>&nbsp;<span class='lexic'>(</span><span class='keyword'>apply</span>&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>global</span>&nbsp;<span class='ident'>tail</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>(</span><span class='ident'>reg</span>&nbsp;<span class='ident'>Z545418</span><span class='lexic'>)))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>def</span>&nbsp;<span class='ident'>Z545392</span>&nbsp;<span class='lexic'>(</span><span class='keyword'>apply</span>&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>reg</span>&nbsp;<span class='ident'>Z545416</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>(</span><span class='ident'>reg</span>&nbsp;<span class='ident'>Z545417</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>(</span><span class='ident'>reg</span>&nbsp;<span class='ident'>Z545387</span><span class='lexic'>))))</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>(</span><span class='ident'>goto</span>&nbsp;<span class='ident'>tailrecentry</span><span class='lexic'>))))</span><br>

</div><p>


<p>And a control flow graph for this example is following:

<p><div class='democode'><object data="foldl_lang0flat2.svg" type="image/svg+xml" style="transform: scale(0.5);"></object></div>








<h2 id='abstract'>Abstract SSA</h2>

<p>The next few sections are entirely optional. We already have an IR suitable for code generation,
but also fit for SSA-based optimisations. MBase provides an abstract SSA library which, with a help of
a user--defined IR model, provide, among others, the following transforms:

<ul>
<li> Constant folding
<li> ADCE
<li> CFG simplification
<li> Loop analysis
<li> Loop invariant motion
<li> Loop unrolling
<li> Common subexpression elimination
</ul>

<p>For the implementation details see \verb|ssa-fold.pdf|.

<p>Some of these optimisations are enabling and may be useful for our code generation even if the target
platform is capable of doing the similar optimisations on a lower level.

<p>Keep in mind that Abstract SSA is an old, list--form AST, and by converting our nice recform AST into it we're
discarding any associated metadata (most importantly, source code locations). Also, some semantics is lost and
must be recovered on a way back (e.g., both arguments and closure variables are represented as registers).

<p>We did not have any <b>select</b> instructions before, but they may appear after the Abstract SSA optimisations.
Backend must be aware of this.




<p><div class='code'>
<span id='Z545421'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_to_abstract_ssa_code</span><span class='lexic'>(</span><span id='Z545942'><span><span class='ident'>c</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;<span id='Z545933'><span><span class='ident'>isintrinsicfn</span></span></span><span class='lexic'>(</span><span id='Z545921'><span><span class='ident'>id</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>case</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z545921",this)' onmouseleave='srcref_leave("Z545921",this)'><span><span class='ident'>id</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='symbol'>'binopadd'</span>&nbsp;<span class='lexic'>|</span>&nbsp;<span class='symbol'>'binopsub'</span>&nbsp;<span class='lexic'>|</span>&nbsp;<span class='symbol'>'binopmul'</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='symbol'>'binopdiv'</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='symbol'>'binopeq'</span>&nbsp;<span class='lexic'>|</span>&nbsp;<span class='symbol'>'binopneq'</span>&nbsp;&#8594;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z545921",this)' onmouseleave='srcref_leave("Z545921",this)'><span><span class='ident'>id</span></span></span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='lexic'>&#8709;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>}};</span><br>
&nbsp;&nbsp;<span id='Z546395'><span><span class='ident'>isintrinsic</span></span></span><span class='lexic'>(</span><span id='Z545936'><span><span class='ident'>f</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>=</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>{</span><span class='keyword'>match</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z545936",this)' onmouseleave='srcref_leave("Z545936",this)'><span><span class='ident'>f</span></span></span>&nbsp;<span class='keyword'>with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='symbol'><span class='pattern'>'glob'</span></span><span class='lexic'><span class='pattern'>(</span></span><span id='Z545934'><span><span class='ident'><span class='pattern'>id</span></span></span></span><span class='lexic'><span class='pattern'>)</span></span>&nbsp;&#8594;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z545933",this)' onmouseleave='srcref_leave("Z545933",this)'><span><span class='ident'>isintrinsicfn</span></span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z545934",this)' onmouseleave='srcref_leave("Z545934",this)'><span><span class='ident'>id</span></span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'><span class='pattern'>else</span></span>&nbsp;&#8594;&nbsp;<span class='lexic'>&#8709;</span><span class='lexic'>};</span><br>
&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0flat2</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>code</span><span class='lexic'>:</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z545942",this)' onmouseleave='srcref_leave("Z545942",this)'><span><span class='ident'>c</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>code</span>&nbsp;<span class='lexic'>{</span>&nbsp;<span id='Z546290'><span><span class='ident'>c</span></span></span>&nbsp;&#8594;&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z546290",this)' onmouseleave='srcref_leave("Z546290",this)'><span><span class='ident'>bs</span></span></span><span class='hint'>c(bs)</span></span>&nbsp;<span class='lexic'>};</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>bblock</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z546309'><span><span class='ident'>bb</span></span></span>&nbsp;&#8594;&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>&lt;</span><span id='Z546314'><span><span class='ident'><span class='pattern'>te</span></span></span></span><span class='lexic'><span class='pattern'>:</span></span><span id='Z546315'><span><span class='ident'><span class='pattern'>t1</span></span></span></span><span class='lexic'>&gt;</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z546309",this)' onmouseleave='srcref_leave("Z546309",this)'><span><span class='ident'>t</span></span></span><span class='hint'>bb(lbl,body,t)</span></span><span class='lexic'>;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='symbol'>'b'</span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z546309",this)' onmouseleave='srcref_leave("Z546309",this)'><span><span class='ident'>lbl</span></span></span><span class='hint'>bb(lbl,body,t)</span></span><span class='lexic'>,</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z546309",this)' onmouseleave='srcref_leave("Z546309",this)'><span><span class='ident'>body</span></span></span><span class='hint'>bb(lbl,body,t)</span></span><span class='lexic'>&#8853;</span><span class='idfrom' onmouseenter='srcref_over("Z546314",this)' onmouseleave='srcref_leave("Z546314",this)'><span><span class='ident'>te</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z546315",this)' onmouseleave='srcref_leave("Z546315",this)'><span><span class='ident'>t1</span></span></span><span class='lexic'>)}};</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>insn</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z546327'><span><span class='ident'>def</span></span></span>&nbsp;&#8594;&nbsp;<span class='lexic'>[</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z546327",this)' onmouseleave='srcref_leave("Z546327",this)'><span><span class='ident'>id</span></span></span><span class='hint'>def(id,v)</span></span><span class='lexic'>;</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z546327",this)' onmouseleave='srcref_leave("Z546327",this)'><span><span class='ident'>v</span></span></span><span class='hint'>def(id,v)</span></span><span class='lexic'>]</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='withhint'><span class='ident'>ccerror</span><span class='hint'>function&nbsp;ccerror&nbsp;arg:&nbsp;<br>
Raises&nbsp;[MBaseException]&nbsp;with&nbsp;a&nbsp;given&nbsp;argument.</span></span><span class='lexic'>(</span><span class='symbol'>'IMPOSSIBLE'</span><span class='lexic'>())};</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>term</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z546349'><span><span class='ident'>goto</span></span></span>&nbsp;&#8594;&nbsp;<span class='lexic'>&#8709;</span><span class='lexic'>:</span><span class='symbol'>'br'</span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z546349",this)' onmouseleave='srcref_leave("Z546349",this)'><span><span class='ident'>id</span></span></span><span class='hint'>goto(id)</span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span id='Z546361'><span><span class='ident'>gotoc</span></span></span>&nbsp;&#8594;&nbsp;<span class='lexic'>&#8709;</span><span class='lexic'>:</span><span class='symbol'>'brc'</span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z546361",this)' onmouseleave='srcref_leave("Z546361",this)'><span><span class='ident'>cnd</span></span></span><span class='hint'>gotoc(cnd,tr,fl)</span></span><span class='lexic'>,</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z546361",this)' onmouseleave='srcref_leave("Z546361",this)'><span><span class='ident'>tr</span></span></span><span class='hint'>gotoc(cnd,tr,fl)</span></span><span class='lexic'>,</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z546361",this)' onmouseleave='srcref_leave("Z546361",this)'><span><span class='ident'>fl</span></span></span><span class='hint'>gotoc(cnd,tr,fl)</span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span id='Z546371'><span><span class='ident'>return</span></span></span>&nbsp;&#8594;&nbsp;<span class='lexic'>[[</span><span class='withhint'><span class='ident'>gensym</span><span class='hint'>function&nbsp;gensym&nbsp;:&nbsp;<br>
Returns&nbsp;a&nbsp;unique&nbsp;symbol&nbsp;every&nbsp;time&nbsp;it&nbsp;is&nbsp;called.<br>
Uniqueness&nbsp;is&nbsp;guaranteed&nbsp;within&nbsp;one&nbsp;run&nbsp;only.</span></span><span class='lexic'>();</span><span class='symbol'>'call'</span><span class='lexic'>([</span><span class='symbol'>'other'</span><span class='lexic'>(</span><span class='symbol'>'src'</span><span class='lexic'>(</span><span class='ident'>thisnodesrc</span><span class='lexic'>()))],</span>&nbsp;<span class='symbol'>'*return*'</span><span class='lexic'>,</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z546371",this)' onmouseleave='srcref_leave("Z546371",this)'><span><span class='ident'>v</span></span></span><span class='hint'>return(v)</span></span><span class='lexic'>)]]:</span><span class='symbol'>'none'</span><span class='lexic'>()</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span id='Z546343'><span><span class='ident'>tail</span></span></span>&nbsp;&#8594;&nbsp;<span class='keyword'>symbols</span><span class='lexic'>(</span><span id='Z546342'><span><span class='ident'>ret</span></span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>[[</span><span class='idfrom' onmouseenter='srcref_over("Z546342",this)' onmouseleave='srcref_leave("Z546342",this)'><span><span class='ident'>ret</span></span></span><span class='lexic'>;</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z546343",this)' onmouseleave='srcref_leave("Z546343",this)'><span><span class='ident'>e</span></span></span><span class='hint'>tail(e)</span></span><span class='lexic'>];</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>[</span><span class='withhint'><span class='ident'>gensym</span><span class='hint'>function&nbsp;gensym&nbsp;:&nbsp;<br>
Returns&nbsp;a&nbsp;unique&nbsp;symbol&nbsp;every&nbsp;time&nbsp;it&nbsp;is&nbsp;called.<br>
Uniqueness&nbsp;is&nbsp;guaranteed&nbsp;within&nbsp;one&nbsp;run&nbsp;only.</span></span><span class='lexic'>();</span><span class='symbol'>'call'</span><span class='lexic'>([</span><span class='symbol'>'other'</span><span class='lexic'>(</span><span class='symbol'>'src'</span><span class='lexic'>(</span><span class='ident'>thisnodesrc</span><span class='lexic'>()))],</span>&nbsp;<span class='symbol'>'*tailreturn*'</span><span class='lexic'>,</span>&nbsp;<span class='symbol'>'var'</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z546342",this)' onmouseleave='srcref_leave("Z546342",this)'><span><span class='ident'>ret</span></span></span><span class='lexic'>))]]:</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='symbol'>'none'</span><span class='lexic'>()};</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>expr</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z546380'><span><span class='ident'>mkclosure</span></span></span>&nbsp;&#8594;&nbsp;<span class='symbol'>'call'</span><span class='lexic'>([</span><span class='symbol'>'other'</span><span class='lexic'>(</span><span class='symbol'>'src'</span><span class='lexic'>(</span><span class='ident'>thisnodesrc</span><span class='lexic'>()))],</span>&nbsp;<span class='symbol'>'*mkclosure*'</span><span class='lexic'>,</span>&nbsp;<span class='symbol'>'glob'</span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z546380",this)' onmouseleave='srcref_leave("Z546380",this)'><span><span class='ident'>df</span></span></span><span class='hint'>mkclosure(df,args)</span></span><span class='lexic'>),@</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z546380",this)' onmouseleave='srcref_leave("Z546380",this)'><span><span class='ident'>args</span></span></span><span class='hint'>mkclosure(df,args)</span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span id='Z546396'><span><span class='ident'>apply</span></span></span>&nbsp;&#8594;&nbsp;<span class='keyword'>aif</span>&nbsp;<span class='lexic'>(</span><span class='ident'>intr</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z546395",this)' onmouseleave='srcref_leave("Z546395",this)'><span><span class='ident'>isintrinsic</span></span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z546396",this)' onmouseleave='srcref_leave("Z546396",this)'><span><span class='ident'>fn</span></span></span><span class='hint'>apply(purep,fn,args)</span></span><span class='lexic'>))</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='symbol'>'call'</span><span class='lexic'>([</span><span class='symbol'>'other'</span><span class='lexic'>(</span><span class='symbol'>'src'</span><span class='lexic'>(</span><span class='ident'>thisnodesrc</span><span class='lexic'>()))],</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='ident'>intr</span><span class='lexic'>,</span>&nbsp;<span class='lexic'>@</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z546396",this)' onmouseleave='srcref_leave("Z546396",this)'><span><span class='ident'>args</span></span></span><span class='hint'>apply(purep,fn,args)</span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>}</span>&nbsp;<span class='keyword'>else</span>&nbsp;<span class='symbol'>'call'</span><span class='lexic'>([</span><span class='symbol'>'other'</span><span class='lexic'>(</span><span class='symbol'>'src'</span><span class='lexic'>(</span><span class='ident'>thisnodesrc</span><span class='lexic'>()))],</span>&nbsp;<span class='symbol'>'*funcall*'</span><span class='lexic'>,</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z546396",this)' onmouseleave='srcref_leave("Z546396",this)'><span><span class='ident'>fn</span></span></span><span class='hint'>apply(purep,fn,args)</span></span><span class='lexic'>,</span>&nbsp;<span class='lexic'>@</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z546396",this)' onmouseleave='srcref_leave("Z546396",this)'><span><span class='ident'>args</span></span></span><span class='hint'>apply(purep,fn,args)</span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>load</span>&nbsp;&#8594;&nbsp;<span class='withhint'><span class='ident'>ccerror</span><span class='hint'>function&nbsp;ccerror&nbsp;arg:&nbsp;<br>
Raises&nbsp;[MBaseException]&nbsp;with&nbsp;a&nbsp;given&nbsp;argument.</span></span><span class='lexic'>(</span><span class='symbol'>'IMPOSSIBLE'</span><span class='lexic'>())</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span id='Z546411'><span><span class='ident'>phi</span></span></span>&nbsp;&#8594;&nbsp;<span class='symbol'>'phi'</span><span class='lexic'>(@</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z546411",this)' onmouseleave='srcref_leave("Z546411",this)'><span><span class='ident'>ss</span></span></span><span class='hint'>phi(ss)</span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span id='Z546423'><span><span class='ident'>select</span></span></span>&nbsp;&#8594;&nbsp;<span class='symbol'>'select'</span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z546423",this)' onmouseleave='srcref_leave("Z546423",this)'><span><span class='ident'>cnd</span></span></span><span class='hint'>select(cnd,tr,fl)</span></span><span class='lexic'>,</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z546423",this)' onmouseleave='srcref_leave("Z546423",this)'><span><span class='ident'>tr</span></span></span><span class='hint'>select(cnd,tr,fl)</span></span><span class='lexic'>,</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z546423",this)' onmouseleave='srcref_leave("Z546423",this)'><span><span class='ident'>fl</span></span></span><span class='hint'>select(cnd,tr,fl)</span></span><span class='lexic'>)};</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>phisrc</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z546439'><span><span class='ident'>s</span></span></span>&nbsp;&#8594;&nbsp;<span class='symbol'>'a'</span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z546439",this)' onmouseleave='srcref_leave("Z546439",this)'><span><span class='ident'>from</span></span></span><span class='hint'>s(from,v)</span></span><span class='lexic'>,</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z546439",this)' onmouseleave='srcref_leave("Z546439",this)'><span><span class='ident'>v</span></span></span><span class='hint'>s(from,v)</span></span><span class='lexic'>)};</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>value</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z546447'><span><span class='ident'>const</span></span></span>&nbsp;&#8594;&nbsp;<span class='symbol'>'const'</span><span class='lexic'>(</span><span class='symbol'>'any'</span><span class='lexic'>(),</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z546447",this)' onmouseleave='srcref_leave("Z546447",this)'><span><span class='ident'>c</span></span></span><span class='hint'>const(c)</span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span id='Z546453'><span><span class='ident'>global</span></span></span>&nbsp;&#8594;&nbsp;<span class='symbol'>'glob'</span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z546453",this)' onmouseleave='srcref_leave("Z546453",this)'><span><span class='ident'>id</span></span></span><span class='hint'>global(id)</span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span id='Z546459'><span><span class='ident'>arg</span></span></span>&nbsp;&#8594;&nbsp;<span class='symbol'>'var'</span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z546459",this)' onmouseleave='srcref_leave("Z546459",this)'><span><span class='ident'>id</span></span></span><span class='hint'>arg(id)</span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span id='Z546465'><span><span class='ident'>clvar</span></span></span>&nbsp;&#8594;&nbsp;<span class='symbol'>'var'</span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z546465",this)' onmouseleave='srcref_leave("Z546465",this)'><span><span class='ident'>id</span></span></span><span class='hint'>clvar(id)</span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span id='Z546471'><span><span class='ident'>reg</span></span></span>&nbsp;&#8594;&nbsp;<span class='symbol'>'var'</span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z546471",this)' onmouseleave='srcref_leave("Z546471",this)'><span><span class='ident'>id</span></span></span><span class='hint'>reg(id)</span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span id='Z546477'><span><span class='ident'>funref</span></span></span>&nbsp;&#8594;&nbsp;<span class='symbol'>'glob'</span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z546477",this)' onmouseleave='srcref_leave("Z546477",this)'><span><span class='ident'>id</span></span></span><span class='hint'>funref(id)</span></span><span class='lexic'>)}}}</span>
<p></div>




<p><div class='code'>
<span id='Z546644'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_to_abstract_ssa</span><span class='lexic'>(</span><span id='Z546820'><span><span class='ident'>ts</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;<span class='keyword'>map</span>&nbsp;<span class='keyword'>append</span>&nbsp;<span id='Z546828'><span><span class='ident'>t</span></span></span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z546820",this)' onmouseleave='srcref_leave("Z546820",this)'><span><span class='ident'>ts</span></span></span>&nbsp;<span class='keyword'>do</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0flat2</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>top</span><span class='lexic'>:</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z546828",this)' onmouseleave='srcref_leave("Z546828",this)'><span><span class='ident'>t</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>top</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z546936'><span><span class='ident'>sfunction</span></span></span>&nbsp;&#8594;&nbsp;<span class='lexic'>[</span><span class='symbol'>'f'</span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z546936",this)' onmouseleave='srcref_leave("Z546936",this)'><span><span class='ident'>id</span></span></span><span class='hint'>sfunction(id,args,body)</span></span><span class='lexic'>,</span>&nbsp;<span class='symbol'>'any'</span><span class='lexic'>(),</span>&nbsp;<span class='keyword'>map</span>&nbsp;<span id='Z546946'><span><span class='ident'>a</span></span></span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z546936",this)' onmouseleave='srcref_leave("Z546936",this)'><span><span class='ident'>args</span></span></span><span class='hint'>sfunction(id,args,body)</span></span>&nbsp;<span class='keyword'>do</span>&nbsp;<span class='lexic'>[</span><span class='symbol'>'any'</span><span class='lexic'>();</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z546946",this)' onmouseleave='srcref_leave("Z546946",this)'><span><span class='ident'>a</span></span></span><span class='lexic'>],</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href='#Z545421'><span class='ident'>l0_to_abstract_ssa_code</span></a><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z546936",this)' onmouseleave='srcref_leave("Z546936",this)'><span><span class='ident'>body</span></span></span><span class='hint'>sfunction(id,args,body)</span></span><span class='lexic'>))]</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span id='Z546961'><span><span class='ident'>closure</span></span></span>&nbsp;&#8594;&nbsp;<span class='lexic'>[</span><span class='symbol'>'f'</span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z546961",this)' onmouseleave='srcref_leave("Z546961",this)'><span><span class='ident'>id</span></span></span><span class='hint'>closure(id,clargs,args,body)</span></span><span class='lexic'>,</span>&nbsp;<span class='symbol'>'any'</span><span class='lexic'>(),</span>&nbsp;<span class='lexic'>[@</span><span class='keyword'>map</span>&nbsp;<span id='Z546971'><span><span class='ident'>a</span></span></span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z546961",this)' onmouseleave='srcref_leave("Z546961",this)'><span><span class='ident'>args</span></span></span><span class='hint'>closure(id,clargs,args,body)</span></span>&nbsp;<span class='keyword'>do</span>&nbsp;<span class='lexic'>[</span><span class='symbol'>'any'</span><span class='lexic'>();</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z546971",this)' onmouseleave='srcref_leave("Z546971",this)'><span><span class='ident'>a</span></span></span><span class='lexic'>];</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>@</span><span class='keyword'>map</span>&nbsp;<span id='Z546979'><span><span class='ident'>a</span></span></span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z546961",this)' onmouseleave='srcref_leave("Z546961",this)'><span><span class='ident'>clargs</span></span></span><span class='hint'>closure(id,clargs,args,body)</span></span>&nbsp;<span class='keyword'>do</span>&nbsp;<span class='lexic'>[</span><span class='symbol'>'any'</span><span class='lexic'>();</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z546979",this)' onmouseleave='srcref_leave("Z546979",this)'><span><span class='ident'>a</span></span></span><span class='lexic'>]],</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href='#Z545421'><span class='ident'>l0_to_abstract_ssa_code</span></a><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z546961",this)' onmouseleave='srcref_leave("Z546961",this)'><span><span class='ident'>body</span></span></span><span class='hint'>closure(id,clargs,args,body)</span></span><span class='lexic'>))]</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='lexic'>&#8709;</span><span class='lexic'>}}}</span>
<p></div>

     

<h3>Model</h3>

<p>
Abstract SSA implementation is IR-agnostic and therefore must be provided with some hints about the nature
of this particular IR. We have to be able to tell pure intrinsics from those that might have some
side effects in order to get the constant folding working. We have to provide a way to evaluate those intrinsics
when all of their arguments are constant. We must tell how to create a boolean constant and how to tell if
a constant is a boolean truth. All such things are forming a model which compliments abstract SSA passes.


<p><div class='code'>
<span id='Z547045'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_make_model</span><span class='lexic'>()</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;<span id='Z547398'><span><span class='ident'>ht</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='ident'>mkhash</span><span class='lexic'>();</span><br>
<br>
&nbsp;&nbsp;&nbsp;<span id='Z547293'><span><span class='ident'>getconst</span></span></span><span class='lexic'>(</span><span id='Z547210'><span><span class='ident'>c</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z547216'><span><span class='ident'>vc</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='lexic'>(</span><span class='keyword'>match</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z547210",this)' onmouseleave='srcref_leave("Z547210",this)'><span><span class='ident'>c</span></span></span>&nbsp;<span class='keyword'>with</span>&nbsp;<span class='symbol'><span class='pattern'>'const'</span></span><span class='lexic'><span class='pattern'>(</span></span><span class='ident'><span class='pattern'>tp</span></span><span class='lexic'><span class='pattern'>,</span></span><span class='pattern'>&nbsp;</span><span id='Z547209'><span><span class='ident'><span class='pattern'>v</span></span></span></span><span class='lexic'><span class='pattern'>)</span></span>&nbsp;&#8594;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z547209",this)' onmouseleave='srcref_leave("Z547209",this)'><span><span class='ident'>v</span></span></span><span class='lexic'>);</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0flat2</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>const</span><span class='lexic'>:</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z547216",this)' onmouseleave='srcref_leave("Z547216",this)'><span><span class='ident'>vc</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>once</span>&nbsp;<span class='ident'>const</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z547270'><span><span class='ident'>number</span></span></span>&nbsp;&#8594;&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z547270",this)' onmouseleave='srcref_leave("Z547270",this)'><span><span class='ident'>n</span></span></span><span class='hint'>number(n)</span></span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span id='Z547276'><span><span class='ident'>string</span></span></span>&nbsp;&#8594;&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z547276",this)' onmouseleave='srcref_leave("Z547276",this)'><span><span class='ident'>s</span></span></span><span class='hint'>string(s)</span></span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span id='Z547282'><span><span class='ident'>symbol</span></span></span>&nbsp;&#8594;&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z547282",this)' onmouseleave='srcref_leave("Z547282",this)'><span><span class='ident'>s</span></span></span><span class='hint'>symbol(s)</span></span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>nil</span>&nbsp;&#8594;&nbsp;<span class='lexic'>&#8709;</span><span class='lexic'>}}};</span><br>
<br>
&nbsp;&nbsp;&nbsp;<span id='Z547409'><span><span class='ident'>istrueconst</span></span></span><span class='lexic'>(</span><span id='Z547294'><span><span class='ident'>c</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z547293",this)' onmouseleave='srcref_leave("Z547293",this)'><span><span class='ident'>getconst</span></span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z547294",this)' onmouseleave='srcref_leave("Z547294",this)'><span><span class='ident'>c</span></span></span><span class='lexic'>);</span><br>
<br>
&nbsp;&nbsp;&nbsp;<br>
&nbsp;&nbsp;&nbsp;<span id='Z547341'><span><span class='ident'>mknumconst</span></span></span><span class='lexic'>(</span><span id='Z547301'><span><span class='ident'>c</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>=</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>with</span>&nbsp;<span class='keyword'>target</span>&nbsp;<span class='lexic'>(</span><span class='ident'>lang0flat2</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='symbol'>'const'</span><span class='lexic'>(</span><span class='symbol'>'any'</span><span class='lexic'>(),</span>&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>const</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>number</span><span class='hint'>lang0flat2:const:number(n)</span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z547301",this)' onmouseleave='srcref_leave("Z547301",this)'><span><span class='ident'>c</span></span></span><span class='lexic'>))};</span><br>
<br>
&nbsp;&nbsp;&nbsp;<span id='Z547365'><span><span class='ident'>mkboolconst</span></span></span><span class='lexic'>(</span><span id='Z547308'><span><span class='ident'>c</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>=</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>with</span>&nbsp;<span class='keyword'>target</span>&nbsp;<span class='lexic'>(</span><span class='ident'>lang0flat2</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='symbol'>'const'</span><span class='lexic'>(</span><span class='symbol'>'any'</span><span class='lexic'>(),</span>&nbsp;<span class='keyword'>if</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z547308",this)' onmouseleave='srcref_leave("Z547308",this)'><span><span class='ident'>c</span></span></span><span class='lexic'>)</span>&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>const</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>symbol</span><span class='hint'>lang0flat2:const:symbol(s)</span></span><span class='lexic'>(</span><span class='symbol'>'t'</span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>else</span>&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>const</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>nil</span><span class='hint'>lang0flat2:const:nil()</span></span><span class='lexic'>())};</span><br>
<br>
&nbsp;&nbsp;&nbsp;<span id='Z547369'><span><span class='ident'>mkbinfun</span></span></span><span class='lexic'>(</span><span id='Z547338'><span><span class='ident'>fn</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>=</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>&lambda;</span><span class='lexic'>(</span><span id='Z547343'><span><span class='ident'>args</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>&lt;</span><span class='lexic'><span class='pattern'>[</span></span><span id='Z547334'><span><span class='ident'><span class='pattern'>l</span></span></span></span><span class='lexic'><span class='pattern'>;</span></span><span id='Z547336'><span><span class='ident'><span class='pattern'>r</span></span></span></span><span class='lexic'><span class='pattern'>]</span></span><span class='lexic'>&gt;</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z547343",this)' onmouseleave='srcref_leave("Z547343",this)'><span><span class='ident'>args</span></span></span><span class='lexic'>;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z547339'><span><span class='ident'>vl</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z547293",this)' onmouseleave='srcref_leave("Z547293",this)'><span><span class='ident'>getconst</span></span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z547334",this)' onmouseleave='srcref_leave("Z547334",this)'><span><span class='ident'>l</span></span></span><span class='lexic'>);</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z547340'><span><span class='ident'>vr</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z547293",this)' onmouseleave='srcref_leave("Z547293",this)'><span><span class='ident'>getconst</span></span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z547336",this)' onmouseleave='srcref_leave("Z547336",this)'><span><span class='ident'>r</span></span></span><span class='lexic'>);</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z547342'><span><span class='ident'>tmp</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z547338",this)' onmouseleave='srcref_leave("Z547338",this)'><span><span class='ident'>fn</span></span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z547339",this)' onmouseleave='srcref_leave("Z547339",this)'><span><span class='ident'>vl</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z547340",this)' onmouseleave='srcref_leave("Z547340",this)'><span><span class='ident'>vr</span></span></span><span class='lexic'>);</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>return</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z547341",this)' onmouseleave='srcref_leave("Z547341",this)'><span><span class='ident'>mknumconst</span></span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z547342",this)' onmouseleave='srcref_leave("Z547342",this)'><span><span class='ident'>tmp</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>}</span><span class='lexic'>;</span><br>
&nbsp;&nbsp;&nbsp;<span id='Z547370'><span><span class='ident'>mkboolfun</span></span></span><span class='lexic'>(</span><span id='Z547362'><span><span class='ident'>fn</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>=</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>&lambda;</span><span class='lexic'>(</span><span id='Z547367'><span><span class='ident'>args</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>&lt;</span><span class='lexic'><span class='pattern'>[</span></span><span id='Z547358'><span><span class='ident'><span class='pattern'>l</span></span></span></span><span class='lexic'><span class='pattern'>;</span></span><span id='Z547360'><span><span class='ident'><span class='pattern'>r</span></span></span></span><span class='lexic'><span class='pattern'>]</span></span><span class='lexic'>&gt;</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z547367",this)' onmouseleave='srcref_leave("Z547367",this)'><span><span class='ident'>args</span></span></span><span class='lexic'>;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z547363'><span><span class='ident'>vl</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z547293",this)' onmouseleave='srcref_leave("Z547293",this)'><span><span class='ident'>getconst</span></span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z547358",this)' onmouseleave='srcref_leave("Z547358",this)'><span><span class='ident'>l</span></span></span><span class='lexic'>);</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z547364'><span><span class='ident'>vr</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z547293",this)' onmouseleave='srcref_leave("Z547293",this)'><span><span class='ident'>getconst</span></span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z547360",this)' onmouseleave='srcref_leave("Z547360",this)'><span><span class='ident'>r</span></span></span><span class='lexic'>);</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z547366'><span><span class='ident'>tmp</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z547362",this)' onmouseleave='srcref_leave("Z547362",this)'><span><span class='ident'>fn</span></span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z547363",this)' onmouseleave='srcref_leave("Z547363",this)'><span><span class='ident'>vl</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z547364",this)' onmouseleave='srcref_leave("Z547364",this)'><span><span class='ident'>vr</span></span></span><span class='lexic'>);</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>return</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z547365",this)' onmouseleave='srcref_leave("Z547365",this)'><span><span class='ident'>mkboolconst</span></span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z547366",this)' onmouseleave='srcref_leave("Z547366",this)'><span><span class='ident'>tmp</span></span></span><span class='lexic'>)}</span><span class='lexic'>;</span><br>
<br>
&nbsp;&nbsp;&nbsp;<span class='keyword'>iter</span>&nbsp;<span class='lexic'>[</span><span id='Z547399'><span><span class='ident'><span class='pattern'>nm</span></span></span></span><span class='lexic'>;</span><span id='Z547404'><span><span class='ident'><span class='pattern'>c</span></span></span></span><span class='lexic'>;</span><span id='Z547405'><span><span class='ident'><span class='pattern'>p</span></span></span></span><span class='lexic'>;</span><span id='Z547406'><span><span class='ident'><span class='pattern'>efun</span></span></span></span><span class='lexic'>;@</span><span id='Z547397'><span><span class='ident'><span class='pattern'>rst</span></span></span></span><span class='lexic'>]</span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='lexic'>[</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>[</span><span class='symbol'>'binopadd'</span><span class='lexic'>;</span><span class='const'>1</span><span class='lexic'>;</span><span class='const'>1</span><span class='lexic'>;</span><span class='idfrom' onmouseenter='srcref_over("Z547369",this)' onmouseleave='srcref_leave("Z547369",this)'><span><span class='ident'>mkbinfun</span></span></span><span class='lexic'>(</span>&nbsp;<span class='ident'>%+</span>&nbsp;<span class='lexic'>);</span><span class='symbol'>'add'</span><span class='lexic'>];</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>[</span><span class='symbol'>'binopsub'</span><span class='lexic'>;</span><span class='const'>1</span><span class='lexic'>;</span><span class='const'>1</span><span class='lexic'>;</span><span class='idfrom' onmouseenter='srcref_over("Z547369",this)' onmouseleave='srcref_leave("Z547369",this)'><span><span class='ident'>mkbinfun</span></span></span><span class='lexic'>(</span>&nbsp;<span class='ident'>%-</span>&nbsp;<span class='lexic'>);</span><span class='symbol'>'sub'</span><span class='lexic'>];</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>[</span><span class='symbol'>'binopmul'</span><span class='lexic'>;</span><span class='const'>1</span><span class='lexic'>;</span><span class='const'>1</span><span class='lexic'>;</span><span class='idfrom' onmouseenter='srcref_over("Z547369",this)' onmouseleave='srcref_leave("Z547369",this)'><span><span class='ident'>mkbinfun</span></span></span><span class='lexic'>(</span>&nbsp;<span class='ident'>%*</span>&nbsp;<span class='lexic'>);</span><span class='symbol'>'mul'</span><span class='lexic'>];</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>[</span><span class='symbol'>'binopdiv'</span><span class='lexic'>;</span><span class='const'>1</span><span class='lexic'>;</span><span class='const'>1</span><span class='lexic'>;</span><span class='idfrom' onmouseenter='srcref_over("Z547369",this)' onmouseleave='srcref_leave("Z547369",this)'><span><span class='ident'>mkbinfun</span></span></span><span class='lexic'>(</span>&nbsp;<span class='ident'>%/</span>&nbsp;<span class='lexic'>);</span><span class='symbol'>'div'</span><span class='lexic'>];</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>[</span><span class='symbol'>'binopeq'</span><span class='lexic'>;</span><span class='const'>1</span><span class='lexic'>;</span><span class='const'>1</span><span class='lexic'>;</span><span class='idfrom' onmouseenter='srcref_over("Z547370",this)' onmouseleave='srcref_leave("Z547370",this)'><span><span class='ident'>mkboolfun</span></span></span><span class='lexic'>(</span>&nbsp;<span class='keyword'>&lambda;</span><span class='lexic'>(</span><span id='Z547373'><span><span class='ident'>l</span></span></span><span class='lexic'>,</span><span id='Z547374'><span><span class='ident'>r</span></span></span><span class='lexic'>)</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z547373",this)' onmouseleave='srcref_leave("Z547373",this)'><span><span class='ident'>l</span></span></span><span class='lexic'>=</span>=<span class='idfrom' onmouseenter='srcref_over("Z547374",this)' onmouseleave='srcref_leave("Z547374",this)'><span><span class='ident'>r</span></span></span>&nbsp;<span class='lexic'>);</span><span class='symbol'>'eq'</span><span class='lexic'>];</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>[</span><span class='symbol'>'binopneq'</span><span class='lexic'>;</span><span class='const'>1</span><span class='lexic'>;</span><span class='const'>1</span><span class='lexic'>;</span><span class='idfrom' onmouseenter='srcref_over("Z547370",this)' onmouseleave='srcref_leave("Z547370",this)'><span><span class='ident'>mkboolfun</span></span></span><span class='lexic'>(</span>&nbsp;<span class='keyword'>&lambda;</span><span class='lexic'>(</span><span id='Z547377'><span><span class='ident'>l</span></span></span><span class='lexic'>,</span><span id='Z547378'><span><span class='ident'>r</span></span></span><span class='lexic'>)</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z547377",this)' onmouseleave='srcref_leave("Z547377",this)'><span><span class='ident'>l</span></span></span>!=<span class='idfrom' onmouseenter='srcref_over("Z547378",this)' onmouseleave='srcref_leave("Z547378",this)'><span><span class='ident'>r</span></span></span>&nbsp;<span class='lexic'>);</span><span class='symbol'>'neq'</span><span class='lexic'>]</span><br>
&nbsp;&nbsp;&nbsp;<span class='lexic'>]</span>&nbsp;<span class='keyword'>do</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z547407'><span><span class='ident'>cls</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='keyword'>if</span>&nbsp;<span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z547397",this)' onmouseleave='srcref_leave("Z547397",this)'><span><span class='ident'>rst</span></span></span><span class='lexic'>)</span>&nbsp;<span class='ident'>car</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z547397",this)' onmouseleave='srcref_leave("Z547397",this)'><span><span class='ident'>rst</span></span></span><span class='lexic'>)</span>&nbsp;<span class='keyword'>else</span>&nbsp;<span class='lexic'>&#8709;</span><span class='lexic'>;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='ident'>ohashput</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z547398",this)' onmouseleave='srcref_leave("Z547398",this)'><span><span class='ident'>ht</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z547399",this)' onmouseleave='srcref_leave("Z547399",this)'><span><span class='ident'>nm</span></span></span><span class='lexic'>,</span>&nbsp;<span class='keyword'>&lambda;</span><span class='lexic'>(</span><span id='Z547408'><span><span class='ident'>tg</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>match</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z547408",this)' onmouseleave='srcref_leave("Z547408",this)'><span><span class='ident'>tg</span></span></span>&nbsp;<span class='keyword'>with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='symbol'><span class='pattern'>'constantp'</span></span>&nbsp;&#8594;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z547404",this)' onmouseleave='srcref_leave("Z547404",this)'><span><span class='ident'>c</span></span></span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='symbol'><span class='pattern'>'purep'</span></span>&nbsp;&#8594;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z547405",this)' onmouseleave='srcref_leave("Z547405",this)'><span><span class='ident'>p</span></span></span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='symbol'><span class='pattern'>'evalfun'</span></span>&nbsp;&#8594;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z547406",this)' onmouseleave='srcref_leave("Z547406",this)'><span><span class='ident'>efun</span></span></span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='symbol'><span class='pattern'>'classify'</span></span>&nbsp;&#8594;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z547407",this)' onmouseleave='srcref_leave("Z547407",this)'><span><span class='ident'>cls</span></span></span><span class='lexic'>}</span><span class='lexic'>)};</span><br>
<br>
&nbsp;&nbsp;&nbsp;<span class='ident'>ohashput</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z547398",this)' onmouseleave='srcref_leave("Z547398",this)'><span><span class='ident'>ht</span></span></span><span class='lexic'>,</span>&nbsp;<span class='symbol'>'*true?*'</span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z547409",this)' onmouseleave='srcref_leave("Z547409",this)'><span><span class='ident'>istrueconst</span></span></span><span class='lexic'>);</span><br>
&nbsp;&nbsp;&nbsp;<span class='ident'>ohashput</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z547398",this)' onmouseleave='srcref_leave("Z547398",this)'><span><span class='ident'>ht</span></span></span><span class='lexic'>,</span>&nbsp;<span class='symbol'>'*boolean-type*'</span><span class='lexic'>,</span>&nbsp;<span class='symbol'>'any'</span><span class='lexic'>());</span><br>
&nbsp;&nbsp;&nbsp;<span class='ident'>ohashput</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z547398",this)' onmouseleave='srcref_leave("Z547398",this)'><span><span class='ident'>ht</span></span></span><span class='lexic'>,</span>&nbsp;<span class='symbol'>'*type-maker*'</span><span class='lexic'>,</span>&nbsp;<span class='keyword'>&lambda;</span><span class='lexic'>(</span><span class='ident'>lenv</span><span class='lexic'>,</span>&nbsp;<span class='ident'>t</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><span class='symbol'>'any'</span><span class='lexic'>()}</span><span class='lexic'>);</span><br>
&nbsp;&nbsp;&nbsp;<span class='ident'>ohashput</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z547398",this)' onmouseleave='srcref_leave("Z547398",this)'><span><span class='ident'>ht</span></span></span><span class='lexic'>,</span>&nbsp;<span class='symbol'>'*ctype-maker*'</span><span class='lexic'>,</span>&nbsp;<span class='keyword'>&lambda;</span><span class='lexic'>(</span><span class='ident'>lenv</span><span class='lexic'>,</span>&nbsp;<span class='ident'>t</span><span class='lexic'>,</span>&nbsp;<span class='ident'>c</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><span class='symbol'>'any'</span><span class='lexic'>()}</span><span class='lexic'>);</span><br>
&nbsp;&nbsp;&nbsp;<span class='ident'>ohashput</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z547398",this)' onmouseleave='srcref_leave("Z547398",this)'><span><span class='ident'>ht</span></span></span><span class='lexic'>,</span>&nbsp;<span class='symbol'>'*type-equation-maker*'</span><span class='lexic'>,</span>&nbsp;<span class='keyword'>&lambda;</span><span class='lexic'>(</span><span class='ident'>dst</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><span class='lexic'>&#8709;</span><span class='lexic'>}</span><span class='lexic'>);</span><br>
<br>
&nbsp;&nbsp;&nbsp;<span class='ident'>ohashput</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z547398",this)' onmouseleave='srcref_leave("Z547398",this)'><span><span class='ident'>ht</span></span></span><span class='lexic'>,</span>&nbsp;<span class='symbol'>'*get-integer-constant*'</span><span class='lexic'>,</span>&nbsp;<span class='keyword'>&lambda;</span><span class='lexic'>(</span><span class='ident'>tp</span><span class='lexic'>,</span>&nbsp;<span class='ident'>vl</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>&#8709;</span><span class='lexic'>}</span><span class='lexic'>);</span><br>
&nbsp;&nbsp;&nbsp;<span class='keyword'>return</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z547398",this)' onmouseleave='srcref_leave("Z547398",this)'><span><span class='ident'>ht</span></span></span><span class='lexic'>}</span>
<p></div>



<p><div class='code'>
<span id='Z547565'><span class='keyword'>d</span></span><span class='keyword'>efine</span>&nbsp;<span class='ident'>l0_default_model</span>&nbsp;<span class='lexic'>=</span>&nbsp;<a href='#Z547045'><span class='ident'>l0_make_model</span></a><span class='lexic'>()</span>
<p></div>


<h3>Optimisations</h3>


<p><div class='code'>
<span id='Z547568'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_genssa_opt</span><span class='lexic'>(</span><span id='Z547584'><span><span class='ident'>ts</span></span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;<span class='keyword'>map</span>&nbsp;<span id='Z547588'><span><span class='ident'>t</span></span></span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z547584",this)' onmouseleave='srcref_leave("Z547584",this)'><span><span class='ident'>ts</span></span></span>&nbsp;<span class='keyword'>do</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z547589'><span><span class='ident'>t0</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<a href='#Z546644'><span class='ident'>l0_to_abstract_ssa</span></a><span class='lexic'>([</span><span class='idfrom' onmouseenter='srcref_over("Z547588",this)' onmouseleave='srcref_leave("Z547588",this)'><span><span class='ident'>t</span></span></span><span class='lexic'>]);</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>if</span>&nbsp;<span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z547589",this)' onmouseleave='srcref_leave("Z547589",this)'><span><span class='ident'>t0</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>&lt;</span><span class='ident'><span class='pattern'>ht</span></span><span class='lexic'><span class='pattern'>:</span></span><span id='Z547597'><span><span class='ident'><span class='pattern'>nv</span></span></span></span><span class='lexic'>&gt;</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='ident'>genssa2_process</span><span class='lexic'>(</span><span class='ident'>l0_default_model</span><span class='lexic'>,</span>&nbsp;<span class='ident'>mkhash</span><span class='lexic'>(),</span>&nbsp;<span class='ident'>car</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z547589",this)' onmouseleave='srcref_leave("Z547589",this)'><span><span class='ident'>t0</span></span></span><span class='lexic'>));</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>return</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z547597",this)' onmouseleave='srcref_leave("Z547597",this)'><span><span class='ident'>nv</span></span></span><span class='lexic'>}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>}</span>
<p></div>


<h3>Back from the abstract SSA</h3>


<p><div class='code'>
<span id='Z547614'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_from_abstract_ssa_code</span><span class='lexic'>(</span><span id='Z548188'><span><span class='ident'>varht</span></span></span><span class='lexic'>,</span>&nbsp;<span id='Z548873'><span><span class='ident'>c</span></span></span><span class='lexic'>)</span><br>
<span class='keyword'>with</span>&nbsp;<span class='keyword'>target</span>&nbsp;<span class='lexic'>(</span><span class='ident'>lang0flat2</span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;<span id='Z548683'><span><span class='ident'>classvar</span></span></span><span class='lexic'>(</span><span id='Z548189'><span><span class='ident'>id</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='keyword'>aif</span><span class='lexic'>(</span><span class='ident'>chk</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='ident'>ohashget</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z548188",this)' onmouseleave='srcref_leave("Z548188",this)'><span><span class='ident'>varht</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z548189",this)' onmouseleave='srcref_leave("Z548189",this)'><span><span class='ident'>id</span></span></span><span class='lexic'>))</span>&nbsp;<span class='ident'>chk</span>&nbsp;<span class='keyword'>else</span>&nbsp;<span class='symbol'>'var'</span><span class='lexic'>;</span><br>
&nbsp;&nbsp;&nbsp;<span id='Z548554'><span><span class='ident'>getglob</span></span></span><span class='lexic'>(</span><span id='Z548198'><span><span class='ident'>v</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>=</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0flat2</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>value</span><span class='lexic'>:</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z548198",this)' onmouseleave='srcref_leave("Z548198",this)'><span><span class='ident'>v</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>once</span>&nbsp;<span class='ident'>value</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z548277'><span><span class='ident'>global</span></span></span>&nbsp;&#8594;&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z548277",this)' onmouseleave='srcref_leave("Z548277",this)'><span><span class='ident'>id</span></span></span><span class='hint'>global(id)</span></span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='withhint'><span class='ident'>ccerror</span><span class='hint'>function&nbsp;ccerror&nbsp;arg:&nbsp;<br>
Raises&nbsp;[MBaseException]&nbsp;with&nbsp;a&nbsp;given&nbsp;argument.</span></span><span class='lexic'>(</span><span class='symbol'>'IMPOSSIBLE'</span><span class='lexic'>())}};</span><br>
&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>genssa2</span>&nbsp;<span class='lexic'>(</span><span class='ident'>code</span><span class='lexic'>:</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z548873",this)' onmouseleave='srcref_leave("Z548873",this)'><span><span class='ident'>c</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>code</span><span class='lexic'>:</span>&nbsp;<span class='lexic'>{</span><span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>code</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>c</span><span class='hint'>lang0flat2:code:c(bs)</span></span><span class='lexic'>(</span><span class='ident'>bs</span><span class='lexic'>)};</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>bblock</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z548378'><span><span class='ident'>b</span></span></span>&nbsp;&#8594;&nbsp;<span class='keyword'>collector</span><span class='lexic'>(</span><span id='Z548384'><span><span class='ident'>addx</span></span></span><span class='lexic'>,</span>&nbsp;<span id='Z548387'><span><span class='ident'>getx</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z548395'><span><span class='ident'>nops</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='keyword'>map</span>&nbsp;<span class='keyword'>append</span>&nbsp;<span id='Z548383'><span><span class='ident'>o</span></span></span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z548378",this)' onmouseleave='srcref_leave("Z548378",this)'><span><span class='ident'>ops</span></span></span><span class='hint'>b(name,ops,t)</span></span>&nbsp;<span class='keyword'>do</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z548383",this)' onmouseleave='srcref_leave("Z548383",this)'><span><span class='ident'>o</span></span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z548384",this)' onmouseleave='srcref_leave("Z548384",this)'><span><span class='ident'>addx</span></span></span><span class='lexic'>);</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z548396'><span><span class='ident'>nt</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z548387",this)' onmouseleave='srcref_leave("Z548387",this)'><span><span class='ident'>getx</span></span></span><span class='lexic'>();</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>bblock</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>bb</span><span class='hint'>lang0flat2:bblock:bb(lbl,body,t)</span></span><span class='lexic'>(</span><span class='ident'>lbl</span><span class='lexic'>=</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z548378",this)' onmouseleave='srcref_leave("Z548378",this)'><span><span class='ident'>name</span></span></span><span class='hint'>b(name,ops,t)</span></span><span class='lexic'>,</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='ident'>body</span><span class='lexic'>=</span><span class='idfrom' onmouseenter='srcref_over("Z548395",this)' onmouseleave='srcref_leave("Z548395",this)'><span><span class='ident'>nops</span></span></span><span class='lexic'>,</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='ident'>t</span><span class='lexic'>=</span><span class='keyword'>if</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z548396",this)' onmouseleave='srcref_leave("Z548396",this)'><span><span class='ident'>nt</span></span></span><span class='lexic'>)</span>&nbsp;<span class='ident'>car</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z548396",this)' onmouseleave='srcref_leave("Z548396",this)'><span><span class='ident'>nt</span></span></span><span class='lexic'>)</span>&nbsp;<span class='keyword'>else</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z548378",this)' onmouseleave='srcref_leave("Z548378",this)'><span><span class='ident'>t</span></span></span><span class='hint'>b(name,ops,t)</span></span><span class='lexic'>)}};</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>oppair</span><span class='lexic'>:</span>&nbsp;<span class='keyword'>&lambda;</span><span class='lexic'>(</span><span id='Z548434'><span><span class='ident'>addx</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><span class='ident'>op</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z548434",this)' onmouseleave='srcref_leave("Z548434",this)'><span><span class='ident'>addx</span></span></span><span class='lexic'>,</span>&nbsp;<span class='ident'>name</span><span class='lexic'>)}</span><span class='lexic'>;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>iop</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z548462'><span><span class='ident'>phi</span></span></span>&nbsp;&#8594;&nbsp;<span class='keyword'>&lambda;</span><span class='lexic'>(</span><span class='ident'>addx</span><span class='lexic'>,</span>&nbsp;<span id='Z548458'><span><span class='ident'>name</span></span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>[</span><span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>insn</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>def</span><span class='hint'>lang0flat2:insn:def(id,v)</span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z548458",this)' onmouseleave='srcref_leave("Z548458",this)'><span><span class='ident'>name</span></span></span><span class='lexic'>,</span>&nbsp;<span class='ident'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>phi</span><span class='hint'>lang0flat2:expr:phi(ss)</span></span><span class='lexic'>(</span><span class='ident'>ss</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z548462",this)' onmouseleave='srcref_leave("Z548462",this)'><span><span class='ident'>args</span></span></span><span class='hint'>phi(args)</span></span><span class='lexic'>))]</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span id='Z548491'><span><span class='ident'>select</span></span></span>&nbsp;&#8594;&nbsp;<span class='keyword'>&lambda;</span><span class='lexic'>(</span><span class='ident'>addx</span><span class='lexic'>,</span>&nbsp;<span id='Z548485'><span><span class='ident'>name</span></span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>[</span><span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>insn</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>def</span><span class='hint'>lang0flat2:insn:def(id,v)</span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z548485",this)' onmouseleave='srcref_leave("Z548485",this)'><span><span class='ident'>name</span></span></span><span class='lexic'>,</span>&nbsp;<span class='ident'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>select</span><span class='hint'>lang0flat2:expr:select(cnd,tr,fl)</span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z548491",this)' onmouseleave='srcref_leave("Z548491",this)'><span><span class='ident'>cnd</span></span></span><span class='hint'>select(cnd,t,f)</span></span><span class='lexic'>,</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z548491",this)' onmouseleave='srcref_leave("Z548491",this)'><span><span class='ident'>t</span></span></span><span class='hint'>select(cnd,t,f)</span></span><span class='lexic'>,</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z548491",this)' onmouseleave='srcref_leave("Z548491",this)'><span><span class='ident'>f</span></span></span><span class='hint'>select(cnd,t,f)</span></span><span class='lexic'>))]</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span id='Z548520'><span><span class='ident'>call</span></span></span>&nbsp;&#8594;&nbsp;<span class='keyword'>&lambda;</span><span class='lexic'>(</span><span id='Z548516'><span><span class='ident'>addx</span></span></span><span class='lexic'>,</span>&nbsp;<span id='Z548530'><span><span class='ident'>dstname</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>match</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z548520",this)' onmouseleave='srcref_leave("Z548520",this)'><span><span class='ident'>dst</span></span></span><span class='hint'>call(a,dst,args)</span></span>&nbsp;<span class='keyword'>with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='symbol'><span class='pattern'>'*tailreturn*'</span></span>&nbsp;&#8594;&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='comment'>//&nbsp;Override&nbsp;the&nbsp;terminal&nbsp;and&nbsp;remove&nbsp;the&nbsp;argument<br>
</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='comment'>//&nbsp;from&nbsp;the&nbsp;insns&nbsp;list<br>
</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z548516",this)' onmouseleave='srcref_leave("Z548516",this)'><span><span class='ident'>addx</span></span></span><span class='lexic'>(</span><span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>term</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>return</span><span class='hint'>lang0flat2:term:return(v)</span></span><span class='lexic'>(</span><span class='ident'>car</span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z548520",this)' onmouseleave='srcref_leave("Z548520",this)'><span><span class='ident'>args</span></span></span><span class='hint'>call(a,dst,args)</span></span><span class='lexic'>)));</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>return</span>&nbsp;<span class='lexic'>&#8709;</span><span class='lexic'>}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='symbol'><span class='pattern'>'*funcall*'</span></span>&nbsp;&#8594;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>[</span><span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>insn</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>def</span><span class='hint'>lang0flat2:insn:def(id,v)</span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z548530",this)' onmouseleave='srcref_leave("Z548530",this)'><span><span class='ident'>dstname</span></span></span><span class='lexic'>,</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='ident'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>apply</span><span class='hint'>lang0flat2:expr:apply(purep,fn,args)</span></span><span class='lexic'>(</span><span class='lexic'>&#8709;</span><span class='lexic'>,</span>&nbsp;<span class='ident'>car</span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z548520",this)' onmouseleave='srcref_leave("Z548520",this)'><span><span class='ident'>args</span></span></span><span class='hint'>call(a,dst,args)</span></span><span class='lexic'>),</span>&nbsp;<span class='ident'>cdr</span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z548520",this)' onmouseleave='srcref_leave("Z548520",this)'><span><span class='ident'>args</span></span></span><span class='hint'>call(a,dst,args)</span></span><span class='lexic'>)))]</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='symbol'><span class='pattern'>'*mkclosure*'</span></span>&nbsp;&#8594;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>[</span><span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>insn</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>def</span><span class='hint'>lang0flat2:insn:def(id,v)</span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z548530",this)' onmouseleave='srcref_leave("Z548530",this)'><span><span class='ident'>dstname</span></span></span><span class='lexic'>,</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='ident'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>mkclosure</span><span class='hint'>lang0flat2:expr:mkclosure(df,args)</span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z548554",this)' onmouseleave='srcref_leave("Z548554",this)'><span><span class='ident'>getglob</span></span></span><span class='lexic'>(</span><span class='ident'>car</span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z548520",this)' onmouseleave='srcref_leave("Z548520",this)'><span><span class='ident'>args</span></span></span><span class='hint'>call(a,dst,args)</span></span><span class='lexic'>)),</span>&nbsp;<span class='ident'>cdr</span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z548520",this)' onmouseleave='srcref_leave("Z548520",this)'><span><span class='ident'>args</span></span></span><span class='hint'>call(a,dst,args)</span></span><span class='lexic'>)))]</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='symbol'><span class='pattern'>'*return*'</span></span>&nbsp;&#8594;&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z548516",this)' onmouseleave='srcref_leave("Z548516",this)'><span><span class='ident'>addx</span></span></span><span class='lexic'>(</span><span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>term</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>return</span><span class='hint'>lang0flat2:term:return(v)</span></span><span class='lexic'>(</span><span class='ident'>car</span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z548520",this)' onmouseleave='srcref_leave("Z548520",this)'><span><span class='ident'>args</span></span></span><span class='hint'>call(a,dst,args)</span></span><span class='lexic'>)));</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>return</span>&nbsp;<span class='lexic'>&#8709;</span><span class='lexic'>}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'><span class='pattern'>else</span></span>&nbsp;&#8594;&nbsp;<span class='lexic'>{</span>&nbsp;<span class='comment'>//&nbsp;intrinsic<br>
</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>[</span><span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>insn</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>def</span><span class='hint'>lang0flat2:insn:def(id,v)</span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z548530",this)' onmouseleave='srcref_leave("Z548530",this)'><span><span class='ident'>dstname</span></span></span><span class='lexic'>,</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='ident'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>apply</span><span class='hint'>lang0flat2:expr:apply(purep,fn,args)</span></span><span class='lexic'>(</span><span class='lexic'>&#8709;</span><span class='lexic'>,</span>&nbsp;<span class='ident'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>global</span><span class='hint'>lang0flat2:value:global(id)</span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z548520",this)' onmouseleave='srcref_leave("Z548520",this)'><span><span class='ident'>dst</span></span></span><span class='hint'>call(a,dst,args)</span></span><span class='lexic'>),</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z548520",this)' onmouseleave='srcref_leave("Z548520",this)'><span><span class='ident'>args</span></span></span><span class='hint'>call(a,dst,args)</span></span><span class='lexic'>))]</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>}}</span><span class='lexic'>};</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>expr</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z548660'><span><span class='ident'>var</span></span></span>&nbsp;&#8594;&nbsp;<span class='lexic'>{</span><span class='keyword'>match</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z548683",this)' onmouseleave='srcref_leave("Z548683",this)'><span><span class='ident'>classvar</span></span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z548660",this)' onmouseleave='srcref_leave("Z548660",this)'><span><span class='ident'>id</span></span></span><span class='hint'>var(id)</span></span><span class='lexic'>)</span>&nbsp;<span class='keyword'>with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='symbol'><span class='pattern'>'var'</span></span>&nbsp;&#8594;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>value</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>reg</span><span class='hint'>lang0flat2:value:reg(id)</span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z548660",this)' onmouseleave='srcref_leave("Z548660",this)'><span><span class='ident'>id</span></span></span><span class='hint'>var(id)</span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='symbol'><span class='pattern'>'arg'</span></span>&nbsp;&#8594;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>value</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>arg</span><span class='hint'>lang0flat2:value:arg(id)</span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z548660",this)' onmouseleave='srcref_leave("Z548660",this)'><span><span class='ident'>id</span></span></span><span class='hint'>var(id)</span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='symbol'><span class='pattern'>'clvar'</span></span>&nbsp;&#8594;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>value</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>clvar</span><span class='hint'>lang0flat2:value:clvar(id)</span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z548660",this)' onmouseleave='srcref_leave("Z548660",this)'><span><span class='ident'>id</span></span></span><span class='hint'>var(id)</span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'><span class='pattern'>else</span></span>&nbsp;&#8594;&nbsp;<span class='withhint'><span class='ident'>ccerror</span><span class='hint'>function&nbsp;ccerror&nbsp;arg:&nbsp;<br>
Raises&nbsp;[MBaseException]&nbsp;with&nbsp;a&nbsp;given&nbsp;argument.</span></span><span class='lexic'>(</span><span class='symbol'>'IMPOSSIBLE'</span><span class='lexic'>())}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span id='Z548693'><span><span class='ident'>glob</span></span></span>&nbsp;&#8594;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>value</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>global</span><span class='hint'>lang0flat2:value:global(id)</span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z548693",this)' onmouseleave='srcref_leave("Z548693",this)'><span><span class='ident'>id</span></span></span><span class='hint'>glob(id)</span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span id='Z548708'><span><span class='ident'>const</span></span></span>&nbsp;&#8594;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>value</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>const</span><span class='hint'>lang0flat2:value:const(c)</span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z548708",this)' onmouseleave='srcref_leave("Z548708",this)'><span><span class='ident'>v</span></span></span><span class='hint'>const(t,v)</span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>other</span>&nbsp;&#8594;&nbsp;<span class='withhint'><span class='ident'>ccerror</span><span class='hint'>function&nbsp;ccerror&nbsp;arg:&nbsp;<br>
Raises&nbsp;[MBaseException]&nbsp;with&nbsp;a&nbsp;given&nbsp;argument.</span></span><span class='lexic'>(</span><span class='symbol'>'IMPOSSIBLE'</span><span class='lexic'>())};</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>phiarg</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z548753'><span><span class='ident'>a</span></span></span>&nbsp;&#8594;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>phisrc</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>s</span><span class='hint'>lang0flat2:phisrc:s(from,v)</span></span><span class='lexic'>(</span><span class='ident'>from</span><span class='lexic'>=</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z548753",this)' onmouseleave='srcref_leave("Z548753",this)'><span><span class='ident'>src</span></span></span><span class='hint'>a(src,v)</span></span><span class='lexic'>,</span>&nbsp;<span class='ident'>v</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z548753",this)' onmouseleave='srcref_leave("Z548753",this)'><span><span class='ident'>v</span></span></span><span class='hint'>a(src,v)</span></span><span class='lexic'>)};</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>deep</span>&nbsp;<span class='ident'>term</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z548787'><span><span class='ident'>br</span></span></span>&nbsp;&nbsp;&#8594;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>term</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>goto</span><span class='hint'>lang0flat2:term:goto(id)</span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z548787",this)' onmouseleave='srcref_leave("Z548787",this)'><span><span class='ident'>dst</span></span></span><span class='hint'>br(dst)</span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span id='Z548806'><span><span class='ident'>brc</span></span></span>&nbsp;&#8594;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>term</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>gotoc</span><span class='hint'>lang0flat2:term:gotoc(cnd,tr,fl)</span></span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z548806",this)' onmouseleave='srcref_leave("Z548806",this)'><span><span class='ident'>c</span></span></span><span class='hint'>brc(c,tr,fl)</span></span><span class='lexic'>,</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z548806",this)' onmouseleave='srcref_leave("Z548806",this)'><span><span class='ident'>tr</span></span></span><span class='hint'>brc(c,tr,fl)</span></span><span class='lexic'>,</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z548806",this)' onmouseleave='srcref_leave("Z548806",this)'><span><span class='ident'>fl</span></span></span><span class='hint'>brc(c,tr,fl)</span></span><span class='lexic'>)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>switch</span>&nbsp;&#8594;&nbsp;<span class='withhint'><span class='ident'>ccerror</span><span class='hint'>function&nbsp;ccerror&nbsp;arg:&nbsp;<br>
Raises&nbsp;[MBaseException]&nbsp;with&nbsp;a&nbsp;given&nbsp;argument.</span></span><span class='lexic'>(</span><span class='symbol'>'IMPOSSIBLE'</span><span class='lexic'>())</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='ident'>none</span>&nbsp;&#8594;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='ident'>term</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>return</span><span class='hint'>lang0flat2:term:return(v)</span></span><span class='lexic'>(</span><span class='ident'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='ident'>reg</span><span class='hint'>lang0flat2:value:reg(id)</span></span><span class='lexic'>(</span><span class='symbol'>'*WTF*'</span><span class='lexic'>))};</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>}}</span>
<p></div>




<p><div class='code'>
<span id='Z549220'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_varht</span><span class='lexic'>(</span><span id='Z549373'><span><span class='ident'>t</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;<span id='Z549486'><span><span class='ident'>ht</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='ident'>mkhash</span><span class='lexic'>();</span><br>
&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0flat2</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>top</span><span class='lexic'>:</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z549373",this)' onmouseleave='srcref_leave("Z549373",this)'><span><span class='ident'>t</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>once</span>&nbsp;<span class='ident'>top</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z549482'><span><span class='ident'>sfunction</span></span></span>&nbsp;&#8594;&nbsp;<span class='lexic'>{</span>&nbsp;<span class='keyword'>iter</span>&nbsp;<span id='Z549487'><span><span class='ident'>a</span></span></span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z549482",this)' onmouseleave='srcref_leave("Z549482",this)'><span><span class='ident'>args</span></span></span><span class='hint'>sfunction(id,args,body)</span></span>&nbsp;<span class='keyword'>do</span>&nbsp;<span class='ident'>ohashput</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z549486",this)' onmouseleave='srcref_leave("Z549486",this)'><span><span class='ident'>ht</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z549487",this)' onmouseleave='srcref_leave("Z549487",this)'><span><span class='ident'>a</span></span></span><span class='lexic'>,</span>&nbsp;<span class='symbol'>'arg'</span><span class='lexic'>);</span>&nbsp;<span class='lexic'>}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span id='Z549501'><span><span class='ident'>closure</span></span></span>&nbsp;&#8594;&nbsp;<span class='lexic'>{</span>&nbsp;<span class='keyword'>iter</span>&nbsp;<span id='Z549505'><span><span class='ident'>a</span></span></span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z549501",this)' onmouseleave='srcref_leave("Z549501",this)'><span><span class='ident'>args</span></span></span><span class='hint'>closure(id,clargs,args,body)</span></span>&nbsp;<span class='keyword'>do</span>&nbsp;<span class='ident'>ohashput</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z549486",this)' onmouseleave='srcref_leave("Z549486",this)'><span><span class='ident'>ht</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z549505",this)' onmouseleave='srcref_leave("Z549505",this)'><span><span class='ident'>a</span></span></span><span class='lexic'>,</span>&nbsp;<span class='symbol'>'arg'</span><span class='lexic'>);</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>iter</span>&nbsp;<span id='Z549510'><span><span class='ident'>c</span></span></span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z549501",this)' onmouseleave='srcref_leave("Z549501",this)'><span><span class='ident'>clargs</span></span></span><span class='hint'>closure(id,clargs,args,body)</span></span>&nbsp;<span class='keyword'>do</span>&nbsp;<span class='ident'>ohashput</span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z549486",this)' onmouseleave='srcref_leave("Z549486",this)'><span><span class='ident'>ht</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z549510",this)' onmouseleave='srcref_leave("Z549510",this)'><span><span class='ident'>c</span></span></span><span class='lexic'>,</span>&nbsp;<span class='symbol'>'clvar'</span><span class='lexic'>)}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='lexic'>&#8709;</span><span class='lexic'>}};</span><br>
&nbsp;&nbsp;&nbsp;<span class='keyword'>return</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z549486",this)' onmouseleave='srcref_leave("Z549486",this)'><span><span class='ident'>ht</span></span></span><span class='lexic'>}</span>
<p></div>



<p><div class='code'>
<span id='Z549560'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_do_abstract_ssa</span><span class='lexic'>(</span><span id='Z549791'><span><span class='ident'>ts</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;<span id='Z549931'><span><span class='ident'>getcode</span></span></span><span class='lexic'>(</span><span id='Z549787'><span><span class='ident'>t</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>=</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>genssa2</span>&nbsp;<span class='lexic'>(</span><span class='ident'>top</span><span class='lexic'>:</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z549787",this)' onmouseleave='srcref_leave("Z549787",this)'><span><span class='ident'>t</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>once</span>&nbsp;<span class='ident'>top</span>&nbsp;<span class='lexic'>{</span>&nbsp;<span id='Z549784'><span><span class='ident'>f</span></span></span>&nbsp;&#8594;&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z549784",this)' onmouseleave='srcref_leave("Z549784",this)'><span><span class='ident'>body</span></span></span><span class='hint'>f(nm,ret,args,body)</span></span>&nbsp;<span class='lexic'>}};</span><br>
&nbsp;&nbsp;<span class='keyword'>map</span>&nbsp;<span id='Z549799'><span><span class='ident'>t</span></span></span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z549791",this)' onmouseleave='srcref_leave("Z549791",this)'><span><span class='ident'>ts</span></span></span>&nbsp;<span class='keyword'>do</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>visit</span><span class='lexic'>:</span><span class='ident'>lang0flat2</span>&nbsp;<span class='lexic'>/rec/</span>&nbsp;<span class='lexic'>(</span><span class='ident'>top</span><span class='lexic'>:</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z549799",this)' onmouseleave='srcref_leave("Z549799",this)'><span><span class='ident'>t</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>once</span>&nbsp;<span class='ident'>top</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z549908'><span><span class='ident'>sfunction</span></span></span>&nbsp;&#8594;&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z549942'><span><span class='ident'>assa</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='symbol'>'f'</span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z549908",this)' onmouseleave='srcref_leave("Z549908",this)'><span><span class='ident'>id</span></span></span><span class='hint'>sfunction(id,args,body)</span></span><span class='lexic'>,</span>&nbsp;<span class='symbol'>'any'</span><span class='lexic'>(),</span>&nbsp;<span class='keyword'>map</span>&nbsp;<span id='Z549918'><span><span class='ident'>a</span></span></span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z549908",this)' onmouseleave='srcref_leave("Z549908",this)'><span><span class='ident'>args</span></span></span><span class='hint'>sfunction(id,args,body)</span></span>&nbsp;<span class='keyword'>do</span>&nbsp;<span class='lexic'>[</span><span class='symbol'>'any'</span><span class='lexic'>();</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z549918",this)' onmouseleave='srcref_leave("Z549918",this)'><span><span class='ident'>a</span></span></span><span class='lexic'>],</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href='#Z545421'><span class='ident'>l0_to_abstract_ssa_code</span></a><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z549908",this)' onmouseleave='srcref_leave("Z549908",this)'><span><span class='ident'>body</span></span></span><span class='hint'>sfunction(id,args,body)</span></span><span class='lexic'>));</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z549930'><span><span class='ident'>varht</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<a href='#Z549220'><span class='ident'>l0_varht</span></a><span class='lexic'>(</span><span class='ident'>thisnodesrc</span><span class='lexic'>());</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>&lt;</span><span class='ident'><span class='pattern'>ht</span></span><span class='lexic'><span class='pattern'>:</span></span><span id='Z549932'><span><span class='ident'><span class='pattern'>nv</span></span></span></span><span class='lexic'>&gt;</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='ident'>genssa2_process</span><span class='lexic'>(</span><span class='ident'>l0_default_model</span><span class='lexic'>,</span>&nbsp;<span class='ident'>mkhash</span><span class='lexic'>(),</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z549942",this)' onmouseleave='srcref_leave("Z549942",this)'><span><span class='ident'>assa</span></span></span><span class='lexic'>);</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z549936'><span><span class='ident'>back</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<a href='#Z547614'><span class='ident'>l0_from_abstract_ssa_code</span></a><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z549930",this)' onmouseleave='srcref_leave("Z549930",this)'><span><span class='ident'>varht</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z549931",this)' onmouseleave='srcref_leave("Z549931",this)'><span><span class='ident'>getcode</span></span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z549932",this)' onmouseleave='srcref_leave("Z549932",this)'><span><span class='ident'>nv</span></span></span><span class='lexic'>));</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='keyword'>node</span><span class='hint'>lang0flat2:top:sfunction(id,args,body)<br>
&nbsp;&nbsp;&nbsp;with&nbsp;implicit&nbsp;arguments:&nbsp;id,&nbsp;args<br>
</span></span><span class='lexic'>(</span><span class='ident'>body</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z549936",this)' onmouseleave='srcref_leave("Z549936",this)'><span><span class='ident'>back</span></span></span><span class='lexic'>)}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span id='Z549956'><span><span class='ident'>closure</span></span></span>&nbsp;&#8594;&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z549997'><span><span class='ident'>assa</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='symbol'>'f'</span><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z549956",this)' onmouseleave='srcref_leave("Z549956",this)'><span><span class='ident'>id</span></span></span><span class='hint'>closure(id,clargs,args,body)</span></span><span class='lexic'>,</span>&nbsp;<span class='symbol'>'any'</span><span class='lexic'>(),</span>&nbsp;<span class='lexic'>[@</span><span class='keyword'>map</span>&nbsp;<span id='Z549966'><span><span class='ident'>a</span></span></span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z549956",this)' onmouseleave='srcref_leave("Z549956",this)'><span><span class='ident'>args</span></span></span><span class='hint'>closure(id,clargs,args,body)</span></span>&nbsp;<span class='keyword'>do</span>&nbsp;<span class='lexic'>[</span><span class='symbol'>'any'</span><span class='lexic'>();</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z549966",this)' onmouseleave='srcref_leave("Z549966",this)'><span><span class='ident'>a</span></span></span><span class='lexic'>];</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>@</span><span class='keyword'>map</span>&nbsp;<span id='Z549974'><span><span class='ident'>a</span></span></span>&nbsp;<span class='keyword'>in</span>&nbsp;<span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z549956",this)' onmouseleave='srcref_leave("Z549956",this)'><span><span class='ident'>clargs</span></span></span><span class='hint'>closure(id,clargs,args,body)</span></span>&nbsp;<span class='keyword'>do</span>&nbsp;<span class='lexic'>[</span><span class='symbol'>'any'</span><span class='lexic'>();</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z549974",this)' onmouseleave='srcref_leave("Z549974",this)'><span><span class='ident'>a</span></span></span><span class='lexic'>]],</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href='#Z545421'><span class='ident'>l0_to_abstract_ssa_code</span></a><span class='lexic'>(</span><span class='withhint'><span class='idfrom' onmouseenter='srcref_over("Z549956",this)' onmouseleave='srcref_leave("Z549956",this)'><span><span class='ident'>body</span></span></span><span class='hint'>closure(id,clargs,args,body)</span></span><span class='lexic'>));</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z549986'><span><span class='ident'>varht</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<a href='#Z549220'><span class='ident'>l0_varht</span></a><span class='lexic'>(</span><span class='ident'>thisnodesrc</span><span class='lexic'>());</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>&lt;</span><span class='ident'><span class='pattern'>ht</span></span><span class='lexic'><span class='pattern'>:</span></span><span id='Z549987'><span><span class='ident'><span class='pattern'>nv</span></span></span></span><span class='lexic'>&gt;</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='ident'>genssa2_process</span><span class='lexic'>(</span><span class='ident'>l0_default_model</span><span class='lexic'>,</span>&nbsp;<span class='ident'>mkhash</span><span class='lexic'>(),</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z549997",this)' onmouseleave='srcref_leave("Z549997",this)'><span><span class='ident'>assa</span></span></span><span class='lexic'>);</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id='Z549991'><span><span class='ident'>back</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<a href='#Z547614'><span class='ident'>l0_from_abstract_ssa_code</span></a><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z549986",this)' onmouseleave='srcref_leave("Z549986",this)'><span><span class='ident'>varht</span></span></span><span class='lexic'>,</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z549931",this)' onmouseleave='srcref_leave("Z549931",this)'><span><span class='ident'>getcode</span></span></span><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z549987",this)' onmouseleave='srcref_leave("Z549987",this)'><span><span class='ident'>nv</span></span></span><span class='lexic'>));</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='keyword'>mk</span><span class='lexic'>:</span><span class='withhint'><span class='keyword'>node</span><span class='hint'>lang0flat2:top:closure(id,clargs,args,body)<br>
&nbsp;&nbsp;&nbsp;with&nbsp;implicit&nbsp;arguments:&nbsp;id,&nbsp;clargs,&nbsp;args<br>
</span></span><span class='lexic'>(</span><span class='ident'>body</span>&nbsp;<span class='lexic'>=</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z549991",this)' onmouseleave='srcref_leave("Z549991",this)'><span><span class='ident'>back</span></span></span><span class='lexic'>)}</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='lexic'>|</span>&nbsp;<span class='keyword'>else</span>&nbsp;&#8594;&nbsp;<span class='ident'>node</span><span class='lexic'>()}}}}</span>
<p></div>





<h2>Driver</h2>

<p>Bringing all the passes together here:


<p><div class='code'>
<span id='Z550077'><span class='keyword'>f</span></span><span class='keyword'>unction</span>&nbsp;<span class='ident'>l0_compiler_driver</span><span class='lexic'>(</span><span id='Z550080'><span><span class='ident'>src</span></span></span><span class='lexic'>)</span>&nbsp;<span class='lexic'>{</span><br>
&nbsp;&nbsp;<span id='Z550082'><span><span class='ident'>x1</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<a href='#Z544344'><span class='ident'>l0_genssa_driver</span></a><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z550080",this)' onmouseleave='srcref_leave("Z550080",this)'><span><span class='ident'>src</span></span></span><span class='lexic'>);</span><br>
&nbsp;&nbsp;<span id='Z550083'><span><span class='ident'>x2</span></span></span>&nbsp;<span class='lexic'>=</span>&nbsp;<a href='#Z549560'><span class='ident'>l0_do_abstract_ssa</span></a><span class='lexic'>(</span><span class='idfrom' onmouseenter='srcref_over("Z550082",this)' onmouseleave='srcref_leave("Z550082",this)'><span><span class='ident'>x1</span></span></span><span class='lexic'>);</span><br>
&nbsp;&nbsp;<span class='keyword'>return</span>&nbsp;<span class='idfrom' onmouseenter='srcref_over("Z550083",this)' onmouseleave='srcref_leave("Z550083",this)'><span><span class='ident'>x2</span></span></span><br>
<span class='lexic'>}</span>
<p></div>



<div class='none'>
  <span id='dummy_to'><span id='too'>&nbsp;</span></span>
  <span id='dummy_from'><span id='frm'>&nbsp;</span></span>
</div>



    <svg>
      <defs>
        <marker id="m1" markerWidth="8" markerHeight="8" refx="5" refy="5">
          <circle cx="5" cy="5" r="1.5"></circle>
        </marker>
        <marker id="m2" 
                markerWidth="5" markerHeight="5" viewBox="-6 -6 12 12" 
                refX="-2" refY="0" 
                markerUnits="strokeWidth" 
                orient="auto">
          <polygon points="-2,0 -5,5 5,0 -5,-5" fill="grey" stroke="black" stroke-width="1px"/>
        </marker>
      </defs>
      <g data-source="frm" data-target="too">
        <line marker-start="url(#m1)" marker-end="url(#m2)"></line>
      </g>
    </svg>
    
</div>


</body>

</html>





